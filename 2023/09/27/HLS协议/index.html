<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CPT+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"fang0407.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="M3U8格式M3U8（也称为 HLS 播放列表）是一种文本文件格式，用于描述 HTTP Live Streaming（HLS）协议中的媒体播放列表。HLS 是一种流媒体传输协议，广泛用于将音频和视频内容分发到互联网上的移动设备和桌面浏览器。 M3U8 文件是一个纯文本文件，其中包含了多个媒体片段的 URL 和其他相关信息，以便客户端能够按顺序下载和播放这些片段。 播放列表 一个 M3U8 的播放列">
<meta property="og:type" content="article">
<meta property="og:title" content="HLS协议">
<meta property="og:url" content="https://fang0407.github.io/2023/09/27/HLS%E5%8D%8F%E8%AE%AE/index.html">
<meta property="og:site_name" content="NOTE">
<meta property="og:description" content="M3U8格式M3U8（也称为 HLS 播放列表）是一种文本文件格式，用于描述 HTTP Live Streaming（HLS）协议中的媒体播放列表。HLS 是一种流媒体传输协议，广泛用于将音频和视频内容分发到互联网上的移动设备和桌面浏览器。 M3U8 文件是一个纯文本文件，其中包含了多个媒体片段的 URL 和其他相关信息，以便客户端能够按顺序下载和播放这些片段。 播放列表 一个 M3U8 的播放列">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://fang0407.github.io/2023/09/27/HLS%E5%8D%8F%E8%AE%AE/ts%E2%BD%82%E4%BB%B6%E5%88%86%E5%B1%82.png">
<meta property="og:image" content="https://fang0407.github.io/2023/09/27/HLS%E5%8D%8F%E8%AE%AE/HLS%E6%8A%A5%E6%96%87.png">
<meta property="og:image" content="https://fang0407.github.io/2023/09/27/HLS%E5%8D%8F%E8%AE%AE/tsheader%E6%8A%A5%E6%96%87.png">
<meta property="og:image" content="https://fang0407.github.io/2023/09/27/HLS%E5%8D%8F%E8%AE%AE/AdaptationField%E6%8A%A5%E6%96%87.png">
<meta property="og:image" content="https://fang0407.github.io/2023/09/27/HLS%E5%8D%8F%E8%AE%AE/PAT%E6%8A%A5%E6%96%87.png">
<meta property="og:image" content="https://fang0407.github.io/2023/09/27/HLS%E5%8D%8F%E8%AE%AE/PMT%E6%8A%A5%E6%96%87.png">
<meta property="article:published_time" content="2023-09-27T14:59:19.000Z">
<meta property="article:modified_time" content="2024-01-16T10:46:05.457Z">
<meta property="article:author" content="Fang">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://fang0407.github.io/2023/09/27/HLS%E5%8D%8F%E8%AE%AE/ts%E2%BD%82%E4%BB%B6%E5%88%86%E5%B1%82.png">


<link rel="canonical" href="https://fang0407.github.io/2023/09/27/HLS%E5%8D%8F%E8%AE%AE/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://fang0407.github.io/2023/09/27/HLS%E5%8D%8F%E8%AE%AE/","path":"2023/09/27/HLS协议/","title":"HLS协议"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>HLS协议 | NOTE</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">NOTE</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#M3U8%E6%A0%BC%E5%BC%8F"><span class="nav-number">1.</span> <span class="nav-text">M3U8格式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%92%AD%E6%94%BE%E5%88%97%E8%A1%A8"><span class="nav-number">1.1.</span> <span class="nav-text">播放列表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%87%E7%AD%BE"><span class="nav-number">1.2.</span> <span class="nav-text">标签</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#M3U8%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.3.</span> <span class="nav-text">M3U8示例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%82%B9%E6%92%AD%E5%AA%92%E4%BD%93%E6%92%AD%E6%94%BE%E5%88%97%E8%A1%A8"><span class="nav-number">1.3.1.</span> <span class="nav-text">点播媒体播放列表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EVENT%E6%92%AD%E6%94%BE%E5%88%97%E8%A1%A8"><span class="nav-number">1.3.2.</span> <span class="nav-text">EVENT播放列表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B4%E6%92%AD%E6%92%AD%E6%94%BE%E5%88%97%E8%A1%A8"><span class="nav-number">1.3.3.</span> <span class="nav-text">直播播放列表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A0%E5%AF%86%E7%9A%84%E5%AA%92%E4%BD%93%E6%92%AD%E6%94%BE%E5%88%97%E8%A1%A8"><span class="nav-number">1.3.4.</span> <span class="nav-text">加密的媒体播放列表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BYTERANGE%E6%92%AD%E6%94%BE%E5%88%97%E8%A1%A8"><span class="nav-number">1.3.5.</span> <span class="nav-text">BYTERANGE播放列表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8F%92%E6%92%AD%E4%B8%8D%E5%90%8C%E6%A0%BC%E5%BC%8F%E5%86%85%E5%AE%B9%E7%9A%84%E6%92%AD%E6%94%BE%E5%88%97%E8%A1%A8"><span class="nav-number">1.3.6.</span> <span class="nav-text">插播不同格式内容的播放列表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E6%92%AD%E6%94%BE%E5%88%97%E8%A1%A8"><span class="nav-number">1.3.7.</span> <span class="nav-text">主播放列表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#I%E5%B8%A7%E6%92%AD%E6%94%BE%E5%88%97%E8%A1%A8"><span class="nav-number">1.3.8.</span> <span class="nav-text">I帧播放列表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HTTP%E4%BC%A0%E8%BE%93M3U8"><span class="nav-number">1.3.9.</span> <span class="nav-text">HTTP传输M3U8</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#TS%E6%A0%BC%E5%BC%8F"><span class="nav-number">2.</span> <span class="nav-text">TS格式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#TS%E6%A0%BC%E5%BC%8F%E4%BB%8B%E7%BB%8D"><span class="nav-number">2.1.</span> <span class="nav-text">TS格式介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8C%85%E5%A4%B4"><span class="nav-number">2.2.</span> <span class="nav-text">包头</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E9%80%82%E5%BA%94%E5%AD%97%E6%AE%B5"><span class="nav-number">2.3.</span> <span class="nav-text">自适应字段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%89%E6%95%88%E8%B4%9F%E8%BD%BD"><span class="nav-number">2.4.</span> <span class="nav-text">有效负载</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#PAT"><span class="nav-number">2.4.1.</span> <span class="nav-text">PAT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PMT"><span class="nav-number">2.4.2.</span> <span class="nav-text">PMT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PES"><span class="nav-number">2.4.3.</span> <span class="nav-text">PES</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#HTTP%E5%8D%8F%E8%AE%AE"><span class="nav-number">3.</span> <span class="nav-text">HTTP协议</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Fang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">77</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/09/27/HLS%E5%8D%8F%E8%AE%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="HLS协议 | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          HLS协议
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-27 22:59:19" itemprop="dateCreated datePublished" datetime="2023-09-27T22:59:19+08:00">2023-09-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-16 18:46:05" itemprop="dateModified" datetime="2024-01-16T18:46:05+08:00">2024-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Protocol/" itemprop="url" rel="index"><span itemprop="name">Protocol</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="M3U8格式"><a href="#M3U8格式" class="headerlink" title="M3U8格式"></a>M3U8格式</h1><p>M3U8（也称为 HLS 播放列表）是一种文本文件格式，用于描述 HTTP Live Streaming（HLS）协议中的媒体播放列表。HLS 是一种流媒体传输协议，广泛用于将音频和视频内容分发到互联网上的移动设备和桌面浏览器。</p>
<p>M3U8 文件是一个纯文本文件，其中包含了多个媒体片段的 URL 和其他相关信息，以便客户端能够按顺序下载和播放这些片段。</p>
<h2 id="播放列表"><a href="#播放列表" class="headerlink" title="播放列表"></a>播放列表</h2><ul>
<li>一个 M3U8 的播放列表（playlist） 就是一个由多个独立行组成的文本文件，每行由回车&#x2F;换行区分。</li>
<li>每一行可以是一个 URI、空白行或是一个以 “#” 号开头的字符串，并且空格只能存在于一行中不同元素间的分隔。</li>
<li>一个 URI 表示一个媒体段或是 “variant playlist file”（最多支持一层嵌套，即一个 M3U8 文件中嵌套另一个 M3U8）。以 “EXT” 开头的表示一个 “tag”，否则表示注释，直接忽略。</li>
<li>每一个 M3U8 文件，分别对应若干个 TS 文件，这些 <strong>TS 文件才是真正存放视频的数据</strong>。<strong>M3U8 文件只是存放了一些 TS 文件的配置信息和相关路径</strong>。</li>
</ul>
<h2 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h2><p>标签（Tags）提供了有关媒体流和播放列表本身的信息。</p>
<p><strong>#EXTM3U</strong></p>
<ul>
<li><p>格式：<code>#EXTM3U</code></p>
</li>
<li><p>作用：每个 m3u8 文件第一行必须是这个 tag，请标示作用。</p>
</li>
</ul>
<p><strong>#EXT-X-VERSION</strong></p>
<ul>
<li>格式：<code>#EXT-X-VERSION:&lt;v&gt;</code></li>
<li>作用：m3u8 文件版本号，比如#EXT-X-VERSION:3。</li>
</ul>
<p><strong>#EXT-X-TARGETDURATION</strong></p>
<ul>
<li>格式： <code>#EXT-X-TARGETDURATION:&lt;s&gt;</code></li>
<li>作用：指定当前视频流中的单个切片（即 ts）文件的最大时长（秒）。所以 #EXTINF 中指定的时间长度必须小于或是等于这个最大值。这个 tag 在整个 playlist 文件中只能出现一次（在嵌套的情况下，一般有真正 ts url 的 m3u8 才会出现该 tag）。</li>
</ul>
<p><strong>#EXT-X-MEDIA-SEQUENCE</strong></p>
<ul>
<li>格式：<code>#EXT-X-MEDIA-SEQUENCE:&lt;number&gt;</code></li>
<li>作用：指定 meida segment 的开始序号，每一个 media uri 在 playlist 中只有唯一的序号，相邻之间序号 +1。 一个 media uri 并不是必须要包含的，如果没有，默认为 0。</li>
</ul>
<p><strong>#EXT-X-ALLOW-CACHE</strong></p>
<ul>
<li>格式：<code>#EXT-X-ALLOW-CACHE:&lt;YES|NO&gt;</code></li>
<li>作用：指示客户端是否被允许缓存媒体片段，可以在 m3u8 文件中任意地方出现，并且最多只出现一次，作用效果是所有的媒体段。</li>
</ul>
<p><strong>#EXTINF</strong></p>
<ul>
<li>格式：<code>#EXTINF:&lt;duration&gt;,&lt;title&gt;</code></li>
<li>作用：指定每个媒体段（ts）的持续时间（单位秒），这个仅对其后面的 uri 有效，每两个媒体段 uri 间被这个 tag 分隔开；比如<code>#EXTINF:14.357, no desc</code>。</li>
</ul>
<p><strong>#EXT-X-ENDLIST</strong></p>
<ul>
<li>格式：<code>#EXT-X-ENDLIST</code></li>
<li>作用：表示 m3u8 文件的结束，live m3u8 没有该 tag。它可以在 playlist 中任意位置出现，但是只能出现一个。</li>
</ul>
<p><strong>#EXT-X-STREAM-INF</strong></p>
<ul>
<li>格式：<code>#EXT-X-STREAM-INF:&lt;attribute-list&gt;</code></li>
<li>作用：指定一个包含多媒体信息的 media uri 作为 playlist，一般做 m3u8 的嵌套使用，它只对紧跟后面的 uri 有效。</li>
<li>常用的属性如下：<ul>
<li>BANDWIDTH：带宽，必须有。</li>
<li>CODECS：指定流的编码类型，不是必须的。</li>
<li>RESOLUTION：分辨率。</li>
<li>AUDIO：这个值必须和 AUDIO 类别的 “EXT-X-MEDIA” 标签中 “GROUP-ID” 属性值相匹配。</li>
<li>VIDEO：同上。</li>
</ul>
</li>
</ul>
<p><strong>#EXT-X-KEY</strong></p>
<ul>
<li>格式：<code>#EXT-X-KEY:&lt;attribute-list&gt;</code></li>
<li>作用：表示怎么对 media segments 进行解密。其作用范围是下次该 tag 出现前的所有 media URI。</li>
<li>参考链接：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/jruing/p/15820950.html">https://www.cnblogs.com/jruing/p/15820950.html</a></li>
</ul>
<h2 id="M3U8示例"><a href="#M3U8示例" class="headerlink" title="M3U8示例"></a>M3U8示例</h2><h3 id="点播媒体播放列表"><a href="#点播媒体播放列表" class="headerlink" title="点播媒体播放列表"></a>点播媒体播放列表</h3><p>主要特征：文件包含 <code>EXT-X-ENDLIST</code> 标签，<code>EXT-X-PLAYLIST-TYPE</code> 标签（可选）值为 VOD，表示播放列表不可变。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-PLAYLIST-TYPE:VOD</span><br><span class="line">#EXT-X-TARGETDURATION:10</span><br><span class="line">#EXT-X-VERSION:3</span><br><span class="line">#EXTINF:9.009,</span><br><span class="line">http://media.example.com/first.ts</span><br><span class="line">#EXTINF:9.009,</span><br><span class="line">http://media.example.com/second.ts</span><br><span class="line">#EXTINF:3.003,</span><br><span class="line">http://media.example.com/third.ts</span><br><span class="line">#EXT-X-ENDLIST</span><br></pre></td></tr></table></figure>

<p>M3U8 文件支持绝对路径，也支持相对路径，所以上面的格式等效于：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-PLAYLIST-TYPE:VOD</span><br><span class="line">#EXT-X-TARGETDURATION:10</span><br><span class="line">#EXT-X-VERSION:3</span><br><span class="line">#EXTINF:9.009,</span><br><span class="line">first.ts</span><br><span class="line">#EXTINF:9.009,</span><br><span class="line">second.ts</span><br><span class="line">#EXTINF:3.003,</span><br><span class="line">third.ts</span><br><span class="line">#EXT-X-ENDLIST</span><br></pre></td></tr></table></figure>

<h3 id="EVENT播放列表"><a href="#EVENT播放列表" class="headerlink" title="EVENT播放列表"></a>EVENT播放列表</h3><p>主要特征：<code>EXT-X-PLAYLIST-TYPE</code> 标签值为 EVENT，表示播放列表内容可变，不过只能在文件末尾改变。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-PLAYLIST-TYPE:EVENT</span><br><span class="line">#EXT-X-TARGETDURATION:10</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:0</span><br><span class="line">#EXTINF:10,</span><br><span class="line">fileSequence0.ts</span><br><span class="line">#EXTINF:10,</span><br><span class="line">fileSequence1.ts</span><br><span class="line">#EXTINF:10,</span><br><span class="line">fileSequence2.ts</span><br><span class="line">#EXTINF:10,</span><br><span class="line">fileSequence3.ts</span><br></pre></td></tr></table></figure>

<p>结束时，M3U8 文件内容如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-PLAYLIST-TYPE:EVENT</span><br><span class="line">#EXT-X-TARGETDURATION:10</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:0</span><br><span class="line">#EXTINF:10,</span><br><span class="line">fileSequence0.ts</span><br><span class="line">#EXTINF:10,</span><br><span class="line">fileSequence1.ts</span><br><span class="line">#EXTINF:10,</span><br><span class="line">fileSequence2.ts</span><br><span class="line">#EXTINF:10,</span><br><span class="line">fileSequence3.ts</span><br><span class="line">...</span><br><span class="line">#EXTINF:10,</span><br><span class="line">fileSequence120.ts</span><br><span class="line">#EXTINF:10,</span><br><span class="line">fileSequence121.ts</span><br><span class="line">#EXT-X-ENDLIST</span><br></pre></td></tr></table></figure>

<h3 id="直播播放列表"><a href="#直播播放列表" class="headerlink" title="直播播放列表"></a>直播播放列表</h3><p>主要特征：不包含 <code>EXT-X-ENDLIST</code> 标签，不包含 <code>EXT-X-PLAYLIST-TYPE</code> 标签。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-VERSION:3</span><br><span class="line">#EXT-X-TARGETDURATION:8</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:2680</span><br><span class="line"></span><br><span class="line">#EXTINF:7.975,</span><br><span class="line">https://priv.example.com/fileSequence2680.ts</span><br><span class="line">#EXTINF:7.941,</span><br><span class="line">https://priv.example.com/fileSequence2681.ts</span><br><span class="line">#EXTINF:7.975,</span><br><span class="line">https://priv.example.com/fileSequence2682.ts</span><br></pre></td></tr></table></figure>

<p>直播播放列表是一个会动态更新的 M3U8 文件，服务端会对直播流进行实时转码生成直播流切片，并定期更新 M3U8 文件。这个 M3U8 文件一般为会包括 3-5 个切片。</p>
<p>直播播放列表中的任意一个切片的 URI 被移除时，都需要更新 <code>EXT-X-MEDIA-SEQUENCE</code> 标签的值（+1）。移除切片 URI 时必须按顺序，以保证客户端通过更新的 M3U8 文件拿到的是连续的切片数据。</p>
<h3 id="加密的媒体播放列表"><a href="#加密的媒体播放列表" class="headerlink" title="加密的媒体播放列表"></a>加密的媒体播放列表</h3><p>主要特征：包含 <code>EXT-X-KEY</code> 标签。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-VERSION:3</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:7794</span><br><span class="line">#EXT-X-TARGETDURATION:15</span><br><span class="line"></span><br><span class="line">#EXT-X-KEY:METHOD=AES-128,URI=&quot;https://priv.example.com/key.php?r=52&quot;</span><br><span class="line"></span><br><span class="line">#EXTINF:2.833,</span><br><span class="line">http://media.example.com/fileSequence52-A.ts</span><br><span class="line">#EXTINF:15.0,</span><br><span class="line">http://media.example.com/fileSequence52-B.ts</span><br><span class="line">#EXTINF:13.333,</span><br><span class="line">http://media.example.com/fileSequence52-C.ts</span><br><span class="line"></span><br><span class="line">#EXT-X-KEY:METHOD=AES-128,URI=&quot;https://priv.example.com/key.php?r=53&quot;</span><br><span class="line"></span><br><span class="line">#EXTINF:15.0,</span><br><span class="line">http://media.example.com/fileSequence53-A.ts</span><br></pre></td></tr></table></figure>

<h3 id="BYTERANGE播放列表"><a href="#BYTERANGE播放列表" class="headerlink" title="BYTERANGE播放列表"></a>BYTERANGE播放列表</h3><p>主要特征：<code>EXT-X-VERSION</code> 标签的值为 4 以上，确保 HLS 支持。通过 <code>EXT-X-BYTERANGE</code> 来指定切片偏移量。语法是：<code>#EXT-X-BYTERANGE:length[@offset]</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-PLAYLIST-TYPE:VOD</span><br><span class="line">#EXT-X-TARGETDURATION:10</span><br><span class="line">#EXT-X-VERSION:4</span><br><span class="line">#EXTINF:9.009,</span><br><span class="line">#EXT-X-BYTERANGE:752320</span><br><span class="line">media.ts</span><br><span class="line">#EXTINF:9.009,</span><br><span class="line">#EXT-X-BYTERANGE:82112@752321</span><br><span class="line">media.ts</span><br><span class="line">#EXTINF:3.003,</span><br><span class="line">#EXT-X-BYTERANGE:69864</span><br><span class="line">media.ts</span><br><span class="line">#EXT-X-ENDLIST</span><br></pre></td></tr></table></figure>

<p>使用 BYTERANGE 播放列表可以不用在服务端存储大量的小切片文件，只通过一个文件再加上文件偏移量信息就可以支持分片。</p>
<p>比如，上面示例的 BYTERANGE 播放列表等价于下面简单的播放列表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-PLAYLIST-TYPE:VOD</span><br><span class="line">#EXT-X-TARGETDURATION:10</span><br><span class="line">#EXT-X-VERSION:3</span><br><span class="line">#EXTINF:9.009,</span><br><span class="line">first.ts</span><br><span class="line">#EXTINF:9.009,</span><br><span class="line">second.ts</span><br><span class="line">#EXTINF:3.003,</span><br><span class="line">third.ts</span><br><span class="line">#EXT-X-ENDLIST</span><br></pre></td></tr></table></figure>

<h3 id="插播不同格式内容的播放列表"><a href="#插播不同格式内容的播放列表" class="headerlink" title="插播不同格式内容的播放列表"></a>插播不同格式内容的播放列表</h3><p>主要特征：包含 <code>EXT-X-DISCONTINUITY</code> 标签。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-TARGETDURATION:10</span><br><span class="line">#EXT-X-VERSION:3</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:0</span><br><span class="line">#EXTINF:10.0,</span><br><span class="line">ad0.ts</span><br><span class="line">#EXTINF:8.0,</span><br><span class="line">ad1.ts</span><br><span class="line">#EXT-X-DISCONTINUITY</span><br><span class="line">#EXTINF:10.0,</span><br><span class="line">movieA.ts</span><br><span class="line">#EXTINF:10.0,</span><br><span class="line">movieB.ts</span><br></pre></td></tr></table></figure>

<p>在一些场景下，我们需要在点播或直播中插入其他内容，比如广告，这时候可能这段广告内容的编码格式与原视频的编码格式存在差异，这种差异可能造成客户端播放出问题，这时候就需要告知客户端。这就需要用到 EXT-X-DISCONTINUITY 标签。</p>
<h3 id="主播放列表"><a href="#主播放列表" class="headerlink" title="主播放列表"></a>主播放列表</h3><p>主要特征：包含 <code>EXT-X-STREAM-INF</code> 标签。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-STREAM-INF:BANDWIDTH=1280000,AVERAGE-BANDWIDTH=1000000</span><br><span class="line">http://example.com/low.m3u8</span><br><span class="line">#EXT-X-STREAM-INF:BANDWIDTH=2560000,AVERAGE-BANDWIDTH=2000000</span><br><span class="line">http://example.com/mid.m3u8</span><br><span class="line">#EXT-X-STREAM-INF:BANDWIDTH=7680000,AVERAGE-BANDWIDTH=6000000</span><br><span class="line">http://example.com/hi.m3u8</span><br><span class="line">#EXT-X-STREAM-INF:BANDWIDTH=65000,CODECS=&quot;mp4a.40.5&quot;</span><br><span class="line">http://example.com/audio-only.m3u8</span><br></pre></td></tr></table></figure>

<p>上面示例中，通过 3 个不同码率的视频流和 1 个音频流来描述一个内容。</p>
<h3 id="I帧播放列表"><a href="#I帧播放列表" class="headerlink" title="I帧播放列表"></a>I帧播放列表</h3><p>主要特征：包含 <code>EXT-X-I-FRAME-STREAM-INF</code> 标签。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-STREAM-INF:BANDWIDTH=1280000</span><br><span class="line">low/audio-video.m3u8</span><br><span class="line">#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=86000,URI=&quot;low/iframe.m3u8&quot;</span><br><span class="line">#EXT-X-STREAM-INF:BANDWIDTH=2560000</span><br><span class="line">mid/audio-video.m3u8</span><br><span class="line">#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=150000,URI=&quot;mid/iframe.m3u8&quot;</span><br><span class="line">#EXT-X-STREAM-INF:BANDWIDTH=7680000</span><br><span class="line">hi/audio-video.m3u8</span><br><span class="line">#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=550000,URI=&quot;hi/iframe.m3u8&quot;</span><br><span class="line">#EXT-X-STREAM-INF:BANDWIDTH=65000,CODECS=&quot;mp4a.40.5&quot;</span><br><span class="line">audio-only.m3u8</span><br></pre></td></tr></table></figure>

<p>HLS 是通过<strong>主播放列表标签 EXT-X-I-FRAME-STREAM-INF 和媒体播放列表标签 EXT-X-I-FRAMES-ONLY 配合来实现 I 帧播放列表</strong>，从而支持视频播放常用的快进和快退功能。</p>
<p>上面的示例是在主播放列表中通过 EXT-X-I-FRAME-STREAM-INF 标签指定 I 帧播放列表，那么对应的 I 帧播放列表内容示例如下：</p>
<p>主要特征：<code>EXT-X-VERSION</code> 标签的值为 4 以上，确保 HLS 支持；包含 <code>EXT-X-I-FRAMES-ONLY</code> 标签。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-VERSION:4</span><br><span class="line">#EXT-X-I-FRAMES-ONLY</span><br><span class="line">...</span><br><span class="line">#EXTINF:4.12,</span><br><span class="line">#EXT-X-BYTERANGE:9400@376</span><br><span class="line">segment1.ts</span><br><span class="line">#EXTINF:3.56,</span><br><span class="line">#EXT-X-BYTERANGE:7144@47000</span><br><span class="line">segment1.ts</span><br><span class="line">#EXTINF:3.82,</span><br><span class="line">#EXT-X-BYTERANGE:10340@1880</span><br><span class="line">segment2.ts</span><br></pre></td></tr></table></figure>

<p>上面的示例是用 EXT-X-BYTERANGE 来指定每个 I 帧对应的数据。这里需要注意的是 EXTINF 表示的时长是<strong>当前 I 帧到下一个 I 帧的时长</strong>。</p>
<h3 id="HTTP传输M3U8"><a href="#HTTP传输M3U8" class="headerlink" title="HTTP传输M3U8"></a>HTTP传输M3U8</h3><p>顶级 M3U8 文件主要是做码率适配的，⼆级 M3U8 才是真正的切片文件。客户端会默认选择码率最高的请求，如果发现码率达不到，会请求降低码率的流。客户端拿到二级 M3U8 文件后，会继续请求里面的文件，这时就可以进行播放了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET /live/test.m3u8 HTTP/1.1</span><br><span class="line">User-Agent: Lavf/59.30.100</span><br><span class="line">Accept: */*</span><br><span class="line">Range: bytes=0-</span><br><span class="line">Connection: close</span><br><span class="line">Host: 192.168.2.101:8080</span><br><span class="line">Icy-MetaData: 1</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Connection: Close</span><br><span class="line">Content-Length: 90</span><br><span class="line">Content-Type: application/vnd.apple.mpegurl</span><br><span class="line">Server: SRS/6.0.75(Bee)</span><br><span class="line"></span><br><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-STREAM-INF:BANDWIDTH=1,AVERAGE-BANDWIDTH=1</span><br><span class="line">/live/test.m3u8?hls_ctx=18201z96</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">GET /live/test.m3u8?hls_ctx=18201z96 HTTP/1.1</span><br><span class="line">User-Agent: Lavf/59.30.100</span><br><span class="line">Accept: */*</span><br><span class="line">Range: bytes=0-</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Host: 192.168.2.101:8080</span><br><span class="line">Icy-MetaData: 1</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Connection: Close</span><br><span class="line">Content-Type: application/vnd.apple.mpegurl</span><br><span class="line">Content-Length: 330</span><br><span class="line">Server: SRS/6.0.75(Bee)</span><br><span class="line"></span><br><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-VERSION:3</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:7</span><br><span class="line">#EXT-X-TARGETDURATION:15</span><br><span class="line">#EXTINF:14.994, no desc</span><br><span class="line">test-7.ts?hls_ctx=18201z96</span><br><span class="line">#EXTINF:14.994, no desc</span><br><span class="line">test-8.ts?hls_ctx=18201z96</span><br><span class="line">#EXTINF:14.994, no desc</span><br><span class="line">test-9.ts?hls_ctx=18201z96</span><br><span class="line">#EXTINF:14.994, no desc</span><br><span class="line">test-10.ts?hls_ctx=18201z96</span><br><span class="line">#EXTINF:8.933, no desc</span><br><span class="line">test-11.ts?hls_ctx=18201z96</span><br><span class="line"></span><br><span class="line">#EXT-X-ALLOW-CACHE:YES</span><br></pre></td></tr></table></figure>

<h1 id="TS格式"><a href="#TS格式" class="headerlink" title="TS格式"></a>TS格式</h1><h2 id="TS格式介绍"><a href="#TS格式介绍" class="headerlink" title="TS格式介绍"></a>TS格式介绍</h2><p>TS 全称为 <strong>MPEG2-TS</strong>，是一种封装的格式，视频编码主要格式为 H264&#x2F;MPEG4，音频为 AAC&#x2F;MP3。</p>
<ul>
<li>TS 分层格式：</li>
</ul>
<img src="/2023/09/27/HLS%E5%8D%8F%E8%AE%AE/ts⽂件分层.png" alt="ts⽂件分层" style="zoom:50%;">

<ul>
<li><p>TS 包大小<strong>固定为 188 字节</strong>，TS 文件分为三层：</p>
<ul>
<li>TS 层：Transport Stream，<strong>是在 PES 层的基础上加⼊数据流的识别和传输必须的信息</strong>。</li>
<li>PES 层： Packet Elemental Stream，<strong>是在音视频数据上加了时间戳等对数据帧的说明信息</strong>。</li>
<li>ES 层：Elementary Stream，<strong>即音视频数据</strong>。</li>
</ul>
</li>
<li><p>解析 TS 流数据的流程：</p>
<ul>
<li><strong>查找 PID 为 0x0 的包，解析 PAT，PAT 包中的 Program Map PID 表示 PMT 的 PID</strong>；</li>
<li><strong>查找 PMT，PMT 包中的 Elementary PID 表示音视频包的 PID，PMT 包中的 PCR PID 表示 PCR 的 PID</strong>，有的时候 PCR 的 PID 跟音频或者视频的 PID 相同，说明 PCR 会融进音视频的包，有的时候 PCR 又是自己单独的包。</li>
</ul>
</li>
<li><p>报文预览：</p>
</li>
</ul>
<img src="/2023/09/27/HLS%E5%8D%8F%E8%AE%AE/HLS报文.png" alt="HLS报文" style="zoom:50%;">

<h2 id="包头"><a href="#包头" class="headerlink" title="包头"></a>包头</h2><p>Header 报文格式：</p>
<img src="/2023/09/27/HLS%E5%8D%8F%E8%AE%AE/tsheader报文.png" alt="tsheader报文" style="zoom:50%;">

<p>MPEG2-TS 包的包头占据了 4 字节，用于标识包的类型和其他信息。包头的字段包括：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>比特数量</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Sync Byte</td>
<td>8b</td>
<td>同步字节，固定为 0x47</td>
</tr>
<tr>
<td>Transport Error Indicator</td>
<td>1b</td>
<td>传输错误指示符，表明在 ts 头的 adapt 域后有一个无用字节，通常都为 0，这个字节算在 adapt 域⻓度内</td>
</tr>
<tr>
<td>Payload Unit Start Indicator</td>
<td>1b</td>
<td>负载单元起始标示符，一个完整的数据包开始时标记为 1</td>
</tr>
<tr>
<td>Transport Priority</td>
<td>1b</td>
<td>传输优先级，0 为低优先级，1 为⾼优先级，通常取 0</td>
</tr>
<tr>
<td><strong>PID</strong></td>
<td>13b</td>
<td>用于标识包中的数据流类型，例如音频、视频、字幕等</td>
</tr>
<tr>
<td>Transport Scrambling Contor</td>
<td>2b</td>
<td>用于指示包是否经过了加扰处理，00 表示未加密</td>
</tr>
<tr>
<td>Adaptation Field Control</td>
<td>2b</td>
<td>用于指示是否存在自适应字段，<br>‘00’保留；‘01’为⽆⾃适应域，仅含有效负载；<br>‘10’为仅含⾃适应域，⽆有效负载；<br>‘11’为同时带有⾃适应域和有效负载</td>
</tr>
<tr>
<td>Continuity Counter</td>
<td>4b</td>
<td>递增计数器，从 0-f，起始值不一定取 0，但必须是连续的，可用于检测丢失的包</td>
</tr>
</tbody></table>
<p><strong>TS 的内容是通过 PID 值来标识的，主要内容包括：PAT 表、PMT 表、音频流、视频流。</strong>PAT 表的和 PMT 表需要定期插入 TS 流，因为用户随时可能加入 TS 流，这个间隔比较小，通常每隔几个视频帧就要加入 PAT 和 PMT。PAT 和 PMT 表是必须的，还可以加入其它表如 SDT（业务描述表）等，不过 HLS 流只要有 PAT 和 PMT 就可以播放了。 </p>
<h2 id="自适应字段"><a href="#自适应字段" class="headerlink" title="自适应字段"></a>自适应字段</h2><p>Adaptation Field 报文格式：</p>
<img src="/2023/09/27/HLS%E5%8D%8F%E8%AE%AE/AdaptationField报文.png" alt="AdaptationField报文" style="zoom:50%;">

<p>自适应字段（Adaptation Field）是可选的，长度不固定，用于在需要时包含额外的控制信息。它可以包括时钟调整、加扰解除、字节对齐等信息。</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>比特数量</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Adaptation Field Length</td>
<td>8b</td>
<td>自适应域长度，后面的字节数</td>
</tr>
<tr>
<td>Discontinuity Indicator</td>
<td>1b</td>
<td>通常用于指示数据流的不连续性。如果有多个数据流，这个标志可以用于标识它们之间的切换</td>
</tr>
<tr>
<td>Random Access Indicator</td>
<td>1b</td>
<td>指示是否存在关键帧或I帧。这对于视频流中的随机访问非常重要</td>
</tr>
<tr>
<td>Elementary Stream Priority Indicator</td>
<td>1b</td>
<td>指示当前包的元素流的优先级</td>
</tr>
<tr>
<td>PCR Flag</td>
<td>1b</td>
<td>指示是否存在 PCR（Program Clock Reference）字段。PCR 用于同步多个数据流的时钟</td>
</tr>
<tr>
<td>OPCR Flag</td>
<td>1b</td>
<td>指示是否存在 OPCR（Original Program Clock Reference）字段。OPCR用于描述原始数据流的时钟</td>
</tr>
<tr>
<td>Splicing Point Flag</td>
<td>1b</td>
<td>指示当前包是否可以被拷贝，即是否可以在此处进行剪切</td>
</tr>
<tr>
<td>Transport Private Data Flag</td>
<td>1b</td>
<td>指示是否存在拷贝权标志信息</td>
</tr>
<tr>
<td>Adaptation Field Extension Flag</td>
<td>1b</td>
<td>指示是否存在自适应字段扩展</td>
</tr>
<tr>
<td>Program Clock Reference</td>
<td>48b</td>
<td>如果 PCR 标志为 1，则包含 PCR 字段，用于同步音频和视频的时钟</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
</tbody></table>
<p>自适应区的长度要包含传输错误指示符标识的一个字节。</p>
<p>打包 TS 流时 PAT 和 PMT 表是没有 adaptation field 的，<strong>不够的长度直接补 0xff 即可</strong>。视频流和音频流都需要加 adaptation field，通常加在一个帧的第一个  TS 包和最后一个 TS 包里，中间的 TS 包不加。</p>
<p>pcr 是节目时钟参考，pcr、dts、pts 都是对同一个系统时钟的采样值，pcr 是递增的，因此可以将其设置为 dts 值，音频数据不需要 pcr。如果没有字段，ipad 是可以播放的，但 vlc 无法播放。</p>
<h2 id="有效负载"><a href="#有效负载" class="headerlink" title="有效负载"></a>有效负载</h2><p>有效负载（Payload）包含了音频、视频、字幕等媒体数据。有效负载的长度可以根据包头中的信息变化，通常为 0 到 184 字节。有效负载的具体格式取决于所传输的内容和编码方式。<strong>在解析 MPEG-TS 流时，需要根据 PID（Packet Identifier）字段中的标识来确定有效负载的类型，并使用相应的解码器来解析数据。</strong>不同的 PID 值对应不同的数据流类型，例如音频、视频、字幕等。</p>
<h3 id="PAT"><a href="#PAT" class="headerlink" title="PAT"></a>PAT</h3><p>PAT 报文格式：</p>
<img src="/2023/09/27/HLS%E5%8D%8F%E8%AE%AE/PAT报文.png" alt="PAT报文" style="zoom:50%;">

<p><strong>TS 包头中的 PID 值为 0x0，表示当前负载为 PAT（Program Association Table）。</strong>PAT 数据的信息可以理解为整个 TS 流包含的节目信息。</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>比特数量</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Table ID</td>
<td>8b</td>
<td>PAT 表固定为 0x00</td>
</tr>
<tr>
<td>Syntax indicator</td>
<td>1b</td>
<td>固定为 1</td>
</tr>
<tr>
<td>Reserverd</td>
<td>3b</td>
<td>固定为 011</td>
</tr>
<tr>
<td>Length</td>
<td>12b</td>
<td>后面数据的长度</td>
</tr>
<tr>
<td>Transport Stream Id</td>
<td>16b</td>
<td>传输流 ID，固定为 0x0001</td>
</tr>
<tr>
<td>Reserved</td>
<td>2b</td>
<td>固定为 11</td>
</tr>
<tr>
<td>Version Number</td>
<td>5b</td>
<td>版本号，固定为 00000，如果 PAT 有变化则版本号加 1</td>
</tr>
<tr>
<td>Current&#x2F;Next Indicator</td>
<td>1b</td>
<td>固定为 1，表示这个 PAT 表可以用，如果为 0 则要等待下一个 PAT 表</td>
</tr>
<tr>
<td>Section Number</td>
<td>8b</td>
<td>固定为 0x00</td>
</tr>
<tr>
<td>Last Section Number</td>
<td>8b</td>
<td>固定为 0x00</td>
</tr>
<tr>
<td>开始循环</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>Program Number</strong></td>
<td>16b</td>
<td>节目号</td>
</tr>
<tr>
<td>Reserved</td>
<td>3b</td>
<td>固定为 111</td>
</tr>
<tr>
<td><strong>Program Map PID</strong></td>
<td>13b</td>
<td>节目号对应内容的 PID 值</td>
</tr>
<tr>
<td>结束循环</td>
<td></td>
<td></td>
</tr>
<tr>
<td>CRC32</td>
<td>32b</td>
<td>前面数据的 CRC32 校验码</td>
</tr>
</tbody></table>
<h3 id="PMT"><a href="#PMT" class="headerlink" title="PMT"></a>PMT</h3><p>PMT 报文格式：</p>
<img src="/2023/09/27/HLS%E5%8D%8F%E8%AE%AE/PMT报文.png" alt="PMT报文" style="zoom:50%;">

<p>PMT（Program Map Table）是 MPEG2-TS（MPEG Transport Stream）中的一种表格，用于描述一个或多个节目的组成，包括音频、视频、字幕等多个元素的信息。PMT 表格的主要作用是告诉接收设备如何解析和处理特定节目的数据流。以下是 PMT 表格的基本格式：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>比特数量</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Table Id</td>
<td>8b</td>
<td>PMT 表取值随意，0x02</td>
</tr>
<tr>
<td>Syntax Indicator</td>
<td>1b</td>
<td>固定为 1</td>
</tr>
<tr>
<td>Reserved</td>
<td>2b</td>
<td>固定为 011</td>
</tr>
<tr>
<td>Length</td>
<td>12b</td>
<td>后面数据的长度</td>
</tr>
<tr>
<td>Program Number</td>
<td>16b</td>
<td>频道号码，表示当前的 PMT 关联到的频道，取值 0x0001</td>
</tr>
<tr>
<td>Reserved</td>
<td>2b</td>
<td>固定为 11</td>
</tr>
<tr>
<td>Version Number</td>
<td>5b</td>
<td>版本号，固定为 00000，如果 PAT 有变化则版本号加 1</td>
</tr>
<tr>
<td>Current&#x2F;Next Indicator</td>
<td>1b</td>
<td>固定为1</td>
</tr>
<tr>
<td>Section Number</td>
<td>8b</td>
<td>固定为 0x00</td>
</tr>
<tr>
<td>Last Section Number</td>
<td>8b</td>
<td>固定为 0x00</td>
</tr>
<tr>
<td>Reserved</td>
<td>3b</td>
<td>固定为 111</td>
</tr>
<tr>
<td><strong>PCR_PID</strong></td>
<td>13b</td>
<td>PCR（节目参考时钟）所在 TS 分组的 PID，指定为视频 PID</td>
</tr>
<tr>
<td>Reserved</td>
<td>4b</td>
<td>固定为 1111</td>
</tr>
<tr>
<td>Program Info Length</td>
<td>12b</td>
<td>节目描述信息，指定为0x000表示没有</td>
</tr>
<tr>
<td>开始循环</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Stream type</td>
<td>8b</td>
<td>流类型，标志是 Video 还是 Audio 还是其他数据，h.264 编码对应 0x1b，aac 编码对应 0x0f，mp3 编码对应 0x03</td>
</tr>
<tr>
<td>Reserved</td>
<td>3b</td>
<td>固定为 111</td>
</tr>
<tr>
<td><strong>Elementary PID</strong></td>
<td>13b</td>
<td>与 Stream type 对应的 PID</td>
</tr>
<tr>
<td>Reserved</td>
<td>4b</td>
<td>固定为 1111</td>
</tr>
<tr>
<td>ES info length</td>
<td>12b</td>
<td>描述信息，指定为 0x000 表示没有</td>
</tr>
<tr>
<td>结束循环</td>
<td></td>
<td></td>
</tr>
<tr>
<td>CRC32</td>
<td>32b</td>
<td>前面数据的 CRC32 校验码</td>
</tr>
</tbody></table>
<h3 id="PES"><a href="#PES" class="headerlink" title="PES"></a>PES</h3><p><strong>PES（Packetized Elementary Stream）用于传输和存储音频、视频和其他媒体数据。</strong>PES 将媒体数据分成小包，每个包包含了媒体数据及其相关信息，使其易于传输和解析。以下是 PES 包头的基本格式：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>比特数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Prefix</td>
<td>24b</td>
<td>PES 包起始码，通常为 0x000001</td>
</tr>
<tr>
<td>Stream</td>
<td>8b</td>
<td>PES 包所包含数据类型，如视频为 0xe0</td>
</tr>
<tr>
<td>Length</td>
<td>16b</td>
<td>指示 PES 包的长度，包含包头、扩展头和有效负载</td>
</tr>
<tr>
<td>10</td>
<td>2b</td>
<td>固定为二进制 10，标志 PES 包头结束，实际数据开始</td>
</tr>
<tr>
<td>Scrambling Control</td>
<td>2b</td>
<td>表示对 PES 包进行加扰控制</td>
</tr>
<tr>
<td>priority</td>
<td>1b</td>
<td>优先级标识位</td>
</tr>
<tr>
<td>Data Alignment</td>
<td>1b</td>
<td>数据对齐标志位，指示包头的结束位置</td>
</tr>
<tr>
<td>Copyright</td>
<td>1b</td>
<td>版权标志</td>
</tr>
<tr>
<td>Original</td>
<td>1b</td>
<td>表示数据的原始性</td>
</tr>
<tr>
<td>PTS Flag</td>
<td>1b</td>
<td>是否包含 PTS 字段</td>
</tr>
<tr>
<td>DTS Flag</td>
<td>1b</td>
<td>是否包含 DTS 字段</td>
</tr>
<tr>
<td>ESCR Flag</td>
<td>1b</td>
<td>是否包含 ESCR 字段</td>
</tr>
<tr>
<td>ES Rate Flag</td>
<td>1b</td>
<td>是否包含 ES Rate 字段</td>
</tr>
<tr>
<td>DSM Trick Model Flag</td>
<td>1b</td>
<td>是否包含 Additional Copy Info 字段</td>
</tr>
<tr>
<td>Additional Copy Info Flag</td>
<td>1b</td>
<td>是否包含 DSM Trick Mode 字段</td>
</tr>
<tr>
<td>CRC Flag</td>
<td>1b</td>
<td>是否包含 CRC 字段</td>
</tr>
<tr>
<td>Extension Flag</td>
<td>1b</td>
<td>是否包含扩展头字段</td>
</tr>
<tr>
<td>Header Data Length</td>
<td>8b</td>
<td>PES 包头数据的长度，包括可选的扩展头</td>
</tr>
</tbody></table>
<h1 id="HTTP协议"><a href="#HTTP协议" class="headerlink" title="HTTP协议"></a>HTTP协议</h1><p>参考：<a target="_blank" rel="noopener" href="https://www.kancloud.cn/spirit-ling/http-study/636182">https://www.kancloud.cn/spirit-ling/http-study/636182</a></p>
<p>参考链接：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/rell336/article/details/38109621">https://blog.csdn.net/rell336/article/details/38109621</a> </p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/rongdeguoqian/article/details/18214627">https://blog.csdn.net/rongdeguoqian/article/details/18214627</a> </p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/09/27/HLS%E7%AE%80%E4%BB%8B/" rel="prev" title="HLS简介">
                  <i class="fa fa-angle-left"></i> HLS简介
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/09/29/HLS%E6%8B%89%E6%B5%81%E6%BA%90%E7%A0%81/" rel="next" title="HLS拉流源码">
                  HLS拉流源码 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Fang</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"neutral","dark":"neutral"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.3.0/mermaid.min.js","integrity":"sha256-9y71g5Lz/KLsHjB8uXwnkuWDtAMDSzD/HdIbqhJfTAI="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





</body>
</html>
