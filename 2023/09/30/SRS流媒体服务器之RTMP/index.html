<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CPT+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"fang0407.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="RTMP推拉流 创建监听套接字  RTMP创建监听套接字SrsServer::listen_rtmp。 启动协程SrsSTCoroutine::start，每个监听对应一个协程。 协程函数SrsTcpListener::cycle。   处理客户端连接  检测获取客户端连接srs_accept，如果有连接则调用handler-&gt;on_tcp_client。  客户端连接具体实现accept_">
<meta property="og:type" content="article">
<meta property="og:title" content="SRS流媒体服务器之RTMP">
<meta property="og:url" content="https://fang0407.github.io/2023/09/30/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BRTMP/index.html">
<meta property="og:site_name" content="NOTE">
<meta property="og:description" content="RTMP推拉流 创建监听套接字  RTMP创建监听套接字SrsServer::listen_rtmp。 启动协程SrsSTCoroutine::start，每个监听对应一个协程。 协程函数SrsTcpListener::cycle。   处理客户端连接  检测获取客户端连接srs_accept，如果有连接则调用handler-&gt;on_tcp_client。  客户端连接具体实现accept_">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://fang0407.github.io/2023/09/30/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BRTMP/rtmp%E5%8D%8F%E8%AE%AE%E6%8A%A5%E6%96%87.png">
<meta property="article:published_time" content="2023-09-30T05:02:25.000Z">
<meta property="article:modified_time" content="2023-12-30T14:37:25.044Z">
<meta property="article:author" content="Fang">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://fang0407.github.io/2023/09/30/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BRTMP/rtmp%E5%8D%8F%E8%AE%AE%E6%8A%A5%E6%96%87.png">


<link rel="canonical" href="https://fang0407.github.io/2023/09/30/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BRTMP/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://fang0407.github.io/2023/09/30/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BRTMP/","path":"2023/09/30/SRS流媒体服务器之RTMP/","title":"SRS流媒体服务器之RTMP"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>SRS流媒体服务器之RTMP | NOTE</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">NOTE</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#RTMP%E6%8E%A8%E6%8B%89%E6%B5%81"><span class="nav-number">1.</span> <span class="nav-text">RTMP推拉流</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%9B%91%E5%90%AC%E5%A5%97%E6%8E%A5%E5%AD%97"><span class="nav-number">1.1.</span> <span class="nav-text">创建监听套接字</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%84%E7%90%86%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9E%E6%8E%A5"><span class="nav-number">1.2.</span> <span class="nav-text">处理客户端连接</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A8%E6%B5%81%E7%AB%AF"><span class="nav-number">1.3.</span> <span class="nav-text">推流端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8B%89%E6%B5%81%E7%AB%AF"><span class="nav-number">1.4.</span> <span class="nav-text">拉流端</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#RTMP%E5%8D%8F%E8%AE%AE"><span class="nav-number">2.</span> <span class="nav-text">RTMP协议</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A8%E6%B5%81%E7%AB%AF-1"><span class="nav-number">2.1.</span> <span class="nav-text">推流端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8B%89%E6%B5%81%E7%AB%AF-1"><span class="nav-number">2.2.</span> <span class="nav-text">拉流端</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Fang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">89</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/09/30/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BRTMP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="SRS流媒体服务器之RTMP | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SRS流媒体服务器之RTMP
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-30 13:02:25" itemprop="dateCreated datePublished" datetime="2023-09-30T13:02:25+08:00">2023-09-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-12-30 22:37:25" itemprop="dateModified" datetime="2023-12-30T22:37:25+08:00">2023-12-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SRS/" itemprop="url" rel="index"><span itemprop="name">SRS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="RTMP推拉流"><a href="#RTMP推拉流" class="headerlink" title="RTMP推拉流"></a>RTMP推拉流</h1><ul>
<li><p>创建监听套接字</p>
<ul>
<li>RTMP创建监听套接字<code>SrsServer::listen_rtmp</code>。</li>
<li>启动协程<code>SrsSTCoroutine::start</code>，每个监听对应一个协程。</li>
<li>协程函数<code>SrsTcpListener::cycle</code>。</li>
</ul>
</li>
<li><p>处理客户端连接</p>
<ul>
<li><p>检测获取客户端连接<code>srs_accept</code>，如果有连接则调用<code>handler-&gt;on_tcp_client</code>。</p>
</li>
<li><p>客户端连接具体实现<code>accept_client</code>，其中<code>fd2conn</code>函数中创建<code>SrsRtmpConn</code>并且绑定连接套接字和连接上下文，之后启动协程<code>conn-&gt;start</code>，每个连接对应一个协程。</p>
</li>
<li><p>协程函数在<code>SrsRtmpConn::do_cycle()</code>中具体实现。</p>
</li>
<li><p>进入 <code>SrsRtmpConn::do_cycle</code>后其中<code>stream_service_cycle</code>里面还分为发布和推流不同分支。</p>
</li>
<li><p>创建或查找<code>SrsSource</code>，一个推流源对应一个<code>SrsSourcce</code>。</p>
</li>
</ul>
</li>
<li><p>推流端</p>
<ul>
<li>每个推流端都会创建一个<code>SrsPublishRecvThread</code>，用来接收数据和推送数据到队列给拉流端使用。</li>
<li>RTMP接收数据<code>rtmp-&gt;recv_message</code>，并且调用<code>pumper-&gt;consume(msg)</code>将处理消息，处理后的消息<code>SrsCommonMessage</code>会推送给<code>SrsComsumer</code>。</li>
</ul>
</li>
<li><p>拉流端</p>
<ul>
<li>每个拉流端都会创建一个<code>SrsQueueRecvThread</code>，用来处理拉流端控制消息，注意和⾳视频消息没有关系。</li>
<li>同时会创建<code>SrsComsumer</code>，<code>SrsSource</code>会将数据通过队列推送过来，之后进行数据处理发送给客户端。</li>
</ul>
</li>
<li><p>核心类</p>
<ul>
<li><code>SrsServer</code>：SRS流媒体服务⼊⼝。</li>
<li><code>SrsBufferListener</code>：监听器，主要是TCP的监听。</li>
<li><code>SrsTcpListener</code>：TCP监听器。</li>
<li><code>SrsRtmpConn</code>：RTMP连接，⾥⾯对应了SrsStSocket和SrsCoroutine。</li>
<li><code>SrsRtmpServer</code>：提供与客户端之间的RTMP-命令-协议-消息的交互服务，使⽤SrsRtmpConn 提供的socket读写数据。</li>
<li><code>SrsSource</code>：描述⼀路播放源，包括推流和拉流的描述。</li>
<li><code>SrsConsumer</code>：拉流消费者，每⼀路拉流客户端对应⼀个SrsConsumer。</li>
<li><code>SrsStSocket</code>：经过封装的socket接⼝。</li>
</ul>
</li>
</ul>
<h2 id="创建监听套接字"><a href="#创建监听套接字" class="headerlink" title="创建监听套接字"></a>创建监听套接字</h2><ul>
<li>RTMP创建监听套接字，并且启动协程。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsServer::listen_rtmp</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// stream service port.</span></span><br><span class="line">    std::vector&lt;std::string&gt; ip_ports = _srs_config-&gt;<span class="built_in">get_listens</span>();</span><br><span class="line">    <span class="built_in">srs_assert</span>((<span class="type">int</span>)ip_ports.<span class="built_in">size</span>() &gt; <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">close_listeners</span>(SrsListenerRtmpStream);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; (<span class="type">int</span>)ip_ports.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        SrsListener* listener = <span class="keyword">new</span> <span class="built_in">SrsBufferListener</span>(<span class="keyword">this</span>, SrsListenerRtmpStream);</span><br><span class="line">        listeners.<span class="built_in">push_back</span>(listener);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> port; string ip;</span><br><span class="line">        <span class="built_in">srs_parse_endpoint</span>(ip_ports[i], ip, port);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//这里调用SrsTcpListener::listen()</span></span><br><span class="line">        <span class="comment">//1.内部创建TCP Socket，bind，listen </span></span><br><span class="line">        <span class="comment">//2.创建SrsSTCoroutine并且执行start() 启动协程</span></span><br><span class="line">        <span class="keyword">if</span> ((err = listener-&gt;<span class="built_in">listen</span>(ip, port)) != srs_success) &#123;</span><br><span class="line">            <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp listen %s:%d&quot;</span>, ip.<span class="built_in">c_str</span>(), port);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>上述启动协程会调用<code>SrsSTCoroutine::start()</code>函数，主要会调用<code>ISrsCoroutineHandler::cycle()</code>函数，该函数子类<code>SrsTcpListener</code>会重写，具体看下面。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsSTCoroutine::start</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//_ST_THREAD_CREATE_PFN _pfn_st_thread_create = (_ST_THREAD_CREATE_PFN)st_thread_create;</span></span><br><span class="line">    <span class="comment">//pfn回调内部调用了cycle()</span></span><br><span class="line">    <span class="keyword">if</span> ((trd = (<span class="type">srs_thread_t</span>)_pfn_st_thread_create(pfn, <span class="keyword">this</span>, <span class="number">1</span>, <span class="number">0</span>)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        err = <span class="built_in">srs_error_new</span>(ERROR_ST_CREATE_CYCLE_THREAD, <span class="string">&quot;create failed&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">srs_freep</span>(trd_err);</span><br><span class="line">        trd_err = <span class="built_in">srs_error_copy</span>(err);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//pfn内部调用了p-&gt;cycle()</span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">SrsSTCoroutine::pfn</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SrsSTCoroutine* p = (SrsSTCoroutine*)arg;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里跟进去调用ISrsCoroutineHandler::cycle()</span></span><br><span class="line">    <span class="comment">//ISrsCoroutineHandler是个接口类</span></span><br><span class="line">    <span class="type">srs_error_t</span> err = p-&gt;<span class="built_in">cycle</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the err for function pull to fetch it.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/pull/1304#issuecomment-480484151</span></span><br><span class="line">    <span class="keyword">if</span> (err != srs_success) &#123;</span><br><span class="line">        <span class="built_in">srs_freep</span>(p-&gt;trd_err);</span><br><span class="line">        <span class="comment">// It&#x27;s ok to directly use it, because it&#x27;s returned by st_thread_join.</span></span><br><span class="line">        p-&gt;trd_err = err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="type">void</span>*)err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>ISrsCoroutineHandler</code>接口。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ISrsCoroutineHandler</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ISrsCoroutineHandler</span>();</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">ISrsCoroutineHandler</span>();</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// Do the work. The ST-coroutine will terminated normally if it returned.</span></span><br><span class="line">    <span class="comment">// @remark If the cycle has its own loop, it must check the thread pull.</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">srs_error_t</span> <span class="title">cycle</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsTcpListener::cycle()</code></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsTcpListener::cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;tcp listener&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//检测获取客户端连接Socket</span></span><br><span class="line">        <span class="type">srs_netfd_t</span> fd = <span class="built_in">srs_accept</span>(lfd, <span class="literal">NULL</span>, <span class="literal">NULL</span>, SRS_UTIME_NO_TIMEOUT);</span><br><span class="line">        <span class="keyword">if</span>(fd == <span class="literal">NULL</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_SOCKET_ACCEPT, <span class="string">&quot;accept at fd=%d&quot;</span>, <span class="built_in">srs_netfd_fileno</span>(lfd));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">	    <span class="keyword">if</span> ((err = <span class="built_in">srs_fd_closeexec</span>(<span class="built_in">srs_netfd_fileno</span>(fd))) != srs_success) &#123;</span><br><span class="line">	        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;set closeexec&quot;</span>);</span><br><span class="line">	    &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//处理新的客户端连接，内部调用SrsServer::accept_client()</span></span><br><span class="line">        <span class="keyword">if</span> ((err = handler-&gt;<span class="built_in">on_tcp_client</span>(fd)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;handle fd=%d&quot;</span>, <span class="built_in">srs_netfd_fileno</span>(fd));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="处理客户端连接"><a href="#处理客户端连接" class="headerlink" title="处理客户端连接"></a>处理客户端连接</h2><ul>
<li><code>fd2conn</code>创建一个<code>SrsRtmpConn</code>并且会绑定连接套接字，其中<code>SrsRtmpConn</code>对应一个<code>SrsRtmpServer</code>，内部也会创建一个协程。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsServer::accept_client</span><span class="params">(SrsListenerType type, <span class="type">srs_netfd_t</span> stfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    SrsConnection* conn = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//绑定Socket和conn，根据不同StreamType创建conn</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    if (type == SrsListenerRtmpStream) &#123;</span></span><br><span class="line"><span class="comment">        *pconn = new SrsRtmpConn(this, stfd, ip);</span></span><br><span class="line"><span class="comment">    &#125; else if (type == SrsListenerHttpApi) &#123;</span></span><br><span class="line"><span class="comment">        *pconn = new SrsHttpApi(this, stfd, http_api_mux, ip);</span></span><br><span class="line"><span class="comment">    &#125; else if (type == SrsListenerHttpStream) &#123;</span></span><br><span class="line"><span class="comment">        *pconn = new SrsResponseOnlyHttpConn(this, stfd, http_server, ip);</span></span><br><span class="line"><span class="comment">    &#125; else &#123;</span></span><br><span class="line"><span class="comment">        srs_warn(&quot;close for no service handler. fd=%d, ip=%s&quot;, fd, ip.c_str());</span></span><br><span class="line"><span class="comment">        srs_close_stfd(stfd);</span></span><br><span class="line"><span class="comment">        return err;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">fd2conn</span>(type, stfd, &amp;conn)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">srs_error_code</span>(err) == ERROR_SOCKET_GET_PEER_IP &amp;&amp; _srs_config-&gt;<span class="built_in">empty_ip_ok</span>()) &#123;</span><br><span class="line">            <span class="built_in">srs_close_stfd</span>(stfd); <span class="built_in">srs_error_reset</span>(err);</span><br><span class="line">            <span class="keyword">return</span> srs_success;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;fd2conn&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">srs_assert</span>(conn);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// directly enqueue, the cycle thread will remove the client.</span></span><br><span class="line">    conns.<span class="built_in">push_back</span>(conn);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cycle will start process thread and when finished remove the client.</span></span><br><span class="line">    <span class="comment">// @remark never use the conn, for it maybe destroyed.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = conn-&gt;<span class="built_in">start</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;start conn coroutine&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>conn-&gt;start()</code>会创建一个协程处理与客户端的连接交互，RTMP在<code>SrsRtmpConn::do_cycle()</code>中具体实现。其中<code>service_cycle</code>继续调用<code>stream_service_cycle</code>里面还分为发布和推流不同分支。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::do_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//握手</span></span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">handshake</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp handshake&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">connect_app</span>(req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp connect tcUrl&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">service_cycle</span>()) != srs_success) &#123;</span><br><span class="line">        err = <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;service cycle&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">srs_error_t</span> r0 = srs_success;</span><br><span class="line">    <span class="keyword">if</span> ((r0 = <span class="built_in">on_disconnect</span>()) != srs_success) &#123;</span><br><span class="line">        err = <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;on disconnect %s&quot;</span>, <span class="built_in">srs_error_desc</span>(r0).<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="built_in">srs_freep</span>(r0);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// If client is redirect to other servers, we already logged the event.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">srs_error_code</span>(err) == ERROR_CONTROL_REDIRECT) &#123;</span><br><span class="line">        <span class="built_in">srs_error_reset</span>(err);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>stream_service_cycle</code>主要创建或查找一个<code>SrsSource</code>，并且处理<code>publishing</code>或<code>playing</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::stream_service_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    </span><br><span class="line">   	<span class="comment">// find a source to serve.</span></span><br><span class="line">    SrsSource* source = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> ((err = _srs_sources-&gt;<span class="built_in">fetch_or_create</span>(req, server, &amp;source)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: fetch source&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (info-&gt;type) &#123;</span><br><span class="line">        <span class="keyword">case</span> SrsRtmpConnPlay: &#123;</span><br><span class="line">            <span class="comment">// response connection start play</span></span><br><span class="line">            <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">start_play</span>(info-&gt;res-&gt;stream_id)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: start play&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((err = <span class="built_in">http_hooks_on_play</span>()) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: callback on play&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            err = <span class="built_in">playing</span>(source);</span><br><span class="line">            <span class="built_in">http_hooks_on_stop</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> SrsRtmpConnFMLEPublish: &#123;</span><br><span class="line">            <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">start_fmle_publish</span>(info-&gt;res-&gt;stream_id)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: start FMLE publish&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">publishing</span>(source);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_SYSTEM_CLIENT_INVALID, <span class="string">&quot;rtmp: unknown client type=%d&quot;</span>, info-&gt;type);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="推流端"><a href="#推流端" class="headerlink" title="推流端"></a>推流端</h2><ul>
<li><code>SrsPublishRecvThread</code>内部封装了协程，具体看下<code>do_publishing</code>中<code>SrsPublishRecvThread::start()</code>，继续进入<code>SrsRecvThread::start()</code>，最后到<code>SrsRecvThread::do_cycle()</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::publishing</span><span class="params">(SrsSource* source)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> Should refine the state of publishing.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">acquire_publish</span>(source)) == srs_success) &#123;</span><br><span class="line">        <span class="comment">// use isolate thread to recv,</span></span><br><span class="line">        <span class="comment">// @see: https://github.com/ossrs/srs/issues/237</span></span><br><span class="line">        <span class="function">SrsPublishRecvThread <span class="title">rtrd</span><span class="params">(rtmp, req, </span></span></span><br><span class="line"><span class="params"><span class="function">                                  srs_netfd_fileno(stfd), </span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="number">0</span>, <span class="keyword">this</span>, source, </span></span></span><br><span class="line"><span class="params"><span class="function">                                  _srs_context-&gt;get_id())</span></span>;</span><br><span class="line">        err = <span class="built_in">do_publishing</span>(source, &amp;rtrd);</span><br><span class="line">        rtrd.<span class="built_in">stop</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsRecvThread::do_cycle</code>中主要看到RTMP接收数据<code>rtmp-&gt;recv_message</code>，并且调用<code>pumper-&gt;consume(msg)</code>将处理消息。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRecvThread::do_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When the pumper is interrupted, wait then retry.</span></span><br><span class="line">        <span class="keyword">if</span> (pumper-&gt;<span class="built_in">interrupted</span>()) &#123;</span><br><span class="line">            <span class="built_in">srs_usleep</span>(timeout);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        SrsCommonMessage* msg = <span class="literal">NULL</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Process the received message.</span></span><br><span class="line">        <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">recv_message</span>(&amp;msg)) == srs_success) &#123;</span><br><span class="line">            err = pumper-&gt;<span class="built_in">consume</span>(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (err != srs_success) &#123;</span><br><span class="line">            <span class="comment">// Interrupt the receive thread for any error.</span></span><br><span class="line">            trd-&gt;<span class="built_in">interrupt</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Notify the pumper to quit for error.</span></span><br><span class="line">            pumper-&gt;<span class="built_in">interrupt</span>(err);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsRtmpServer::recv_message</code>调用<code>protocol-&gt;recv_message(pmsg)</code>处理。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsProtocol::recv_message</span><span class="params">(SrsCommonMessage** pmsg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *pmsg = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsCommonMessage* msg = <span class="literal">NULL</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">recv_interlaced_message</span>(&amp;msg)) != srs_success) &#123;</span><br><span class="line">            <span class="built_in">srs_freep</span>(msg);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv interlaced message&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!msg) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (msg-&gt;size &lt;= <span class="number">0</span> || msg-&gt;header.payload_length &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">srs_trace</span>(<span class="string">&quot;ignore empty message(type=%d, size=%d, time=%&quot;</span> PRId64 <span class="string">&quot;, sid=%d).&quot;</span>,</span><br><span class="line">                      msg-&gt;header.message_type, msg-&gt;header.payload_length,</span><br><span class="line">                      msg-&gt;header.timestamp, msg-&gt;header.stream_id);</span><br><span class="line">            <span class="built_in">srs_freep</span>(msg);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">on_recv_message</span>(msg)) != srs_success) &#123;</span><br><span class="line">            <span class="built_in">srs_freep</span>(msg);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;on recv message&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        *pmsg = msg;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>consume</code>消息处理。</li>
</ul>
<pre class="mermaid">graph TB
    F1[SrsPublishRecvThread::consume]-->F2[SrsRtmpConn::handle_publish_message]
    F2-->F3[SrsRtmpConn::process_publish_message]
    F3-->F3_1[SrsSource::on_audio]
    F3-->F3_2[SrsSource::on_video]
    F3-->F3_3[SrsSource::on_meta_data]
    F3_1-->F3_1_1[SrsSource::on_audio_imp]
    F3_1_1-->F3_1_1_1[SrsMetaCache::update_ash]
    F3_1_1-->F3_1_1_2[SrsConsumer::enqueue]</pre>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsPublishRecvThread::consume</span><span class="params">(SrsCommonMessage* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    err = _conn-&gt;<span class="built_in">handle_publish_message</span>(_source, msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>handle_publish_message</code>调用<code>process_publish_message</code></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::process_publish_message</span><span class="params">(SrsSource* source, SrsCommonMessage* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// process audio packet</span></span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;header.<span class="built_in">is_audio</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">on_audio</span>(msg)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: consume audio&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// process video packet</span></span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;header.<span class="built_in">is_video</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">on_video</span>(msg)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: consume video&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// process aggregate packet</span></span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;header.<span class="built_in">is_aggregate</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">on_aggregate</span>(msg)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: consume aggregate&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// process onMetaData</span></span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;header.<span class="built_in">is_amf0_data</span>() || msg-&gt;header.<span class="built_in">is_amf3_data</span>()) &#123;</span><br><span class="line">        SrsPacket* pkt = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">decode_message</span>(msg, &amp;pkt)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: decode message&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(SrsPacket, pkt);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">dynamic_cast</span>&lt;SrsOnMetaDataPacket*&gt;(pkt)) &#123;</span><br><span class="line">            SrsOnMetaDataPacket* metadata = <span class="built_in">dynamic_cast</span>&lt;SrsOnMetaDataPacket*&gt;(pkt);</span><br><span class="line">            <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">on_meta_data</span>(msg, metadata)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: consume metadata&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>跟踪音频流<code>source-&gt;on_audio</code>处理音频包，最终会调到<code>on_audio_imp</code>，将消息<code>SrsCommonMessage</code>推送到<code>SrsConsumer</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsSource::on_audio_imp</span><span class="params">(SrsSharedPtrMessage* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// copy to all consumer</span></span><br><span class="line">    <span class="keyword">if</span> (!drop_for_reduce) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; (<span class="type">int</span>)consumers.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            SrsConsumer* consumer = consumers.<span class="built_in">at</span>(i);</span><br><span class="line">            <span class="keyword">if</span> ((err = consumer-&gt;<span class="built_in">enqueue</span>(msg, atc, jitter_algorithm)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;consume message&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Copy to hub to all utilities.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = hub-&gt;<span class="built_in">on_audio</span>(msg)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;consume audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cache the sequence header of aac, or first packet of mp3.</span></span><br><span class="line">    <span class="comment">// for example, the mp3 is used for hls to write the &quot;right&quot; audio codec.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> to refine the stream info system.</span></span><br><span class="line">    <span class="comment">//保存sequence header</span></span><br><span class="line">    <span class="keyword">if</span> (is_aac_sequence_header || !meta-&gt;<span class="built_in">ash</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = meta-&gt;<span class="built_in">update_ash</span>(msg)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;meta consume audio&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// when sequence header, donot push to gop cache and adjust the timestamp.</span></span><br><span class="line">    <span class="keyword">if</span> (is_sequence_header) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cache the last gop packets</span></span><br><span class="line">    <span class="comment">//gop 缓存减少延迟</span></span><br><span class="line">    <span class="keyword">if</span> ((err = gop_cache-&gt;<span class="built_in">cache</span>(msg)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;gop cache consume audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="拉流端"><a href="#拉流端" class="headerlink" title="拉流端"></a>拉流端</h2><ul>
<li>控制相关。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpServer::start_play</span><span class="params">(<span class="type">int</span> stream_id)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>看到<code>source-&gt;create_consumer</code>创建消费者，推流端<code>SrsSource::on_audio_imp</code>中有消息将会推送<code>consumer-&gt;enqueue</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::playing</span><span class="params">(SrsSource* source)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// SrsSource的消费者，每个拉流端都会绑定一个SrsConsumer</span></span><br><span class="line">    <span class="comment">// Create a consumer of source.</span></span><br><span class="line">    SrsConsumer* consumer = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">create_consumer</span>(<span class="keyword">this</span>, consumer)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: create consumer&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsConsumer, consumer);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Use receiving thread to receive packets from peer.</span></span><br><span class="line">    <span class="comment">// @see: https://github.com/ossrs/srs/issues/217</span></span><br><span class="line">    <span class="comment">//接收消息的线程是每个SrsRtmpConn是独立的</span></span><br><span class="line">    <span class="function">SrsQueueRecvThread <span class="title">trd</span><span class="params">(consumer, rtmp, SRS_PERF_MW_SLEEP, _srs_context-&gt;get_id())</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = trd.<span class="built_in">start</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: start receive thread&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Deliver packets to peer.</span></span><br><span class="line">    wakable = consumer;</span><br><span class="line">    err = <span class="built_in">do_playing</span>(source, consumer, &amp;trd);</span><br><span class="line">    wakable = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    trd.<span class="built_in">stop</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Drop all packets in receiving thread.</span></span><br><span class="line">    <span class="keyword">if</span> (!trd.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="built_in">srs_warn</span>(<span class="string">&quot;drop the received %d messages&quot;</span>, trd.<span class="built_in">size</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>consumer-&gt;dump_packets</code>获取来自拉流端<code>SrsSource</code>传递给<code>SrsConsumer</code>的数据，并且发送数据给客户端。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::do_playing</span><span class="params">(SrsSource* source, SrsConsumer* consumer, SrsQueueRecvThread* rtrd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">// when source is set to expired, disconnect it.</span></span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: thread quit&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// collect elapse for pithy print.</span></span><br><span class="line">        pprint-&gt;<span class="built_in">elapse</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// to use isolate thread to recv, can improve about 33% performance.</span></span><br><span class="line">        <span class="comment">// @see: https://github.com/ossrs/srs/issues/196</span></span><br><span class="line">        <span class="comment">// @see: https://github.com/ossrs/srs/issues/217</span></span><br><span class="line">        <span class="keyword">while</span> (!rtrd-&gt;<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            SrsCommonMessage* msg = rtrd-&gt;<span class="built_in">pump</span>();</span><br><span class="line">            <span class="comment">//处理拉流客户端的控制消息</span></span><br><span class="line">            <span class="keyword">if</span> ((err = <span class="built_in">process_play_control_msg</span>(consumer, msg)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: play control message&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// quit when recv thread error.</span></span><br><span class="line">        <span class="keyword">if</span> ((err = rtrd-&gt;<span class="built_in">error_code</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: recv thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_PERF_QUEUE_COND_WAIT</span></span><br><span class="line">        <span class="comment">// wait for message to incoming.</span></span><br><span class="line">        <span class="comment">// @see https://github.com/ossrs/srs/issues/251</span></span><br><span class="line">        <span class="comment">// @see https://github.com/ossrs/srs/issues/257</span></span><br><span class="line">        <span class="keyword">if</span> (realtime) &#123;</span><br><span class="line">            <span class="comment">// for realtime, min required msgs is 0, send when got one+ msgs.</span></span><br><span class="line">            consumer-&gt;<span class="built_in">wait</span>(<span class="number">0</span>, mw_sleep);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// for no-realtime, got some msgs then send.</span></span><br><span class="line">            consumer-&gt;<span class="built_in">wait</span>(SRS_PERF_MW_MIN_MSGS, mw_sleep);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// get messages from consumer.</span></span><br><span class="line">        <span class="comment">// each msg in msgs.msgs must be free, for the SrsMessageArray never free them.</span></span><br><span class="line">        <span class="comment">// @remark when enable send_min_interval, only fetch one message a time.</span></span><br><span class="line">        <span class="type">int</span> count = (send_min_interval &gt; <span class="number">0</span>)? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//获取消息</span></span><br><span class="line">        <span class="keyword">if</span> ((err = consumer-&gt;<span class="built_in">dump_packets</span>(&amp;msgs, count)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: consumer dump packets&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// reportable</span></span><br><span class="line">        <span class="keyword">if</span> (pprint-&gt;<span class="built_in">can_print</span>()) &#123;</span><br><span class="line">            kbps-&gt;<span class="built_in">sample</span>();</span><br><span class="line">            <span class="built_in">srs_trace</span>(<span class="string">&quot;-&gt; &quot;</span> SRS_CONSTS_LOG_PLAY <span class="string">&quot; time=%d, msgs=%d, okbps=%d,%d,%d, ikbps=%d,%d,%d, mw=%d&quot;</span>,</span><br><span class="line">                (<span class="type">int</span>)pprint-&gt;<span class="built_in">age</span>(), count, kbps-&gt;<span class="built_in">get_send_kbps</span>(), kbps-&gt;<span class="built_in">get_send_kbps_30s</span>(), kbps-&gt;<span class="built_in">get_send_kbps_5m</span>(),</span><br><span class="line">                kbps-&gt;<span class="built_in">get_recv_kbps</span>(), kbps-&gt;<span class="built_in">get_recv_kbps_30s</span>(), kbps-&gt;<span class="built_in">get_recv_kbps_5m</span>(), <span class="built_in">srsu2msi</span>(mw_sleep));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> SRS_PERF_QUEUE_COND_WAIT</span></span><br><span class="line">            <span class="built_in">srs_usleep</span>(mw_sleep);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            <span class="comment">// ignore when nothing got.</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// only when user specifies the duration,</span></span><br><span class="line">        <span class="comment">// we start to collect the durations for each message.</span></span><br><span class="line">        <span class="keyword">if</span> (user_specified_duration_to_stop) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">                SrsSharedPtrMessage* msg = msgs.msgs[i];</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// foreach msg, collect the duration.</span></span><br><span class="line">                <span class="comment">// @remark: never use msg when sent it, for the protocol sdk will free it.</span></span><br><span class="line">                <span class="keyword">if</span> (starttime &lt; <span class="number">0</span> || starttime &gt; msg-&gt;timestamp) &#123;</span><br><span class="line">                    starttime = msg-&gt;timestamp;</span><br><span class="line">                &#125;</span><br><span class="line">                duration += (msg-&gt;timestamp - starttime) * SRS_UTIME_MILLISECONDS;</span><br><span class="line">                starttime = msg-&gt;timestamp;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// sendout messages, all messages are freed by send_and_free_messages().</span></span><br><span class="line">        <span class="comment">// no need to assert msg, for the rtmp will assert it.</span></span><br><span class="line">        <span class="comment">//发送数据给play客户端</span></span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span> &amp;&amp; (err = rtmp-&gt;<span class="built_in">send_and_free_messages</span>(msgs.msgs, count, info-&gt;res-&gt;stream_id)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: send %d messages&quot;</span>, count);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// if duration specified, and exceed it, stop play live.</span></span><br><span class="line">        <span class="comment">// @see: https://github.com/ossrs/srs/issues/45</span></span><br><span class="line">        <span class="keyword">if</span> (user_specified_duration_to_stop) &#123;</span><br><span class="line">            <span class="keyword">if</span> (duration &gt;= req-&gt;duration) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_RTMP_DURATION_EXCEED, <span class="string">&quot;rtmp: time %d up %d&quot;</span>, <span class="built_in">srsu2msi</span>(duration), <span class="built_in">srsu2msi</span>(req-&gt;duration));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// apply the minimal interval for delivery stream in srs_utime_t.</span></span><br><span class="line">        <span class="keyword">if</span> (send_min_interval &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">srs_usleep</span>(send_min_interval);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="RTMP协议"><a href="#RTMP协议" class="headerlink" title="RTMP协议"></a>RTMP协议</h1><h2 id="推流端-1"><a href="#推流端-1" class="headerlink" title="推流端"></a>推流端</h2><img src="/2023/09/30/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BRTMP/rtmp协议报文.png" alt="rtmp协议报文" style="zoom:50%;">

<ul>
<li>上述RTMP拉流端协程回调中会处理与客户端的握手<code>rtmp-&gt;handshake</code>，<code>rtmp-&gt;connect_app</code>连接命令等。后续处理跟踪<code>service_cycle</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">rs_error_t</span> <span class="title">SrsRtmpConn::do_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;RTMP client ip=%s, fd=%d&quot;</span>, ip.<span class="built_in">c_str</span>(), <span class="built_in">srs_netfd_fileno</span>(stfd));</span><br><span class="line">    </span><br><span class="line">    rtmp-&gt;<span class="built_in">set_recv_timeout</span>(SRS_CONSTS_RTMP_TIMEOUT);</span><br><span class="line">    rtmp-&gt;<span class="built_in">set_send_timeout</span>(SRS_CONSTS_RTMP_TIMEOUT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">handshake</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp handshake&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> rip = rtmp-&gt;<span class="built_in">proxy_real_ip</span>();</span><br><span class="line">    <span class="keyword">if</span> (rip &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">srs_trace</span>(<span class="string">&quot;RTMP proxy real client ip=%d.%d.%d.%d&quot;</span>,</span><br><span class="line">            <span class="built_in">uint8_t</span>(rip&gt;&gt;<span class="number">24</span>), <span class="built_in">uint8_t</span>(rip&gt;&gt;<span class="number">16</span>), <span class="built_in">uint8_t</span>(rip&gt;&gt;<span class="number">8</span>), <span class="built_in">uint8_t</span>(rip));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">connect_app</span>(req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp connect tcUrl&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// set client ip to request.</span></span><br><span class="line">    req-&gt;ip = ip;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;connect app, tcUrl=%s, pageUrl=%s, swfUrl=%s, schema=%s, vhost=%s, port=%d, app=%s, args=%s&quot;</span>,</span><br><span class="line">        req-&gt;tcUrl.<span class="built_in">c_str</span>(), req-&gt;pageUrl.<span class="built_in">c_str</span>(), req-&gt;swfUrl.<span class="built_in">c_str</span>(),</span><br><span class="line">        req-&gt;schema.<span class="built_in">c_str</span>(), req-&gt;vhost.<span class="built_in">c_str</span>(), req-&gt;port,</span><br><span class="line">        req-&gt;app.<span class="built_in">c_str</span>(), (req-&gt;args? <span class="string">&quot;(obj)&quot;</span>:<span class="string">&quot;null&quot;</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// show client identity</span></span><br><span class="line">    <span class="keyword">if</span>(req-&gt;args) &#123;</span><br><span class="line">        std::string srs_version;</span><br><span class="line">        std::string srs_server_ip;</span><br><span class="line">        <span class="type">int</span> srs_pid = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> srs_id = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        SrsAmf0Any* prop = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> ((prop = req-&gt;args-&gt;<span class="built_in">ensure_property_string</span>(<span class="string">&quot;srs_version&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            srs_version = prop-&gt;<span class="built_in">to_str</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((prop = req-&gt;args-&gt;<span class="built_in">ensure_property_string</span>(<span class="string">&quot;srs_server_ip&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            srs_server_ip = prop-&gt;<span class="built_in">to_str</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((prop = req-&gt;args-&gt;<span class="built_in">ensure_property_number</span>(<span class="string">&quot;srs_pid&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            srs_pid = (<span class="type">int</span>)prop-&gt;<span class="built_in">to_number</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((prop = req-&gt;args-&gt;<span class="built_in">ensure_property_number</span>(<span class="string">&quot;srs_id&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            srs_id = (<span class="type">int</span>)prop-&gt;<span class="built_in">to_number</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (srs_pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">srs_trace</span>(<span class="string">&quot;edge-srs ip=%s, version=%s, pid=%d, id=%d&quot;</span>,</span><br><span class="line">                srs_server_ip.<span class="built_in">c_str</span>(), srs_version.<span class="built_in">c_str</span>(), srs_pid, srs_id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">service_cycle</span>()) != srs_success) &#123;</span><br><span class="line">        err = <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;service cycle&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">srs_error_t</span> r0 = srs_success;</span><br><span class="line">    <span class="keyword">if</span> ((r0 = <span class="built_in">on_disconnect</span>()) != srs_success) &#123;</span><br><span class="line">        err = <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;on disconnect %s&quot;</span>, <span class="built_in">srs_error_desc</span>(r0).<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="built_in">srs_freep</span>(r0);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// If client is redirect to other servers, we already logged the event.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">srs_error_code</span>(err) == ERROR_CONTROL_REDIRECT) &#123;</span><br><span class="line">        <span class="built_in">srs_error_reset</span>(err);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>connect消息处理。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpServer::connect_app</span><span class="params">(SrsRequest* req)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    SrsCommonMessage* msg = <span class="literal">NULL</span>;</span><br><span class="line">    SrsConnectAppPacket* pkt = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//期望收到connect命令消息</span></span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">expect_message</span>&lt;SrsConnectAppPacket&gt;(&amp;msg, &amp;pkt)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;expect connect app response&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsCommonMessage, msg);</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsConnectAppPacket, pkt);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//从SrsConnectAppPacket读取对应的字段数据</span></span><br><span class="line">    SrsAmf0Any* prop = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((prop = pkt-&gt;command_object-&gt;<span class="built_in">ensure_property_string</span>(<span class="string">&quot;tcUrl&quot;</span>)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_RTMP_REQ_CONNECT, <span class="string">&quot;invalid request without tcUrl&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    req-&gt;tcUrl = prop-&gt;<span class="built_in">to_str</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((prop = pkt-&gt;command_object-&gt;<span class="built_in">ensure_property_string</span>(<span class="string">&quot;pageUrl&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        req-&gt;pageUrl = prop-&gt;<span class="built_in">to_str</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((prop = pkt-&gt;command_object-&gt;<span class="built_in">ensure_property_string</span>(<span class="string">&quot;swfUrl&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        req-&gt;swfUrl = prop-&gt;<span class="built_in">to_str</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((prop = pkt-&gt;command_object-&gt;<span class="built_in">ensure_property_number</span>(<span class="string">&quot;objectEncoding&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        req-&gt;objectEncoding = prop-&gt;<span class="built_in">to_number</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (pkt-&gt;args) &#123;</span><br><span class="line">        <span class="built_in">srs_freep</span>(req-&gt;args);</span><br><span class="line">        req-&gt;args = pkt-&gt;args-&gt;<span class="built_in">copy</span>()-&gt;<span class="built_in">to_object</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_discovery_tc_url</span>(req-&gt;tcUrl, req-&gt;schema, req-&gt;host, req-&gt;vhost, req-&gt;app, req-&gt;stream, req-&gt;port, req-&gt;param);</span><br><span class="line">    req-&gt;<span class="built_in">strip</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>解析消息，对于<code>recv_message</code>从TCP流式数据中获取chunk封装成<code>SrsCommonMessage</code>，对于<code>decode_message</code>将<code>SrsCommonMessage</code>封装成<code>SrsConnectAppPacket</code>对象数据。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">expect_message</span><span class="params">(SrsCommonMessage** pmsg, T** ppacket)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *pmsg = <span class="literal">NULL</span>;</span><br><span class="line">    *ppacket = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsCommonMessage* msg = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">recv_message</span>(&amp;msg)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv message&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        SrsPacket* packet = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">decode_message</span>(msg, &amp;packet)) != srs_success) &#123;</span><br><span class="line">            <span class="built_in">srs_freep</span>(msg);</span><br><span class="line">            <span class="built_in">srs_freep</span>(packet);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;decode message&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        T* pkt = <span class="built_in">dynamic_cast</span>&lt;T*&gt;(packet);</span><br><span class="line">        <span class="keyword">if</span> (!pkt) &#123;</span><br><span class="line">            <span class="built_in">srs_freep</span>(msg);</span><br><span class="line">            <span class="built_in">srs_freep</span>(packet);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        *pmsg = msg;</span><br><span class="line">        *ppacket = pkt;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>service_cycle</code>具体看下协议处理。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::service_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//设置窗口大小</span></span><br><span class="line">    <span class="type">int</span> out_ack_size = _srs_config-&gt;<span class="built_in">get_out_ack_size</span>(req-&gt;vhost);</span><br><span class="line">    <span class="keyword">if</span> (out_ack_size &amp;&amp; (err = rtmp-&gt;<span class="built_in">set_window_ack_size</span>(out_ack_size)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: set out window ack size&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> in_ack_size = _srs_config-&gt;<span class="built_in">get_in_ack_size</span>(req-&gt;vhost);</span><br><span class="line">    <span class="keyword">if</span> (in_ack_size &amp;&amp; (err = rtmp-&gt;<span class="built_in">set_in_window_ack_size</span>(in_ack_size)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: set in window ack size&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//设置带宽</span></span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">set_peer_bandwidth</span>((<span class="type">int</span>)(<span class="number">2.5</span> * <span class="number">1000</span> * <span class="number">1000</span>), <span class="number">2</span>)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: set peer bandwidth&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// get the ip which client connected.</span></span><br><span class="line">    std::string local_ip = <span class="built_in">srs_get_local_ip</span>(<span class="built_in">srs_netfd_fileno</span>(stfd));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// do bandwidth test if connect to the vhost which is for bandwidth check.</span></span><br><span class="line">    <span class="keyword">if</span> (_srs_config-&gt;<span class="built_in">get_bw_check_enabled</span>(req-&gt;vhost)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = bandwidth-&gt;<span class="built_in">bandwidth_check</span>(rtmp, skt, req, local_ip)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: bandwidth check&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// set chunk size to larger.</span></span><br><span class="line">    <span class="comment">// set the chunk size before any larger response greater than 128,</span></span><br><span class="line">    <span class="comment">// to make OBS happy, @see https://github.com/ossrs/srs/issues/454</span></span><br><span class="line">    <span class="comment">//设置chunk size 一般60k</span></span><br><span class="line">    <span class="type">int</span> chunk_size = _srs_config-&gt;<span class="built_in">get_chunk_size</span>(req-&gt;vhost);</span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">set_chunk_size</span>(chunk_size)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: set chunk size %d&quot;</span>, chunk_size);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// response the client connect ok.</span></span><br><span class="line">    <span class="comment">//响应客户端</span></span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">response_connect_app</span>(req, local_ip.<span class="built_in">c_str</span>())) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: response connect app&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">on_bw_done</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: on bw down&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: thread quit&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        err = <span class="built_in">stream_service_cycle</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// stream service must terminated with error, never success.</span></span><br><span class="line">        <span class="comment">// when terminated with success, it&#x27;s user required to stop.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> Support RTMP client timeout, https://github.com/ossrs/srs/issues/1134</span></span><br><span class="line">        <span class="keyword">if</span> (err == srs_success) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// when not system control error, fatal error, return.</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">srs_is_system_control_error</span>(err)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: stream service&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// for republish, continue service</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">srs_error_code</span>(err) == ERROR_CONTROL_REPUBLISH) &#123;</span><br><span class="line">            <span class="comment">// set timeout to a larger value, wait for encoder to republish.</span></span><br><span class="line">            rtmp-&gt;<span class="built_in">set_send_timeout</span>(SRS_REPUBLISH_RECV_TIMEOUT);</span><br><span class="line">            rtmp-&gt;<span class="built_in">set_recv_timeout</span>(SRS_REPUBLISH_SEND_TIMEOUT);</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">srs_info</span>(<span class="string">&quot;rtmp: retry for republish&quot;</span>);</span><br><span class="line">            <span class="built_in">srs_freep</span>(err);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// for &quot;some&quot; system control error,</span></span><br><span class="line">        <span class="comment">// logical accept and retry stream service.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">srs_error_code</span>(err) == ERROR_CONTROL_RTMP_CLOSE) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> use ping message to anti-death of socket.</span></span><br><span class="line">            <span class="comment">// @see: https://github.com/ossrs/srs/issues/39</span></span><br><span class="line">            <span class="comment">// set timeout to a larger value, for user paused.</span></span><br><span class="line">            rtmp-&gt;<span class="built_in">set_recv_timeout</span>(SRS_PAUSED_RECV_TIMEOUT);</span><br><span class="line">            rtmp-&gt;<span class="built_in">set_send_timeout</span>(SRS_PAUSED_SEND_TIMEOUT);</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">srs_trace</span>(<span class="string">&quot;rtmp: retry for close&quot;</span>);</span><br><span class="line">            <span class="built_in">srs_freep</span>(err);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// for other system control message, fatal error.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: reject&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>继续跟踪到<code>stream_service_cycle</code>中<code>rtmp-&gt;start_fmle_publish</code>，处理FCPublish、createStream、publish等消息。FCPublish命令是一个用于通知服务器要发布新流的RTMP命令，而Publish命令是用于告诉服务器要发布特定流的RTMP命令。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpServer::start_fmle_publish</span><span class="params">(<span class="type">int</span> stream_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// FCPublish</span></span><br><span class="line">    <span class="type">double</span> fc_publish_tid = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsCommonMessage* msg = <span class="literal">NULL</span>;</span><br><span class="line">        SrsFMLEStartPacket* pkt = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">expect_message</span>&lt;SrsFMLEStartPacket&gt;(&amp;msg, &amp;pkt)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv FCPublish&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(SrsCommonMessage, msg);</span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(SrsFMLEStartPacket, pkt);</span><br><span class="line">        </span><br><span class="line">        fc_publish_tid = pkt-&gt;transaction_id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// FCPublish response</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsFMLEStartResPacket* pkt = <span class="keyword">new</span> <span class="built_in">SrsFMLEStartResPacket</span>(fc_publish_tid);</span><br><span class="line">        <span class="keyword">if</span> ((err = protocol-&gt;<span class="built_in">send_and_free_packet</span>(pkt, <span class="number">0</span>)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send FCPublish response&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// createStream</span></span><br><span class="line">    <span class="type">double</span> create_stream_tid = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsCommonMessage* msg = <span class="literal">NULL</span>;</span><br><span class="line">        SrsCreateStreamPacket* pkt = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">expect_message</span>&lt;SrsCreateStreamPacket&gt;(&amp;msg, &amp;pkt)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv createStream&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(SrsCommonMessage, msg);</span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(SrsCreateStreamPacket, pkt);</span><br><span class="line">        </span><br><span class="line">        create_stream_tid = pkt-&gt;transaction_id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// createStream response</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsCreateStreamResPacket* pkt = <span class="keyword">new</span> <span class="built_in">SrsCreateStreamResPacket</span>(create_stream_tid, stream_id);</span><br><span class="line">        <span class="keyword">if</span> ((err = protocol-&gt;<span class="built_in">send_and_free_packet</span>(pkt, <span class="number">0</span>)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send createStream response&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// publish</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsCommonMessage* msg = <span class="literal">NULL</span>;</span><br><span class="line">        SrsPublishPacket* pkt = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">expect_message</span>&lt;SrsPublishPacket&gt;(&amp;msg, &amp;pkt)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv publish&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(SrsCommonMessage, msg);</span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(SrsPublishPacket, pkt);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// publish response onFCPublish(NetStream.Publish.Start)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsOnStatusCallPacket* pkt = <span class="keyword">new</span> <span class="built_in">SrsOnStatusCallPacket</span>();</span><br><span class="line">        </span><br><span class="line">        pkt-&gt;command_name = RTMP_AMF0_COMMAND_ON_FC_PUBLISH;</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusCode, SrsAmf0Any::<span class="built_in">str</span>(StatusCodePublishStart));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusDescription, SrsAmf0Any::<span class="built_in">str</span>(<span class="string">&quot;Started publishing stream.&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = protocol-&gt;<span class="built_in">send_and_free_packet</span>(pkt, stream_id)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send NetStream.Publish.Start&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// publish response onStatus(NetStream.Publish.Start)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsOnStatusCallPacket* pkt = <span class="keyword">new</span> <span class="built_in">SrsOnStatusCallPacket</span>();</span><br><span class="line">        </span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusLevel, SrsAmf0Any::<span class="built_in">str</span>(StatusLevelStatus));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusCode, SrsAmf0Any::<span class="built_in">str</span>(StatusCodePublishStart));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusDescription, SrsAmf0Any::<span class="built_in">str</span>(<span class="string">&quot;Started publishing stream.&quot;</span>));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusClientId, SrsAmf0Any::<span class="built_in">str</span>(RTMP_SIG_CLIENT_ID));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = protocol-&gt;<span class="built_in">send_and_free_packet</span>(pkt, stream_id)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send NetStream.Publish.Start&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="拉流端-1"><a href="#拉流端-1" class="headerlink" title="拉流端"></a>拉流端</h2><ul>
<li>拉流端大部分和推流一样，拉流进入<code>rsRtmpServer::start_play</code>分支。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpServer::start_play</span><span class="params">(<span class="type">int</span> stream_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// StreamBegin</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsUserControlPacket* pkt = <span class="keyword">new</span> <span class="built_in">SrsUserControlPacket</span>();</span><br><span class="line">        pkt-&gt;event_type = SrcPCUCStreamBegin;</span><br><span class="line">        pkt-&gt;event_data = stream_id;</span><br><span class="line">        <span class="keyword">if</span> ((err = protocol-&gt;<span class="built_in">send_and_free_packet</span>(pkt, <span class="number">0</span>)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send StreamBegin&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// onStatus(NetStream.Play.Reset)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsOnStatusCallPacket* pkt = <span class="keyword">new</span> <span class="built_in">SrsOnStatusCallPacket</span>();</span><br><span class="line">        </span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusLevel, SrsAmf0Any::<span class="built_in">str</span>(StatusLevelStatus));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusCode, SrsAmf0Any::<span class="built_in">str</span>(StatusCodeStreamReset));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusDescription, SrsAmf0Any::<span class="built_in">str</span>(<span class="string">&quot;Playing and resetting stream.&quot;</span>));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusDetails, SrsAmf0Any::<span class="built_in">str</span>(<span class="string">&quot;stream&quot;</span>));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusClientId, SrsAmf0Any::<span class="built_in">str</span>(RTMP_SIG_CLIENT_ID));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = protocol-&gt;<span class="built_in">send_and_free_packet</span>(pkt, stream_id)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send NetStream.Play.Reset&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// onStatus(NetStream.Play.Start)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsOnStatusCallPacket* pkt = <span class="keyword">new</span> <span class="built_in">SrsOnStatusCallPacket</span>();</span><br><span class="line">        </span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusLevel, SrsAmf0Any::<span class="built_in">str</span>(StatusLevelStatus));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusCode, SrsAmf0Any::<span class="built_in">str</span>(StatusCodeStreamStart));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusDescription, SrsAmf0Any::<span class="built_in">str</span>(<span class="string">&quot;Started playing stream.&quot;</span>));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusDetails, SrsAmf0Any::<span class="built_in">str</span>(<span class="string">&quot;stream&quot;</span>));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusClientId, SrsAmf0Any::<span class="built_in">str</span>(RTMP_SIG_CLIENT_ID));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = protocol-&gt;<span class="built_in">send_and_free_packet</span>(pkt, stream_id)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send NetStream.Play.Start&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// |RtmpSampleAccess(false, false)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsSampleAccessPacket* pkt = <span class="keyword">new</span> <span class="built_in">SrsSampleAccessPacket</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// allow audio/video sample.</span></span><br><span class="line">        <span class="comment">// @see: https://github.com/ossrs/srs/issues/49</span></span><br><span class="line">        pkt-&gt;audio_sample_access = <span class="literal">true</span>;</span><br><span class="line">        pkt-&gt;video_sample_access = <span class="literal">true</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = protocol-&gt;<span class="built_in">send_and_free_packet</span>(pkt, stream_id)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send |RtmpSampleAccess true&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// onStatus(NetStream.Data.Start)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsOnStatusDataPacket* pkt = <span class="keyword">new</span> <span class="built_in">SrsOnStatusDataPacket</span>();</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusCode, SrsAmf0Any::<span class="built_in">str</span>(StatusCodeDataStart));</span><br><span class="line">        <span class="keyword">if</span> ((err = protocol-&gt;<span class="built_in">send_and_free_packet</span>(pkt, stream_id)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send NetStream.Data.Start&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/09/29/nginx%E6%90%AD%E5%BB%BAHLS/" rel="prev" title="nginx搭建HLS">
                  <i class="fa fa-angle-left"></i> nginx搭建HLS
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/10/02/SRC%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BHTTP-FLV/" rel="next" title="SRC流媒体服务器之HTTP-FLV">
                  SRC流媒体服务器之HTTP-FLV <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Fang</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"neutral","dark":"neutral"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.3.0/mermaid.min.js","integrity":"sha256-9y71g5Lz/KLsHjB8uXwnkuWDtAMDSzD/HdIbqhJfTAI="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





</body>
</html>
