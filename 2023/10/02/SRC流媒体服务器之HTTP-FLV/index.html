<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CPT+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"fang0407.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="HTTP-FLV介绍 HTTP协议中有个约定：Content-Length字段，HTTP服务器回复HTTP请求的时候如果有这个字段，客户端就接收这个⻓度的数据然后就认为数据传输完成了，如果服务器回复HTTP请求中没有这个字段，客户端就⼀直接收数据，直到服务器跟客户端的socket连接断开。 HTTP-FLV直播就是利⽤了这个原理，服务器回复客户端请求的时候不加Content-Length字段，在回">
<meta property="og:type" content="article">
<meta property="og:title" content="SRC流媒体服务器之HTTP-FLV">
<meta property="og:url" content="https://fang0407.github.io/2023/10/02/SRC%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BHTTP-FLV/index.html">
<meta property="og:site_name" content="NOTE">
<meta property="og:description" content="HTTP-FLV介绍 HTTP协议中有个约定：Content-Length字段，HTTP服务器回复HTTP请求的时候如果有这个字段，客户端就接收这个⻓度的数据然后就认为数据传输完成了，如果服务器回复HTTP请求中没有这个字段，客户端就⼀直接收数据，直到服务器跟客户端的socket连接断开。 HTTP-FLV直播就是利⽤了这个原理，服务器回复客户端请求的时候不加Content-Length字段，在回">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-10-02T02:07:31.000Z">
<meta property="article:modified_time" content="2023-12-30T14:37:44.016Z">
<meta property="article:author" content="Fang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://fang0407.github.io/2023/10/02/SRC%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BHTTP-FLV/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://fang0407.github.io/2023/10/02/SRC%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BHTTP-FLV/","path":"2023/10/02/SRC流媒体服务器之HTTP-FLV/","title":"SRC流媒体服务器之HTTP-FLV"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>SRC流媒体服务器之HTTP-FLV | NOTE</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">NOTE</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#HTTP-FLV%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.</span> <span class="nav-text">HTTP-FLV介绍</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#HTTP-FLV%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">2.</span> <span class="nav-text">HTTP-FLV源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E2%BD%82%E4%BB%B6"><span class="nav-number">2.1.</span> <span class="nav-text">配置⽂件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90"><span class="nav-number">2.2.</span> <span class="nav-text">调试分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E7%B1%BB"><span class="nav-number">2.2.1.</span> <span class="nav-text">核心类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%91%E5%90%AC"><span class="nav-number">2.2.2.</span> <span class="nav-text">监听</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A8%E6%B5%81%E7%AB%AF"><span class="nav-number">2.2.3.</span> <span class="nav-text">推流端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8B%89%E6%B5%81%E7%AB%AF"><span class="nav-number">2.2.4.</span> <span class="nav-text">拉流端</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Fang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">90</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/10/02/SRC%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BHTTP-FLV/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="SRC流媒体服务器之HTTP-FLV | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SRC流媒体服务器之HTTP-FLV
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-10-02 10:07:31" itemprop="dateCreated datePublished" datetime="2023-10-02T10:07:31+08:00">2023-10-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-12-30 22:37:44" itemprop="dateModified" datetime="2023-12-30T22:37:44+08:00">2023-12-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SRS/" itemprop="url" rel="index"><span itemprop="name">SRS</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="HTTP-FLV介绍"><a href="#HTTP-FLV介绍" class="headerlink" title="HTTP-FLV介绍"></a>HTTP-FLV介绍</h1><ul>
<li>HTTP协议中有个约定：Content-Length字段，HTTP服务器回复HTTP请求的时候如果有这个字段，客户端就接收这个⻓度的数据然后就认为数据传输完成了，如果服务器回复HTTP请求中没有这个字段，客户端就⼀直接收数据，直到服务器跟客户端的socket连接断开。</li>
<li>HTTP-FLV直播就是利⽤了这个原理，服务器回复客户端请求的时候不加Content-Length字段，在回复了HTTP内容之后，紧接着发送FLV数据，客户端就⼀直接收数据了。 </li>
<li>HTTP-FLV报文格式：</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/live/livestream.flv</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Lavf/59.30.100</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Range</span><span class="punctuation">: </span>bytes=0-</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.2.9:8080</span><br><span class="line"><span class="attribute">Icy-MetaData</span><span class="punctuation">: </span>1</span><br><span class="line"></span><br><span class="line"><span class="language-http"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span></span><br><span class="line"><span class="language-http"><span class="attribute">Connection</span><span class="punctuation">: </span>Close</span></span><br><span class="line"><span class="language-http"><span class="attribute">Content-Type</span><span class="punctuation">: </span>video/x-flv</span></span><br><span class="line"><span class="language-http"><span class="attribute">Server</span><span class="punctuation">: </span>SRS/6.0.75(Bee)</span></span><br><span class="line"><span class="language-http"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span></span><br><span class="line"><span class="language-http"></span></span><br><span class="line"><span class="language-http"><span class="language-jboss-cli">9</span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http">FLV.<span class="string">....</span>	</span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http">4</span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http"><span class="string">....</span></span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http">df91</span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http"><span class="string">.............</span></span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http">onMetaData.<span class="string">..width.</span>@<span class="string">.........height.</span>@t.<span class="string">......</span></span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http">videodatarate.@i.P.<span class="string">....</span>	framerate.@9.<span class="string">.......videocodecid.</span>@<span class="string">........</span></span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http">audiodatarate.@=T@<span class="string">......audiosamplerate.</span>@<span class="string">.........audiosamplesize.</span>@0.<span class="string">.......stereo....audiocodecid.</span>@$<span class="string">........major_brand...isom.</span></span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http">minor_<span class="keyword">version</span>.<span class="string">..512..compatible_brands...isomiso2avc1mp41..encoder..</span></span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http">Lavf59.30.100.<span class="string">.filesize...........server...SRS/6.0.75</span><span class="params">(Bee)</span><span class="string">..server_version...6.0.75.</span></span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http"><span class="comment">#省略</span></span></span></span><br></pre></td></tr></table></figure>

<h1 id="HTTP-FLV源码分析"><a href="#HTTP-FLV源码分析" class="headerlink" title="HTTP-FLV源码分析"></a>HTTP-FLV源码分析</h1><h2 id="配置⽂件"><a href="#配置⽂件" class="headerlink" title="配置⽂件"></a>配置⽂件</h2><p>修改<code>conf/http.flv.live.conf</code>文件，<code>./objs/srs -c conf/http.flv.live.conf</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">listen              1935;</span><br><span class="line">max_connections     1000;</span><br><span class="line">daemon              off;</span><br><span class="line">srs_log_tank        console;</span><br><span class="line">http_server &#123;</span><br><span class="line">    enabled         on;</span><br><span class="line">    listen          8080;</span><br><span class="line">    dir             ./objs/nginx/html;</span><br><span class="line">&#125;</span><br><span class="line">vhost __defaultVhost__ &#123;</span><br><span class="line">    http_remux &#123;</span><br><span class="line">        enabled     on;</span><br><span class="line">        mount       [vhost]/[app]/[stream].flv;  # ⽀持.flv .ts .aac .mp3的使⽤</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="调试分析"><a href="#调试分析" class="headerlink" title="调试分析"></a>调试分析</h2><h3 id="核心类"><a href="#核心类" class="headerlink" title="核心类"></a>核心类</h3><ul>
<li><p><code>SrsBufferCache</code>：HTTP直播流编码器的缓存。</p>
</li>
<li><p><code>SrsFlvStreamEncoder</code>：将RTMP转成HTTP FLV流。</p>
</li>
<li><p><code>SrsTsStreamEncoder</code>：将RTMP转成HTTP TS流。</p>
</li>
<li><p><code>SrsAacStreamEncoder</code>：将RTMP含有的AAC成分转成HTTP AAC流。</p>
</li>
<li><p><code>SrsMp3StreamEncoder</code>：将RTMP含有的MP3成分转成HTTP MP3流。</p>
</li>
<li><p><code>SrsBufferWriter</code>：将流直接写⼊到HTTP响应。</p>
</li>
<li><p><code>SrsLiveStream</code>：HTTP直播流，将RTMP转成HTTP-FLV或者其他格式，其实际是handler。</p>
</li>
<li><p><code>SrsLiveEntry</code>：直播⼊⼝，⽤来处理HTTP直播流。</p>
</li>
<li><p><code>SrsHttpStreamServer</code>：HTTP直播流服务，服务FLV&#x2F;TS&#x2F;MP3&#x2F;AAC流。</p>
</li>
<li><p><code>SrsHttpResponseWriter</code>：负责将数据发送给客户端，本质是调⽤SrsStSocket进⾏发送。</p>
</li>
<li><p><code>SrsHttpServeMux</code>：HTTP请求多路复⽤器，说⽩了就是路由，⾥⾯记录了path以及对应的handler。</p>
</li>
</ul>
<h3 id="监听"><a href="#监听" class="headerlink" title="监听"></a>监听</h3><ul>
<li>监听进入<code>SrsServer::listen_http_stream</code>，流程与RTMP监听一样。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsServer::listen_http_stream</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">close_listeners</span>(SrsListenerHttpStream);</span><br><span class="line">    <span class="keyword">if</span> (_srs_config-&gt;<span class="built_in">get_http_stream_enabled</span>()) &#123;</span><br><span class="line">        <span class="comment">//SrsListenerHttpStream</span></span><br><span class="line">        SrsListener* listener = <span class="keyword">new</span> <span class="built_in">SrsBufferListener</span>(<span class="keyword">this</span>, SrsListenerHttpStream);</span><br><span class="line">        listeners.<span class="built_in">push_back</span>(listener);</span><br><span class="line">        </span><br><span class="line">        std::string ep = _srs_config-&gt;<span class="built_in">get_http_stream_listen</span>();</span><br><span class="line">        </span><br><span class="line">        std::string ip;</span><br><span class="line">        <span class="type">int</span> port;</span><br><span class="line">        <span class="built_in">srs_parse_endpoint</span>(ep, ip, port);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = listener-&gt;<span class="built_in">listen</span>(ip, port)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;http stream listen %s:%d&quot;</span>, ip.<span class="built_in">c_str</span>(), port);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>监听类型是<code>SrsListenerHttpStream</code>，创建<code>SrsResponseOnlyHttpConn</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsServer::fd2conn</span><span class="params">(SrsListenerType type, <span class="type">srs_netfd_t</span> stfd, SrsConnection** pconn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (type == SrsListenerRtmpStream) &#123;</span><br><span class="line">        *pconn = <span class="keyword">new</span> <span class="built_in">SrsRtmpConn</span>(<span class="keyword">this</span>, stfd, ip);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == SrsListenerHttpApi) &#123;</span><br><span class="line">        *pconn = <span class="keyword">new</span> <span class="built_in">SrsHttpApi</span>(<span class="keyword">this</span>, stfd, http_api_mux, ip);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == SrsListenerHttpStream) &#123;</span><br><span class="line">        *pconn = <span class="keyword">new</span> <span class="built_in">SrsResponseOnlyHttpConn</span>(<span class="keyword">this</span>, stfd, http_server, ip);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">srs_warn</span>(<span class="string">&quot;close for no service handler. fd=%d, ip=%s&quot;</span>, fd, ip.<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="built_in">srs_close_stfd</span>(stfd);</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="推流端"><a href="#推流端" class="headerlink" title="推流端"></a>推流端</h3><p>推流主要根据URL创建对应的<code>ISrsHttpHandler</code>。</p>
<ul>
<li>根据配置文件关键字<code>http_remux</code>查找，断点<code>SrsConfig::get_vhost_http_remux_enabled</code>。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#0 SrsConfig::get_vhost_http_remux_enabled (this=0xa0fcf0, vhost=&quot;__defaultVhost__&quot;)</span><br><span class="line">   at src/app/srs_app_config.cpp:6886</span><br><span class="line">#1 0x00000000005029cf in SrsHttpStreamServer::initialize_flv_entry this=0xallfd0, vhost=&quot;__defaultVhost__&quot;)</span><br><span class="line">   at src/app/srs_app_http_stream.cpp:1166</span><br><span class="line">#2 0x00000000005028d3 in SrsHttpStreamServer::initialize_flv_streaming (this=0xa11fd0)</span><br><span class="line">   at src/app/srs_app_http_stream.cpp:1154</span><br><span class="line">#3 0x0000000000500a2a in SrsHttpStreamServer::initialize (this=0xallfd0)</span><br><span class="line">   at src/app/srs_app_http_stream.cpp:873</span><br><span class="line">#4 0x0000000000561eb7 in SrsHttpServer::initialize (this=0xalle00) at src/app/srs_app_http_conn.cpp:279</span><br><span class="line">#5 0x00000000004c84c0 in SrsServer::initialize (this=0xallea0, ch=0x0) at src/app/srs_app_server.cpp:757</span><br><span class="line">#6 0x00000000005bcb57 in run (svr=0xa11ea0) at src/main/srs_main_server.cpp:395</span><br><span class="line">#7 0x00000000005bb769 in do_main (argc=3, argv=0x7fffffffe4f8) at src/main/srs_main_server.cpp:184</span><br><span class="line">#8 0x00000000005bb8ad in main (argc=3, argv=0x7fffffffe4f8) at src/main/srs_main_server.cpp:192</span><br></pre></td></tr></table></figure>

<ul>
<li><code>initialize_flv_entry</code>，创建<code>SrsLiveEntry</code>用于处理HTTP直播流并保存。</li>
<li><code>tflvs</code>根据配置创建并保存HTTP直播流地址模板，提供给<code>sflvs</code>使用。</li>
<li><code>sflvs</code>在<code>SrsHttpStreamServer::http_mount</code>中赋值，用于HTTP直播流。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpStreamServer::initialize_flv_entry</span><span class="params">(std::string vhost)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!_srs_config-&gt;<span class="built_in">get_vhost_http_remux_enabled</span>(vhost)) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    SrsLiveEntry* entry = <span class="keyword">new</span> <span class="built_in">SrsLiveEntry</span>(_srs_config-&gt;<span class="built_in">get_vhost_http_remux_mount</span>(vhost));</span><br><span class="line">    </span><br><span class="line">    tflvs[vhost] = entry;</span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;http flv live stream, vhost=%s, mount=%s&quot;</span>, vhost.<span class="built_in">c_str</span>(), entry-&gt;mount.<span class="built_in">c_str</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>do_main</code>函数初始化srs服务。</li>
<li>其中<code>SrsHttpServeMux</code>用于公共路由规则。</li>
<li><code>SrsHttpServer</code>包含<code>SrsHttpStreamServer</code>和<code>SrsHttpStaticServer</code>。<ul>
<li><code>SrsHttpStreamServer</code>用于HTTP直播流。</li>
<li><code>SrsHttpStaticServer</code>用于HTTP静态文件访问。</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">SrsServer::<span class="built_in">SrsServer</span>()</span><br><span class="line">&#123;</span><br><span class="line">    signal_reload = <span class="literal">false</span>;</span><br><span class="line">    signal_persistence_config = <span class="literal">false</span>;</span><br><span class="line">    signal_gmc_stop = <span class="literal">false</span>;</span><br><span class="line">    signal_fast_quit = <span class="literal">false</span>;</span><br><span class="line">    signal_gracefully_quit = <span class="literal">false</span>;</span><br><span class="line">    pid_fd = <span class="number">-1</span>;</span><br><span class="line">    </span><br><span class="line">    signal_manager = <span class="keyword">new</span> <span class="built_in">SrsSignalManager</span>(<span class="keyword">this</span>);</span><br><span class="line">    conn_manager = <span class="keyword">new</span> <span class="built_in">SrsCoroutineManager</span>();</span><br><span class="line">    </span><br><span class="line">    handler = <span class="literal">NULL</span>;</span><br><span class="line">    ppid = ::<span class="built_in">getppid</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// donot new object in constructor,</span></span><br><span class="line">    <span class="comment">// for some global instance is not ready now,</span></span><br><span class="line">    <span class="comment">// new these objects in initialize instead.</span></span><br><span class="line">    http_api_mux = <span class="keyword">new</span> <span class="built_in">SrsHttpServeMux</span>();</span><br><span class="line">    http_server = <span class="keyword">new</span> <span class="built_in">SrsHttpServer</span>(<span class="keyword">this</span>);</span><br><span class="line">    http_heartbeat = <span class="keyword">new</span> <span class="built_in">SrsHttpHeartbeat</span>();</span><br><span class="line">    ingester = <span class="keyword">new</span> <span class="built_in">SrsIngester</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>断点<code>SrsHttpStreamServer::http_mount </code>，看下推流具体堆栈。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#0 0x0000000000500ffa in SrsHttpStreamServer::http_mount (this=0xa11dc0, s=0xa3bf80, r=0xa3ae90)</span><br><span class="line">   at src/app/srs_app_http_stream.cpp:907</span><br><span class="line">#1 0x00000000005620f5 in SrsHttpServer::http_mount (this=0xa118f0, s=0xa3bf80, r=0xa3ae90)</span><br><span class="line">   at src/app/srs_app_http_conn.cpp:308</span><br><span class="line">#2 0x00000000004cd3cc in SrsServer::on_publish (this=0xa103a0, s=0xa3bf80, r=0xa3ae90)</span><br><span class="line">   at src/app/srs_app_server.cpp:1608</span><br><span class="line">#3 0x00000000004e6a9b in SrsSource::on_publish (this=0xa3bf80) at src/app/srs_app_source.cpp:2466</span><br><span class="line">#4 0x00000000004d89f2 in SrsRtmpConn::acquire_publish (this=0xa30ce0, source=0xa3bf80)</span><br><span class="line">   at src/app/srs_app_rtmp_conn.cpp:940</span><br><span class="line">#5 0x00000000004d7a74 in SrsRtmpConn::publishing (this=0xa30ce0, source=0xa3bf80)</span><br><span class="line">   at src/app/srs_app_rtmp_conn.cpp:822</span><br><span class="line">#6 0x00000000004d5229 in SrsRtmpConn::stream_service_cycle (this=0xa30ce0)</span><br><span class="line">   at src/app/srs_app_rtmp_conn.cpp:534</span><br><span class="line">#7 0x00000000004d4141 in SrsRtmpConn::service_cycle (this=0xa30ce0) at src/app/srs_app_rtmp_conn.cpp:388</span><br><span class="line">#8 0x00000000004d2f09 in SrsRtmpConn::do_cycle (this=0xa30ce0) at src/app/srs_app_rtmp_conn.cpp:209</span><br><span class="line">#9 0x00000000004d10fb in SrsConnection::cycle (this=0xa30d58) at src/app/srs_app_conn.cpp:171</span><br><span class="line">#10 0x0000000000509c88 in SrsSTCoroutine::cycle (this=0xa30f70) at src/app/srs_app_st.cpp:198</span><br><span class="line">#11 0x0000000000509cfd in SrsSTCoroutine::pfn (arg=0xa30f70) at src/app/srs_app_st.cpp:213</span><br><span class="line">#12 0x00000000005bdd9d in _st_thread_main () at sched.c:337</span><br><span class="line">#13 0x00000000005be515 in st_thread_create (start=0x5bd719 &lt;_st_vp_schedule+170&gt;, </span><br><span class="line">    arg=0x700000001, joinable=1, stk_size=1) at sched.c:616</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsRtmpConn::acquire_publish</code>中<code>info-&gt;edge</code>分支是用来edge边缘推流的，该流程处理在另一个分支<code>source-&gt;on_publish</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::acquire_publish</span><span class="params">(SrsSource* source)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!source-&gt;<span class="built_in">can_publish</span>(info-&gt;edge)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_SYSTEM_STREAM_BUSY, </span><br><span class="line">                             <span class="string">&quot;rtmp: stream %s is busy&quot;</span>, </span><br><span class="line">                             req-&gt;<span class="built_in">get_stream_url</span>().<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// when edge, ignore the publish event, directly proxy it.</span></span><br><span class="line">    <span class="keyword">if</span> (info-&gt;edge) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">on_edge_start_publish</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: edge start publish&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">on_publish</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: source publish&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用<code>source-&gt;on_publish</code>进入<code>SrsServer::on_publish</code>，调用<code>http_server-&gt;http_mount</code>创建路由规则。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsServer::on_publish</span><span class="params">(SrsSource* s, SrsRequest* r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = http_server-&gt;<span class="built_in">http_mount</span>(s, r)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;http mount&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//源站集群</span></span><br><span class="line">    SrsCoWorkers* coworkers = SrsCoWorkers::<span class="built_in">instance</span>();</span><br><span class="line">    <span class="keyword">if</span> ((err = coworkers-&gt;<span class="built_in">on_publish</span>(s, r)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;coworkers&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>对于同一个推流端，<code>SrsLiveEntry</code>和<code>SrsLiveStream</code>是一一对应的。</li>
<li><code>SrsLiveEntry</code>是用来处理URL映射关系的；</li>
<li><code>SrsLiveStream</code>主要是给HTTP拉流客户端访问的。</li>
<li>同一路的多个拉流客户端公用一个<code>SrsLiveStream</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpStreamServer::http_mount</span><span class="params">(SrsSource* s, SrsRequest* r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// the id to identify stream.</span></span><br><span class="line">    <span class="comment">//比如/live/stream</span></span><br><span class="line">    std::string sid = r-&gt;<span class="built_in">get_stream_url</span>();</span><br><span class="line">    SrsLiveEntry* entry = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// create stream from template when not found.</span></span><br><span class="line">    <span class="keyword">if</span> (sflvs.<span class="built_in">find</span>(sid) == sflvs.<span class="built_in">end</span>()) &#123;</span><br><span class="line">        <span class="comment">//查找对应vhost，比如__defaultVhost__</span></span><br><span class="line">        <span class="keyword">if</span> (tflvs.<span class="built_in">find</span>(r-&gt;vhost) == tflvs.<span class="built_in">end</span>()) &#123; <span class="comment">//vhost</span></span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取SrsLiveEntry</span></span><br><span class="line">        SrsLiveEntry* tmpl = tflvs[r-&gt;vhost];</span><br><span class="line">        <span class="comment">//mount 比如[vhost]/[app]/[stream].flv</span></span><br><span class="line">        std::string mount = tmpl-&gt;mount;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// replace the vhost variable</span></span><br><span class="line">        mount = <span class="built_in">srs_string_replace</span>(mount, <span class="string">&quot;[vhost]&quot;</span>, r-&gt;vhost);</span><br><span class="line">        mount = <span class="built_in">srs_string_replace</span>(mount, <span class="string">&quot;[app]&quot;</span>, r-&gt;app);</span><br><span class="line">        mount = <span class="built_in">srs_string_replace</span>(mount, <span class="string">&quot;[stream]&quot;</span>, r-&gt;stream);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// remove the default vhost mount</span></span><br><span class="line">        <span class="comment">//替换mount 类似 /livestream/live.flv格式</span></span><br><span class="line">        mount = <span class="built_in">srs_string_replace</span>(mount, SRS_CONSTS_RTMP_DEFAULT_VHOST<span class="string">&quot;/&quot;</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        entry = <span class="keyword">new</span> <span class="built_in">SrsLiveEntry</span>(mount);</span><br><span class="line"></span><br><span class="line">        entry-&gt;source = s;</span><br><span class="line">        entry-&gt;req = r-&gt;<span class="built_in">copy</span>()-&gt;<span class="built_in">as_http</span>();</span><br><span class="line">        entry-&gt;cache = <span class="keyword">new</span> <span class="built_in">SrsBufferCache</span>(s, r);</span><br><span class="line">        <span class="comment">//创建SrsLiveStream，每个SrsSource绑定一个</span></span><br><span class="line">        entry-&gt;stream = <span class="keyword">new</span> <span class="built_in">SrsLiveStream</span>(s, r, entry-&gt;cache);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> maybe refine the logic of http remux service.</span></span><br><span class="line">        <span class="comment">// if user push streams followed:</span></span><br><span class="line">        <span class="comment">//     rtmp://test.com/live/stream1</span></span><br><span class="line">        <span class="comment">//     rtmp://test.com/live/stream2</span></span><br><span class="line">        <span class="comment">// and they will using the same template, such as: [vhost]/[app]/[stream].flv</span></span><br><span class="line">        <span class="comment">// so, need to free last request object, otherwise, it will cause memory leak.</span></span><br><span class="line">        <span class="built_in">srs_freep</span>(tmpl-&gt;req);</span><br><span class="line">        </span><br><span class="line">        tmpl-&gt;source = s;</span><br><span class="line">        tmpl-&gt;req = r-&gt;<span class="built_in">copy</span>()-&gt;<span class="built_in">as_http</span>();</span><br><span class="line">        </span><br><span class="line">        sflvs[sid] = entry;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// mount the http flv stream.</span></span><br><span class="line">        <span class="comment">// we must register the handler, then start the thread,</span></span><br><span class="line">        <span class="comment">// for the thread will cause thread switch context.</span></span><br><span class="line">        <span class="comment">// @see https://github.com/ossrs/srs/issues/404</span></span><br><span class="line">        <span class="comment">//创建路由规则SrsHttpServeMux，mount：要匹配的路由</span></span><br><span class="line">        <span class="keyword">if</span> ((err = mux.<span class="built_in">handle</span>(mount, entry-&gt;stream)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;http: mount flv stream for vhost=%s failed&quot;</span>, sid.<span class="built_in">c_str</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// start http stream cache thread</span></span><br><span class="line">        <span class="keyword">if</span> ((err = entry-&gt;cache-&gt;<span class="built_in">start</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;http: start stream cache failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">srs_trace</span>(<span class="string">&quot;http: mount flv stream for sid=%s, mount=%s&quot;</span>, sid.<span class="built_in">c_str</span>(), mount.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        entry = sflvs[sid];</span><br><span class="line">        entry-&gt;stream-&gt;<span class="built_in">update</span>(s, r);</span><br><span class="line">        entry-&gt;cache-&gt;<span class="built_in">update</span>(s, r);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (entry-&gt;stream) &#123;</span><br><span class="line">        entry-&gt;stream-&gt;entry-&gt;enabled = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHttpServeMux::handle</code>是真正创建路由规则的函数。</li>
<li>参数<code>pattern</code>作为URL索引，参数<code>handler</code>是<code>SrsLiveStream</code>提供给拉流客户端访问。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpServeMux::handle</span><span class="params">(std::string pattern, ISrsHttpHandler* handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">srs_assert</span>(handler);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (pattern.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_HTTP_PATTERN_EMPTY, <span class="string">&quot;empty pattern&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (entries.<span class="built_in">find</span>(pattern) != entries.<span class="built_in">end</span>()) &#123;</span><br><span class="line">        SrsHttpMuxEntry* exists = entries[pattern];</span><br><span class="line">        <span class="keyword">if</span> (exists-&gt;explicit_match) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_HTTP_PATTERN_DUPLICATED, <span class="string">&quot;pattern=%s exists&quot;</span>, pattern.<span class="built_in">c_str</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    std::string vhost = pattern;</span><br><span class="line">    <span class="keyword">if</span> (pattern.<span class="built_in">at</span>(<span class="number">0</span>) != <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pattern.<span class="built_in">find</span>(<span class="string">&quot;/&quot;</span>) != string::npos) &#123;</span><br><span class="line">            vhost = pattern.<span class="built_in">substr</span>(<span class="number">0</span>, pattern.<span class="built_in">find</span>(<span class="string">&quot;/&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        vhosts[vhost] = handler;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">//创建路由</span></span><br><span class="line">        SrsHttpMuxEntry* entry = <span class="keyword">new</span> <span class="built_in">SrsHttpMuxEntry</span>();</span><br><span class="line">        entry-&gt;explicit_match = <span class="literal">true</span>;</span><br><span class="line">        entry-&gt;handler = handler;</span><br><span class="line">        entry-&gt;pattern = pattern;</span><br><span class="line">        entry-&gt;handler-&gt;entry = entry;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (entries.<span class="built_in">find</span>(pattern) != entries.<span class="built_in">end</span>()) &#123;</span><br><span class="line">            SrsHttpMuxEntry* exists = entries[pattern];</span><br><span class="line">            <span class="built_in">srs_freep</span>(exists);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//设置 patter:URL</span></span><br><span class="line">        entries[pattern] = entry;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Helpful behavior:</span></span><br><span class="line">    <span class="comment">// If pattern is /tree/, insert an implicit permanent redirect for /tree.</span></span><br><span class="line">    <span class="comment">// It can be overridden by an explicit registration.</span></span><br><span class="line">    <span class="keyword">if</span> (pattern != <span class="string">&quot;/&quot;</span> &amp;&amp; !pattern.<span class="built_in">empty</span>() &amp;&amp; pattern.<span class="built_in">at</span>(pattern.<span class="built_in">length</span>() - <span class="number">1</span>) == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">        std::string rpattern = pattern.<span class="built_in">substr</span>(<span class="number">0</span>, pattern.<span class="built_in">length</span>() - <span class="number">1</span>);</span><br><span class="line">        SrsHttpMuxEntry* entry = <span class="literal">NULL</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// free the exists implicit entry</span></span><br><span class="line">        <span class="keyword">if</span> (entries.<span class="built_in">find</span>(rpattern) != entries.<span class="built_in">end</span>()) &#123;</span><br><span class="line">            entry = entries[rpattern];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// create implicit redirect.</span></span><br><span class="line">        <span class="keyword">if</span> (!entry || !entry-&gt;explicit_match) &#123;</span><br><span class="line">            <span class="built_in">srs_freep</span>(entry);</span><br><span class="line">            </span><br><span class="line">            entry = <span class="keyword">new</span> <span class="built_in">SrsHttpMuxEntry</span>();</span><br><span class="line">            entry-&gt;explicit_match = <span class="literal">false</span>;</span><br><span class="line">            entry-&gt;handler = <span class="keyword">new</span> <span class="built_in">SrsHttpRedirectHandler</span>(pattern, SRS_CONSTS_HTTP_Found);</span><br><span class="line">            entry-&gt;pattern = pattern;</span><br><span class="line">            entry-&gt;handler-&gt;entry = entry;</span><br><span class="line">            </span><br><span class="line">            entries[rpattern] = entry;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> srs_success;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="拉流端"><a href="#拉流端" class="headerlink" title="拉流端"></a>拉流端</h3><p>拉流端根据URL查找对应的<code>ISrsHttpHandler</code>。</p>
<ul>
<li>断点<code>SrsHttpResponseWriter::write</code>，<code>SrsHttpResponseWriter</code>负责将数据发送给客户端。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#0 SrsHttpResponseWriter::write (this=0x7ffff7eb5bd0, data=0x7ffff7eb5470 &quot;FLV\001\005&quot;, size=9)</span><br><span class="line">   at src/service/srs_service_http_conn.cpp:727</span><br><span class="line">#1 0x00000000004fde19 in SrsBufferWriter::write (this=0x7ffff7eb5860, buf=0x7ffff7eb5470,</span><br><span class="line">   count=9, pnwrite=0x0) at src/app/srs_app_http_stream.cpp:506</span><br><span class="line">#2 0x000000000040e9e1 in SrsFlvTransmuxer::write_header (this=0xa71b10,</span><br><span class="line">   flv_header=0x7ffff7eb5470 &quot;FLV\001\005&quot;) at src/kernel/srs_kernel_flv.cpp:411</span><br><span class="line">#3 0x000000000040e90d in SrsFlvTransmuxer::write_header (this=0xa71b10, has_video=true, has_audio=true)</span><br><span class="line">   at src/kernel/srs_kernel_flv.cpp:399</span><br><span class="line">#4 0x00000000004fd11a in SrsFlvStreamEncoder::write_header (this=0xa68b10, has_video=true, has_audio=true)</span><br><span class="line">   at src/app/srs_app_http_stream.cpp:355</span><br><span class="line">#5 0x00000000004fd04f in SrsFlvStreamEncoder::write_tags (this=0xa68b10, msgs=0xa6da30, count=10)</span><br><span class="line">   at src/app/srs_app_http_stream.cpp:340</span><br><span class="line">#6 0x00000000004ff0dc in SrsLiveStream::do_serve_http (this=0xa3d9d0, w=0x7ffff7eb5bd0, r=0xa91c00)</span><br><span class="line">   at src/app/srs_app_http_stream.cpp:677</span><br><span class="line">#7 0x00000000004fe108 in SrsLiveStream::serve_http (this=0xa3d9d0, w=0x7ffff7eb5bd0, r=0xa91c00)</span><br><span class="line">   at src/app/srs_app_http_stream.cpp:544</span><br><span class="line">#8 0x000000000049c86f in SrsHttpServeMux::serve_http (this=0xa11fe0, w=0x7ffff7eb5bd0, r=0xa91c00)</span><br><span class="line">   at src/protocol/srs_http_stack.cpp:711</span><br><span class="line">#9 0x0000000000562080 in SrsHttpServer::serve_http (this=0xa11e00, w=0x7ffff7eb5bd0, r=0xa91c00)</span><br><span class="line">   at src/app/srs_app_http_conn.cpp:300 </span><br><span class="line">#10 0x000000000049d6be in SrsHttpCorsMux::serve_http (this=0xa3aa60, w=0x7ffff7eb5bd0, r=0xa91c00)</span><br><span class="line">    at src/protocol/srs_http_stack.cpp:859</span><br><span class="line">#11 0x0000000000561086 in SrsHttpConn::process_request (this=0xa626e0, w=0x7ffff7eb5bd0, r=0xa91c00)</span><br><span class="line">    at src/app/srs_app_http_conn.cpp:161</span><br><span class="line">#12 0x0000000000560ce8 in SrsHttpConn::do_cycle (this=0xa626e0) at src/app/srs_app_http_conn.cpp:133</span><br><span class="line">#13 0x00000000004d10fb in SrsConnection::cycle (this=0xa626e0) at src/app/srs_app_conn.cpp:171</span><br><span class="line">#14 0x0000000000509c88 in SrsSTCoroutine::cycle (this=0xa62a70) at src/app/srs_app_st.cpp:198</span><br><span class="line">#15 0x0000000000509cfd in SrsSTCoroutine::pfn (arg=0xa62a70) at src/app/srs_app_st.cpp:213</span><br><span class="line">#16 0x00000000005bdd9d in _st_thread_main () at sched.c:337</span><br><span class="line">#17 0x00000000005be515 in st_thread_create (start=0x5bd719 &lt;_st_vp_schedule+170&gt;,</span><br><span class="line">    arg=0x900000001, joinable=1, stk_size=1) at sched.c:616</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHttpConn::do_cycle</code>中初始化<code>cors-&gt;initialize</code>。</li>
<li><code>http_mux</code>是<code>SrsHttpServer</code> ，之后处理HTTP请求<code>process_request</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpConn::do_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// initialize parser</span></span><br><span class="line">    <span class="keyword">if</span> ((err = parser-&gt;<span class="built_in">initialize</span>(HTTP_REQUEST, <span class="literal">false</span>)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;init parser for %s&quot;</span>, ip.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// set the recv timeout, for some clients never disconnect the connection.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/398</span></span><br><span class="line">    skt-&gt;<span class="built_in">set_recv_timeout</span>(SRS_HTTP_RECV_TIMEOUT);</span><br><span class="line">    </span><br><span class="line">    SrsRequest* last_req = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsRequest, last_req);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// initialize the cors, which will proxy to mux.</span></span><br><span class="line">    <span class="type">bool</span> crossdomain_enabled = _srs_config-&gt;<span class="built_in">get_http_stream_crossdomain</span>();</span><br><span class="line">    <span class="keyword">if</span> ((err = cors-&gt;<span class="built_in">initialize</span>(http_mux, crossdomain_enabled)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;init cors&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// process http messages.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> req_id = <span class="number">0</span>; (err = trd-&gt;<span class="built_in">pull</span>()) == srs_success; req_id++) &#123;</span><br><span class="line">        <span class="comment">// Try to receive a message from http.</span></span><br><span class="line">        <span class="built_in">srs_trace</span>(<span class="string">&quot;HTTP client ip=%s, request=%d, to=%dms&quot;</span>, </span><br><span class="line">                  ip.<span class="built_in">c_str</span>(), req_id, <span class="built_in">srsu2ms</span>(SRS_HTTP_RECV_TIMEOUT));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// get a http message</span></span><br><span class="line">        ISrsHttpMessage* req = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = parser-&gt;<span class="built_in">parse_message</span>(skt, &amp;req)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// if SUCCESS, always NOT-NULL.</span></span><br><span class="line">        <span class="comment">// always free it in this scope.</span></span><br><span class="line">        <span class="built_in">srs_assert</span>(req);</span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(ISrsHttpMessage, req);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Attach owner connection to message.</span></span><br><span class="line">        SrsHttpMessage* hreq = (SrsHttpMessage*)req;</span><br><span class="line">        hreq-&gt;<span class="built_in">set_connection</span>(<span class="keyword">this</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// copy request to last request object.</span></span><br><span class="line">        <span class="built_in">srs_freep</span>(last_req);</span><br><span class="line">        last_req = hreq-&gt;<span class="built_in">to_request</span>(hreq-&gt;<span class="built_in">host</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// may should discard the body.</span></span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">on_got_http_message</span>(req)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ok, handle http request.</span></span><br><span class="line">        <span class="comment">//给客户端推数据SrsHttpResponseWriter</span></span><br><span class="line">        <span class="function">SrsHttpResponseWriter <span class="title">writer</span><span class="params">(skt)</span></span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">process_request</span>(&amp;writer, req)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// donot keep alive, disconnect it.</span></span><br><span class="line">        <span class="comment">// @see https://github.com/ossrs/srs/issues/399</span></span><br><span class="line">        <span class="keyword">if</span> (!req-&gt;<span class="built_in">is_keep_alive</span>()) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">srs_error_t</span> r0 = srs_success;</span><br><span class="line">    <span class="keyword">if</span> ((r0 = <span class="built_in">on_disconnect</span>(last_req)) != srs_success) &#123;</span><br><span class="line">        err = <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;on disconnect %s&quot;</span>, <span class="built_in">srs_error_desc</span>(r0).<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="built_in">srs_freep</span>(r0);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHttpConn::process_request</code>调用<code>SrsHttpCorsMux::serve_http</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpCorsMux::serve_http</span><span class="params">(ISrsHttpResponseWriter* w, ISrsHttpMessage* r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// If CORS enabled, and there is a &quot;Origin&quot; header, it&#x27;s CORS.</span></span><br><span class="line">    <span class="keyword">if</span> (enabled) &#123;</span><br><span class="line">        SrsHttpHeader* h = r-&gt;<span class="built_in">header</span>();</span><br><span class="line">        required = !h-&gt;<span class="built_in">get</span>(<span class="string">&quot;Origin&quot;</span>).<span class="built_in">empty</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// When CORS required, set the CORS headers.</span></span><br><span class="line">    <span class="keyword">if</span> (required) &#123;</span><br><span class="line">        SrsHttpHeader* h = w-&gt;<span class="built_in">header</span>();</span><br><span class="line">        h-&gt;<span class="built_in">set</span>(<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>, <span class="string">&quot;*&quot;</span>);</span><br><span class="line">        h-&gt;<span class="built_in">set</span>(<span class="string">&quot;Access-Control-Allow-Methods&quot;</span>, <span class="string">&quot;GET, POST, HEAD, PUT, DELETE, OPTIONS&quot;</span>);</span><br><span class="line">        h-&gt;<span class="built_in">set</span>(<span class="string">&quot;Access-Control-Expose-Headers&quot;</span>, <span class="string">&quot;Server,range,Content-Length,Content-Range&quot;</span>);</span><br><span class="line">        h-&gt;<span class="built_in">set</span>(<span class="string">&quot;Access-Control-Allow-Headers&quot;</span>, <span class="string">&quot;origin,range,accept-encoding,referer,Cache-Control,X-Proxy-Authorization,X-Requested-With,Content-Type&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// handle the http options.</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;<span class="built_in">is_http_options</span>()) &#123;</span><br><span class="line">        w-&gt;<span class="built_in">header</span>()-&gt;<span class="built_in">set_content_length</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (enabled) &#123;</span><br><span class="line">            w-&gt;<span class="built_in">write_header</span>(SRS_CONSTS_HTTP_OK);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            w-&gt;<span class="built_in">write_header</span>(SRS_CONSTS_HTTP_MethodNotAllowed);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> w-&gt;<span class="built_in">final_request</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_assert</span>(next);</span><br><span class="line">    <span class="keyword">return</span> next-&gt;<span class="built_in">serve_http</span>(w, r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>推流的时候通过<code>mux.handle</code>创建路由规则。</li>
<li>拉流的时候通过<code>http_stream-&gt;mux.find_handler</code>查找路由。</li>
<li>创建的时候根据<code>http_remux</code>配置，例如&#x2F;live&#x2F;test.flv，拉流查找的时候找到对应的才能播放。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpServer::serve_http</span><span class="params">(ISrsHttpResponseWriter* w, ISrsHttpMessage* r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// try http stream first.</span></span><br><span class="line">    ISrsHttpHandler* h = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//查找路由</span></span><br><span class="line">    <span class="keyword">if</span> ((err = http_stream-&gt;mux.<span class="built_in">find_handler</span>(r, &amp;h)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;find handler&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!h-&gt;<span class="built_in">is_not_found</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> http_stream-&gt;mux.<span class="built_in">serve_http</span>(w, r);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> http_static-&gt;mux.<span class="built_in">serve_http</span>(w, r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>匹配<code>entry-&gt;pattern</code>后缀，获取音视频数据<code>source-&gt;create_consumer</code>。</li>
<li>如果是FLV格式<code>ffe-&gt;write_tags</code>写数据，具体里面包含<code>write_header</code>和<code>write_tags</code>，具体参考FLV格式。</li>
<li>最终通过<code>SrsHttpResponseWriter::writev</code>响应客户端。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsLiveStream::do_serve_http</span><span class="params">(ISrsHttpResponseWriter* w, ISrsHttpMessage* r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    string enc_desc;</span><br><span class="line">    ISrsBufferEncoder* enc = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_assert</span>(entry);</span><br><span class="line">    <span class="comment">//匹配后缀</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">srs_string_ends_with</span>(entry-&gt;pattern, <span class="string">&quot;.flv&quot;</span>)) &#123;</span><br><span class="line">        w-&gt;<span class="built_in">header</span>()-&gt;<span class="built_in">set_content_type</span>(<span class="string">&quot;video/x-flv&quot;</span>);</span><br><span class="line">        enc_desc = <span class="string">&quot;FLV&quot;</span>;</span><br><span class="line">        <span class="comment">//FLV Encoder</span></span><br><span class="line">        enc = <span class="keyword">new</span> <span class="built_in">SrsFlvStreamEncoder</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">srs_string_ends_with</span>(entry-&gt;pattern, <span class="string">&quot;.aac&quot;</span>)) &#123;</span><br><span class="line">        w-&gt;<span class="built_in">header</span>()-&gt;<span class="built_in">set_content_type</span>(<span class="string">&quot;audio/x-aac&quot;</span>);</span><br><span class="line">        enc_desc = <span class="string">&quot;AAC&quot;</span>;</span><br><span class="line">        enc = <span class="keyword">new</span> <span class="built_in">SrsAacStreamEncoder</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">srs_string_ends_with</span>(entry-&gt;pattern, <span class="string">&quot;.mp3&quot;</span>)) &#123;</span><br><span class="line">        w-&gt;<span class="built_in">header</span>()-&gt;<span class="built_in">set_content_type</span>(<span class="string">&quot;audio/mpeg&quot;</span>);</span><br><span class="line">        enc_desc = <span class="string">&quot;MP3&quot;</span>;</span><br><span class="line">        enc = <span class="keyword">new</span> <span class="built_in">SrsMp3StreamEncoder</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">srs_string_ends_with</span>(entry-&gt;pattern, <span class="string">&quot;.ts&quot;</span>)) &#123;</span><br><span class="line">        w-&gt;<span class="built_in">header</span>()-&gt;<span class="built_in">set_content_type</span>(<span class="string">&quot;video/MP2T&quot;</span>);</span><br><span class="line">        enc_desc = <span class="string">&quot;TS&quot;</span>;</span><br><span class="line">        enc = <span class="keyword">new</span> <span class="built_in">SrsTsStreamEncoder</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_HTTP_LIVE_STREAM_EXT, <span class="string">&quot;invalid pattern=%s&quot;</span>, entry-&gt;pattern.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(ISrsBufferEncoder, enc);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Enter chunked mode, because we didn&#x27;t set the content-length.</span></span><br><span class="line">    w-&gt;<span class="built_in">write_header</span>(SRS_CONSTS_HTTP_OK);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// create consumer of souce, ignore gop cache, use the audio gop cache.</span></span><br><span class="line">    SrsConsumer* consumer = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">create_consumer</span>(<span class="literal">NULL</span>, consumer, <span class="literal">true</span>, <span class="literal">true</span>, !enc-&gt;<span class="built_in">has_cache</span>())) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;create consumer&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsConsumer, consumer);</span><br><span class="line">    <span class="built_in">srs_verbose</span>(<span class="string">&quot;http: consumer created success.&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    SrsPithyPrint* pprint = SrsPithyPrint::<span class="built_in">create_http_stream</span>();</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsPithyPrint, pprint);</span><br><span class="line">    </span><br><span class="line">    <span class="function">SrsMessageArray <span class="title">msgs</span><span class="params">(SRS_PERF_MW_MSGS)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use receive thread to accept the close event to avoid FD leak.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/636#issuecomment-298208427</span></span><br><span class="line">    SrsHttpMessage* hr = <span class="built_in">dynamic_cast</span>&lt;SrsHttpMessage*&gt;(r);</span><br><span class="line">    SrsResponseOnlyHttpConn* hc = <span class="built_in">dynamic_cast</span>&lt;SrsResponseOnlyHttpConn*&gt;(hr-&gt;<span class="built_in">connection</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// update the statistic when source disconveried.</span></span><br><span class="line">    SrsStatistic* stat = SrsStatistic::<span class="built_in">instance</span>();</span><br><span class="line">    <span class="keyword">if</span> ((err = stat-&gt;<span class="built_in">on_client</span>(_srs_context-&gt;<span class="built_in">get_id</span>(), req, hc, SrsRtmpConnPlay)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;stat on client&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// the memory writer.</span></span><br><span class="line">    <span class="function">SrsBufferWriter <span class="title">writer</span><span class="params">(w)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> ((err = enc-&gt;<span class="built_in">initialize</span>(&amp;writer, cache)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;init encoder&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if gop cache enabled for encoder, dump to consumer.</span></span><br><span class="line">    <span class="keyword">if</span> (enc-&gt;<span class="built_in">has_cache</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = enc-&gt;<span class="built_in">dump_cache</span>(consumer, source-&gt;<span class="built_in">jitter</span>())) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;encoder dump cache&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    SrsFlvStreamEncoder* ffe = <span class="built_in">dynamic_cast</span>&lt;SrsFlvStreamEncoder*&gt;(enc);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Set the socket options for transport.</span></span><br><span class="line">    <span class="type">bool</span> tcp_nodelay = _srs_config-&gt;<span class="built_in">get_tcp_nodelay</span>(req-&gt;vhost);</span><br><span class="line">    <span class="keyword">if</span> (tcp_nodelay) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = hc-&gt;<span class="built_in">set_tcp_nodelay</span>(tcp_nodelay)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;set tcp nodelay&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">srs_utime_t</span> mw_sleep = _srs_config-&gt;<span class="built_in">get_mw_sleep</span>(req-&gt;vhost);</span><br><span class="line">    <span class="keyword">if</span> ((err = hc-&gt;<span class="built_in">set_socket_buffer</span>(mw_sleep)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;set mw_sleep %&quot;</span> PRId64, mw_sleep);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//读取客户端数据，直接丢弃了</span></span><br><span class="line">    SrsHttpRecvThread* trd = <span class="keyword">new</span> <span class="built_in">SrsHttpRecvThread</span>(hc);</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsHttpRecvThread, trd);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">start</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;start recv thread&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;FLV %s, encoder=%s, nodelay=%d, mw_sleep=%dms, cache=%d, msgs=%d&quot;</span>,</span><br><span class="line">        entry-&gt;pattern.<span class="built_in">c_str</span>(), enc_desc.<span class="built_in">c_str</span>(), tcp_nodelay, <span class="built_in">srsu2msi</span>(mw_sleep),</span><br><span class="line">        enc-&gt;<span class="built_in">has_cache</span>(), msgs.max);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> free and erase the disabled entry after all related connections is closed.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> FXIME: Support timeout for player, quit infinite-loop.</span></span><br><span class="line">    <span class="keyword">while</span> (entry-&gt;enabled) &#123;</span><br><span class="line">        <span class="comment">// Whether client closed the FD.</span></span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pprint-&gt;<span class="built_in">elapse</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// get messages from consumer.</span></span><br><span class="line">        <span class="comment">// each msg in msgs.msgs must be free, for the SrsMessageArray never free them.</span></span><br><span class="line">        <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = consumer-&gt;<span class="built_in">dump_packets</span>(&amp;msgs, count)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;consumer dump packets&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Directly use sleep, donot use consumer wait, because we couldn&#x27;t awake consumer.</span></span><br><span class="line">            <span class="built_in">srs_usleep</span>(mw_sleep);</span><br><span class="line">            <span class="comment">// ignore when nothing got.</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (pprint-&gt;<span class="built_in">can_print</span>()) &#123;</span><br><span class="line">            <span class="built_in">srs_trace</span>(<span class="string">&quot;-&gt; &quot;</span> SRS_CONSTS_LOG_HTTP_STREAM <span class="string">&quot; http: got %d msgs, age=%d, min=%d, mw=%d&quot;</span>,</span><br><span class="line">                count, pprint-&gt;<span class="built_in">age</span>(), SRS_PERF_MW_MIN_MSGS, <span class="built_in">srsu2msi</span>(mw_sleep));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// sendout all messages.</span></span><br><span class="line">        <span class="keyword">if</span> (ffe) &#123;</span><br><span class="line">            err = ffe-&gt;<span class="built_in">write_tags</span>(msgs.msgs, count);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            err = <span class="built_in">streaming_send_messages</span>(enc, msgs.msgs, count);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// free the messages.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            SrsSharedPtrMessage* msg = msgs.msgs[i];</span><br><span class="line">            <span class="built_in">srs_freep</span>(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// check send error code.</span></span><br><span class="line">        <span class="keyword">if</span> (err != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send messages&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Here, the entry is disabled by encoder un-publishing or reloading,</span></span><br><span class="line">    <span class="comment">// so we must return a io.EOF error to disconnect the client, or the client will never quit.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_HTTP_STREAM_EOF, <span class="string">&quot;Stream EOF&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHttpRecvThread</code>协程读取客户端数据<code>conn-&gt;pop_message</code>直接丢弃。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpRecvThread::cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> ((err = trd-&gt;<span class="built_in">pull</span>()) == srs_success) &#123;</span><br><span class="line">        ISrsHttpMessage* req = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(ISrsHttpMessage, req);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = conn-&gt;<span class="built_in">pop_message</span>(&amp;req)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;pop message&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsFlvStreamEncoder::write_tags</code>对FLV格式封装。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsFlvStreamEncoder::write_tags</span><span class="params">(SrsSharedPtrMessage** msgs, <span class="type">int</span> count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// For https://github.com/ossrs/srs/issues/939</span></span><br><span class="line">    <span class="keyword">if</span> (!header_written) &#123;</span><br><span class="line">        <span class="type">bool</span> has_video = <span class="literal">false</span>;</span><br><span class="line">        <span class="type">bool</span> has_audio = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count &amp;&amp; (!has_video || !has_audio); i++) &#123;</span><br><span class="line">            SrsSharedPtrMessage* msg = msgs[i];</span><br><span class="line">            <span class="keyword">if</span> (msg-&gt;<span class="built_in">is_video</span>()) &#123;</span><br><span class="line">                has_video = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (msg-&gt;<span class="built_in">is_audio</span>()) &#123;</span><br><span class="line">                has_audio = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Drop data if no A+V.</span></span><br><span class="line">        <span class="keyword">if</span> (!has_video &amp;&amp; !has_audio) &#123;</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">write_header</span>(has_video, has_audio))  != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;write header&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> enc-&gt;<span class="built_in">write_tags</span>(msgs, count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/09/30/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BRTMP/" rel="prev" title="SRS流媒体服务器之RTMP">
                  <i class="fa fa-angle-left"></i> SRS流媒体服务器之RTMP
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/10/03/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BHLS/" rel="next" title="SRS流媒体服务器之HLS">
                  SRS流媒体服务器之HLS <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Fang</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"neutral","dark":"neutral"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.3.0/mermaid.min.js","integrity":"sha256-9y71g5Lz/KLsHjB8uXwnkuWDtAMDSzD/HdIbqhJfTAI="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
