<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CPT+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"fang0407.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="HLS介绍HLS简介RTMP指Adobe的RTMP（Realtime Message Protocol），⼴泛应⽤于低延时直播，也是编码器和服务器对接的实际标准协议，在PC（Flash）上有最佳观看体验和最佳稳定性。HLS指Apple的HLS（Http Live Streaming），本身就是Live（直播）的，不过Vod（点播）也能⽀持。HLS是Apple平台的标准流媒体协议，和RTMP在PC上">
<meta property="og:type" content="article">
<meta property="og:title" content="SRS流媒体服务器之HLS">
<meta property="og:url" content="https://fang0407.github.io/2023/10/03/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BHLS/index.html">
<meta property="og:site_name" content="NOTE">
<meta property="og:description" content="HLS介绍HLS简介RTMP指Adobe的RTMP（Realtime Message Protocol），⼴泛应⽤于低延时直播，也是编码器和服务器对接的实际标准协议，在PC（Flash）上有最佳观看体验和最佳稳定性。HLS指Apple的HLS（Http Live Streaming），本身就是Live（直播）的，不过Vod（点播）也能⽀持。HLS是Apple平台的标准流媒体协议，和RTMP在PC上">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-10-03T05:13:50.000Z">
<meta property="article:modified_time" content="2023-12-30T14:37:29.361Z">
<meta property="article:author" content="Fang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://fang0407.github.io/2023/10/03/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BHLS/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://fang0407.github.io/2023/10/03/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BHLS/","path":"2023/10/03/SRS流媒体服务器之HLS/","title":"SRS流媒体服务器之HLS"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>SRS流媒体服务器之HLS | NOTE</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">NOTE</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#HLS%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.</span> <span class="nav-text">HLS介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#HLS%E7%AE%80%E4%BB%8B"><span class="nav-number">1.1.</span> <span class="nav-text">HLS简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HLS%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">1.2.</span> <span class="nav-text">HLS应用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A8%E8%8D%90%E5%88%86%E5%8F%91%E2%BD%85%E5%BC%8F"><span class="nav-number">1.3.</span> <span class="nav-text">推荐分发⽅式</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#HLS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">2.</span> <span class="nav-text">HLS源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E2%BD%82%E4%BB%B6"><span class="nav-number">2.1.</span> <span class="nav-text">配置⽂件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90"><span class="nav-number">2.2.</span> <span class="nav-text">调试分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E7%B1%BB"><span class="nav-number">2.2.1.</span> <span class="nav-text">核心类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A8%E6%B5%81%E7%AB%AF"><span class="nav-number">2.2.2.</span> <span class="nav-text">推流端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8B%89%E6%B5%81%E7%AB%AF"><span class="nav-number">2.2.3.</span> <span class="nav-text">拉流端</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Fang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">73</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/10/03/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BHLS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="SRS流媒体服务器之HLS | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SRS流媒体服务器之HLS
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-10-03 13:13:50" itemprop="dateCreated datePublished" datetime="2023-10-03T13:13:50+08:00">2023-10-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-12-30 22:37:29" itemprop="dateModified" datetime="2023-12-30T22:37:29+08:00">2023-12-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SRS/" itemprop="url" rel="index"><span itemprop="name">SRS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="HLS介绍"><a href="#HLS介绍" class="headerlink" title="HLS介绍"></a>HLS介绍</h1><h2 id="HLS简介"><a href="#HLS简介" class="headerlink" title="HLS简介"></a>HLS简介</h2><p>RTMP指Adobe的RTMP（Realtime Message Protocol），⼴泛应⽤于低延时直播，也是编码器和服务器对接的实际标准协议，在PC（Flash）上有最佳观看体验和最佳稳定性。HLS指Apple的HLS（Http Live Streaming），本身就是Live（直播）的，不过Vod（点播）也能⽀持。HLS是Apple平台的标准流媒体协议，和RTMP在PC上⼀样⽀持得天⾐⽆缝。HLS和RTMP两种分发⽅式，就可以⽀持所有的终端。 </p>
<h2 id="HLS应用场景"><a href="#HLS应用场景" class="headerlink" title="HLS应用场景"></a>HLS应用场景</h2><ul>
<li>跨平台：PC主要的直播⽅案是RTMP，也有⼀些库能播放HLS，譬如jwplayer，基于osmf的hls插件也⼀⼤堆。所以实际上如果选⼀种协议能跨PC&#x2F;Android&#x2F;IOS，那就是HLS。 </li>
<li>IOS上苛刻的稳定性要求：IOS上最稳定的当然是HLS，稳定性不差于RTMP在PC-flash上的表现。 </li>
<li>友好的CDN分发⽅式：⽬前CDN对于RTMP也是基本协议，但是HLS分发的基础是HTTP，所以CDN的接⼊和分发会⽐RTMP更加完善。能在各种CDN之间切换，RTMP也能，只是可能需要对接测试。 </li>
<li>简单：HLS作为流媒体协议⾮常简单，Apple⽀持得也很完善。Android对HLS的⽀持也会越来越完善。⾄于DASH&#x2F;HDS，好像没有什么特别的理由，就像linux已经⼤⾏其道⽽且开放，其他的系统很难再⼴泛应⽤。</li>
</ul>
<p>总之，SRS⽀持HLS主要是作为输出的分发协议，直播以RTMP+HLS分发，满⾜各种应⽤场景。点播以HLS为主。 </p>
<h2 id="推荐分发⽅式"><a href="#推荐分发⽅式" class="headerlink" title="推荐分发⽅式"></a>推荐分发⽅式</h2><ul>
<li>编码器输出RTMP协议。 </li>
<li>流媒体系统接⼊使⽤RTMP协议。 </li>
<li>流媒体系统内部直播分发使⽤RTMP。 </li>
<li>PC+直播+实时性要求⾼：使⽤flash播放RTMP。 </li>
<li>PC+直播+没有实时性要求：使⽤RTMP或者HLS均可。 </li>
<li>PC+点播：使⽤HTTP或者HLS。 </li>
<li>Apple IOS&#x2F;OSX：都使⽤HLS（实时性要求⾼得⾃⼰解析RTMP，或者使⽤外部库。</li>
<li>Andorid：和IOS⼀样，不过可以确定的是可以⾃⼰开发⽀持RTMP。</li>
</ul>
<h1 id="HLS源码分析"><a href="#HLS源码分析" class="headerlink" title="HLS源码分析"></a>HLS源码分析</h1><h2 id="配置⽂件"><a href="#配置⽂件" class="headerlink" title="配置⽂件"></a>配置⽂件</h2><p>修改<code>conf/hls.conf</code>文件，<code>./objs/srs -c conf/hls.conf</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">listen              1935;</span><br><span class="line">max_connections     1000;</span><br><span class="line">daemon              off;</span><br><span class="line">srs_log_tank        console;</span><br><span class="line">http_server &#123;</span><br><span class="line">    enabled         on;</span><br><span class="line">    listen          8080;</span><br><span class="line">    dir             ./objs/nginx/html;</span><br><span class="line">&#125;</span><br><span class="line">vhost __defaultVhost__ &#123;</span><br><span class="line">    hls &#123;</span><br><span class="line">        enabled         on;</span><br><span class="line">        hls_path        ./objs/nginx/html;  # ts,m3u8保存路径</span><br><span class="line">        hls_fragment    10;   # 分片时长</span><br><span class="line">        hls_window      60;   # 总分片时长，窗⼝时⻓</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="调试分析"><a href="#调试分析" class="headerlink" title="调试分析"></a>调试分析</h2><h3 id="核心类"><a href="#核心类" class="headerlink" title="核心类"></a>核心类</h3><ul>
<li><code>SrsHls</code>：对于HLS业务的封装。</li>
<li><code>SrsHlsController</code>：The hls stream cache。</li>
<li><code>SrsHlsMuxer</code>：负责⽣产m3u8和ts⽂件。</li>
<li><code>SrsHlsSegment</code>：负责分⽚，⽂件创建、删除等。</li>
<li><code>SrsFragment</code>：对⽂件的处理，是SrsHlsSegment 的基类。</li>
<li><code>SrsFragmentWindow</code>：管理segment。</li>
</ul>
<h3 id="推流端"><a href="#推流端" class="headerlink" title="推流端"></a>推流端</h3><p>主要通过RTMP推流，将接收音视频数据写入m3u8和ts文件。</p>
<ul>
<li>看到配置文件<code>hls_fragment</code>字段，找到<code>SrsConfig::get_hls_fragmen</code>，打断点，查看堆栈：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#0 SrsConfig::get_hls_fragment (this=0xa0fcf0, vhost=&quot;__defaultVhost__&quot;) at src/app/srs_app_config.cpp:6102</span><br><span class="line">#1 0x00000000004f3ee9 in SrsHlsController::on_publish (this=0xa3b560, req=0xa3bcb0) </span><br><span class="line">   at src/app/srs_app_hls.cpp:885 </span><br><span class="line">#2 0x00000000004f5be2 in SrsHls::on_publish (this=0xa3b030) at src/app/srs_app_hls.cpp:1181</span><br><span class="line">#3 0x00000000004e0603 in SrsOriginHub::on_publish (this=0xa3b670) at src/app/srs_app_source.cpp:1129</span><br><span class="line">#4 0x00000000004e6a0b in SrsSource::on_publish (this=0xa3b1e0) at src/app/srs_app_source.cpp:2460</span><br><span class="line">#5 0x00000000004d89f2 in SrsRtmpConn::acquire_publish (this=0xa30d60, source=0xa3b1e0) </span><br><span class="line">   at src/app/srs_app_rtmp_conn.cpp:940</span><br><span class="line">#6 0x00000000004d7a74 in SrsRtmpConn::publishing (this=0xa30d60, source=0xa3b1e0)</span><br><span class="line">   at src/app/srs_app_rtmp_conn.cpp:822</span><br><span class="line">#7 0x00000000004d5229 in SrsRtmpConn::stream_service_cycle (this=0xa30d60)</span><br><span class="line">   at src/app/srs_app_rtmp_conn.cpp:534</span><br><span class="line">#8 0x00000000004d4141 in SrsRtmpConn::service_cycle (this=0xa30d60) at src/app/srs_app_rtmp_conn.cpp:388</span><br><span class="line">#9 0x00000000004d2f09 in SrsRtmpConn::do_cycle (this=0xa30d60) at src/app/srs_app_rtmp_conn.cpp:209</span><br><span class="line">#10 0x00000000004d10fb in SrsConnection::cycle (this=0xa30dd8) at src/app/srs_app_conn.cpp:171</span><br><span class="line">#11 0x0000000000509c88 in SrsSTCoroutine::cycle (this=0xa31010) at src/app/srs_app_st.cpp:198</span><br><span class="line">#12 0x0000000000509cfd in SrsSTCoroutine::pfn (arg=0xa31010) at src/app/srs_app_st.cpp:213</span><br><span class="line">#13 0x00000000005bdd9d in _st_thread_main () at sched.c:337</span><br><span class="line">#14 0x00000000005be515 in st_thread_create (start=0x5bd719 &lt;_st_vp_schedule+170&gt;,</span><br><span class="line">    arg=0x700000001, joinable=1, stk_size=1) at sched.c616</span><br></pre></td></tr></table></figure>

<ul>
<li>看到堆栈前面和RTMP推流流程一致。</li>
<li><code>SrsRtmpConn::acquire_publish</code>后<code>info-&gt;edge</code>分支用于edge边缘结点推流，该流程处理在另一个分支<code>source-&gt;on_publish</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::acquire_publish</span><span class="params">(SrsSource* source)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!source-&gt;<span class="built_in">can_publish</span>(info-&gt;edge)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_SYSTEM_STREAM_BUSY,</span><br><span class="line">                             <span class="string">&quot;rtmp: stream %s is busy&quot;</span>,</span><br><span class="line">                             req-&gt;<span class="built_in">get_stream_url</span>().<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// when edge, ignore the publish event, directly proxy it.</span></span><br><span class="line">    <span class="keyword">if</span> (info-&gt;edge) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">on_edge_start_publish</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: edge start publish&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">on_publish</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: source publish&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>进入<code>SrsSource::on_publish</code>后调用<code>hub-&gt;on_publish</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsSource::on_publish</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// update the request object.</span></span><br><span class="line">    <span class="built_in">srs_assert</span>(req);</span><br><span class="line">    </span><br><span class="line">    _can_publish = <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// whatever, the publish thread is the source or edge source,</span></span><br><span class="line">    <span class="comment">// save its id to srouce id.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">on_source_id_changed</span>(_srs_context-&gt;<span class="built_in">get_id</span>())) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;source id change&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// reset the mix queue.</span></span><br><span class="line">    mix_queue-&gt;<span class="built_in">clear</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reset the metadata cache, to make VLC happy when disable/enable stream.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/1630#issuecomment-597979448</span></span><br><span class="line">    meta-&gt;<span class="built_in">clear</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// detect the monotonically again.</span></span><br><span class="line">    is_monotonically_increase = <span class="literal">true</span>;</span><br><span class="line">    last_packet_time = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Notify the hub about the publish event.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = hub-&gt;<span class="built_in">on_publish</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hub publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// notify the handler.</span></span><br><span class="line">    <span class="built_in">srs_assert</span>(handler);</span><br><span class="line">    <span class="keyword">if</span> ((err = handler-&gt;<span class="built_in">on_publish</span>(<span class="keyword">this</span>, req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;handle publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    SrsStatistic* stat = SrsStatistic::<span class="built_in">instance</span>();</span><br><span class="line">    stat-&gt;<span class="built_in">on_stream_publish</span>(req, _source_id);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsOriginHub</code>扩展源推流不同业务，比如转码，录制，转发等，主要关注<code>hls-&gt;on_publish</code>用于HLS。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsOriginHub::on_publish</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// create forwarders</span></span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">create_forwarders</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;create forwarders&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> use initialize to set req.</span></span><br><span class="line">    <span class="comment">//转码</span></span><br><span class="line">    <span class="keyword">if</span> ((err = encoder-&gt;<span class="built_in">on_publish</span>(req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;encoder publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = hls-&gt;<span class="built_in">on_publish</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = dash-&gt;<span class="built_in">on_publish</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;dash publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//录制</span></span><br><span class="line">    <span class="keyword">if</span> ((err = dvr-&gt;<span class="built_in">on_publish</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;dvr publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> use initialize to set req.</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_AUTO_HDS</span></span><br><span class="line">    <span class="keyword">if</span> ((err = hds-&gt;<span class="built_in">on_publish</span>(req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hds publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> use initialize to set req.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = ng_exec-&gt;<span class="built_in">on_publish</span>(req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;exec publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    is_active = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHls::on_publish</code>主要调用<code>controller-&gt;on_publish</code>做处理。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHls::on_publish</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// update the hls time, for hls_dispose.</span></span><br><span class="line">    last_update_time = <span class="built_in">srs_get_system_time</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// support multiple publish.</span></span><br><span class="line">    <span class="keyword">if</span> (enabled) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!_srs_config-&gt;<span class="built_in">get_hls_enabled</span>(req-&gt;vhost)) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = controller-&gt;<span class="built_in">on_publish</span>(req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: on publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If enabled, directly turn FLV timestamp to TS DTS.</span></span><br><span class="line">    <span class="comment">// @remark It&#x27;ll be reloaded automatically, because the origin hub will republish while reloading.</span></span><br><span class="line">    hls_dts_directly = _srs_config-&gt;<span class="built_in">get_vhost_hls_dts_directly</span>(req-&gt;vhost);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if enabled, open the muxer.</span></span><br><span class="line">    enabled = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ok, the hls can be dispose, or need to be dispose.</span></span><br><span class="line">    disposable = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHlsController::on_publish</code>读取配置文件信息，之后<code>SrsHlsMuxer</code>处理HLS相关业务封装。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHlsController::on_publish</span><span class="params">(SrsRequest* req)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    std::string vhost = req-&gt;vhost;</span><br><span class="line">    std::string stream = req-&gt;stream;</span><br><span class="line">    std::string app = req-&gt;app;</span><br><span class="line">    </span><br><span class="line">    <span class="type">srs_utime_t</span> hls_fragment = _srs_config-&gt;<span class="built_in">get_hls_fragment</span>(vhost);</span><br><span class="line">    <span class="type">srs_utime_t</span> hls_window = _srs_config-&gt;<span class="built_in">get_hls_window</span>(vhost);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// get the hls m3u8 ts list entry prefix config</span></span><br><span class="line">    std::string entry_prefix = _srs_config-&gt;<span class="built_in">get_hls_entry_prefix</span>(vhost);</span><br><span class="line">    <span class="comment">// get the hls path config</span></span><br><span class="line">    std::string path = _srs_config-&gt;<span class="built_in">get_hls_path</span>(vhost);</span><br><span class="line">    std::string m3u8_file = _srs_config-&gt;<span class="built_in">get_hls_m3u8_file</span>(vhost);</span><br><span class="line">    std::string ts_file = _srs_config-&gt;<span class="built_in">get_hls_ts_file</span>(vhost);</span><br><span class="line">    <span class="type">bool</span> cleanup = _srs_config-&gt;<span class="built_in">get_hls_cleanup</span>(vhost);</span><br><span class="line">    <span class="type">bool</span> wait_keyframe = _srs_config-&gt;<span class="built_in">get_hls_wait_keyframe</span>(vhost);</span><br><span class="line">    <span class="comment">// the audio overflow, for pure audio to reap segment.</span></span><br><span class="line">    <span class="type">double</span> hls_aof_ratio = _srs_config-&gt;<span class="built_in">get_hls_aof_ratio</span>(vhost);</span><br><span class="line">    <span class="comment">// whether use floor(timestamp/hls_fragment) for variable timestamp</span></span><br><span class="line">    <span class="type">bool</span> ts_floor = _srs_config-&gt;<span class="built_in">get_hls_ts_floor</span>(vhost);</span><br><span class="line">    <span class="comment">// the seconds to dispose the hls.</span></span><br><span class="line">    <span class="type">srs_utime_t</span> hls_dispose = _srs_config-&gt;<span class="built_in">get_hls_dispose</span>(vhost);</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> hls_keys = _srs_config-&gt;<span class="built_in">get_hls_keys</span>(vhost);</span><br><span class="line">    <span class="type">int</span> hls_fragments_per_key = _srs_config-&gt;<span class="built_in">get_hls_fragments_per_key</span>(vhost);</span><br><span class="line">    string hls_key_file =  _srs_config-&gt;<span class="built_in">get_hls_key_file</span>(vhost);</span><br><span class="line">    string hls_key_file_path = _srs_config-&gt;<span class="built_in">get_hls_key_file_path</span>(vhost);</span><br><span class="line">    string hls_key_url = _srs_config-&gt;<span class="built_in">get_hls_key_url</span>(vhost);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> support load exists m3u8, to continue publish stream.</span></span><br><span class="line">    <span class="comment">// for the HLS donot requires the EXT-X-MEDIA-SEQUENCE be monotonically increase.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((err = muxer-&gt;<span class="built_in">on_publish</span>(req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;muxer publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = muxer-&gt;<span class="built_in">update_config</span>(req, entry_prefix, path, m3u8_file, ts_file, hls_fragment,</span><br><span class="line">        hls_window, ts_floor, hls_aof_ratio, cleanup, wait_keyframe,hls_keys,hls_fragments_per_key,</span><br><span class="line">        hls_key_file, hls_key_file_path, hls_key_url)) != srs_success ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: update config&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = muxer-&gt;<span class="built_in">segment_open</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: segment open&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This config item is used in SrsHls, we just log its value here.</span></span><br><span class="line">    <span class="type">bool</span> hls_dts_directly = _srs_config-&gt;<span class="built_in">get_vhost_hls_dts_directly</span>(req-&gt;vhost);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;hls: win=%dms, frag=%dms, prefix=%s, path=%s, m3u8=%s, ts=%s, aof=%.2f, floor=%d, clean=%d, waitk=%d, dispose=%dms, dts_directly=%d&quot;</span>,</span><br><span class="line">        <span class="built_in">srsu2msi</span>(hls_window), <span class="built_in">srsu2msi</span>(hls_fragment), entry_prefix.<span class="built_in">c_str</span>(), path.<span class="built_in">c_str</span>(), m3u8_file.<span class="built_in">c_str</span>(), ts_file.<span class="built_in">c_str</span>(),</span><br><span class="line">        hls_aof_ratio, ts_floor, cleanup, wait_keyframe, <span class="built_in">srsu2msi</span>(hls_dispose), hls_dts_directly);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>配置<code>SrsHlsMuxer</code>信息，创建<code>SrsFileWriter</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHlsMuxer::update_config</span><span class="params">(SrsRequest* r, string entry_prefix,</span></span></span><br><span class="line"><span class="params"><span class="function">    string path, string m3u8_file, string ts_file, <span class="type">srs_utime_t</span> fragment, <span class="type">srs_utime_t</span> window,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">bool</span> ts_floor, <span class="type">double</span> aof_ratio, <span class="type">bool</span> cleanup, <span class="type">bool</span> wait_keyframe, <span class="type">bool</span> keys,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">int</span> fragments_per_key, string key_file ,string key_file_path, string key_url)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_freep</span>(req);</span><br><span class="line">    req = r-&gt;<span class="built_in">copy</span>();</span><br><span class="line">    </span><br><span class="line">    hls_entry_prefix = entry_prefix;</span><br><span class="line">    hls_path = path;</span><br><span class="line">    hls_ts_file = ts_file;</span><br><span class="line">    hls_fragment = fragment;</span><br><span class="line">    hls_aof_ratio = aof_ratio;</span><br><span class="line">    hls_ts_floor = ts_floor;</span><br><span class="line">    hls_cleanup = cleanup;</span><br><span class="line">    hls_wait_keyframe = wait_keyframe;</span><br><span class="line">    previous_floor_ts = <span class="number">0</span>;</span><br><span class="line">    accept_floor_ts = <span class="number">0</span>;</span><br><span class="line">    hls_window = window;</span><br><span class="line">    deviation_ts = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    hls_keys = keys;</span><br><span class="line">    hls_fragments_per_key = fragments_per_key;</span><br><span class="line">    hls_key_file = key_file;</span><br><span class="line">    hls_key_file_path = key_file_path;</span><br><span class="line">    hls_key_url = key_url;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// generate the m3u8 dir and path.</span></span><br><span class="line">    m3u8_url = <span class="built_in">srs_path_build_stream</span>(m3u8_file, req-&gt;vhost, req-&gt;app, req-&gt;stream);</span><br><span class="line">    m3u8 = path + <span class="string">&quot;/&quot;</span> + m3u8_url;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// when update config, reset the history target duration.</span></span><br><span class="line">    max_td = fragment * _srs_config-&gt;<span class="built_in">get_hls_td_ratio</span>(r-&gt;vhost);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// create m3u8 dir once.</span></span><br><span class="line">    m3u8_dir = <span class="built_in">srs_path_dirname</span>(m3u8);</span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">srs_create_dir_recursively</span>(m3u8_dir)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;create dir&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hls_keys &amp;&amp; (hls_path != hls_key_file_path)) &#123;</span><br><span class="line">        string key_file = <span class="built_in">srs_path_build_stream</span>(hls_key_file, req-&gt;vhost, req-&gt;app, req-&gt;stream);</span><br><span class="line">        string key_url = hls_key_file_path + <span class="string">&quot;/&quot;</span> + key_file;</span><br><span class="line">        string key_dir = <span class="built_in">srs_path_dirname</span>(key_url);</span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">srs_create_dir_recursively</span>(key_dir)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;create dir&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(hls_keys) &#123;</span><br><span class="line">        writer = <span class="keyword">new</span> <span class="built_in">SrsEncFileWriter</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        writer = <span class="keyword">new</span> <span class="built_in">SrsFileWriter</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHlsMuxer::segment_open</code>打开TS分片，并写入。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHlsMuxer::segment_open</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//省略...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// open temp ts file.</span></span><br><span class="line">    std::string tmp_file = current-&gt;<span class="built_in">tmppath</span>();</span><br><span class="line">    <span class="keyword">if</span> ((err = current-&gt;writer-&gt;<span class="built_in">open</span>(tmp_file)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;open hls muxer&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// reset the context for a new ts start.</span></span><br><span class="line">    context-&gt;<span class="built_in">reset</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>断点<code>SrsHlsMuxer::do_segment_close</code>。</li>
<li><code>SrsHlsMuxer::segment_open</code>，对应<code>SrsHlsMuxer::segment_close</code>用于结束⼀个segment的写⼊。</li>
<li><code>_refresh_m3u8</code>用于更新m3u8文件。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#0 SrsHlsMuxer::do_segment_close (this=0xa3b6f0) at src/app/srs_app_hls.cpp:602</span><br><span class="line">#1 0x00000000004f1b19 in SrsHlsMuxer::segment_close (this=0xa3b6f0) at src/app/srs_app_hls.cpp:593</span><br><span class="line">#2 0x00000000004f52c4 in SrsHlsController::reap_segment (this=0xa3b560) at src/app/srs_app_hls.cpp:1046</span><br><span class="line">#3 0x00000000004f51d2 in SrsHlsController::write_video (this=0xa3b560, frame=0xa3fdb0, dts=1328400)</span><br><span class="line">   at src/app/srs_app_hls.cpp:1024</span><br><span class="line">#4 0x00000000004f63c3 in SrsHls::on_video (this=0xa3b030, shared_video=0x7ffff7ee8b00, format=0xa3bad0)</span><br><span class="line">   at src/app/srs_app_hls.cpp:1340</span><br><span class="line">#5 0x00000000004dfbef in SrsOriginHub::on_video (</span><br><span class="line">   this=0xa3b670, shared_video=0x7ffff7ee8b00, is_sequence_header=false) at src/app/srs_app_source.cpp:1062</span><br><span class="line">#6 0x00000000004e5fa5 in SrsSource::on_video_imp (this=0xa3b1e0, msg=0x7ffff7ee8b00) </span><br><span class="line">   at src/app/srs_app_source.cpp:2306</span><br><span class="line">#7 0x00000000004e5bf9 in SrsSource::on_video (this=0xa3b1e0, shared_video=0xa3dfa0)</span><br><span class="line">   at src/app/srs_app_source.cpp:2261</span><br><span class="line">#8 0x00000000004d8fa7 in SrsRtmpConn::process_publish_message (this=0xa30d60,</span><br><span class="line">   source=0xa3b1e0, msg=0xa3dfa0)</span><br><span class="line">   at src/app/srs_app_rtmp_conn.cpp:1021</span><br><span class="line">#9 0x00000000004d8dce in SrsRtmpConn::handle_publish_message (this=0xa30d60,</span><br><span class="line">   source=0xa3b1e0, msg=0xa3dfa0) </span><br><span class="line">   at src/app/srs_app_rtmp_conn.cpp:993</span><br><span class="line">#10 0x00000000005810b6 in SrsPublishRecvThread::consume (this=0x7ffff7f42800, msg=0xa3dfa0)</span><br><span class="line">    at src/app/srs_app_recv_thread.cpp:389</span><br><span class="line">#11 0x00000000004d2f09 in SrsRtmpConn::do_cycle (this=0x7ffff7f42808) at src/app/srs_app_rtmp_conn.cpp:146</span><br><span class="line">#12 0x000000000057fa25 in SrsRecvThread::cycle (this=0x7ffff7f42808) at src/app/srs_app_recv_thread.cpp:115 #13 0x0000000000509c88 in SrsSTCoroutine::cycle (this=0xa3de00) at src/app/srs_app_st.cpp:198</span><br></pre></td></tr></table></figure>

<ul>
<li>写入TS的视频数据。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHlsController::write_video</span><span class="params">(SrsVideoFrame* frame, <span class="type">int64_t</span> dts)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// write video to cache.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = tsmc-&gt;<span class="built_in">cache_video</span>(frame, dts)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: cache video&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// when segment overflow, reap if possible.</span></span><br><span class="line">    <span class="comment">//文件是不是够fragment</span></span><br><span class="line">    <span class="keyword">if</span> (muxer-&gt;<span class="built_in">is_segment_overflow</span>()) &#123;</span><br><span class="line">        <span class="comment">// do reap ts if any of:</span></span><br><span class="line">        <span class="comment">//      a. wait keyframe and got keyframe.</span></span><br><span class="line">        <span class="comment">//      b. always reap when not wait keyframe.</span></span><br><span class="line">        <span class="keyword">if</span> (!muxer-&gt;<span class="built_in">wait_keyframe</span>() || frame-&gt;frame_type == SrsVideoAvcFrameTypeKeyFrame) &#123;</span><br><span class="line">            <span class="comment">// reap the segment, which will also flush the video.</span></span><br><span class="line">            <span class="keyword">if</span> ((err = <span class="built_in">reap_segment</span>()) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: reap segment&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// flush video when got one</span></span><br><span class="line">    <span class="keyword">if</span> ((err = muxer-&gt;<span class="built_in">flush_video</span>(tsmc)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: flush video&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHlsController::reap_segment</code>主要管理对ts、m3u8文件。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHlsController::reap_segment</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> flush audio before or after segment?</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> fresh segment begin with audio or video?</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// close current ts.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = muxer-&gt;<span class="built_in">segment_close</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="comment">// When close segment error, we must reopen it for next packet to write.</span></span><br><span class="line">        <span class="type">srs_error_t</span> r0 = muxer-&gt;<span class="built_in">segment_open</span>();</span><br><span class="line">        <span class="keyword">if</span> (r0 != srs_success) &#123;</span><br><span class="line">            <span class="built_in">srs_warn</span>(<span class="string">&quot;close segment err %s&quot;</span>, <span class="built_in">srs_error_desc</span>(r0).<span class="built_in">c_str</span>());</span><br><span class="line">            <span class="built_in">srs_freep</span>(r0);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: segment close&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// open new ts.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = muxer-&gt;<span class="built_in">segment_open</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: segment open&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// segment open, flush video first.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = muxer-&gt;<span class="built_in">flush_video</span>(tsmc)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: flush video&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// segment open, flush the audio.</span></span><br><span class="line">    <span class="comment">// @see: ngx_rtmp_hls_open_fragment</span></span><br><span class="line">    <span class="comment">/* start fragment with audio to make iPhone happy */</span></span><br><span class="line">    <span class="keyword">if</span> ((err = muxer-&gt;<span class="built_in">flush_audio</span>(tsmc)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: flush audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>上述主要在<code>SrsHls::on_publish</code>处理推流初始化相关。</li>
<li>具体从哪里读音视频数据中，断点<code>SrsTsContextWriter::write_audio</code>如何写入音频数据。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#0 SrsTsContextWriter::write_audio (this=0xa3c770, audio=0xa45bf0) at src/kernel/srs_kernel_ts.cpp:2582</span><br><span class="line">#1 0x00000000004f1858 in SrsHlsMuxer::flush_audio (this=0xa3b6f0, cache=0xa3b580)</span><br><span class="line">   at src/app/srs_app_hls.cpp:552</span><br><span class="line">#2 0x00000000004f5089 in SrsHlsController::write_audio (this=0xa3b560, frame=0xa41640, pts=3060)</span><br><span class="line">   at src/app/srs_app_hls.cpp:1001</span><br><span class="line">#3 0x00000000004f613c in SrsHls::on_audio (this=0xa3b030, shared_audio=0x7ffff7ee8b10, format=0xa3bad0)</span><br><span class="line">   at src/app/srs_app_hls.cpp:1290</span><br><span class="line">#4 0x00000000004deeaf in SrsOriginHub::on_audio (this=0xa3b670, shared_audio=0x7ffff7ee8b10)</span><br><span class="line">   at src/app/srs_app_source.cpp:969</span><br><span class="line">#5 0x00000000004e579a in SrsSource::on_audio_imp (this=0xa3b1e0, msg=0x7ffff7ee8b10)</span><br><span class="line">   at src/app/srs_app_source.cpp:2191</span><br><span class="line">#6 0x00000000004e539d in SrsSource::on_audio (this=0xa3b1e0, shared_audio=0xa3dfa0)</span><br><span class="line">   at src/app/srs_app_source.cpp:2141</span><br><span class="line">#7 0x00000000004d8f28 in SrsRtmpConn::process_publish_message (this=0xa30d60, source=0xa3b1e0, msg=0xa3dfa0)    at src/app/srs_app_rtmp_conn.cpp:1014</span><br><span class="line">#8 0x00000000004d8dce in SrsRtmpConn::handle_publish_message (this=0xa30d60, source=0xa3b1e0, msg=0xa3dfa0)      at src/app/srs_app_rtmp_conn.cpp:993</span><br><span class="line">#9 0x00000000005810b6 in SrsPublishRecvThread::consume (this=0x7ffff7f42800, msg=0xa3dfa0)</span><br><span class="line">   at src/app/srs_app_recv_thread.cpp:389</span><br><span class="line">#10 0x000000000057fbd4 in SrsRecvThread::do_cycle (this=0x7ffff7f42808)</span><br><span class="line">    at src/app/srs_app_recv_thread.cpp:146</span><br><span class="line">#11 0x000000000057fa25 in SrsRecvThread::cycle (this=0x7ffff7f42808) at src/app/srs_app_recv_thread.cpp:115</span><br><span class="line">#12 0x0000000000509c88 in SrsSTCoroutine::cycle (this=0xa3de00) at src/app/srs_app_st.cpp:198</span><br><span class="line">#13 0x0000000000509cfd in SrsSTCoroutine::pfn (arg=0xa3de00) at src/app/srs_app_st.cpp:213</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsSource::on_audio_imp</code>的<code>SrsSharedPtrMessage</code>消息是RTMP格式消息。</li>
<li><code>consumer-&gt;enqueue</code>推送给消费者，<code>hub-&gt;on_audio</code>是具体<code>SrsOriginHub</code>做处理。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsSource::on_audio_imp</span><span class="params">(SrsSharedPtrMessage* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="type">bool</span> is_aac_sequence_header = SrsFlvAudio::<span class="built_in">sh</span>(msg-&gt;payload, msg-&gt;size);</span><br><span class="line">    <span class="type">bool</span> is_sequence_header = is_aac_sequence_header;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// whether consumer should drop for the duplicated sequence header.</span></span><br><span class="line">    <span class="type">bool</span> drop_for_reduce = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (is_sequence_header &amp;&amp; meta-&gt;<span class="built_in">previous_ash</span>() &amp;&amp; _srs_config-&gt;<span class="built_in">get_reduce_sequence_header</span>(req-&gt;vhost)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (meta-&gt;<span class="built_in">previous_ash</span>()-&gt;size == msg-&gt;size) &#123;</span><br><span class="line">            drop_for_reduce = <span class="built_in">srs_bytes_equals</span>(meta-&gt;<span class="built_in">previous_ash</span>()-&gt;payload, msg-&gt;payload, msg-&gt;size);</span><br><span class="line">            <span class="built_in">srs_warn</span>(<span class="string">&quot;drop for reduce sh audio, size=%d&quot;</span>, msg-&gt;size);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// copy to all consumer</span></span><br><span class="line">    <span class="keyword">if</span> (!drop_for_reduce) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; (<span class="type">int</span>)consumers.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            SrsConsumer* consumer = consumers.<span class="built_in">at</span>(i);</span><br><span class="line">            <span class="keyword">if</span> ((err = consumer-&gt;<span class="built_in">enqueue</span>(msg, atc, jitter_algorithm)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;consume message&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Copy to hub to all utilities.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = hub-&gt;<span class="built_in">on_audio</span>(msg)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;consume audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cache the sequence header of aac, or first packet of mp3.</span></span><br><span class="line">    <span class="comment">// for example, the mp3 is used for hls to write the &quot;right&quot; audio codec.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> to refine the stream info system.</span></span><br><span class="line">    <span class="keyword">if</span> (is_aac_sequence_header || !meta-&gt;<span class="built_in">ash</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = meta-&gt;<span class="built_in">update_ash</span>(msg)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;meta consume audio&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// when sequence header, donot push to gop cache and adjust the timestamp.</span></span><br><span class="line">    <span class="keyword">if</span> (is_sequence_header) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cache the last gop packets</span></span><br><span class="line">    <span class="keyword">if</span> ((err = gop_cache-&gt;<span class="built_in">cache</span>(msg)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;gop cache consume audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if atc, update the sequence header to abs time.</span></span><br><span class="line">    <span class="keyword">if</span> (atc) &#123;</span><br><span class="line">        <span class="keyword">if</span> (meta-&gt;<span class="built_in">ash</span>()) &#123;</span><br><span class="line">            meta-&gt;<span class="built_in">ash</span>()-&gt;timestamp = msg-&gt;timestamp;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (meta-&gt;<span class="built_in">data</span>()) &#123;</span><br><span class="line">            meta-&gt;<span class="built_in">data</span>()-&gt;timestamp = msg-&gt;timestamp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsOriginHub::on_audio</code>中处理不同格式的音频数，首先会将<code>SrsSharedPtrMessage</code>RTMP消息格式转<code>SrsFormat</code>消息格式。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsOriginHub::on_audio</span><span class="params">(SrsSharedPtrMessage* shared_audio)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;    </span><br><span class="line">    SrsSharedPtrMessage* msg = shared_audio;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = format-&gt;<span class="built_in">on_audio</span>(msg)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;format consume audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cache the sequence header if aac</span></span><br><span class="line">    <span class="comment">// donot cache the sequence header to gop_cache, return here.</span></span><br><span class="line">    <span class="keyword">if</span> (format-&gt;<span class="built_in">is_aac_sequence_header</span>()) &#123;</span><br><span class="line">        <span class="built_in">srs_assert</span>(format-&gt;acodec);</span><br><span class="line">        SrsAudioCodecConfig* c = format-&gt;acodec;</span><br><span class="line">        </span><br><span class="line">        <span class="type">static</span> <span class="type">int</span> flv_sample_sizes[] = &#123;<span class="number">8</span>, <span class="number">16</span>, <span class="number">0</span>&#125;;</span><br><span class="line">        <span class="type">static</span> <span class="type">int</span> flv_sound_types[] = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>&#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// when got audio stream info.</span></span><br><span class="line">        SrsStatistic* stat = SrsStatistic::<span class="built_in">instance</span>();</span><br><span class="line">        <span class="keyword">if</span> ((err = stat-&gt;<span class="built_in">on_audio_info</span>(req, SrsAudioCodecIdAAC, c-&gt;sound_rate, c-&gt;sound_type, c-&gt;aac_object)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;stat audio&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">srs_trace</span>(<span class="string">&quot;%dB audio sh, codec(%d, profile=%s, %dchannels, %dkbps, %dHZ), flv(%dbits, %dchannels, %dHZ)&quot;</span>,</span><br><span class="line">                  msg-&gt;size, c-&gt;id, <span class="built_in">srs_aac_object2str</span>(c-&gt;aac_object).<span class="built_in">c_str</span>(), c-&gt;aac_channels,</span><br><span class="line">                  c-&gt;audio_data_rate / <span class="number">1000</span>, srs_aac_srates[c-&gt;aac_sample_rate],</span><br><span class="line">                  flv_sample_sizes[c-&gt;sound_size], flv_sound_types[c-&gt;sound_type],</span><br><span class="line">                  srs_flv_srates[c-&gt;sound_rate]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = hls-&gt;<span class="built_in">on_audio</span>(msg, format)) != srs_success) &#123;</span><br><span class="line">        <span class="comment">// apply the error strategy for hls.</span></span><br><span class="line">        <span class="comment">// @see https://github.com/ossrs/srs/issues/264</span></span><br><span class="line">        std::string hls_error_strategy = _srs_config-&gt;<span class="built_in">get_hls_on_error</span>(req-&gt;vhost);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">srs_config_hls_is_on_error_ignore</span>(hls_error_strategy)) &#123;</span><br><span class="line">            <span class="built_in">srs_warn</span>(<span class="string">&quot;hls: ignore audio error %s&quot;</span>, <span class="built_in">srs_error_desc</span>(err).<span class="built_in">c_str</span>());</span><br><span class="line">            hls-&gt;<span class="built_in">on_unpublish</span>();</span><br><span class="line">            <span class="built_in">srs_error_reset</span>(err);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">srs_config_hls_is_on_error_continue</span>(hls_error_strategy)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">srs_hls_can_continue</span>(<span class="built_in">srs_error_code</span>(err), source-&gt;meta-&gt;<span class="built_in">ash</span>(), msg)) &#123;</span><br><span class="line">                <span class="built_in">srs_error_reset</span>(err);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: audio&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: audio&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHls::on_audio</code>调用<code>controller-&gt;write_audio</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHls::on_audio</span><span class="params">(SrsSharedPtrMessage* shared_audio, SrsFormat* format)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!enabled) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Ignore if no format-&gt;acodec, it means the codec is not parsed, or unknown codec.</span></span><br><span class="line">    <span class="comment">// @issue https://github.com/ossrs/srs/issues/1506#issuecomment-562079474</span></span><br><span class="line">    <span class="keyword">if</span> (!format-&gt;acodec) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// update the hls time, for hls_dispose.</span></span><br><span class="line">    last_update_time = <span class="built_in">srs_get_system_time</span>();</span><br><span class="line">    </span><br><span class="line">    SrsSharedPtrMessage* audio = shared_audio-&gt;<span class="built_in">copy</span>();</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsSharedPtrMessage, audio);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ts support audio codec: aac/mp3</span></span><br><span class="line">    SrsAudioCodecId acodec = format-&gt;acodec-&gt;id;</span><br><span class="line">    <span class="keyword">if</span> (acodec != SrsAudioCodecIdAAC &amp;&amp; acodec != SrsAudioCodecIdMP3) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ignore sequence header</span></span><br><span class="line">    <span class="built_in">srs_assert</span>(format-&gt;audio);</span><br><span class="line">    <span class="keyword">if</span> (acodec == SrsAudioCodecIdAAC &amp;&amp;</span><br><span class="line">        format-&gt;audio-&gt;aac_packet_type == SrsAudioAacFrameTraitSequenceHeader) &#123;</span><br><span class="line">        <span class="keyword">return</span> controller-&gt;<span class="built_in">on_sequence_header</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> config the jitter of HLS.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = jitter-&gt;<span class="built_in">correct</span>(audio, SrsRtmpJitterAlgorithmOFF)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: jitter&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Reset the aac samples counter when DTS jitter.</span></span><br><span class="line">    <span class="keyword">if</span> (previous_audio_dts &gt; audio-&gt;timestamp) &#123;</span><br><span class="line">        previous_audio_dts = audio-&gt;timestamp;</span><br><span class="line">        aac_samples = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The diff duration in ms between two FLV audio packets.</span></span><br><span class="line">    <span class="type">int</span> diff = ::<span class="built_in">abs</span>((<span class="type">int</span>)(audio-&gt;timestamp - previous_audio_dts));</span><br><span class="line">    previous_audio_dts = audio-&gt;timestamp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Guess the number of samples for each AAC frame.</span></span><br><span class="line">    <span class="comment">// If samples is 1024, the sample-rate is 8000HZ, the diff should be 1024/8000s=128ms.</span></span><br><span class="line">    <span class="comment">// If samples is 1024, the sample-rate is 44100HZ, the diff should be 1024/44100s=23ms.</span></span><br><span class="line">    <span class="comment">// If samples is 2048, the sample-rate is 44100HZ, the diff should be 2048/44100s=46ms.</span></span><br><span class="line">    <span class="type">int</span> nb_samples_per_frame = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> guessNumberOfSamples = diff * srs_flv_srates[format-&gt;acodec-&gt;sound_rate] / <span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">if</span> (guessNumberOfSamples &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (guessNumberOfSamples &lt; <span class="number">960</span>) &#123;</span><br><span class="line">            nb_samples_per_frame = <span class="number">960</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (guessNumberOfSamples &lt; <span class="number">1536</span>) &#123;</span><br><span class="line">            nb_samples_per_frame = <span class="number">1024</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (guessNumberOfSamples &lt; <span class="number">3072</span>) &#123;</span><br><span class="line">            nb_samples_per_frame = <span class="number">2048</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            nb_samples_per_frame = <span class="number">4096</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Recalc the DTS by the samples of AAC.</span></span><br><span class="line">    aac_samples += nb_samples_per_frame;</span><br><span class="line">    <span class="type">int64_t</span> dts = <span class="number">90000</span> * aac_samples / srs_flv_srates[format-&gt;acodec-&gt;sound_rate];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If directly turn FLV timestamp, overwrite the guessed DTS.</span></span><br><span class="line">    <span class="comment">// @doc https://github.com/ossrs/srs/issues/1506#issuecomment-562063095</span></span><br><span class="line">    <span class="keyword">if</span> (hls_dts_directly) &#123;</span><br><span class="line">        dts = audio-&gt;timestamp * <span class="number">90</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = controller-&gt;<span class="built_in">write_audio</span>(format-&gt;audio, dts)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: write audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHlsController::write_audio</code>缓存音频数据等，<code>muxer-&gt;flush_audio</code>写入音频数据。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHlsController::write_audio</span><span class="params">(SrsAudioFrame* frame, <span class="type">int64_t</span> pts)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// write audio to cache.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = tsmc-&gt;<span class="built_in">cache_audio</span>(frame, pts)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: cache audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// reap when current source is pure audio.</span></span><br><span class="line">    <span class="comment">// it maybe changed when stream info changed,</span></span><br><span class="line">    <span class="comment">// for example, pure audio when start, audio/video when publishing,</span></span><br><span class="line">    <span class="comment">// pure audio again for audio disabled.</span></span><br><span class="line">    <span class="comment">// so we reap event when the audio incoming when segment overflow.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/151</span></span><br><span class="line">    <span class="comment">// we use absolutely overflow of segment to make jwplayer/ffplay happy</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/151#issuecomment-71155184</span></span><br><span class="line">    <span class="keyword">if</span> (tsmc-&gt;audio &amp;&amp; muxer-&gt;<span class="built_in">is_segment_absolutely_overflow</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">reap_segment</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: reap segment&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// for pure audio, aggregate some frame to one.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> Check whether it&#x27;s necessary.</span></span><br><span class="line">    <span class="keyword">if</span> (muxer-&gt;<span class="built_in">pure_audio</span>() &amp;&amp; tsmc-&gt;audio) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pts - tsmc-&gt;audio-&gt;start_pts &lt; SRS_CONSTS_HLS_PURE_AUDIO_AGGREGATE) &#123;</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// directly write the audio frame by frame to ts,</span></span><br><span class="line">    <span class="comment">// it&#x27;s ok for the hls overload, or maybe cause the audio corrupt,</span></span><br><span class="line">    <span class="comment">// which introduced by aggregate the audios to a big one.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/512</span></span><br><span class="line">    <span class="keyword">if</span> ((err = muxer-&gt;<span class="built_in">flush_audio</span>(tsmc)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: flush audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用<code>current-&gt;tscw-&gt;write_audio</code>写入缓存音频数据。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHlsMuxer::flush_audio</span><span class="params">(SrsTsMessageCache* cache)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if current is NULL, segment is not open, ignore the flush event.</span></span><br><span class="line">    <span class="keyword">if</span> (!current) &#123;</span><br><span class="line">        <span class="built_in">srs_warn</span>(<span class="string">&quot;flush audio ignored, for segment is not open.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!cache-&gt;audio || cache-&gt;audio-&gt;payload-&gt;<span class="built_in">length</span>() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// update the duration of segment.</span></span><br><span class="line">    current-&gt;<span class="built_in">append</span>(cache-&gt;audio-&gt;pts / <span class="number">90</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = current-&gt;tscw-&gt;<span class="built_in">write_audio</span>(cache-&gt;audio)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: write audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// write success, clear and free the msg</span></span><br><span class="line">    <span class="built_in">srs_freep</span>(cache-&gt;audio);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用<code>context-&gt;encode</code>做TS格式封装。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsTsContextWriter::write_audio</span><span class="params">(SrsTsMessage* audio)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_info</span>(<span class="string">&quot;hls: write audio pts=%&quot;</span> PRId64 <span class="string">&quot;, dts=%&quot;</span> PRId64 <span class="string">&quot;, size=%d&quot;</span>,</span><br><span class="line">        audio-&gt;pts, audio-&gt;dts, audio-&gt;PES_packet_length);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = context-&gt;<span class="built_in">encode</span>(writer, audio, vcodec, acodec)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;ts: write audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">srs_info</span>(<span class="string">&quot;hls encode audio ok&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="拉流端"><a href="#拉流端" class="headerlink" title="拉流端"></a>拉流端</h3><p>主要是响应拉流客户端HTTP携带的m3u8和ts文件。</p>
<ul>
<li>断点<code>SrsFileReader::SrsFileReader</code>，拉流端会构造<code>SrsFileReader</code>类读取HLS协议相关文件响应客户端。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#0 SrsFileReader::SrsFileReader (this=0xa7ac50, __in_chrg=&lt;optimized out&gt;, __vtt_parm= &lt;optimized out&gt;) </span><br><span class="line">   at src/kernel/srs_kernel_file.cpp:195</span><br><span class="line">#1 0x0000000000459258 in ISrsFileReaderFactory::create_file_reader (this=0xa122f0)</span><br><span class="line">   at src/kernel/srs_kernel_file.cpp:192</span><br><span class="line">#2 0x0000000000499842 in SrsHttpFileServer::serve_file (this=0xa12310, w=0x7ffff7f0cbd0, r=0xa77130,</span><br><span class="line">   fullpath=&quot;./objs/nginx/html/live/livestream.m3u8&quot;) at src/protocol/srs_http_stack.cpp:391</span><br><span class="line">#3 0x000000000049957e in SrsHttpFileServer::serve_http (this=0xa12310, w=0x7ffff7f0cbd0, r=0xa77130)</span><br><span class="line">   at src/protocol/srs_http_stack.cpp:384</span><br><span class="line">#4 0x000000000049c86f in SrsHttpServeMux::serve_http (this=0xa10420, w=0x7ffff7f0cbd0, r=0xa77130)</span><br><span class="line">   at src/protocol/srs_http_stack.cpp:711</span><br><span class="line">#5 0x00000000005620a1 in SrsHttpServer::serve_http (this=0xa11e60, w=0x7ffff7f0cbd0, r=0xa77130)</span><br><span class="line">   at src/app/srs_app_http_conn.cpp:303</span><br><span class="line">#6 0x000000000049d6be in SrsHttpCorsMux::serve_http (this=0xa59bb0, w=0x7ffff7f0cbd0, r=0xa77130)</span><br><span class="line">   at src/protocol/srs_http_stack.cpp:859</span><br><span class="line">#7 0x0000000000561086 in SrsHttpConn::process_request (this=0xa76ea0, w=0x7ffff7f0cbd0, r=0xa77130)</span><br><span class="line">   at src/app/srs_app_http_conn.cpp:161</span><br><span class="line">#8 0x0000000000560ce8 in SrsHttpConn::do_cycle (this=0xa76ea0) at src/app/srs_app_http_conn.cpp:133</span><br><span class="line">#9 0x00000000004d10fb in SrsConnection::cycle (this=0xa76ea0) at src/app/srs_app_conn.cpp:171</span><br><span class="line">#10 0x0000000000509c88 in SrsSTCoroutine::cycle (this=0xa5aa20) at src/app/srs_app_st.cpp:198</span><br><span class="line">#11 0x0000000000509cfd in SrsSTCoroutine::pfn (arg=0xa5aa20) at src/app/srs_app_st.cpp:213 </span><br><span class="line">#12 0x00000000005bdd9d in _st_thread_main () at sched.c:337</span><br><span class="line">#13 0x00000000005be515 in st_thread_create (start=0x5bd719 &lt;_st_vp_schedule+170&gt;, </span><br><span class="line">    arg=0x900000001, joinable=1, stk_size=1) at sched.c:616</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHttpServer::serve_http</code>之前流程类似HTTP-FLV拉流。</li>
<li>对于HTTP-FLV进入<code>http_stream-&gt;mux.serve_http</code>，而HLS进入<code>http_static-&gt;mux.serve_http</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpServer::serve_http</span><span class="params">(ISrsHttpResponseWriter* w, ISrsHttpMessage* r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// try http stream first.</span></span><br><span class="line">    ISrsHttpHandler* h = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> ((err = http_stream-&gt;mux.<span class="built_in">find_handler</span>(r, &amp;h)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;find handler&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!h-&gt;<span class="built_in">is_not_found</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> http_stream-&gt;mux.<span class="built_in">serve_http</span>(w, r);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> http_static-&gt;mux.<span class="built_in">serve_http</span>(w, r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>与HTTP-FLV不同HLS<code>ISrsHttpHandler</code>是<code>SrsHttpFileServer</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpServeMux::serve_http</span><span class="params">(ISrsHttpResponseWriter* w, ISrsHttpMessage* r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    ISrsHttpHandler* h = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">find_handler</span>(r, &amp;h)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;find handler&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_assert</span>(h);</span><br><span class="line">    <span class="keyword">if</span> ((err = h-&gt;<span class="built_in">serve_http</span>(w, r)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;serve http&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>检查文件是否存在，<code>serve_file</code>读取文件。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpFileServer::serve_http</span><span class="params">(ISrsHttpResponseWriter* w, ISrsHttpMessage* r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">srs_assert</span>(entry);</span><br><span class="line"></span><br><span class="line">    string upath = r-&gt;<span class="built_in">path</span>();</span><br><span class="line">    string fullpath = <span class="built_in">srs_http_fs_fullpath</span>(dir, entry-&gt;pattern, upath);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// stat current dir, if exists, return error.</span></span><br><span class="line">    <span class="keyword">if</span> (!_srs_path_exists(fullpath)) &#123;</span><br><span class="line">        <span class="built_in">srs_warn</span>(<span class="string">&quot;http miss file=%s, pattern=%s, upath=%s&quot;</span>,</span><br><span class="line">                 fullpath.<span class="built_in">c_str</span>(), entry-&gt;pattern.<span class="built_in">c_str</span>(), upath.<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">SrsHttpNotFoundHandler</span>().<span class="built_in">serve_http</span>(w, r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;http match file=%s, pattern=%s, upath=%s&quot;</span>,</span><br><span class="line">              fullpath.<span class="built_in">c_str</span>(), entry-&gt;pattern.<span class="built_in">c_str</span>(), upath.<span class="built_in">c_str</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// handle file according to its extension.</span></span><br><span class="line">    <span class="comment">// use vod stream for .flv/.fhv</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">srs_string_ends_with</span>(fullpath, <span class="string">&quot;.flv&quot;</span>) || <span class="built_in">srs_string_ends_with</span>(fullpath, <span class="string">&quot;.fhv&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">serve_flv_file</span>(w, r, fullpath);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">srs_string_ends_with</span>(fullpath, <span class="string">&quot;.mp4&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">serve_mp4_file</span>(w, r, fullpath);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// serve common static file.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">serve_file</span>(w, r, fullpath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>文件读取并封装HTTP响应格式，最后调用<code>SrsHttpResponseWriter::final_request</code>完成对客户端响应。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpFileServer::serve_file</span><span class="params">(ISrsHttpResponseWriter* w, ISrsHttpMessage* r, string fullpath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    SrsFileReader* fs = fs_factory-&gt;<span class="built_in">create_file_reader</span>();</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsFileReader, fs);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((err = fs-&gt;<span class="built_in">open</span>(fullpath)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;open file %s&quot;</span>, fullpath.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The length of bytes we could response to.</span></span><br><span class="line">    <span class="type">int64_t</span> length = fs-&gt;<span class="built_in">filesize</span>() - fs-&gt;<span class="built_in">tellg</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// unset the content length to encode in chunked encoding.</span></span><br><span class="line">    w-&gt;<span class="built_in">header</span>()-&gt;<span class="built_in">set_content_length</span>(length);</span><br><span class="line">    </span><br><span class="line">    <span class="type">static</span> std::map&lt;std::string, std::string&gt; _mime;</span><br><span class="line">    <span class="keyword">if</span> (_mime.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        _mime[<span class="string">&quot;.ts&quot;</span>] = <span class="string">&quot;video/MP2T&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.flv&quot;</span>] = <span class="string">&quot;video/x-flv&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.m4v&quot;</span>] = <span class="string">&quot;video/x-m4v&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.3gpp&quot;</span>] = <span class="string">&quot;video/3gpp&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.3gp&quot;</span>] = <span class="string">&quot;video/3gpp&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.mp4&quot;</span>] = <span class="string">&quot;video/mp4&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.aac&quot;</span>] = <span class="string">&quot;audio/x-aac&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.mp3&quot;</span>] = <span class="string">&quot;audio/mpeg&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.m4a&quot;</span>] = <span class="string">&quot;audio/x-m4a&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.ogg&quot;</span>] = <span class="string">&quot;audio/ogg&quot;</span>;</span><br><span class="line">        <span class="comment">// @see hls-m3u8-draft-pantos-http-live-streaming-12.pdf, page 5.</span></span><br><span class="line">        _mime[<span class="string">&quot;.m3u8&quot;</span>] = <span class="string">&quot;application/vnd.apple.mpegurl&quot;</span>; <span class="comment">// application/x-mpegURL</span></span><br><span class="line">        _mime[<span class="string">&quot;.rss&quot;</span>] = <span class="string">&quot;application/rss+xml&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.json&quot;</span>] = <span class="string">&quot;application/json&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.swf&quot;</span>] = <span class="string">&quot;application/x-shockwave-flash&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.doc&quot;</span>] = <span class="string">&quot;application/msword&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.zip&quot;</span>] = <span class="string">&quot;application/zip&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.rar&quot;</span>] = <span class="string">&quot;application/x-rar-compressed&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.xml&quot;</span>] = <span class="string">&quot;text/xml&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.html&quot;</span>] = <span class="string">&quot;text/html&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.js&quot;</span>] = <span class="string">&quot;text/javascript&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.css&quot;</span>] = <span class="string">&quot;text/css&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.ico&quot;</span>] = <span class="string">&quot;image/x-icon&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.png&quot;</span>] = <span class="string">&quot;image/png&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.jpeg&quot;</span>] = <span class="string">&quot;image/jpeg&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.jpg&quot;</span>] = <span class="string">&quot;image/jpeg&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.gif&quot;</span>] = <span class="string">&quot;image/gif&quot;</span>;</span><br><span class="line">        <span class="comment">// For MPEG-DASH.</span></span><br><span class="line">        <span class="comment">//_mime[&quot;.mpd&quot;] = &quot;application/dash+xml&quot;;</span></span><br><span class="line">        _mime[<span class="string">&quot;.mpd&quot;</span>] = <span class="string">&quot;text/xml&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.m4s&quot;</span>] = <span class="string">&quot;video/iso.segment&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.mp4v&quot;</span>] = <span class="string">&quot;video/mp4&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        std::string ext = <span class="built_in">srs_path_filext</span>(fullpath);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (_mime.<span class="built_in">find</span>(ext) == _mime.<span class="built_in">end</span>()) &#123;</span><br><span class="line">            w-&gt;<span class="built_in">header</span>()-&gt;<span class="built_in">set_content_type</span>(<span class="string">&quot;application/octet-stream&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            w-&gt;<span class="built_in">header</span>()-&gt;<span class="built_in">set_content_type</span>(_mime[ext]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Enter chunked mode, because we didn&#x27;t set the content-length.</span></span><br><span class="line">    w-&gt;<span class="built_in">write_header</span>(SRS_CONSTS_HTTP_OK);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// write body.</span></span><br><span class="line">    <span class="type">int64_t</span> left = length;</span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">copy</span>(w, fs, r, (<span class="type">int</span>)left)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;copy file=%s size=%d&quot;</span>, fullpath.<span class="built_in">c_str</span>(), left);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = w-&gt;<span class="built_in">final_request</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;final request&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHttpFileServer</code>怎么创建的，断点<code>SrsHttpFileServer::SrsHttpFileServer</code>。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#0 SrsHttpFileServer (this=0xa12530, root_dir=&quot;\360$\241\000\000\000\000\000\021\000\000\000\000\0001000\000\021\000\000\000\00010001000100013241301\376\366\377\177\000\000 \b\241\000\000\000\000\000\000\364\363\034\031\071\000\234`\340\377\377\377\177\000\000\060%\241\000\000\000\000\000`\340\377\377\177\000\ 000R\351W\ 000\000\000\000\000\000\027\241\000\000\000\0001000\000 \241\000\000\000\000\000\260\337\377\000\b&quot;, &#x27;\000&#x27; &lt;r&gt;，</span><br><span class="line">&quot;\341\377\377\377\177\000\000\060\004\241\000\000\000\000\000\060\005\241\000\000\000\000\000\021\000\000\000\000\000\000\000\021\000\000\000\000\00010001000100010271241\000\000\000\000\000\&quot;\241\000\000\000\000\000&quot;...) at src/protocol/srs_http_stack. cpp:336</span><br><span class="line">#1 0x000000000057d326 in SrsVodStream: :SrsVodStream (this=0xa12530, root_dir=&quot;`\&quot;\241\000\000\000\000\000\021\000\000\000\000\000\000\000\021&quot;</span><br><span class="line">, &#x27;\000&#x27; &lt;repeats 24 times&gt;, &quot;\364\363\034\031\071\000\234\064\005n\000\000\000\000\000\000\b\241\000\000\000\000\000 \340\377\377\377\177\000\000\000\364\363\034\031\071\000\234\000\000\000\000\000\000\000\000\000\b\241\000\000\0001\000\000 \b\241\0001000\000\000\000\300\341\377\377\377\177\000\000\320\340\377\377\377\177\000\000\234 V\000\000\000\000\000\220\340\377\377\377\177\000\000\260\033\241\000\000\000\000\000\320\340\377\377\377\177\000\000\000\000\000\000\000\000\000\000@\b\241\00\000\000\000\00\020\000\000\000\000\000\000\000\020\000\000\000\000\000\000\000s\277I\000\000\000\000\000\250!\241\000\000\000\000\000&quot;...) </span><br><span class="line">  at src/app/srs_app_http_static.cpp:54</span><br><span class="line">#2 0x000000000057e952 in SrsHttpStaticServer::initialize (this=0xa12000)</span><br><span class="line">   at src/app/srs_app_http_static. cpp:235</span><br><span class="line">#3 0x000000000056209 in SrsHttpServer::initialize (this=0xallbb0) at src/app/srs_app_http_conn.cpp:283</span><br><span class="line">#4 0x00000000004c8648 in SrsServer::initialize (this=0xa10630, ch=0x0) at src/app/srs_app_server.cpp:757</span><br><span class="line">#5 0x00000000005bccdf in run (svr=0xa10630) at src/main/srs_main_server.cpp:395</span><br><span class="line">#6 0x00000000005bb8f1 in do_main (argc=3, argv=0×7fffffffe4f8) at src/main/srs_main_server.cpp:184</span><br><span class="line">#7 0x00000000005bba35 in main (argc=3, argv=0x7fffffffe4f8) at src/main/srs_main_server.cpp:192</span><br></pre></td></tr></table></figure>

<ul>
<li>初始化<code>SrsHttpStreamServer</code>和<code>SrsHttpStaticServer</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpServer::initialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// for SRS go-sharp to detect the status of HTTP server of SRS HTTP FLV Cluster.</span></span><br><span class="line">    <span class="comment">//需要做精碗匹配</span></span><br><span class="line">    <span class="keyword">if</span> ((err = http_static-&gt;mux.<span class="built_in">handle</span>(<span class="string">&quot;/api/v1/versions&quot;</span>, <span class="keyword">new</span> <span class="built_in">SrsGoApiVersion</span>())) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;handle versin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = http_stream-&gt;<span class="built_in">initialize</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;http stream&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = http_static-&gt;<span class="built_in">initialize</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;http static&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>注册<code>SrsVodStream</code>，基类是<code>SrsHttpFileServer</code>，在<code>find_handler</code>中可以匹配。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpStaticServer::initialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="type">bool</span> default_root_exists = <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// http static file and flv vod stream mount for each vhost.</span></span><br><span class="line">    SrsConfDirective* root = _srs_config-&gt;<span class="built_in">get_root</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; (<span class="type">int</span>)root-&gt;directives.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        SrsConfDirective* conf = root-&gt;<span class="built_in">at</span>(i);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!conf-&gt;<span class="built_in">is_vhost</span>()) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        string pmount;</span><br><span class="line">        string vhost = conf-&gt;<span class="built_in">arg0</span>();</span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">mount_vhost</span>(vhost, pmount)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;mount vhost&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (pmount == <span class="string">&quot;/&quot;</span>) &#123;</span><br><span class="line">            default_root_exists = <span class="literal">true</span>;</span><br><span class="line">            std::string dir = _srs_config-&gt;<span class="built_in">get_vhost_http_dir</span>(vhost);</span><br><span class="line">            <span class="built_in">srs_warn</span>(<span class="string">&quot;http: root mount to %s&quot;</span>, dir.<span class="built_in">c_str</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!default_root_exists) &#123;</span><br><span class="line">        <span class="comment">// add root</span></span><br><span class="line">        std::string dir = _srs_config-&gt;<span class="built_in">get_http_stream_dir</span>();</span><br><span class="line">        <span class="keyword">if</span> ((err = mux.<span class="built_in">handle</span>(<span class="string">&quot;/&quot;</span>, <span class="keyword">new</span> <span class="built_in">SrsVodStream</span>(dir))) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;mount root dir=%s&quot;</span>, dir.<span class="built_in">c_str</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">srs_trace</span>(<span class="string">&quot;http: root mount to %s&quot;</span>, dir.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/10/02/SRC%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BHTTP-FLV/" rel="prev" title="SRC流媒体服务器之HTTP-FLV">
                  <i class="fa fa-angle-left"></i> SRC流媒体服务器之HTTP-FLV
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/10/05/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BForward%E9%9B%86%E7%BE%A4/" rel="next" title="SRS流媒体服务器之Forward集群">
                  SRS流媒体服务器之Forward集群 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Fang</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"neutral","dark":"neutral"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.3.0/mermaid.min.js","integrity":"sha256-9y71g5Lz/KLsHjB8uXwnkuWDtAMDSzD/HdIbqhJfTAI="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





</body>
</html>
