<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CPT+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"fang0407.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="注：SRS版本为v6.0.75 RTMP服务运行配置文件 rtmp.conf  123456listen              1935;max_connections     1000;daemon              off;srs_log_tank        console;vhost __defaultVhost__ &amp;#123;&amp;#125;  运行服务 运行SRS服务  1">
<meta property="og:type" content="article">
<meta property="og:title" content="SRS-RTMP">
<meta property="og:url" content="https://fang0407.github.io/2023/10/29/SRS-RTMP/index.html">
<meta property="og:site_name" content="NOTE">
<meta property="og:description" content="注：SRS版本为v6.0.75 RTMP服务运行配置文件 rtmp.conf  123456listen              1935;max_connections     1000;daemon              off;srs_log_tank        console;vhost __defaultVhost__ &amp;#123;&amp;#125;  运行服务 运行SRS服务  1">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://fang0407.github.io/2023/10/29/SRS-RTMP/SRS%E6%96%AD%E7%82%B9get_listens.png">
<meta property="og:image" content="https://fang0407.github.io/2023/10/29/SRS-RTMP/SRS%E6%96%AD%E7%82%B9on_tcp_client.png">
<meta property="og:image" content="https://fang0407.github.io/2023/10/29/SRS-RTMP/10/29/SRS-RTMP/SrsRtmpConn%E4%B8%ADpublishing%E6%96%AD%E7%82%B9.png">
<meta property="og:image" content="https://fang0407.github.io/2023/10/29/SRS-RTMP/%E6%96%AD%E7%82%B9SrsLiveSource-on_video_imp.png">
<meta property="article:published_time" content="2023-10-29T02:29:39.000Z">
<meta property="article:modified_time" content="2023-12-30T14:37:41.618Z">
<meta property="article:author" content="Fang">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://fang0407.github.io/2023/10/29/SRS-RTMP/SRS%E6%96%AD%E7%82%B9get_listens.png">


<link rel="canonical" href="https://fang0407.github.io/2023/10/29/SRS-RTMP/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://fang0407.github.io/2023/10/29/SRS-RTMP/","path":"2023/10/29/SRS-RTMP/","title":"SRS-RTMP"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>SRS-RTMP | NOTE</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">NOTE</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#RTMP%E6%9C%8D%E5%8A%A1%E8%BF%90%E8%A1%8C"><span class="nav-number">1.</span> <span class="nav-text">RTMP服务运行</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">1.1.</span> <span class="nav-text">配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E6%9C%8D%E5%8A%A1"><span class="nav-number">1.2.</span> <span class="nav-text">运行服务</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#RTMP%E7%AB%AF%E5%8F%A3%E7%9B%91%E5%90%AC"><span class="nav-number">2.</span> <span class="nav-text">RTMP端口监听</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SrsServer-listen"><span class="nav-number">2.1.</span> <span class="nav-text">SrsServer::listen()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SrsTcpListener-listen"><span class="nav-number">2.2.</span> <span class="nav-text">SrsTcpListener::listen()</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#RTMP%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9E%E6%8E%A5"><span class="nav-number">3.</span> <span class="nav-text">RTMP客户端连接</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SrsTcpListener-cycle"><span class="nav-number">3.1.</span> <span class="nav-text">SrsTcpListener::cycle()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SrsServer-do-on-tcp-client"><span class="nav-number">3.2.</span> <span class="nav-text">SrsServer::do_on_tcp_client()</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#RTMP%E6%8E%A8%E6%B5%81%E7%AB%AF"><span class="nav-number">4.</span> <span class="nav-text">RTMP推流端</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#RTMP%E8%BF%9E%E6%8E%A5%E8%AF%B7%E6%B1%82%E5%8D%8F%E7%A8%8B"><span class="nav-number">4.1.</span> <span class="nav-text">RTMP连接请求协程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SrsRtmpConn-cycle"><span class="nav-number">4.1.1.</span> <span class="nav-text">SrsRtmpConn::cycle()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SrsRtmpConn-service-cycle"><span class="nav-number">4.1.2.</span> <span class="nav-text">SrsRtmpConn::service_cycle()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SrsRtmpConn-stream-service-cycle"><span class="nav-number">4.1.3.</span> <span class="nav-text">SrsRtmpConn::stream_service_cycle()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SrsRtmpConn-publishing"><span class="nav-number">4.1.4.</span> <span class="nav-text">SrsRtmpConn::publishing()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SrsRtmpConn-do-publishing"><span class="nav-number">4.1.5.</span> <span class="nav-text">SrsRtmpConn::do_publishing()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RTMP%E6%95%B0%E6%8D%AE%E6%8E%A5%E6%94%B6%E5%8D%8F%E7%A8%8B"><span class="nav-number">4.2.</span> <span class="nav-text">RTMP数据接收协程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SrsPublishRecvThread-start"><span class="nav-number">4.2.1.</span> <span class="nav-text">SrsPublishRecvThread::start()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SrsRecvThread-do-cycle"><span class="nav-number">4.2.2.</span> <span class="nav-text">SrsRecvThread::do_cycle()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SrsPublishRecvThread-consume"><span class="nav-number">4.2.3.</span> <span class="nav-text">SrsPublishRecvThread::consume()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SrsRtmpConn-handle-publish-message"><span class="nav-number">4.2.4.</span> <span class="nav-text">SrsRtmpConn::handle_publish_message()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SrsLiveSource-on-video"><span class="nav-number">4.2.5.</span> <span class="nav-text">SrsLiveSource::on_video()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SrsLiveSource-on-frame"><span class="nav-number">4.2.6.</span> <span class="nav-text">SrsLiveSource::on_frame()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SrsLiveSource-on-video-imp"><span class="nav-number">4.2.7.</span> <span class="nav-text">SrsLiveSource::on_video_imp()</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#RTMP%E6%8B%89%E6%B5%81%E7%AB%AF"><span class="nav-number">5.</span> <span class="nav-text">RTMP拉流端</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SrsRtmpConn-playing"><span class="nav-number">5.1.</span> <span class="nav-text">SrsRtmpConn::playing()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SrsQueueRecvThread-start"><span class="nav-number">5.2.</span> <span class="nav-text">SrsQueueRecvThread::start()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SrsQueueRecvThread-consume"><span class="nav-number">5.3.</span> <span class="nav-text">SrsQueueRecvThread::consume()</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Fang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">77</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/10/29/SRS-RTMP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="SRS-RTMP | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SRS-RTMP
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-10-29 10:29:39" itemprop="dateCreated datePublished" datetime="2023-10-29T10:29:39+08:00">2023-10-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-12-30 22:37:41" itemprop="dateModified" datetime="2023-12-30T22:37:41+08:00">2023-12-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SRS/" itemprop="url" rel="index"><span itemprop="name">SRS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>注：SRS版本为<code>v6.0.75</code></p>
<h1 id="RTMP服务运行"><a href="#RTMP服务运行" class="headerlink" title="RTMP服务运行"></a>RTMP服务运行</h1><h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><ul>
<li><code>rtmp.conf</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">listen              1935;</span><br><span class="line">max_connections     1000;</span><br><span class="line">daemon              off;</span><br><span class="line">srs_log_tank        console;</span><br><span class="line">vhost __defaultVhost__ &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="运行服务"><a href="#运行服务" class="headerlink" title="运行服务"></a>运行服务</h2><ul>
<li>运行SRS服务</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./obj/srs -c conf/rtmp.conf</span><br></pre></td></tr></table></figure>

<ul>
<li>推流</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -re -i test.mp4 -codec copy -f flv -y rtmp://127.0.0.1/live/livestream</span><br></pre></td></tr></table></figure>

<ul>
<li>拉流</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffplay rtmp://127.0.0.1/live/livestream</span><br></pre></td></tr></table></figure>

<h1 id="RTMP端口监听"><a href="#RTMP端口监听" class="headerlink" title="RTMP端口监听"></a>RTMP端口监听</h1><ul>
<li>断点：<code>b SrsConfig::get_listens()</code>，查看堆栈。</li>
</ul>
<img src="/2023/10/29/SRS-RTMP/SRS断点get_listens.png" alt="SRS断点get_listens" style="zoom:50%;">

<h2 id="SrsServer-listen"><a href="#SrsServer-listen" class="headerlink" title="SrsServer::listen()"></a>SrsServer::listen()</h2><p>RTMP监听配置端口。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsServer::listen</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create RTMP listeners.</span></span><br><span class="line">    rtmp_listener_-&gt;<span class="built_in">add</span>(_srs_config-&gt;<span class="built_in">get_listens</span>())-&gt;<span class="built_in">set_label</span>(<span class="string">&quot;RTMP&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp_listener_-&gt;<span class="built_in">listen</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp listen&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsMultipleTcpListeners::listen</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (vector&lt;SrsTcpListener*&gt;::iterator it = listeners_.<span class="built_in">begin</span>(); it != listeners_.<span class="built_in">end</span>(); ++it) &#123;</span><br><span class="line">        SrsTcpListener* l = *it;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((err = l-&gt;<span class="built_in">listen</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;listen&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SrsTcpListener-listen"><a href="#SrsTcpListener-listen" class="headerlink" title="SrsTcpListener::listen()"></a>SrsTcpListener::listen()</h2><ul>
<li><code>srs_tcp_listen</code>中创建套接字，监听。</li>
<li><code>trd-&gt;start()</code>启动协程，真正的协程函数是<code>handler-&gt;cycle()</code>，<code>handler</code>通过<code>SrsSTCoroutine(&quot;tcp&quot;, this)</code>构造函数的参数<code>this</code>赋值，即<code>SrsTcpListener</code>，所以具体实现是<code>SrsTcpListener::cycle()</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsTcpListener::listen</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Ignore if not configured.</span></span><br><span class="line">    <span class="keyword">if</span> (ip.<span class="built_in">empty</span>() || !port_) <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">srs_close_stfd</span>(lfd);</span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">srs_tcp_listen</span>(ip, port_, &amp;lfd)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;listen at %s:%d&quot;</span>, ip.<span class="built_in">c_str</span>(), port_);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_freep</span>(trd);</span><br><span class="line">    trd = <span class="keyword">new</span> <span class="built_in">SrsSTCoroutine</span>(<span class="string">&quot;tcp&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">start</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;start coroutine&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> fd = <span class="built_in">srs_netfd_fileno</span>(lfd);</span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;%s listen at tcp://%s:%d, fd=%d&quot;</span>, label_.<span class="built_in">c_str</span>(), ip.<span class="built_in">c_str</span>(), port_, fd);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="RTMP客户端连接"><a href="#RTMP客户端连接" class="headerlink" title="RTMP客户端连接"></a>RTMP客户端连接</h1><h2 id="SrsTcpListener-cycle"><a href="#SrsTcpListener-cycle" class="headerlink" title="SrsTcpListener::cycle()"></a>SrsTcpListener::cycle()</h2><ul>
<li><code>srs_accept()</code>接收获取客户端的连接套接字。</li>
<li><code>handler-&gt;on_tcp_client()</code>，真正处理连接的地方；这行打个断点，客户端进行RTMP推流。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsTcpListener::cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;tcp listener&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">srs_netfd_t</span> fd = <span class="built_in">srs_accept</span>(lfd, <span class="literal">NULL</span>, <span class="literal">NULL</span>, SRS_UTIME_NO_TIMEOUT);</span><br><span class="line">        <span class="keyword">if</span>(fd == <span class="literal">NULL</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_SOCKET_ACCEPT, <span class="string">&quot;accept at fd=%d&quot;</span>, <span class="built_in">srs_netfd_fileno</span>(lfd));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">srs_fd_closeexec</span>(<span class="built_in">srs_netfd_fileno</span>(fd))) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;set closeexec&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = handler-&gt;<span class="built_in">on_tcp_client</span>(<span class="keyword">this</span>, fd)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;handle fd=%d&quot;</span>, <span class="built_in">srs_netfd_fileno</span>(fd));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>断点：<code>b srs_app_listener.cpp:316</code>。</li>
</ul>
<img src="/2023/10/29/SRS-RTMP/SRS断点on_tcp_client.png" alt="SRS断点on_tcp_client" style="zoom:50%;">

<ul>
<li><code>SrsTcpListener::cycle()</code>中的<code>handler_</code>是<code>SrsMultipleTcpListeners</code>。</li>
<li><code>SrsMultipleTcpListeners::on_tcp_client()</code>中的<code>handler_</code>是<code>SrsServer</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsMultipleTcpListeners::on_tcp_client</span><span class="params">(ISrsListener* listener, <span class="type">srs_netfd_t</span> stfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> handler_-&gt;<span class="built_in">on_tcp_client</span>(<span class="keyword">this</span>, stfd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsServer::on_tcp_client</span><span class="params">(ISrsListener* listener, <span class="type">srs_netfd_t</span> stfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = <span class="built_in">do_on_tcp_client</span>(listener, stfd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We always try to close the stfd, because it should be NULL if it has been handled or closed.</span></span><br><span class="line">    <span class="built_in">srs_close_stfd</span>(stfd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SrsServer-do-on-tcp-client"><a href="#SrsServer-do-on-tcp-client" class="headerlink" title="SrsServer::do_on_tcp_client()"></a>SrsServer::do_on_tcp_client()</h2><ul>
<li>创建RTMP连接：<code>resource = new SrsRtmpConn(this, stfd2, ip, port)</code>。</li>
<li>连接管理：<code>conn_manager-&gt;add(resource)</code>。</li>
<li>启动连接协程：<code>conn-&gt;start()</code>，可以发现每个连接都对应一个协程。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsServer::do_on_tcp_client</span><span class="params">(ISrsListener* listener, <span class="type">srs_netfd_t</span>&amp; stfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> fd = <span class="built_in">srs_netfd_fileno</span>(stfd);</span><br><span class="line">    string ip = <span class="built_in">srs_get_peer_ip</span>(fd);</span><br><span class="line">    <span class="type">int</span> port = <span class="built_in">srs_get_peer_port</span>(fd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Ignore if ip is empty, for example, load balancer keepalive.</span></span><br><span class="line">    <span class="keyword">if</span> (ip.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_srs_config-&gt;<span class="built_in">empty_ip_ok</span>()) <span class="keyword">return</span> err;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_SOCKET_GET_PEER_IP, <span class="string">&quot;ignore empty ip, fd=%d&quot;</span>, fd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Security or system flow control check.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">on_before_connection</span>(stfd, ip, port)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;check&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Covert handler to resource.</span></span><br><span class="line">    ISrsResource* resource = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The context id may change during creating the bellow objects.</span></span><br><span class="line">    <span class="built_in">SrsContextRestore</span>(_srs_context-&gt;<span class="built_in">get_id</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// From now on, we always handle the stfd, so we set the original one to NULL.</span></span><br><span class="line">    <span class="type">srs_netfd_t</span> stfd2 = stfd;</span><br><span class="line">    stfd = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_RTC</span></span><br><span class="line">    <span class="comment">// If reuse HTTP server with WebRTC TCP, peek to detect the client.</span></span><br><span class="line">    <span class="keyword">if</span> (reuse_rtc_over_server_ &amp;&amp; (listener == http_listener_ || listener == https_listener_)) &#123;</span><br><span class="line">        SrsTcpConnection* skt = <span class="keyword">new</span> <span class="built_in">SrsTcpConnection</span>(stfd2);</span><br><span class="line">        SrsBufferedReadWriter* io = <span class="keyword">new</span> <span class="built_in">SrsBufferedReadWriter</span>(skt);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Peek first N bytes to finger out the real client type.</span></span><br><span class="line">        <span class="type">uint8_t</span> b[<span class="number">10</span>]; <span class="type">int</span> nn = <span class="built_in">sizeof</span>(b);</span><br><span class="line">        <span class="keyword">if</span> ((err = io-&gt;<span class="built_in">peek</span>((<span class="type">char</span>*)b, &amp;nn)) != srs_success) &#123;</span><br><span class="line">            <span class="built_in">srs_freep</span>(io); <span class="built_in">srs_freep</span>(skt);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;peek&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If first message is BindingRequest(00 01), prefixed with length(2B), it&#x27;s WebRTC client. Generally, the frame</span></span><br><span class="line">        <span class="comment">// length minus message length should be 20, that is the header size of STUN is 20 bytes. For example:</span></span><br><span class="line">        <span class="comment">//      00 6c # Frame length: 0x006c = 108</span></span><br><span class="line">        <span class="comment">//      00 01 # Message Type: Binding Request(0x0001)</span></span><br><span class="line">        <span class="comment">//      00 58 # Message Length: 0x005 = 88</span></span><br><span class="line">        <span class="comment">//      21 12 a4 42 # Message Cookie: 0x2112a442</span></span><br><span class="line">        <span class="comment">//      48 32 6c 61 6b 42 35 71 42 35 4a 71 # Message Transaction ID: 12 bytes</span></span><br><span class="line">        <span class="keyword">if</span> (nn == <span class="number">10</span> &amp;&amp; b[<span class="number">0</span>] == <span class="number">0</span> &amp;&amp; b[<span class="number">2</span>] == <span class="number">0</span> &amp;&amp; b[<span class="number">3</span>] == <span class="number">1</span> &amp;&amp; b[<span class="number">1</span>] - b[<span class="number">5</span>] == <span class="number">20</span></span><br><span class="line">            &amp;&amp; b[<span class="number">6</span>] == <span class="number">0x21</span> &amp;&amp; b[<span class="number">7</span>] == <span class="number">0x12</span> &amp;&amp; b[<span class="number">8</span>] == <span class="number">0xa4</span> &amp;&amp; b[<span class="number">9</span>] == <span class="number">0x42</span></span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> Should manage this connection by _srs_rtc_manager</span></span><br><span class="line">            resource = <span class="keyword">new</span> <span class="built_in">SrsRtcTcpConn</span>(io, ip, port, <span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resource = <span class="keyword">new</span> <span class="built_in">SrsHttpxConn</span>(listener == http_listener_, <span class="keyword">this</span>, io, http_server, ip, port);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create resource by normal listeners.</span></span><br><span class="line">    <span class="keyword">if</span> (!resource) &#123;</span><br><span class="line">        <span class="keyword">if</span> (listener == rtmp_listener_) &#123;</span><br><span class="line">            resource = <span class="keyword">new</span> <span class="built_in">SrsRtmpConn</span>(<span class="keyword">this</span>, stfd2, ip, port);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (listener == api_listener_ || listener == apis_listener_) &#123;</span><br><span class="line">            <span class="type">bool</span> is_https = listener == apis_listener_;</span><br><span class="line">            resource = <span class="keyword">new</span> <span class="built_in">SrsHttpxConn</span>(is_https, <span class="keyword">this</span>, <span class="keyword">new</span> <span class="built_in">SrsTcpConnection</span>(stfd2), http_api_mux, ip, port);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (listener == http_listener_ || listener == https_listener_) &#123;</span><br><span class="line">            <span class="type">bool</span> is_https = listener == https_listener_;</span><br><span class="line">            resource = <span class="keyword">new</span> <span class="built_in">SrsHttpxConn</span>(is_https, <span class="keyword">this</span>, <span class="keyword">new</span> <span class="built_in">SrsTcpConnection</span>(stfd2), http_server, ip, port);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_RTC</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (listener == webrtc_listener_) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> Should manage this connection by _srs_rtc_manager</span></span><br><span class="line">            resource = <span class="keyword">new</span> <span class="built_in">SrsRtcTcpConn</span>(<span class="keyword">new</span> <span class="built_in">SrsTcpConnection</span>(stfd2), ip, port, <span class="keyword">this</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (listener == exporter_listener_) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> Maybe should support https metrics.</span></span><br><span class="line">            <span class="type">bool</span> is_https = <span class="literal">false</span>;</span><br><span class="line">            resource = <span class="keyword">new</span> <span class="built_in">SrsHttpxConn</span>(is_https, <span class="keyword">this</span>, <span class="keyword">new</span> <span class="built_in">SrsTcpConnection</span>(stfd2), http_api_mux, ip, port);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">srs_close_stfd</span>(stfd2);</span><br><span class="line">            <span class="built_in">srs_warn</span>(<span class="string">&quot;Close for invalid fd=%d, ip=%s:%d&quot;</span>, fd, ip.<span class="built_in">c_str</span>(), port);</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use connection manager to manage all the resources.</span></span><br><span class="line">    conn_manager-&gt;<span class="built_in">add</span>(resource);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If connection is a resource to start, start a coroutine to handle it.</span></span><br><span class="line">    ISrsStartable* conn = <span class="built_in">dynamic_cast</span>&lt;ISrsStartable*&gt;(resource);</span><br><span class="line">    <span class="keyword">if</span> ((err = conn-&gt;<span class="built_in">start</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;start conn coroutine&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="RTMP推流端"><a href="#RTMP推流端" class="headerlink" title="RTMP推流端"></a>RTMP推流端</h1><h2 id="RTMP连接请求协程"><a href="#RTMP连接请求协程" class="headerlink" title="RTMP连接请求协程"></a>RTMP连接请求协程</h2><ul>
<li>断点<code>b SrsRtmpConn::publishing(SrsLiveSource*)</code>。</li>
</ul>
<img src="/2023/10/29/SRS-RTMP/10/29/SRS-RTMP/SrsRtmpConn%E4%B8%ADpublishing%E6%96%AD%E7%82%B9.png" class title="SrsRtmpConn中publishing断点">

<h3 id="SrsRtmpConn-cycle"><a href="#SrsRtmpConn-cycle" class="headerlink" title="SrsRtmpConn::cycle()"></a>SrsRtmpConn::cycle()</h3><ul>
<li>上述<code>conn-&gt;start()</code>启动后，同样会调用协程函数。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Serve the client.</span></span><br><span class="line">    err = <span class="built_in">do_cycle</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">    <span class="comment">// Final APM span, parent is the last span, not the root span. Note that only client or server kind will be filtered</span></span><br><span class="line">    <span class="comment">// for error or exception report.</span></span><br><span class="line">    ISrsApmSpan* span_final = _srs_apm-&gt;<span class="built_in">span</span>(<span class="string">&quot;final&quot;</span>)-&gt;<span class="built_in">set_kind</span>(SrsApmKindServer)-&gt;<span class="built_in">as_child</span>(span_client_);</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(ISrsApmSpan, span_final);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">srs_error_code</span>(err) != <span class="number">0</span>) &#123;</span><br><span class="line">        span_final-&gt;<span class="built_in">record_error</span>(err)-&gt;<span class="built_in">set_status</span>(SrsApmStatusError, </span><br><span class="line">                                                  <span class="built_in">srs_fmt</span>(<span class="string">&quot;fail code=%d&quot;</span>, <span class="built_in">srs_error_code</span>(err)));</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update statistic when done.</span></span><br><span class="line">    SrsStatistic* stat = SrsStatistic::<span class="built_in">instance</span>();</span><br><span class="line">    stat-&gt;<span class="built_in">kbps_add_delta</span>(<span class="built_in">get_id</span>().<span class="built_in">c_str</span>(), delta_);</span><br><span class="line">    stat-&gt;<span class="built_in">on_disconnect</span>(<span class="built_in">get_id</span>().<span class="built_in">c_str</span>(), err);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Notify manager to remove it.</span></span><br><span class="line">    <span class="comment">// Note that we create this object, so we use manager to remove it.</span></span><br><span class="line">    manager-&gt;<span class="built_in">remove</span>(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// success.</span></span><br><span class="line">    <span class="keyword">if</span> (err == srs_success) &#123;</span><br><span class="line">        <span class="built_in">srs_trace</span>(<span class="string">&quot;client finished.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// It maybe success with message.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">srs_error_code</span>(err) == ERROR_SUCCESS) &#123;</span><br><span class="line">        <span class="built_in">srs_trace</span>(<span class="string">&quot;client finished%s.&quot;</span>, <span class="built_in">srs_error_summary</span>(err).<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="built_in">srs_freep</span>(err);</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// client close peer.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> Only reset the error when client closed it.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">srs_is_client_gracefully_close</span>(err)) &#123;</span><br><span class="line">        <span class="built_in">srs_warn</span>(<span class="string">&quot;client disconnect peer. ret=%d&quot;</span>, <span class="built_in">srs_error_code</span>(err));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">srs_is_server_gracefully_close</span>(err)) &#123;</span><br><span class="line">        <span class="built_in">srs_warn</span>(<span class="string">&quot;server disconnect. ret=%d&quot;</span>, <span class="built_in">srs_error_code</span>(err));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">srs_error</span>(<span class="string">&quot;serve error %s&quot;</span>, <span class="built_in">srs_error_desc</span>(err).<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">srs_freep</span>(err);</span><br><span class="line">    <span class="keyword">return</span> srs_success;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>RTMP协议握手：<code>rtmp-&gt;handshake()</code>。</li>
<li>处理客户端连接命令：<code>rtmp-&gt;connect_app(req)</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::do_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">    <span class="comment">// We should keep the root span to alive util connection closed.</span></span><br><span class="line">    <span class="comment">// Note that we use producer and consumer span because RTMP connection is long polling connection.</span></span><br><span class="line">    <span class="comment">// Note that we also store this span in coroutine context, so that edge could load it.</span></span><br><span class="line">    <span class="built_in">srs_freep</span>(span_main_);</span><br><span class="line">    span_main_ = _srs_apm-&gt;<span class="built_in">span</span>(<span class="string">&quot;rtmp&quot;</span>)-&gt;<span class="built_in">set_kind</span>(SrsApmKindServer)-&gt;<span class="built_in">attr</span>(<span class="string">&quot;cip&quot;</span>, ip)</span><br><span class="line">        -&gt;<span class="built_in">attr</span>(<span class="string">&quot;cid&quot;</span>, _srs_context-&gt;<span class="built_in">get_id</span>().<span class="built_in">c_str</span>());</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;RTMP client ip=%s:%d, fd=%d, trace=%s, span=%s&quot;</span>, ip.<span class="built_in">c_str</span>(), port, <span class="built_in">srs_netfd_fileno</span>(stfd),</span><br><span class="line">        span_main_-&gt;format_trace_id(), span_main_-&gt;format_span_id()</span><br><span class="line">    );</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;RTMP client ip=%s:%d, fd=%d&quot;</span>, ip.<span class="built_in">c_str</span>(), port, <span class="built_in">srs_netfd_fileno</span>(stfd));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    rtmp-&gt;<span class="built_in">set_recv_timeout</span>(SRS_CONSTS_RTMP_TIMEOUT);</span><br><span class="line">    rtmp-&gt;<span class="built_in">set_send_timeout</span>(SRS_CONSTS_RTMP_TIMEOUT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">handshake</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp handshake&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> rip = rtmp-&gt;<span class="built_in">proxy_real_ip</span>();</span><br><span class="line">    std::string rips = <span class="built_in">srs_ipv4_string</span>(rip);</span><br><span class="line">    <span class="keyword">if</span> (rip &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">srs_trace</span>(<span class="string">&quot;RTMP proxy real client ip=%s&quot;</span>, rips.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">    <span class="comment">// Update the real IP of client, also set the HTTP fields.</span></span><br><span class="line">    span_main_-&gt;<span class="built_in">attr</span>(<span class="string">&quot;rip&quot;</span>, rip ? rips : ip)-&gt;<span class="built_in">attr</span>(<span class="string">&quot;http.client_ip&quot;</span>, rip ? rips : ip);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The span for RTMP connecting to application.</span></span><br><span class="line">    <span class="built_in">srs_freep</span>(span_connect_);</span><br><span class="line">    span_connect_ = _srs_apm-&gt;<span class="built_in">span</span>(<span class="string">&quot;connect&quot;</span>)-&gt;<span class="built_in">as_child</span>(span_main_);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">connect_app</span>(req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp connect tcUrl&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set client ip to request.</span></span><br><span class="line">    req-&gt;ip = ip;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;connect app, tcUrl=%s, pageUrl=%s, swfUrl=%s, schema=%s, vhost=%s, port=%d, app=%s, args=%s&quot;</span>,</span><br><span class="line">        req-&gt;tcUrl.<span class="built_in">c_str</span>(), req-&gt;pageUrl.<span class="built_in">c_str</span>(), req-&gt;swfUrl.<span class="built_in">c_str</span>(),</span><br><span class="line">        req-&gt;schema.<span class="built_in">c_str</span>(), req-&gt;vhost.<span class="built_in">c_str</span>(), req-&gt;port,</span><br><span class="line">        req-&gt;app.<span class="built_in">c_str</span>(), (req-&gt;args? <span class="string">&quot;(obj)&quot;</span>:<span class="string">&quot;null&quot;</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// show client identity</span></span><br><span class="line">    <span class="keyword">if</span>(req-&gt;args) &#123;</span><br><span class="line">        std::string srs_version;</span><br><span class="line">        std::string srs_server_ip;</span><br><span class="line">        <span class="type">int</span> srs_pid = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> srs_id = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        SrsAmf0Any* prop = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> ((prop = req-&gt;args-&gt;<span class="built_in">ensure_property_string</span>(<span class="string">&quot;srs_version&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            srs_version = prop-&gt;<span class="built_in">to_str</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((prop = req-&gt;args-&gt;<span class="built_in">ensure_property_string</span>(<span class="string">&quot;srs_server_ip&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            srs_server_ip = prop-&gt;<span class="built_in">to_str</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((prop = req-&gt;args-&gt;<span class="built_in">ensure_property_number</span>(<span class="string">&quot;srs_pid&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            srs_pid = (<span class="type">int</span>)prop-&gt;<span class="built_in">to_number</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((prop = req-&gt;args-&gt;<span class="built_in">ensure_property_number</span>(<span class="string">&quot;srs_id&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            srs_id = (<span class="type">int</span>)prop-&gt;<span class="built_in">to_number</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (srs_pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">srs_trace</span>(<span class="string">&quot;edge-srs ip=%s, version=%s, pid=%d, id=%d&quot;</span>,</span><br><span class="line">                srs_server_ip.<span class="built_in">c_str</span>(), srs_version.<span class="built_in">c_str</span>(), srs_pid, srs_id);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">        <span class="comment">// Load the span from the AMF0 object propagator.</span></span><br><span class="line">        <span class="comment">// Note that we will update the trace id, so please make sure no spans are ended before this.</span></span><br><span class="line">        _srs_apm-&gt;<span class="built_in">extract</span>(span_main_, req-&gt;args);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">service_cycle</span>()) != srs_success) &#123;</span><br><span class="line">        err = <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;service cycle&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">srs_error_t</span> r0 = srs_success;</span><br><span class="line">    <span class="keyword">if</span> ((r0 = <span class="built_in">on_disconnect</span>()) != srs_success) &#123;</span><br><span class="line">        err = <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;on disconnect %s&quot;</span>, <span class="built_in">srs_error_desc</span>(r0).<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="built_in">srs_freep</span>(r0);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// If client is redirect to other servers, we already logged the event.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">srs_error_code</span>(err) == ERROR_CONTROL_REDIRECT) &#123;</span><br><span class="line">        <span class="built_in">srs_error_reset</span>(err);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SrsRtmpConn-service-cycle"><a href="#SrsRtmpConn-service-cycle" class="headerlink" title="SrsRtmpConn::service_cycle()"></a>SrsRtmpConn::service_cycle()</h3><ul>
<li>设置窗口大小：<code>rtmp-&gt;set_window_ack_size()</code>。</li>
<li>设置带宽：<code>rtmp-&gt;set_peer_bandwidth()</code>。</li>
<li>设置块传输大小：<code>rtmp-&gt;set_chunk_size</code>。</li>
<li>响应客户端连接命令：<code>rtmp-&gt;response_connect_app()</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::service_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> out_ack_size = _srs_config-&gt;<span class="built_in">get_out_ack_size</span>(req-&gt;vhost);</span><br><span class="line">    <span class="keyword">if</span> (out_ack_size &amp;&amp; (err = rtmp-&gt;<span class="built_in">set_window_ack_size</span>(out_ack_size)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: set out window ack size&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> in_ack_size = _srs_config-&gt;<span class="built_in">get_in_ack_size</span>(req-&gt;vhost);</span><br><span class="line">    <span class="keyword">if</span> (in_ack_size &amp;&amp; (err = rtmp-&gt;<span class="built_in">set_in_window_ack_size</span>(in_ack_size)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: set in window ack size&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">set_peer_bandwidth</span>((<span class="type">int</span>)(<span class="number">2.5</span> * <span class="number">1000</span> * <span class="number">1000</span>), <span class="number">2</span>)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: set peer bandwidth&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// get the ip which client connected.</span></span><br><span class="line">    std::string local_ip = <span class="built_in">srs_get_local_ip</span>(<span class="built_in">srs_netfd_fileno</span>(stfd));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// set chunk size to larger.</span></span><br><span class="line">    <span class="comment">// set the chunk size before any larger response greater than 128,</span></span><br><span class="line">    <span class="comment">// to make OBS happy, @see https://github.com/ossrs/srs/issues/454</span></span><br><span class="line">    <span class="type">int</span> chunk_size = _srs_config-&gt;<span class="built_in">get_chunk_size</span>(req-&gt;vhost);</span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">set_chunk_size</span>(chunk_size)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: set chunk size %d&quot;</span>, chunk_size);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// response the client connect ok.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">response_connect_app</span>(req, local_ip.<span class="built_in">c_str</span>())) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: response connect app&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">    <span class="comment">// Must be a connecting application span.</span></span><br><span class="line">    span_connect_-&gt;<span class="built_in">end</span>();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">on_bw_done</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: on bw down&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: thread quit&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        err = <span class="built_in">stream_service_cycle</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// stream service must terminated with error, never success.</span></span><br><span class="line">        <span class="comment">// when terminated with success, it&#x27;s user required to stop.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> Support RTMP client timeout, https://github.com/ossrs/srs/issues/1134</span></span><br><span class="line">        <span class="keyword">if</span> (err == srs_success) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// when not system control error, fatal error, return.</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">srs_is_system_control_error</span>(err)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: stream service&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// for republish, continue service</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">srs_error_code</span>(err) == ERROR_CONTROL_REPUBLISH) &#123;</span><br><span class="line">            <span class="comment">// set timeout to a larger value, wait for encoder to republish.</span></span><br><span class="line">            rtmp-&gt;<span class="built_in">set_send_timeout</span>(SRS_REPUBLISH_RECV_TIMEOUT);</span><br><span class="line">            rtmp-&gt;<span class="built_in">set_recv_timeout</span>(SRS_REPUBLISH_SEND_TIMEOUT);</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">srs_info</span>(<span class="string">&quot;rtmp: retry for republish&quot;</span>);</span><br><span class="line">            <span class="built_in">srs_freep</span>(err);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// for &quot;some&quot; system control error,</span></span><br><span class="line">        <span class="comment">// logical accept and retry stream service.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">srs_error_code</span>(err) == ERROR_CONTROL_RTMP_CLOSE) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> use ping message to anti-death of socket.</span></span><br><span class="line">            <span class="comment">// set timeout to a larger value, for user paused.</span></span><br><span class="line">            rtmp-&gt;<span class="built_in">set_recv_timeout</span>(SRS_PAUSED_RECV_TIMEOUT);</span><br><span class="line">            rtmp-&gt;<span class="built_in">set_send_timeout</span>(SRS_PAUSED_SEND_TIMEOUT);</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">srs_trace</span>(<span class="string">&quot;rtmp: retry for close&quot;</span>);</span><br><span class="line">            <span class="built_in">srs_freep</span>(err);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// for other system control message, fatal error.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: reject&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SrsRtmpConn-stream-service-cycle"><a href="#SrsRtmpConn-stream-service-cycle" class="headerlink" title="SrsRtmpConn::stream_service_cycle()"></a>SrsRtmpConn::stream_service_cycle()</h3><ul>
<li>通过<code>rtmp-&gt;identify_client()</code>获取连接类型，判断拉流还是推流。</li>
<li><code>_srs_sources-&gt;fetch_or_create()</code>创建或获取<code>SrsLiveSource</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::stream_service_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">identify_client</span>(info-&gt;res-&gt;stream_id, info-&gt;type, req-&gt;stream, req-&gt;duration)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: identify client&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_discovery_tc_url</span>(req-&gt;tcUrl, req-&gt;schema, req-&gt;host, </span><br><span class="line">                         req-&gt;vhost, req-&gt;app, req-&gt;stream, req-&gt;port, req-&gt;param);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// guess stream name</span></span><br><span class="line">    <span class="keyword">if</span> (req-&gt;stream.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        string app = req-&gt;app, param = req-&gt;param;</span><br><span class="line">        <span class="built_in">srs_guess_stream_by_app</span>(req-&gt;app, req-&gt;param, req-&gt;stream);</span><br><span class="line">        <span class="built_in">srs_trace</span>(<span class="string">&quot;Guessing by app=%s, param=%s to app=%s, param=%s, stream=%s&quot;</span>, </span><br><span class="line">                  app.<span class="built_in">c_str</span>(), param.<span class="built_in">c_str</span>(), req-&gt;app.<span class="built_in">c_str</span>(), req-&gt;param.<span class="built_in">c_str</span>(), req-&gt;stream.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    req-&gt;<span class="built_in">strip</span>();</span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;client identified, type=%s, vhost=%s, app=%s, stream=%s, param=%s, duration=%dms&quot;</span>,</span><br><span class="line">        <span class="built_in">srs_client_type_string</span>(info-&gt;type).<span class="built_in">c_str</span>(), req-&gt;vhost.<span class="built_in">c_str</span>(), req-&gt;app.<span class="built_in">c_str</span>(), req-&gt;stream.<span class="built_in">c_str</span>(), req-&gt;param.<span class="built_in">c_str</span>(), <span class="built_in">srsu2msi</span>(req-&gt;duration));</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">    <span class="comment">// Start APM only when client is identified, because it might republish.</span></span><br><span class="line">    <span class="built_in">srs_freep</span>(span_client_);</span><br><span class="line">    span_client_ = _srs_apm-&gt;<span class="built_in">span</span>(<span class="string">&quot;client&quot;</span>)-&gt;<span class="built_in">as_child</span>(span_connect_)-&gt;<span class="built_in">attr</span>(<span class="string">&quot;type&quot;</span>, <span class="built_in">srs_client_type_string</span>(info-&gt;type))</span><br><span class="line">        -&gt;<span class="built_in">attr</span>(<span class="string">&quot;url&quot;</span>, req-&gt;<span class="built_in">get_stream_url</span>())-&gt;<span class="built_in">attr</span>(<span class="string">&quot;http.url&quot;</span>, req-&gt;<span class="built_in">get_stream_url</span>());</span><br><span class="line">    <span class="comment">// We store the span to coroutine context, for edge to load it.</span></span><br><span class="line">    _srs_apm-&gt;<span class="built_in">store</span>(span_client_);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// discovery vhost, resolve the vhost from config</span></span><br><span class="line">    SrsConfDirective* parsed_vhost = _srs_config-&gt;<span class="built_in">get_vhost</span>(req-&gt;vhost);</span><br><span class="line">    <span class="keyword">if</span> (parsed_vhost) &#123;</span><br><span class="line">        req-&gt;vhost = parsed_vhost-&gt;<span class="built_in">arg0</span>();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">    span_client_-&gt;<span class="built_in">attr</span>(<span class="string">&quot;vhost&quot;</span>, req-&gt;vhost)-&gt;<span class="built_in">attr</span>(<span class="string">&quot;http.host&quot;</span>, req-&gt;host)-&gt;<span class="built_in">attr</span>(<span class="string">&quot;http.server_name&quot;</span>, req-&gt;vhost)</span><br><span class="line">        -&gt;<span class="built_in">attr</span>(<span class="string">&quot;http.target&quot;</span>, <span class="built_in">srs_fmt</span>(<span class="string">&quot;/%s/%s&quot;</span>, req-&gt;app.<span class="built_in">c_str</span>(), req-&gt;stream.<span class="built_in">c_str</span>()));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (req-&gt;schema.<span class="built_in">empty</span>() || req-&gt;vhost.<span class="built_in">empty</span>() || req-&gt;port == <span class="number">0</span> || req-&gt;app.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_RTMP_REQ_TCURL, <span class="string">&quot;discovery tcUrl failed, tcUrl=%s, schema=%s, vhost=%s, port=%d, app=%s&quot;</span>,</span><br><span class="line">            req-&gt;tcUrl.<span class="built_in">c_str</span>(), req-&gt;schema.<span class="built_in">c_str</span>(), req-&gt;vhost.<span class="built_in">c_str</span>(), req-&gt;port, req-&gt;app.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check vhost, allow default vhost.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">check_vhost</span>(<span class="literal">true</span>)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;check vhost&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;connected stream, tcUrl=%s, pageUrl=%s, swfUrl=%s, schema=%s, vhost=%s, port=%d, app=%s, stream=%s, param=%s, args=%s&quot;</span>,</span><br><span class="line">        req-&gt;tcUrl.<span class="built_in">c_str</span>(), req-&gt;pageUrl.<span class="built_in">c_str</span>(), req-&gt;swfUrl.<span class="built_in">c_str</span>(), req-&gt;schema.<span class="built_in">c_str</span>(), req-&gt;vhost.<span class="built_in">c_str</span>(), req-&gt;port,</span><br><span class="line">        req-&gt;app.<span class="built_in">c_str</span>(), req-&gt;stream.<span class="built_in">c_str</span>(), req-&gt;param.<span class="built_in">c_str</span>(), (req-&gt;args? <span class="string">&quot;(obj)&quot;</span>:<span class="string">&quot;null&quot;</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// do token traverse before serve it.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/pull/239</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        info-&gt;edge = _srs_config-&gt;<span class="built_in">get_vhost_is_edge</span>(req-&gt;vhost);</span><br><span class="line">        <span class="type">bool</span> edge_traverse = _srs_config-&gt;<span class="built_in">get_vhost_edge_token_traverse</span>(req-&gt;vhost);</span><br><span class="line">        <span class="keyword">if</span> (info-&gt;edge &amp;&amp; edge_traverse) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((err = <span class="built_in">check_edge_token_traverse_auth</span>()) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: check token traverse&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// security check</span></span><br><span class="line">    <span class="keyword">if</span> ((err = security-&gt;<span class="built_in">check</span>(info-&gt;type, ip, req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: security check&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Never allow the empty stream name, for HLS may write to a file with empty name.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/834</span></span><br><span class="line">    <span class="keyword">if</span> (req-&gt;stream.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_RTMP_STREAM_NAME_EMPTY, <span class="string">&quot;rtmp: empty stream&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// client is identified, set the timeout to service timeout.</span></span><br><span class="line">    rtmp-&gt;<span class="built_in">set_recv_timeout</span>(SRS_CONSTS_RTMP_TIMEOUT);</span><br><span class="line">    rtmp-&gt;<span class="built_in">set_send_timeout</span>(SRS_CONSTS_RTMP_TIMEOUT);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// find a source to serve.</span></span><br><span class="line">    SrsLiveSource* source = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> ((err = _srs_sources-&gt;<span class="built_in">fetch_or_create</span>(req, server, &amp;source)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: fetch source&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">srs_assert</span>(source != <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> enabled_cache = _srs_config-&gt;<span class="built_in">get_gop_cache</span>(req-&gt;vhost);</span><br><span class="line">    <span class="type">int</span> gcmf = _srs_config-&gt;<span class="built_in">get_gop_cache_max_frames</span>(req-&gt;vhost);</span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;source url=%s, ip=%s, cache=%d/%d, is_edge=%d, source_id=%s/%s&quot;</span>,</span><br><span class="line">        req-&gt;<span class="built_in">get_stream_url</span>().<span class="built_in">c_str</span>(), </span><br><span class="line">              ip.<span class="built_in">c_str</span>(), </span><br><span class="line">              enabled_cache, </span><br><span class="line">              gcmf, </span><br><span class="line">              info-&gt;edge, </span><br><span class="line">              source-&gt;<span class="built_in">source_id</span>().<span class="built_in">c_str</span>(),</span><br><span class="line">              source-&gt;<span class="built_in">pre_source_id</span>().<span class="built_in">c_str</span>());</span><br><span class="line">    </span><br><span class="line">    source-&gt;<span class="built_in">set_cache</span>(enabled_cache);</span><br><span class="line">    source-&gt;<span class="built_in">set_gop_cache_max_frames</span>(gcmf);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (info-&gt;type) &#123;</span><br><span class="line">        <span class="keyword">case</span> SrsRtmpConnPlay: &#123;</span><br><span class="line">            <span class="comment">// response connection start play</span></span><br><span class="line">            <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">start_play</span>(info-&gt;res-&gt;stream_id)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: start play&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// We must do stat the client before hooks, because hooks depends on it.</span></span><br><span class="line">            SrsStatistic* stat = SrsStatistic::<span class="built_in">instance</span>();</span><br><span class="line">            <span class="keyword">if</span> ((err = stat-&gt;<span class="built_in">on_client</span>(_srs_context-&gt;<span class="built_in">get_id</span>().<span class="built_in">c_str</span>(), req, <span class="keyword">this</span>, info-&gt;type)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: stat client&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// We must do hook after stat, because depends on it.</span></span><br><span class="line">            <span class="keyword">if</span> ((err = <span class="built_in">http_hooks_on_play</span>()) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: callback on play&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">            <span class="comment">// Must be a client span.</span></span><br><span class="line">            span_client_-&gt;<span class="built_in">set_name</span>(<span class="string">&quot;play&quot;</span>)-&gt;<span class="built_in">end</span>();</span><br><span class="line">            <span class="comment">// We end the connection span because it&#x27;s a producer and only trace the established.</span></span><br><span class="line">            span_main_-&gt;<span class="built_in">end</span>();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            </span><br><span class="line">            err = <span class="built_in">playing</span>(source);</span><br><span class="line">            <span class="built_in">http_hooks_on_stop</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> SrsRtmpConnFMLEPublish: &#123;</span><br><span class="line">            <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">start_fmle_publish</span>(info-&gt;res-&gt;stream_id)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: start FMLE publish&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">            <span class="comment">// Must be a client span.</span></span><br><span class="line">            span_client_-&gt;<span class="built_in">set_name</span>(<span class="string">&quot;publish&quot;</span>)-&gt;<span class="built_in">end</span>();</span><br><span class="line">            <span class="comment">// We end the connection span because it&#x27;s a producer and only trace the established.</span></span><br><span class="line">            span_main_-&gt;<span class="built_in">end</span>();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">publishing</span>(source);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> SrsRtmpConnHaivisionPublish: &#123;</span><br><span class="line">            <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">start_haivision_publish</span>(info-&gt;res-&gt;stream_id)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: start HAIVISION publish&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">            <span class="comment">// Must be a client span.</span></span><br><span class="line">            span_client_-&gt;<span class="built_in">set_name</span>(<span class="string">&quot;publish&quot;</span>)-&gt;<span class="built_in">end</span>();</span><br><span class="line">            <span class="comment">// We end the connection span because it&#x27;s a producer and only trace the established.</span></span><br><span class="line">            span_main_-&gt;<span class="built_in">end</span>();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">publishing</span>(source);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> SrsRtmpConnFlashPublish: &#123;</span><br><span class="line">            <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">start_flash_publish</span>(info-&gt;res-&gt;stream_id)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: start FLASH publish&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">            <span class="comment">// Must be a client span.</span></span><br><span class="line">            span_client_-&gt;<span class="built_in">set_name</span>(<span class="string">&quot;publish&quot;</span>)-&gt;<span class="built_in">end</span>();</span><br><span class="line">            <span class="comment">// We end the connection span because it&#x27;s a producer and only trace the established.</span></span><br><span class="line">            span_main_-&gt;<span class="built_in">end</span>();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">publishing</span>(source);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_SYSTEM_CLIENT_INVALID, <span class="string">&quot;rtmp: unknown client type=%d&quot;</span>, info-&gt;type);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SrsRtmpConn-publishing"><a href="#SrsRtmpConn-publishing" class="headerlink" title="SrsRtmpConn::publishing()"></a>SrsRtmpConn::publishing()</h3><ul>
<li><code>SrsPublishRecvThread</code>接收推流数据协程，在<code>do_publishing</code>中启动。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::publishing</span><span class="params">(SrsLiveSource* source)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (_srs_config-&gt;<span class="built_in">get_refer_enabled</span>(req-&gt;vhost)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = refer-&gt;<span class="built_in">check</span>(req-&gt;pageUrl, _srs_config-&gt;<span class="built_in">get_refer_publish</span>(req-&gt;vhost))) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: referer check&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We must do stat the client before hooks, because hooks depends on it.</span></span><br><span class="line">    SrsStatistic* stat = SrsStatistic::<span class="built_in">instance</span>();</span><br><span class="line">    <span class="keyword">if</span> ((err = stat-&gt;<span class="built_in">on_client</span>(_srs_context-&gt;<span class="built_in">get_id</span>().<span class="built_in">c_str</span>(), req, <span class="keyword">this</span>, info-&gt;type)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: stat client&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We must do hook after stat, because depends on it.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">http_hooks_on_publish</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: callback on publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> Should refine the state of publishing.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">acquire_publish</span>(source)) == srs_success) &#123;</span><br><span class="line">        <span class="comment">// use isolate thread to recv,</span></span><br><span class="line">        <span class="comment">// @see: https://github.com/ossrs/srs/issues/237</span></span><br><span class="line">        <span class="function">SrsPublishRecvThread <span class="title">rtrd</span><span class="params">(rtmp, req, srs_netfd_fileno(stfd), <span class="number">0</span>, <span class="keyword">this</span>, source, _srs_context-&gt;get_id())</span></span>;</span><br><span class="line">        err = <span class="built_in">do_publishing</span>(source, &amp;rtrd);</span><br><span class="line">        rtrd.<span class="built_in">stop</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// whatever the acquire publish, always release publish.</span></span><br><span class="line">    <span class="comment">// when the acquire error in the midlle-way, the publish state changed,</span></span><br><span class="line">    <span class="comment">// but failed, so we must cleanup it.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/474</span></span><br><span class="line">    <span class="comment">// @remark when stream is busy, should never release it.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">srs_error_code</span>(err) != ERROR_SYSTEM_STREAM_BUSY) &#123;</span><br><span class="line">        <span class="built_in">release_publish</span>(source);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">http_hooks_on_unpublish</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SrsRtmpConn-do-publishing"><a href="#SrsRtmpConn-do-publishing" class="headerlink" title="SrsRtmpConn::do_publishing()"></a>SrsRtmpConn::do_publishing()</h3><ul>
<li><code>rtrd-&gt;start()</code>启动推流接收数据协程。</li>
<li><code>SrsStatistic</code>统计相关。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::do_publishing</span><span class="params">(SrsLiveSource* source, SrsPublishRecvThread* rtrd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    SrsPithyPrint* pprint = SrsPithyPrint::<span class="built_in">create_rtmp_publish</span>();</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsPithyPrint, pprint);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// start isolate recv thread.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> Pass the callback here.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = rtrd-&gt;<span class="built_in">start</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: receive thread&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// initialize the publish timeout.</span></span><br><span class="line">    publish_1stpkt_timeout = _srs_config-&gt;<span class="built_in">get_publish_1stpkt_timeout</span>(req-&gt;vhost);</span><br><span class="line">    publish_normal_timeout = _srs_config-&gt;<span class="built_in">get_publish_normal_timeout</span>(req-&gt;vhost);</span><br><span class="line">    <span class="type">srs_utime_t</span> publish_kickoff_for_idle = _srs_config-&gt;<span class="built_in">get_publish_kickoff_for_idle</span>(req-&gt;vhost);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// set the sock options.</span></span><br><span class="line">    <span class="built_in">set_sock_options</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="type">bool</span> mr = _srs_config-&gt;<span class="built_in">get_mr_enabled</span>(req-&gt;vhost);</span><br><span class="line">        <span class="type">srs_utime_t</span> mr_sleep = _srs_config-&gt;<span class="built_in">get_mr_sleep</span>(req-&gt;vhost);</span><br><span class="line">        <span class="built_in">srs_trace</span>(<span class="string">&quot;start publish mr=%d/%d, p1stpt=%d, pnt=%d, tcp_nodelay=%d&quot;</span>, </span><br><span class="line">                  mr, <span class="built_in">srsu2msi</span>(mr_sleep), <span class="built_in">srsu2msi</span>(publish_1stpkt_timeout), </span><br><span class="line">                  <span class="built_in">srsu2msi</span>(publish_normal_timeout), tcp_nodelay);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">    ISrsApmSpan* span = _srs_apm-&gt;<span class="built_in">span</span>(<span class="string">&quot;publish-cycle&quot;</span>)-&gt;<span class="built_in">set_kind</span>(SrsApmKindProducer)-&gt;<span class="built_in">as_child</span>(span_client_)</span><br><span class="line">        -&gt;<span class="built_in">attr</span>(<span class="string">&quot;timeout&quot;</span>, <span class="built_in">srs_fmt</span>(<span class="string">&quot;%d&quot;</span>, <span class="built_in">srsu2msi</span>(publish_normal_timeout)))-&gt;<span class="built_in">end</span>();</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(ISrsApmSpan, span);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="type">int64_t</span> nb_msgs = <span class="number">0</span>;</span><br><span class="line">    <span class="type">uint64_t</span> nb_frames = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: thread quit&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Kick off the publisher when idle for a period of timeout.</span></span><br><span class="line">        <span class="keyword">if</span> (source-&gt;<span class="built_in">publisher_is_idle_for</span>(publish_kickoff_for_idle)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_KICKOFF_FOR_IDLE, <span class="string">&quot;kicked for idle, url=%s, timeout=%ds&quot;</span>, </span><br><span class="line">                                 req-&gt;tcUrl.<span class="built_in">c_str</span>(), <span class="built_in">srsu2si</span>(publish_kickoff_for_idle));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pprint-&gt;<span class="built_in">elapse</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// cond wait for timeout.</span></span><br><span class="line">        <span class="keyword">if</span> (nb_msgs == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// when not got msgs, wait for a larger timeout.</span></span><br><span class="line">            rtrd-&gt;<span class="built_in">wait</span>(publish_1stpkt_timeout);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            rtrd-&gt;<span class="built_in">wait</span>(publish_normal_timeout);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// check the thread error code.</span></span><br><span class="line">        <span class="keyword">if</span> ((err = rtrd-&gt;<span class="built_in">error_code</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: receive thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// when not got any messages, timeout.</span></span><br><span class="line">        <span class="keyword">if</span> (rtrd-&gt;<span class="built_in">nb_msgs</span>() &lt;= nb_msgs) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_SOCKET_TIMEOUT, <span class="string">&quot;rtmp: publish timeout %dms, nb_msgs=%d&quot;</span>,</span><br><span class="line">                nb_msgs? <span class="built_in">srsu2msi</span>(publish_normal_timeout) : <span class="built_in">srsu2msi</span>(publish_1stpkt_timeout), (<span class="type">int</span>)nb_msgs);</span><br><span class="line">        &#125;</span><br><span class="line">        nb_msgs = rtrd-&gt;<span class="built_in">nb_msgs</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Update the stat for video fps.</span></span><br><span class="line">        <span class="comment">// @remark https://github.com/ossrs/srs/issues/851</span></span><br><span class="line">        SrsStatistic* stat = SrsStatistic::<span class="built_in">instance</span>();</span><br><span class="line">        <span class="keyword">if</span> ((err = stat-&gt;<span class="built_in">on_video_frames</span>(req, (<span class="type">int</span>)(rtrd-&gt;<span class="built_in">nb_video_frames</span>() - nb_frames))) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: stat video frames&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        nb_frames = rtrd-&gt;<span class="built_in">nb_video_frames</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// reportable</span></span><br><span class="line">        <span class="keyword">if</span> (pprint-&gt;<span class="built_in">can_print</span>()) &#123;</span><br><span class="line">            kbps-&gt;<span class="built_in">sample</span>();</span><br><span class="line">            <span class="type">bool</span> mr = _srs_config-&gt;<span class="built_in">get_mr_enabled</span>(req-&gt;vhost);</span><br><span class="line">            <span class="type">srs_utime_t</span> mr_sleep = _srs_config-&gt;<span class="built_in">get_mr_sleep</span>(req-&gt;vhost);</span><br><span class="line">            <span class="built_in">srs_trace</span>(<span class="string">&quot;&lt;- &quot;</span> SRS_CONSTS_LOG_CLIENT_PUBLISH <span class="string">&quot; time=%d, okbps=%d,%d,%d, ikbps=%d,%d,%d, mr=%d/%d, p1stpt=%d, pnt=%d&quot;</span>,</span><br><span class="line">                (<span class="type">int</span>)pprint-&gt;<span class="built_in">age</span>(), kbps-&gt;<span class="built_in">get_send_kbps</span>(), kbps-&gt;<span class="built_in">get_send_kbps_30s</span>(), kbps-&gt;<span class="built_in">get_send_kbps_5m</span>(),</span><br><span class="line">                kbps-&gt;<span class="built_in">get_recv_kbps</span>(), kbps-&gt;<span class="built_in">get_recv_kbps_30s</span>(), kbps-&gt;<span class="built_in">get_recv_kbps_5m</span>(), mr, <span class="built_in">srsu2msi</span>(mr_sleep),</span><br><span class="line">                <span class="built_in">srsu2msi</span>(publish_1stpkt_timeout), <span class="built_in">srsu2msi</span>(publish_normal_timeout));</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Do not use pithy print for frame span.</span></span><br><span class="line">            ISrsApmSpan* sample = _srs_apm-&gt;<span class="built_in">span</span>(<span class="string">&quot;publish-frame&quot;</span>)-&gt;<span class="built_in">set_kind</span>(SrsApmKindConsumer)-&gt;<span class="built_in">as_child</span>(span)</span><br><span class="line">                -&gt;<span class="built_in">attr</span>(<span class="string">&quot;msgs&quot;</span>, <span class="built_in">srs_fmt</span>(<span class="string">&quot;%&quot;</span> PRId64, nb_frames))-&gt;<span class="built_in">attr</span>(<span class="string">&quot;kbps&quot;</span>, <span class="built_in">srs_fmt</span>(<span class="string">&quot;%d&quot;</span>, kbps-&gt;<span class="built_in">get_recv_kbps_30s</span>()));</span><br><span class="line">            <span class="built_in">srs_freep</span>(sample);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RTMP数据接收协程"><a href="#RTMP数据接收协程" class="headerlink" title="RTMP数据接收协程"></a>RTMP数据接收协程</h2><ul>
<li>断点：<code>b SrsLiveSource::on_video_imp(SrsSharedPtrMessage*)</code>，查看堆栈。</li>
</ul>
<img src="/2023/10/29/SRS-RTMP/断点SrsLiveSource-on_video_imp.png" alt="断点SrsLiveSource-on_video_imp" style="zoom:50%;">

<h3 id="SrsPublishRecvThread-start"><a href="#SrsPublishRecvThread-start" class="headerlink" title="SrsPublishRecvThread::start()"></a>SrsPublishRecvThread::start()</h3><ul>
<li>启动接收协程，协程函数<code>SrsRecvThread::do_cycle()</code>。</li>
<li><code>pumper-&gt;consume()</code>，具体处理数据。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsPublishRecvThread::start</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = trd.<span class="built_in">start</span>()) != srs_success) &#123;</span><br><span class="line">        err = <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;publish recv thread&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ncid = cid = trd.<span class="built_in">cid</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SrsRecvThread-do-cycle"><a href="#SrsRecvThread-do-cycle" class="headerlink" title="SrsRecvThread::do_cycle()"></a>SrsRecvThread::do_cycle()</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRecvThread::do_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When the pumper is interrupted, wait then retry.</span></span><br><span class="line">        <span class="keyword">if</span> (pumper-&gt;<span class="built_in">interrupted</span>()) &#123;</span><br><span class="line">            <span class="built_in">srs_usleep</span>(timeout);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        SrsCommonMessage* msg = <span class="literal">NULL</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Process the received message.</span></span><br><span class="line">        <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">recv_message</span>(&amp;msg)) == srs_success) &#123;</span><br><span class="line">            err = pumper-&gt;<span class="built_in">consume</span>(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (err != srs_success) &#123;</span><br><span class="line">            <span class="comment">// Interrupt the receive thread for any error.</span></span><br><span class="line">            trd-&gt;<span class="built_in">interrupt</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Notify the pumper to quit for error.</span></span><br><span class="line">            pumper-&gt;<span class="built_in">interrupt</span>(err);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br></pre></td></tr></table></figure>

<h3 id="SrsPublishRecvThread-consume"><a href="#SrsPublishRecvThread-consume" class="headerlink" title="SrsPublishRecvThread::consume()"></a>SrsPublishRecvThread::consume()</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsPublishRecvThread::consume</span><span class="params">(SrsCommonMessage* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// when cid changed, change it.</span></span><br><span class="line">    <span class="keyword">if</span> (ncid.<span class="built_in">compare</span>(cid)) &#123;</span><br><span class="line">        _srs_context-&gt;<span class="built_in">set_id</span>(ncid);</span><br><span class="line">        cid = ncid;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    _nb_msgs++;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;header.<span class="built_in">is_video</span>()) &#123;</span><br><span class="line">        video_frames++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// log to show the time of recv thread.</span></span><br><span class="line">    <span class="built_in">srs_verbose</span>(<span class="string">&quot;recv thread now=%&quot;</span> PRId64 <span class="string">&quot;us, got msg time=%&quot;</span> PRId64 <span class="string">&quot;ms, size=%d&quot;</span>,</span><br><span class="line">                <span class="built_in">srs_update_system_time</span>(), msg-&gt;header.timestamp, msg-&gt;size);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// the rtmp connection will handle this message</span></span><br><span class="line">    err = _conn-&gt;<span class="built_in">handle_publish_message</span>(_source, msg);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// must always free it,</span></span><br><span class="line">    <span class="comment">// the source will copy it if need to use.</span></span><br><span class="line">    <span class="built_in">srs_freep</span>(msg);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (err != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;handle publish message&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Yield to another coroutines.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/2194#issuecomment-777463768</span></span><br><span class="line">    <span class="keyword">if</span> (++nn_msgs_for_yield_ &gt;= <span class="number">15</span>) &#123;</span><br><span class="line">        nn_msgs_for_yield_ = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">srs_thread_yield</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SrsRtmpConn-handle-publish-message"><a href="#SrsRtmpConn-handle-publish-message" class="headerlink" title="SrsRtmpConn::handle_publish_message()"></a>SrsRtmpConn::handle_publish_message()</h3><ul>
<li><code>process_publish_message()</code>用于处理媒体数据。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::handle_publish_message</span><span class="params">(SrsLiveSource* source, SrsCommonMessage* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// process publish event.</span></span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;header.<span class="built_in">is_amf0_command</span>() || msg-&gt;header.<span class="built_in">is_amf3_command</span>()) &#123;</span><br><span class="line">        SrsPacket* pkt = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">decode_message</span>(msg, &amp;pkt)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: decode message&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(SrsPacket, pkt);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// for flash, any packet is republish.</span></span><br><span class="line">        <span class="keyword">if</span> (info-&gt;type == SrsRtmpConnFlashPublish) &#123;</span><br><span class="line">            <span class="comment">// flash unpublish.</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> maybe need to support republish.</span></span><br><span class="line">            <span class="built_in">srs_trace</span>(<span class="string">&quot;flash flash publish finished.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_CONTROL_REPUBLISH, <span class="string">&quot;rtmp: republish&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// for fmle, drop others except the fmle start packet.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">dynamic_cast</span>&lt;SrsFMLEStartPacket*&gt;(pkt)) &#123;</span><br><span class="line">            SrsFMLEStartPacket* unpublish = <span class="built_in">dynamic_cast</span>&lt;SrsFMLEStartPacket*&gt;(pkt);</span><br><span class="line">            <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">fmle_unpublish</span>(info-&gt;res-&gt;stream_id, unpublish-&gt;transaction_id)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: republish&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_CONTROL_REPUBLISH, <span class="string">&quot;rtmp: republish&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">srs_trace</span>(<span class="string">&quot;fmle ignore AMF0/AMF3 command message.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// video, audio, data message</span></span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">process_publish_message</span>(source, msg)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: consume message&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SrsLiveSource-on-video"><a href="#SrsLiveSource-on-video" class="headerlink" title="SrsLiveSource::on_video()"></a>SrsLiveSource::on_video()</h3><ul>
<li>以视频处理为例。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsLiveSource::on_video</span><span class="params">(SrsCommonMessage* shared_video)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Detect where stream is monotonically increasing.</span></span><br><span class="line">    <span class="keyword">if</span> (!mix_correct &amp;&amp; is_monotonically_increase) &#123;</span><br><span class="line">        <span class="keyword">if</span> (last_packet_time &gt; <span class="number">0</span> &amp;&amp; shared_video-&gt;header.timestamp &lt; last_packet_time) &#123;</span><br><span class="line">            is_monotonically_increase = <span class="literal">false</span>;</span><br><span class="line">            <span class="built_in">srs_warn</span>(<span class="string">&quot;VIDEO: Timestamp %&quot;</span> PRId64 <span class="string">&quot;=&gt;%&quot;</span> PRId64 <span class="string">&quot;, may need mix_correct.&quot;</span>,</span><br><span class="line">                     last_packet_time, shared_video-&gt;header.timestamp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    last_packet_time = shared_video-&gt;header.timestamp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// drop any unknown header video.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/421</span></span><br><span class="line">    <span class="keyword">if</span> (!SrsFlvVideo::<span class="built_in">acceptable</span>(shared_video-&gt;payload, shared_video-&gt;size)) &#123;</span><br><span class="line">        <span class="type">char</span> b0 = <span class="number">0x00</span>;</span><br><span class="line">        <span class="keyword">if</span> (shared_video-&gt;size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            b0 = shared_video-&gt;payload[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">srs_warn</span>(<span class="string">&quot;drop unknown header video, size=%d, bytes[0]=%#x&quot;</span>, shared_video-&gt;size, b0);</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// convert shared_video to msg, user should not use shared_video again.</span></span><br><span class="line">    <span class="comment">// the payload is transfer to msg, and set to NULL in shared_video.</span></span><br><span class="line">    SrsSharedPtrMessage msg;</span><br><span class="line">    <span class="keyword">if</span> ((err = msg.<span class="built_in">create</span>(shared_video)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;create message&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">on_frame</span>(&amp;msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SrsLiveSource-on-frame"><a href="#SrsLiveSource-on-frame" class="headerlink" title="SrsLiveSource::on_frame()"></a>SrsLiveSource::on_frame()</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsLiveSource::on_frame</span><span class="params">(SrsSharedPtrMessage* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// directly process the audio message.</span></span><br><span class="line">    <span class="keyword">if</span> (!mix_correct) &#123;</span><br><span class="line">        <span class="keyword">if</span> (msg-&gt;<span class="built_in">is_audio</span>()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">on_audio_imp</span>(msg);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">on_video_imp</span>(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// insert msg to the queue.</span></span><br><span class="line">    mix_queue-&gt;<span class="built_in">push</span>(msg-&gt;<span class="built_in">copy</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// fetch someone from mix queue.</span></span><br><span class="line">    SrsSharedPtrMessage* m = mix_queue-&gt;<span class="built_in">pop</span>();</span><br><span class="line">    <span class="keyword">if</span> (!m) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// consume the monotonically increase message.</span></span><br><span class="line">    <span class="keyword">if</span> (m-&gt;<span class="built_in">is_audio</span>()) &#123;</span><br><span class="line">        err = <span class="built_in">on_audio_imp</span>(m);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        err = <span class="built_in">on_video_imp</span>(m);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">srs_freep</span>(m);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SrsLiveSource-on-video-imp"><a href="#SrsLiveSource-on-video-imp" class="headerlink" title="SrsLiveSource::on_video_imp()"></a>SrsLiveSource::on_video_imp()</h3><ul>
<li><code>consumer-&gt;enqueue()</code>拷贝数据给拉流消费者。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsLiveSource::on_video_imp</span><span class="params">(SrsSharedPtrMessage* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> is_sequence_header = SrsFlvVideo::<span class="built_in">sh</span>(msg-&gt;payload, msg-&gt;size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// user can disable the sps parse to workaround when parse sps failed.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/474</span></span><br><span class="line">    <span class="keyword">if</span> (is_sequence_header) &#123;</span><br><span class="line">        format_-&gt;avc_parse_sps = _srs_config-&gt;<span class="built_in">get_parse_sps</span>(req-&gt;vhost);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((err = format_-&gt;<span class="built_in">on_video</span>(msg)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;format consume video&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Ignore if no format-&gt;vcodec, it means the codec is not parsed, or unsupport/unknown codec</span></span><br><span class="line">    <span class="comment">// such as H.263 codec</span></span><br><span class="line">    <span class="keyword">if</span> (!format_-&gt;vcodec) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// whether consumer should drop for the duplicated sequence header.</span></span><br><span class="line">    <span class="type">bool</span> drop_for_reduce = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (is_sequence_header &amp;&amp; meta-&gt;<span class="built_in">previous_vsh</span>() &amp;&amp; _srs_config-&gt;<span class="built_in">get_reduce_sequence_header</span>(req-&gt;vhost)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (meta-&gt;<span class="built_in">previous_vsh</span>()-&gt;size == msg-&gt;size) &#123;</span><br><span class="line">            drop_for_reduce = <span class="built_in">srs_bytes_equals</span>(meta-&gt;<span class="built_in">previous_vsh</span>()-&gt;payload, msg-&gt;payload, msg-&gt;size);</span><br><span class="line">            <span class="built_in">srs_warn</span>(<span class="string">&quot;drop for reduce sh video, size=%d&quot;</span>, msg-&gt;size);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cache the sequence header if h264</span></span><br><span class="line">    <span class="comment">// donot cache the sequence header to gop_cache, return here.</span></span><br><span class="line">    <span class="keyword">if</span> (is_sequence_header &amp;&amp; (err = meta-&gt;<span class="built_in">update_vsh</span>(msg)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;meta update video&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Copy to hub to all utilities.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = hub-&gt;<span class="built_in">on_video</span>(msg, is_sequence_header)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hub consume video&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// For bridge to consume the message.</span></span><br><span class="line">    <span class="keyword">if</span> (bridge_ &amp;&amp; (err = bridge_-&gt;<span class="built_in">on_frame</span>(msg)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;bridge consume video&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// copy to all consumer</span></span><br><span class="line">    <span class="keyword">if</span> (!drop_for_reduce) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; (<span class="type">int</span>)consumers.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            SrsLiveConsumer* consumer = consumers.<span class="built_in">at</span>(i);</span><br><span class="line">            <span class="keyword">if</span> ((err = consumer-&gt;<span class="built_in">enqueue</span>(msg, atc, jitter_algorithm)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;consume video&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// when sequence header, donot push to gop cache and adjust the timestamp.</span></span><br><span class="line">    <span class="keyword">if</span> (is_sequence_header) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cache the last gop packets</span></span><br><span class="line">    <span class="keyword">if</span> ((err = gop_cache-&gt;<span class="built_in">cache</span>(msg)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;gop cache consume vdieo&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if atc, update the sequence header to abs time.</span></span><br><span class="line">    <span class="keyword">if</span> (atc) &#123;</span><br><span class="line">        <span class="keyword">if</span> (meta-&gt;<span class="built_in">vsh</span>()) &#123;</span><br><span class="line">            meta-&gt;<span class="built_in">vsh</span>()-&gt;timestamp = msg-&gt;timestamp;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (meta-&gt;<span class="built_in">data</span>()) &#123;</span><br><span class="line">            meta-&gt;<span class="built_in">data</span>()-&gt;timestamp = msg-&gt;timestamp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="RTMP拉流端"><a href="#RTMP拉流端" class="headerlink" title="RTMP拉流端"></a>RTMP拉流端</h1><h2 id="SrsRtmpConn-playing"><a href="#SrsRtmpConn-playing" class="headerlink" title="SrsRtmpConn::playing()"></a>SrsRtmpConn::playing()</h2><ul>
<li><code>SrsQueueRecvThread</code>接收拉流端命令。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::playing</span><span class="params">(SrsLiveSource* source)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Check page referer of player.</span></span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    <span class="keyword">if</span> (_srs_config-&gt;<span class="built_in">get_refer_enabled</span>(req-&gt;vhost)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = refer-&gt;<span class="built_in">check</span>(req-&gt;pageUrl, _srs_config-&gt;<span class="built_in">get_refer_play</span>(req-&gt;vhost))) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: referer check&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// When origin cluster enabled, try to redirect to the origin which is active.</span></span><br><span class="line">    <span class="comment">// A active origin is a server which is delivering stream.</span></span><br><span class="line">    <span class="keyword">if</span> (!info-&gt;edge &amp;&amp; _srs_config-&gt;<span class="built_in">get_vhost_origin_cluster</span>(req-&gt;vhost) &amp;&amp; source-&gt;<span class="built_in">inactive</span>()) &#123;</span><br><span class="line">        vector&lt;string&gt; coworkers = _srs_config-&gt;<span class="built_in">get_vhost_coworkers</span>(req-&gt;vhost);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; (<span class="type">int</span>)coworkers.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> User may config the server itself as coworker, we must identify and ignore it.</span></span><br><span class="line">            string host; <span class="type">int</span> port = <span class="number">0</span>; string coworker = coworkers.<span class="built_in">at</span>(i);</span><br><span class="line"></span><br><span class="line">            string url = <span class="string">&quot;http://&quot;</span> + coworker + <span class="string">&quot;/api/v1/clusters?&quot;</span></span><br><span class="line">                + <span class="string">&quot;vhost=&quot;</span> + req-&gt;vhost + <span class="string">&quot;&amp;ip=&quot;</span> + req-&gt;host + <span class="string">&quot;&amp;app=&quot;</span> + req-&gt;app + <span class="string">&quot;&amp;stream=&quot;</span> + req-&gt;stream</span><br><span class="line">                + <span class="string">&quot;&amp;coworker=&quot;</span> + coworker;</span><br><span class="line">            <span class="keyword">if</span> ((err = SrsHttpHooks::<span class="built_in">discover_co_workers</span>(url, host, port)) != srs_success) &#123;</span><br><span class="line">                <span class="comment">// If failed to discovery stream in this coworker, we should request the next one util the last.</span></span><br><span class="line">                <span class="comment">// @see https://github.com/ossrs/srs/issues/1223</span></span><br><span class="line">                <span class="keyword">if</span> (i &lt; (<span class="type">int</span>)coworkers.<span class="built_in">size</span>() - <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;discover coworkers, url=%s&quot;</span>, url.<span class="built_in">c_str</span>());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            string rurl = <span class="built_in">srs_generate_rtmp_url</span>(host, port, req-&gt;host, req-&gt;vhost, req-&gt;app, req-&gt;stream, req-&gt;param);</span><br><span class="line">            <span class="built_in">srs_trace</span>(<span class="string">&quot;rtmp: redirect in cluster, from=%s:%d, target=%s:%d, url=%s, rurl=%s&quot;</span>,</span><br><span class="line">                req-&gt;host.<span class="built_in">c_str</span>(), req-&gt;port, host.<span class="built_in">c_str</span>(), port, url.<span class="built_in">c_str</span>(), rurl.<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Ignore if host or port is invalid.</span></span><br><span class="line">            <span class="keyword">if</span> (host.<span class="built_in">empty</span>() || port == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="type">bool</span> accepted = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">redirect</span>(req, rurl, accepted)) != srs_success) &#123;</span><br><span class="line">                <span class="built_in">srs_error_reset</span>(err);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_CONTROL_REDIRECT, <span class="string">&quot;redirected&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_OCLUSTER_REDIRECT, <span class="string">&quot;no origin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Set the socket options for transport.</span></span><br><span class="line">    <span class="built_in">set_sock_options</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Create a consumer of source.</span></span><br><span class="line">    SrsLiveConsumer* consumer = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsLiveConsumer, consumer);</span><br><span class="line">    <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">create_consumer</span>(consumer)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: create consumer&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">consumer_dumps</span>(consumer)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: dumps consumer&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Use receiving thread to receive packets from peer.</span></span><br><span class="line">    <span class="function">SrsQueueRecvThread <span class="title">trd</span><span class="params">(consumer, rtmp, SRS_PERF_MW_SLEEP, _srs_context-&gt;get_id())</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = trd.<span class="built_in">start</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: start receive thread&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Deliver packets to peer.</span></span><br><span class="line">    wakable = consumer;</span><br><span class="line">    err = <span class="built_in">do_playing</span>(source, consumer, &amp;trd);</span><br><span class="line">    wakable = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    trd.<span class="built_in">stop</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Drop all packets in receiving thread.</span></span><br><span class="line">    <span class="keyword">if</span> (!trd.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="built_in">srs_warn</span>(<span class="string">&quot;drop the received %d messages&quot;</span>, trd.<span class="built_in">size</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>process_play_control_msg()</code>处理拉流端对应的客户端命令。</li>
<li><code>consumer-&gt;dump_packets()</code>获取音视频数据。</li>
<li><code>rtmp-&gt;send_and_free_messages()</code>发送音视频数据给客户端。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::do_playing</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    SrsLiveSource* source, SrsLiveConsumer* consumer, SrsQueueRecvThread* rtrd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    <span class="built_in">srs_assert</span>(req);</span><br><span class="line">    <span class="built_in">srs_assert</span>(consumer);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// initialize other components</span></span><br><span class="line">    SrsPithyPrint* pprint = SrsPithyPrint::<span class="built_in">create_rtmp_play</span>();</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsPithyPrint, pprint);</span><br><span class="line">    </span><br><span class="line">    <span class="function">SrsMessageArray <span class="title">msgs</span><span class="params">(SRS_PERF_MW_MSGS)</span></span>;</span><br><span class="line">    <span class="type">bool</span> user_specified_duration_to_stop = (req-&gt;duration &gt; <span class="number">0</span>);</span><br><span class="line">    <span class="type">int64_t</span> starttime = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// setup the realtime.</span></span><br><span class="line">    realtime = _srs_config-&gt;<span class="built_in">get_realtime_enabled</span>(req-&gt;vhost);</span><br><span class="line">    <span class="comment">// setup the mw config.</span></span><br><span class="line">    <span class="comment">// when mw_sleep changed, resize the socket send buffer.</span></span><br><span class="line">    mw_msgs = _srs_config-&gt;<span class="built_in">get_mw_msgs</span>(req-&gt;vhost, realtime);</span><br><span class="line">    mw_sleep = _srs_config-&gt;<span class="built_in">get_mw_sleep</span>(req-&gt;vhost);</span><br><span class="line">    skt-&gt;<span class="built_in">set_socket_buffer</span>(mw_sleep);</span><br><span class="line">    <span class="comment">// initialize the send_min_interval</span></span><br><span class="line">    send_min_interval = _srs_config-&gt;<span class="built_in">get_send_min_interval</span>(req-&gt;vhost);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;start play smi=%dms, mw_sleep=%d, mw_msgs=%d, realtime=%d, tcp_nodelay=%d&quot;</span>,</span><br><span class="line">        <span class="built_in">srsu2msi</span>(send_min_interval), <span class="built_in">srsu2msi</span>(mw_sleep), mw_msgs, realtime, tcp_nodelay);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">    ISrsApmSpan* span = _srs_apm-&gt;<span class="built_in">span</span>(<span class="string">&quot;play-cycle&quot;</span>)-&gt;<span class="built_in">set_kind</span>(SrsApmKindProducer)-&gt;<span class="built_in">as_child</span>(span_client_)</span><br><span class="line">        -&gt;<span class="built_in">attr</span>(<span class="string">&quot;realtime&quot;</span>, <span class="built_in">srs_fmt</span>(<span class="string">&quot;%d&quot;</span>, realtime))-&gt;<span class="built_in">end</span>();</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(ISrsApmSpan, span);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">// when source is set to expired, disconnect it.</span></span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: thread quit&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// collect elapse for pithy print.</span></span><br><span class="line">        pprint-&gt;<span class="built_in">elapse</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// to use isolate thread to recv, can improve about 33% performance.</span></span><br><span class="line">        <span class="keyword">while</span> (!rtrd-&gt;<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            SrsCommonMessage* msg = rtrd-&gt;<span class="built_in">pump</span>();</span><br><span class="line">            <span class="keyword">if</span> ((err = <span class="built_in">process_play_control_msg</span>(consumer, msg)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: play control message&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// quit when recv thread error.</span></span><br><span class="line">        <span class="keyword">if</span> ((err = rtrd-&gt;<span class="built_in">error_code</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: recv thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_PERF_QUEUE_COND_WAIT</span></span><br><span class="line">        <span class="comment">// wait for message to incoming.</span></span><br><span class="line">        <span class="comment">// @see https://github.com/ossrs/srs/issues/257</span></span><br><span class="line">        consumer-&gt;<span class="built_in">wait</span>(mw_msgs, mw_sleep);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// get messages from consumer.</span></span><br><span class="line">        <span class="comment">// each msg in msgs.msgs must be free, for the SrsMessageArray never free them.</span></span><br><span class="line">        <span class="comment">// @remark when enable send_min_interval, only fetch one message a time.</span></span><br><span class="line">        <span class="type">int</span> count = (send_min_interval &gt; <span class="number">0</span>)? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = consumer-&gt;<span class="built_in">dump_packets</span>(&amp;msgs, count)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: consumer dump packets&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// reportable</span></span><br><span class="line">        <span class="keyword">if</span> (pprint-&gt;<span class="built_in">can_print</span>()) &#123;</span><br><span class="line">            kbps-&gt;<span class="built_in">sample</span>();</span><br><span class="line">            <span class="built_in">srs_trace</span>(<span class="string">&quot;-&gt; &quot;</span> SRS_CONSTS_LOG_PLAY <span class="string">&quot; time=%d, msgs=%d, okbps=%d,%d,%d, ikbps=%d,%d,%d, mw=%d/%d&quot;</span>,</span><br><span class="line">                (<span class="type">int</span>)pprint-&gt;<span class="built_in">age</span>(), count, kbps-&gt;<span class="built_in">get_send_kbps</span>(), kbps-&gt;<span class="built_in">get_send_kbps_30s</span>(), kbps-&gt;<span class="built_in">get_send_kbps_5m</span>(),</span><br><span class="line">                kbps-&gt;<span class="built_in">get_recv_kbps</span>(), kbps-&gt;<span class="built_in">get_recv_kbps_30s</span>(), kbps-&gt;<span class="built_in">get_recv_kbps_5m</span>(), <span class="built_in">srsu2msi</span>(mw_sleep), mw_msgs);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Do not use pithy print for frame span.</span></span><br><span class="line">            ISrsApmSpan* sample = _srs_apm-&gt;<span class="built_in">span</span>(<span class="string">&quot;play-frame&quot;</span>)-&gt;<span class="built_in">set_kind</span>(SrsApmKindConsumer)-&gt;<span class="built_in">as_child</span>(span)</span><br><span class="line">                -&gt;<span class="built_in">attr</span>(<span class="string">&quot;msgs&quot;</span>, <span class="built_in">srs_fmt</span>(<span class="string">&quot;%d&quot;</span>, count))-&gt;<span class="built_in">attr</span>(<span class="string">&quot;kbps&quot;</span>, <span class="built_in">srs_fmt</span>(<span class="string">&quot;%d&quot;</span>, kbps-&gt;<span class="built_in">get_send_kbps_30s</span>()));</span><br><span class="line">            <span class="built_in">srs_freep</span>(sample);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> SRS_PERF_QUEUE_COND_WAIT</span></span><br><span class="line">            <span class="built_in">srs_usleep</span>(mw_sleep);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            <span class="comment">// ignore when nothing got.</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// only when user specifies the duration,</span></span><br><span class="line">        <span class="comment">// we start to collect the durations for each message.</span></span><br><span class="line">        <span class="keyword">if</span> (user_specified_duration_to_stop) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">                SrsSharedPtrMessage* msg = msgs.msgs[i];</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// foreach msg, collect the duration.</span></span><br><span class="line">                <span class="comment">// @remark: never use msg when sent it, for the protocol sdk will free it.</span></span><br><span class="line">                <span class="keyword">if</span> (starttime &lt; <span class="number">0</span> || starttime &gt; msg-&gt;timestamp) &#123;</span><br><span class="line">                    starttime = msg-&gt;timestamp;</span><br><span class="line">                &#125;</span><br><span class="line">                duration += (msg-&gt;timestamp - starttime) * SRS_UTIME_MILLISECONDS;</span><br><span class="line">                starttime = msg-&gt;timestamp;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// sendout messages, all messages are freed by send_and_free_messages().</span></span><br><span class="line">        <span class="comment">// no need to assert msg, for the rtmp will assert it.</span></span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span> &amp;&amp; (err = rtmp-&gt;<span class="built_in">send_and_free_messages</span>(msgs.msgs, count, info-&gt;res-&gt;stream_id)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: send %d messages&quot;</span>, count);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// if duration specified, and exceed it, stop play live.</span></span><br><span class="line">        <span class="comment">// @see: https://github.com/ossrs/srs/issues/45</span></span><br><span class="line">        <span class="keyword">if</span> (user_specified_duration_to_stop) &#123;</span><br><span class="line">            <span class="keyword">if</span> (duration &gt;= req-&gt;duration) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_RTMP_DURATION_EXCEED, <span class="string">&quot;rtmp: time %d up %d&quot;</span>, <span class="built_in">srsu2msi</span>(duration), <span class="built_in">srsu2msi</span>(req-&gt;duration));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// apply the minimal interval for delivery stream in srs_utime_t.</span></span><br><span class="line">        <span class="keyword">if</span> (send_min_interval &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">srs_usleep</span>(send_min_interval);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Yield to another coroutines.</span></span><br><span class="line">        <span class="comment">// @see https://github.com/ossrs/srs/issues/2194#issuecomment-777437476</span></span><br><span class="line">        <span class="built_in">srs_thread_yield</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SrsQueueRecvThread-start"><a href="#SrsQueueRecvThread-start" class="headerlink" title="SrsQueueRecvThread::start()"></a>SrsQueueRecvThread::start()</h2><ul>
<li>启动接收协程，协程函数<code>SrsRecvThread::do_cycle()</code>。</li>
<li><code>pumper-&gt;consume()</code>，具体处理数据。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsQueueRecvThread::start</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = trd.<span class="built_in">start</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;queue recv thread&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRecvThread::do_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When the pumper is interrupted, wait then retry.</span></span><br><span class="line">        <span class="keyword">if</span> (pumper-&gt;<span class="built_in">interrupted</span>()) &#123;</span><br><span class="line">            <span class="built_in">srs_usleep</span>(timeout);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        SrsCommonMessage* msg = <span class="literal">NULL</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Process the received message.</span></span><br><span class="line">        <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">recv_message</span>(&amp;msg)) == srs_success) &#123;</span><br><span class="line">            err = pumper-&gt;<span class="built_in">consume</span>(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (err != srs_success) &#123;</span><br><span class="line">            <span class="comment">// Interrupt the receive thread for any error.</span></span><br><span class="line">            trd-&gt;<span class="built_in">interrupt</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Notify the pumper to quit for error.</span></span><br><span class="line">            pumper-&gt;<span class="built_in">interrupt</span>(err);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SrsQueueRecvThread-consume"><a href="#SrsQueueRecvThread-consume" class="headerlink" title="SrsQueueRecvThread::consume()"></a>SrsQueueRecvThread::consume()</h2><ul>
<li>接收数据后存放到队列中，具体<code>SrsRtmpConn::process_play_control_msg</code>处理。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsQueueRecvThread::consume</span><span class="params">(SrsCommonMessage* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// put into queue, the send thread will get and process it,</span></span><br><span class="line">    <span class="comment">// @see SrsRtmpConn::process_play_control_msg</span></span><br><span class="line">    queue.<span class="built_in">push_back</span>(msg);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_PERF_QUEUE_COND_WAIT</span></span><br><span class="line">    <span class="keyword">if</span> (_consumer) &#123;</span><br><span class="line">        _consumer-&gt;<span class="built_in">wakeup</span>();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> srs_success;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/10/28/SRS%E9%85%8D%E7%BD%AE%E6%94%AF%E6%8C%81WebRTC/" rel="prev" title="SRS配置支持WebRTC">
                  <i class="fa fa-angle-left"></i> SRS配置支持WebRTC
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/10/30/SRS%E9%85%8D%E7%BD%AE%E5%BD%B1%E5%93%8D%E5%BB%B6%E6%97%B6/" rel="next" title="SRS配置影响延时">
                  SRS配置影响延时 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Fang</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"neutral","dark":"neutral"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.3.0/mermaid.min.js","integrity":"sha256-9y71g5Lz/KLsHjB8uXwnkuWDtAMDSzD/HdIbqhJfTAI="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





</body>
</html>
