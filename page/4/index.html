<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CPT+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"fang0407.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="NOTE">
<meta property="og:url" content="https://fang0407.github.io/page/4/index.html">
<meta property="og:site_name" content="NOTE">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Fang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://fang0407.github.io/page/4/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/4/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>NOTE</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">NOTE</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Fang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">85</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/10/30/SRS%E9%85%8D%E7%BD%AE%E5%BD%B1%E5%93%8D%E5%BB%B6%E6%97%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/30/SRS%E9%85%8D%E7%BD%AE%E5%BD%B1%E5%93%8D%E5%BB%B6%E6%97%B6/" class="post-title-link" itemprop="url">SRS配置影响延时</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-10-30 19:05:57" itemprop="dateCreated datePublished" datetime="2023-10-30T19:05:57+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-12-30 22:37:19" itemprop="dateModified" datetime="2023-12-30T22:37:19+08:00">2023-12-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SRS/" itemprop="url" rel="index"><span itemprop="name">SRS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>音视频传输过程中不同端都会产生延迟，比如推流端可能由于编码会产生延迟，拉流端可能会缓存数据产生延迟，流媒体服务器转发过程中也会缓存数据产生延迟，本文只要考虑流媒体SRS服务器产生的延迟可能。</p>
<h1 id="低延时配置"><a href="#低延时配置" class="headerlink" title="低延时配置"></a>低延时配置</h1><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># the listen ports, split by space.</span></span><br><span class="line"><span class="attribute">listen</span>              <span class="number">1935</span>;</span><br><span class="line"><span class="attribute">vhost</span> __defaultVhost__ &#123;</span><br><span class="line">    <span class="attribute">tcp_nodelay</span>     <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">min_latency</span>     <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="section">play</span> &#123;</span><br><span class="line">        <span class="attribute">gop_cache</span>       <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">queue_length</span>    <span class="number">10</span>;</span><br><span class="line">        <span class="attribute">mw_latency</span>      <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">publish</span> &#123;</span><br><span class="line">        <span class="attribute">mr</span> <span class="literal">off</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Min-Latency"><a href="#Min-Latency" class="headerlink" title="Min-Latency"></a>Min-Latency</h1><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>当开启最低延迟配置后，SRS会禁用mr(merged-read)，并且在consumer队列中使用超时等待，大约每收到1-2个视频包就发送给客户端，达到最低延迟目标。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">vhost</span> mrw.srs.com &#123;</span><br><span class="line">    <span class="comment"># whether enable min delay mode for vhost.</span></span><br><span class="line">    <span class="comment"># for min latence mode:</span></span><br><span class="line">    <span class="comment"># 1. disable the publish.mr for vhost.</span></span><br><span class="line">    <span class="comment"># 2. use timeout for cond wait for consumer queue.</span></span><br><span class="line">    <span class="comment"># @see https://github.com/ossrs/srs/issues/257</span></span><br><span class="line">    <span class="comment"># default: off</span></span><br><span class="line">    <span class="attribute">min_latency</span>     <span class="literal">off</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>对于RTC默认开启，否则关闭。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">SrsConfig::get_realtime_enabled</span><span class="params">(string vhost, <span class="type">bool</span> is_rtc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_rtc) &#123;</span><br><span class="line">        <span class="built_in">SRS_OVERWRITE_BY_ENV_BOOL2</span>(<span class="string">&quot;srs.vhost.min_latency&quot;</span>); <span class="comment">// SRS_VHOST_MIN_LATENCY</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">SRS_OVERWRITE_BY_ENV_BOOL</span>(<span class="string">&quot;srs.vhost.min_latency&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> <span class="type">bool</span> SYS_DEFAULT = SRS_PERF_MIN_LATENCY_ENABLED;</span><br><span class="line">    <span class="type">static</span> <span class="type">bool</span> RTC_DEFAULT = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> DEFAULT = is_rtc? RTC_DEFAULT : SYS_DEFAULT;</span><br><span class="line"></span><br><span class="line">    SrsConfDirective* conf = <span class="built_in">get_vhost</span>(vhost);</span><br><span class="line">    <span class="keyword">if</span> (!conf) &#123;</span><br><span class="line">        <span class="keyword">return</span> DEFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    conf = conf-&gt;<span class="built_in">get</span>(<span class="string">&quot;min_latency&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!conf || conf-&gt;<span class="built_in">arg0</span>().<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> DEFAULT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_rtc) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">SRS_CONF_PERFER_TRUE</span>(conf-&gt;<span class="built_in">arg0</span>());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">SRS_CONF_PERFER_FALSE</span>(conf-&gt;<span class="built_in">arg0</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Merged-Read"><a href="#Merged-Read" class="headerlink" title="Merged-Read"></a>Merged-Read</h1><h2 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h2><p>RTMP的Read效率非常低，需要先读一个字节，判断是哪个chunk，然后读取header，接着读取payload。因此上行支持的流的路数大约只有下行的1&#x2F;3，譬如SRS1.0支持下行2700上行只有1000，SRS2.0支持下行10000上行只有4500。</p>
<p>为了提高性能，SRS对于上行的read使用merged-read，即SRS在读写时一次读取N毫秒的数据，这个可以配置：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># the MR(merged-read) setting for publisher.</span></span><br><span class="line">vhost mrw.srs.com &#123;</span><br><span class="line">    publish &#123;</span><br><span class="line">        mr          on;</span><br><span class="line">        mr_latency  <span class="number">350</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也就是说，当开启merged-read之后，服务器的接收缓冲区至少会有latency毫秒的数据，延迟也就会有这么多毫秒。</p>
<p>若需要低延迟配置，关闭merged-read，服务器每次收到1个包就会解析。</p>
<h2 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h2><p>分别看下读取和使用配置字段的代码。</p>
<h3 id="读取配置"><a href="#读取配置" class="headerlink" title="读取配置"></a>读取配置</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">SrsPublishRecvThread::<span class="built_in">SrsPublishRecvThread</span>(SrsRtmpServer* rtmp_sdk, SrsRequest* _req,</span><br><span class="line">	<span class="type">int</span> mr_sock_fd, <span class="type">srs_utime_t</span> tm, SrsRtmpConn* conn, SrsLiveSource* source, SrsContextId parent_cid)</span><br><span class="line">    : <span class="built_in">trd</span>(<span class="keyword">this</span>, rtmp_sdk, tm, parent_cid)</span><br><span class="line">&#123;</span><br><span class="line">    rtmp = rtmp_sdk;</span><br><span class="line">    </span><br><span class="line">    _conn = conn;</span><br><span class="line">    _source = source;</span><br><span class="line"></span><br><span class="line">    nn_msgs_for_yield_ = <span class="number">0</span>;</span><br><span class="line">    recv_error = srs_success;</span><br><span class="line">    _nb_msgs = <span class="number">0</span>;</span><br><span class="line">    video_frames = <span class="number">0</span>;</span><br><span class="line">    error = <span class="built_in">srs_cond_new</span>();</span><br><span class="line"></span><br><span class="line">    req = _req;</span><br><span class="line">    mr_fd = mr_sock_fd;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// the mr settings,</span></span><br><span class="line">    mr = _srs_config-&gt;<span class="built_in">get_mr_enabled</span>(req-&gt;vhost);</span><br><span class="line">    mr_sleep = _srs_config-&gt;<span class="built_in">get_mr_sleep</span>(req-&gt;vhost);</span><br><span class="line">    </span><br><span class="line">    realtime = _srs_config-&gt;<span class="built_in">get_realtime_enabled</span>(req-&gt;vhost);</span><br><span class="line">    </span><br><span class="line">    _srs_config-&gt;<span class="built_in">subscribe</span>(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>默认下是关闭合并读。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">SrsConfig::get_mr_enabled</span><span class="params">(string vhost)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">SRS_OVERWRITE_BY_ENV_BOOL</span>(<span class="string">&quot;srs.vhost.publish.mr&quot;</span>); <span class="comment">// SRS_VHOST_PUBLISH_MR</span></span><br><span class="line"></span><br><span class="line">    SrsConfDirective* conf = <span class="built_in">get_vhost</span>(vhost);</span><br><span class="line">    <span class="keyword">if</span> (!conf) &#123;</span><br><span class="line">        <span class="keyword">return</span> SRS_PERF_MR_ENABLED; <span class="comment">//false</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    conf = conf-&gt;<span class="built_in">get</span>(<span class="string">&quot;publish&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!conf) &#123;</span><br><span class="line">        <span class="keyword">return</span> SRS_PERF_MR_ENABLED;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    conf = conf-&gt;<span class="built_in">get</span>(<span class="string">&quot;mr&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!conf || conf-&gt;<span class="built_in">arg0</span>().<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> SRS_PERF_MR_ENABLED;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">SRS_CONF_PERFER_FALSE</span>(conf-&gt;<span class="built_in">arg0</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>默认350ms。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_utime_t</span> <span class="title">SrsConfig::get_mr_sleep</span><span class="params">(string vhost)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">SRS_OVERWRITE_BY_ENV_MILLISECONDS</span>(<span class="string">&quot;srs.vhost.publish.mr_latency&quot;</span>); <span class="comment">// SRS_VHOST_PUBLISH_MR_LATENCY</span></span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> <span class="type">srs_utime_t</span> DEFAULT = SRS_PERF_MR_SLEEP;</span><br><span class="line"></span><br><span class="line">    SrsConfDirective* conf = <span class="built_in">get_vhost</span>(vhost);</span><br><span class="line">    <span class="keyword">if</span> (!conf) &#123;</span><br><span class="line">        <span class="keyword">return</span> DEFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    conf = conf-&gt;<span class="built_in">get</span>(<span class="string">&quot;publish&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!conf) &#123;</span><br><span class="line">        <span class="keyword">return</span> DEFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    conf = conf-&gt;<span class="built_in">get</span>(<span class="string">&quot;mr_latency&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!conf || conf-&gt;<span class="built_in">arg0</span>().<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> DEFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> (<span class="type">srs_utime_t</span>)(::<span class="built_in">atoi</span>(conf-&gt;<span class="built_in">arg0</span>().<span class="built_in">c_str</span>()) * SRS_UTIME_MILLISECONDS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用配置"><a href="#使用配置" class="headerlink" title="使用配置"></a>使用配置</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">SrsPublishRecvThread::on_start</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// we donot set the auto response to false,</span></span><br><span class="line">    <span class="comment">// for the main thread never send message.</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_PERF_MERGED_READ</span></span><br><span class="line">    <span class="keyword">if</span> (mr) &#123;</span><br><span class="line">        <span class="comment">// set underlayer buffer size</span></span><br><span class="line">        <span class="built_in">set_socket_buffer</span>(mr_sleep);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// disable the merge read</span></span><br><span class="line">        rtmp-&gt;<span class="built_in">set_merge_read</span>(<span class="literal">true</span>, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">SrsPublishRecvThread::on_read</span><span class="params">(<span class="type">ssize_t</span> nread)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mr || realtime) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (nread &lt; <span class="number">0</span> || mr_sleep &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * to improve read performance, merge some packets then read,</span></span><br><span class="line"><span class="comment">     * when it on and read small bytes, we sleep to wait more data.,</span></span><br><span class="line"><span class="comment">     * that is, we merge some data to read together.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (nread &lt; SRS_MR_SMALL_BYTES) &#123;</span><br><span class="line">        <span class="built_in">srs_usleep</span>(mr_sleep);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Merged-Write"><a href="#Merged-Write" class="headerlink" title="Merged-Write"></a>Merged-Write</h1><h2 id="配置-2"><a href="#配置-2" class="headerlink" title="配置"></a>配置</h2><p>SRS永远使用Merged-Write，即一次发送N毫秒的包给客户端。这个算法可以将RTMP下行的效率提升5倍左右，SRS1.0每次writev一个packet支持2700客户端，SRS2.0一次writev多个packet支持10000客户端。</p>
<p>用户可以配置merged-write一次写入的包的数目，建议不做修改：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># the MW(merged-write) settings for player.</span></span><br><span class="line"><span class="attribute">vhost</span> mrw.srs.com &#123;</span><br><span class="line">    <span class="comment"># for play client, both RTMP and other stream clients,</span></span><br><span class="line">    <span class="comment"># for instance, the HTTP FLV stream clients.</span></span><br><span class="line">    <span class="section">play</span> &#123;</span><br><span class="line">        <span class="comment"># set the MW(merged-write) latency in ms. </span></span><br><span class="line">        <span class="comment"># SRS always set mw on, so we just set the latency value.</span></span><br><span class="line">        <span class="comment"># the latency of stream &gt;= mw_latency + mr_latency</span></span><br><span class="line">        <span class="comment"># the value recomment is [300, 1800]</span></span><br><span class="line">        <span class="comment"># default: 350</span></span><br><span class="line">        <span class="attribute">mw_latency</span>      <span class="number">350</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>若需要极低延迟（损失较多性能），可以设置为100毫秒，SRS大约一次发送几个包。</p>
<h2 id="代码-2"><a href="#代码-2" class="headerlink" title="代码"></a>代码</h2><p>对于RTC合并写默认设置为0ms，否则默认设置为350ms。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_utime_t</span> <span class="title">SrsConfig::get_mw_sleep</span><span class="params">(string vhost, <span class="type">bool</span> is_rtc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">srs_getenv</span>(<span class="string">&quot;srs.vhost.play.mw_latency&quot;</span>).<span class="built_in">empty</span>()) &#123; <span class="comment">// SRS_VHOST_PLAY_MW_LATENCY</span></span><br><span class="line">        <span class="type">int</span> v = ::<span class="built_in">atoi</span>(<span class="built_in">srs_getenv</span>(<span class="string">&quot;srs.vhost.play.mw_latency&quot;</span>).<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="keyword">if</span> (is_rtc &amp;&amp; v &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">srs_warn</span>(<span class="string">&quot;For RTC, we ignore mw_latency&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (<span class="type">srs_utime_t</span>)(v * SRS_UTIME_MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> <span class="type">srs_utime_t</span> SYS_DEFAULT = SRS_PERF_MW_SLEEP;</span><br><span class="line">    <span class="type">static</span> <span class="type">srs_utime_t</span> RTC_DEFAULT = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">srs_utime_t</span> DEFAULT = is_rtc? RTC_DEFAULT : SYS_DEFAULT;</span><br><span class="line"></span><br><span class="line">    SrsConfDirective* conf = <span class="built_in">get_vhost</span>(vhost);</span><br><span class="line">    <span class="keyword">if</span> (!conf) &#123;</span><br><span class="line">        <span class="keyword">return</span> DEFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    conf = conf-&gt;<span class="built_in">get</span>(<span class="string">&quot;play&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!conf) &#123;</span><br><span class="line">        <span class="keyword">return</span> DEFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    conf = conf-&gt;<span class="built_in">get</span>(<span class="string">&quot;mw_latency&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!conf || conf-&gt;<span class="built_in">arg0</span>().<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> DEFAULT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> v = ::<span class="built_in">atoi</span>(conf-&gt;<span class="built_in">arg0</span>().<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">if</span> (is_rtc &amp;&amp; v &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">srs_warn</span>(<span class="string">&quot;For RTC, we ignore mw_latency&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> (<span class="type">srs_utime_t</span>)(v * SRS_UTIME_MILLISECONDS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于RTC默认是合并1个消息帧，如果开起<code>Min-Latency on</code>默认是0个消息帧，否则默认是8个消息帧。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">SrsConfig::get_mw_msgs</span><span class="params">(string vhost, <span class="type">bool</span> is_realtime, <span class="type">bool</span> is_rtc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">srs_getenv</span>(<span class="string">&quot;srs.vhost.play.mw_msgs&quot;</span>).<span class="built_in">empty</span>()) &#123; <span class="comment">// SRS_VHOST_PLAY_MW_MSGS</span></span><br><span class="line">        <span class="type">int</span> v = ::<span class="built_in">atoi</span>(<span class="built_in">srs_getenv</span>(<span class="string">&quot;srs.vhost.play.mw_msgs&quot;</span>).<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="keyword">if</span> (v &gt; SRS_PERF_MW_MSGS) &#123;</span><br><span class="line">            <span class="built_in">srs_warn</span>(<span class="string">&quot;reset mw_msgs %d to max %d&quot;</span>, v, SRS_PERF_MW_MSGS);</span><br><span class="line">            v = SRS_PERF_MW_MSGS;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> v;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> DEFAULT = SRS_PERF_MW_MIN_MSGS;</span><br><span class="line">    <span class="keyword">if</span> (is_rtc) &#123;</span><br><span class="line">        DEFAULT = SRS_PERF_MW_MIN_MSGS_FOR_RTC;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (is_realtime) &#123;</span><br><span class="line">        DEFAULT = SRS_PERF_MW_MIN_MSGS_REALTIME;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SrsConfDirective* conf = <span class="built_in">get_vhost</span>(vhost);</span><br><span class="line">    <span class="keyword">if</span> (!conf) &#123;</span><br><span class="line">        <span class="keyword">return</span> DEFAULT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    conf = conf-&gt;<span class="built_in">get</span>(<span class="string">&quot;play&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!conf) &#123;</span><br><span class="line">        <span class="keyword">return</span> DEFAULT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    conf = conf-&gt;<span class="built_in">get</span>(<span class="string">&quot;mw_msgs&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!conf || conf-&gt;<span class="built_in">arg0</span>().<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> DEFAULT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> v = ::<span class="built_in">atoi</span>(conf-&gt;<span class="built_in">arg0</span>().<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">if</span> (v &gt; SRS_PERF_MW_MSGS) &#123;</span><br><span class="line">        <span class="built_in">srs_warn</span>(<span class="string">&quot;reset mw_msgs %d to max %d&quot;</span>, v, SRS_PERF_MW_MSGS);</span><br><span class="line">        v = SRS_PERF_MW_MSGS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> v;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="读取配置-1"><a href="#读取配置-1" class="headerlink" title="读取配置"></a>读取配置</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::do_playing</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    SrsLiveSource* source, SrsLiveConsumer* consumer, SrsQueueRecvThread* rtrd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// setup the mw config.</span></span><br><span class="line">    <span class="comment">// when mw_sleep changed, resize the socket send buffer.</span></span><br><span class="line">    mw_msgs = _srs_config-&gt;<span class="built_in">get_mw_msgs</span>(req-&gt;vhost, realtime);</span><br><span class="line">    mw_sleep = _srs_config-&gt;<span class="built_in">get_mw_sleep</span>(req-&gt;vhost);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用配置-1"><a href="#使用配置-1" class="headerlink" title="使用配置"></a>使用配置</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::do_playing</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    SrsLiveSource* source, SrsLiveConsumer* consumer, SrsQueueRecvThread* rtrd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// setup the mw config.</span></span><br><span class="line">    <span class="comment">// when mw_sleep changed, resize the socket send buffer.</span></span><br><span class="line">    mw_msgs = _srs_config-&gt;<span class="built_in">get_mw_msgs</span>(req-&gt;vhost, realtime);</span><br><span class="line">    mw_sleep = _srs_config-&gt;<span class="built_in">get_mw_sleep</span>(req-&gt;vhost);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    consumer-&gt;<span class="built_in">wait</span>(mw_msgs, mw_sleep);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要同时满足合并写的最小消息数量和	最小时长，才通知写。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">SrsLiveConsumer::wait</span><span class="params">(<span class="type">int</span> nb_msgs, <span class="type">srs_utime_t</span> msgs_duration)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (paused) &#123;</span><br><span class="line">        <span class="built_in">srs_usleep</span>(SRS_CONSTS_RTMP_PULSE);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    mw_min_msgs = nb_msgs;</span><br><span class="line">    mw_duration = msgs_duration;</span><br><span class="line">    </span><br><span class="line">    <span class="type">srs_utime_t</span> duration = queue-&gt;<span class="built_in">duration</span>();</span><br><span class="line">    <span class="type">bool</span> match_min_msgs = queue-&gt;<span class="built_in">size</span>() &gt; mw_min_msgs;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// when duration ok, signal to flush.</span></span><br><span class="line">    <span class="keyword">if</span> (match_min_msgs &amp;&amp; duration &gt; mw_duration) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// the enqueue will notify this cond.</span></span><br><span class="line">    mw_waiting = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// use cond block wait for high performance mode.</span></span><br><span class="line">    <span class="built_in">srs_cond_wait</span>(mw_wait);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过<code>mw_waiting</code>变量判断，通过<code>srs_cond_signal</code>通知拉流端获取数据。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsLiveConsumer::enqueue</span><span class="params">(SrsSharedPtrMessage* shared_msg, <span class="type">bool</span> atc, SrsRtmpJitterAlgorithm ag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_PERF_QUEUE_COND_WAIT</span></span><br><span class="line">    <span class="comment">// fire the mw when msgs is enough.</span></span><br><span class="line">    <span class="keyword">if</span> (mw_waiting) &#123;</span><br><span class="line">        <span class="comment">// For RTMP, we wait for messages and duration.</span></span><br><span class="line">        <span class="type">srs_utime_t</span> duration = queue-&gt;<span class="built_in">duration</span>();</span><br><span class="line">        <span class="type">bool</span> match_min_msgs = queue-&gt;<span class="built_in">size</span>() &gt; mw_min_msgs;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// For ATC, maybe the SH timestamp bigger than A/V packet,</span></span><br><span class="line">        <span class="comment">// when encoder republish or overflow.</span></span><br><span class="line">        <span class="comment">// @see https://github.com/ossrs/srs/pull/749</span></span><br><span class="line">        <span class="keyword">if</span> (atc &amp;&amp; duration &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">srs_cond_signal</span>(mw_wait);</span><br><span class="line">            mw_waiting = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// when duration ok, signal to flush.</span></span><br><span class="line">        <span class="keyword">if</span> (match_min_msgs &amp;&amp; duration &gt; mw_duration) &#123;</span><br><span class="line">            <span class="built_in">srs_cond_signal</span>(mw_wait);</span><br><span class="line">            mw_waiting = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Queue-Length"><a href="#Queue-Length" class="headerlink" title="Queue Length"></a>Queue Length</h1><h2 id="配置-3"><a href="#配置-3" class="headerlink" title="配置"></a>配置</h2><p>SRS可以配置直播队列的长度，服务器会将数据放在直播队列中，如果超过这个长度就清空到最后一个I帧：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># the max live queue length in seconds.</span><br><span class="line"># if the messages in the queue exceed the max length, </span><br><span class="line"># drop the old whole gop.</span><br><span class="line"># default: 30</span><br><span class="line">queue_length    10; #单位是秒</span><br></pre></td></tr></table></figure>

<p>当然这个不能配置太小，譬如GOP是1秒，queue_length是1秒，这样会导致有1秒数据就清空，会导致跳跃。</p>
<p>有更好的方法？有的。延迟基本上就等于客户端的缓冲区长度，因为延迟大多由于网络带宽低，服务器缓存后一起发给客户端，现象就是客户端的缓冲区变大了，譬如NetStream.BufferLength&#x3D;5秒，那么说明缓冲区中至少有5秒数据。</p>
<p>处理累积延迟的最好方法，是客户端检测到缓冲区有很多数据了，如果可以的话，就重连服务器。当然如果网络一直不好，那就没有办法了。</p>
<h2 id="代码-3"><a href="#代码-3" class="headerlink" title="代码"></a>代码</h2><h3 id="读取配置-2"><a href="#读取配置-2" class="headerlink" title="读取配置"></a>读取配置</h3><p>默认是30秒。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_utime_t</span> <span class="title">SrsConfig::get_queue_length</span><span class="params">(string vhost)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">SRS_OVERWRITE_BY_ENV_SECONDS</span>(<span class="string">&quot;srs.vhost.play.queue_length&quot;</span>); <span class="comment">// SRS_VHOST_PLAY_QUEUE_LENGTH</span></span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> <span class="type">srs_utime_t</span> DEFAULT = SRS_PERF_PLAY_QUEUE;</span><br><span class="line">    </span><br><span class="line">    SrsConfDirective* conf = <span class="built_in">get_vhost</span>(vhost);</span><br><span class="line">    <span class="keyword">if</span> (!conf) &#123;</span><br><span class="line">        <span class="keyword">return</span> DEFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    conf = conf-&gt;<span class="built_in">get</span>(<span class="string">&quot;play&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!conf) &#123;</span><br><span class="line">        <span class="keyword">return</span> DEFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    conf = conf-&gt;<span class="built_in">get</span>(<span class="string">&quot;queue_length&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!conf || conf-&gt;<span class="built_in">arg0</span>().<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> DEFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">srs_utime_t</span>(::<span class="built_in">atoi</span>(conf-&gt;<span class="built_in">arg0</span>().<span class="built_in">c_str</span>()) * SRS_UTIME_SECONDS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用配置-2"><a href="#使用配置-2" class="headerlink" title="使用配置"></a>使用配置</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsMessageQueue::enqueue</span><span class="params">(SrsSharedPtrMessage* msg, <span class="type">bool</span>* is_overflow)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    msgs.<span class="built_in">push_back</span>(msg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If jitter is off, the timestamp of first sequence header is zero, which wll cause SRS to shrink and drop the</span></span><br><span class="line">    <span class="comment">// keyframes even if there is not overflow packets in queue, so we must ignore the zero timestamps, please</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/pull/2186#issuecomment-953383063</span></span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;<span class="built_in">is_av</span>() &amp;&amp; msg-&gt;timestamp != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (av_start_time == <span class="number">-1</span>) &#123;</span><br><span class="line">            av_start_time = <span class="built_in">srs_utime_t</span>(msg-&gt;timestamp * SRS_UTIME_MILLISECONDS);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        av_end_time = <span class="built_in">srs_utime_t</span>(msg-&gt;timestamp * SRS_UTIME_MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (max_queue_size &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (av_end_time - av_start_time &gt; max_queue_size) &#123;</span><br><span class="line">        <span class="comment">// notice the caller queue already overflow and shrinked.</span></span><br><span class="line">        <span class="keyword">if</span> (is_overflow) &#123;</span><br><span class="line">            *is_overflow = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">shrink</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="GOP-Cache"><a href="#GOP-Cache" class="headerlink" title="GOP-Cache"></a>GOP-Cache</h1><h2 id="配置-4"><a href="#配置-4" class="headerlink" title="配置"></a>配置</h2><p>GOP有什么影响？Flash（解码器）只有拿到GOP才能开始解码播放。也就是说，服务器一般先给一个I帧给Flash。可惜问题来了，假设GOP是10秒，也就是每隔10秒才有关键帧，如果用户在第5秒时开始播放，会怎么样？</p>
<p>第一种方案：等待下一个I帧，也就是说，再等5秒才开始给客户端数据。这样延迟就很低了，总是实时的流。问题是：等待的这5秒，会黑屏，现象就是播放器卡在那里，什么也没有，有些用户可能以为死掉了，就会刷新页面。总之，某些客户会认为等待关键帧是个不可饶恕的错误，延时有什么关系？我就希望能快速启动和播放视频，最好打开就能放！</p>
<p>第二种方案：马上开始放，放什么呢？你肯定知道了，放前一个I帧。也就是说，服务器需要总是cache一个gop，这样客户端上来就从前一个I帧开始播放，就可以快速启动了。问题是：延迟自然就大了。</p>
<p>有没有好的方案？有！至少有两种：</p>
<ul>
<li>编码器调低GOP，譬如0.5秒一个GOP，这样延迟也很低，也不用等待。坏处是编码器压缩率会降低，图像质量没有那么好。</li>
<li>服务器提供配置，可以选择前面两个方案之一：SRS就这么做，有个gop_cache配置项，on就会马上播放，off就低延迟。</li>
</ul>
<p>SRS的配置项：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># the listen ports, split by space.</span></span><br><span class="line"><span class="attribute">listen</span>              <span class="number">1935</span>;</span><br><span class="line"><span class="attribute">vhost</span> __defaultVhost__ &#123;</span><br><span class="line">    <span class="comment"># for play client, both RTMP and other stream clients,</span></span><br><span class="line">    <span class="comment"># for instance, the HTTP FLV stream clients.</span></span><br><span class="line">    <span class="section">play</span> &#123;</span><br><span class="line">        <span class="comment"># whether cache the last gop.</span></span><br><span class="line">        <span class="comment"># if on, cache the last gop and dispatch to client,</span></span><br><span class="line">        <span class="comment">#   to enabled fast startup for client, client play immediately.</span></span><br><span class="line">        <span class="comment"># if off, send the latest media data to client,</span></span><br><span class="line">        <span class="comment">#   client need to wait for the next Iframe to decode and show the video.</span></span><br><span class="line">        <span class="comment"># set to off if requires min delay;</span></span><br><span class="line">        <span class="comment"># set to on if requires client fast startup.</span></span><br><span class="line">        <span class="comment"># default: on</span></span><br><span class="line">        <span class="attribute">gop_cache</span>       <span class="literal">off</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="代码-4"><a href="#代码-4" class="headerlink" title="代码"></a>代码</h2><p>默认开启gop-cache。</p>
<h3 id="读取配置-3"><a href="#读取配置-3" class="headerlink" title="读取配置"></a>读取配置</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">SrsConfig::get_gop_cache</span><span class="params">(string vhost)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">SRS_OVERWRITE_BY_ENV_BOOL2</span>(<span class="string">&quot;srs.vhost.play.gop_cache&quot;</span>); <span class="comment">// SRS_VHOST_PLAY_GOP_CACHE</span></span><br><span class="line"></span><br><span class="line">    SrsConfDirective* conf = <span class="built_in">get_vhost</span>(vhost);</span><br><span class="line">    <span class="keyword">if</span> (!conf) &#123;</span><br><span class="line">        <span class="keyword">return</span> SRS_PERF_GOP_CACHE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    conf = conf-&gt;<span class="built_in">get</span>(<span class="string">&quot;play&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!conf) &#123;</span><br><span class="line">        <span class="keyword">return</span> SRS_PERF_GOP_CACHE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    conf = conf-&gt;<span class="built_in">get</span>(<span class="string">&quot;gop_cache&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!conf || conf-&gt;<span class="built_in">arg0</span>().<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> SRS_PERF_GOP_CACHE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">SRS_CONF_PERFER_TRUE</span>(conf-&gt;<span class="built_in">arg0</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用配置-3"><a href="#使用配置-3" class="headerlink" title="使用配置"></a>使用配置</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsGopCache::cache</span><span class="params">(SrsSharedPtrMessage* shared_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!enable_gop_cache) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// the gop cache know when to gop it.</span></span><br><span class="line">    SrsSharedPtrMessage* msg = shared_msg;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// got video, update the video count if acceptable</span></span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;<span class="built_in">is_video</span>()) &#123;</span><br><span class="line">        <span class="comment">// Drop video when not h.264 or h.265.</span></span><br><span class="line">        <span class="type">bool</span> codec_ok = SrsFlvVideo::<span class="built_in">h264</span>(msg-&gt;payload, msg-&gt;size);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_H265</span></span><br><span class="line">        codec_ok = codec_ok ? <span class="literal">true</span> : SrsFlvVideo::<span class="built_in">hevc</span>(msg-&gt;payload, msg-&gt;size);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">if</span> (!codec_ok) <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">        cached_video_count++;</span><br><span class="line">        audio_after_last_video_count = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// no acceptable video or pure audio, disable the cache.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">pure_audio</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ok, gop cache enabled, and got an audio.</span></span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;<span class="built_in">is_audio</span>()) &#123;</span><br><span class="line">        audio_after_last_video_count++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// clear gop cache when pure audio count overflow</span></span><br><span class="line">    <span class="keyword">if</span> (audio_after_last_video_count &gt; SRS_PURE_AUDIO_GUESS_COUNT) &#123;</span><br><span class="line">        <span class="built_in">srs_warn</span>(<span class="string">&quot;clear gop cache for guess pure audio overflow&quot;</span>);</span><br><span class="line">        <span class="built_in">clear</span>();</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// clear gop cache when got key frame</span></span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;<span class="built_in">is_video</span>() &amp;&amp; SrsFlvVideo::<span class="built_in">keyframe</span>(msg-&gt;payload, msg-&gt;size)) &#123;</span><br><span class="line">        <span class="built_in">clear</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// curent msg is video frame, so we set to 1.</span></span><br><span class="line">        cached_video_count = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// cache the frame.</span></span><br><span class="line">    gop_cache.<span class="built_in">push_back</span>(msg-&gt;<span class="built_in">copy</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clear gop cache if exceed the max frames.</span></span><br><span class="line">    <span class="keyword">if</span> (gop_cache_max_frames_ &gt; <span class="number">0</span> &amp;&amp; gop_cache.<span class="built_in">size</span>() &gt; (<span class="type">size_t</span>)gop_cache_max_frames_) &#123;</span><br><span class="line">        <span class="built_in">srs_warn</span>(<span class="string">&quot;Gop cache exceed max frames=%d, total=%d, videos=%d, aalvc=%d&quot;</span>,</span><br><span class="line">            gop_cache_max_frames_, (<span class="type">int</span>)gop_cache.<span class="built_in">size</span>(), cached_video_count, audio_after_last_video_count);</span><br><span class="line">        <span class="built_in">clear</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参考链接：<a target="_blank" rel="noopener" href="https://ossrs.net/lts/zh-cn/docs/v5/doc/low-latency#max-queue-length">https://ossrs.net/lts/zh-cn/docs/v5/doc/low-latency#max-queue-length</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/10/29/SRS-RTMP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/29/SRS-RTMP/" class="post-title-link" itemprop="url">SRS-RTMP</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-10-29 10:29:39" itemprop="dateCreated datePublished" datetime="2023-10-29T10:29:39+08:00">2023-10-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-12-30 22:37:41" itemprop="dateModified" datetime="2023-12-30T22:37:41+08:00">2023-12-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SRS/" itemprop="url" rel="index"><span itemprop="name">SRS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>注：SRS版本为<code>v6.0.75</code></p>
<h1 id="RTMP服务运行"><a href="#RTMP服务运行" class="headerlink" title="RTMP服务运行"></a>RTMP服务运行</h1><h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><ul>
<li><code>rtmp.conf</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">listen              1935;</span><br><span class="line">max_connections     1000;</span><br><span class="line">daemon              off;</span><br><span class="line">srs_log_tank        console;</span><br><span class="line">vhost __defaultVhost__ &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="运行服务"><a href="#运行服务" class="headerlink" title="运行服务"></a>运行服务</h2><ul>
<li>运行SRS服务</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./obj/srs -c conf/rtmp.conf</span><br></pre></td></tr></table></figure>

<ul>
<li>推流</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -re -i test.mp4 -codec copy -f flv -y rtmp://127.0.0.1/live/livestream</span><br></pre></td></tr></table></figure>

<ul>
<li>拉流</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffplay rtmp://127.0.0.1/live/livestream</span><br></pre></td></tr></table></figure>

<h1 id="RTMP端口监听"><a href="#RTMP端口监听" class="headerlink" title="RTMP端口监听"></a>RTMP端口监听</h1><ul>
<li>断点：<code>b SrsConfig::get_listens()</code>，查看堆栈。</li>
</ul>
<img src="/2023/10/29/SRS-RTMP/SRS断点get_listens.png" alt="SRS断点get_listens" style="zoom:50%;">

<h2 id="SrsServer-listen"><a href="#SrsServer-listen" class="headerlink" title="SrsServer::listen()"></a>SrsServer::listen()</h2><p>RTMP监听配置端口。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsServer::listen</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create RTMP listeners.</span></span><br><span class="line">    rtmp_listener_-&gt;<span class="built_in">add</span>(_srs_config-&gt;<span class="built_in">get_listens</span>())-&gt;<span class="built_in">set_label</span>(<span class="string">&quot;RTMP&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp_listener_-&gt;<span class="built_in">listen</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp listen&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsMultipleTcpListeners::listen</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (vector&lt;SrsTcpListener*&gt;::iterator it = listeners_.<span class="built_in">begin</span>(); it != listeners_.<span class="built_in">end</span>(); ++it) &#123;</span><br><span class="line">        SrsTcpListener* l = *it;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((err = l-&gt;<span class="built_in">listen</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;listen&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SrsTcpListener-listen"><a href="#SrsTcpListener-listen" class="headerlink" title="SrsTcpListener::listen()"></a>SrsTcpListener::listen()</h2><ul>
<li><code>srs_tcp_listen</code>中创建套接字，监听。</li>
<li><code>trd-&gt;start()</code>启动协程，真正的协程函数是<code>handler-&gt;cycle()</code>，<code>handler</code>通过<code>SrsSTCoroutine(&quot;tcp&quot;, this)</code>构造函数的参数<code>this</code>赋值，即<code>SrsTcpListener</code>，所以具体实现是<code>SrsTcpListener::cycle()</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsTcpListener::listen</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Ignore if not configured.</span></span><br><span class="line">    <span class="keyword">if</span> (ip.<span class="built_in">empty</span>() || !port_) <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">srs_close_stfd</span>(lfd);</span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">srs_tcp_listen</span>(ip, port_, &amp;lfd)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;listen at %s:%d&quot;</span>, ip.<span class="built_in">c_str</span>(), port_);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_freep</span>(trd);</span><br><span class="line">    trd = <span class="keyword">new</span> <span class="built_in">SrsSTCoroutine</span>(<span class="string">&quot;tcp&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">start</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;start coroutine&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> fd = <span class="built_in">srs_netfd_fileno</span>(lfd);</span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;%s listen at tcp://%s:%d, fd=%d&quot;</span>, label_.<span class="built_in">c_str</span>(), ip.<span class="built_in">c_str</span>(), port_, fd);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="RTMP客户端连接"><a href="#RTMP客户端连接" class="headerlink" title="RTMP客户端连接"></a>RTMP客户端连接</h1><h2 id="SrsTcpListener-cycle"><a href="#SrsTcpListener-cycle" class="headerlink" title="SrsTcpListener::cycle()"></a>SrsTcpListener::cycle()</h2><ul>
<li><code>srs_accept()</code>接收获取客户端的连接套接字。</li>
<li><code>handler-&gt;on_tcp_client()</code>，真正处理连接的地方；这行打个断点，客户端进行RTMP推流。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsTcpListener::cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;tcp listener&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">srs_netfd_t</span> fd = <span class="built_in">srs_accept</span>(lfd, <span class="literal">NULL</span>, <span class="literal">NULL</span>, SRS_UTIME_NO_TIMEOUT);</span><br><span class="line">        <span class="keyword">if</span>(fd == <span class="literal">NULL</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_SOCKET_ACCEPT, <span class="string">&quot;accept at fd=%d&quot;</span>, <span class="built_in">srs_netfd_fileno</span>(lfd));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">srs_fd_closeexec</span>(<span class="built_in">srs_netfd_fileno</span>(fd))) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;set closeexec&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = handler-&gt;<span class="built_in">on_tcp_client</span>(<span class="keyword">this</span>, fd)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;handle fd=%d&quot;</span>, <span class="built_in">srs_netfd_fileno</span>(fd));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>断点：<code>b srs_app_listener.cpp:316</code>。</li>
</ul>
<img src="/2023/10/29/SRS-RTMP/SRS断点on_tcp_client.png" alt="SRS断点on_tcp_client" style="zoom:50%;">

<ul>
<li><code>SrsTcpListener::cycle()</code>中的<code>handler_</code>是<code>SrsMultipleTcpListeners</code>。</li>
<li><code>SrsMultipleTcpListeners::on_tcp_client()</code>中的<code>handler_</code>是<code>SrsServer</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsMultipleTcpListeners::on_tcp_client</span><span class="params">(ISrsListener* listener, <span class="type">srs_netfd_t</span> stfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> handler_-&gt;<span class="built_in">on_tcp_client</span>(<span class="keyword">this</span>, stfd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsServer::on_tcp_client</span><span class="params">(ISrsListener* listener, <span class="type">srs_netfd_t</span> stfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = <span class="built_in">do_on_tcp_client</span>(listener, stfd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We always try to close the stfd, because it should be NULL if it has been handled or closed.</span></span><br><span class="line">    <span class="built_in">srs_close_stfd</span>(stfd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SrsServer-do-on-tcp-client"><a href="#SrsServer-do-on-tcp-client" class="headerlink" title="SrsServer::do_on_tcp_client()"></a>SrsServer::do_on_tcp_client()</h2><ul>
<li>创建RTMP连接：<code>resource = new SrsRtmpConn(this, stfd2, ip, port)</code>。</li>
<li>连接管理：<code>conn_manager-&gt;add(resource)</code>。</li>
<li>启动连接协程：<code>conn-&gt;start()</code>，可以发现每个连接都对应一个协程。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsServer::do_on_tcp_client</span><span class="params">(ISrsListener* listener, <span class="type">srs_netfd_t</span>&amp; stfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> fd = <span class="built_in">srs_netfd_fileno</span>(stfd);</span><br><span class="line">    string ip = <span class="built_in">srs_get_peer_ip</span>(fd);</span><br><span class="line">    <span class="type">int</span> port = <span class="built_in">srs_get_peer_port</span>(fd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Ignore if ip is empty, for example, load balancer keepalive.</span></span><br><span class="line">    <span class="keyword">if</span> (ip.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_srs_config-&gt;<span class="built_in">empty_ip_ok</span>()) <span class="keyword">return</span> err;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_SOCKET_GET_PEER_IP, <span class="string">&quot;ignore empty ip, fd=%d&quot;</span>, fd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Security or system flow control check.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">on_before_connection</span>(stfd, ip, port)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;check&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Covert handler to resource.</span></span><br><span class="line">    ISrsResource* resource = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The context id may change during creating the bellow objects.</span></span><br><span class="line">    <span class="built_in">SrsContextRestore</span>(_srs_context-&gt;<span class="built_in">get_id</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// From now on, we always handle the stfd, so we set the original one to NULL.</span></span><br><span class="line">    <span class="type">srs_netfd_t</span> stfd2 = stfd;</span><br><span class="line">    stfd = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_RTC</span></span><br><span class="line">    <span class="comment">// If reuse HTTP server with WebRTC TCP, peek to detect the client.</span></span><br><span class="line">    <span class="keyword">if</span> (reuse_rtc_over_server_ &amp;&amp; (listener == http_listener_ || listener == https_listener_)) &#123;</span><br><span class="line">        SrsTcpConnection* skt = <span class="keyword">new</span> <span class="built_in">SrsTcpConnection</span>(stfd2);</span><br><span class="line">        SrsBufferedReadWriter* io = <span class="keyword">new</span> <span class="built_in">SrsBufferedReadWriter</span>(skt);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Peek first N bytes to finger out the real client type.</span></span><br><span class="line">        <span class="type">uint8_t</span> b[<span class="number">10</span>]; <span class="type">int</span> nn = <span class="built_in">sizeof</span>(b);</span><br><span class="line">        <span class="keyword">if</span> ((err = io-&gt;<span class="built_in">peek</span>((<span class="type">char</span>*)b, &amp;nn)) != srs_success) &#123;</span><br><span class="line">            <span class="built_in">srs_freep</span>(io); <span class="built_in">srs_freep</span>(skt);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;peek&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If first message is BindingRequest(00 01), prefixed with length(2B), it&#x27;s WebRTC client. Generally, the frame</span></span><br><span class="line">        <span class="comment">// length minus message length should be 20, that is the header size of STUN is 20 bytes. For example:</span></span><br><span class="line">        <span class="comment">//      00 6c # Frame length: 0x006c = 108</span></span><br><span class="line">        <span class="comment">//      00 01 # Message Type: Binding Request(0x0001)</span></span><br><span class="line">        <span class="comment">//      00 58 # Message Length: 0x005 = 88</span></span><br><span class="line">        <span class="comment">//      21 12 a4 42 # Message Cookie: 0x2112a442</span></span><br><span class="line">        <span class="comment">//      48 32 6c 61 6b 42 35 71 42 35 4a 71 # Message Transaction ID: 12 bytes</span></span><br><span class="line">        <span class="keyword">if</span> (nn == <span class="number">10</span> &amp;&amp; b[<span class="number">0</span>] == <span class="number">0</span> &amp;&amp; b[<span class="number">2</span>] == <span class="number">0</span> &amp;&amp; b[<span class="number">3</span>] == <span class="number">1</span> &amp;&amp; b[<span class="number">1</span>] - b[<span class="number">5</span>] == <span class="number">20</span></span><br><span class="line">            &amp;&amp; b[<span class="number">6</span>] == <span class="number">0x21</span> &amp;&amp; b[<span class="number">7</span>] == <span class="number">0x12</span> &amp;&amp; b[<span class="number">8</span>] == <span class="number">0xa4</span> &amp;&amp; b[<span class="number">9</span>] == <span class="number">0x42</span></span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> Should manage this connection by _srs_rtc_manager</span></span><br><span class="line">            resource = <span class="keyword">new</span> <span class="built_in">SrsRtcTcpConn</span>(io, ip, port, <span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resource = <span class="keyword">new</span> <span class="built_in">SrsHttpxConn</span>(listener == http_listener_, <span class="keyword">this</span>, io, http_server, ip, port);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create resource by normal listeners.</span></span><br><span class="line">    <span class="keyword">if</span> (!resource) &#123;</span><br><span class="line">        <span class="keyword">if</span> (listener == rtmp_listener_) &#123;</span><br><span class="line">            resource = <span class="keyword">new</span> <span class="built_in">SrsRtmpConn</span>(<span class="keyword">this</span>, stfd2, ip, port);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (listener == api_listener_ || listener == apis_listener_) &#123;</span><br><span class="line">            <span class="type">bool</span> is_https = listener == apis_listener_;</span><br><span class="line">            resource = <span class="keyword">new</span> <span class="built_in">SrsHttpxConn</span>(is_https, <span class="keyword">this</span>, <span class="keyword">new</span> <span class="built_in">SrsTcpConnection</span>(stfd2), http_api_mux, ip, port);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (listener == http_listener_ || listener == https_listener_) &#123;</span><br><span class="line">            <span class="type">bool</span> is_https = listener == https_listener_;</span><br><span class="line">            resource = <span class="keyword">new</span> <span class="built_in">SrsHttpxConn</span>(is_https, <span class="keyword">this</span>, <span class="keyword">new</span> <span class="built_in">SrsTcpConnection</span>(stfd2), http_server, ip, port);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_RTC</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (listener == webrtc_listener_) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> Should manage this connection by _srs_rtc_manager</span></span><br><span class="line">            resource = <span class="keyword">new</span> <span class="built_in">SrsRtcTcpConn</span>(<span class="keyword">new</span> <span class="built_in">SrsTcpConnection</span>(stfd2), ip, port, <span class="keyword">this</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (listener == exporter_listener_) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> Maybe should support https metrics.</span></span><br><span class="line">            <span class="type">bool</span> is_https = <span class="literal">false</span>;</span><br><span class="line">            resource = <span class="keyword">new</span> <span class="built_in">SrsHttpxConn</span>(is_https, <span class="keyword">this</span>, <span class="keyword">new</span> <span class="built_in">SrsTcpConnection</span>(stfd2), http_api_mux, ip, port);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">srs_close_stfd</span>(stfd2);</span><br><span class="line">            <span class="built_in">srs_warn</span>(<span class="string">&quot;Close for invalid fd=%d, ip=%s:%d&quot;</span>, fd, ip.<span class="built_in">c_str</span>(), port);</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use connection manager to manage all the resources.</span></span><br><span class="line">    conn_manager-&gt;<span class="built_in">add</span>(resource);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If connection is a resource to start, start a coroutine to handle it.</span></span><br><span class="line">    ISrsStartable* conn = <span class="built_in">dynamic_cast</span>&lt;ISrsStartable*&gt;(resource);</span><br><span class="line">    <span class="keyword">if</span> ((err = conn-&gt;<span class="built_in">start</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;start conn coroutine&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="RTMP推流端"><a href="#RTMP推流端" class="headerlink" title="RTMP推流端"></a>RTMP推流端</h1><h2 id="RTMP连接请求协程"><a href="#RTMP连接请求协程" class="headerlink" title="RTMP连接请求协程"></a>RTMP连接请求协程</h2><ul>
<li>断点<code>b SrsRtmpConn::publishing(SrsLiveSource*)</code>。</li>
</ul>
<img src="/2023/10/29/SRS-RTMP/10/29/SRS-RTMP/SrsRtmpConn%E4%B8%ADpublishing%E6%96%AD%E7%82%B9.png" class title="SrsRtmpConn中publishing断点">

<h3 id="SrsRtmpConn-cycle"><a href="#SrsRtmpConn-cycle" class="headerlink" title="SrsRtmpConn::cycle()"></a>SrsRtmpConn::cycle()</h3><ul>
<li>上述<code>conn-&gt;start()</code>启动后，同样会调用协程函数。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Serve the client.</span></span><br><span class="line">    err = <span class="built_in">do_cycle</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">    <span class="comment">// Final APM span, parent is the last span, not the root span. Note that only client or server kind will be filtered</span></span><br><span class="line">    <span class="comment">// for error or exception report.</span></span><br><span class="line">    ISrsApmSpan* span_final = _srs_apm-&gt;<span class="built_in">span</span>(<span class="string">&quot;final&quot;</span>)-&gt;<span class="built_in">set_kind</span>(SrsApmKindServer)-&gt;<span class="built_in">as_child</span>(span_client_);</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(ISrsApmSpan, span_final);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">srs_error_code</span>(err) != <span class="number">0</span>) &#123;</span><br><span class="line">        span_final-&gt;<span class="built_in">record_error</span>(err)-&gt;<span class="built_in">set_status</span>(SrsApmStatusError, </span><br><span class="line">                                                  <span class="built_in">srs_fmt</span>(<span class="string">&quot;fail code=%d&quot;</span>, <span class="built_in">srs_error_code</span>(err)));</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update statistic when done.</span></span><br><span class="line">    SrsStatistic* stat = SrsStatistic::<span class="built_in">instance</span>();</span><br><span class="line">    stat-&gt;<span class="built_in">kbps_add_delta</span>(<span class="built_in">get_id</span>().<span class="built_in">c_str</span>(), delta_);</span><br><span class="line">    stat-&gt;<span class="built_in">on_disconnect</span>(<span class="built_in">get_id</span>().<span class="built_in">c_str</span>(), err);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Notify manager to remove it.</span></span><br><span class="line">    <span class="comment">// Note that we create this object, so we use manager to remove it.</span></span><br><span class="line">    manager-&gt;<span class="built_in">remove</span>(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// success.</span></span><br><span class="line">    <span class="keyword">if</span> (err == srs_success) &#123;</span><br><span class="line">        <span class="built_in">srs_trace</span>(<span class="string">&quot;client finished.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// It maybe success with message.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">srs_error_code</span>(err) == ERROR_SUCCESS) &#123;</span><br><span class="line">        <span class="built_in">srs_trace</span>(<span class="string">&quot;client finished%s.&quot;</span>, <span class="built_in">srs_error_summary</span>(err).<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="built_in">srs_freep</span>(err);</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// client close peer.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> Only reset the error when client closed it.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">srs_is_client_gracefully_close</span>(err)) &#123;</span><br><span class="line">        <span class="built_in">srs_warn</span>(<span class="string">&quot;client disconnect peer. ret=%d&quot;</span>, <span class="built_in">srs_error_code</span>(err));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">srs_is_server_gracefully_close</span>(err)) &#123;</span><br><span class="line">        <span class="built_in">srs_warn</span>(<span class="string">&quot;server disconnect. ret=%d&quot;</span>, <span class="built_in">srs_error_code</span>(err));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">srs_error</span>(<span class="string">&quot;serve error %s&quot;</span>, <span class="built_in">srs_error_desc</span>(err).<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">srs_freep</span>(err);</span><br><span class="line">    <span class="keyword">return</span> srs_success;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>RTMP协议握手：<code>rtmp-&gt;handshake()</code>。</li>
<li>处理客户端连接命令：<code>rtmp-&gt;connect_app(req)</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::do_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">    <span class="comment">// We should keep the root span to alive util connection closed.</span></span><br><span class="line">    <span class="comment">// Note that we use producer and consumer span because RTMP connection is long polling connection.</span></span><br><span class="line">    <span class="comment">// Note that we also store this span in coroutine context, so that edge could load it.</span></span><br><span class="line">    <span class="built_in">srs_freep</span>(span_main_);</span><br><span class="line">    span_main_ = _srs_apm-&gt;<span class="built_in">span</span>(<span class="string">&quot;rtmp&quot;</span>)-&gt;<span class="built_in">set_kind</span>(SrsApmKindServer)-&gt;<span class="built_in">attr</span>(<span class="string">&quot;cip&quot;</span>, ip)</span><br><span class="line">        -&gt;<span class="built_in">attr</span>(<span class="string">&quot;cid&quot;</span>, _srs_context-&gt;<span class="built_in">get_id</span>().<span class="built_in">c_str</span>());</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;RTMP client ip=%s:%d, fd=%d, trace=%s, span=%s&quot;</span>, ip.<span class="built_in">c_str</span>(), port, <span class="built_in">srs_netfd_fileno</span>(stfd),</span><br><span class="line">        span_main_-&gt;format_trace_id(), span_main_-&gt;format_span_id()</span><br><span class="line">    );</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;RTMP client ip=%s:%d, fd=%d&quot;</span>, ip.<span class="built_in">c_str</span>(), port, <span class="built_in">srs_netfd_fileno</span>(stfd));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    rtmp-&gt;<span class="built_in">set_recv_timeout</span>(SRS_CONSTS_RTMP_TIMEOUT);</span><br><span class="line">    rtmp-&gt;<span class="built_in">set_send_timeout</span>(SRS_CONSTS_RTMP_TIMEOUT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">handshake</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp handshake&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> rip = rtmp-&gt;<span class="built_in">proxy_real_ip</span>();</span><br><span class="line">    std::string rips = <span class="built_in">srs_ipv4_string</span>(rip);</span><br><span class="line">    <span class="keyword">if</span> (rip &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">srs_trace</span>(<span class="string">&quot;RTMP proxy real client ip=%s&quot;</span>, rips.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">    <span class="comment">// Update the real IP of client, also set the HTTP fields.</span></span><br><span class="line">    span_main_-&gt;<span class="built_in">attr</span>(<span class="string">&quot;rip&quot;</span>, rip ? rips : ip)-&gt;<span class="built_in">attr</span>(<span class="string">&quot;http.client_ip&quot;</span>, rip ? rips : ip);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The span for RTMP connecting to application.</span></span><br><span class="line">    <span class="built_in">srs_freep</span>(span_connect_);</span><br><span class="line">    span_connect_ = _srs_apm-&gt;<span class="built_in">span</span>(<span class="string">&quot;connect&quot;</span>)-&gt;<span class="built_in">as_child</span>(span_main_);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">connect_app</span>(req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp connect tcUrl&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set client ip to request.</span></span><br><span class="line">    req-&gt;ip = ip;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;connect app, tcUrl=%s, pageUrl=%s, swfUrl=%s, schema=%s, vhost=%s, port=%d, app=%s, args=%s&quot;</span>,</span><br><span class="line">        req-&gt;tcUrl.<span class="built_in">c_str</span>(), req-&gt;pageUrl.<span class="built_in">c_str</span>(), req-&gt;swfUrl.<span class="built_in">c_str</span>(),</span><br><span class="line">        req-&gt;schema.<span class="built_in">c_str</span>(), req-&gt;vhost.<span class="built_in">c_str</span>(), req-&gt;port,</span><br><span class="line">        req-&gt;app.<span class="built_in">c_str</span>(), (req-&gt;args? <span class="string">&quot;(obj)&quot;</span>:<span class="string">&quot;null&quot;</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// show client identity</span></span><br><span class="line">    <span class="keyword">if</span>(req-&gt;args) &#123;</span><br><span class="line">        std::string srs_version;</span><br><span class="line">        std::string srs_server_ip;</span><br><span class="line">        <span class="type">int</span> srs_pid = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> srs_id = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        SrsAmf0Any* prop = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> ((prop = req-&gt;args-&gt;<span class="built_in">ensure_property_string</span>(<span class="string">&quot;srs_version&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            srs_version = prop-&gt;<span class="built_in">to_str</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((prop = req-&gt;args-&gt;<span class="built_in">ensure_property_string</span>(<span class="string">&quot;srs_server_ip&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            srs_server_ip = prop-&gt;<span class="built_in">to_str</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((prop = req-&gt;args-&gt;<span class="built_in">ensure_property_number</span>(<span class="string">&quot;srs_pid&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            srs_pid = (<span class="type">int</span>)prop-&gt;<span class="built_in">to_number</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((prop = req-&gt;args-&gt;<span class="built_in">ensure_property_number</span>(<span class="string">&quot;srs_id&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            srs_id = (<span class="type">int</span>)prop-&gt;<span class="built_in">to_number</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (srs_pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">srs_trace</span>(<span class="string">&quot;edge-srs ip=%s, version=%s, pid=%d, id=%d&quot;</span>,</span><br><span class="line">                srs_server_ip.<span class="built_in">c_str</span>(), srs_version.<span class="built_in">c_str</span>(), srs_pid, srs_id);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">        <span class="comment">// Load the span from the AMF0 object propagator.</span></span><br><span class="line">        <span class="comment">// Note that we will update the trace id, so please make sure no spans are ended before this.</span></span><br><span class="line">        _srs_apm-&gt;<span class="built_in">extract</span>(span_main_, req-&gt;args);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">service_cycle</span>()) != srs_success) &#123;</span><br><span class="line">        err = <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;service cycle&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">srs_error_t</span> r0 = srs_success;</span><br><span class="line">    <span class="keyword">if</span> ((r0 = <span class="built_in">on_disconnect</span>()) != srs_success) &#123;</span><br><span class="line">        err = <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;on disconnect %s&quot;</span>, <span class="built_in">srs_error_desc</span>(r0).<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="built_in">srs_freep</span>(r0);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// If client is redirect to other servers, we already logged the event.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">srs_error_code</span>(err) == ERROR_CONTROL_REDIRECT) &#123;</span><br><span class="line">        <span class="built_in">srs_error_reset</span>(err);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SrsRtmpConn-service-cycle"><a href="#SrsRtmpConn-service-cycle" class="headerlink" title="SrsRtmpConn::service_cycle()"></a>SrsRtmpConn::service_cycle()</h3><ul>
<li>设置窗口大小：<code>rtmp-&gt;set_window_ack_size()</code>。</li>
<li>设置带宽：<code>rtmp-&gt;set_peer_bandwidth()</code>。</li>
<li>设置块传输大小：<code>rtmp-&gt;set_chunk_size</code>。</li>
<li>响应客户端连接命令：<code>rtmp-&gt;response_connect_app()</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::service_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> out_ack_size = _srs_config-&gt;<span class="built_in">get_out_ack_size</span>(req-&gt;vhost);</span><br><span class="line">    <span class="keyword">if</span> (out_ack_size &amp;&amp; (err = rtmp-&gt;<span class="built_in">set_window_ack_size</span>(out_ack_size)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: set out window ack size&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> in_ack_size = _srs_config-&gt;<span class="built_in">get_in_ack_size</span>(req-&gt;vhost);</span><br><span class="line">    <span class="keyword">if</span> (in_ack_size &amp;&amp; (err = rtmp-&gt;<span class="built_in">set_in_window_ack_size</span>(in_ack_size)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: set in window ack size&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">set_peer_bandwidth</span>((<span class="type">int</span>)(<span class="number">2.5</span> * <span class="number">1000</span> * <span class="number">1000</span>), <span class="number">2</span>)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: set peer bandwidth&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// get the ip which client connected.</span></span><br><span class="line">    std::string local_ip = <span class="built_in">srs_get_local_ip</span>(<span class="built_in">srs_netfd_fileno</span>(stfd));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// set chunk size to larger.</span></span><br><span class="line">    <span class="comment">// set the chunk size before any larger response greater than 128,</span></span><br><span class="line">    <span class="comment">// to make OBS happy, @see https://github.com/ossrs/srs/issues/454</span></span><br><span class="line">    <span class="type">int</span> chunk_size = _srs_config-&gt;<span class="built_in">get_chunk_size</span>(req-&gt;vhost);</span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">set_chunk_size</span>(chunk_size)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: set chunk size %d&quot;</span>, chunk_size);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// response the client connect ok.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">response_connect_app</span>(req, local_ip.<span class="built_in">c_str</span>())) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: response connect app&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">    <span class="comment">// Must be a connecting application span.</span></span><br><span class="line">    span_connect_-&gt;<span class="built_in">end</span>();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">on_bw_done</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: on bw down&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: thread quit&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        err = <span class="built_in">stream_service_cycle</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// stream service must terminated with error, never success.</span></span><br><span class="line">        <span class="comment">// when terminated with success, it&#x27;s user required to stop.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> Support RTMP client timeout, https://github.com/ossrs/srs/issues/1134</span></span><br><span class="line">        <span class="keyword">if</span> (err == srs_success) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// when not system control error, fatal error, return.</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">srs_is_system_control_error</span>(err)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: stream service&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// for republish, continue service</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">srs_error_code</span>(err) == ERROR_CONTROL_REPUBLISH) &#123;</span><br><span class="line">            <span class="comment">// set timeout to a larger value, wait for encoder to republish.</span></span><br><span class="line">            rtmp-&gt;<span class="built_in">set_send_timeout</span>(SRS_REPUBLISH_RECV_TIMEOUT);</span><br><span class="line">            rtmp-&gt;<span class="built_in">set_recv_timeout</span>(SRS_REPUBLISH_SEND_TIMEOUT);</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">srs_info</span>(<span class="string">&quot;rtmp: retry for republish&quot;</span>);</span><br><span class="line">            <span class="built_in">srs_freep</span>(err);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// for &quot;some&quot; system control error,</span></span><br><span class="line">        <span class="comment">// logical accept and retry stream service.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">srs_error_code</span>(err) == ERROR_CONTROL_RTMP_CLOSE) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> use ping message to anti-death of socket.</span></span><br><span class="line">            <span class="comment">// set timeout to a larger value, for user paused.</span></span><br><span class="line">            rtmp-&gt;<span class="built_in">set_recv_timeout</span>(SRS_PAUSED_RECV_TIMEOUT);</span><br><span class="line">            rtmp-&gt;<span class="built_in">set_send_timeout</span>(SRS_PAUSED_SEND_TIMEOUT);</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">srs_trace</span>(<span class="string">&quot;rtmp: retry for close&quot;</span>);</span><br><span class="line">            <span class="built_in">srs_freep</span>(err);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// for other system control message, fatal error.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: reject&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SrsRtmpConn-stream-service-cycle"><a href="#SrsRtmpConn-stream-service-cycle" class="headerlink" title="SrsRtmpConn::stream_service_cycle()"></a>SrsRtmpConn::stream_service_cycle()</h3><ul>
<li>通过<code>rtmp-&gt;identify_client()</code>获取连接类型，判断拉流还是推流。</li>
<li><code>_srs_sources-&gt;fetch_or_create()</code>创建或获取<code>SrsLiveSource</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::stream_service_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">identify_client</span>(info-&gt;res-&gt;stream_id, info-&gt;type, req-&gt;stream, req-&gt;duration)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: identify client&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_discovery_tc_url</span>(req-&gt;tcUrl, req-&gt;schema, req-&gt;host, </span><br><span class="line">                         req-&gt;vhost, req-&gt;app, req-&gt;stream, req-&gt;port, req-&gt;param);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// guess stream name</span></span><br><span class="line">    <span class="keyword">if</span> (req-&gt;stream.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        string app = req-&gt;app, param = req-&gt;param;</span><br><span class="line">        <span class="built_in">srs_guess_stream_by_app</span>(req-&gt;app, req-&gt;param, req-&gt;stream);</span><br><span class="line">        <span class="built_in">srs_trace</span>(<span class="string">&quot;Guessing by app=%s, param=%s to app=%s, param=%s, stream=%s&quot;</span>, </span><br><span class="line">                  app.<span class="built_in">c_str</span>(), param.<span class="built_in">c_str</span>(), req-&gt;app.<span class="built_in">c_str</span>(), req-&gt;param.<span class="built_in">c_str</span>(), req-&gt;stream.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    req-&gt;<span class="built_in">strip</span>();</span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;client identified, type=%s, vhost=%s, app=%s, stream=%s, param=%s, duration=%dms&quot;</span>,</span><br><span class="line">        <span class="built_in">srs_client_type_string</span>(info-&gt;type).<span class="built_in">c_str</span>(), req-&gt;vhost.<span class="built_in">c_str</span>(), req-&gt;app.<span class="built_in">c_str</span>(), req-&gt;stream.<span class="built_in">c_str</span>(), req-&gt;param.<span class="built_in">c_str</span>(), <span class="built_in">srsu2msi</span>(req-&gt;duration));</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">    <span class="comment">// Start APM only when client is identified, because it might republish.</span></span><br><span class="line">    <span class="built_in">srs_freep</span>(span_client_);</span><br><span class="line">    span_client_ = _srs_apm-&gt;<span class="built_in">span</span>(<span class="string">&quot;client&quot;</span>)-&gt;<span class="built_in">as_child</span>(span_connect_)-&gt;<span class="built_in">attr</span>(<span class="string">&quot;type&quot;</span>, <span class="built_in">srs_client_type_string</span>(info-&gt;type))</span><br><span class="line">        -&gt;<span class="built_in">attr</span>(<span class="string">&quot;url&quot;</span>, req-&gt;<span class="built_in">get_stream_url</span>())-&gt;<span class="built_in">attr</span>(<span class="string">&quot;http.url&quot;</span>, req-&gt;<span class="built_in">get_stream_url</span>());</span><br><span class="line">    <span class="comment">// We store the span to coroutine context, for edge to load it.</span></span><br><span class="line">    _srs_apm-&gt;<span class="built_in">store</span>(span_client_);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// discovery vhost, resolve the vhost from config</span></span><br><span class="line">    SrsConfDirective* parsed_vhost = _srs_config-&gt;<span class="built_in">get_vhost</span>(req-&gt;vhost);</span><br><span class="line">    <span class="keyword">if</span> (parsed_vhost) &#123;</span><br><span class="line">        req-&gt;vhost = parsed_vhost-&gt;<span class="built_in">arg0</span>();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">    span_client_-&gt;<span class="built_in">attr</span>(<span class="string">&quot;vhost&quot;</span>, req-&gt;vhost)-&gt;<span class="built_in">attr</span>(<span class="string">&quot;http.host&quot;</span>, req-&gt;host)-&gt;<span class="built_in">attr</span>(<span class="string">&quot;http.server_name&quot;</span>, req-&gt;vhost)</span><br><span class="line">        -&gt;<span class="built_in">attr</span>(<span class="string">&quot;http.target&quot;</span>, <span class="built_in">srs_fmt</span>(<span class="string">&quot;/%s/%s&quot;</span>, req-&gt;app.<span class="built_in">c_str</span>(), req-&gt;stream.<span class="built_in">c_str</span>()));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (req-&gt;schema.<span class="built_in">empty</span>() || req-&gt;vhost.<span class="built_in">empty</span>() || req-&gt;port == <span class="number">0</span> || req-&gt;app.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_RTMP_REQ_TCURL, <span class="string">&quot;discovery tcUrl failed, tcUrl=%s, schema=%s, vhost=%s, port=%d, app=%s&quot;</span>,</span><br><span class="line">            req-&gt;tcUrl.<span class="built_in">c_str</span>(), req-&gt;schema.<span class="built_in">c_str</span>(), req-&gt;vhost.<span class="built_in">c_str</span>(), req-&gt;port, req-&gt;app.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check vhost, allow default vhost.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">check_vhost</span>(<span class="literal">true</span>)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;check vhost&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;connected stream, tcUrl=%s, pageUrl=%s, swfUrl=%s, schema=%s, vhost=%s, port=%d, app=%s, stream=%s, param=%s, args=%s&quot;</span>,</span><br><span class="line">        req-&gt;tcUrl.<span class="built_in">c_str</span>(), req-&gt;pageUrl.<span class="built_in">c_str</span>(), req-&gt;swfUrl.<span class="built_in">c_str</span>(), req-&gt;schema.<span class="built_in">c_str</span>(), req-&gt;vhost.<span class="built_in">c_str</span>(), req-&gt;port,</span><br><span class="line">        req-&gt;app.<span class="built_in">c_str</span>(), req-&gt;stream.<span class="built_in">c_str</span>(), req-&gt;param.<span class="built_in">c_str</span>(), (req-&gt;args? <span class="string">&quot;(obj)&quot;</span>:<span class="string">&quot;null&quot;</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// do token traverse before serve it.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/pull/239</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        info-&gt;edge = _srs_config-&gt;<span class="built_in">get_vhost_is_edge</span>(req-&gt;vhost);</span><br><span class="line">        <span class="type">bool</span> edge_traverse = _srs_config-&gt;<span class="built_in">get_vhost_edge_token_traverse</span>(req-&gt;vhost);</span><br><span class="line">        <span class="keyword">if</span> (info-&gt;edge &amp;&amp; edge_traverse) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((err = <span class="built_in">check_edge_token_traverse_auth</span>()) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: check token traverse&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// security check</span></span><br><span class="line">    <span class="keyword">if</span> ((err = security-&gt;<span class="built_in">check</span>(info-&gt;type, ip, req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: security check&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Never allow the empty stream name, for HLS may write to a file with empty name.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/834</span></span><br><span class="line">    <span class="keyword">if</span> (req-&gt;stream.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_RTMP_STREAM_NAME_EMPTY, <span class="string">&quot;rtmp: empty stream&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// client is identified, set the timeout to service timeout.</span></span><br><span class="line">    rtmp-&gt;<span class="built_in">set_recv_timeout</span>(SRS_CONSTS_RTMP_TIMEOUT);</span><br><span class="line">    rtmp-&gt;<span class="built_in">set_send_timeout</span>(SRS_CONSTS_RTMP_TIMEOUT);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// find a source to serve.</span></span><br><span class="line">    SrsLiveSource* source = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> ((err = _srs_sources-&gt;<span class="built_in">fetch_or_create</span>(req, server, &amp;source)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: fetch source&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">srs_assert</span>(source != <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> enabled_cache = _srs_config-&gt;<span class="built_in">get_gop_cache</span>(req-&gt;vhost);</span><br><span class="line">    <span class="type">int</span> gcmf = _srs_config-&gt;<span class="built_in">get_gop_cache_max_frames</span>(req-&gt;vhost);</span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;source url=%s, ip=%s, cache=%d/%d, is_edge=%d, source_id=%s/%s&quot;</span>,</span><br><span class="line">        req-&gt;<span class="built_in">get_stream_url</span>().<span class="built_in">c_str</span>(), </span><br><span class="line">              ip.<span class="built_in">c_str</span>(), </span><br><span class="line">              enabled_cache, </span><br><span class="line">              gcmf, </span><br><span class="line">              info-&gt;edge, </span><br><span class="line">              source-&gt;<span class="built_in">source_id</span>().<span class="built_in">c_str</span>(),</span><br><span class="line">              source-&gt;<span class="built_in">pre_source_id</span>().<span class="built_in">c_str</span>());</span><br><span class="line">    </span><br><span class="line">    source-&gt;<span class="built_in">set_cache</span>(enabled_cache);</span><br><span class="line">    source-&gt;<span class="built_in">set_gop_cache_max_frames</span>(gcmf);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (info-&gt;type) &#123;</span><br><span class="line">        <span class="keyword">case</span> SrsRtmpConnPlay: &#123;</span><br><span class="line">            <span class="comment">// response connection start play</span></span><br><span class="line">            <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">start_play</span>(info-&gt;res-&gt;stream_id)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: start play&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// We must do stat the client before hooks, because hooks depends on it.</span></span><br><span class="line">            SrsStatistic* stat = SrsStatistic::<span class="built_in">instance</span>();</span><br><span class="line">            <span class="keyword">if</span> ((err = stat-&gt;<span class="built_in">on_client</span>(_srs_context-&gt;<span class="built_in">get_id</span>().<span class="built_in">c_str</span>(), req, <span class="keyword">this</span>, info-&gt;type)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: stat client&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// We must do hook after stat, because depends on it.</span></span><br><span class="line">            <span class="keyword">if</span> ((err = <span class="built_in">http_hooks_on_play</span>()) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: callback on play&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">            <span class="comment">// Must be a client span.</span></span><br><span class="line">            span_client_-&gt;<span class="built_in">set_name</span>(<span class="string">&quot;play&quot;</span>)-&gt;<span class="built_in">end</span>();</span><br><span class="line">            <span class="comment">// We end the connection span because it&#x27;s a producer and only trace the established.</span></span><br><span class="line">            span_main_-&gt;<span class="built_in">end</span>();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            </span><br><span class="line">            err = <span class="built_in">playing</span>(source);</span><br><span class="line">            <span class="built_in">http_hooks_on_stop</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> SrsRtmpConnFMLEPublish: &#123;</span><br><span class="line">            <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">start_fmle_publish</span>(info-&gt;res-&gt;stream_id)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: start FMLE publish&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">            <span class="comment">// Must be a client span.</span></span><br><span class="line">            span_client_-&gt;<span class="built_in">set_name</span>(<span class="string">&quot;publish&quot;</span>)-&gt;<span class="built_in">end</span>();</span><br><span class="line">            <span class="comment">// We end the connection span because it&#x27;s a producer and only trace the established.</span></span><br><span class="line">            span_main_-&gt;<span class="built_in">end</span>();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">publishing</span>(source);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> SrsRtmpConnHaivisionPublish: &#123;</span><br><span class="line">            <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">start_haivision_publish</span>(info-&gt;res-&gt;stream_id)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: start HAIVISION publish&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">            <span class="comment">// Must be a client span.</span></span><br><span class="line">            span_client_-&gt;<span class="built_in">set_name</span>(<span class="string">&quot;publish&quot;</span>)-&gt;<span class="built_in">end</span>();</span><br><span class="line">            <span class="comment">// We end the connection span because it&#x27;s a producer and only trace the established.</span></span><br><span class="line">            span_main_-&gt;<span class="built_in">end</span>();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">publishing</span>(source);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> SrsRtmpConnFlashPublish: &#123;</span><br><span class="line">            <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">start_flash_publish</span>(info-&gt;res-&gt;stream_id)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: start FLASH publish&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">            <span class="comment">// Must be a client span.</span></span><br><span class="line">            span_client_-&gt;<span class="built_in">set_name</span>(<span class="string">&quot;publish&quot;</span>)-&gt;<span class="built_in">end</span>();</span><br><span class="line">            <span class="comment">// We end the connection span because it&#x27;s a producer and only trace the established.</span></span><br><span class="line">            span_main_-&gt;<span class="built_in">end</span>();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">publishing</span>(source);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_SYSTEM_CLIENT_INVALID, <span class="string">&quot;rtmp: unknown client type=%d&quot;</span>, info-&gt;type);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SrsRtmpConn-publishing"><a href="#SrsRtmpConn-publishing" class="headerlink" title="SrsRtmpConn::publishing()"></a>SrsRtmpConn::publishing()</h3><ul>
<li><code>SrsPublishRecvThread</code>接收推流数据协程，在<code>do_publishing</code>中启动。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::publishing</span><span class="params">(SrsLiveSource* source)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (_srs_config-&gt;<span class="built_in">get_refer_enabled</span>(req-&gt;vhost)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = refer-&gt;<span class="built_in">check</span>(req-&gt;pageUrl, _srs_config-&gt;<span class="built_in">get_refer_publish</span>(req-&gt;vhost))) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: referer check&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We must do stat the client before hooks, because hooks depends on it.</span></span><br><span class="line">    SrsStatistic* stat = SrsStatistic::<span class="built_in">instance</span>();</span><br><span class="line">    <span class="keyword">if</span> ((err = stat-&gt;<span class="built_in">on_client</span>(_srs_context-&gt;<span class="built_in">get_id</span>().<span class="built_in">c_str</span>(), req, <span class="keyword">this</span>, info-&gt;type)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: stat client&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We must do hook after stat, because depends on it.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">http_hooks_on_publish</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: callback on publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> Should refine the state of publishing.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">acquire_publish</span>(source)) == srs_success) &#123;</span><br><span class="line">        <span class="comment">// use isolate thread to recv,</span></span><br><span class="line">        <span class="comment">// @see: https://github.com/ossrs/srs/issues/237</span></span><br><span class="line">        <span class="function">SrsPublishRecvThread <span class="title">rtrd</span><span class="params">(rtmp, req, srs_netfd_fileno(stfd), <span class="number">0</span>, <span class="keyword">this</span>, source, _srs_context-&gt;get_id())</span></span>;</span><br><span class="line">        err = <span class="built_in">do_publishing</span>(source, &amp;rtrd);</span><br><span class="line">        rtrd.<span class="built_in">stop</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// whatever the acquire publish, always release publish.</span></span><br><span class="line">    <span class="comment">// when the acquire error in the midlle-way, the publish state changed,</span></span><br><span class="line">    <span class="comment">// but failed, so we must cleanup it.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/474</span></span><br><span class="line">    <span class="comment">// @remark when stream is busy, should never release it.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">srs_error_code</span>(err) != ERROR_SYSTEM_STREAM_BUSY) &#123;</span><br><span class="line">        <span class="built_in">release_publish</span>(source);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">http_hooks_on_unpublish</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SrsRtmpConn-do-publishing"><a href="#SrsRtmpConn-do-publishing" class="headerlink" title="SrsRtmpConn::do_publishing()"></a>SrsRtmpConn::do_publishing()</h3><ul>
<li><code>rtrd-&gt;start()</code>启动推流接收数据协程。</li>
<li><code>SrsStatistic</code>统计相关。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::do_publishing</span><span class="params">(SrsLiveSource* source, SrsPublishRecvThread* rtrd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    SrsPithyPrint* pprint = SrsPithyPrint::<span class="built_in">create_rtmp_publish</span>();</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsPithyPrint, pprint);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// start isolate recv thread.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> Pass the callback here.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = rtrd-&gt;<span class="built_in">start</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: receive thread&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// initialize the publish timeout.</span></span><br><span class="line">    publish_1stpkt_timeout = _srs_config-&gt;<span class="built_in">get_publish_1stpkt_timeout</span>(req-&gt;vhost);</span><br><span class="line">    publish_normal_timeout = _srs_config-&gt;<span class="built_in">get_publish_normal_timeout</span>(req-&gt;vhost);</span><br><span class="line">    <span class="type">srs_utime_t</span> publish_kickoff_for_idle = _srs_config-&gt;<span class="built_in">get_publish_kickoff_for_idle</span>(req-&gt;vhost);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// set the sock options.</span></span><br><span class="line">    <span class="built_in">set_sock_options</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="type">bool</span> mr = _srs_config-&gt;<span class="built_in">get_mr_enabled</span>(req-&gt;vhost);</span><br><span class="line">        <span class="type">srs_utime_t</span> mr_sleep = _srs_config-&gt;<span class="built_in">get_mr_sleep</span>(req-&gt;vhost);</span><br><span class="line">        <span class="built_in">srs_trace</span>(<span class="string">&quot;start publish mr=%d/%d, p1stpt=%d, pnt=%d, tcp_nodelay=%d&quot;</span>, </span><br><span class="line">                  mr, <span class="built_in">srsu2msi</span>(mr_sleep), <span class="built_in">srsu2msi</span>(publish_1stpkt_timeout), </span><br><span class="line">                  <span class="built_in">srsu2msi</span>(publish_normal_timeout), tcp_nodelay);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">    ISrsApmSpan* span = _srs_apm-&gt;<span class="built_in">span</span>(<span class="string">&quot;publish-cycle&quot;</span>)-&gt;<span class="built_in">set_kind</span>(SrsApmKindProducer)-&gt;<span class="built_in">as_child</span>(span_client_)</span><br><span class="line">        -&gt;<span class="built_in">attr</span>(<span class="string">&quot;timeout&quot;</span>, <span class="built_in">srs_fmt</span>(<span class="string">&quot;%d&quot;</span>, <span class="built_in">srsu2msi</span>(publish_normal_timeout)))-&gt;<span class="built_in">end</span>();</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(ISrsApmSpan, span);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="type">int64_t</span> nb_msgs = <span class="number">0</span>;</span><br><span class="line">    <span class="type">uint64_t</span> nb_frames = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: thread quit&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Kick off the publisher when idle for a period of timeout.</span></span><br><span class="line">        <span class="keyword">if</span> (source-&gt;<span class="built_in">publisher_is_idle_for</span>(publish_kickoff_for_idle)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_KICKOFF_FOR_IDLE, <span class="string">&quot;kicked for idle, url=%s, timeout=%ds&quot;</span>, </span><br><span class="line">                                 req-&gt;tcUrl.<span class="built_in">c_str</span>(), <span class="built_in">srsu2si</span>(publish_kickoff_for_idle));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pprint-&gt;<span class="built_in">elapse</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// cond wait for timeout.</span></span><br><span class="line">        <span class="keyword">if</span> (nb_msgs == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// when not got msgs, wait for a larger timeout.</span></span><br><span class="line">            rtrd-&gt;<span class="built_in">wait</span>(publish_1stpkt_timeout);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            rtrd-&gt;<span class="built_in">wait</span>(publish_normal_timeout);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// check the thread error code.</span></span><br><span class="line">        <span class="keyword">if</span> ((err = rtrd-&gt;<span class="built_in">error_code</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: receive thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// when not got any messages, timeout.</span></span><br><span class="line">        <span class="keyword">if</span> (rtrd-&gt;<span class="built_in">nb_msgs</span>() &lt;= nb_msgs) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_SOCKET_TIMEOUT, <span class="string">&quot;rtmp: publish timeout %dms, nb_msgs=%d&quot;</span>,</span><br><span class="line">                nb_msgs? <span class="built_in">srsu2msi</span>(publish_normal_timeout) : <span class="built_in">srsu2msi</span>(publish_1stpkt_timeout), (<span class="type">int</span>)nb_msgs);</span><br><span class="line">        &#125;</span><br><span class="line">        nb_msgs = rtrd-&gt;<span class="built_in">nb_msgs</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Update the stat for video fps.</span></span><br><span class="line">        <span class="comment">// @remark https://github.com/ossrs/srs/issues/851</span></span><br><span class="line">        SrsStatistic* stat = SrsStatistic::<span class="built_in">instance</span>();</span><br><span class="line">        <span class="keyword">if</span> ((err = stat-&gt;<span class="built_in">on_video_frames</span>(req, (<span class="type">int</span>)(rtrd-&gt;<span class="built_in">nb_video_frames</span>() - nb_frames))) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: stat video frames&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        nb_frames = rtrd-&gt;<span class="built_in">nb_video_frames</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// reportable</span></span><br><span class="line">        <span class="keyword">if</span> (pprint-&gt;<span class="built_in">can_print</span>()) &#123;</span><br><span class="line">            kbps-&gt;<span class="built_in">sample</span>();</span><br><span class="line">            <span class="type">bool</span> mr = _srs_config-&gt;<span class="built_in">get_mr_enabled</span>(req-&gt;vhost);</span><br><span class="line">            <span class="type">srs_utime_t</span> mr_sleep = _srs_config-&gt;<span class="built_in">get_mr_sleep</span>(req-&gt;vhost);</span><br><span class="line">            <span class="built_in">srs_trace</span>(<span class="string">&quot;&lt;- &quot;</span> SRS_CONSTS_LOG_CLIENT_PUBLISH <span class="string">&quot; time=%d, okbps=%d,%d,%d, ikbps=%d,%d,%d, mr=%d/%d, p1stpt=%d, pnt=%d&quot;</span>,</span><br><span class="line">                (<span class="type">int</span>)pprint-&gt;<span class="built_in">age</span>(), kbps-&gt;<span class="built_in">get_send_kbps</span>(), kbps-&gt;<span class="built_in">get_send_kbps_30s</span>(), kbps-&gt;<span class="built_in">get_send_kbps_5m</span>(),</span><br><span class="line">                kbps-&gt;<span class="built_in">get_recv_kbps</span>(), kbps-&gt;<span class="built_in">get_recv_kbps_30s</span>(), kbps-&gt;<span class="built_in">get_recv_kbps_5m</span>(), mr, <span class="built_in">srsu2msi</span>(mr_sleep),</span><br><span class="line">                <span class="built_in">srsu2msi</span>(publish_1stpkt_timeout), <span class="built_in">srsu2msi</span>(publish_normal_timeout));</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Do not use pithy print for frame span.</span></span><br><span class="line">            ISrsApmSpan* sample = _srs_apm-&gt;<span class="built_in">span</span>(<span class="string">&quot;publish-frame&quot;</span>)-&gt;<span class="built_in">set_kind</span>(SrsApmKindConsumer)-&gt;<span class="built_in">as_child</span>(span)</span><br><span class="line">                -&gt;<span class="built_in">attr</span>(<span class="string">&quot;msgs&quot;</span>, <span class="built_in">srs_fmt</span>(<span class="string">&quot;%&quot;</span> PRId64, nb_frames))-&gt;<span class="built_in">attr</span>(<span class="string">&quot;kbps&quot;</span>, <span class="built_in">srs_fmt</span>(<span class="string">&quot;%d&quot;</span>, kbps-&gt;<span class="built_in">get_recv_kbps_30s</span>()));</span><br><span class="line">            <span class="built_in">srs_freep</span>(sample);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RTMP数据接收协程"><a href="#RTMP数据接收协程" class="headerlink" title="RTMP数据接收协程"></a>RTMP数据接收协程</h2><ul>
<li>断点：<code>b SrsLiveSource::on_video_imp(SrsSharedPtrMessage*)</code>，查看堆栈。</li>
</ul>
<img src="/2023/10/29/SRS-RTMP/断点SrsLiveSource-on_video_imp.png" alt="断点SrsLiveSource-on_video_imp" style="zoom:50%;">

<h3 id="SrsPublishRecvThread-start"><a href="#SrsPublishRecvThread-start" class="headerlink" title="SrsPublishRecvThread::start()"></a>SrsPublishRecvThread::start()</h3><ul>
<li>启动接收协程，协程函数<code>SrsRecvThread::do_cycle()</code>。</li>
<li><code>pumper-&gt;consume()</code>，具体处理数据。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsPublishRecvThread::start</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = trd.<span class="built_in">start</span>()) != srs_success) &#123;</span><br><span class="line">        err = <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;publish recv thread&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ncid = cid = trd.<span class="built_in">cid</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SrsRecvThread-do-cycle"><a href="#SrsRecvThread-do-cycle" class="headerlink" title="SrsRecvThread::do_cycle()"></a>SrsRecvThread::do_cycle()</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRecvThread::do_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When the pumper is interrupted, wait then retry.</span></span><br><span class="line">        <span class="keyword">if</span> (pumper-&gt;<span class="built_in">interrupted</span>()) &#123;</span><br><span class="line">            <span class="built_in">srs_usleep</span>(timeout);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        SrsCommonMessage* msg = <span class="literal">NULL</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Process the received message.</span></span><br><span class="line">        <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">recv_message</span>(&amp;msg)) == srs_success) &#123;</span><br><span class="line">            err = pumper-&gt;<span class="built_in">consume</span>(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (err != srs_success) &#123;</span><br><span class="line">            <span class="comment">// Interrupt the receive thread for any error.</span></span><br><span class="line">            trd-&gt;<span class="built_in">interrupt</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Notify the pumper to quit for error.</span></span><br><span class="line">            pumper-&gt;<span class="built_in">interrupt</span>(err);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br></pre></td></tr></table></figure>

<h3 id="SrsPublishRecvThread-consume"><a href="#SrsPublishRecvThread-consume" class="headerlink" title="SrsPublishRecvThread::consume()"></a>SrsPublishRecvThread::consume()</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsPublishRecvThread::consume</span><span class="params">(SrsCommonMessage* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// when cid changed, change it.</span></span><br><span class="line">    <span class="keyword">if</span> (ncid.<span class="built_in">compare</span>(cid)) &#123;</span><br><span class="line">        _srs_context-&gt;<span class="built_in">set_id</span>(ncid);</span><br><span class="line">        cid = ncid;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    _nb_msgs++;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;header.<span class="built_in">is_video</span>()) &#123;</span><br><span class="line">        video_frames++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// log to show the time of recv thread.</span></span><br><span class="line">    <span class="built_in">srs_verbose</span>(<span class="string">&quot;recv thread now=%&quot;</span> PRId64 <span class="string">&quot;us, got msg time=%&quot;</span> PRId64 <span class="string">&quot;ms, size=%d&quot;</span>,</span><br><span class="line">                <span class="built_in">srs_update_system_time</span>(), msg-&gt;header.timestamp, msg-&gt;size);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// the rtmp connection will handle this message</span></span><br><span class="line">    err = _conn-&gt;<span class="built_in">handle_publish_message</span>(_source, msg);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// must always free it,</span></span><br><span class="line">    <span class="comment">// the source will copy it if need to use.</span></span><br><span class="line">    <span class="built_in">srs_freep</span>(msg);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (err != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;handle publish message&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Yield to another coroutines.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/2194#issuecomment-777463768</span></span><br><span class="line">    <span class="keyword">if</span> (++nn_msgs_for_yield_ &gt;= <span class="number">15</span>) &#123;</span><br><span class="line">        nn_msgs_for_yield_ = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">srs_thread_yield</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SrsRtmpConn-handle-publish-message"><a href="#SrsRtmpConn-handle-publish-message" class="headerlink" title="SrsRtmpConn::handle_publish_message()"></a>SrsRtmpConn::handle_publish_message()</h3><ul>
<li><code>process_publish_message()</code>用于处理媒体数据。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::handle_publish_message</span><span class="params">(SrsLiveSource* source, SrsCommonMessage* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// process publish event.</span></span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;header.<span class="built_in">is_amf0_command</span>() || msg-&gt;header.<span class="built_in">is_amf3_command</span>()) &#123;</span><br><span class="line">        SrsPacket* pkt = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">decode_message</span>(msg, &amp;pkt)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: decode message&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(SrsPacket, pkt);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// for flash, any packet is republish.</span></span><br><span class="line">        <span class="keyword">if</span> (info-&gt;type == SrsRtmpConnFlashPublish) &#123;</span><br><span class="line">            <span class="comment">// flash unpublish.</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> maybe need to support republish.</span></span><br><span class="line">            <span class="built_in">srs_trace</span>(<span class="string">&quot;flash flash publish finished.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_CONTROL_REPUBLISH, <span class="string">&quot;rtmp: republish&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// for fmle, drop others except the fmle start packet.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">dynamic_cast</span>&lt;SrsFMLEStartPacket*&gt;(pkt)) &#123;</span><br><span class="line">            SrsFMLEStartPacket* unpublish = <span class="built_in">dynamic_cast</span>&lt;SrsFMLEStartPacket*&gt;(pkt);</span><br><span class="line">            <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">fmle_unpublish</span>(info-&gt;res-&gt;stream_id, unpublish-&gt;transaction_id)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: republish&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_CONTROL_REPUBLISH, <span class="string">&quot;rtmp: republish&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">srs_trace</span>(<span class="string">&quot;fmle ignore AMF0/AMF3 command message.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// video, audio, data message</span></span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">process_publish_message</span>(source, msg)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: consume message&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SrsLiveSource-on-video"><a href="#SrsLiveSource-on-video" class="headerlink" title="SrsLiveSource::on_video()"></a>SrsLiveSource::on_video()</h3><ul>
<li>以视频处理为例。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsLiveSource::on_video</span><span class="params">(SrsCommonMessage* shared_video)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Detect where stream is monotonically increasing.</span></span><br><span class="line">    <span class="keyword">if</span> (!mix_correct &amp;&amp; is_monotonically_increase) &#123;</span><br><span class="line">        <span class="keyword">if</span> (last_packet_time &gt; <span class="number">0</span> &amp;&amp; shared_video-&gt;header.timestamp &lt; last_packet_time) &#123;</span><br><span class="line">            is_monotonically_increase = <span class="literal">false</span>;</span><br><span class="line">            <span class="built_in">srs_warn</span>(<span class="string">&quot;VIDEO: Timestamp %&quot;</span> PRId64 <span class="string">&quot;=&gt;%&quot;</span> PRId64 <span class="string">&quot;, may need mix_correct.&quot;</span>,</span><br><span class="line">                     last_packet_time, shared_video-&gt;header.timestamp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    last_packet_time = shared_video-&gt;header.timestamp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// drop any unknown header video.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/421</span></span><br><span class="line">    <span class="keyword">if</span> (!SrsFlvVideo::<span class="built_in">acceptable</span>(shared_video-&gt;payload, shared_video-&gt;size)) &#123;</span><br><span class="line">        <span class="type">char</span> b0 = <span class="number">0x00</span>;</span><br><span class="line">        <span class="keyword">if</span> (shared_video-&gt;size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            b0 = shared_video-&gt;payload[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">srs_warn</span>(<span class="string">&quot;drop unknown header video, size=%d, bytes[0]=%#x&quot;</span>, shared_video-&gt;size, b0);</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// convert shared_video to msg, user should not use shared_video again.</span></span><br><span class="line">    <span class="comment">// the payload is transfer to msg, and set to NULL in shared_video.</span></span><br><span class="line">    SrsSharedPtrMessage msg;</span><br><span class="line">    <span class="keyword">if</span> ((err = msg.<span class="built_in">create</span>(shared_video)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;create message&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">on_frame</span>(&amp;msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SrsLiveSource-on-frame"><a href="#SrsLiveSource-on-frame" class="headerlink" title="SrsLiveSource::on_frame()"></a>SrsLiveSource::on_frame()</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsLiveSource::on_frame</span><span class="params">(SrsSharedPtrMessage* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// directly process the audio message.</span></span><br><span class="line">    <span class="keyword">if</span> (!mix_correct) &#123;</span><br><span class="line">        <span class="keyword">if</span> (msg-&gt;<span class="built_in">is_audio</span>()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">on_audio_imp</span>(msg);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">on_video_imp</span>(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// insert msg to the queue.</span></span><br><span class="line">    mix_queue-&gt;<span class="built_in">push</span>(msg-&gt;<span class="built_in">copy</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// fetch someone from mix queue.</span></span><br><span class="line">    SrsSharedPtrMessage* m = mix_queue-&gt;<span class="built_in">pop</span>();</span><br><span class="line">    <span class="keyword">if</span> (!m) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// consume the monotonically increase message.</span></span><br><span class="line">    <span class="keyword">if</span> (m-&gt;<span class="built_in">is_audio</span>()) &#123;</span><br><span class="line">        err = <span class="built_in">on_audio_imp</span>(m);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        err = <span class="built_in">on_video_imp</span>(m);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">srs_freep</span>(m);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SrsLiveSource-on-video-imp"><a href="#SrsLiveSource-on-video-imp" class="headerlink" title="SrsLiveSource::on_video_imp()"></a>SrsLiveSource::on_video_imp()</h3><ul>
<li><code>consumer-&gt;enqueue()</code>拷贝数据给拉流消费者。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsLiveSource::on_video_imp</span><span class="params">(SrsSharedPtrMessage* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> is_sequence_header = SrsFlvVideo::<span class="built_in">sh</span>(msg-&gt;payload, msg-&gt;size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// user can disable the sps parse to workaround when parse sps failed.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/474</span></span><br><span class="line">    <span class="keyword">if</span> (is_sequence_header) &#123;</span><br><span class="line">        format_-&gt;avc_parse_sps = _srs_config-&gt;<span class="built_in">get_parse_sps</span>(req-&gt;vhost);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((err = format_-&gt;<span class="built_in">on_video</span>(msg)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;format consume video&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Ignore if no format-&gt;vcodec, it means the codec is not parsed, or unsupport/unknown codec</span></span><br><span class="line">    <span class="comment">// such as H.263 codec</span></span><br><span class="line">    <span class="keyword">if</span> (!format_-&gt;vcodec) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// whether consumer should drop for the duplicated sequence header.</span></span><br><span class="line">    <span class="type">bool</span> drop_for_reduce = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (is_sequence_header &amp;&amp; meta-&gt;<span class="built_in">previous_vsh</span>() &amp;&amp; _srs_config-&gt;<span class="built_in">get_reduce_sequence_header</span>(req-&gt;vhost)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (meta-&gt;<span class="built_in">previous_vsh</span>()-&gt;size == msg-&gt;size) &#123;</span><br><span class="line">            drop_for_reduce = <span class="built_in">srs_bytes_equals</span>(meta-&gt;<span class="built_in">previous_vsh</span>()-&gt;payload, msg-&gt;payload, msg-&gt;size);</span><br><span class="line">            <span class="built_in">srs_warn</span>(<span class="string">&quot;drop for reduce sh video, size=%d&quot;</span>, msg-&gt;size);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cache the sequence header if h264</span></span><br><span class="line">    <span class="comment">// donot cache the sequence header to gop_cache, return here.</span></span><br><span class="line">    <span class="keyword">if</span> (is_sequence_header &amp;&amp; (err = meta-&gt;<span class="built_in">update_vsh</span>(msg)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;meta update video&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Copy to hub to all utilities.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = hub-&gt;<span class="built_in">on_video</span>(msg, is_sequence_header)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hub consume video&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// For bridge to consume the message.</span></span><br><span class="line">    <span class="keyword">if</span> (bridge_ &amp;&amp; (err = bridge_-&gt;<span class="built_in">on_frame</span>(msg)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;bridge consume video&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// copy to all consumer</span></span><br><span class="line">    <span class="keyword">if</span> (!drop_for_reduce) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; (<span class="type">int</span>)consumers.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            SrsLiveConsumer* consumer = consumers.<span class="built_in">at</span>(i);</span><br><span class="line">            <span class="keyword">if</span> ((err = consumer-&gt;<span class="built_in">enqueue</span>(msg, atc, jitter_algorithm)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;consume video&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// when sequence header, donot push to gop cache and adjust the timestamp.</span></span><br><span class="line">    <span class="keyword">if</span> (is_sequence_header) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cache the last gop packets</span></span><br><span class="line">    <span class="keyword">if</span> ((err = gop_cache-&gt;<span class="built_in">cache</span>(msg)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;gop cache consume vdieo&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if atc, update the sequence header to abs time.</span></span><br><span class="line">    <span class="keyword">if</span> (atc) &#123;</span><br><span class="line">        <span class="keyword">if</span> (meta-&gt;<span class="built_in">vsh</span>()) &#123;</span><br><span class="line">            meta-&gt;<span class="built_in">vsh</span>()-&gt;timestamp = msg-&gt;timestamp;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (meta-&gt;<span class="built_in">data</span>()) &#123;</span><br><span class="line">            meta-&gt;<span class="built_in">data</span>()-&gt;timestamp = msg-&gt;timestamp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="RTMP拉流端"><a href="#RTMP拉流端" class="headerlink" title="RTMP拉流端"></a>RTMP拉流端</h1><h2 id="SrsRtmpConn-playing"><a href="#SrsRtmpConn-playing" class="headerlink" title="SrsRtmpConn::playing()"></a>SrsRtmpConn::playing()</h2><ul>
<li><code>SrsQueueRecvThread</code>接收拉流端命令。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::playing</span><span class="params">(SrsLiveSource* source)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Check page referer of player.</span></span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    <span class="keyword">if</span> (_srs_config-&gt;<span class="built_in">get_refer_enabled</span>(req-&gt;vhost)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = refer-&gt;<span class="built_in">check</span>(req-&gt;pageUrl, _srs_config-&gt;<span class="built_in">get_refer_play</span>(req-&gt;vhost))) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: referer check&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// When origin cluster enabled, try to redirect to the origin which is active.</span></span><br><span class="line">    <span class="comment">// A active origin is a server which is delivering stream.</span></span><br><span class="line">    <span class="keyword">if</span> (!info-&gt;edge &amp;&amp; _srs_config-&gt;<span class="built_in">get_vhost_origin_cluster</span>(req-&gt;vhost) &amp;&amp; source-&gt;<span class="built_in">inactive</span>()) &#123;</span><br><span class="line">        vector&lt;string&gt; coworkers = _srs_config-&gt;<span class="built_in">get_vhost_coworkers</span>(req-&gt;vhost);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; (<span class="type">int</span>)coworkers.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> User may config the server itself as coworker, we must identify and ignore it.</span></span><br><span class="line">            string host; <span class="type">int</span> port = <span class="number">0</span>; string coworker = coworkers.<span class="built_in">at</span>(i);</span><br><span class="line"></span><br><span class="line">            string url = <span class="string">&quot;http://&quot;</span> + coworker + <span class="string">&quot;/api/v1/clusters?&quot;</span></span><br><span class="line">                + <span class="string">&quot;vhost=&quot;</span> + req-&gt;vhost + <span class="string">&quot;&amp;ip=&quot;</span> + req-&gt;host + <span class="string">&quot;&amp;app=&quot;</span> + req-&gt;app + <span class="string">&quot;&amp;stream=&quot;</span> + req-&gt;stream</span><br><span class="line">                + <span class="string">&quot;&amp;coworker=&quot;</span> + coworker;</span><br><span class="line">            <span class="keyword">if</span> ((err = SrsHttpHooks::<span class="built_in">discover_co_workers</span>(url, host, port)) != srs_success) &#123;</span><br><span class="line">                <span class="comment">// If failed to discovery stream in this coworker, we should request the next one util the last.</span></span><br><span class="line">                <span class="comment">// @see https://github.com/ossrs/srs/issues/1223</span></span><br><span class="line">                <span class="keyword">if</span> (i &lt; (<span class="type">int</span>)coworkers.<span class="built_in">size</span>() - <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;discover coworkers, url=%s&quot;</span>, url.<span class="built_in">c_str</span>());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            string rurl = <span class="built_in">srs_generate_rtmp_url</span>(host, port, req-&gt;host, req-&gt;vhost, req-&gt;app, req-&gt;stream, req-&gt;param);</span><br><span class="line">            <span class="built_in">srs_trace</span>(<span class="string">&quot;rtmp: redirect in cluster, from=%s:%d, target=%s:%d, url=%s, rurl=%s&quot;</span>,</span><br><span class="line">                req-&gt;host.<span class="built_in">c_str</span>(), req-&gt;port, host.<span class="built_in">c_str</span>(), port, url.<span class="built_in">c_str</span>(), rurl.<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Ignore if host or port is invalid.</span></span><br><span class="line">            <span class="keyword">if</span> (host.<span class="built_in">empty</span>() || port == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="type">bool</span> accepted = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">redirect</span>(req, rurl, accepted)) != srs_success) &#123;</span><br><span class="line">                <span class="built_in">srs_error_reset</span>(err);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_CONTROL_REDIRECT, <span class="string">&quot;redirected&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_OCLUSTER_REDIRECT, <span class="string">&quot;no origin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Set the socket options for transport.</span></span><br><span class="line">    <span class="built_in">set_sock_options</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Create a consumer of source.</span></span><br><span class="line">    SrsLiveConsumer* consumer = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsLiveConsumer, consumer);</span><br><span class="line">    <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">create_consumer</span>(consumer)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: create consumer&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">consumer_dumps</span>(consumer)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: dumps consumer&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Use receiving thread to receive packets from peer.</span></span><br><span class="line">    <span class="function">SrsQueueRecvThread <span class="title">trd</span><span class="params">(consumer, rtmp, SRS_PERF_MW_SLEEP, _srs_context-&gt;get_id())</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = trd.<span class="built_in">start</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: start receive thread&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Deliver packets to peer.</span></span><br><span class="line">    wakable = consumer;</span><br><span class="line">    err = <span class="built_in">do_playing</span>(source, consumer, &amp;trd);</span><br><span class="line">    wakable = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    trd.<span class="built_in">stop</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Drop all packets in receiving thread.</span></span><br><span class="line">    <span class="keyword">if</span> (!trd.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="built_in">srs_warn</span>(<span class="string">&quot;drop the received %d messages&quot;</span>, trd.<span class="built_in">size</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>process_play_control_msg()</code>处理拉流端对应的客户端命令。</li>
<li><code>consumer-&gt;dump_packets()</code>获取音视频数据。</li>
<li><code>rtmp-&gt;send_and_free_messages()</code>发送音视频数据给客户端。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::do_playing</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    SrsLiveSource* source, SrsLiveConsumer* consumer, SrsQueueRecvThread* rtrd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    <span class="built_in">srs_assert</span>(req);</span><br><span class="line">    <span class="built_in">srs_assert</span>(consumer);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// initialize other components</span></span><br><span class="line">    SrsPithyPrint* pprint = SrsPithyPrint::<span class="built_in">create_rtmp_play</span>();</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsPithyPrint, pprint);</span><br><span class="line">    </span><br><span class="line">    <span class="function">SrsMessageArray <span class="title">msgs</span><span class="params">(SRS_PERF_MW_MSGS)</span></span>;</span><br><span class="line">    <span class="type">bool</span> user_specified_duration_to_stop = (req-&gt;duration &gt; <span class="number">0</span>);</span><br><span class="line">    <span class="type">int64_t</span> starttime = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// setup the realtime.</span></span><br><span class="line">    realtime = _srs_config-&gt;<span class="built_in">get_realtime_enabled</span>(req-&gt;vhost);</span><br><span class="line">    <span class="comment">// setup the mw config.</span></span><br><span class="line">    <span class="comment">// when mw_sleep changed, resize the socket send buffer.</span></span><br><span class="line">    mw_msgs = _srs_config-&gt;<span class="built_in">get_mw_msgs</span>(req-&gt;vhost, realtime);</span><br><span class="line">    mw_sleep = _srs_config-&gt;<span class="built_in">get_mw_sleep</span>(req-&gt;vhost);</span><br><span class="line">    skt-&gt;<span class="built_in">set_socket_buffer</span>(mw_sleep);</span><br><span class="line">    <span class="comment">// initialize the send_min_interval</span></span><br><span class="line">    send_min_interval = _srs_config-&gt;<span class="built_in">get_send_min_interval</span>(req-&gt;vhost);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;start play smi=%dms, mw_sleep=%d, mw_msgs=%d, realtime=%d, tcp_nodelay=%d&quot;</span>,</span><br><span class="line">        <span class="built_in">srsu2msi</span>(send_min_interval), <span class="built_in">srsu2msi</span>(mw_sleep), mw_msgs, realtime, tcp_nodelay);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">    ISrsApmSpan* span = _srs_apm-&gt;<span class="built_in">span</span>(<span class="string">&quot;play-cycle&quot;</span>)-&gt;<span class="built_in">set_kind</span>(SrsApmKindProducer)-&gt;<span class="built_in">as_child</span>(span_client_)</span><br><span class="line">        -&gt;<span class="built_in">attr</span>(<span class="string">&quot;realtime&quot;</span>, <span class="built_in">srs_fmt</span>(<span class="string">&quot;%d&quot;</span>, realtime))-&gt;<span class="built_in">end</span>();</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(ISrsApmSpan, span);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">// when source is set to expired, disconnect it.</span></span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: thread quit&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// collect elapse for pithy print.</span></span><br><span class="line">        pprint-&gt;<span class="built_in">elapse</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// to use isolate thread to recv, can improve about 33% performance.</span></span><br><span class="line">        <span class="keyword">while</span> (!rtrd-&gt;<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            SrsCommonMessage* msg = rtrd-&gt;<span class="built_in">pump</span>();</span><br><span class="line">            <span class="keyword">if</span> ((err = <span class="built_in">process_play_control_msg</span>(consumer, msg)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: play control message&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// quit when recv thread error.</span></span><br><span class="line">        <span class="keyword">if</span> ((err = rtrd-&gt;<span class="built_in">error_code</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: recv thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_PERF_QUEUE_COND_WAIT</span></span><br><span class="line">        <span class="comment">// wait for message to incoming.</span></span><br><span class="line">        <span class="comment">// @see https://github.com/ossrs/srs/issues/257</span></span><br><span class="line">        consumer-&gt;<span class="built_in">wait</span>(mw_msgs, mw_sleep);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// get messages from consumer.</span></span><br><span class="line">        <span class="comment">// each msg in msgs.msgs must be free, for the SrsMessageArray never free them.</span></span><br><span class="line">        <span class="comment">// @remark when enable send_min_interval, only fetch one message a time.</span></span><br><span class="line">        <span class="type">int</span> count = (send_min_interval &gt; <span class="number">0</span>)? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = consumer-&gt;<span class="built_in">dump_packets</span>(&amp;msgs, count)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: consumer dump packets&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// reportable</span></span><br><span class="line">        <span class="keyword">if</span> (pprint-&gt;<span class="built_in">can_print</span>()) &#123;</span><br><span class="line">            kbps-&gt;<span class="built_in">sample</span>();</span><br><span class="line">            <span class="built_in">srs_trace</span>(<span class="string">&quot;-&gt; &quot;</span> SRS_CONSTS_LOG_PLAY <span class="string">&quot; time=%d, msgs=%d, okbps=%d,%d,%d, ikbps=%d,%d,%d, mw=%d/%d&quot;</span>,</span><br><span class="line">                (<span class="type">int</span>)pprint-&gt;<span class="built_in">age</span>(), count, kbps-&gt;<span class="built_in">get_send_kbps</span>(), kbps-&gt;<span class="built_in">get_send_kbps_30s</span>(), kbps-&gt;<span class="built_in">get_send_kbps_5m</span>(),</span><br><span class="line">                kbps-&gt;<span class="built_in">get_recv_kbps</span>(), kbps-&gt;<span class="built_in">get_recv_kbps_30s</span>(), kbps-&gt;<span class="built_in">get_recv_kbps_5m</span>(), <span class="built_in">srsu2msi</span>(mw_sleep), mw_msgs);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_APM</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Do not use pithy print for frame span.</span></span><br><span class="line">            ISrsApmSpan* sample = _srs_apm-&gt;<span class="built_in">span</span>(<span class="string">&quot;play-frame&quot;</span>)-&gt;<span class="built_in">set_kind</span>(SrsApmKindConsumer)-&gt;<span class="built_in">as_child</span>(span)</span><br><span class="line">                -&gt;<span class="built_in">attr</span>(<span class="string">&quot;msgs&quot;</span>, <span class="built_in">srs_fmt</span>(<span class="string">&quot;%d&quot;</span>, count))-&gt;<span class="built_in">attr</span>(<span class="string">&quot;kbps&quot;</span>, <span class="built_in">srs_fmt</span>(<span class="string">&quot;%d&quot;</span>, kbps-&gt;<span class="built_in">get_send_kbps_30s</span>()));</span><br><span class="line">            <span class="built_in">srs_freep</span>(sample);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> SRS_PERF_QUEUE_COND_WAIT</span></span><br><span class="line">            <span class="built_in">srs_usleep</span>(mw_sleep);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            <span class="comment">// ignore when nothing got.</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// only when user specifies the duration,</span></span><br><span class="line">        <span class="comment">// we start to collect the durations for each message.</span></span><br><span class="line">        <span class="keyword">if</span> (user_specified_duration_to_stop) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">                SrsSharedPtrMessage* msg = msgs.msgs[i];</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// foreach msg, collect the duration.</span></span><br><span class="line">                <span class="comment">// @remark: never use msg when sent it, for the protocol sdk will free it.</span></span><br><span class="line">                <span class="keyword">if</span> (starttime &lt; <span class="number">0</span> || starttime &gt; msg-&gt;timestamp) &#123;</span><br><span class="line">                    starttime = msg-&gt;timestamp;</span><br><span class="line">                &#125;</span><br><span class="line">                duration += (msg-&gt;timestamp - starttime) * SRS_UTIME_MILLISECONDS;</span><br><span class="line">                starttime = msg-&gt;timestamp;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// sendout messages, all messages are freed by send_and_free_messages().</span></span><br><span class="line">        <span class="comment">// no need to assert msg, for the rtmp will assert it.</span></span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span> &amp;&amp; (err = rtmp-&gt;<span class="built_in">send_and_free_messages</span>(msgs.msgs, count, info-&gt;res-&gt;stream_id)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: send %d messages&quot;</span>, count);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// if duration specified, and exceed it, stop play live.</span></span><br><span class="line">        <span class="comment">// @see: https://github.com/ossrs/srs/issues/45</span></span><br><span class="line">        <span class="keyword">if</span> (user_specified_duration_to_stop) &#123;</span><br><span class="line">            <span class="keyword">if</span> (duration &gt;= req-&gt;duration) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_RTMP_DURATION_EXCEED, <span class="string">&quot;rtmp: time %d up %d&quot;</span>, <span class="built_in">srsu2msi</span>(duration), <span class="built_in">srsu2msi</span>(req-&gt;duration));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// apply the minimal interval for delivery stream in srs_utime_t.</span></span><br><span class="line">        <span class="keyword">if</span> (send_min_interval &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">srs_usleep</span>(send_min_interval);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Yield to another coroutines.</span></span><br><span class="line">        <span class="comment">// @see https://github.com/ossrs/srs/issues/2194#issuecomment-777437476</span></span><br><span class="line">        <span class="built_in">srs_thread_yield</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SrsQueueRecvThread-start"><a href="#SrsQueueRecvThread-start" class="headerlink" title="SrsQueueRecvThread::start()"></a>SrsQueueRecvThread::start()</h2><ul>
<li>启动接收协程，协程函数<code>SrsRecvThread::do_cycle()</code>。</li>
<li><code>pumper-&gt;consume()</code>，具体处理数据。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsQueueRecvThread::start</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = trd.<span class="built_in">start</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;queue recv thread&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRecvThread::do_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When the pumper is interrupted, wait then retry.</span></span><br><span class="line">        <span class="keyword">if</span> (pumper-&gt;<span class="built_in">interrupted</span>()) &#123;</span><br><span class="line">            <span class="built_in">srs_usleep</span>(timeout);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        SrsCommonMessage* msg = <span class="literal">NULL</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Process the received message.</span></span><br><span class="line">        <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">recv_message</span>(&amp;msg)) == srs_success) &#123;</span><br><span class="line">            err = pumper-&gt;<span class="built_in">consume</span>(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (err != srs_success) &#123;</span><br><span class="line">            <span class="comment">// Interrupt the receive thread for any error.</span></span><br><span class="line">            trd-&gt;<span class="built_in">interrupt</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Notify the pumper to quit for error.</span></span><br><span class="line">            pumper-&gt;<span class="built_in">interrupt</span>(err);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SrsQueueRecvThread-consume"><a href="#SrsQueueRecvThread-consume" class="headerlink" title="SrsQueueRecvThread::consume()"></a>SrsQueueRecvThread::consume()</h2><ul>
<li>接收数据后存放到队列中，具体<code>SrsRtmpConn::process_play_control_msg</code>处理。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsQueueRecvThread::consume</span><span class="params">(SrsCommonMessage* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// put into queue, the send thread will get and process it,</span></span><br><span class="line">    <span class="comment">// @see SrsRtmpConn::process_play_control_msg</span></span><br><span class="line">    queue.<span class="built_in">push_back</span>(msg);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_PERF_QUEUE_COND_WAIT</span></span><br><span class="line">    <span class="keyword">if</span> (_consumer) &#123;</span><br><span class="line">        _consumer-&gt;<span class="built_in">wakeup</span>();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> srs_success;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/10/28/SRS%E9%85%8D%E7%BD%AE%E6%94%AF%E6%8C%81WebRTC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/28/SRS%E9%85%8D%E7%BD%AE%E6%94%AF%E6%8C%81WebRTC/" class="post-title-link" itemprop="url">SRS配置支持WebRTC</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-10-28 21:32:53" itemprop="dateCreated datePublished" datetime="2023-10-28T21:32:53+08:00">2023-10-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-12-30 22:37:16" itemprop="dateModified" datetime="2023-12-30T22:37:16+08:00">2023-12-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SRS/" itemprop="url" rel="index"><span itemprop="name">SRS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="SRS环境搭建"><a href="#SRS环境搭建" class="headerlink" title="SRS环境搭建"></a>SRS环境搭建</h1><p>SRS官⽹：<a target="_blank" rel="noopener" href="http://www.ossrs.net/">http://www.ossrs.net/</a></p>
<p>官⽅Wiki：<a target="_blank" rel="noopener" href="https://ossrs.net/lts/zh-cn/docs/v5/tutorial/srs-server">https://ossrs.net/lts/zh-cn/docs/v5/tutorial/srs-server</a></p>
<h2 id="安装SRS"><a href="#安装SRS" class="headerlink" title="安装SRS"></a>安装SRS</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/ossrs/srs.git srs</span><br><span class="line">cd srs/trunk</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编译debug模式调试</span></span><br><span class="line">./configure --debug=on --debug-stats=on --prefix=`pwd`/install</span><br><span class="line">make -j4</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装到当前目录下的install</span></span><br><span class="line">make instal</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动</span></span><br><span class="line">cd install</span><br><span class="line">./objs/srs -c conf/srs.conf</span><br></pre></td></tr></table></figure>

<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>conf目录下有多个配置文件，<code>srs.conf如下</code>，其中详细信息在<code>full.conf</code>。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># main config for srs.</span></span><br><span class="line"><span class="comment"># @see full.conf for detail config.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># RTMP监听端口</span></span><br><span class="line"><span class="attribute">listen</span>              <span class="number">1935</span>;</span><br><span class="line"><span class="attribute">max_connections</span>     <span class="number">1000</span>;</span><br><span class="line"><span class="comment">#srs_log_tank        file;</span></span><br><span class="line"><span class="comment">#srs_log_file        ./objs/srs.log;</span></span><br><span class="line"><span class="comment"># off 前台启动</span></span><br><span class="line"><span class="attribute">daemon</span>              <span class="literal">off</span>;</span><br><span class="line"><span class="attribute">srs_log_tank</span>        console;</span><br><span class="line"></span><br><span class="line"><span class="comment"># http api服务，可以通过Web查看SRS相关的状态信息</span></span><br><span class="line"><span class="section">http_api</span> &#123;</span><br><span class="line">    <span class="attribute">enabled</span>         <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">listen</span>          <span class="number">1985</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">http_server</span> &#123;</span><br><span class="line">    <span class="attribute">enabled</span>         <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">listen</span>          <span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">dir</span>             ./objs/nginx/html;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">rtc_server</span> &#123;</span><br><span class="line">    <span class="attribute">enabled</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8000</span>; <span class="comment"># UDP port</span></span><br><span class="line">    <span class="comment"># @see https://ossrs.net/lts/zh-cn/docs/v4/doc/webrtc#config-candidate</span></span><br><span class="line">    <span class="attribute">candidate</span> <span class="variable">$CANDIDATE</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">vhost</span> __defaultVhost__ &#123;</span><br><span class="line">    <span class="section">hls</span> &#123;</span><br><span class="line">        <span class="attribute">enabled</span>         <span class="literal">on</span>;</span><br><span class="line"><span class="comment">#       hlt_path        ./objs/nginx/html;</span></span><br><span class="line"><span class="comment">#       hls_fragment    5;</span></span><br><span class="line"><span class="comment">#       hls_window      25;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">http_remux</span> &#123;</span><br><span class="line">        <span class="attribute">enabled</span>     <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">mount</span>       [vhost]/[app]/[stream].flv;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">rtc</span> &#123;</span><br><span class="line">        <span class="attribute">enabled</span>     <span class="literal">on</span>;</span><br><span class="line">        <span class="comment"># @see https://ossrs.net/lts/zh-cn/docs/v4/doc/webrtc#rtmp-to-rtc</span></span><br><span class="line">        <span class="attribute">rtmp_to_rtc</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="comment"># @see https://ossrs.net/lts/zh-cn/docs/v4/doc/webrtc#rtc-to-rtmp</span></span><br><span class="line">        <span class="attribute">rtc_to_rtmp</span> <span class="literal">off</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    play&#123;</span><br><span class="line">        <span class="attribute">gop_cache_max_frames</span> <span class="number">2500</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="测试SRS"><a href="#测试SRS" class="headerlink" title="测试SRS"></a>测试SRS</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">RTMP推流</span></span><br><span class="line">ffmpeg -re -i test.flv -codec copy -f flv -y rtmp://127.0.0.1/live/livestream</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">RTMP流地址：rtmp://127.0.0.1/live/livestream</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">HTTP-FLV地址：http://127.0.0.1:8080/live/livestream.flv</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">HLS流地址：http://127.0.0.1:8080/live/livestream.m3u8</span></span><br></pre></td></tr></table></figure>

<p>使⽤在线srs播放器拉流</p>
<p><a target="_blank" rel="noopener" href="http://127.0.0.1:8080/players/srs_player.html">http://127.0.0.1:8080/players/srs_player.html</a></p>
<p><a target="_blank" rel="noopener" href="http://ossrs.net/srs.release/trunk/research/players/srs_player.html%EF%BC%88%E5%AE%98%E2%BD%85%E6%8F%90%E4%BE%9B%E7%9A%84%E9%93%BE%E6%8E%A5%EF%BC%89">http://ossrs.net/srs.release/trunk/research/players/srs_player.html（官⽅提供的链接）</a></p>
<h1 id="SRS配置WebRTC"><a href="#SRS配置WebRTC" class="headerlink" title="SRS配置WebRTC"></a>SRS配置WebRTC</h1><h2 id="配置支持WebRTC"><a href="#配置支持WebRTC" class="headerlink" title="配置支持WebRTC"></a>配置支持WebRTC</h2><p>SRS 的 webrtc 是默认⽀持的（<code>--rtc=on</code>），使用默认<code>rtc2rtmp.conf</code>配置启动。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">listen</span>              <span class="number">1935</span>;</span><br><span class="line"><span class="attribute">max_connections</span>     <span class="number">1000</span>;</span><br><span class="line"><span class="attribute">daemon</span>              <span class="literal">off</span>;</span><br><span class="line"><span class="attribute">srs_log_tank</span>        console;</span><br><span class="line"></span><br><span class="line"><span class="section">http_server</span> &#123;</span><br><span class="line">    <span class="attribute">enabled</span>         <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">listen</span>          <span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">dir</span>             ./objs/nginx/html;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http_api</span> &#123;</span><br><span class="line">    <span class="attribute">enabled</span>         <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">listen</span>          <span class="number">1985</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">stats</span> &#123;</span><br><span class="line">    <span class="attribute">network</span>         <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">rtc_server</span> &#123;</span><br><span class="line">    <span class="attribute">enabled</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8000</span>; <span class="comment"># UDP port</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># The $CANDIDATE means fetch from env, if not configed, use * as default.</span></span><br><span class="line">    <span class="comment"># @see https://ossrs.net/lts/zh-cn/docs/v4/doc/webrtc#config-candidate</span></span><br><span class="line">    <span class="comment"># candidate $CANDIDATE;</span></span><br><span class="line">    </span><br><span class="line">    <span class="attribute">candidate</span> xxx.xxx.xxx.xxx; <span class="comment"># 在公网测试，需要设置为公⽹的地址</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">vhost</span> __defaultVhost__ &#123;</span><br><span class="line">    <span class="section">rtc</span> &#123;</span><br><span class="line">        <span class="attribute">enabled</span>     <span class="literal">on</span>;</span><br><span class="line">        <span class="comment"># @see https://ossrs.net/lts/zh-cn/docs/v4/doc/webrtc#rtmp-to-rtc</span></span><br><span class="line">        <span class="attribute">rtmp_to_rtc</span> <span class="literal">on</span>;</span><br><span class="line">        <span class="comment"># @see https://ossrs.net/lts/zh-cn/docs/v4/doc/webrtc#rtc-to-rtmp</span></span><br><span class="line">        <span class="attribute">rtc_to_rtmp</span> <span class="literal">on</span>;  <span class="comment"># ⽀持RTC推流，RTMP拉流</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">http_remux</span> &#123;</span><br><span class="line">        <span class="attribute">enabled</span>     <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">mount</span>       [vhost]/[app]/[stream].flv;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>$CANDIDATE</code>在服务器⼀般默认会选中172（之类）的局域⽹络，若是推流地址和拉流地址不在⼀个局域中会异常，解决⽅法设置为公⽹ip。</p>
<h2 id="WebRTC推拉流测试"><a href="#WebRTC推拉流测试" class="headerlink" title="WebRTC推拉流测试"></a>WebRTC推拉流测试</h2><h3 id="WebRTC拉流"><a href="#WebRTC拉流" class="headerlink" title="WebRTC拉流"></a>WebRTC拉流</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">推流端使用RTMP</span></span><br><span class="line">ffmpeg -re -i test.flv -codec copy -f flv -y rtmp://127.0.0.1/live/livestream</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉流端使用RTC</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使⽤srs⾃带的rtc_player播放器进⾏播放，直接请求srs服务的8080端⼝即可</span></span><br><span class="line">http://127.0.0.1:8080/players/srs_player.html</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">选择RTC播放器</span></span><br><span class="line">URL：webrtc://127.0.0.1/live/livestream</span><br></pre></td></tr></table></figure>

<h3 id="WebRTC推流"><a href="#WebRTC推流" class="headerlink" title="WebRTC推流"></a>WebRTC推流</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">推流端使用RTC</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使⽤srs⾃带的rtc_player播放器进⾏播放，直接请求srs服务的8080端⼝即可</span></span><br><span class="line">http://127.0.0.1:8080/players/srs_player.html</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">选择RTC推流</span></span><br><span class="line">URL：webrtc://127.0.0.1/live/livestream</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉流端也使用RTC</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">选择RTC播放器</span></span><br><span class="line">URL：webrtc://127.0.0.1/live/livestream</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/10/26/Qt/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/26/Qt/" class="post-title-link" itemprop="url">Qt</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-10-26 18:56:14" itemprop="dateCreated datePublished" datetime="2023-10-26T18:56:14+08:00">2023-10-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-12-30 22:38:55" itemprop="dateModified" datetime="2023-12-30T22:38:55+08:00">2023-12-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Qt/" itemprop="url" rel="index"><span itemprop="name">Qt</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="QT小程序"><a href="#QT小程序" class="headerlink" title="QT小程序"></a>QT小程序</h1><h2 id="项目文件"><a href="#项目文件" class="headerlink" title="项目文件"></a>项目文件</h2><p>Qt 的项目文件（.pro文件）是一个重要的配置文件，用于指导 Qt 的 qmake 工具来生成 Makefile，从而编译和构建 Qt 项目。这个文件包含了项目的元信息、编译选项、依赖关系和其他配置信息。以下是一个典型的 Qt 项目文件的示例，以及对各个部分的简要介绍：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># 指定Qt版本</span><br><span class="line">QT       += core gui</span><br><span class="line">greaterThan(QT_MAJOR_VERSION, 4): QT += widgets</span><br><span class="line"></span><br><span class="line"># 指定项目名称</span><br><span class="line">TARGET = Demo</span><br><span class="line">TEMPLATE = app</span><br><span class="line">CONFIG += console c++17</span><br><span class="line"></span><br><span class="line"># 项目图标</span><br><span class="line">ICON = demo.png</span><br><span class="line"></span><br><span class="line"># 源文件</span><br><span class="line">SOURCES += \</span><br><span class="line">        main.cpp \</span><br><span class="line">        main_window.cpp \</span><br><span class="line">        </span><br><span class="line"># 头文件</span><br><span class="line">HEADERS += \</span><br><span class="line">    main_window.h \</span><br><span class="line"></span><br><span class="line"># 依赖头文件和库</span><br><span class="line">mac &#123;</span><br><span class="line">    INCLUDEPATH += &quot;/usr/local/include/&quot;</span><br><span class="line">    LIBS += -L/usr/local/lib -lprotobuf</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 添加UI文件</span><br><span class="line">FORMS += \</span><br><span class="line">    mainwindow.ui</span><br><span class="line"></span><br><span class="line"># 指定资源文件</span><br><span class="line">RESOURCES += \</span><br><span class="line">    res.qrc</span><br></pre></td></tr></table></figure>

<h2 id="创建按钮"><a href="#创建按钮" class="headerlink" title="创建按钮"></a>创建按钮</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;mywidget.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QApplication&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">QApplication <span class="title">a</span><span class="params">(argc, argv)</span></span>;</span><br><span class="line">    MyWidget w;</span><br><span class="line">    <span class="comment">//显示窗口</span></span><br><span class="line">    w.<span class="built_in">show</span>();</span><br><span class="line">    <span class="comment">//进入消息循环</span></span><br><span class="line">    <span class="keyword">return</span> a.<span class="built_in">exec</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;mywidget.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">MyWidget::<span class="built_in">MyWidget</span>(QWidget *parent)</span><br><span class="line">    : <span class="built_in">QWidget</span>(parent)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    QPushButton* btn = <span class="keyword">new</span> <span class="built_in">QPushButton</span>();</span><br><span class="line">    <span class="comment">//partent</span></span><br><span class="line">    btn-&gt;<span class="built_in">setParent</span>(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">//set button name</span></span><br><span class="line">    btn-&gt;<span class="built_in">setText</span>(<span class="string">&quot;btn1&quot;</span>);</span><br><span class="line"></span><br><span class="line">    QPushButton* btn2 = <span class="keyword">new</span> <span class="built_in">QPushButton</span>(<span class="string">&quot;btn2&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">//move button position</span></span><br><span class="line">    btn2-&gt;<span class="built_in">move</span>(<span class="number">100</span>, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//resize button</span></span><br><span class="line">    btn2-&gt;<span class="built_in">resize</span>(<span class="number">50</span>, <span class="number">50</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//resize window</span></span><br><span class="line">    <span class="built_in">resize</span>(<span class="number">600</span>, <span class="number">400</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//set fixed window size</span></span><br><span class="line">    <span class="built_in">setFixedSize</span>(<span class="number">600</span>, <span class="number">400</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//set window title</span></span><br><span class="line">    <span class="built_in">setWindowTitle</span>(<span class="string">&quot;my window&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="对象树"><a href="#对象树" class="headerlink" title="对象树"></a>对象树</h2><p>上面通过在堆内存中创建控件对象可以正确展示控件到窗口上，但是随之而来也会有一个问题，如何回收在堆内存中申请的内存<code>btn</code>？</p>
<p>可以在窗口关闭或程序退出的时候统一回收，缺点是实现麻烦，并且很容易忘记回收内存。</p>
<p>Qt的<strong>对象树模型</strong>可以大大简化在堆中申请的内存。</p>
<blockquote>
<p>QT最基础和核心的类是：<code>QObject</code></p>
<p>Qt中几乎所有的类都是从<code>QObject</code>直接或简介继承的</p>
</blockquote>
<ul>
<li>QObject内部有一个list，会保存children，还有一个指针保存parent</li>
<li>当自己析构时，会自己从parent列表中删除并且析构所有的children</li>
</ul>
<h2 id="窗口坐标系"><a href="#窗口坐标系" class="headerlink" title="窗口坐标系"></a>窗口坐标系</h2><p>以左上角为原点，X轴正方向向右，Y轴正方向向下。对于嵌套窗口，其坐标是相对于父窗口。</p>
<h1 id="信号和槽"><a href="#信号和槽" class="headerlink" title="信号和槽"></a>信号和槽</h1><h2 id="信号和槽-1"><a href="#信号和槽-1" class="headerlink" title="信号和槽"></a>信号和槽</h2><p>信号和槽机制是 QT 的核心机制,它是一种高级接口，应用于对象之间的通信，它是 QT 的核心特性。</p>
<ul>
<li><strong>信号：</strong>当特定的事件发生的时候，信号就由该对象发射 (emit) 出去。</li>
<li><strong>槽：</strong>普通的成员函数，用于接受信号。</li>
<li><strong>信号和槽绑定：</strong>信号和槽通过<strong>connet</strong>方法绑定。</li>
</ul>
<p>信号和槽连接格式：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> QMetaObject::Connection <span class="title">connect</span><span class="params">(<span class="type">const</span> Object *sender, <span class="comment">//发送信号的对象</span></span></span></span><br><span class="line"><span class="params"><span class="function">                                     Func1 signal,         <span class="comment">//信号     </span></span></span></span><br><span class="line"><span class="params"><span class="function">                                     constObject *receiver,<span class="comment">//接收者 </span></span></span></span><br><span class="line"><span class="params"><span class="function">                                     Func2 slot,           <span class="comment">//槽函数</span></span></span></span><br><span class="line"><span class="params"><span class="function">                                     Qt::ConnectionType type = Qt::AutoConnection)</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MyWidget::<span class="built_in">MyWidget</span>(QWidget *parent)</span><br><span class="line">    : <span class="built_in">QWidget</span>(parent)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    QPushButton* btn1 = <span class="keyword">new</span> <span class="built_in">QPushButton</span>();</span><br><span class="line">    <span class="comment">//partent</span></span><br><span class="line">    btn1-&gt;<span class="built_in">setParent</span>(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">//set button name</span></span><br><span class="line">    btn1-&gt;<span class="built_in">setText</span>(<span class="string">&quot;btn1&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过点击btn1按钮，关闭窗口</span></span><br><span class="line"><span class="comment">     * btn1: 信号发送者</span></span><br><span class="line"><span class="comment">     * &amp;QPushButton::clicked: 发送的信号</span></span><br><span class="line"><span class="comment">     * this: 信号接收者</span></span><br><span class="line"><span class="comment">     * &amp;MyWidget::close: 处理的槽函数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">connect</span>(btn1, &amp;QPushButton::clicked, <span class="keyword">this</span>, &amp;MyWidget::close);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="自定义信号和槽"><a href="#自定义信号和槽" class="headerlink" title="自定义信号和槽"></a>自定义信号和槽</h2><ol>
<li>定义信号类<code>SignalWidget.h</code></li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> QT_SIGNALWIDGET_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> QT_SIGNALWIDGET_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QObject&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SignalWidget</span> : <span class="keyword">public</span> QObject &#123;</span><br><span class="line"><span class="comment">//1.如果需要自定义信号,需要加上宏定义</span></span><br><span class="line">Q_OBJECT</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">SignalWidget</span>(QObject *parent = Q_NULLPTR);</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">SignalWidget</span>();</span><br><span class="line"></span><br><span class="line">signals:</span><br><span class="line">    <span class="comment">//2.定义在signals下是信号,函数不需要实现</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">mySignal</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//QT_SIGNALWIDGET_H</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>自定义信号必须引入宏定义Q_OBJECT。</li>
<li>自定义信号必须要定义在signals下。</li>
<li>返回值是void，可以有参数，可以发生重载。</li>
</ul>
<ol start="2">
<li>定义槽函数类<code>SLotWidget.cpp</code></li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;SlotWidget.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">SlotWidget::<span class="built_in">SlotWidget</span>(QObject *parent):<span class="built_in">QObject</span>(parent)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SlotWidget::~<span class="built_in">SlotWidget</span>()</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//接收自定义信号的槽函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SlotWidget::mySlot</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;接收到自定义信号了:&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>mySlot槽函数用来接收信号。</li>
<li>返回值是void，可以有参数，可以发生重载。</li>
</ul>
<ol start="3">
<li>在程序中<code>MainWindow.cpp</code></li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;MainWindow.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">MainWindow::<span class="built_in">MainWindow</span>(QWidget* parent):<span class="built_in">QWidget</span>(parent) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//创建发送信号对象和槽函数对象</span></span><br><span class="line">    signalWidget = <span class="keyword">new</span> <span class="built_in">SignalWidget</span>(<span class="keyword">this</span>);</span><br><span class="line">    slotWidget = <span class="keyword">new</span> <span class="built_in">SlotWidget</span>(<span class="keyword">this</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">setFixedSize</span>(<span class="number">400</span>,<span class="number">400</span>);</span><br><span class="line">    QPushButton *btn = <span class="keyword">new</span> <span class="built_in">QPushButton</span>(<span class="string">&quot;发送信号&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">//绑定自定义的信号和槽函数</span></span><br><span class="line">    <span class="built_in">connect</span>(signalWidget, &amp;SignalWidget::mySignal, slotWidget, &amp;SlotWidget::mySlot);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//绑定了按钮的信号</span></span><br><span class="line">    <span class="built_in">connect</span>(btn, &amp;QPushButton::clicked, <span class="keyword">this</span>, &amp;MainWindow::btnClick);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//断开信号</span></span><br><span class="line">    <span class="comment">//disconnect(signalWidget, &amp;SignalWidget::mySignal, slotWidget, &amp;SlotWidget::mySlot);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MainWindow::~<span class="built_in">MainWindow</span>()</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//按钮点击事件槽函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MainWindow::btnClick</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//发送信号</span></span><br><span class="line">    emit signalWidget-&gt;<span class="built_in">mySignal</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>系统的信号会由Qt自动发射，自定义的信号必须要在特定的情况通过<code>emit</code>自己发射。</li>
<li>信号和槽函数的参数必须要一一对应。</li>
</ul>
<h2 id="信号和槽扩展"><a href="#信号和槽扩展" class="headerlink" title="信号和槽扩展"></a>信号和槽扩展</h2><ul>
<li>信号可以连接信号。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">MainWindow::<span class="built_in">MainWindow</span>(QWidget* parent):<span class="built_in">QWidget</span>(parent) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//创建发送信号对象和槽函数对象</span></span><br><span class="line">    signalWidget = <span class="keyword">new</span> <span class="built_in">SignalWidget</span>(<span class="keyword">this</span>);</span><br><span class="line">    slotWidget = <span class="keyword">new</span> <span class="built_in">SlotWidget</span>(<span class="keyword">this</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">setFixedSize</span>(<span class="number">400</span>,<span class="number">400</span>);</span><br><span class="line">    QPushButton *btn = <span class="keyword">new</span> <span class="built_in">QPushButton</span>(<span class="string">&quot;发送信号&quot;</span>,<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">//绑定自定义的信号和槽函数</span></span><br><span class="line">    <span class="built_in">connect</span>(signalWidget, &amp;SignalWidget::mySignal, slotWidget, &amp;SlotWidget::mySlot);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//按钮信号连接我的自定义信号</span></span><br><span class="line">    <span class="built_in">connect</span>(btn, &amp;QPushButton::clicked, signalWidget, &amp;SignalWidget::mySignal);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>一个信号可以连接多个槽函数。</li>
<li>多个信号可以连接同一个槽函数。</li>
<li>信号函数的参数个数可以多于槽函数的参数个数，但是没有对于的部分必须和槽函数一一对应。</li>
<li>信号断开连接。</li>
<li>QT4版本的<code>connect</code>写法。</li>
</ul>
<h1 id="主窗口"><a href="#主窗口" class="headerlink" title="主窗口"></a>主窗口</h1><p>主窗口（QMainWindow）是一个为用户提供主窗口程序的类，包含一个菜单栏（menu bar）、多个工具栏(tool bars)、多个锚接部件(dock widgets)、一个状态栏(status bar)及一个中心部件(central widget)，是许多应用程序的基础，如文本编辑器，图片编辑器等。</p>
<h2 id="菜单栏"><a href="#菜单栏" class="headerlink" title="菜单栏"></a>菜单栏</h2><p>一个主窗口最多只有一个菜单栏。位于主窗口顶部、主窗口标题栏下面。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">MainWindow::<span class="built_in">MainWindow</span>(Widget* parent):<span class="built_in">QMainWindow</span>(parent)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//创建菜单栏，获取主窗口菜单栏指针</span></span><br><span class="line">    QMenuBar* menuBar = <span class="built_in">menuBar</span>();</span><br><span class="line">    <span class="keyword">this</span>-&gt;<span class="built_in">setMenuBar</span>(menuBar);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建菜单</span></span><br><span class="line">    QMenu* fileMenu = menuBar-&gt;<span class="built_in">addMenu</span>(<span class="string">&quot;文件&quot;</span>);</span><br><span class="line">    <span class="comment">//添加分割线 (&quot;新建&quot;与“打开”之间)</span></span><br><span class="line">    fileMenu-&gt;<span class="built_in">addSeparator</span>();</span><br><span class="line">    <span class="comment">//创建菜单项</span></span><br><span class="line">    QAction* openAction = fileMenu-&gt;<span class="built_in">addAction</span>(<span class="string">&quot;打开&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="工具栏"><a href="#工具栏" class="headerlink" title="工具栏"></a>工具栏</h2><p>主窗口的工具栏上可以有多个工具条。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">MainWindow::<span class="built_in">MainWindow</span>(Widget* parent):<span class="built_in">QMainWindow</span>(parent)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//创建工具栏</span></span><br><span class="line">    QToolBar* toolBar = <span class="keyword">new</span> <span class="built_in">QToolBar</span>(<span class="keyword">this</span>);</span><br><span class="line">    <span class="built_in">addToolBar</span>(Qt::LeftToolBarArea, toolBar);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建工具项</span></span><br><span class="line">    toolBar-&gt;<span class="built_in">addAction</span>(<span class="string">&quot;工具&quot;</span>);</span><br><span class="line">    <span class="comment">//指定停靠区域</span></span><br><span class="line">    toolbar-&gt;<span class="built_in">setAllowedAreas</span>(Qt::LeftToolBarArea | Qt::RightToolBarArea);</span><br><span class="line">    <span class="comment">//设置工具栏的浮动状态</span></span><br><span class="line">    toolbar-&gt;<span class="built_in">setFloatable</span>(<span class="literal">false</span>);</span><br><span class="line">    <span class="comment">//修改工具栏不可移动</span></span><br><span class="line">    toolbar-&gt;<span class="built_in">setMovable</span>(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="状态栏"><a href="#状态栏" class="headerlink" title="状态栏"></a>状态栏</h2><p>状态栏也只能最多有一个。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">MainWindow::<span class="built_in">MainWindow</span>(Widget* parent):<span class="built_in">QMainWindow</span>(parent)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//创建状态栏</span></span><br><span class="line">    QStatusBar *statusbar = <span class="built_in">statusBar</span>();</span><br><span class="line">    <span class="keyword">this</span>-&gt;<span class="built_in">setStatusBar</span>(statusbar);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//增加正式信息（一般位于状态栏左侧）</span></span><br><span class="line">    QLabel *label1 = <span class="keyword">new</span> <span class="built_in">QLabel</span>(<span class="string">&quot;打开文件&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">    statusbar-&gt;<span class="built_in">addWidget</span>(label1);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//增加永久信息（一般位于状态栏右侧）</span></span><br><span class="line">    QLabel *label2 = <span class="keyword">new</span> <span class="built_in">QLabel</span>(<span class="string">&quot;test&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">    statusbar-&gt;<span class="built_in">addPermanentWidget</span>(label2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="浮动窗口"><a href="#浮动窗口" class="headerlink" title="浮动窗口"></a>浮动窗口</h2><p>也称铆接部件，可以有多个。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MainWindow::<span class="built_in">MainWindow</span>(Widget* parent):<span class="built_in">QMainWindow</span>(parent)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//创建浮动窗口</span></span><br><span class="line">    QDockWidget* dock = <span class="keyword">new</span> <span class="built_in">QDockWidget</span>(<span class="string">&quot;浮动&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">    <span class="built_in">addDockWidget</span>(Qt::RightDockWidgetArea, dock); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="核心部件"><a href="#核心部件" class="headerlink" title="核心部件"></a>核心部件</h2><p>例如一个记事本文件，可以利用QTextEdit做核心部件</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MainWindow::<span class="built_in">MainWindow</span>(Widget* parent):<span class="built_in">QMainWindow</span>(parent)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//创建文本</span></span><br><span class="line">    QTextEdit* text = <span class="keyword">new</span> <span class="built_in">QTextEdit</span>(<span class="keyword">this</span>);</span><br><span class="line">    <span class="built_in">setCentralWidget</span>(text); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="资源文件"><a href="#资源文件" class="headerlink" title="资源文件"></a>资源文件</h2><p>Qt资源系统可以将运行时所需的资源以二进制的形式存储于可执行文件内部。</p>
<ul>
<li>将图片文件文件夹拷贝到项目下</li>
<li>右键项目-&gt;添加新文件-&gt;Qt-&gt;Qt recourse File</li>
<li>res 生成 res.qrc</li>
<li>右键res.qrc-&gt;open in editor 编辑资源</li>
<li>添加前缀</li>
<li>添加文件</li>
<li>使用 “: + 前缀名 + 文件名”访问</li>
</ul>
<img src="/2023/10/26/Qt/Qt创建资源文件.png" alt="Qt创建资源文件" style="zoom:50%;">

<p>在窗口<code>MainWindow.cpp</code>中显示图片。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MainWindow::<span class="built_in">MainWindow</span>(Widget* parent):<span class="built_in">QMainWindow</span>(parent)</span><br><span class="line">&#123;</span><br><span class="line">    QLabel*label  = <span class="keyword">new</span> <span class="built_in">QLabel</span>(btn1);</span><br><span class="line">    label-&gt;<span class="built_in">setPixmap</span>(<span class="built_in">QPixmap</span>(<span class="string">&quot;:/image/image.jpg&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="对话框"><a href="#对话框" class="headerlink" title="对话框"></a>对话框</h1><h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p>对话框是 GUI 程序中不可或缺的组成部分。很多不能或者不适合放入主窗口的功能组件都必须放在对话框中设置。对话框通常会是一个顶层窗口，出现在程序最上层，用于实现短期任务或者简洁的用户交互。</p>
<p>对话框分为模态对话框和非模态对话框。</p>
<ul>
<li>模态对话框：不可以对同一应用程序中其他窗口进行操作。</li>
<li>非模态对话框：可以对其他窗口进行操作。</li>
</ul>
<h2 id="自定义对话框"><a href="#自定义对话框" class="headerlink" title="自定义对话框"></a>自定义对话框</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">MainWindow::<span class="built_in">MainWindow</span>(QWidget *parent) :</span><br><span class="line">    <span class="built_in">QMainWindow</span>(parent),</span><br><span class="line">    <span class="built_in">ui</span>(<span class="keyword">new</span> Ui::MainWindow)</span><br><span class="line">&#123;</span><br><span class="line">    ui-&gt;<span class="built_in">setupUi</span>(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">connect</span>(ui-&gt;actionnew, &amp;QAction::triggered, <span class="keyword">this</span>, [=]()&#123;</span><br><span class="line">        <span class="comment">//模态对话框</span></span><br><span class="line">        QDialog dlg1;</span><br><span class="line">        dlg1.<span class="built_in">exec</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//非模态对话框</span></span><br><span class="line">        QDialog* dlg2 = <span class="keyword">new</span> <span class="built_in">QDialog</span>(<span class="keyword">this</span>);</span><br><span class="line">        dlg2-&gt;<span class="built_in">setAttribute</span>(Qt::WA_DeleteOnClose);</span><br><span class="line">        dlg2-&gt;<span class="built_in">resize</span>(<span class="number">200</span>, <span class="number">200</span>);</span><br><span class="line">        dlg2-&gt;<span class="built_in">show</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="标准对话框"><a href="#标准对话框" class="headerlink" title="标准对话框"></a>标准对话框</h2><p>所谓标准对话框，是 Qt 内置的一系列对话框，用于简化开发。事实上，有很多对话框都是通用的，比如打开文件、设置颜色、打印设置等。这些对话框在所有程序中几乎相同，因此没有必要在每一个程序中都自己实现这么一个对话框。</p>
<p>Qt 的内置对话框大致分为以下几类：</p>
<ul>
<li><code>QColorDialog</code>：选择颜色。</li>
<li><code>QFileDialog</code>：选择文件或者目录。</li>
<li><code>QFontDialog</code>：选择字体。</li>
<li><code>QInputDialog</code>：允许用户输入一个值，并将其值返回。</li>
<li><code>QMessageBox</code>：模态对话框，用于显示信息、询问问题等。</li>
<li><code>QPageSetupDialog</code>：为打印机提供纸张相关的选项。</li>
<li><code>QPrintDialog</code>：打印机配置。</li>
<li><code>QPrintPreviewDialog</code>：打印预览。</li>
<li><code>QProgressDialog</code>：显示操作过程。</li>
</ul>
<h2 id="消息对话框"><a href="#消息对话框" class="headerlink" title="消息对话框"></a>消息对话框</h2><p>QMessageBox用于显示消息提示。我们一般会使用其提供的几个 static 函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">QMessageBox::<span class="built_in">abort</span>(<span class="keyword">this</span>, <span class="string">&quot;abort&quot;</span>, <span class="string">&quot;关于&quot;</span>);</span><br><span class="line">QMessageBox::<span class="built_in">information</span>(<span class="keyword">this</span>, <span class="string">&quot;information&quot;</span>, <span class="string">&quot;普通信息提示&quot;</span>);</span><br><span class="line">QMessageBox::<span class="built_in">question</span>(<span class="keyword">this</span>, <span class="string">&quot;question&quot;</span>, <span class="string">&quot;问题&quot;</span>);</span><br><span class="line">QMessageBox::<span class="built_in">warning</span>(<span class="keyword">this</span>, <span class="string">&quot;warning&quot;</span>, <span class="string">&quot;警告&quot;</span>);</span><br><span class="line">QMessageBox::<span class="built_in">critical</span>(<span class="keyword">this</span>, <span class="string">&quot;wrong&quot;</span>, <span class="string">&quot;错误&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//根据返回值判断</span></span><br><span class="line"><span class="keyword">if</span> (QMessageBox::Save == QMessageBox::<span class="built_in">question</span>(<span class="keyword">this</span>,        <span class="comment">//父类</span></span><br><span class="line">                                               <span class="string">&quot;question&quot;</span>,  <span class="comment">//标题</span></span><br><span class="line">                                               <span class="string">&quot;询问！&quot;</span>,     <span class="comment">//显示内容</span></span><br><span class="line">                                               QMessageBox::Save|QMessageBox::Cancel,    <span class="comment">//按键类型</span></span><br><span class="line">                                               QMessageBox::Cancel))    <span class="comment">//默认关联回车的按键</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;保存&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;取消&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="其他对话框"><a href="#其他对话框" class="headerlink" title="其他对话框"></a>其他对话框</h2><h3 id="颜色对话框"><a href="#颜色对话框" class="headerlink" title="颜色对话框"></a>颜色对话框</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">QColor color = QColorDialog::<span class="built_in">getColor</span>(<span class="built_in">QColor</span>(<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line"><span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;r=&quot;</span> &lt;&lt; color.<span class="built_in">red</span>() &lt;&lt; <span class="string">&quot;b=&quot;</span> &lt;&lt; color.<span class="built_in">blue</span>() &lt;&lt; <span class="string">&quot;g=&quot;</span> &lt;&lt; color.<span class="built_in">green</span>();</span><br></pre></td></tr></table></figure>

<h3 id="字体对话框"><a href="#字体对话框" class="headerlink" title="字体对话框"></a>字体对话框</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> ok;</span><br><span class="line">QFontDialog::<span class="built_in">getFont</span>(&amp;ok, <span class="built_in">QFont</span>(<span class="string">&quot;华文彩云&quot;</span>, <span class="number">20</span>));</span><br><span class="line">QFont font = QFontDialog::<span class="built_in">getFont</span>(&amp;ok, <span class="built_in">QFont</span>(<span class="string">&quot;华文彩云&quot;</span>, <span class="number">20</span>));</span><br><span class="line"><span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;字体：&quot;</span> &lt;&lt; font.<span class="built_in">family</span>() &lt;&lt; <span class="string">&quot;字号：&quot;</span> &lt;&lt; font.<span class="built_in">pointSize</span>()</span><br><span class="line">    &lt;&lt; <span class="string">&quot;加粗：&quot;</span> &lt;&lt; font.<span class="built_in">bold</span>() &lt;&lt; <span class="string">&quot;倾斜：&quot;</span> &lt;&lt; font.<span class="built_in">italic</span>();</span><br></pre></td></tr></table></figure>

<h3 id="文件对话框"><a href="#文件对话框" class="headerlink" title="文件对话框"></a>文件对话框</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">QString str = QFileDialog::<span class="built_in">getOpenFileName</span>(<span class="keyword">this</span>, <span class="string">&quot;打开文件&quot;</span>, <span class="string">&quot;C:\\Users\\xxx\\Desktop\\coding&quot;</span>, <span class="string">&quot;(*.exe)&quot;</span>);</span><br><span class="line"><span class="built_in">qDebug</span>() &lt;&lt; str;</span><br></pre></td></tr></table></figure>

<h1 id="布局管理器"><a href="#布局管理器" class="headerlink" title="布局管理器"></a>布局管理器</h1><ol>
<li>登录窗口，选择基本控件。</li>
</ol>
<img src="/2023/10/26/Qt/登录窗口1.png" alt="登录窗口1" style="zoom:70%;">

<ol start="2">
<li>选取 widget 进行布局，水平布局、垂直布局、栅格布局，同时利用弹簧给用户名、密码、登陆、退出按钮进行布局。</li>
</ol>
<img src="/2023/10/26/Qt/登录窗口2.png" alt="登录窗口2" style="zoom:70%;">

<ol start="3">
<li>默认窗口和控件之间 有12（不同版本的QT可能不一样）间隙，可以调整。</li>
</ol>
<img src="/2023/10/26/Qt/布局间隙.png" alt="布局间隙" style="zoom:80%;">

<h1 id="常用控件"><a href="#常用控件" class="headerlink" title="常用控件"></a>常用控件</h1><h2 id="布局控件"><a href="#布局控件" class="headerlink" title="布局控件"></a>布局控件</h2><table>
<thead>
<tr>
<th>名称</th>
<th>类名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Vertical Layout</td>
<td>QVBoxLayout</td>
<td>垂直布局</td>
</tr>
<tr>
<td>Horizontal Layout</td>
<td>QHBoxLayout</td>
<td>水平布局</td>
</tr>
<tr>
<td>Grid Layout</td>
<td>QGridLayout</td>
<td>栅格布局</td>
</tr>
<tr>
<td>Format Layout</td>
<td>QFormatLayout</td>
<td>表单布局</td>
</tr>
</tbody></table>
<p>也可以通过Widget进行布局。</p>
<h2 id="空间间隔控件"><a href="#空间间隔控件" class="headerlink" title="空间间隔控件"></a>空间间隔控件</h2><table>
<thead>
<tr>
<th>名称</th>
<th>类名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Horizontal Spacer</td>
<td>Spacer</td>
<td>水平间隔</td>
</tr>
<tr>
<td>Vertical Spacer</td>
<td>Spacer</td>
<td>竖直间隔</td>
</tr>
</tbody></table>
<h2 id="按钮控件"><a href="#按钮控件" class="headerlink" title="按钮控件"></a>按钮控件</h2><table>
<thead>
<tr>
<th>名称</th>
<th>类名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Push Button</td>
<td>QPushButton</td>
<td>按钮</td>
</tr>
<tr>
<td>Tool Button</td>
<td>QToolButton</td>
<td>工具按钮</td>
</tr>
<tr>
<td>Radio Button</td>
<td>QRadioButton</td>
<td>单选按钮</td>
</tr>
<tr>
<td>Check Box</td>
<td>QCheckBox</td>
<td>复选框</td>
</tr>
<tr>
<td>Command Link Button</td>
<td>QCommandLinkButton</td>
<td>命令链接按钮</td>
</tr>
<tr>
<td>Dialog Button Box</td>
<td>QDialogButtonBox</td>
<td>对话框按钮</td>
</tr>
</tbody></table>
<h3 id="常用属性"><a href="#常用属性" class="headerlink" title="常用属性"></a>常用属性</h3><p><strong>QAbstractButton</strong></p>
<table>
<thead>
<tr>
<th>属性</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>text</td>
<td>名称</td>
</tr>
<tr>
<td>icon</td>
<td>图标，添加资源文件显示</td>
</tr>
<tr>
<td>iconSize</td>
<td>图标大小</td>
</tr>
<tr>
<td>checked</td>
<td>默认选中</td>
</tr>
</tbody></table>
<p><strong>QToolButton</strong></p>
<table>
<thead>
<tr>
<th>属性</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>toolButtonStyle</td>
<td>显示文字和图标的风格</td>
</tr>
<tr>
<td>autoRaise</td>
<td>设置按钮是否自动突出</td>
</tr>
</tbody></table>
<h2 id="Item-Widgets"><a href="#Item-Widgets" class="headerlink" title="Item Widgets"></a>Item Widgets</h2><h3 id="List-Widget"><a href="#List-Widget" class="headerlink" title="List Widget"></a>List Widget</h3><p>QListView 用于显示单列的列表数据，适用于一维数据的操作，QListWidgetItem 表示 QListWidget 中的单个每一个列表项，可以设置文字对齐，背景大小、图标之类的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">MainWindow::<span class="built_in">MainWindow</span>(QWidget *parent) :</span><br><span class="line">    <span class="built_in">QMainWindow</span>(parent),</span><br><span class="line">    <span class="built_in">ui</span>(<span class="keyword">new</span> Ui::MainWindow)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//添加一行</span></span><br><span class="line">    QListWidgetItem* item = <span class="keyword">new</span> <span class="built_in">QListWidgetItem</span>(<span class="string">&quot;第一行&quot;</span>);</span><br><span class="line">    <span class="comment">//设置中心对齐</span></span><br><span class="line">    item-&gt;<span class="built_in">setTextAlignment</span>(Qt::AlignHCenter);</span><br><span class="line">    ui-&gt;listWidget-&gt;<span class="built_in">addItem</span>(item);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加多行</span></span><br><span class="line">    QStringList items;</span><br><span class="line">    items &lt;&lt; <span class="string">&quot;第二行&quot;</span> &lt;&lt; <span class="string">&quot;第三行&quot;</span>;</span><br><span class="line">    ui-&gt;listWidget-&gt;<span class="built_in">addItems</span>(items);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Tree-Widget"><a href="#Tree-Widget" class="headerlink" title="Tree Widget"></a>Tree Widget</h3><p>QTreeView用于显示树状结构数据，适用于树状结构数据的操作。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">MainWindow::<span class="built_in">MainWindow</span>(QWidget *parent) :</span><br><span class="line">    <span class="built_in">QMainWindow</span>(parent),</span><br><span class="line">    <span class="built_in">ui</span>(<span class="keyword">new</span> Ui::MainWindow)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//设置头部标签</span></span><br><span class="line">    ui-&gt;treeWidget-&gt;<span class="built_in">setHeaderLabels</span>(<span class="built_in">QStringList</span>() &lt;&lt; <span class="string">&quot;名称&quot;</span> &lt;&lt; <span class="string">&quot;大小&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加载顶层结点</span></span><br><span class="line">    QTreeWidgetItem* item1 = <span class="keyword">new</span> <span class="built_in">QTreeWidgetItem</span>(<span class="built_in">QStringList</span>() &lt;&lt; <span class="string">&quot;水果类&quot;</span>);</span><br><span class="line">    ui-&gt;treeWidget-&gt;<span class="built_in">addTopLevelItem</span>(item1);</span><br><span class="line"></span><br><span class="line">    QTreeWidgetItem* item2 = <span class="keyword">new</span> <span class="built_in">QTreeWidgetItem</span>(<span class="built_in">QStringList</span>() &lt;&lt; <span class="string">&quot;肉类&quot;</span>);</span><br><span class="line">    ui-&gt;treeWidget-&gt;<span class="built_in">addTopLevelItem</span>(item2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//追加子结点</span></span><br><span class="line">    QTreeWidgetItem* item1_1 = <span class="keyword">new</span> <span class="built_in">QTreeWidgetItem</span>(<span class="built_in">QStringList</span>() &lt;&lt; <span class="string">&quot;香蕉&quot;</span> &lt;&lt; <span class="string">&quot;10&quot;</span>);</span><br><span class="line">    item-&gt;<span class="built_in">addChild</span>(item1_1);</span><br><span class="line"></span><br><span class="line">    QTreeWidgetItem* item2_1 = <span class="keyword">new</span> <span class="built_in">QTreeWidgetItem</span>(<span class="built_in">QStringList</span>() &lt;&lt; <span class="string">&quot;牛肉&quot;</span> &lt;&lt; <span class="string">&quot;20&quot;</span>);</span><br><span class="line">    item2-&gt;<span class="built_in">addChild</span>(item2_1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Table-Widget"><a href="#Table-Widget" class="headerlink" title="Table Widget"></a>Table Widget</h3><p>QTableView用于显示表格状数据，适用于二维表格型数据的操作。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">MainWindow::<span class="built_in">MainWindow</span>(QWidget *parent) :</span><br><span class="line">    <span class="built_in">QMainWindow</span>(parent),</span><br><span class="line">    <span class="built_in">ui</span>(<span class="keyword">new</span> Ui::MainWindow)</span><br><span class="line">&#123;</span><br><span class="line">    ui-&gt;<span class="built_in">setupUi</span>(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置列数</span></span><br><span class="line">    ui-&gt;tableWidget-&gt;<span class="built_in">setColumnCount</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置水平表头</span></span><br><span class="line">    ui-&gt;tableWidget-&gt;<span class="built_in">setHorizontalHeaderLabels</span>(<span class="built_in">QStringList</span>() &lt;&lt; <span class="string">&quot;姓名&quot;</span> &lt;&lt; <span class="string">&quot;年龄&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置行数</span></span><br><span class="line">    ui-&gt;tableWidget-&gt;<span class="built_in">setRowCount</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置正文</span></span><br><span class="line">    ui-&gt;tableWidget-&gt;<span class="built_in">setItem</span>(<span class="number">0</span>,<span class="number">0</span>, <span class="keyword">new</span> <span class="built_in">QTableWidgetItem</span>(<span class="string">&quot;张三&quot;</span>));</span><br><span class="line">    ui-&gt;tableWidget-&gt;<span class="built_in">setItem</span>(<span class="number">0</span>,<span class="number">1</span>, <span class="keyword">new</span> <span class="built_in">QTableWidgetItem</span>(<span class="string">&quot;18&quot;</span>));</span><br><span class="line">    ui-&gt;tableWidget-&gt;<span class="built_in">setItem</span>(<span class="number">1</span>,<span class="number">0</span>, <span class="keyword">new</span> <span class="built_in">QTableWidgetItem</span>(<span class="string">&quot;李四&quot;</span>));</span><br><span class="line">    ui-&gt;tableWidget-&gt;<span class="built_in">setItem</span>(<span class="number">1</span>,<span class="number">1</span>, <span class="keyword">new</span> <span class="built_in">QTableWidgetItem</span>(<span class="string">&quot;19&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/10/23/%E9%87%8D%E9%87%87%E6%A0%B7%E4%BD%BF%E7%94%A8AVAudioFifo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/23/%E9%87%8D%E9%87%87%E6%A0%B7%E4%BD%BF%E7%94%A8AVAudioFifo/" class="post-title-link" itemprop="url">重采样使用AVAudioFifo</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-10-23 23:15:09" itemprop="dateCreated datePublished" datetime="2023-10-23T23:15:09+08:00">2023-10-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-18 09:40:26" itemprop="dateModified" datetime="2024-01-18T09:40:26+08:00">2024-01-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/FFmpeg/" itemprop="url" rel="index"><span itemprop="name">FFmpeg</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>音频重采样时，输入输出的采样点数不一样的时候可以使用 AVAudioFifo 缓存数据。</p>
<h1 id="AVAudioFifo"><a href="#AVAudioFifo" class="headerlink" title="AVAudioFifo"></a>AVAudioFifo</h1><p>AVAudioFifo 是一个缓冲区，它以一次音频采样为基本单位，是一个先进先出的队列。有了它，对音频的采样数据做缓冲就会变得非常简单，其优势有两点：</p>
<ul>
<li>让我们在采样层面做操作，而不是更底层的字节层面。</li>
<li>支持多种格式的单次采样，如支持 planar 或 packed 的采样格式，支持不同的通道数等等。</li>
</ul>
<p>相关 API 记录：</p>
<h2 id="分配和释放"><a href="#分配和释放" class="headerlink" title="分配和释放"></a>分配和释放</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 分配一个AVAudioFifo。</span></span><br><span class="line"><span class="comment">// sample_fmt和channels指定单次采样的参数</span></span><br><span class="line"><span class="comment">// nb_samples则指定AVAudioFifo的缓冲区大小。</span></span><br><span class="line">AVAudioFifo *<span class="title function_">av_audio_fifo_alloc</span><span class="params">(<span class="keyword">enum</span> AVSampleFormat sample_fmt, <span class="type">int</span> channels,<span class="type">int</span> nb_samples)</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 重新分配缓冲区大小</span></span><br><span class="line"><span class="comment">// 成功返回0，失败返回负的错误值</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">av_audio_fifo_realloc</span><span class="params">(AVAudioFifo *af, <span class="type">int</span> nb_samples)</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 释放AVAudioFifo</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">av_audio_fifo_free</span><span class="params">(AVAudioFifo *af)</span>;</span><br></pre></td></tr></table></figure>

<h2 id="读写"><a href="#读写" class="headerlink" title="读写"></a>读写</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将采样写入到AVAudioFifo</span></span><br><span class="line"><span class="comment">// 成功则返回实际写入的采样数（实际上如果写入成功，返回值必定等于nb_samples），失败返回负的错误值</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">av_audio_fifo_write</span><span class="params">(AVAudioFifo *af, <span class="type">void</span> **data, <span class="type">int</span> nb_samples)</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// peek：读取数据，但读到的数据并不会从fifo中删除</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">av_audio_fifo_peek</span><span class="params">(AVAudioFifo *af, <span class="type">void</span> **data, <span class="type">int</span> nb_samples)</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 从指定的偏移位置peek数据</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">av_audio_fifo_peek_at</span><span class="params">(AVAudioFifo *af, <span class="type">void</span> **data, <span class="type">int</span> nb_samples, <span class="type">int</span> offset)</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 读取数据，读到的数据会从fifo中删除</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">av_audio_fifo_read</span><span class="params">(AVAudioFifo *af, <span class="type">void</span> **data, <span class="type">int</span> nb_samples)</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 从fifo中删除nb_samples个采样</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">av_audio_fifo_drain</span><span class="params">(AVAudioFifo *af, <span class="type">int</span> nb_samples)</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 删除fifo中的所有采样，情空</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">av_audio_fifo_reset</span><span class="params">(AVAudioFifo *af)</span>;</span><br></pre></td></tr></table></figure>

<h2 id="查看"><a href="#查看" class="headerlink" title="查看"></a>查看</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回fifo中当前存储的采样数量</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">av_audio_fifo_size</span><span class="params">(AVAudioFifo *af)</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 返回fifo中当前可写的采样数量，即尚未使用的空间数量</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">av_audio_fifo_space</span><span class="params">(AVAudioFifo *af)</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 同一时刻，以上两个函数的返回值之和等于fifo的缓冲区大小</span></span><br></pre></td></tr></table></figure>

<h1 id="重采样实例"><a href="#重采样实例" class="headerlink" title="重采样实例"></a>重采样实例</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 输入参数</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">AVSampleFormat</span> <span class="title">src_sample_fmt</span>;</span></span><br><span class="line"><span class="type">int</span> src_sample_rate;</span><br><span class="line"><span class="type">uint64_t</span> src_channel_layout;</span><br><span class="line"><span class="comment">// 输出参数</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">AVSampleFormat</span> <span class="title">dst_sample_fmt</span>;</span></span><br><span class="line"><span class="type">int</span> dst_sample_rate;</span><br><span class="line"><span class="type">uint64_t</span> dst_channel_layout;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SwrContext</span> *<span class="title">swr_ctx</span>;</span></span><br><span class="line">AVAudioFifo *audio_fifo;</span><br><span class="line"><span class="type">uint8_t</span> **resampled_data;   <span class="comment">// 用来缓存重采样后的数据</span></span><br><span class="line"><span class="type">int</span> resampled_data_size;    <span class="comment">// 重采样后的采样数</span></span><br><span class="line"><span class="type">int</span> src_channels;           <span class="comment">// 输入的通道数</span></span><br><span class="line"><span class="type">int</span> dst_channels;           <span class="comment">// 输出通道数</span></span><br></pre></td></tr></table></figure>

<h2 id="分配"><a href="#分配" class="headerlink" title="分配"></a>分配</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">audio_fifo = av_audio_fifo_alloc(dst_sample_fmt, dst_channels, <span class="number">1</span>);</span><br><span class="line">*swr_ctx = swr_alloc();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* set options */</span></span><br><span class="line">av_opt_set_sample_fmt(swr_ctx, <span class="string">&quot;in_sample_fmt&quot;</span>,      src_sample_fmt, <span class="number">0</span>);</span><br><span class="line">av_opt_set_int(swr_ctx,        <span class="string">&quot;in_channel_layout&quot;</span>,  src_channel_layout, <span class="number">0</span>);</span><br><span class="line">av_opt_set_int(swr_ctx,        <span class="string">&quot;in_sample_rate&quot;</span>,     src_sample_rate, <span class="number">0</span>);</span><br><span class="line">av_opt_set_sample_fmt(swr_ctx, <span class="string">&quot;out_sample_fmt&quot;</span>,     dst_sample_fmt, <span class="number">0</span>);</span><br><span class="line">av_opt_set_int(swr_ctx,        <span class="string">&quot;out_channel_layout&quot;</span>, dst_channel_layout, <span class="number">0</span>);</span><br><span class="line">av_opt_set_int(swr_ctx,        <span class="string">&quot;out_sample_rate&quot;</span>,    dst_sample_rate, <span class="number">0</span>);</span><br><span class="line"><span class="comment">/* initialize the resampling context */</span></span><br><span class="line">swr_init(swr_ctx);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> linesize = <span class="number">0</span>;</span><br><span class="line"><span class="comment">/* resampled data buffer must enough, otherwise should realloc*/</span></span><br><span class="line">resampled_data_size = <span class="number">2048</span>;</span><br><span class="line"><span class="comment">/* alloc resampled data */</span></span><br><span class="line">av_samples_alloc_array_and_samples(&amp;resampled_data, &amp;linesize, dst_channels, resampled_data_size, dst_sample_fmt, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<h2 id="释放"><a href="#释放" class="headerlink" title="释放"></a>释放</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (swr_ctx)</span><br><span class="line">    swr_free(&amp;resampler-&gt;swr_ctx);</span><br><span class="line"><span class="keyword">if</span> (audio_fifo)</span><br><span class="line">    av_fifo_freep((AVFifoBuffer **)&amp;audio_fifo);</span><br><span class="line"><span class="keyword">if</span> (resampled_data)</span><br><span class="line">    av_freep(&amp;resampled_data[<span class="number">0</span>]);</span><br><span class="line">av_freep(&amp;resampled_data);</span><br></pre></td></tr></table></figure>

<h2 id="重采样"><a href="#重采样" class="headerlink" title="重采样"></a>重采样</h2><p>输入和输出都为 AVFrame，当输出的采样点数不满足时返回空。</p>
<h3 id="输入"><a href="#输入" class="headerlink" title="输入"></a>输入</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* input nb_samples */</span></span><br><span class="line"><span class="type">int</span> src_nb_samples = frame-&gt;nb_samples;</span><br><span class="line"><span class="comment">/* input data buffer */</span></span><br><span class="line"><span class="type">uint8_t</span> **src_data = frame-&gt;extended_data;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* do resample output nb_samples */</span></span><br><span class="line"><span class="type">int</span> dst_nb_samples = av_rescale_rnd(swr_get_delay(swr_ctx, src_sample_rate) + src_nb_samples,</span><br><span class="line">                                    dst_sample_rate,</span><br><span class="line">                                    src_sample_rate,</span><br><span class="line">                                    AV_ROUND_UP);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* check resampled data size */</span></span><br><span class="line"><span class="keyword">if</span> (dst_nb_samples &gt; resampled_data_size)</span><br><span class="line">    realloc_resampled_data();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* do resample */</span></span><br><span class="line"><span class="type">int</span> nb_samples = swr_convert(swr_ctx, </span><br><span class="line">                             resampled_data, </span><br><span class="line">                             dst_nb_samples,</span><br><span class="line">                             (<span class="type">const</span> <span class="type">uint8_t</span> **)src_data,</span><br><span class="line">                             src_nb_samples);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* write resampled data to audio fifo */</span></span><br><span class="line"><span class="type">int</span> ret_size = av_audio_fifo_write(audio_fifo, (<span class="type">void</span> **)resampled_data, nb_samples);</span><br></pre></td></tr></table></figure>

<h3 id="输出"><a href="#输出" class="headerlink" title="输出"></a>输出</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> ret_nb_samples = av_audio_fifo_size(audio_fifo);</span><br><span class="line"><span class="comment">/* check has enough samples */</span></span><br><span class="line"><span class="keyword">if</span> (need_nb_samples &gt; ret_nb_samples)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">AVFrame* frame = av_frame_alloc();</span><br><span class="line">frame-&gt;nb_samples = nb_samples;</span><br><span class="line">frame-&gt;channel_layout = dst_channel_layout;</span><br><span class="line">frame-&gt;format = dst_sample_fmt;</span><br><span class="line">av_frame_get_buffer(frame, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* read samples from audio fifo, before read must alloc frame, use av_frame_get_buffer */</span></span><br><span class="line">av_audio_fifo_read(audio_fifo, (<span class="type">void</span> **)frame-&gt;data, need_nb_samples);</span><br></pre></td></tr></table></figure>

<h2 id="时间戳"><a href="#时间戳" class="headerlink" title="时间戳"></a>时间戳</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> factor = <span class="number">1.0</span> * dst_sample_rate / src_sample_rate;</span><br><span class="line"><span class="type">int64_t</span> out_pts = (<span class="type">int64_t</span>)(in_pts * factor);</span><br></pre></td></tr></table></figure>

<p>参考链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_34305316/article/details/106356443">https://blog.csdn.net/qq_34305316/article/details/106356443</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/10/16/AppRTC%E6%90%AD%E5%BB%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/16/AppRTC%E6%90%AD%E5%BB%BA/" class="post-title-link" itemprop="url">AppRTC搭建</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-10-16 20:25:12" itemprop="dateCreated datePublished" datetime="2023-10-16T20:25:12+08:00">2023-10-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-12-30 22:41:24" itemprop="dateModified" datetime="2023-12-30T22:41:24+08:00">2023-12-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/WebRTC/" itemprop="url" rel="index"><span itemprop="name">WebRTC</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="软件安装"><a href="#软件安装" class="headerlink" title="软件安装"></a>软件安装</h1><h2 id="安装JDK"><a href="#安装JDK" class="headerlink" title="安装JDK"></a>安装JDK</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">先安装add‐apt‐repository命令支持</span></span><br><span class="line">sudo apt-get install python-software-properties</span><br><span class="line">sudo apt-get install software-properties-common</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">第一步：打开终端，添加ppa源</span></span><br><span class="line">sudo add-apt-repository ppa:openjdk-r/ppa</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">第二步：更新源</span></span><br><span class="line">sudo apt‐get update</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">第三步：安装openjdk 8</span></span><br><span class="line">sudo apt-get install openjdk-8-jdk</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">第四步：配置openjdk 8为默认java环境</span></span><br><span class="line">sudo update-alternatives --config java</span><br><span class="line">sudo update-alternatives --config javac</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">最后，验证一下是否成功</span></span><br><span class="line">java ‐version</span><br></pre></td></tr></table></figure>

<h2 id="安装node-js"><a href="#安装node-js" class="headerlink" title="安装node.js"></a>安装node.js</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> -p /root/webrtc</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> /root/webrtc</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget https://nodejs.org/dist/v15.0.0/node‐v15.0.0‐linux‐x64.tar.xz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tar xvf node-v15.0.0-linux-x64.tar.xz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> node-v15.0.0-linux-x64/bin</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ln</span> -s `<span class="built_in">pwd</span>`/npm /usr/local/bin</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">npm -v</span></span><br><span class="line">7.0.2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ln</span> -s `<span class="built_in">pwd</span>`/node /usr/local/bin</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">node -v</span></span><br><span class="line">v15.0.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">npm  -g install grunt-cli</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ln</span> -s `<span class="built_in">pwd</span>`/grunt /usr/local/bin</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">grunt --version</span></span><br><span class="line">grunt-cli v1.4.3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo npm install -g cnpm --registry=https://registry.npm.taobao.org</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ln</span> -s `<span class="built_in">pwd</span>`/cnpm /usr/local/bin</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看版本发现报错</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cnpm -v</span> </span><br><span class="line">internal/modules/cjs/loader.js:638</span><br><span class="line">    throw err;</span><br><span class="line">    ^</span><br><span class="line"></span><br><span class="line">Error: Cannot find module &#x27;node:util&#x27;</span><br><span class="line">    at Function.Module._resolveFilename (internal/modules/cjs/loader.js:636:15)</span><br><span class="line">    at Function.Module._load (internal/modules/cjs/loader.js:562:25)</span><br><span class="line">    at Module.require (internal/modules/cjs/loader.js:690:17)</span><br><span class="line">    at require (internal/modules/cjs/helpers.js:25:18)</span><br><span class="line">    at Object.&lt;anonymous&gt; (/home/pico/webrtc/node-v10.16.0-linux-x64/lib/node_modules/cnpm/bin/cnpm:3:15)</span><br><span class="line">    at Module._compile (internal/modules/cjs/loader.js:776:30)</span><br><span class="line">    at Object.Module._extensions..js (internal/modules/cjs/loader.js:787:10)</span><br><span class="line">    at Module.load (internal/modules/cjs/loader.js:653:32)</span><br><span class="line">    at tryModuleLoad (internal/modules/cjs/loader.js:593:12)</span><br><span class="line">    at Function.Module._load (internal/modules/cjs/loader.js:585:3)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">卸载cnpm</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo npm uninstall cnpm</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用7.0.0版本</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo npm install -g cnpm@7.0.0 --registry=https://registry.npm.taobao.org</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cnpm -v</span></span><br><span class="line">cnpm@7.0.0 (/home/pico/webrtc/node-v15.0.0-linux-x64/lib/node_modules/cnpm/lib/parse_argv.js)</span><br><span class="line">npm@6.14.18 (/home/pico/webrtc/node-v15.0.0-linux-x64/lib/node_modules/cnpm/node_modules/npm/lib/npm.js)</span><br><span class="line">node@15.0.0 (/home/pico/webrtc/node-v15.0.0-linux-x64/bin/node)</span><br><span class="line">npminstall@5.8.1 (/home/pico/webrtc/node-v15.0.0-linux-x64/lib/node_modules/cnpm/node_modules/npminstall/lib/index.js)</span><br><span class="line">prefix=/home/pico/webrtc/node-v15.0.0-linux-x64</span><br><span class="line">linux x64 4.15.0-142-generic</span><br><span class="line">registry=https://registry.nlark.com</span><br></pre></td></tr></table></figure>

<h2 id="安装python"><a href="#安装python" class="headerlink" title="安装python"></a>安装python</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">没有默认安装python2则安装</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo apt-get install python</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo apt-get install python-webtest</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">python -V</span></span><br></pre></td></tr></table></figure>

<h2 id="安装google-appengine"><a href="#安装google-appengine" class="headerlink" title="安装google_appengine"></a>安装google_appengine</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> /root/webrtc</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget https://storage.googleapis.com/appengine-sdks/featured/google_appengine_1.9.40.zip</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">unzip google_appengine_1.9.40.zip</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改/root/.bashrc加入</span></span><br><span class="line">export PATH=$PATH:/root/webrtc/google_appengine</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使之生效</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">source</span> /root/.bashrc</span></span><br></pre></td></tr></table></figure>

<h2 id="安装go"><a href="#安装go" class="headerlink" title="安装go"></a>安装go</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo apt-get install golang-go</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">go version</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建go工作目录</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> ‐p /root/webrtc/goworkspace/src</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改/root/.bashrc加入</span></span><br><span class="line">export GOPATH=/root/webrtc/goworkspace</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使之生效</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">source</span> /root/.bashrc</span></span><br></pre></td></tr></table></figure>

<h2 id="安装apprtc"><a href="#安装apprtc" class="headerlink" title="安装apprtc"></a>安装apprtc</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> /root/webrtc</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git <span class="built_in">clone</span> https://github.com/webrtc/apprtc.git</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将collider的源码软连接到go的工作目录下</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ln</span> ‐s /root/webrtc/apprtc/src/collider/collider <span class="variable">$GOPATH</span>/src</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ln</span> ‐s /root/webrtc/apprtc/src/collider/collidermain <span class="variable">$GOPATH</span>/src</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ln</span> ‐s /root/webrtc/apprtc/src/collider/collidertest <span class="variable">$GOPATH</span>/src</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下一步在编译 go get collidermain: 被墙</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">报错: package golang.org/x/net/websocket: unrecognized import path <span class="string">&quot;golang.org/x/net/websocket&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">所以先执行:</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> ‐p <span class="variable">$GOPATH</span>/src/golang.org/x/</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/golang.org/x/</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git <span class="built_in">clone</span> https://github.com/golang/net.git net</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">go install net</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编译collidermain</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> /root/webrtc/goworkspace/src</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">go get collidermain</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">go install collidermain</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成collidermain</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> /root/webrtc/goworkspace/bin/</span></span><br></pre></td></tr></table></figure>

<h2 id="安装coturn"><a href="#安装coturn" class="headerlink" title="安装coturn"></a>安装coturn</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo apt-get install libssl-dev</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo apt-get install libevent-dev</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">返回webrtc目录</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> /root/webrtc</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">提供另一种安装方式turnserver是coturn的升级版本</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget http://coturn.net/turnserver/v4.5.0.7/turnserver-4.5.0.7.tar.gz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tar xfz turnserver-4.5.0.7.tar.gz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> turnserver-4.5.0.7</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编译安装</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./configure</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make install -j</span></span><br></pre></td></tr></table></figure>

<h2 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo apt-get update</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装依赖：gcc、g++依赖库</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo apt-get install build-essential libtool</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装 pcre依赖库（http://www.pcre.org/）</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo apt-get install libpcre3 libpcre3-dev</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装 zlib依赖库（http://www.zlib.net）</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo apt-get install zlib1g-dev</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装ssl依赖库</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo apt-get install openssl</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载nginx 1.15.8版本</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget http://nginx.org/download/nginx-1.15.8.tar.gz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tar xvzf nginx-1.15.8.tar.gz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> nginx-1.15.8/</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置，一定要支持https</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./configure --with-http_ssl_module</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编译安装</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo make install</span></span><br><span class="line"></span><br><span class="line">默认安装目录：/usr/local/nginx</span><br><span class="line">启动：sudo /usr/local/nginx/sbin/nginx</span><br><span class="line">停止：sudo /usr/local/nginx/sbin/nginx -s stop</span><br><span class="line">重新加载配置文件：sudo /usr/local/nginx/sbin/nginx -s reload</span><br></pre></td></tr></table></figure>

<h1 id="配置与运行"><a href="#配置与运行" class="headerlink" title="配置与运行"></a>配置与运行</h1><h2 id="coturn中继服务器"><a href="#coturn中继服务器" class="headerlink" title="coturn中继服务器"></a>coturn中继服务器</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo turnserver -L 0.0.0.0 -a -u <span class="built_in">test</span>:123456 -v -f -r nort.gov</span></span><br></pre></td></tr></table></figure>

<h2 id="collider信令服务器"><a href="#collider信令服务器" class="headerlink" title="collider信令服务器"></a>collider信令服务器</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="variable">$GOPATH</span>/bin/collidermain -port=8089 -tls=<span class="literal">false</span> ‐room-server=<span class="string">&quot;http://192.168.2.143:8090&quot;</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">room-server=<span class="string">&quot;http://192.168.2.143:8090&quot;</span> 实际是连接房间服务器的地址</span></span><br></pre></td></tr></table></figure>

<h2 id="apprtc房间服务器"><a href="#apprtc房间服务器" class="headerlink" title="apprtc房间服务器"></a>apprtc房间服务器</h2><h3 id="安装pip"><a href="#安装pip" class="headerlink" title="安装pip"></a>安装pip</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> /root/webrtc</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget https://pypi.python.org/packages/2.7/s/setuptools/setuptools-0.6c11-py2.7.egg --no-check-certificate</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">chmod</span> +x setuptools-0.6c11-py2.7.egg</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo ./setuptools-0.6c11-py2.7.egg</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget https://pypi.python.org/packages/source/p/pip/pip-1.5.4.tar.gz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tar -xf pip-1.5.4.tar.gz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> pip-1.5.4/</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo python setup.py install</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo pip install requests</span></span><br></pre></td></tr></table></figure>

<h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><p>配置文件修改（主要是配置apprtc对应的conturn和collider相关参数）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /home/lqf/webrtc/apprtc/src/app_engine/constants.py</span><br></pre></td></tr></table></figure>

<p>修改后（填的都是外网IP，为了适合更多数朋友测试，我这里用的是内网的环境，在公网部署填入公网IP即可）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># Turn/Stun server override. This allows AppRTC to connect to turn servers</span><br><span class="line"># directly rather than retrieving them from an ICE server provider.</span><br><span class="line"># ICE_SERVER_OVERRIDE = None 注释</span><br><span class="line"># Enable by uncomment below and comment out above, then specify turn and stun</span><br><span class="line">ICE_SERVER_OVERRIDE  = [</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;urls&quot;: [</span><br><span class="line">      &quot;turn:192.168.2.143:3478?transport=udp&quot;,</span><br><span class="line">      &quot;turn:192.168.2.143:3478?transport=tcp&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;username&quot;: &quot;test&quot;,</span><br><span class="line">    &quot;credential&quot;: &quot;123456&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;urls&quot;: [</span><br><span class="line">      &quot;stun:192.168.2.143:3478&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">ICE_SERVER_BASE_URL = &#x27;https:192.168.2.143&#x27;</span><br><span class="line">ICE_SERVER_URL_TEMPLATE = &#x27;%s/v1alpha/iceconfig?key=%s&#x27;</span><br><span class="line">ICE_SERVER_API_KEY = os.environ.get(&#x27;ICE_SERVER_API_KEY&#x27;)</span><br><span class="line"></span><br><span class="line"># Dictionary keys in the collider instance info constant.</span><br><span class="line">WSS_INSTANCE_HOST_KEY = &#x27;192.168.2.143:8088&#x27;</span><br><span class="line">WSS_INSTANCE_NAME_KEY = &#x27;vm_name&#x27;</span><br><span class="line">WSS_INSTANCE_ZONE_KEY = &#x27;zone&#x27;</span><br><span class="line">WSS_INSTANCES = [&#123;</span><br><span class="line">    WSS_INSTANCE_HOST_KEY: &#x27;192.168.2.143:8088&#x27;,</span><br><span class="line">    WSS_INSTANCE_NAME_KEY: &#x27;wsserver-std&#x27;,</span><br><span class="line">    WSS_INSTANCE_ZONE_KEY: &#x27;us-central1-a&#x27;</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>

<h3 id="apprtc编译运行"><a href="#apprtc编译运行" class="headerlink" title="apprtc编译运行"></a>apprtc编译运行</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> /root/webrtc/apprtc</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo cnpm install</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo grunt build</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/root/webrtc/google_appengine/dev_appserver.py --host=0.0.0.0 --port=8090 /root/webrtc/apprtc/out/app_engine --skip_sdk_update_check</span></span><br></pre></td></tr></table></figure>

<p>此时可以通过谷歌浏览器访问测试： <a target="_blank" rel="noopener" href="http://192.168.2.143:8090/">http://192.168.2.143:8090/</a> 。</p>
<h2 id="nginx代理"><a href="#nginx代理" class="headerlink" title="nginx代理"></a>nginx代理</h2><h3 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> ‐p /root/webrtc/cert</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> /root/webrtc/cert</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CA私钥</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">openssl genrsa ‐out key.pem 2048</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">自签名证书</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">openssl req ‐new ‐x509 ‐key key.pem ‐out cert.pem ‐days 1095</span></span><br></pre></td></tr></table></figure>

<h3 id="Web代理"><a href="#Web代理" class="headerlink" title="Web代理"></a>Web代理</h3><p>反向代理apprtc，使之支持https访问，如果http直接访问apprtc，则客户端无法启动视频音频采集（必须得用https访问) 。</p>
<p>完整配置文件：<code>/usr/local/nginx/conf/conf.d/apprtc-https-proxy.conf</code></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> roomserver &#123;</span><br><span class="line">  <span class="attribute">server</span> <span class="number">127.0.0.1:8090</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">  <span class="attribute">ssl_certificate</span> /root/webrtc/cert/cert.pem;</span><br><span class="line">  <span class="attribute">ssl_certificate_key</span> /root/webrtc/cert/key.pem;</span><br><span class="line">  <span class="attribute">charset</span> utf‐<span class="number">8</span>;</span><br><span class="line">  <span class="comment"># ip地址或者域名</span></span><br><span class="line">  <span class="attribute">server_name</span> <span class="number">192.168.2.143</span>;</span><br><span class="line">  <span class="section">location</span> / &#123;</span><br><span class="line">    <span class="comment"># 转向代理的地址</span></span><br><span class="line">    <span class="attribute">proxy_pass</span> http://roomserver<span class="variable">$request_uri</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编辑nginx.conf文件，在末尾<code>&#125;</code>之前添加包含文件。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">  <span class="attribute">include</span> /usr/local/nginx/conf/conf.d/<span class="regexp">*.conf</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="配置websocket代理"><a href="#配置websocket代理" class="headerlink" title="配置websocket代理"></a>配置websocket代理</h3><p>完整配置文件：<code>/usr/local/nginx/conf/conf.d/apprtc-websocket-proxy.conf </code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">map $http_upgrade $connection_upgrade &#123;</span><br><span class="line">    default upgrade;</span><br><span class="line">    &#x27;&#x27; close;</span><br><span class="line">&#125;</span><br><span class="line">upstream websocket &#123;</span><br><span class="line">    server 127.0.0.1:8089;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 8088 ssl;</span><br><span class="line">    ssl_certificate /home/pico/webrtc/cert/cert.pem;</span><br><span class="line">    ssl_certificate_key /home/pico/webrtc/cert/key.pem;</span><br><span class="line"></span><br><span class="line">    server_name 192.168.2.143;</span><br><span class="line">    location /ws &#123;</span><br><span class="line">    proxy_pass http://websocket;</span><br><span class="line">    proxy_http_version 1.1;</span><br><span class="line">    proxy_connect_timeout 4s; #配置点1</span><br><span class="line">    proxy_read_timeout 6000s; #配置点2，如果没效，可以考虑这个时间配置长一点</span><br><span class="line">    proxy_send_timeout 6000s; #配置点3</span><br><span class="line">    proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">    proxy_set_header Connection $connection_upgrade;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="解决跨域问题"><a href="#解决跨域问题" class="headerlink" title="解决跨域问题"></a>解决跨域问题</h3><p>浏览器通话跨域问题 :pushState </p>
<p><code>Messages:Failed to start signaling: Failed to execute &#39;pushState&#39; on &#39;History&#39;</code></p>
<p>修改文件<code>root/webrtc/apprtc/src/web_app/js/appcontroller.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">查找AppController.prototype.displaySharingInfo_函数第一行增加</span><br><span class="line">roomLink=roomLink.replace(&quot;http&quot;,&quot;https&quot;);</span><br><span class="line"></span><br><span class="line">最终效果</span><br><span class="line">AppController.prototype.displaySharingInfo_ = function(roomId, roomLink) &#123;</span><br><span class="line">  roomLink=roomLink.replace(&quot;http&quot;,&quot;https&quot;);</span><br><span class="line">  this.roomLinkHref_.href = roomLink;</span><br><span class="line">  this.roomLinkHref_.text = roomLink;</span><br><span class="line">  this.roomLink_ = roomLink;</span><br><span class="line">  this.pushCallNavigation_(roomId, roomLink);</span><br><span class="line">  this.activate_(this.sharingDiv_);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>重新编译运行apprtc</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> /root/webrtc/apprtc</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo grunt build</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/root/webrtc/google_appengine/dev_appserver.py --host=0.0.0.0 --port=8090 /root/webrtc/apprtc/out/app_engine --skip_sdk_update_check</span></span><br></pre></td></tr></table></figure>

<p>此时可以通过谷歌浏览器访问测试： <a target="_blank" rel="noopener" href="https://192.168.2.143/">https://192.168.2.143</a> 。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><pre class="mermaid">graph LR
    F1[Web]--https port=443-->F2[nginx Web代理]
    F1--wss port=8088-->F3[nginx WebSocket代理]
    F1--ICE port=3478-->F4[coturn服务]
    F2--http port=8090-->F5[AppRTCWeb+房间服务]
    F3--ws port=8089-->F6[AppRTC Collider信令服务]</pre>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/10/14/WebRTC%E4%B8%80%E5%AF%B9%E4%B8%80%E9%80%9A%E8%AF%9D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/14/WebRTC%E4%B8%80%E5%AF%B9%E4%B8%80%E9%80%9A%E8%AF%9D/" class="post-title-link" itemprop="url">WebRTC一对一通话</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-10-14 20:03:33" itemprop="dateCreated datePublished" datetime="2023-10-14T20:03:33+08:00">2023-10-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-12-30 22:37:01" itemprop="dateModified" datetime="2023-12-30T22:37:01+08:00">2023-12-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/WebRTC/" itemprop="url" rel="index"><span itemprop="name">WebRTC</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="一对一通话"><a href="#一对一通话" class="headerlink" title="一对一通话"></a>一对一通话</h1><img src="/2023/10/14/WebRTC%E4%B8%80%E5%AF%B9%E4%B8%80%E9%80%9A%E8%AF%9D/一对一通话.png" alt="一对一通话" style="zoom:70%;">

<h2 id="信令协议设计"><a href="#信令协议设计" class="headerlink" title="信令协议设计"></a>信令协议设计</h2><ul>
<li><code>join</code> 加入房间。</li>
<li><code>resp­-join</code> 当join房间后发现房间已经存在另一个人时则返回另一个人的uid；如果只有自己则不返回。</li>
<li><code>new­-peer</code> 服务器通知客户端有新人加入，收到new­-peer则发起连接请求。</li>
<li><code>offer</code> 转发offer sdp。</li>
<li><code>answer</code> 转发answer sdp。</li>
<li><code>candidate</code> 转发candidate sdp。 </li>
<li><code>leave</code> 离开房间，服务器收到leave信令则检查同一房间是否有其他人，如果有其他人则通知他有人离开。</li>
<li><code>peer­-leave</code> 服务器通知客户端有人离开。</li>
</ul>
<h2 id="RTCPeerConnection"><a href="#RTCPeerConnection" class="headerlink" title="RTCPeerConnection"></a>RTCPeerConnection</h2><p><code>RTCPeerConnection</code> 接口代表一个由本地计算机到远端的 WebRTC 连接。该接口提供了创建，保持，监控，关闭连接的方法的实现。</p>
<p>参考链接：<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/RTCPeerConnection">https://developer.mozilla.org/zh-CN/docs/Web/API/RTCPeerConnection</a></p>
<p><strong>RTCPeerConnection</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pc = <span class="keyword">new</span> <span class="title class_">RTCPeerConnection</span>([configuration]);</span><br></pre></td></tr></table></figure>

<p>configuration可选</p>
<ul>
<li><p><code>bundlePolicy</code>：一般用<code>max­bundle</code>。</p>
<ul>
<li><code>banlanced</code>：音频与视频轨使用各自的传输通道。</li>
<li><code>max­compat</code>：每个轨使用自己的传输通道。</li>
<li><code>max­bundle</code>：都绑定到同一个传输通道。</li>
</ul>
</li>
<li><p><code>iceTransportPolicy</code>：指定ICE的传输策略，一般用<code>all</code>。</p>
<ul>
<li><code>relay</code>：只使用中继候选者。</li>
<li><code>all</code>：可以使用任何类型的候选者。</li>
</ul>
</li>
<li><p><code>iceServers</code>：其由RTCIceServer组成，每个RTCIceServer都是一个ICE代理的服务器。</p>
<ul>
<li><code>credential </code>：凭据，只有TURN服务使用。</li>
<li><code>credentialType</code>：凭据类型，可以password或oauth。</li>
<li><code>urls </code>：用于连接服中的ur数组。</li>
<li><code>username</code>：用户名，只有TURN服务使用。</li>
</ul>
</li>
<li><p><code>rtcpMuxPolicy</code>：rtcp的复用策略，该选项在收集ICE候选者时使用，一般用<code>require</code>。</p>
<ul>
<li><code>negotiate</code>：收集RTCP与RTP复用的ICE候选者，如果RTCP能复用就与RTP复用，如果不能复用，就将他们单独使用。</li>
<li><code>require</code>：只能收集RTCP与RTP复用的ICE候选者，如果RTCP不能复用，则失败。</li>
</ul>
</li>
</ul>
<p><strong>事件处理回调</strong></p>
<ul>
<li><code>onicecandidate</code>：收到候选者时触发的事件。</li>
<li><code>ontrack</code>：获取远端流。</li>
<li><code>onconnectionstatechange</code>：PeerConnection的连接状态。</li>
<li><code>oniceconnectionstatechange</code>：ICE连接事件。</li>
</ul>
<h2 id="媒体协商"><a href="#媒体协商" class="headerlink" title="媒体协商"></a>媒体协商</h2><img src="/2023/10/14/WebRTC%E4%B8%80%E5%AF%B9%E4%B8%80%E9%80%9A%E8%AF%9D/媒体协商.png" alt="媒体协商" style="zoom:70%;">

<p><strong>createOffer</strong></p>
<p>生成一个 offer，它是一个带有特定的配置信息寻找远端匹配机器（peer）的请求。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">aPromise = myPeerConnection.<span class="title function_">createOffer</span>([options]);</span><br><span class="line"></span><br><span class="line"><span class="comment">//[options] 参数：</span></span><br><span class="line"><span class="keyword">var</span> options = &#123;</span><br><span class="line">    <span class="attr">offerToReceiveAudio</span>: <span class="literal">true</span>, <span class="comment">// 告诉另一端，你是否想接收音频，默认true </span></span><br><span class="line">    <span class="attr">offerToReceiveVideo</span>: <span class="literal">true</span>, <span class="comment">// 告诉另一端，你是否想接收视频，默认true </span></span><br><span class="line">    <span class="attr">iceRestart</span>: <span class="literal">false</span>, <span class="comment">// 是否在活跃状态重启ICE网络协商 </span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>createAnswer</strong></p>
<p>在协调一条连接中的两端 offer&#x2F;answers 时，根据从远端发来的 offer 生成一个 answer。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aPromise = <span class="title class_">RTCPeerConnection</span>.<span class="title function_">createAnswer</span>([options]); <span class="comment">//目前createAnswer的options是 无效的。</span></span><br></pre></td></tr></table></figure>

<p><strong>setLocalDescription</strong></p>
<p>改变与连接相关的本地描述。这个描述定义了连接的属性，例如：连接的编码方式。连接会受到它的改变的影响，而且连接必须能同时支持新的以及旧的描述。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aPromise = <span class="title class_">RTCPeerConnection</span>.<span class="title function_">setLocalDescription</span>(sessionDescription);</span><br></pre></td></tr></table></figure>

<p><strong>setRemoteDescription</strong></p>
<p>改变与连接相关的远端描述。这个描述定义了连接的属性，例如：连接的编码方式。连接会受到它的改变的影响，而且连接必须能同时支持新的以及旧的描述。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aPromise = <span class="title class_">RTCPeerConnection</span>.<span class="title function_">setRemoteDescription</span>(sessionDescription);</span><br></pre></td></tr></table></figure>

<h2 id="添加媒体流"><a href="#添加媒体流" class="headerlink" title="添加媒体流"></a>添加媒体流</h2><p><strong>addTrack</strong></p>
<p>将一个新的媒体音轨添加到一组音轨中，这些音轨将被传输给另一个对等点。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rtpSender = rtcPeerConnection.<span class="title function_">addTrack</span>(track, stream...);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">参数：</span></span><br><span class="line"><span class="comment">track：一个MediaStreamTrack对象，表示要添加到对等连接的媒体轨道。</span></span><br><span class="line"><span class="comment">stream...：可选一个或多个本地的MediaStream对象，该轨迹应添加到其中。</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="网络协商"><a href="#网络协商" class="headerlink" title="网络协商"></a>网络协商</h2><p>添加一个 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Glossary/ICE">ICE</a> 代理。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aPromise = pc.<span class="title function_">addIceCandidate</span>(candidate);</span><br></pre></td></tr></table></figure>

<p>candidate有Web端（和Android不同）相关属性：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>candidate</td>
<td>候选者描述信息</td>
</tr>
<tr>
<td>sdpMid</td>
<td>与候选者相关的媒体流的识别标签</td>
</tr>
<tr>
<td>sdpMLineIndex</td>
<td>在SDP中 m&#x3D;的索引值</td>
</tr>
<tr>
<td>usernameFragment</td>
<td>包括了远端的唯一标识</td>
</tr>
</tbody></table>
<h1 id="Coturn服务"><a href="#Coturn服务" class="headerlink" title="Coturn服务"></a>Coturn服务</h1><p>coturn穿透和转发服务器，集成了stun+turn协议。 </p>
<p><strong>编译安装</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/coturn/coturn</span><br><span class="line">cd coturn</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<p><strong>是否安装成功</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">turnserver ‐L 0.0.0.0 ‐a ‐u test:123456 ‐v ‐f ‐r nort.gov</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看相应的端口号3478是否存在进程</span></span><br><span class="line">sudo lsof ‐i:3478</span><br></pre></td></tr></table></figure>

<p><strong>测试地址</strong></p>
<p>测试网址：<a target="_blank" rel="noopener" href="https://webrtc.github.io/samples/src/content/peerconnection/trickle-ice/">https://webrtc.github.io/samples/src/content/peerconnection/trickle-ice/</a></p>
<h1 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h1><h2 id="局域网测试"><a href="#局域网测试" class="headerlink" title="局域网测试"></a>局域网测试</h2><p><strong>启动conturn</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">turnserver ‐L 0.0.0.0 ‐a ‐u test:123456 ‐v ‐f ‐r nort.gov</span><br></pre></td></tr></table></figure>

<p><strong>配置RTCPeerConnection参数</strong></p>
<p><code>RTCPeerConnection</code>时传入ICE server的参数，以便当在公网环境下可以进行正常通话。</p>
<p>设置configuration，先设置为relay中继模式，只有relay中继模式可用的时候，才能部署到公网去（部署到公网后也先测试relay）。 </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> defaultConfiguration = &#123;</span><br><span class="line"><span class="attr">bundlePolicy</span>: <span class="string">&quot;max-bundle&quot;</span>,</span><br><span class="line"><span class="attr">rtcpMuxPolicy</span>: <span class="string">&quot;require&quot;</span>,</span><br><span class="line"><span class="attr">iceTransportPolicy</span>: <span class="string">&quot;relay&quot;</span>, <span class="comment">//relay 或者 all，测试用relay</span></span><br><span class="line"><span class="comment">// 修改ice数组测试效果，需要进行封装</span></span><br><span class="line"><span class="attr">iceServers</span>: [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">urls</span>: [</span><br><span class="line">      <span class="string">&quot;turn:192.168.2.101:3478?transport=udp&quot;</span>,</span><br><span class="line">      <span class="string">&quot;turn:192.168.2.101:3478?transport=tcp&quot;</span>, <span class="comment">// 可以插入多个进行备选</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">username</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">    <span class="attr">credential</span>: <span class="string">&quot;123456&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">urls</span>: [<span class="string">&quot;stun:192.168.2.101:3478&quot;</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">],</span><br><span class="line">&#125;;</span><br><span class="line">pc = <span class="keyword">new</span> <span class="title class_">RTCPeerConnection</span>(defaultConfiguration</span><br></pre></td></tr></table></figure>

<p><strong>局域网测试</strong></p>
<p>启动通话后，如果使用relay模式断开conturn后会发现Web是无法通信的，但是使用all模式断开conturn后依然可以通信。</p>
<h2 id="公网部署"><a href="#公网部署" class="headerlink" title="公网部署"></a>公网部署</h2><p>注意公网防火墙问题，比如 coturn涉及到的3478端口是否开放。在局域网上搭建，部署公网只需要替换公网IP即可。</p>
<p><strong>nginx安装</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx‐1.15.8.tar.gz</span><br><span class="line">tar xvzf nginx‐1.15.8.tar.gz</span><br><span class="line">cd nginx‐1.15.8/</span><br><span class="line"></span><br><span class="line">./configure ‐‐with‐http_ssl_module</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br><span class="line"></span><br><span class="line">启动：sudo /usr/local/nginx/sbin/nginx </span><br><span class="line">停止：sudo /usr/local/nginx/sbin/nginx -s stop</span><br><span class="line">重新加载配置文件：sudo /usr/local/nginx/sbin/nginx -s reload</span><br></pre></td></tr></table></figure>

<p><strong>产生证书</strong> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir ‐p ~/cert</span><br><span class="line">cd ~/cert</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CA私钥</span></span><br><span class="line">openssl genrsa -out key.pem 2048</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">自签名证书</span></span><br><span class="line">openssl req -new -x509 -key key.pem -out cert.pem -days 1095</span><br></pre></td></tr></table></figure>

<p><strong>配置web服务器</strong></p>
<p>添加<code>/usr/local/nginx/conf/conf.d/webrtc-https.conf</code></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">    <span class="comment"># 配置自己的证书</span></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /root/cert/cert.pem;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /root/cert/key.pem;</span><br><span class="line">    <span class="attribute">charset</span> utf‐<span class="number">8</span>;</span><br><span class="line">    <span class="comment"># ip地址或者域名</span></span><br><span class="line">    <span class="attribute">server_name</span> <span class="number">192.168.2.101</span>;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">add_header</span> <span class="string">&#x27;Access‐Control‐Allow‐Origin&#x27;</span> <span class="string">&#x27;*&#x27;</span>;</span><br><span class="line">        <span class="attribute">add_header</span> <span class="string">&#x27;Access‐Control‐Allow‐Credentials&#x27;</span> <span class="string">&#x27;true&#x27;</span>;</span><br><span class="line">        <span class="attribute">add_header</span> <span class="string">&#x27;Access‐Control‐Allow‐Methods&#x27;</span> <span class="string">&#x27;*&#x27;</span>;</span><br><span class="line">        <span class="attribute">add_header</span> <span class="string">&#x27;Access‐Control‐Allow‐Headers&#x27;</span> <span class="string">&#x27;Origin, X‐Requested‐With, Content‐Type, Accept&#x27;</span>;</span><br><span class="line">        <span class="comment"># web页面所在目录</span></span><br><span class="line">        <span class="attribute">root</span> /root/webrtc/client;</span><br><span class="line">        <span class="attribute">index</span> index.php index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编辑<code>nginx.conf</code>文件，在末尾<code>&#125;</code>之前添加包含文件。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">    <span class="attribute">include</span> /usr/local/nginx/conf/conf.d/<span class="regexp">*.conf</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果遇到权限问题，编辑<code>nginx.conf</code>文件，加入。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">user</span> root owner;</span><br></pre></td></tr></table></figure>

<p>页面打开<a target="_blank" rel="noopener" href="https://192.168.2.101测试./">https://192.168.2.101测试。</a></p>
<p><strong>配置websocket代理</strong></p>
<p>此时Web不能直接访问信令服务器，https不能访问ws，本身是安全的访问，不能降级做不安全的访问。</p>
<p>使用Nginx服务器代理访问信令服务器。</p>
<p>完整配置文件：<code>/usr/local/nginx/conf/conf.d/webrtc-websocket-proxy.conf</code></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">map</span> <span class="variable">$http_upgrade</span> <span class="variable">$connection_upgrade</span> &#123;</span><br><span class="line">    <span class="attribute">default</span> upgrade;</span><br><span class="line">    &#x27;&#x27; close;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">upstream</span> websocket &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.2.101:8099</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8098</span> ssl;</span><br><span class="line">    <span class="comment">#ssl on;</span></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /root/cert/cert.pem;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /root/cert/key.pem;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">server_name</span> <span class="number">192.168.2.101</span>;</span><br><span class="line">    <span class="section">location</span> /ws &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://websocket;</span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="variable">$connection_upgrade</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>websocket超时断开</strong></p>
<p>在通话时，出现60秒后客户端自动断开的问题，是因为经过nginx代理时，如果websocket长时间没有收发消息则该websocket将会被断开。我们这里可以修改收发消息的时间间隔。</p>
<ul>
<li><strong>proxy_connect_timeout：</strong>设置代理服务器与后端服务器建立连接的超时时间。</li>
<li><strong>proxy_read_timeout：</strong>设置代理服务器从后端服务器读取数据的超时时间。</li>
<li><strong>proxy_send_timeout：</strong>设置代理服务器向后端服务器发送数据的超时时间。</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">map</span> <span class="variable">$http_upgrade</span> <span class="variable">$connection_upgrade</span> &#123;</span><br><span class="line">    <span class="attribute">default</span> upgrade;</span><br><span class="line">    &#x27;&#x27; close;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">upstream</span> websocket &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.2.101:8099</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8098</span> ssl;</span><br><span class="line">    <span class="comment">#ssl on;</span></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /root/cert/cert.pem;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /root/cert/key.pem;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">server_name</span> <span class="number">192.168.2.101</span>;</span><br><span class="line">    <span class="section">location</span> /ws &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://websocket;</span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_connect_timeout</span> <span class="number">4s</span>;</span><br><span class="line">        <span class="attribute">proxy_read_timeout</span> <span class="number">6000s</span>;</span><br><span class="line">        <span class="attribute">proxy_send_timeout</span> <span class="number">6000s</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="variable">$connection_upgrade</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><pre class="mermaid">graph LR
    F1[客户端]--https port=443-->F2[Web服务]
    F2--wss port=8098 path=/ws-->F3[nginx代理信令服务]
    F3--http port=8099-->F4[信令服务]
    F1--ICE port=3478-->F5[Coturn服务]</pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/10/11/WebSocket%E5%8D%8F%E8%AE%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/11/WebSocket%E5%8D%8F%E8%AE%AE/" class="post-title-link" itemprop="url">WebSocket协议</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-10-11 22:59:27" itemprop="dateCreated datePublished" datetime="2023-10-11T22:59:27+08:00">2023-10-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-16 18:47:25" itemprop="dateModified" datetime="2024-01-16T18:47:25+08:00">2024-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Protocol/" itemprop="url" rel="index"><span itemprop="name">Protocol</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="WebSocket介绍"><a href="#WebSocket介绍" class="headerlink" title="WebSocket介绍"></a>WebSocket介绍</h1><p>WebSocket 是 HTML5 开始提供的一种在单个 TCP 连接上进行全双工通讯的协议。 WebSocket 使得客户端和服务器之间的数据交换变得更加简单，允许服务端主动向客户端推送数据。在 WebSocket API 中，浏览器和服务器只需要完成一次握手，两者之间就直接可以创建持久性的连接，并进行双向数据传输。</p>
<p>WebSocket 通信流程：</p>
<img src="/2023/10/11/WebSocket%E5%8D%8F%E8%AE%AE/WebSocket通信流程.png" alt="WebSocket通信流程" style="zoom:80%;">

<p>为了建立一个 WebSocket 连接，客户端浏览器首先要向服务器发起一个 HTTP 请求，这个请求和通常的 HTTP 请求不同，包含了一些附加头信息，其中附加头信息”<strong>Upgrade: WebSocket</strong>“表明这是一个申请协议升级的 HTTP 请求，服务器端解析这些附加的头信息然后产生应答信息返回给客户端，客户端和服务器端的 WebSocket 连接就建立起来了，双方就可以通过这个连接通道自由的传递信息，并且这个连接会持续存在直到客户端或者服务器端的某一方主动的关闭连接。</p>
<p>申请协议升级 HTTP 请求响应：</p>
<img src="/2023/10/11/WebSocket%E5%8D%8F%E8%AE%AE/HTTP升级WebSocket报文.png" alt="HTTP升级WebSocket报文" style="zoom:50%;">

<p>WebSocket 报文格式：</p>
<img src="/2023/10/11/WebSocket%E5%8D%8F%E8%AE%AE/websocket报文.png" alt="websocket报文" style="zoom:50%;">

<h1 id="WebSocket例子"><a href="#WebSocket例子" class="headerlink" title="WebSocket例子"></a>WebSocket例子</h1><h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Websocket通信<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;sendMsg&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;submitBtn&quot;</span>&gt;</span>Send<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">showMessage</span>(<span class="params">str, type</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">var</span> div = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;div&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">      div.<span class="property">innerHTML</span> = str;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">if</span> (type == <span class="string">&quot;enter&quot;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        div.<span class="property">style</span>.<span class="property">color</span> = <span class="string">&quot;blue&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="string">&quot;leave&quot;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        div.<span class="property">style</span>.<span class="property">color</span> = <span class="string">&quot;red&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(div);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> websocket = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&quot;ws://127.0.0.1:8010&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//open connection</span></span></span><br><span class="line"><span class="language-javascript">    websocket.<span class="property">onopen</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;connect to server&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">//bind btn click event</span></span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;submitBtn&quot;</span>).<span class="property">onclick</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> txt = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;sendMsg&quot;</span>).<span class="property">value</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (txt) &#123;</span></span><br><span class="line"><span class="language-javascript">          websocket.<span class="title function_">send</span>(txt);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">      &#125;;</span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//close connection</span></span></span><br><span class="line"><span class="language-javascript">    websocket.<span class="property">onclose</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;websocket close&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//error connection</span></span></span><br><span class="line"><span class="language-javascript">    websocket.<span class="property">onerror</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;websocket error&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//receive message</span></span></span><br><span class="line"><span class="language-javascript">    websocket.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">var</span> mes = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(e.<span class="property">data</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">showMessage</span>(mes.<span class="property">data</span>, mes.<span class="property">type</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h2><p>服务器端使用 WebSocket 需要安装 nodejs­-websocket。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm init # 创建package.json文件，系统会提示相关配置，也可以使用命令： </span><br><span class="line">npm init ‐y </span><br><span class="line">npm install nodejs-websocket</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ws = <span class="built_in">require</span>(<span class="string">&quot;nodejs-websocket&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> port = <span class="number">8010</span>;</span><br><span class="line"><span class="keyword">var</span> user = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = ws.<span class="title function_">createServer</span>(<span class="keyword">function</span> (<span class="params">conn</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;create a new connection...&quot;</span>);</span><br><span class="line">    user++;</span><br><span class="line">    conn.<span class="property">nickname</span> = <span class="string">&quot;user&quot;</span> + user;</span><br><span class="line">    conn.<span class="property">fd</span> = <span class="string">&quot;user&quot;</span> + user;</span><br><span class="line">    <span class="keyword">var</span> mes = &#123;&#125;;</span><br><span class="line">    mes.<span class="property">type</span> = <span class="string">&quot;enter&quot;</span>;</span><br><span class="line">    mes.<span class="property">data</span> = conn.<span class="property">nickname</span> + <span class="string">&quot;进来了&quot;</span>;</span><br><span class="line">    <span class="title function_">broadcast</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(mes));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//send message</span></span><br><span class="line">    conn.<span class="title function_">on</span>(<span class="string">&quot;text&quot;</span>, <span class="keyword">function</span>(<span class="params">str</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;回复:&quot;</span> + str);</span><br><span class="line">        mes.<span class="property">type</span> = <span class="string">&quot;message&quot;</span>;</span><br><span class="line">        mes.<span class="property">data</span> = conn.<span class="property">nickname</span> + <span class="string">&quot; 说: &quot;</span> + str;</span><br><span class="line">        <span class="title function_">broadcast</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(mes));</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//close connection</span></span><br><span class="line">    conn.<span class="title function_">on</span>(<span class="string">&quot;close&quot;</span>, <span class="keyword">function</span>(<span class="params">code, reason</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;关闭连接&quot;</span>);</span><br><span class="line">        mes.<span class="property">type</span> = <span class="string">&quot;leave&quot;</span>;</span><br><span class="line">        mes.<span class="property">data</span> = conn.<span class="property">nickname</span> + <span class="string">&quot; 离开了&quot;</span>;</span><br><span class="line">        <span class="title function_">broadcast</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(mes));</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//error</span></span><br><span class="line">    conn.<span class="title function_">on</span>(<span class="string">&quot;error&quot;</span>, <span class="keyword">function</span>(<span class="params">err</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;监听错误:&quot;</span> + err);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;).<span class="title function_">listen</span>(port);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;server listen on port: &quot;</span> + port);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">broadcast</span>(<span class="params">str</span>) &#123;</span><br><span class="line">    server.<span class="property">connections</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">connection</span>)&#123;</span><br><span class="line">        connection.<span class="title function_">sendText</span>(str);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/10/09/WebRTC%E4%BB%8B%E7%BB%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/09/WebRTC%E4%BB%8B%E7%BB%8D/" class="post-title-link" itemprop="url">WebRTC介绍</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-10-09 19:16:26" itemprop="dateCreated datePublished" datetime="2023-10-09T19:16:26+08:00">2023-10-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-18 13:48:18" itemprop="dateModified" datetime="2024-01-18T13:48:18+08:00">2024-01-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/WebRTC/" itemprop="url" rel="index"><span itemprop="name">WebRTC</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="WebRTC介绍"><a href="#WebRTC介绍" class="headerlink" title="WebRTC介绍"></a>WebRTC介绍</h1><p>WebRTC（Web Real­Time Communication）是 Google 于 2010 以 6829 万美元从 Global IP Solutions 公司购买，并于 2011 年将其开源，旨在建立一个互联网浏览器间的实时通信的平台，让 WebRTC 技术成为 H5 标准之一。WebRTC 是一个免费的开放项目，它通过简单的 API 为浏览器和移动应用程序提供实时通信（RTC）功能。</p>
<h1 id="WebRTC框架"><a href="#WebRTC框架" class="headerlink" title="WebRTC框架"></a>WebRTC框架</h1><img src="/2023/10/09/WebRTC%E4%BB%8B%E7%BB%8D/WebRTC框架.png" alt="WebRTC框架" style="zoom:50%;">

<p>上图的框架对于不同的开发人员关注点不同： </p>
<ul>
<li>紫色部分是 Web 应用开发者 API 层</li>
<li>蓝色实线部分是面向浏览器厂商的 API 层</li>
<li>蓝色虚线部分浏览器厂商可以自定义实现</li>
</ul>
<p>特别是图中的 PeerConnection 为 Web 开发人员提供了一个抽象，从复杂的内部结构中抽象出来。注意关注 PeerConnection 这个对象即可以开发音视频通话应用。 </p>
<h2 id="WebRTC架构组件介绍"><a href="#WebRTC架构组件介绍" class="headerlink" title="WebRTC架构组件介绍"></a>WebRTC架构组件介绍</h2><h3 id="Web-APP"><a href="#Web-APP" class="headerlink" title="Web APP"></a>Web APP</h3><p>Web 开发者开发的程序，Web 开发者可以基于集成 WebRTC 的浏览器提供的 Web API 开发基于视频、音频的实时通信应用。</p>
<h3 id="Web-API"><a href="#Web-API" class="headerlink" title="Web API"></a>Web API</h3><p>面向第三方开发者的 WebRTC 标准 API（Javascript），使开发者能够容易地开发出类似于网络视频聊天的 Web 应用。</p>
<h3 id="WebRTC-Native-C-API"><a href="#WebRTC-Native-C-API" class="headerlink" title="WebRTC Native C++ API"></a>WebRTC Native C++ API</h3><p>本地 C++ API 层，使浏览器厂商容易实现 WebRTC 标准的 Web API，抽象地对数字信号过程进行处理。</p>
<h3 id="Transport-Session"><a href="#Transport-Session" class="headerlink" title="Transport &#x2F; Session"></a>Transport &#x2F; Session</h3><p>传输&#x2F;会话层，会话层组件采用了 libjingle 库的部分组件实现，无需使用 xmpp&#x2F;jingle 协议。</p>
<h3 id="VoiceEngine"><a href="#VoiceEngine" class="headerlink" title="VoiceEngine"></a>VoiceEngine</h3><p>WebRTC 音频处理引擎，包含一系列音频多媒体处理的框架，VoiceEngine 是 WebRTC 极具价值的技术之一，是 Google 收购 GIPS 公司后开源的。在 VoIP上，技术业界领先。</p>
<p>Opus：支持从 6 kbit&#x2F;s 到 510 kbit&#x2F;s 的恒定和可变比特率编码，帧大小从 2.5 ms 到 60 ms，各种采样率从 8 kHz（4 kHz 带宽）到 48 kHz（20 kHz 带宽，可复制人类听觉系统的整个听力范围）。由 IETF RFC 6176 定义。</p>
<p>NetEQ 模块是 WebRTC 语音引擎中的核心模块 ，一种动态抖动缓冲和错误隐藏算法，用于隐藏网络抖动和数据包丢失的负面影响。保持尽可能低的延迟，同时保持最高的语音质量。</p>
<h3 id="VideoEngine"><a href="#VideoEngine" class="headerlink" title="VideoEngine"></a>VideoEngine</h3><p>WebRTC 视频处理引擎，VideoEngine 是包含一系列视频处理的整体框架，从摄像头采集视频到视频信息网络传输再到视频显示整个完整过程的解决方案。VP8 视频图像编解码器，是 WebRTC 视频引擎的默认的编解码，VP8 适合实时通信应用场景，因为它主要是针对低延时而设计的编解码器。 </p>
<h1 id="WebRTC发展前景"><a href="#WebRTC发展前景" class="headerlink" title="WebRTC发展前景"></a>WebRTC发展前景</h1><p>WebRTC 虽然冠以“web”之名，但并不受限于传统互联网应用或浏览器的终端运行环境。实际上<strong>无论终端运行环境是浏览器、桌面应用、移动设备（Android 或 iOS）还是 IoT 设备，只要IP连接可到达且符合 WebRTC 规范就可以互通</strong>。这一点释放了大量智能终端（或运行在智能终端上的app）的实时通信能力，打开了许多对于实时交互性要求较高的应用场景的想象空间，譬如在线教育、视频会议、视频社交、远程协助、远程操控等等都是其合适的应用领域。</p>
<h1 id="WebRTC通话原理"><a href="#WebRTC通话原理" class="headerlink" title="WebRTC通话原理"></a>WebRTC通话原理</h1><p>问题：两个不同网络环境的（具备摄像头&#x2F;麦克风多媒体设备的）浏览器，要实现点对点的实时音视频对话，难点在哪里？ </p>
<h2 id="媒体协商"><a href="#媒体协商" class="headerlink" title="媒体协商"></a>媒体协商</h2><p><strong>彼此要了解对方支持的媒体格式。</strong></p>
<p>在 WebRTC 中用来描述网络信息的术语叫 <strong>SDP</strong>。</p>
<p>比如：Peer­A端可支持 VP8、H264 多种编码格式，而 Peer­B 端支持 VP9、H264，要保证二端都正确的编解码，最简单的办法就是取它们的交集 H264。</p>
<p>注：有一个专门的协议 ，称为Session Description Protocol （SDP），可用于描述上述这类信息，在 WebRTC 中，<strong>参与视频通讯的双方必须先交换SDP信息</strong>，这样双方才能知根知底，而交换SDP的过程，也称为”<strong>媒体协商</strong>“。</p>
<h2 id="网络协商"><a href="#网络协商" class="headerlink" title="网络协商"></a>网络协商</h2><p><strong>彼此要了解对方的网络情况，这样才有可能找到一条相互通讯的链路。</strong></p>
<p>在 WebRTC 中用来描述网络信息的术语叫 <strong>Candidate</strong>。</p>
<p>解决方式：</p>
<ul>
<li>获取外网IP地址映射。</li>
<li>通过信令服务器（signal server）交换网络信息。</li>
</ul>
<p>对于理想的网络情况是每个浏览器的电脑都是私有公网 IP，可以直接进行点对点连接。</p>
<img src="/2023/10/09/WebRTC%E4%BB%8B%E7%BB%8D/理想网络情况.png" alt="理想网络情况" style="zoom:50%;">



<p>但是实际情况是我们的电脑和电脑之前或大或小都是在某个局域网中，需要 NAT（Network Address Translation，网络地址转换）。</p>
<img src="/2023/10/09/WebRTC%E4%BB%8B%E7%BB%8D/实际网络情况.png" alt="实际网络情况" style="zoom:50%;">

<p>在解决 WebRTC 使用过程中的上述问题的时候，我们需要用到 STUN 和 TURN。</p>
<h3 id="STUN"><a href="#STUN" class="headerlink" title="STUN"></a>STUN</h3><p>STUN（Session Traversal Utilities for NAT，NAT会话穿越应用程序）是一种网络协议，它允许位于 NAT（或多重 NAT）后的<strong>客户端找出自己的公网地址</strong>，查出自己位于哪种类型的 NAT 之后以及 <strong>NAT 为某一个本地端口所绑定的 Internet 端端口</strong>。这些信息被用来在两个同时处于 NAT 路由器之后的主机之间创建 UDP 通信。该协议由 RFC 5389 定义。</p>
<p>在遇到上述情况的时候，我们可以建立一个 STUN 服务器，这个服务器做什么用的呢？主要是<strong>给无法在公网环境下的视频通话设备分配公网 IP 用的</strong>。这样两台电脑就可以在公网 IP 中进行通话。</p>
<img src="/2023/10/09/WebRTC%E4%BB%8B%E7%BB%8D/STUN服务器.png" alt="STUN服务器" style="zoom:50%;">

<p>使用一句话说明 STUN 做的事情就是：<strong>告诉我你的公网 IP 地址+端口是什么</strong>。搭建 STUN 服务器很简单，媒体流传输是按照 P2P 的方式。</p>
<p>那么问题来了，<strong>STUN 并不是每次都能成功的为需要 NAT 的通话设备分配 IP 地址的</strong>，P2P 在传输媒体流时，使用的本地带宽，在多人视频通话的过程中，通话质量的好坏往往需要根据使用者本地的带宽确定。那么怎么办？TURN 可以很好的解决这个问题。</p>
<h3 id="TURN"><a href="#TURN" class="headerlink" title="TURN"></a>TURN</h3><p>TURN 的全称为 Traversal Using Relays around NAT，是 STUN&#x2F;RFC5389 的一个拓展，主要添加了 <strong>Relay</strong> 功能。如果终端在 NAT 之后， 那么在特定的情景下，有可能使得终端无法和其对等端（peer）进行直接的通信，这时就需要公网的服务器作为一个中继， 对来往的数据进行转发。这个转发的协议就被定义为 TURN。</p>
<img src="/2023/10/09/WebRTC%E4%BB%8B%E7%BB%8D/TURN服务器.png" alt="TURN服务器" style="zoom:50%;">

<p>在 STUN 分配公网 IP 失败后，可以通过 TURN 服务器请求公网 IP 地址作为中继地址。<strong>这种方式的带宽由服务器端承担</strong>，在多人视频聊天的时候，本地带宽压力较小，并且，根据 Google 的说明，TURN 协议可以使用在所有的环境中。（单向数据 200kbps 一对一通话）。</p>
<p>以上是 WebRTC 中经常用到的两个协议，STUN 和 TURN 服务器我们使用 coturn 开源项目来搭建。</p>
<p>补充：ICE 跟 STUN 和 TURN 不一样，ICE 不是一种协议，而是一个框架（Framework），它整合了 STUN 和 TURN。coturn 开源项目集成了 STUN 和 TURN 的功能。</p>
<h2 id="信令服务器"><a href="#信令服务器" class="headerlink" title="信令服务器"></a>信令服务器</h2><p>从上面我们知道了两个客户端协商媒体信息和网络信息，那怎么去交换？是不是需要一个中间商去做交换？所以我们需要一个信令服务器（Signal Server）转发彼此的媒体信息和网络信息。 </p>
<img src="/2023/10/09/WebRTC%E4%BB%8B%E7%BB%8D/信令服务器.png" alt="信令服务器" style="zoom:50%;">

<p>如上图，我们在基于 WebRTC API 开发应用（APP）时，可以将彼此的 APP 连接到信令服务器（Signal Server，一般搭建在公网，或者两端都可以访问到的局域网），<strong>借助信令服务器，就可以实现上面提到的 SDP 媒体信息及 Candidate 网络信息交换</strong>。</p>
<p>注意：信令服务器不只是交互媒体信息 sdp 和网络信息 candidate，比如：</p>
<ul>
<li><p>房间管理</p>
</li>
<li><p>人员进出房间</p>
</li>
</ul>
<h2 id="WebRTC-API"><a href="#WebRTC-API" class="headerlink" title="WebRTC API"></a>WebRTC API</h2><ul>
<li><strong>MediaStream</strong> — MediaStream 用来表示一个媒体数据流（通过 getUserMedia 接口获取），允许你访问输入设备，如麦克风和 Web摄像机，该 API 允许从其中任意一个获取媒体流。</li>
<li><strong>RTCPeerConnection</strong> — RTCPeerConnection 对象允许用户在两个浏览器之间直接通讯 ，你可以通过网络将捕获的音频和视频流实时发送到另一个 WebRTC 端点。使用这些 API，你可以在本地机器和远程对等点之间创建连接。它提供了连接到远程对等点、维护和监视连接以及在不再需要连接时关闭连接的方法。</li>
</ul>
<h2 id="一对一通话"><a href="#一对一通话" class="headerlink" title="一对一通话"></a>一对一通话</h2><img src="/2023/10/09/WebRTC%E4%BB%8B%E7%BB%8D/一对一通话.png" alt="一对一通话" style="zoom:70%;">

<p>在一对一通话场景中，每个 Peer 均创建有一个 PeerConnection 对象，由一方主动发 Offer SDP，另一方则应答 Answer SDP，最后双方交换 ICE Candidate 从而完成通话链路的建立。但是在中国的网络环境中，据一些统计数据显示，至少一半的网络是无法直接穿透打通，这种情况下只能借助 TURN 服务器中转。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/10/09/RTCP%E6%97%B6%E9%97%B4%E6%88%B3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/09/RTCP%E6%97%B6%E9%97%B4%E6%88%B3/" class="post-title-link" itemprop="url">RTCP时间戳</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-10-09 19:02:19" itemprop="dateCreated datePublished" datetime="2023-10-09T19:02:19+08:00">2023-10-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-17 22:46:07" itemprop="dateModified" datetime="2023-10-17T22:46:07+08:00">2023-10-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>今天通过RTSP使用UDP协议拉流播放摄像头，获取流的开始时间<code>start_time_realtime</code>的时候，发现时间戳会差8个小时，具体记录一下排查过程。FFmpeg版本是<code>ffmpeg version N-106450-g5ee198f9aa Copyright (c) 2000-2022 the FFmpeg developers</code>。</p>
<h1 id="排查步骤"><a href="#排查步骤" class="headerlink" title="排查步骤"></a>排查步骤</h1><h2 id="测试程序"><a href="#测试程序" class="headerlink" title="测试程序"></a>测试程序</h2><ul>
<li>编写main.c文件</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libavformat/avformat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span>                                                                    </span></span><br><span class="line"><span class="function"></span>&#123;                                                                      </span><br><span class="line">    AVDictionary *format_opts = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">av_dict_set</span>(&amp;format_opts, <span class="string">&quot;rtsp_transport&quot;</span>, <span class="string">&quot;udp&quot;</span>, <span class="number">0</span>); </span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* rtsp_path = <span class="string">&quot;rtsp://admin:HuaWei123@10.30.30.70/LiveMedia/ch1/Media1&quot;</span>;</span><br><span class="line">    AVFormatContext* ifmt_ctx = <span class="built_in">avformat_alloc_context</span>();</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">avformat_open_input</span>(&amp;ifmt_ctx, rtsp_path, <span class="literal">NULL</span>, &amp;format_opts);</span><br><span class="line">    <span class="built_in">avformat_find_stream_info</span>(ifmt_ctx, <span class="literal">NULL</span>);</span><br><span class="line">    AVPacket* pkt = <span class="built_in">av_packet_alloc</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">av_read_frame</span>(ifmt_ctx, pkt);</span><br><span class="line">        <span class="comment">//printf(&quot;%ld\n&quot;, ifmt_ctx-&gt;start_time_realtime);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><ul>
<li>ffmpeg编译debug版本</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./configure --enable-debug=3 --prefix=/root/ffmpeg/install --enable-shared --enable-pic --extra-cflags=-g --disable-stripping</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make -j4</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make install</span></span><br></pre></td></tr></table></figure>

<ul>
<li>测试demo编译</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -g main.c -I /root/ffmpeg/install/include -L /root/ffmpeg/install/lib -lavformat -lavutil -lavcodec</span><br></pre></td></tr></table></figure>

<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><h3 id="tcpdump"><a href="#tcpdump" class="headerlink" title="tcpdump"></a>tcpdump</h3><p>先启动tcpdump然后启动gdb调试程序。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i any host 127.0.0.1 and udp -w rtp_rtcp.pcap</span><br></pre></td></tr></table></figure>

<img src="/2023/10/09/RTCP%E6%97%B6%E9%97%B4%E6%88%B3/SR报文.png" alt="SR报文" style="zoom:90%;">

<h3 id="gdb"><a href="#gdb" class="headerlink" title="gdb"></a>gdb</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">gdb ./a.out</span><br><span class="line">gdb: /usr/local/lib/libuuid.so.1: no version information available (required by /usr/lib/x86_64-linux-gnu/libbabeltrace-ctf.so.1)</span><br><span class="line">GNU gdb (Ubuntu 7.11.1-0ubuntu1~16.5) 7.11.1</span><br><span class="line">Copyright (C) 2016 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type &quot;show copying&quot;</span><br><span class="line">and &quot;show warranty&quot; for details.</span><br><span class="line">This GDB was configured as &quot;x86_64-linux-gnu&quot;.</span><br><span class="line">Type &quot;show configuration&quot; for configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line">For help, type &quot;help&quot;.</span><br><span class="line">Type &quot;apropos word&quot; to search for commands related to &quot;word&quot;...</span><br><span class="line">Reading symbols from ./a.out...done.</span><br><span class="line">(gdb) b main</span><br><span class="line">Breakpoint 1 at 0x4008ce: file main.c, line 7.</span><br><span class="line">(gdb) r</span><br><span class="line">Starting program: /root/ffmpeg/a.out </span><br><span class="line">[Thread debugging using libthread_db enabled]</span><br><span class="line">Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, main () at main.c:7</span><br><span class="line">7       &#123;</span><br><span class="line">(gdb) b libavformat/rtsp.c:2310</span><br><span class="line">Breakpoint 2 at 0x7ffff7aedade: file libavformat/rtsp.c, line 2310.</span><br><span class="line">(gdb) b libavformat/rtpdec.c:194</span><br><span class="line">Breakpoint 3 at 0x7ffff7ad8340: file libavformat/rtpdec.c, line 194.</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 3, rtcp_parse_packet (len=52, buf=0x662040 &quot;\200&quot;, &lt;incomplete sequence \310&gt;, s=&lt;optimized out&gt;) at libavformat/rtpdec.c:194</span><br><span class="line">194                 if (payload_len &lt; 20) &#123;</span><br><span class="line">(gdb) l</span><br><span class="line">189         while (len &gt;= 4) &#123;</span><br><span class="line">190             payload_len = FFMIN(len, (AV_RB16(buf + 2) + 1) * 4);</span><br><span class="line">191</span><br><span class="line">192             switch (buf[1]) &#123;</span><br><span class="line">193             case RTCP_SR:</span><br><span class="line">194                 if (payload_len &lt; 20) &#123;</span><br><span class="line">195                     av_log(s-&gt;ic, AV_LOG_ERROR, &quot;Invalid RTCP SR packet length\n&quot;);</span><br><span class="line">196                     return AVERROR_INVALIDDATA;</span><br><span class="line">197                 &#125;</span><br><span class="line">198</span><br><span class="line">(gdb) x buf</span><br><span class="line">0x662040:       0x0600c880</span><br><span class="line">(gdb) x/xb buf</span><br><span class="line">0x662040:       0x80</span><br><span class="line">(gdb) x/tb buf</span><br><span class="line">0x662040:       10000000</span><br><span class="line">(gdb) x/xb buf+1</span><br><span class="line">0x662041:       0xc8</span><br><span class="line">(gdb) p buf[1]     #RTCP消息类型 200是SR</span><br><span class="line">$1 = 200 &#x27;\310&#x27;</span><br><span class="line">(gdb) x/ub buf+1</span><br><span class="line">0x662041:       200</span><br><span class="line">(gdb) x/xh buf+2   #RTCP消息长度，6*4 == 24Byte</span><br><span class="line">0x662042:       0x0600</span><br><span class="line">(gdb) x/xw buf+4   #SSRC</span><br><span class="line">0x662044:       0xa50b6170</span><br><span class="line">(gdb) x/xw buf+8   #NTP timestamp (高32位)</span><br><span class="line">0x662048:       0x9390cee8</span><br><span class="line">(gdb) x/xw buf+12  #NTP timestamp (低32位)</span><br><span class="line">0x66204c:       0x2fa1822b</span><br><span class="line">(gdb) p av_rescale(AV_RB64(buf + 8) - (NTP_OFFSET &lt;&lt; 32), 1000000, 1LL &lt;&lt; 32)  #这个具体下面解释</span><br><span class="line">$5 = 1696862739169962</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>可以看到gdb输出的和SR报文内容是一致的，具体：</p>
<ul>
<li>Packet Type：<code>p buf[1]</code></li>
<li>Length：<code>x/xh buf+2</code></li>
<li>Sender SSRC：<code>x/xw buf+4</code></li>
<li>Timestamp，MSW：<code>x/xw buf+8</code></li>
<li>Timestamp，LSW：<code>x/xw buf+12</code></li>
</ul>
<p>但是gdb输出下面代码的结果为<code>1696862739169962</code>转为时间是<code>2023-10-9 22:45:39</code>和上述报文的<code>NTP timestamp</code>差了8个小时。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">av_rescale</span>(<span class="built_in">AV_RB64</span>(buf + <span class="number">8</span>) - (NTP_OFFSET &lt;&lt; <span class="number">32</span>), <span class="number">1000000</span>, <span class="number">1LL</span> &lt;&lt; <span class="number">32</span>);</span><br></pre></td></tr></table></figure>

<p><code>AV_RB64(buf + 8)</code>是MSW时间，单位从<code>1900-01-01 00:00:00</code>开始的。</p>
<p><code>NTP_OFFSET &lt;&lt; 32</code>这个是1900年到1970年的时间长度，为什么要减去它，因为时间戳是从<code>1970-01-01 00:00:00</code>开始的。</p>
<p>所以差8个小时，是由于北京时间时间戳是从<code>1970-01-01 08:00:00</code>开始的，NTP timestamp要减去8个小时才是北京时间，这里存在疑惑？？？</p>
<h1 id="RTCP传输"><a href="#RTCP传输" class="headerlink" title="RTCP传输"></a>RTCP传输</h1><h2 id="拉流端"><a href="#拉流端" class="headerlink" title="拉流端"></a>拉流端</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">rtcp_parse_packet</span><span class="params">(RTPDemuxContext *s, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *buf,</span></span><br><span class="line"><span class="params">                             <span class="type">int</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> payload_len;</span><br><span class="line">    <span class="keyword">while</span> (len &gt;= <span class="number">4</span>) &#123;</span><br><span class="line">        payload_len = FFMIN(len, (AV_RB16(buf + <span class="number">2</span>) + <span class="number">1</span>) * <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (buf[<span class="number">1</span>]) &#123;</span><br><span class="line">        <span class="keyword">case</span> RTCP_SR:</span><br><span class="line">            <span class="keyword">if</span> (payload_len &lt; <span class="number">20</span>) &#123;</span><br><span class="line">                av_log(s-&gt;ic, AV_LOG_ERROR, <span class="string">&quot;Invalid RTCP SR packet length\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> AVERROR_INVALIDDATA;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            s-&gt;last_rtcp_reception_time = av_gettime_relative();</span><br><span class="line">            s-&gt;last_rtcp_ntp_time  = AV_RB64(buf + <span class="number">8</span>);</span><br><span class="line">            s-&gt;last_rtcp_timestamp = AV_RB32(buf + <span class="number">16</span>);</span><br><span class="line">            <span class="keyword">if</span> (s-&gt;first_rtcp_ntp_time == AV_NOPTS_VALUE) &#123;</span><br><span class="line">                s-&gt;first_rtcp_ntp_time = s-&gt;last_rtcp_ntp_time;</span><br><span class="line">                <span class="keyword">if</span> (!s-&gt;base_timestamp)</span><br><span class="line">                    s-&gt;base_timestamp = s-&gt;last_rtcp_timestamp;</span><br><span class="line">                s-&gt;rtcp_ts_offset = (<span class="type">int32_t</span>)(s-&gt;last_rtcp_timestamp - s-&gt;base_timestamp);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> RTCP_BYE:</span><br><span class="line">            <span class="keyword">return</span> -RTCP_BYE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        buf += payload_len;</span><br><span class="line">        len -= payload_len;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要看下<code>s-&gt;last_rtcp_ntp_time  = AV_RB64(buf + 8)</code>推流端如何打包数据。</p>
<h2 id="推流端"><a href="#推流端" class="headerlink" title="推流端"></a>推流端</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* send an rtcp sender report packet */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">rtcp_send_sr</span><span class="params">(AVFormatContext *s1, <span class="type">int64_t</span> ntp_time, <span class="type">int</span> bye)</span></span><br><span class="line">&#123;</span><br><span class="line">    RTPMuxContext *s = s1-&gt;priv_data;</span><br><span class="line">    <span class="type">uint32_t</span> rtp_ts;</span><br><span class="line"></span><br><span class="line">    av_log(s1, AV_LOG_TRACE, <span class="string">&quot;RTCP: %02x %&quot;</span>PRIx64<span class="string">&quot; %&quot;</span>PRIx32<span class="string">&quot;\n&quot;</span>, </span><br><span class="line">           s-&gt;payload_type, ntp_time, s-&gt;timestamp);</span><br><span class="line"></span><br><span class="line">    s-&gt;last_rtcp_ntp_time = ntp_time;</span><br><span class="line">    rtp_ts = av_rescale_q(ntp_time - s-&gt;first_rtcp_ntp_time, (AVRational)&#123;<span class="number">1</span>, <span class="number">1000000</span>&#125;,</span><br><span class="line">                          s1-&gt;streams[<span class="number">0</span>]-&gt;time_base) + s-&gt;base_timestamp;</span><br><span class="line">    avio_w8(s1-&gt;pb, RTP_VERSION &lt;&lt; <span class="number">6</span>);</span><br><span class="line">    avio_w8(s1-&gt;pb, RTCP_SR);</span><br><span class="line">    avio_wb16(s1-&gt;pb, <span class="number">6</span>); <span class="comment">/* length in words - 1 */</span></span><br><span class="line">    avio_wb32(s1-&gt;pb, s-&gt;ssrc);</span><br><span class="line">    avio_wb32(s1-&gt;pb, ntp_time / <span class="number">1000000</span>);</span><br><span class="line">    avio_wb32(s1-&gt;pb, ((ntp_time % <span class="number">1000000</span>) &lt;&lt; <span class="number">32</span>) / <span class="number">1000000</span>);</span><br><span class="line">    avio_wb32(s1-&gt;pb, rtp_ts);</span><br><span class="line">    avio_wb32(s1-&gt;pb, s-&gt;packet_count);</span><br><span class="line">    avio_wb32(s1-&gt;pb, s-&gt;octet_count);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s-&gt;cname) &#123;</span><br><span class="line">        <span class="type">int</span> len = FFMIN(<span class="built_in">strlen</span>(s-&gt;cname), <span class="number">255</span>);</span><br><span class="line">        avio_w8(s1-&gt;pb, (RTP_VERSION &lt;&lt; <span class="number">6</span>) + <span class="number">1</span>);</span><br><span class="line">        avio_w8(s1-&gt;pb, RTCP_SDES);</span><br><span class="line">        avio_wb16(s1-&gt;pb, (<span class="number">7</span> + len + <span class="number">3</span>) / <span class="number">4</span>); <span class="comment">/* length in words - 1 */</span></span><br><span class="line"></span><br><span class="line">        avio_wb32(s1-&gt;pb, s-&gt;ssrc);</span><br><span class="line">        avio_w8(s1-&gt;pb, <span class="number">0x01</span>); <span class="comment">/* CNAME */</span></span><br><span class="line">        avio_w8(s1-&gt;pb, len);</span><br><span class="line">        avio_write(s1-&gt;pb, s-&gt;cname, len);</span><br><span class="line">        avio_w8(s1-&gt;pb, <span class="number">0</span>); <span class="comment">/* END */</span></span><br><span class="line">        <span class="keyword">for</span> (len = (<span class="number">7</span> + len) % <span class="number">4</span>; len % <span class="number">4</span>; len++)</span><br><span class="line">            avio_w8(s1-&gt;pb, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bye) &#123;</span><br><span class="line">        avio_w8(s1-&gt;pb, (RTP_VERSION &lt;&lt; <span class="number">6</span>) | <span class="number">1</span>);</span><br><span class="line">        avio_w8(s1-&gt;pb, RTCP_BYE);</span><br><span class="line">        avio_wb16(s1-&gt;pb, <span class="number">1</span>); <span class="comment">/* length in words - 1 */</span></span><br><span class="line">        avio_wb32(s1-&gt;pb, s-&gt;ssrc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    avio_flush(s1-&gt;pb);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>拉流端的<code>last_rtcp_ntp_time  </code>对应<code>avio_wb32(s1-&gt;pb, ntp_time / 1000000)</code>，其中<code>ntp_time</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint64_t</span> <span class="title function_">ff_ntp_time</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (av_gettime() / <span class="number">1000</span>) * <span class="number">1000</span> + NTP_OFFSET_US;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rtcp_send_sr(s1, ff_ntp_time(), <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>其中<code>av_gettime</code>调用<code>gettimeofday</code>，为什么加上<code>NTP_OFFSET_US</code>这个其实就是1900年到1970年的时间差，转成MSW，所以上面拉流端需要减去<code>NTP_OFFSET_US</code>。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Fang</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"neutral","dark":"neutral"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.3.0/mermaid.min.js","integrity":"sha256-9y71g5Lz/KLsHjB8uXwnkuWDtAMDSzD/HdIbqhJfTAI="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





</body>
</html>
