<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CPT+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"fang0407.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="NOTE">
<meta property="og:url" content="https://fang0407.github.io/page/4/index.html">
<meta property="og:site_name" content="NOTE">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Fang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://fang0407.github.io/page/4/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/4/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>NOTE</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">NOTE</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Fang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">73</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/10/03/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BHLS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/03/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BHLS/" class="post-title-link" itemprop="url">SRS流媒体服务器之HLS</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-10-03 13:13:50" itemprop="dateCreated datePublished" datetime="2023-10-03T13:13:50+08:00">2023-10-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-12-30 22:37:29" itemprop="dateModified" datetime="2023-12-30T22:37:29+08:00">2023-12-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SRS/" itemprop="url" rel="index"><span itemprop="name">SRS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="HLS介绍"><a href="#HLS介绍" class="headerlink" title="HLS介绍"></a>HLS介绍</h1><h2 id="HLS简介"><a href="#HLS简介" class="headerlink" title="HLS简介"></a>HLS简介</h2><p>RTMP指Adobe的RTMP（Realtime Message Protocol），⼴泛应⽤于低延时直播，也是编码器和服务器对接的实际标准协议，在PC（Flash）上有最佳观看体验和最佳稳定性。HLS指Apple的HLS（Http Live Streaming），本身就是Live（直播）的，不过Vod（点播）也能⽀持。HLS是Apple平台的标准流媒体协议，和RTMP在PC上⼀样⽀持得天⾐⽆缝。HLS和RTMP两种分发⽅式，就可以⽀持所有的终端。 </p>
<h2 id="HLS应用场景"><a href="#HLS应用场景" class="headerlink" title="HLS应用场景"></a>HLS应用场景</h2><ul>
<li>跨平台：PC主要的直播⽅案是RTMP，也有⼀些库能播放HLS，譬如jwplayer，基于osmf的hls插件也⼀⼤堆。所以实际上如果选⼀种协议能跨PC&#x2F;Android&#x2F;IOS，那就是HLS。 </li>
<li>IOS上苛刻的稳定性要求：IOS上最稳定的当然是HLS，稳定性不差于RTMP在PC-flash上的表现。 </li>
<li>友好的CDN分发⽅式：⽬前CDN对于RTMP也是基本协议，但是HLS分发的基础是HTTP，所以CDN的接⼊和分发会⽐RTMP更加完善。能在各种CDN之间切换，RTMP也能，只是可能需要对接测试。 </li>
<li>简单：HLS作为流媒体协议⾮常简单，Apple⽀持得也很完善。Android对HLS的⽀持也会越来越完善。⾄于DASH&#x2F;HDS，好像没有什么特别的理由，就像linux已经⼤⾏其道⽽且开放，其他的系统很难再⼴泛应⽤。</li>
</ul>
<p>总之，SRS⽀持HLS主要是作为输出的分发协议，直播以RTMP+HLS分发，满⾜各种应⽤场景。点播以HLS为主。 </p>
<h2 id="推荐分发⽅式"><a href="#推荐分发⽅式" class="headerlink" title="推荐分发⽅式"></a>推荐分发⽅式</h2><ul>
<li>编码器输出RTMP协议。 </li>
<li>流媒体系统接⼊使⽤RTMP协议。 </li>
<li>流媒体系统内部直播分发使⽤RTMP。 </li>
<li>PC+直播+实时性要求⾼：使⽤flash播放RTMP。 </li>
<li>PC+直播+没有实时性要求：使⽤RTMP或者HLS均可。 </li>
<li>PC+点播：使⽤HTTP或者HLS。 </li>
<li>Apple IOS&#x2F;OSX：都使⽤HLS（实时性要求⾼得⾃⼰解析RTMP，或者使⽤外部库。</li>
<li>Andorid：和IOS⼀样，不过可以确定的是可以⾃⼰开发⽀持RTMP。</li>
</ul>
<h1 id="HLS源码分析"><a href="#HLS源码分析" class="headerlink" title="HLS源码分析"></a>HLS源码分析</h1><h2 id="配置⽂件"><a href="#配置⽂件" class="headerlink" title="配置⽂件"></a>配置⽂件</h2><p>修改<code>conf/hls.conf</code>文件，<code>./objs/srs -c conf/hls.conf</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">listen              1935;</span><br><span class="line">max_connections     1000;</span><br><span class="line">daemon              off;</span><br><span class="line">srs_log_tank        console;</span><br><span class="line">http_server &#123;</span><br><span class="line">    enabled         on;</span><br><span class="line">    listen          8080;</span><br><span class="line">    dir             ./objs/nginx/html;</span><br><span class="line">&#125;</span><br><span class="line">vhost __defaultVhost__ &#123;</span><br><span class="line">    hls &#123;</span><br><span class="line">        enabled         on;</span><br><span class="line">        hls_path        ./objs/nginx/html;  # ts,m3u8保存路径</span><br><span class="line">        hls_fragment    10;   # 分片时长</span><br><span class="line">        hls_window      60;   # 总分片时长，窗⼝时⻓</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="调试分析"><a href="#调试分析" class="headerlink" title="调试分析"></a>调试分析</h2><h3 id="核心类"><a href="#核心类" class="headerlink" title="核心类"></a>核心类</h3><ul>
<li><code>SrsHls</code>：对于HLS业务的封装。</li>
<li><code>SrsHlsController</code>：The hls stream cache。</li>
<li><code>SrsHlsMuxer</code>：负责⽣产m3u8和ts⽂件。</li>
<li><code>SrsHlsSegment</code>：负责分⽚，⽂件创建、删除等。</li>
<li><code>SrsFragment</code>：对⽂件的处理，是SrsHlsSegment 的基类。</li>
<li><code>SrsFragmentWindow</code>：管理segment。</li>
</ul>
<h3 id="推流端"><a href="#推流端" class="headerlink" title="推流端"></a>推流端</h3><p>主要通过RTMP推流，将接收音视频数据写入m3u8和ts文件。</p>
<ul>
<li>看到配置文件<code>hls_fragment</code>字段，找到<code>SrsConfig::get_hls_fragmen</code>，打断点，查看堆栈：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#0 SrsConfig::get_hls_fragment (this=0xa0fcf0, vhost=&quot;__defaultVhost__&quot;) at src/app/srs_app_config.cpp:6102</span><br><span class="line">#1 0x00000000004f3ee9 in SrsHlsController::on_publish (this=0xa3b560, req=0xa3bcb0) </span><br><span class="line">   at src/app/srs_app_hls.cpp:885 </span><br><span class="line">#2 0x00000000004f5be2 in SrsHls::on_publish (this=0xa3b030) at src/app/srs_app_hls.cpp:1181</span><br><span class="line">#3 0x00000000004e0603 in SrsOriginHub::on_publish (this=0xa3b670) at src/app/srs_app_source.cpp:1129</span><br><span class="line">#4 0x00000000004e6a0b in SrsSource::on_publish (this=0xa3b1e0) at src/app/srs_app_source.cpp:2460</span><br><span class="line">#5 0x00000000004d89f2 in SrsRtmpConn::acquire_publish (this=0xa30d60, source=0xa3b1e0) </span><br><span class="line">   at src/app/srs_app_rtmp_conn.cpp:940</span><br><span class="line">#6 0x00000000004d7a74 in SrsRtmpConn::publishing (this=0xa30d60, source=0xa3b1e0)</span><br><span class="line">   at src/app/srs_app_rtmp_conn.cpp:822</span><br><span class="line">#7 0x00000000004d5229 in SrsRtmpConn::stream_service_cycle (this=0xa30d60)</span><br><span class="line">   at src/app/srs_app_rtmp_conn.cpp:534</span><br><span class="line">#8 0x00000000004d4141 in SrsRtmpConn::service_cycle (this=0xa30d60) at src/app/srs_app_rtmp_conn.cpp:388</span><br><span class="line">#9 0x00000000004d2f09 in SrsRtmpConn::do_cycle (this=0xa30d60) at src/app/srs_app_rtmp_conn.cpp:209</span><br><span class="line">#10 0x00000000004d10fb in SrsConnection::cycle (this=0xa30dd8) at src/app/srs_app_conn.cpp:171</span><br><span class="line">#11 0x0000000000509c88 in SrsSTCoroutine::cycle (this=0xa31010) at src/app/srs_app_st.cpp:198</span><br><span class="line">#12 0x0000000000509cfd in SrsSTCoroutine::pfn (arg=0xa31010) at src/app/srs_app_st.cpp:213</span><br><span class="line">#13 0x00000000005bdd9d in _st_thread_main () at sched.c:337</span><br><span class="line">#14 0x00000000005be515 in st_thread_create (start=0x5bd719 &lt;_st_vp_schedule+170&gt;,</span><br><span class="line">    arg=0x700000001, joinable=1, stk_size=1) at sched.c616</span><br></pre></td></tr></table></figure>

<ul>
<li>看到堆栈前面和RTMP推流流程一致。</li>
<li><code>SrsRtmpConn::acquire_publish</code>后<code>info-&gt;edge</code>分支用于edge边缘结点推流，该流程处理在另一个分支<code>source-&gt;on_publish</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::acquire_publish</span><span class="params">(SrsSource* source)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!source-&gt;<span class="built_in">can_publish</span>(info-&gt;edge)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_SYSTEM_STREAM_BUSY,</span><br><span class="line">                             <span class="string">&quot;rtmp: stream %s is busy&quot;</span>,</span><br><span class="line">                             req-&gt;<span class="built_in">get_stream_url</span>().<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// when edge, ignore the publish event, directly proxy it.</span></span><br><span class="line">    <span class="keyword">if</span> (info-&gt;edge) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">on_edge_start_publish</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: edge start publish&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">on_publish</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: source publish&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>进入<code>SrsSource::on_publish</code>后调用<code>hub-&gt;on_publish</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsSource::on_publish</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// update the request object.</span></span><br><span class="line">    <span class="built_in">srs_assert</span>(req);</span><br><span class="line">    </span><br><span class="line">    _can_publish = <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// whatever, the publish thread is the source or edge source,</span></span><br><span class="line">    <span class="comment">// save its id to srouce id.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">on_source_id_changed</span>(_srs_context-&gt;<span class="built_in">get_id</span>())) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;source id change&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// reset the mix queue.</span></span><br><span class="line">    mix_queue-&gt;<span class="built_in">clear</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reset the metadata cache, to make VLC happy when disable/enable stream.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/1630#issuecomment-597979448</span></span><br><span class="line">    meta-&gt;<span class="built_in">clear</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// detect the monotonically again.</span></span><br><span class="line">    is_monotonically_increase = <span class="literal">true</span>;</span><br><span class="line">    last_packet_time = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Notify the hub about the publish event.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = hub-&gt;<span class="built_in">on_publish</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hub publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// notify the handler.</span></span><br><span class="line">    <span class="built_in">srs_assert</span>(handler);</span><br><span class="line">    <span class="keyword">if</span> ((err = handler-&gt;<span class="built_in">on_publish</span>(<span class="keyword">this</span>, req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;handle publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    SrsStatistic* stat = SrsStatistic::<span class="built_in">instance</span>();</span><br><span class="line">    stat-&gt;<span class="built_in">on_stream_publish</span>(req, _source_id);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsOriginHub</code>扩展源推流不同业务，比如转码，录制，转发等，主要关注<code>hls-&gt;on_publish</code>用于HLS。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsOriginHub::on_publish</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// create forwarders</span></span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">create_forwarders</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;create forwarders&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> use initialize to set req.</span></span><br><span class="line">    <span class="comment">//转码</span></span><br><span class="line">    <span class="keyword">if</span> ((err = encoder-&gt;<span class="built_in">on_publish</span>(req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;encoder publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = hls-&gt;<span class="built_in">on_publish</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = dash-&gt;<span class="built_in">on_publish</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;dash publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//录制</span></span><br><span class="line">    <span class="keyword">if</span> ((err = dvr-&gt;<span class="built_in">on_publish</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;dvr publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> use initialize to set req.</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_AUTO_HDS</span></span><br><span class="line">    <span class="keyword">if</span> ((err = hds-&gt;<span class="built_in">on_publish</span>(req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hds publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> use initialize to set req.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = ng_exec-&gt;<span class="built_in">on_publish</span>(req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;exec publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    is_active = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHls::on_publish</code>主要调用<code>controller-&gt;on_publish</code>做处理。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHls::on_publish</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// update the hls time, for hls_dispose.</span></span><br><span class="line">    last_update_time = <span class="built_in">srs_get_system_time</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// support multiple publish.</span></span><br><span class="line">    <span class="keyword">if</span> (enabled) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!_srs_config-&gt;<span class="built_in">get_hls_enabled</span>(req-&gt;vhost)) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = controller-&gt;<span class="built_in">on_publish</span>(req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: on publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If enabled, directly turn FLV timestamp to TS DTS.</span></span><br><span class="line">    <span class="comment">// @remark It&#x27;ll be reloaded automatically, because the origin hub will republish while reloading.</span></span><br><span class="line">    hls_dts_directly = _srs_config-&gt;<span class="built_in">get_vhost_hls_dts_directly</span>(req-&gt;vhost);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if enabled, open the muxer.</span></span><br><span class="line">    enabled = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ok, the hls can be dispose, or need to be dispose.</span></span><br><span class="line">    disposable = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHlsController::on_publish</code>读取配置文件信息，之后<code>SrsHlsMuxer</code>处理HLS相关业务封装。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHlsController::on_publish</span><span class="params">(SrsRequest* req)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    std::string vhost = req-&gt;vhost;</span><br><span class="line">    std::string stream = req-&gt;stream;</span><br><span class="line">    std::string app = req-&gt;app;</span><br><span class="line">    </span><br><span class="line">    <span class="type">srs_utime_t</span> hls_fragment = _srs_config-&gt;<span class="built_in">get_hls_fragment</span>(vhost);</span><br><span class="line">    <span class="type">srs_utime_t</span> hls_window = _srs_config-&gt;<span class="built_in">get_hls_window</span>(vhost);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// get the hls m3u8 ts list entry prefix config</span></span><br><span class="line">    std::string entry_prefix = _srs_config-&gt;<span class="built_in">get_hls_entry_prefix</span>(vhost);</span><br><span class="line">    <span class="comment">// get the hls path config</span></span><br><span class="line">    std::string path = _srs_config-&gt;<span class="built_in">get_hls_path</span>(vhost);</span><br><span class="line">    std::string m3u8_file = _srs_config-&gt;<span class="built_in">get_hls_m3u8_file</span>(vhost);</span><br><span class="line">    std::string ts_file = _srs_config-&gt;<span class="built_in">get_hls_ts_file</span>(vhost);</span><br><span class="line">    <span class="type">bool</span> cleanup = _srs_config-&gt;<span class="built_in">get_hls_cleanup</span>(vhost);</span><br><span class="line">    <span class="type">bool</span> wait_keyframe = _srs_config-&gt;<span class="built_in">get_hls_wait_keyframe</span>(vhost);</span><br><span class="line">    <span class="comment">// the audio overflow, for pure audio to reap segment.</span></span><br><span class="line">    <span class="type">double</span> hls_aof_ratio = _srs_config-&gt;<span class="built_in">get_hls_aof_ratio</span>(vhost);</span><br><span class="line">    <span class="comment">// whether use floor(timestamp/hls_fragment) for variable timestamp</span></span><br><span class="line">    <span class="type">bool</span> ts_floor = _srs_config-&gt;<span class="built_in">get_hls_ts_floor</span>(vhost);</span><br><span class="line">    <span class="comment">// the seconds to dispose the hls.</span></span><br><span class="line">    <span class="type">srs_utime_t</span> hls_dispose = _srs_config-&gt;<span class="built_in">get_hls_dispose</span>(vhost);</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> hls_keys = _srs_config-&gt;<span class="built_in">get_hls_keys</span>(vhost);</span><br><span class="line">    <span class="type">int</span> hls_fragments_per_key = _srs_config-&gt;<span class="built_in">get_hls_fragments_per_key</span>(vhost);</span><br><span class="line">    string hls_key_file =  _srs_config-&gt;<span class="built_in">get_hls_key_file</span>(vhost);</span><br><span class="line">    string hls_key_file_path = _srs_config-&gt;<span class="built_in">get_hls_key_file_path</span>(vhost);</span><br><span class="line">    string hls_key_url = _srs_config-&gt;<span class="built_in">get_hls_key_url</span>(vhost);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> support load exists m3u8, to continue publish stream.</span></span><br><span class="line">    <span class="comment">// for the HLS donot requires the EXT-X-MEDIA-SEQUENCE be monotonically increase.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((err = muxer-&gt;<span class="built_in">on_publish</span>(req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;muxer publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = muxer-&gt;<span class="built_in">update_config</span>(req, entry_prefix, path, m3u8_file, ts_file, hls_fragment,</span><br><span class="line">        hls_window, ts_floor, hls_aof_ratio, cleanup, wait_keyframe,hls_keys,hls_fragments_per_key,</span><br><span class="line">        hls_key_file, hls_key_file_path, hls_key_url)) != srs_success ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: update config&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = muxer-&gt;<span class="built_in">segment_open</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: segment open&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This config item is used in SrsHls, we just log its value here.</span></span><br><span class="line">    <span class="type">bool</span> hls_dts_directly = _srs_config-&gt;<span class="built_in">get_vhost_hls_dts_directly</span>(req-&gt;vhost);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;hls: win=%dms, frag=%dms, prefix=%s, path=%s, m3u8=%s, ts=%s, aof=%.2f, floor=%d, clean=%d, waitk=%d, dispose=%dms, dts_directly=%d&quot;</span>,</span><br><span class="line">        <span class="built_in">srsu2msi</span>(hls_window), <span class="built_in">srsu2msi</span>(hls_fragment), entry_prefix.<span class="built_in">c_str</span>(), path.<span class="built_in">c_str</span>(), m3u8_file.<span class="built_in">c_str</span>(), ts_file.<span class="built_in">c_str</span>(),</span><br><span class="line">        hls_aof_ratio, ts_floor, cleanup, wait_keyframe, <span class="built_in">srsu2msi</span>(hls_dispose), hls_dts_directly);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>配置<code>SrsHlsMuxer</code>信息，创建<code>SrsFileWriter</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHlsMuxer::update_config</span><span class="params">(SrsRequest* r, string entry_prefix,</span></span></span><br><span class="line"><span class="params"><span class="function">    string path, string m3u8_file, string ts_file, <span class="type">srs_utime_t</span> fragment, <span class="type">srs_utime_t</span> window,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">bool</span> ts_floor, <span class="type">double</span> aof_ratio, <span class="type">bool</span> cleanup, <span class="type">bool</span> wait_keyframe, <span class="type">bool</span> keys,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">int</span> fragments_per_key, string key_file ,string key_file_path, string key_url)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_freep</span>(req);</span><br><span class="line">    req = r-&gt;<span class="built_in">copy</span>();</span><br><span class="line">    </span><br><span class="line">    hls_entry_prefix = entry_prefix;</span><br><span class="line">    hls_path = path;</span><br><span class="line">    hls_ts_file = ts_file;</span><br><span class="line">    hls_fragment = fragment;</span><br><span class="line">    hls_aof_ratio = aof_ratio;</span><br><span class="line">    hls_ts_floor = ts_floor;</span><br><span class="line">    hls_cleanup = cleanup;</span><br><span class="line">    hls_wait_keyframe = wait_keyframe;</span><br><span class="line">    previous_floor_ts = <span class="number">0</span>;</span><br><span class="line">    accept_floor_ts = <span class="number">0</span>;</span><br><span class="line">    hls_window = window;</span><br><span class="line">    deviation_ts = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    hls_keys = keys;</span><br><span class="line">    hls_fragments_per_key = fragments_per_key;</span><br><span class="line">    hls_key_file = key_file;</span><br><span class="line">    hls_key_file_path = key_file_path;</span><br><span class="line">    hls_key_url = key_url;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// generate the m3u8 dir and path.</span></span><br><span class="line">    m3u8_url = <span class="built_in">srs_path_build_stream</span>(m3u8_file, req-&gt;vhost, req-&gt;app, req-&gt;stream);</span><br><span class="line">    m3u8 = path + <span class="string">&quot;/&quot;</span> + m3u8_url;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// when update config, reset the history target duration.</span></span><br><span class="line">    max_td = fragment * _srs_config-&gt;<span class="built_in">get_hls_td_ratio</span>(r-&gt;vhost);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// create m3u8 dir once.</span></span><br><span class="line">    m3u8_dir = <span class="built_in">srs_path_dirname</span>(m3u8);</span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">srs_create_dir_recursively</span>(m3u8_dir)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;create dir&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hls_keys &amp;&amp; (hls_path != hls_key_file_path)) &#123;</span><br><span class="line">        string key_file = <span class="built_in">srs_path_build_stream</span>(hls_key_file, req-&gt;vhost, req-&gt;app, req-&gt;stream);</span><br><span class="line">        string key_url = hls_key_file_path + <span class="string">&quot;/&quot;</span> + key_file;</span><br><span class="line">        string key_dir = <span class="built_in">srs_path_dirname</span>(key_url);</span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">srs_create_dir_recursively</span>(key_dir)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;create dir&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(hls_keys) &#123;</span><br><span class="line">        writer = <span class="keyword">new</span> <span class="built_in">SrsEncFileWriter</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        writer = <span class="keyword">new</span> <span class="built_in">SrsFileWriter</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHlsMuxer::segment_open</code>打开TS分片，并写入。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHlsMuxer::segment_open</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//省略...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// open temp ts file.</span></span><br><span class="line">    std::string tmp_file = current-&gt;<span class="built_in">tmppath</span>();</span><br><span class="line">    <span class="keyword">if</span> ((err = current-&gt;writer-&gt;<span class="built_in">open</span>(tmp_file)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;open hls muxer&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// reset the context for a new ts start.</span></span><br><span class="line">    context-&gt;<span class="built_in">reset</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>断点<code>SrsHlsMuxer::do_segment_close</code>。</li>
<li><code>SrsHlsMuxer::segment_open</code>，对应<code>SrsHlsMuxer::segment_close</code>用于结束⼀个segment的写⼊。</li>
<li><code>_refresh_m3u8</code>用于更新m3u8文件。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#0 SrsHlsMuxer::do_segment_close (this=0xa3b6f0) at src/app/srs_app_hls.cpp:602</span><br><span class="line">#1 0x00000000004f1b19 in SrsHlsMuxer::segment_close (this=0xa3b6f0) at src/app/srs_app_hls.cpp:593</span><br><span class="line">#2 0x00000000004f52c4 in SrsHlsController::reap_segment (this=0xa3b560) at src/app/srs_app_hls.cpp:1046</span><br><span class="line">#3 0x00000000004f51d2 in SrsHlsController::write_video (this=0xa3b560, frame=0xa3fdb0, dts=1328400)</span><br><span class="line">   at src/app/srs_app_hls.cpp:1024</span><br><span class="line">#4 0x00000000004f63c3 in SrsHls::on_video (this=0xa3b030, shared_video=0x7ffff7ee8b00, format=0xa3bad0)</span><br><span class="line">   at src/app/srs_app_hls.cpp:1340</span><br><span class="line">#5 0x00000000004dfbef in SrsOriginHub::on_video (</span><br><span class="line">   this=0xa3b670, shared_video=0x7ffff7ee8b00, is_sequence_header=false) at src/app/srs_app_source.cpp:1062</span><br><span class="line">#6 0x00000000004e5fa5 in SrsSource::on_video_imp (this=0xa3b1e0, msg=0x7ffff7ee8b00) </span><br><span class="line">   at src/app/srs_app_source.cpp:2306</span><br><span class="line">#7 0x00000000004e5bf9 in SrsSource::on_video (this=0xa3b1e0, shared_video=0xa3dfa0)</span><br><span class="line">   at src/app/srs_app_source.cpp:2261</span><br><span class="line">#8 0x00000000004d8fa7 in SrsRtmpConn::process_publish_message (this=0xa30d60,</span><br><span class="line">   source=0xa3b1e0, msg=0xa3dfa0)</span><br><span class="line">   at src/app/srs_app_rtmp_conn.cpp:1021</span><br><span class="line">#9 0x00000000004d8dce in SrsRtmpConn::handle_publish_message (this=0xa30d60,</span><br><span class="line">   source=0xa3b1e0, msg=0xa3dfa0) </span><br><span class="line">   at src/app/srs_app_rtmp_conn.cpp:993</span><br><span class="line">#10 0x00000000005810b6 in SrsPublishRecvThread::consume (this=0x7ffff7f42800, msg=0xa3dfa0)</span><br><span class="line">    at src/app/srs_app_recv_thread.cpp:389</span><br><span class="line">#11 0x00000000004d2f09 in SrsRtmpConn::do_cycle (this=0x7ffff7f42808) at src/app/srs_app_rtmp_conn.cpp:146</span><br><span class="line">#12 0x000000000057fa25 in SrsRecvThread::cycle (this=0x7ffff7f42808) at src/app/srs_app_recv_thread.cpp:115 #13 0x0000000000509c88 in SrsSTCoroutine::cycle (this=0xa3de00) at src/app/srs_app_st.cpp:198</span><br></pre></td></tr></table></figure>

<ul>
<li>写入TS的视频数据。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHlsController::write_video</span><span class="params">(SrsVideoFrame* frame, <span class="type">int64_t</span> dts)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// write video to cache.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = tsmc-&gt;<span class="built_in">cache_video</span>(frame, dts)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: cache video&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// when segment overflow, reap if possible.</span></span><br><span class="line">    <span class="comment">//文件是不是够fragment</span></span><br><span class="line">    <span class="keyword">if</span> (muxer-&gt;<span class="built_in">is_segment_overflow</span>()) &#123;</span><br><span class="line">        <span class="comment">// do reap ts if any of:</span></span><br><span class="line">        <span class="comment">//      a. wait keyframe and got keyframe.</span></span><br><span class="line">        <span class="comment">//      b. always reap when not wait keyframe.</span></span><br><span class="line">        <span class="keyword">if</span> (!muxer-&gt;<span class="built_in">wait_keyframe</span>() || frame-&gt;frame_type == SrsVideoAvcFrameTypeKeyFrame) &#123;</span><br><span class="line">            <span class="comment">// reap the segment, which will also flush the video.</span></span><br><span class="line">            <span class="keyword">if</span> ((err = <span class="built_in">reap_segment</span>()) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: reap segment&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// flush video when got one</span></span><br><span class="line">    <span class="keyword">if</span> ((err = muxer-&gt;<span class="built_in">flush_video</span>(tsmc)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: flush video&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHlsController::reap_segment</code>主要管理对ts、m3u8文件。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHlsController::reap_segment</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> flush audio before or after segment?</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> fresh segment begin with audio or video?</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// close current ts.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = muxer-&gt;<span class="built_in">segment_close</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="comment">// When close segment error, we must reopen it for next packet to write.</span></span><br><span class="line">        <span class="type">srs_error_t</span> r0 = muxer-&gt;<span class="built_in">segment_open</span>();</span><br><span class="line">        <span class="keyword">if</span> (r0 != srs_success) &#123;</span><br><span class="line">            <span class="built_in">srs_warn</span>(<span class="string">&quot;close segment err %s&quot;</span>, <span class="built_in">srs_error_desc</span>(r0).<span class="built_in">c_str</span>());</span><br><span class="line">            <span class="built_in">srs_freep</span>(r0);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: segment close&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// open new ts.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = muxer-&gt;<span class="built_in">segment_open</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: segment open&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// segment open, flush video first.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = muxer-&gt;<span class="built_in">flush_video</span>(tsmc)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: flush video&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// segment open, flush the audio.</span></span><br><span class="line">    <span class="comment">// @see: ngx_rtmp_hls_open_fragment</span></span><br><span class="line">    <span class="comment">/* start fragment with audio to make iPhone happy */</span></span><br><span class="line">    <span class="keyword">if</span> ((err = muxer-&gt;<span class="built_in">flush_audio</span>(tsmc)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: flush audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>上述主要在<code>SrsHls::on_publish</code>处理推流初始化相关。</li>
<li>具体从哪里读音视频数据中，断点<code>SrsTsContextWriter::write_audio</code>如何写入音频数据。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#0 SrsTsContextWriter::write_audio (this=0xa3c770, audio=0xa45bf0) at src/kernel/srs_kernel_ts.cpp:2582</span><br><span class="line">#1 0x00000000004f1858 in SrsHlsMuxer::flush_audio (this=0xa3b6f0, cache=0xa3b580)</span><br><span class="line">   at src/app/srs_app_hls.cpp:552</span><br><span class="line">#2 0x00000000004f5089 in SrsHlsController::write_audio (this=0xa3b560, frame=0xa41640, pts=3060)</span><br><span class="line">   at src/app/srs_app_hls.cpp:1001</span><br><span class="line">#3 0x00000000004f613c in SrsHls::on_audio (this=0xa3b030, shared_audio=0x7ffff7ee8b10, format=0xa3bad0)</span><br><span class="line">   at src/app/srs_app_hls.cpp:1290</span><br><span class="line">#4 0x00000000004deeaf in SrsOriginHub::on_audio (this=0xa3b670, shared_audio=0x7ffff7ee8b10)</span><br><span class="line">   at src/app/srs_app_source.cpp:969</span><br><span class="line">#5 0x00000000004e579a in SrsSource::on_audio_imp (this=0xa3b1e0, msg=0x7ffff7ee8b10)</span><br><span class="line">   at src/app/srs_app_source.cpp:2191</span><br><span class="line">#6 0x00000000004e539d in SrsSource::on_audio (this=0xa3b1e0, shared_audio=0xa3dfa0)</span><br><span class="line">   at src/app/srs_app_source.cpp:2141</span><br><span class="line">#7 0x00000000004d8f28 in SrsRtmpConn::process_publish_message (this=0xa30d60, source=0xa3b1e0, msg=0xa3dfa0)    at src/app/srs_app_rtmp_conn.cpp:1014</span><br><span class="line">#8 0x00000000004d8dce in SrsRtmpConn::handle_publish_message (this=0xa30d60, source=0xa3b1e0, msg=0xa3dfa0)      at src/app/srs_app_rtmp_conn.cpp:993</span><br><span class="line">#9 0x00000000005810b6 in SrsPublishRecvThread::consume (this=0x7ffff7f42800, msg=0xa3dfa0)</span><br><span class="line">   at src/app/srs_app_recv_thread.cpp:389</span><br><span class="line">#10 0x000000000057fbd4 in SrsRecvThread::do_cycle (this=0x7ffff7f42808)</span><br><span class="line">    at src/app/srs_app_recv_thread.cpp:146</span><br><span class="line">#11 0x000000000057fa25 in SrsRecvThread::cycle (this=0x7ffff7f42808) at src/app/srs_app_recv_thread.cpp:115</span><br><span class="line">#12 0x0000000000509c88 in SrsSTCoroutine::cycle (this=0xa3de00) at src/app/srs_app_st.cpp:198</span><br><span class="line">#13 0x0000000000509cfd in SrsSTCoroutine::pfn (arg=0xa3de00) at src/app/srs_app_st.cpp:213</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsSource::on_audio_imp</code>的<code>SrsSharedPtrMessage</code>消息是RTMP格式消息。</li>
<li><code>consumer-&gt;enqueue</code>推送给消费者，<code>hub-&gt;on_audio</code>是具体<code>SrsOriginHub</code>做处理。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsSource::on_audio_imp</span><span class="params">(SrsSharedPtrMessage* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="type">bool</span> is_aac_sequence_header = SrsFlvAudio::<span class="built_in">sh</span>(msg-&gt;payload, msg-&gt;size);</span><br><span class="line">    <span class="type">bool</span> is_sequence_header = is_aac_sequence_header;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// whether consumer should drop for the duplicated sequence header.</span></span><br><span class="line">    <span class="type">bool</span> drop_for_reduce = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (is_sequence_header &amp;&amp; meta-&gt;<span class="built_in">previous_ash</span>() &amp;&amp; _srs_config-&gt;<span class="built_in">get_reduce_sequence_header</span>(req-&gt;vhost)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (meta-&gt;<span class="built_in">previous_ash</span>()-&gt;size == msg-&gt;size) &#123;</span><br><span class="line">            drop_for_reduce = <span class="built_in">srs_bytes_equals</span>(meta-&gt;<span class="built_in">previous_ash</span>()-&gt;payload, msg-&gt;payload, msg-&gt;size);</span><br><span class="line">            <span class="built_in">srs_warn</span>(<span class="string">&quot;drop for reduce sh audio, size=%d&quot;</span>, msg-&gt;size);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// copy to all consumer</span></span><br><span class="line">    <span class="keyword">if</span> (!drop_for_reduce) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; (<span class="type">int</span>)consumers.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            SrsConsumer* consumer = consumers.<span class="built_in">at</span>(i);</span><br><span class="line">            <span class="keyword">if</span> ((err = consumer-&gt;<span class="built_in">enqueue</span>(msg, atc, jitter_algorithm)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;consume message&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Copy to hub to all utilities.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = hub-&gt;<span class="built_in">on_audio</span>(msg)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;consume audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cache the sequence header of aac, or first packet of mp3.</span></span><br><span class="line">    <span class="comment">// for example, the mp3 is used for hls to write the &quot;right&quot; audio codec.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> to refine the stream info system.</span></span><br><span class="line">    <span class="keyword">if</span> (is_aac_sequence_header || !meta-&gt;<span class="built_in">ash</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = meta-&gt;<span class="built_in">update_ash</span>(msg)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;meta consume audio&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// when sequence header, donot push to gop cache and adjust the timestamp.</span></span><br><span class="line">    <span class="keyword">if</span> (is_sequence_header) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cache the last gop packets</span></span><br><span class="line">    <span class="keyword">if</span> ((err = gop_cache-&gt;<span class="built_in">cache</span>(msg)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;gop cache consume audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if atc, update the sequence header to abs time.</span></span><br><span class="line">    <span class="keyword">if</span> (atc) &#123;</span><br><span class="line">        <span class="keyword">if</span> (meta-&gt;<span class="built_in">ash</span>()) &#123;</span><br><span class="line">            meta-&gt;<span class="built_in">ash</span>()-&gt;timestamp = msg-&gt;timestamp;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (meta-&gt;<span class="built_in">data</span>()) &#123;</span><br><span class="line">            meta-&gt;<span class="built_in">data</span>()-&gt;timestamp = msg-&gt;timestamp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsOriginHub::on_audio</code>中处理不同格式的音频数，首先会将<code>SrsSharedPtrMessage</code>RTMP消息格式转<code>SrsFormat</code>消息格式。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsOriginHub::on_audio</span><span class="params">(SrsSharedPtrMessage* shared_audio)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;    </span><br><span class="line">    SrsSharedPtrMessage* msg = shared_audio;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = format-&gt;<span class="built_in">on_audio</span>(msg)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;format consume audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cache the sequence header if aac</span></span><br><span class="line">    <span class="comment">// donot cache the sequence header to gop_cache, return here.</span></span><br><span class="line">    <span class="keyword">if</span> (format-&gt;<span class="built_in">is_aac_sequence_header</span>()) &#123;</span><br><span class="line">        <span class="built_in">srs_assert</span>(format-&gt;acodec);</span><br><span class="line">        SrsAudioCodecConfig* c = format-&gt;acodec;</span><br><span class="line">        </span><br><span class="line">        <span class="type">static</span> <span class="type">int</span> flv_sample_sizes[] = &#123;<span class="number">8</span>, <span class="number">16</span>, <span class="number">0</span>&#125;;</span><br><span class="line">        <span class="type">static</span> <span class="type">int</span> flv_sound_types[] = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>&#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// when got audio stream info.</span></span><br><span class="line">        SrsStatistic* stat = SrsStatistic::<span class="built_in">instance</span>();</span><br><span class="line">        <span class="keyword">if</span> ((err = stat-&gt;<span class="built_in">on_audio_info</span>(req, SrsAudioCodecIdAAC, c-&gt;sound_rate, c-&gt;sound_type, c-&gt;aac_object)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;stat audio&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">srs_trace</span>(<span class="string">&quot;%dB audio sh, codec(%d, profile=%s, %dchannels, %dkbps, %dHZ), flv(%dbits, %dchannels, %dHZ)&quot;</span>,</span><br><span class="line">                  msg-&gt;size, c-&gt;id, <span class="built_in">srs_aac_object2str</span>(c-&gt;aac_object).<span class="built_in">c_str</span>(), c-&gt;aac_channels,</span><br><span class="line">                  c-&gt;audio_data_rate / <span class="number">1000</span>, srs_aac_srates[c-&gt;aac_sample_rate],</span><br><span class="line">                  flv_sample_sizes[c-&gt;sound_size], flv_sound_types[c-&gt;sound_type],</span><br><span class="line">                  srs_flv_srates[c-&gt;sound_rate]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = hls-&gt;<span class="built_in">on_audio</span>(msg, format)) != srs_success) &#123;</span><br><span class="line">        <span class="comment">// apply the error strategy for hls.</span></span><br><span class="line">        <span class="comment">// @see https://github.com/ossrs/srs/issues/264</span></span><br><span class="line">        std::string hls_error_strategy = _srs_config-&gt;<span class="built_in">get_hls_on_error</span>(req-&gt;vhost);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">srs_config_hls_is_on_error_ignore</span>(hls_error_strategy)) &#123;</span><br><span class="line">            <span class="built_in">srs_warn</span>(<span class="string">&quot;hls: ignore audio error %s&quot;</span>, <span class="built_in">srs_error_desc</span>(err).<span class="built_in">c_str</span>());</span><br><span class="line">            hls-&gt;<span class="built_in">on_unpublish</span>();</span><br><span class="line">            <span class="built_in">srs_error_reset</span>(err);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">srs_config_hls_is_on_error_continue</span>(hls_error_strategy)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">srs_hls_can_continue</span>(<span class="built_in">srs_error_code</span>(err), source-&gt;meta-&gt;<span class="built_in">ash</span>(), msg)) &#123;</span><br><span class="line">                <span class="built_in">srs_error_reset</span>(err);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: audio&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: audio&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHls::on_audio</code>调用<code>controller-&gt;write_audio</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHls::on_audio</span><span class="params">(SrsSharedPtrMessage* shared_audio, SrsFormat* format)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!enabled) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Ignore if no format-&gt;acodec, it means the codec is not parsed, or unknown codec.</span></span><br><span class="line">    <span class="comment">// @issue https://github.com/ossrs/srs/issues/1506#issuecomment-562079474</span></span><br><span class="line">    <span class="keyword">if</span> (!format-&gt;acodec) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// update the hls time, for hls_dispose.</span></span><br><span class="line">    last_update_time = <span class="built_in">srs_get_system_time</span>();</span><br><span class="line">    </span><br><span class="line">    SrsSharedPtrMessage* audio = shared_audio-&gt;<span class="built_in">copy</span>();</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsSharedPtrMessage, audio);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ts support audio codec: aac/mp3</span></span><br><span class="line">    SrsAudioCodecId acodec = format-&gt;acodec-&gt;id;</span><br><span class="line">    <span class="keyword">if</span> (acodec != SrsAudioCodecIdAAC &amp;&amp; acodec != SrsAudioCodecIdMP3) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ignore sequence header</span></span><br><span class="line">    <span class="built_in">srs_assert</span>(format-&gt;audio);</span><br><span class="line">    <span class="keyword">if</span> (acodec == SrsAudioCodecIdAAC &amp;&amp;</span><br><span class="line">        format-&gt;audio-&gt;aac_packet_type == SrsAudioAacFrameTraitSequenceHeader) &#123;</span><br><span class="line">        <span class="keyword">return</span> controller-&gt;<span class="built_in">on_sequence_header</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> config the jitter of HLS.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = jitter-&gt;<span class="built_in">correct</span>(audio, SrsRtmpJitterAlgorithmOFF)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: jitter&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Reset the aac samples counter when DTS jitter.</span></span><br><span class="line">    <span class="keyword">if</span> (previous_audio_dts &gt; audio-&gt;timestamp) &#123;</span><br><span class="line">        previous_audio_dts = audio-&gt;timestamp;</span><br><span class="line">        aac_samples = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The diff duration in ms between two FLV audio packets.</span></span><br><span class="line">    <span class="type">int</span> diff = ::<span class="built_in">abs</span>((<span class="type">int</span>)(audio-&gt;timestamp - previous_audio_dts));</span><br><span class="line">    previous_audio_dts = audio-&gt;timestamp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Guess the number of samples for each AAC frame.</span></span><br><span class="line">    <span class="comment">// If samples is 1024, the sample-rate is 8000HZ, the diff should be 1024/8000s=128ms.</span></span><br><span class="line">    <span class="comment">// If samples is 1024, the sample-rate is 44100HZ, the diff should be 1024/44100s=23ms.</span></span><br><span class="line">    <span class="comment">// If samples is 2048, the sample-rate is 44100HZ, the diff should be 2048/44100s=46ms.</span></span><br><span class="line">    <span class="type">int</span> nb_samples_per_frame = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> guessNumberOfSamples = diff * srs_flv_srates[format-&gt;acodec-&gt;sound_rate] / <span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">if</span> (guessNumberOfSamples &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (guessNumberOfSamples &lt; <span class="number">960</span>) &#123;</span><br><span class="line">            nb_samples_per_frame = <span class="number">960</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (guessNumberOfSamples &lt; <span class="number">1536</span>) &#123;</span><br><span class="line">            nb_samples_per_frame = <span class="number">1024</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (guessNumberOfSamples &lt; <span class="number">3072</span>) &#123;</span><br><span class="line">            nb_samples_per_frame = <span class="number">2048</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            nb_samples_per_frame = <span class="number">4096</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Recalc the DTS by the samples of AAC.</span></span><br><span class="line">    aac_samples += nb_samples_per_frame;</span><br><span class="line">    <span class="type">int64_t</span> dts = <span class="number">90000</span> * aac_samples / srs_flv_srates[format-&gt;acodec-&gt;sound_rate];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If directly turn FLV timestamp, overwrite the guessed DTS.</span></span><br><span class="line">    <span class="comment">// @doc https://github.com/ossrs/srs/issues/1506#issuecomment-562063095</span></span><br><span class="line">    <span class="keyword">if</span> (hls_dts_directly) &#123;</span><br><span class="line">        dts = audio-&gt;timestamp * <span class="number">90</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = controller-&gt;<span class="built_in">write_audio</span>(format-&gt;audio, dts)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: write audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHlsController::write_audio</code>缓存音频数据等，<code>muxer-&gt;flush_audio</code>写入音频数据。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHlsController::write_audio</span><span class="params">(SrsAudioFrame* frame, <span class="type">int64_t</span> pts)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// write audio to cache.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = tsmc-&gt;<span class="built_in">cache_audio</span>(frame, pts)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: cache audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// reap when current source is pure audio.</span></span><br><span class="line">    <span class="comment">// it maybe changed when stream info changed,</span></span><br><span class="line">    <span class="comment">// for example, pure audio when start, audio/video when publishing,</span></span><br><span class="line">    <span class="comment">// pure audio again for audio disabled.</span></span><br><span class="line">    <span class="comment">// so we reap event when the audio incoming when segment overflow.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/151</span></span><br><span class="line">    <span class="comment">// we use absolutely overflow of segment to make jwplayer/ffplay happy</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/151#issuecomment-71155184</span></span><br><span class="line">    <span class="keyword">if</span> (tsmc-&gt;audio &amp;&amp; muxer-&gt;<span class="built_in">is_segment_absolutely_overflow</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">reap_segment</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: reap segment&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// for pure audio, aggregate some frame to one.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> Check whether it&#x27;s necessary.</span></span><br><span class="line">    <span class="keyword">if</span> (muxer-&gt;<span class="built_in">pure_audio</span>() &amp;&amp; tsmc-&gt;audio) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pts - tsmc-&gt;audio-&gt;start_pts &lt; SRS_CONSTS_HLS_PURE_AUDIO_AGGREGATE) &#123;</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// directly write the audio frame by frame to ts,</span></span><br><span class="line">    <span class="comment">// it&#x27;s ok for the hls overload, or maybe cause the audio corrupt,</span></span><br><span class="line">    <span class="comment">// which introduced by aggregate the audios to a big one.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/512</span></span><br><span class="line">    <span class="keyword">if</span> ((err = muxer-&gt;<span class="built_in">flush_audio</span>(tsmc)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: flush audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用<code>current-&gt;tscw-&gt;write_audio</code>写入缓存音频数据。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHlsMuxer::flush_audio</span><span class="params">(SrsTsMessageCache* cache)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if current is NULL, segment is not open, ignore the flush event.</span></span><br><span class="line">    <span class="keyword">if</span> (!current) &#123;</span><br><span class="line">        <span class="built_in">srs_warn</span>(<span class="string">&quot;flush audio ignored, for segment is not open.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!cache-&gt;audio || cache-&gt;audio-&gt;payload-&gt;<span class="built_in">length</span>() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// update the duration of segment.</span></span><br><span class="line">    current-&gt;<span class="built_in">append</span>(cache-&gt;audio-&gt;pts / <span class="number">90</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = current-&gt;tscw-&gt;<span class="built_in">write_audio</span>(cache-&gt;audio)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: write audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// write success, clear and free the msg</span></span><br><span class="line">    <span class="built_in">srs_freep</span>(cache-&gt;audio);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用<code>context-&gt;encode</code>做TS格式封装。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsTsContextWriter::write_audio</span><span class="params">(SrsTsMessage* audio)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_info</span>(<span class="string">&quot;hls: write audio pts=%&quot;</span> PRId64 <span class="string">&quot;, dts=%&quot;</span> PRId64 <span class="string">&quot;, size=%d&quot;</span>,</span><br><span class="line">        audio-&gt;pts, audio-&gt;dts, audio-&gt;PES_packet_length);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = context-&gt;<span class="built_in">encode</span>(writer, audio, vcodec, acodec)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;ts: write audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">srs_info</span>(<span class="string">&quot;hls encode audio ok&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="拉流端"><a href="#拉流端" class="headerlink" title="拉流端"></a>拉流端</h3><p>主要是响应拉流客户端HTTP携带的m3u8和ts文件。</p>
<ul>
<li>断点<code>SrsFileReader::SrsFileReader</code>，拉流端会构造<code>SrsFileReader</code>类读取HLS协议相关文件响应客户端。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#0 SrsFileReader::SrsFileReader (this=0xa7ac50, __in_chrg=&lt;optimized out&gt;, __vtt_parm= &lt;optimized out&gt;) </span><br><span class="line">   at src/kernel/srs_kernel_file.cpp:195</span><br><span class="line">#1 0x0000000000459258 in ISrsFileReaderFactory::create_file_reader (this=0xa122f0)</span><br><span class="line">   at src/kernel/srs_kernel_file.cpp:192</span><br><span class="line">#2 0x0000000000499842 in SrsHttpFileServer::serve_file (this=0xa12310, w=0x7ffff7f0cbd0, r=0xa77130,</span><br><span class="line">   fullpath=&quot;./objs/nginx/html/live/livestream.m3u8&quot;) at src/protocol/srs_http_stack.cpp:391</span><br><span class="line">#3 0x000000000049957e in SrsHttpFileServer::serve_http (this=0xa12310, w=0x7ffff7f0cbd0, r=0xa77130)</span><br><span class="line">   at src/protocol/srs_http_stack.cpp:384</span><br><span class="line">#4 0x000000000049c86f in SrsHttpServeMux::serve_http (this=0xa10420, w=0x7ffff7f0cbd0, r=0xa77130)</span><br><span class="line">   at src/protocol/srs_http_stack.cpp:711</span><br><span class="line">#5 0x00000000005620a1 in SrsHttpServer::serve_http (this=0xa11e60, w=0x7ffff7f0cbd0, r=0xa77130)</span><br><span class="line">   at src/app/srs_app_http_conn.cpp:303</span><br><span class="line">#6 0x000000000049d6be in SrsHttpCorsMux::serve_http (this=0xa59bb0, w=0x7ffff7f0cbd0, r=0xa77130)</span><br><span class="line">   at src/protocol/srs_http_stack.cpp:859</span><br><span class="line">#7 0x0000000000561086 in SrsHttpConn::process_request (this=0xa76ea0, w=0x7ffff7f0cbd0, r=0xa77130)</span><br><span class="line">   at src/app/srs_app_http_conn.cpp:161</span><br><span class="line">#8 0x0000000000560ce8 in SrsHttpConn::do_cycle (this=0xa76ea0) at src/app/srs_app_http_conn.cpp:133</span><br><span class="line">#9 0x00000000004d10fb in SrsConnection::cycle (this=0xa76ea0) at src/app/srs_app_conn.cpp:171</span><br><span class="line">#10 0x0000000000509c88 in SrsSTCoroutine::cycle (this=0xa5aa20) at src/app/srs_app_st.cpp:198</span><br><span class="line">#11 0x0000000000509cfd in SrsSTCoroutine::pfn (arg=0xa5aa20) at src/app/srs_app_st.cpp:213 </span><br><span class="line">#12 0x00000000005bdd9d in _st_thread_main () at sched.c:337</span><br><span class="line">#13 0x00000000005be515 in st_thread_create (start=0x5bd719 &lt;_st_vp_schedule+170&gt;, </span><br><span class="line">    arg=0x900000001, joinable=1, stk_size=1) at sched.c:616</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHttpServer::serve_http</code>之前流程类似HTTP-FLV拉流。</li>
<li>对于HTTP-FLV进入<code>http_stream-&gt;mux.serve_http</code>，而HLS进入<code>http_static-&gt;mux.serve_http</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpServer::serve_http</span><span class="params">(ISrsHttpResponseWriter* w, ISrsHttpMessage* r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// try http stream first.</span></span><br><span class="line">    ISrsHttpHandler* h = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> ((err = http_stream-&gt;mux.<span class="built_in">find_handler</span>(r, &amp;h)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;find handler&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!h-&gt;<span class="built_in">is_not_found</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> http_stream-&gt;mux.<span class="built_in">serve_http</span>(w, r);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> http_static-&gt;mux.<span class="built_in">serve_http</span>(w, r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>与HTTP-FLV不同HLS<code>ISrsHttpHandler</code>是<code>SrsHttpFileServer</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpServeMux::serve_http</span><span class="params">(ISrsHttpResponseWriter* w, ISrsHttpMessage* r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    ISrsHttpHandler* h = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">find_handler</span>(r, &amp;h)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;find handler&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_assert</span>(h);</span><br><span class="line">    <span class="keyword">if</span> ((err = h-&gt;<span class="built_in">serve_http</span>(w, r)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;serve http&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>检查文件是否存在，<code>serve_file</code>读取文件。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpFileServer::serve_http</span><span class="params">(ISrsHttpResponseWriter* w, ISrsHttpMessage* r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">srs_assert</span>(entry);</span><br><span class="line"></span><br><span class="line">    string upath = r-&gt;<span class="built_in">path</span>();</span><br><span class="line">    string fullpath = <span class="built_in">srs_http_fs_fullpath</span>(dir, entry-&gt;pattern, upath);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// stat current dir, if exists, return error.</span></span><br><span class="line">    <span class="keyword">if</span> (!_srs_path_exists(fullpath)) &#123;</span><br><span class="line">        <span class="built_in">srs_warn</span>(<span class="string">&quot;http miss file=%s, pattern=%s, upath=%s&quot;</span>,</span><br><span class="line">                 fullpath.<span class="built_in">c_str</span>(), entry-&gt;pattern.<span class="built_in">c_str</span>(), upath.<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">SrsHttpNotFoundHandler</span>().<span class="built_in">serve_http</span>(w, r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;http match file=%s, pattern=%s, upath=%s&quot;</span>,</span><br><span class="line">              fullpath.<span class="built_in">c_str</span>(), entry-&gt;pattern.<span class="built_in">c_str</span>(), upath.<span class="built_in">c_str</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// handle file according to its extension.</span></span><br><span class="line">    <span class="comment">// use vod stream for .flv/.fhv</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">srs_string_ends_with</span>(fullpath, <span class="string">&quot;.flv&quot;</span>) || <span class="built_in">srs_string_ends_with</span>(fullpath, <span class="string">&quot;.fhv&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">serve_flv_file</span>(w, r, fullpath);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">srs_string_ends_with</span>(fullpath, <span class="string">&quot;.mp4&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">serve_mp4_file</span>(w, r, fullpath);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// serve common static file.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">serve_file</span>(w, r, fullpath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>文件读取并封装HTTP响应格式，最后调用<code>SrsHttpResponseWriter::final_request</code>完成对客户端响应。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpFileServer::serve_file</span><span class="params">(ISrsHttpResponseWriter* w, ISrsHttpMessage* r, string fullpath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    SrsFileReader* fs = fs_factory-&gt;<span class="built_in">create_file_reader</span>();</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsFileReader, fs);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((err = fs-&gt;<span class="built_in">open</span>(fullpath)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;open file %s&quot;</span>, fullpath.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The length of bytes we could response to.</span></span><br><span class="line">    <span class="type">int64_t</span> length = fs-&gt;<span class="built_in">filesize</span>() - fs-&gt;<span class="built_in">tellg</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// unset the content length to encode in chunked encoding.</span></span><br><span class="line">    w-&gt;<span class="built_in">header</span>()-&gt;<span class="built_in">set_content_length</span>(length);</span><br><span class="line">    </span><br><span class="line">    <span class="type">static</span> std::map&lt;std::string, std::string&gt; _mime;</span><br><span class="line">    <span class="keyword">if</span> (_mime.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        _mime[<span class="string">&quot;.ts&quot;</span>] = <span class="string">&quot;video/MP2T&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.flv&quot;</span>] = <span class="string">&quot;video/x-flv&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.m4v&quot;</span>] = <span class="string">&quot;video/x-m4v&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.3gpp&quot;</span>] = <span class="string">&quot;video/3gpp&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.3gp&quot;</span>] = <span class="string">&quot;video/3gpp&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.mp4&quot;</span>] = <span class="string">&quot;video/mp4&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.aac&quot;</span>] = <span class="string">&quot;audio/x-aac&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.mp3&quot;</span>] = <span class="string">&quot;audio/mpeg&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.m4a&quot;</span>] = <span class="string">&quot;audio/x-m4a&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.ogg&quot;</span>] = <span class="string">&quot;audio/ogg&quot;</span>;</span><br><span class="line">        <span class="comment">// @see hls-m3u8-draft-pantos-http-live-streaming-12.pdf, page 5.</span></span><br><span class="line">        _mime[<span class="string">&quot;.m3u8&quot;</span>] = <span class="string">&quot;application/vnd.apple.mpegurl&quot;</span>; <span class="comment">// application/x-mpegURL</span></span><br><span class="line">        _mime[<span class="string">&quot;.rss&quot;</span>] = <span class="string">&quot;application/rss+xml&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.json&quot;</span>] = <span class="string">&quot;application/json&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.swf&quot;</span>] = <span class="string">&quot;application/x-shockwave-flash&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.doc&quot;</span>] = <span class="string">&quot;application/msword&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.zip&quot;</span>] = <span class="string">&quot;application/zip&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.rar&quot;</span>] = <span class="string">&quot;application/x-rar-compressed&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.xml&quot;</span>] = <span class="string">&quot;text/xml&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.html&quot;</span>] = <span class="string">&quot;text/html&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.js&quot;</span>] = <span class="string">&quot;text/javascript&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.css&quot;</span>] = <span class="string">&quot;text/css&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.ico&quot;</span>] = <span class="string">&quot;image/x-icon&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.png&quot;</span>] = <span class="string">&quot;image/png&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.jpeg&quot;</span>] = <span class="string">&quot;image/jpeg&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.jpg&quot;</span>] = <span class="string">&quot;image/jpeg&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.gif&quot;</span>] = <span class="string">&quot;image/gif&quot;</span>;</span><br><span class="line">        <span class="comment">// For MPEG-DASH.</span></span><br><span class="line">        <span class="comment">//_mime[&quot;.mpd&quot;] = &quot;application/dash+xml&quot;;</span></span><br><span class="line">        _mime[<span class="string">&quot;.mpd&quot;</span>] = <span class="string">&quot;text/xml&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.m4s&quot;</span>] = <span class="string">&quot;video/iso.segment&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.mp4v&quot;</span>] = <span class="string">&quot;video/mp4&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        std::string ext = <span class="built_in">srs_path_filext</span>(fullpath);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (_mime.<span class="built_in">find</span>(ext) == _mime.<span class="built_in">end</span>()) &#123;</span><br><span class="line">            w-&gt;<span class="built_in">header</span>()-&gt;<span class="built_in">set_content_type</span>(<span class="string">&quot;application/octet-stream&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            w-&gt;<span class="built_in">header</span>()-&gt;<span class="built_in">set_content_type</span>(_mime[ext]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Enter chunked mode, because we didn&#x27;t set the content-length.</span></span><br><span class="line">    w-&gt;<span class="built_in">write_header</span>(SRS_CONSTS_HTTP_OK);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// write body.</span></span><br><span class="line">    <span class="type">int64_t</span> left = length;</span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">copy</span>(w, fs, r, (<span class="type">int</span>)left)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;copy file=%s size=%d&quot;</span>, fullpath.<span class="built_in">c_str</span>(), left);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = w-&gt;<span class="built_in">final_request</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;final request&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHttpFileServer</code>怎么创建的，断点<code>SrsHttpFileServer::SrsHttpFileServer</code>。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#0 SrsHttpFileServer (this=0xa12530, root_dir=&quot;\360$\241\000\000\000\000\000\021\000\000\000\000\0001000\000\021\000\000\000\00010001000100013241301\376\366\377\177\000\000 \b\241\000\000\000\000\000\000\364\363\034\031\071\000\234`\340\377\377\377\177\000\000\060%\241\000\000\000\000\000`\340\377\377\177\000\ 000R\351W\ 000\000\000\000\000\000\027\241\000\000\000\0001000\000 \241\000\000\000\000\000\260\337\377\000\b&quot;, &#x27;\000&#x27; &lt;r&gt;，</span><br><span class="line">&quot;\341\377\377\377\177\000\000\060\004\241\000\000\000\000\000\060\005\241\000\000\000\000\000\021\000\000\000\000\000\000\000\021\000\000\000\000\00010001000100010271241\000\000\000\000\000\&quot;\241\000\000\000\000\000&quot;...) at src/protocol/srs_http_stack. cpp:336</span><br><span class="line">#1 0x000000000057d326 in SrsVodStream: :SrsVodStream (this=0xa12530, root_dir=&quot;`\&quot;\241\000\000\000\000\000\021\000\000\000\000\000\000\000\021&quot;</span><br><span class="line">, &#x27;\000&#x27; &lt;repeats 24 times&gt;, &quot;\364\363\034\031\071\000\234\064\005n\000\000\000\000\000\000\b\241\000\000\000\000\000 \340\377\377\377\177\000\000\000\364\363\034\031\071\000\234\000\000\000\000\000\000\000\000\000\b\241\000\000\0001\000\000 \b\241\0001000\000\000\000\300\341\377\377\377\177\000\000\320\340\377\377\377\177\000\000\234 V\000\000\000\000\000\220\340\377\377\377\177\000\000\260\033\241\000\000\000\000\000\320\340\377\377\377\177\000\000\000\000\000\000\000\000\000\000@\b\241\00\000\000\000\00\020\000\000\000\000\000\000\000\020\000\000\000\000\000\000\000s\277I\000\000\000\000\000\250!\241\000\000\000\000\000&quot;...) </span><br><span class="line">  at src/app/srs_app_http_static.cpp:54</span><br><span class="line">#2 0x000000000057e952 in SrsHttpStaticServer::initialize (this=0xa12000)</span><br><span class="line">   at src/app/srs_app_http_static. cpp:235</span><br><span class="line">#3 0x000000000056209 in SrsHttpServer::initialize (this=0xallbb0) at src/app/srs_app_http_conn.cpp:283</span><br><span class="line">#4 0x00000000004c8648 in SrsServer::initialize (this=0xa10630, ch=0x0) at src/app/srs_app_server.cpp:757</span><br><span class="line">#5 0x00000000005bccdf in run (svr=0xa10630) at src/main/srs_main_server.cpp:395</span><br><span class="line">#6 0x00000000005bb8f1 in do_main (argc=3, argv=0×7fffffffe4f8) at src/main/srs_main_server.cpp:184</span><br><span class="line">#7 0x00000000005bba35 in main (argc=3, argv=0x7fffffffe4f8) at src/main/srs_main_server.cpp:192</span><br></pre></td></tr></table></figure>

<ul>
<li>初始化<code>SrsHttpStreamServer</code>和<code>SrsHttpStaticServer</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpServer::initialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// for SRS go-sharp to detect the status of HTTP server of SRS HTTP FLV Cluster.</span></span><br><span class="line">    <span class="comment">//需要做精碗匹配</span></span><br><span class="line">    <span class="keyword">if</span> ((err = http_static-&gt;mux.<span class="built_in">handle</span>(<span class="string">&quot;/api/v1/versions&quot;</span>, <span class="keyword">new</span> <span class="built_in">SrsGoApiVersion</span>())) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;handle versin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = http_stream-&gt;<span class="built_in">initialize</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;http stream&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = http_static-&gt;<span class="built_in">initialize</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;http static&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>注册<code>SrsVodStream</code>，基类是<code>SrsHttpFileServer</code>，在<code>find_handler</code>中可以匹配。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpStaticServer::initialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="type">bool</span> default_root_exists = <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// http static file and flv vod stream mount for each vhost.</span></span><br><span class="line">    SrsConfDirective* root = _srs_config-&gt;<span class="built_in">get_root</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; (<span class="type">int</span>)root-&gt;directives.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        SrsConfDirective* conf = root-&gt;<span class="built_in">at</span>(i);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!conf-&gt;<span class="built_in">is_vhost</span>()) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        string pmount;</span><br><span class="line">        string vhost = conf-&gt;<span class="built_in">arg0</span>();</span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">mount_vhost</span>(vhost, pmount)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;mount vhost&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (pmount == <span class="string">&quot;/&quot;</span>) &#123;</span><br><span class="line">            default_root_exists = <span class="literal">true</span>;</span><br><span class="line">            std::string dir = _srs_config-&gt;<span class="built_in">get_vhost_http_dir</span>(vhost);</span><br><span class="line">            <span class="built_in">srs_warn</span>(<span class="string">&quot;http: root mount to %s&quot;</span>, dir.<span class="built_in">c_str</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!default_root_exists) &#123;</span><br><span class="line">        <span class="comment">// add root</span></span><br><span class="line">        std::string dir = _srs_config-&gt;<span class="built_in">get_http_stream_dir</span>();</span><br><span class="line">        <span class="keyword">if</span> ((err = mux.<span class="built_in">handle</span>(<span class="string">&quot;/&quot;</span>, <span class="keyword">new</span> <span class="built_in">SrsVodStream</span>(dir))) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;mount root dir=%s&quot;</span>, dir.<span class="built_in">c_str</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">srs_trace</span>(<span class="string">&quot;http: root mount to %s&quot;</span>, dir.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/10/02/SRC%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BHTTP-FLV/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/02/SRC%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BHTTP-FLV/" class="post-title-link" itemprop="url">SRC流媒体服务器之HTTP-FLV</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-10-02 10:07:31" itemprop="dateCreated datePublished" datetime="2023-10-02T10:07:31+08:00">2023-10-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-12-30 22:37:44" itemprop="dateModified" datetime="2023-12-30T22:37:44+08:00">2023-12-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SRS/" itemprop="url" rel="index"><span itemprop="name">SRS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="HTTP-FLV介绍"><a href="#HTTP-FLV介绍" class="headerlink" title="HTTP-FLV介绍"></a>HTTP-FLV介绍</h1><ul>
<li>HTTP协议中有个约定：Content-Length字段，HTTP服务器回复HTTP请求的时候如果有这个字段，客户端就接收这个⻓度的数据然后就认为数据传输完成了，如果服务器回复HTTP请求中没有这个字段，客户端就⼀直接收数据，直到服务器跟客户端的socket连接断开。</li>
<li>HTTP-FLV直播就是利⽤了这个原理，服务器回复客户端请求的时候不加Content-Length字段，在回复了HTTP内容之后，紧接着发送FLV数据，客户端就⼀直接收数据了。 </li>
<li>HTTP-FLV报文格式：</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/live/livestream.flv</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Lavf/59.30.100</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Range</span><span class="punctuation">: </span>bytes=0-</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.2.9:8080</span><br><span class="line"><span class="attribute">Icy-MetaData</span><span class="punctuation">: </span>1</span><br><span class="line"></span><br><span class="line"><span class="language-http"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span></span><br><span class="line"><span class="language-http"><span class="attribute">Connection</span><span class="punctuation">: </span>Close</span></span><br><span class="line"><span class="language-http"><span class="attribute">Content-Type</span><span class="punctuation">: </span>video/x-flv</span></span><br><span class="line"><span class="language-http"><span class="attribute">Server</span><span class="punctuation">: </span>SRS/6.0.75(Bee)</span></span><br><span class="line"><span class="language-http"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span></span><br><span class="line"><span class="language-http"></span></span><br><span class="line"><span class="language-http"><span class="language-jboss-cli">9</span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http">FLV.<span class="string">....</span>	</span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http">4</span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http"><span class="string">....</span></span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http">df91</span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http"><span class="string">.............</span></span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http">onMetaData.<span class="string">..width.</span>@<span class="string">.........height.</span>@t.<span class="string">......</span></span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http">videodatarate.@i.P.<span class="string">....</span>	framerate.@9.<span class="string">.......videocodecid.</span>@<span class="string">........</span></span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http">audiodatarate.@=T@<span class="string">......audiosamplerate.</span>@<span class="string">.........audiosamplesize.</span>@0.<span class="string">.......stereo....audiocodecid.</span>@$<span class="string">........major_brand...isom.</span></span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http">minor_<span class="keyword">version</span>.<span class="string">..512..compatible_brands...isomiso2avc1mp41..encoder..</span></span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http">Lavf59.30.100.<span class="string">.filesize...........server...SRS/6.0.75</span><span class="params">(Bee)</span><span class="string">..server_version...6.0.75.</span></span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http"><span class="comment">#省略</span></span></span></span><br></pre></td></tr></table></figure>

<h1 id="HTTP-FLV源码分析"><a href="#HTTP-FLV源码分析" class="headerlink" title="HTTP-FLV源码分析"></a>HTTP-FLV源码分析</h1><h2 id="配置⽂件"><a href="#配置⽂件" class="headerlink" title="配置⽂件"></a>配置⽂件</h2><p>修改<code>conf/http.flv.live.conf</code>文件，<code>./objs/srs -c conf/http.flv.live.conf</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">listen              1935;</span><br><span class="line">max_connections     1000;</span><br><span class="line">daemon              off;</span><br><span class="line">srs_log_tank        console;</span><br><span class="line">http_server &#123;</span><br><span class="line">    enabled         on;</span><br><span class="line">    listen          8080;</span><br><span class="line">    dir             ./objs/nginx/html;</span><br><span class="line">&#125;</span><br><span class="line">vhost __defaultVhost__ &#123;</span><br><span class="line">    http_remux &#123;</span><br><span class="line">        enabled     on;</span><br><span class="line">        mount       [vhost]/[app]/[stream].flv;  # ⽀持.flv .ts .aac .mp3的使⽤</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="调试分析"><a href="#调试分析" class="headerlink" title="调试分析"></a>调试分析</h2><h3 id="核心类"><a href="#核心类" class="headerlink" title="核心类"></a>核心类</h3><ul>
<li><p><code>SrsBufferCache</code>：HTTP直播流编码器的缓存。</p>
</li>
<li><p><code>SrsFlvStreamEncoder</code>：将RTMP转成HTTP FLV流。</p>
</li>
<li><p><code>SrsTsStreamEncoder</code>：将RTMP转成HTTP TS流。</p>
</li>
<li><p><code>SrsAacStreamEncoder</code>：将RTMP含有的AAC成分转成HTTP AAC流。</p>
</li>
<li><p><code>SrsMp3StreamEncoder</code>：将RTMP含有的MP3成分转成HTTP MP3流。</p>
</li>
<li><p><code>SrsBufferWriter</code>：将流直接写⼊到HTTP响应。</p>
</li>
<li><p><code>SrsLiveStream</code>：HTTP直播流，将RTMP转成HTTP-FLV或者其他格式，其实际是handler。</p>
</li>
<li><p><code>SrsLiveEntry</code>：直播⼊⼝，⽤来处理HTTP直播流。</p>
</li>
<li><p><code>SrsHttpStreamServer</code>：HTTP直播流服务，服务FLV&#x2F;TS&#x2F;MP3&#x2F;AAC流。</p>
</li>
<li><p><code>SrsHttpResponseWriter</code>：负责将数据发送给客户端，本质是调⽤SrsStSocket进⾏发送。</p>
</li>
<li><p><code>SrsHttpServeMux</code>：HTTP请求多路复⽤器，说⽩了就是路由，⾥⾯记录了path以及对应的handler。</p>
</li>
</ul>
<h3 id="监听"><a href="#监听" class="headerlink" title="监听"></a>监听</h3><ul>
<li>监听进入<code>SrsServer::listen_http_stream</code>，流程与RTMP监听一样。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsServer::listen_http_stream</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">close_listeners</span>(SrsListenerHttpStream);</span><br><span class="line">    <span class="keyword">if</span> (_srs_config-&gt;<span class="built_in">get_http_stream_enabled</span>()) &#123;</span><br><span class="line">        <span class="comment">//SrsListenerHttpStream</span></span><br><span class="line">        SrsListener* listener = <span class="keyword">new</span> <span class="built_in">SrsBufferListener</span>(<span class="keyword">this</span>, SrsListenerHttpStream);</span><br><span class="line">        listeners.<span class="built_in">push_back</span>(listener);</span><br><span class="line">        </span><br><span class="line">        std::string ep = _srs_config-&gt;<span class="built_in">get_http_stream_listen</span>();</span><br><span class="line">        </span><br><span class="line">        std::string ip;</span><br><span class="line">        <span class="type">int</span> port;</span><br><span class="line">        <span class="built_in">srs_parse_endpoint</span>(ep, ip, port);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = listener-&gt;<span class="built_in">listen</span>(ip, port)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;http stream listen %s:%d&quot;</span>, ip.<span class="built_in">c_str</span>(), port);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>监听类型是<code>SrsListenerHttpStream</code>，创建<code>SrsResponseOnlyHttpConn</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsServer::fd2conn</span><span class="params">(SrsListenerType type, <span class="type">srs_netfd_t</span> stfd, SrsConnection** pconn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (type == SrsListenerRtmpStream) &#123;</span><br><span class="line">        *pconn = <span class="keyword">new</span> <span class="built_in">SrsRtmpConn</span>(<span class="keyword">this</span>, stfd, ip);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == SrsListenerHttpApi) &#123;</span><br><span class="line">        *pconn = <span class="keyword">new</span> <span class="built_in">SrsHttpApi</span>(<span class="keyword">this</span>, stfd, http_api_mux, ip);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == SrsListenerHttpStream) &#123;</span><br><span class="line">        *pconn = <span class="keyword">new</span> <span class="built_in">SrsResponseOnlyHttpConn</span>(<span class="keyword">this</span>, stfd, http_server, ip);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">srs_warn</span>(<span class="string">&quot;close for no service handler. fd=%d, ip=%s&quot;</span>, fd, ip.<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="built_in">srs_close_stfd</span>(stfd);</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="推流端"><a href="#推流端" class="headerlink" title="推流端"></a>推流端</h3><p>推流主要根据URL创建对应的<code>ISrsHttpHandler</code>。</p>
<ul>
<li>根据配置文件关键字<code>http_remux</code>查找，断点<code>SrsConfig::get_vhost_http_remux_enabled</code>。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#0 SrsConfig::get_vhost_http_remux_enabled (this=0xa0fcf0, vhost=&quot;__defaultVhost__&quot;)</span><br><span class="line">   at src/app/srs_app_config.cpp:6886</span><br><span class="line">#1 0x00000000005029cf in SrsHttpStreamServer::initialize_flv_entry this=0xallfd0, vhost=&quot;__defaultVhost__&quot;)</span><br><span class="line">   at src/app/srs_app_http_stream.cpp:1166</span><br><span class="line">#2 0x00000000005028d3 in SrsHttpStreamServer::initialize_flv_streaming (this=0xa11fd0)</span><br><span class="line">   at src/app/srs_app_http_stream.cpp:1154</span><br><span class="line">#3 0x0000000000500a2a in SrsHttpStreamServer::initialize (this=0xallfd0)</span><br><span class="line">   at src/app/srs_app_http_stream.cpp:873</span><br><span class="line">#4 0x0000000000561eb7 in SrsHttpServer::initialize (this=0xalle00) at src/app/srs_app_http_conn.cpp:279</span><br><span class="line">#5 0x00000000004c84c0 in SrsServer::initialize (this=0xallea0, ch=0x0) at src/app/srs_app_server.cpp:757</span><br><span class="line">#6 0x00000000005bcb57 in run (svr=0xa11ea0) at src/main/srs_main_server.cpp:395</span><br><span class="line">#7 0x00000000005bb769 in do_main (argc=3, argv=0x7fffffffe4f8) at src/main/srs_main_server.cpp:184</span><br><span class="line">#8 0x00000000005bb8ad in main (argc=3, argv=0x7fffffffe4f8) at src/main/srs_main_server.cpp:192</span><br></pre></td></tr></table></figure>

<ul>
<li><code>initialize_flv_entry</code>，创建<code>SrsLiveEntry</code>用于处理HTTP直播流并保存。</li>
<li><code>tflvs</code>根据配置创建并保存HTTP直播流地址模板，提供给<code>sflvs</code>使用。</li>
<li><code>sflvs</code>在<code>SrsHttpStreamServer::http_mount</code>中赋值，用于HTTP直播流。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpStreamServer::initialize_flv_entry</span><span class="params">(std::string vhost)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!_srs_config-&gt;<span class="built_in">get_vhost_http_remux_enabled</span>(vhost)) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    SrsLiveEntry* entry = <span class="keyword">new</span> <span class="built_in">SrsLiveEntry</span>(_srs_config-&gt;<span class="built_in">get_vhost_http_remux_mount</span>(vhost));</span><br><span class="line">    </span><br><span class="line">    tflvs[vhost] = entry;</span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;http flv live stream, vhost=%s, mount=%s&quot;</span>, vhost.<span class="built_in">c_str</span>(), entry-&gt;mount.<span class="built_in">c_str</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>do_main</code>函数初始化srs服务。</li>
<li>其中<code>SrsHttpServeMux</code>用于公共路由规则。</li>
<li><code>SrsHttpServer</code>包含<code>SrsHttpStreamServer</code>和<code>SrsHttpStaticServer</code>。<ul>
<li><code>SrsHttpStreamServer</code>用于HTTP直播流。</li>
<li><code>SrsHttpStaticServer</code>用于HTTP静态文件访问。</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">SrsServer::<span class="built_in">SrsServer</span>()</span><br><span class="line">&#123;</span><br><span class="line">    signal_reload = <span class="literal">false</span>;</span><br><span class="line">    signal_persistence_config = <span class="literal">false</span>;</span><br><span class="line">    signal_gmc_stop = <span class="literal">false</span>;</span><br><span class="line">    signal_fast_quit = <span class="literal">false</span>;</span><br><span class="line">    signal_gracefully_quit = <span class="literal">false</span>;</span><br><span class="line">    pid_fd = <span class="number">-1</span>;</span><br><span class="line">    </span><br><span class="line">    signal_manager = <span class="keyword">new</span> <span class="built_in">SrsSignalManager</span>(<span class="keyword">this</span>);</span><br><span class="line">    conn_manager = <span class="keyword">new</span> <span class="built_in">SrsCoroutineManager</span>();</span><br><span class="line">    </span><br><span class="line">    handler = <span class="literal">NULL</span>;</span><br><span class="line">    ppid = ::<span class="built_in">getppid</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// donot new object in constructor,</span></span><br><span class="line">    <span class="comment">// for some global instance is not ready now,</span></span><br><span class="line">    <span class="comment">// new these objects in initialize instead.</span></span><br><span class="line">    http_api_mux = <span class="keyword">new</span> <span class="built_in">SrsHttpServeMux</span>();</span><br><span class="line">    http_server = <span class="keyword">new</span> <span class="built_in">SrsHttpServer</span>(<span class="keyword">this</span>);</span><br><span class="line">    http_heartbeat = <span class="keyword">new</span> <span class="built_in">SrsHttpHeartbeat</span>();</span><br><span class="line">    ingester = <span class="keyword">new</span> <span class="built_in">SrsIngester</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>断点<code>SrsHttpStreamServer::http_mount </code>，看下推流具体堆栈。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#0 0x0000000000500ffa in SrsHttpStreamServer::http_mount (this=0xa11dc0, s=0xa3bf80, r=0xa3ae90)</span><br><span class="line">   at src/app/srs_app_http_stream.cpp:907</span><br><span class="line">#1 0x00000000005620f5 in SrsHttpServer::http_mount (this=0xa118f0, s=0xa3bf80, r=0xa3ae90)</span><br><span class="line">   at src/app/srs_app_http_conn.cpp:308</span><br><span class="line">#2 0x00000000004cd3cc in SrsServer::on_publish (this=0xa103a0, s=0xa3bf80, r=0xa3ae90)</span><br><span class="line">   at src/app/srs_app_server.cpp:1608</span><br><span class="line">#3 0x00000000004e6a9b in SrsSource::on_publish (this=0xa3bf80) at src/app/srs_app_source.cpp:2466</span><br><span class="line">#4 0x00000000004d89f2 in SrsRtmpConn::acquire_publish (this=0xa30ce0, source=0xa3bf80)</span><br><span class="line">   at src/app/srs_app_rtmp_conn.cpp:940</span><br><span class="line">#5 0x00000000004d7a74 in SrsRtmpConn::publishing (this=0xa30ce0, source=0xa3bf80)</span><br><span class="line">   at src/app/srs_app_rtmp_conn.cpp:822</span><br><span class="line">#6 0x00000000004d5229 in SrsRtmpConn::stream_service_cycle (this=0xa30ce0)</span><br><span class="line">   at src/app/srs_app_rtmp_conn.cpp:534</span><br><span class="line">#7 0x00000000004d4141 in SrsRtmpConn::service_cycle (this=0xa30ce0) at src/app/srs_app_rtmp_conn.cpp:388</span><br><span class="line">#8 0x00000000004d2f09 in SrsRtmpConn::do_cycle (this=0xa30ce0) at src/app/srs_app_rtmp_conn.cpp:209</span><br><span class="line">#9 0x00000000004d10fb in SrsConnection::cycle (this=0xa30d58) at src/app/srs_app_conn.cpp:171</span><br><span class="line">#10 0x0000000000509c88 in SrsSTCoroutine::cycle (this=0xa30f70) at src/app/srs_app_st.cpp:198</span><br><span class="line">#11 0x0000000000509cfd in SrsSTCoroutine::pfn (arg=0xa30f70) at src/app/srs_app_st.cpp:213</span><br><span class="line">#12 0x00000000005bdd9d in _st_thread_main () at sched.c:337</span><br><span class="line">#13 0x00000000005be515 in st_thread_create (start=0x5bd719 &lt;_st_vp_schedule+170&gt;, </span><br><span class="line">    arg=0x700000001, joinable=1, stk_size=1) at sched.c:616</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsRtmpConn::acquire_publish</code>中<code>info-&gt;edge</code>分支是用来edge边缘推流的，该流程处理在另一个分支<code>source-&gt;on_publish</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::acquire_publish</span><span class="params">(SrsSource* source)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!source-&gt;<span class="built_in">can_publish</span>(info-&gt;edge)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_SYSTEM_STREAM_BUSY, </span><br><span class="line">                             <span class="string">&quot;rtmp: stream %s is busy&quot;</span>, </span><br><span class="line">                             req-&gt;<span class="built_in">get_stream_url</span>().<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// when edge, ignore the publish event, directly proxy it.</span></span><br><span class="line">    <span class="keyword">if</span> (info-&gt;edge) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">on_edge_start_publish</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: edge start publish&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">on_publish</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: source publish&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用<code>source-&gt;on_publish</code>进入<code>SrsServer::on_publish</code>，调用<code>http_server-&gt;http_mount</code>创建路由规则。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsServer::on_publish</span><span class="params">(SrsSource* s, SrsRequest* r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = http_server-&gt;<span class="built_in">http_mount</span>(s, r)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;http mount&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//源站集群</span></span><br><span class="line">    SrsCoWorkers* coworkers = SrsCoWorkers::<span class="built_in">instance</span>();</span><br><span class="line">    <span class="keyword">if</span> ((err = coworkers-&gt;<span class="built_in">on_publish</span>(s, r)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;coworkers&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>对于同一个推流端，<code>SrsLiveEntry</code>和<code>SrsLiveStream</code>是一一对应的。</li>
<li><code>SrsLiveEntry</code>是用来处理URL映射关系的；</li>
<li><code>SrsLiveStream</code>主要是给HTTP拉流客户端访问的。</li>
<li>同一路的多个拉流客户端公用一个<code>SrsLiveStream</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpStreamServer::http_mount</span><span class="params">(SrsSource* s, SrsRequest* r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// the id to identify stream.</span></span><br><span class="line">    <span class="comment">//比如/live/stream</span></span><br><span class="line">    std::string sid = r-&gt;<span class="built_in">get_stream_url</span>();</span><br><span class="line">    SrsLiveEntry* entry = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// create stream from template when not found.</span></span><br><span class="line">    <span class="keyword">if</span> (sflvs.<span class="built_in">find</span>(sid) == sflvs.<span class="built_in">end</span>()) &#123;</span><br><span class="line">        <span class="comment">//查找对应vhost，比如__defaultVhost__</span></span><br><span class="line">        <span class="keyword">if</span> (tflvs.<span class="built_in">find</span>(r-&gt;vhost) == tflvs.<span class="built_in">end</span>()) &#123; <span class="comment">//vhost</span></span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取SrsLiveEntry</span></span><br><span class="line">        SrsLiveEntry* tmpl = tflvs[r-&gt;vhost];</span><br><span class="line">        <span class="comment">//mount 比如[vhost]/[app]/[stream].flv</span></span><br><span class="line">        std::string mount = tmpl-&gt;mount;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// replace the vhost variable</span></span><br><span class="line">        mount = <span class="built_in">srs_string_replace</span>(mount, <span class="string">&quot;[vhost]&quot;</span>, r-&gt;vhost);</span><br><span class="line">        mount = <span class="built_in">srs_string_replace</span>(mount, <span class="string">&quot;[app]&quot;</span>, r-&gt;app);</span><br><span class="line">        mount = <span class="built_in">srs_string_replace</span>(mount, <span class="string">&quot;[stream]&quot;</span>, r-&gt;stream);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// remove the default vhost mount</span></span><br><span class="line">        <span class="comment">//替换mount 类似 /livestream/live.flv格式</span></span><br><span class="line">        mount = <span class="built_in">srs_string_replace</span>(mount, SRS_CONSTS_RTMP_DEFAULT_VHOST<span class="string">&quot;/&quot;</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        entry = <span class="keyword">new</span> <span class="built_in">SrsLiveEntry</span>(mount);</span><br><span class="line"></span><br><span class="line">        entry-&gt;source = s;</span><br><span class="line">        entry-&gt;req = r-&gt;<span class="built_in">copy</span>()-&gt;<span class="built_in">as_http</span>();</span><br><span class="line">        entry-&gt;cache = <span class="keyword">new</span> <span class="built_in">SrsBufferCache</span>(s, r);</span><br><span class="line">        <span class="comment">//创建SrsLiveStream，每个SrsSource绑定一个</span></span><br><span class="line">        entry-&gt;stream = <span class="keyword">new</span> <span class="built_in">SrsLiveStream</span>(s, r, entry-&gt;cache);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> maybe refine the logic of http remux service.</span></span><br><span class="line">        <span class="comment">// if user push streams followed:</span></span><br><span class="line">        <span class="comment">//     rtmp://test.com/live/stream1</span></span><br><span class="line">        <span class="comment">//     rtmp://test.com/live/stream2</span></span><br><span class="line">        <span class="comment">// and they will using the same template, such as: [vhost]/[app]/[stream].flv</span></span><br><span class="line">        <span class="comment">// so, need to free last request object, otherwise, it will cause memory leak.</span></span><br><span class="line">        <span class="built_in">srs_freep</span>(tmpl-&gt;req);</span><br><span class="line">        </span><br><span class="line">        tmpl-&gt;source = s;</span><br><span class="line">        tmpl-&gt;req = r-&gt;<span class="built_in">copy</span>()-&gt;<span class="built_in">as_http</span>();</span><br><span class="line">        </span><br><span class="line">        sflvs[sid] = entry;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// mount the http flv stream.</span></span><br><span class="line">        <span class="comment">// we must register the handler, then start the thread,</span></span><br><span class="line">        <span class="comment">// for the thread will cause thread switch context.</span></span><br><span class="line">        <span class="comment">// @see https://github.com/ossrs/srs/issues/404</span></span><br><span class="line">        <span class="comment">//创建路由规则SrsHttpServeMux，mount：要匹配的路由</span></span><br><span class="line">        <span class="keyword">if</span> ((err = mux.<span class="built_in">handle</span>(mount, entry-&gt;stream)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;http: mount flv stream for vhost=%s failed&quot;</span>, sid.<span class="built_in">c_str</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// start http stream cache thread</span></span><br><span class="line">        <span class="keyword">if</span> ((err = entry-&gt;cache-&gt;<span class="built_in">start</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;http: start stream cache failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">srs_trace</span>(<span class="string">&quot;http: mount flv stream for sid=%s, mount=%s&quot;</span>, sid.<span class="built_in">c_str</span>(), mount.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        entry = sflvs[sid];</span><br><span class="line">        entry-&gt;stream-&gt;<span class="built_in">update</span>(s, r);</span><br><span class="line">        entry-&gt;cache-&gt;<span class="built_in">update</span>(s, r);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (entry-&gt;stream) &#123;</span><br><span class="line">        entry-&gt;stream-&gt;entry-&gt;enabled = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHttpServeMux::handle</code>是真正创建路由规则的函数。</li>
<li>参数<code>pattern</code>作为URL索引，参数<code>handler</code>是<code>SrsLiveStream</code>提供给拉流客户端访问。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpServeMux::handle</span><span class="params">(std::string pattern, ISrsHttpHandler* handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">srs_assert</span>(handler);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (pattern.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_HTTP_PATTERN_EMPTY, <span class="string">&quot;empty pattern&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (entries.<span class="built_in">find</span>(pattern) != entries.<span class="built_in">end</span>()) &#123;</span><br><span class="line">        SrsHttpMuxEntry* exists = entries[pattern];</span><br><span class="line">        <span class="keyword">if</span> (exists-&gt;explicit_match) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_HTTP_PATTERN_DUPLICATED, <span class="string">&quot;pattern=%s exists&quot;</span>, pattern.<span class="built_in">c_str</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    std::string vhost = pattern;</span><br><span class="line">    <span class="keyword">if</span> (pattern.<span class="built_in">at</span>(<span class="number">0</span>) != <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pattern.<span class="built_in">find</span>(<span class="string">&quot;/&quot;</span>) != string::npos) &#123;</span><br><span class="line">            vhost = pattern.<span class="built_in">substr</span>(<span class="number">0</span>, pattern.<span class="built_in">find</span>(<span class="string">&quot;/&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        vhosts[vhost] = handler;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">//创建路由</span></span><br><span class="line">        SrsHttpMuxEntry* entry = <span class="keyword">new</span> <span class="built_in">SrsHttpMuxEntry</span>();</span><br><span class="line">        entry-&gt;explicit_match = <span class="literal">true</span>;</span><br><span class="line">        entry-&gt;handler = handler;</span><br><span class="line">        entry-&gt;pattern = pattern;</span><br><span class="line">        entry-&gt;handler-&gt;entry = entry;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (entries.<span class="built_in">find</span>(pattern) != entries.<span class="built_in">end</span>()) &#123;</span><br><span class="line">            SrsHttpMuxEntry* exists = entries[pattern];</span><br><span class="line">            <span class="built_in">srs_freep</span>(exists);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//设置 patter:URL</span></span><br><span class="line">        entries[pattern] = entry;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Helpful behavior:</span></span><br><span class="line">    <span class="comment">// If pattern is /tree/, insert an implicit permanent redirect for /tree.</span></span><br><span class="line">    <span class="comment">// It can be overridden by an explicit registration.</span></span><br><span class="line">    <span class="keyword">if</span> (pattern != <span class="string">&quot;/&quot;</span> &amp;&amp; !pattern.<span class="built_in">empty</span>() &amp;&amp; pattern.<span class="built_in">at</span>(pattern.<span class="built_in">length</span>() - <span class="number">1</span>) == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">        std::string rpattern = pattern.<span class="built_in">substr</span>(<span class="number">0</span>, pattern.<span class="built_in">length</span>() - <span class="number">1</span>);</span><br><span class="line">        SrsHttpMuxEntry* entry = <span class="literal">NULL</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// free the exists implicit entry</span></span><br><span class="line">        <span class="keyword">if</span> (entries.<span class="built_in">find</span>(rpattern) != entries.<span class="built_in">end</span>()) &#123;</span><br><span class="line">            entry = entries[rpattern];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// create implicit redirect.</span></span><br><span class="line">        <span class="keyword">if</span> (!entry || !entry-&gt;explicit_match) &#123;</span><br><span class="line">            <span class="built_in">srs_freep</span>(entry);</span><br><span class="line">            </span><br><span class="line">            entry = <span class="keyword">new</span> <span class="built_in">SrsHttpMuxEntry</span>();</span><br><span class="line">            entry-&gt;explicit_match = <span class="literal">false</span>;</span><br><span class="line">            entry-&gt;handler = <span class="keyword">new</span> <span class="built_in">SrsHttpRedirectHandler</span>(pattern, SRS_CONSTS_HTTP_Found);</span><br><span class="line">            entry-&gt;pattern = pattern;</span><br><span class="line">            entry-&gt;handler-&gt;entry = entry;</span><br><span class="line">            </span><br><span class="line">            entries[rpattern] = entry;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> srs_success;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="拉流端"><a href="#拉流端" class="headerlink" title="拉流端"></a>拉流端</h3><p>拉流端根据URL查找对应的<code>ISrsHttpHandler</code>。</p>
<ul>
<li>断点<code>SrsHttpResponseWriter::write</code>，<code>SrsHttpResponseWriter</code>负责将数据发送给客户端。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#0 SrsHttpResponseWriter::write (this=0x7ffff7eb5bd0, data=0x7ffff7eb5470 &quot;FLV\001\005&quot;, size=9)</span><br><span class="line">   at src/service/srs_service_http_conn.cpp:727</span><br><span class="line">#1 0x00000000004fde19 in SrsBufferWriter::write (this=0x7ffff7eb5860, buf=0x7ffff7eb5470,</span><br><span class="line">   count=9, pnwrite=0x0) at src/app/srs_app_http_stream.cpp:506</span><br><span class="line">#2 0x000000000040e9e1 in SrsFlvTransmuxer::write_header (this=0xa71b10,</span><br><span class="line">   flv_header=0x7ffff7eb5470 &quot;FLV\001\005&quot;) at src/kernel/srs_kernel_flv.cpp:411</span><br><span class="line">#3 0x000000000040e90d in SrsFlvTransmuxer::write_header (this=0xa71b10, has_video=true, has_audio=true)</span><br><span class="line">   at src/kernel/srs_kernel_flv.cpp:399</span><br><span class="line">#4 0x00000000004fd11a in SrsFlvStreamEncoder::write_header (this=0xa68b10, has_video=true, has_audio=true)</span><br><span class="line">   at src/app/srs_app_http_stream.cpp:355</span><br><span class="line">#5 0x00000000004fd04f in SrsFlvStreamEncoder::write_tags (this=0xa68b10, msgs=0xa6da30, count=10)</span><br><span class="line">   at src/app/srs_app_http_stream.cpp:340</span><br><span class="line">#6 0x00000000004ff0dc in SrsLiveStream::do_serve_http (this=0xa3d9d0, w=0x7ffff7eb5bd0, r=0xa91c00)</span><br><span class="line">   at src/app/srs_app_http_stream.cpp:677</span><br><span class="line">#7 0x00000000004fe108 in SrsLiveStream::serve_http (this=0xa3d9d0, w=0x7ffff7eb5bd0, r=0xa91c00)</span><br><span class="line">   at src/app/srs_app_http_stream.cpp:544</span><br><span class="line">#8 0x000000000049c86f in SrsHttpServeMux::serve_http (this=0xa11fe0, w=0x7ffff7eb5bd0, r=0xa91c00)</span><br><span class="line">   at src/protocol/srs_http_stack.cpp:711</span><br><span class="line">#9 0x0000000000562080 in SrsHttpServer::serve_http (this=0xa11e00, w=0x7ffff7eb5bd0, r=0xa91c00)</span><br><span class="line">   at src/app/srs_app_http_conn.cpp:300 </span><br><span class="line">#10 0x000000000049d6be in SrsHttpCorsMux::serve_http (this=0xa3aa60, w=0x7ffff7eb5bd0, r=0xa91c00)</span><br><span class="line">    at src/protocol/srs_http_stack.cpp:859</span><br><span class="line">#11 0x0000000000561086 in SrsHttpConn::process_request (this=0xa626e0, w=0x7ffff7eb5bd0, r=0xa91c00)</span><br><span class="line">    at src/app/srs_app_http_conn.cpp:161</span><br><span class="line">#12 0x0000000000560ce8 in SrsHttpConn::do_cycle (this=0xa626e0) at src/app/srs_app_http_conn.cpp:133</span><br><span class="line">#13 0x00000000004d10fb in SrsConnection::cycle (this=0xa626e0) at src/app/srs_app_conn.cpp:171</span><br><span class="line">#14 0x0000000000509c88 in SrsSTCoroutine::cycle (this=0xa62a70) at src/app/srs_app_st.cpp:198</span><br><span class="line">#15 0x0000000000509cfd in SrsSTCoroutine::pfn (arg=0xa62a70) at src/app/srs_app_st.cpp:213</span><br><span class="line">#16 0x00000000005bdd9d in _st_thread_main () at sched.c:337</span><br><span class="line">#17 0x00000000005be515 in st_thread_create (start=0x5bd719 &lt;_st_vp_schedule+170&gt;,</span><br><span class="line">    arg=0x900000001, joinable=1, stk_size=1) at sched.c:616</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHttpConn::do_cycle</code>中初始化<code>cors-&gt;initialize</code>。</li>
<li><code>http_mux</code>是<code>SrsHttpServer</code> ，之后处理HTTP请求<code>process_request</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpConn::do_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// initialize parser</span></span><br><span class="line">    <span class="keyword">if</span> ((err = parser-&gt;<span class="built_in">initialize</span>(HTTP_REQUEST, <span class="literal">false</span>)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;init parser for %s&quot;</span>, ip.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// set the recv timeout, for some clients never disconnect the connection.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/398</span></span><br><span class="line">    skt-&gt;<span class="built_in">set_recv_timeout</span>(SRS_HTTP_RECV_TIMEOUT);</span><br><span class="line">    </span><br><span class="line">    SrsRequest* last_req = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsRequest, last_req);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// initialize the cors, which will proxy to mux.</span></span><br><span class="line">    <span class="type">bool</span> crossdomain_enabled = _srs_config-&gt;<span class="built_in">get_http_stream_crossdomain</span>();</span><br><span class="line">    <span class="keyword">if</span> ((err = cors-&gt;<span class="built_in">initialize</span>(http_mux, crossdomain_enabled)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;init cors&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// process http messages.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> req_id = <span class="number">0</span>; (err = trd-&gt;<span class="built_in">pull</span>()) == srs_success; req_id++) &#123;</span><br><span class="line">        <span class="comment">// Try to receive a message from http.</span></span><br><span class="line">        <span class="built_in">srs_trace</span>(<span class="string">&quot;HTTP client ip=%s, request=%d, to=%dms&quot;</span>, </span><br><span class="line">                  ip.<span class="built_in">c_str</span>(), req_id, <span class="built_in">srsu2ms</span>(SRS_HTTP_RECV_TIMEOUT));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// get a http message</span></span><br><span class="line">        ISrsHttpMessage* req = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = parser-&gt;<span class="built_in">parse_message</span>(skt, &amp;req)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// if SUCCESS, always NOT-NULL.</span></span><br><span class="line">        <span class="comment">// always free it in this scope.</span></span><br><span class="line">        <span class="built_in">srs_assert</span>(req);</span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(ISrsHttpMessage, req);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Attach owner connection to message.</span></span><br><span class="line">        SrsHttpMessage* hreq = (SrsHttpMessage*)req;</span><br><span class="line">        hreq-&gt;<span class="built_in">set_connection</span>(<span class="keyword">this</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// copy request to last request object.</span></span><br><span class="line">        <span class="built_in">srs_freep</span>(last_req);</span><br><span class="line">        last_req = hreq-&gt;<span class="built_in">to_request</span>(hreq-&gt;<span class="built_in">host</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// may should discard the body.</span></span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">on_got_http_message</span>(req)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ok, handle http request.</span></span><br><span class="line">        <span class="comment">//给客户端推数据SrsHttpResponseWriter</span></span><br><span class="line">        <span class="function">SrsHttpResponseWriter <span class="title">writer</span><span class="params">(skt)</span></span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">process_request</span>(&amp;writer, req)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// donot keep alive, disconnect it.</span></span><br><span class="line">        <span class="comment">// @see https://github.com/ossrs/srs/issues/399</span></span><br><span class="line">        <span class="keyword">if</span> (!req-&gt;<span class="built_in">is_keep_alive</span>()) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">srs_error_t</span> r0 = srs_success;</span><br><span class="line">    <span class="keyword">if</span> ((r0 = <span class="built_in">on_disconnect</span>(last_req)) != srs_success) &#123;</span><br><span class="line">        err = <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;on disconnect %s&quot;</span>, <span class="built_in">srs_error_desc</span>(r0).<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="built_in">srs_freep</span>(r0);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHttpConn::process_request</code>调用<code>SrsHttpCorsMux::serve_http</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpCorsMux::serve_http</span><span class="params">(ISrsHttpResponseWriter* w, ISrsHttpMessage* r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// If CORS enabled, and there is a &quot;Origin&quot; header, it&#x27;s CORS.</span></span><br><span class="line">    <span class="keyword">if</span> (enabled) &#123;</span><br><span class="line">        SrsHttpHeader* h = r-&gt;<span class="built_in">header</span>();</span><br><span class="line">        required = !h-&gt;<span class="built_in">get</span>(<span class="string">&quot;Origin&quot;</span>).<span class="built_in">empty</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// When CORS required, set the CORS headers.</span></span><br><span class="line">    <span class="keyword">if</span> (required) &#123;</span><br><span class="line">        SrsHttpHeader* h = w-&gt;<span class="built_in">header</span>();</span><br><span class="line">        h-&gt;<span class="built_in">set</span>(<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>, <span class="string">&quot;*&quot;</span>);</span><br><span class="line">        h-&gt;<span class="built_in">set</span>(<span class="string">&quot;Access-Control-Allow-Methods&quot;</span>, <span class="string">&quot;GET, POST, HEAD, PUT, DELETE, OPTIONS&quot;</span>);</span><br><span class="line">        h-&gt;<span class="built_in">set</span>(<span class="string">&quot;Access-Control-Expose-Headers&quot;</span>, <span class="string">&quot;Server,range,Content-Length,Content-Range&quot;</span>);</span><br><span class="line">        h-&gt;<span class="built_in">set</span>(<span class="string">&quot;Access-Control-Allow-Headers&quot;</span>, <span class="string">&quot;origin,range,accept-encoding,referer,Cache-Control,X-Proxy-Authorization,X-Requested-With,Content-Type&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// handle the http options.</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;<span class="built_in">is_http_options</span>()) &#123;</span><br><span class="line">        w-&gt;<span class="built_in">header</span>()-&gt;<span class="built_in">set_content_length</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (enabled) &#123;</span><br><span class="line">            w-&gt;<span class="built_in">write_header</span>(SRS_CONSTS_HTTP_OK);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            w-&gt;<span class="built_in">write_header</span>(SRS_CONSTS_HTTP_MethodNotAllowed);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> w-&gt;<span class="built_in">final_request</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_assert</span>(next);</span><br><span class="line">    <span class="keyword">return</span> next-&gt;<span class="built_in">serve_http</span>(w, r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>推流的时候通过<code>mux.handle</code>创建路由规则。</li>
<li>拉流的时候通过<code>http_stream-&gt;mux.find_handler</code>查找路由。</li>
<li>创建的时候根据<code>http_remux</code>配置，例如&#x2F;live&#x2F;test.flv，拉流查找的时候找到对应的才能播放。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpServer::serve_http</span><span class="params">(ISrsHttpResponseWriter* w, ISrsHttpMessage* r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// try http stream first.</span></span><br><span class="line">    ISrsHttpHandler* h = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//查找路由</span></span><br><span class="line">    <span class="keyword">if</span> ((err = http_stream-&gt;mux.<span class="built_in">find_handler</span>(r, &amp;h)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;find handler&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!h-&gt;<span class="built_in">is_not_found</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> http_stream-&gt;mux.<span class="built_in">serve_http</span>(w, r);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> http_static-&gt;mux.<span class="built_in">serve_http</span>(w, r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>匹配<code>entry-&gt;pattern</code>后缀，获取音视频数据<code>source-&gt;create_consumer</code>。</li>
<li>如果是FLV格式<code>ffe-&gt;write_tags</code>写数据，具体里面包含<code>write_header</code>和<code>write_tags</code>，具体参考FLV格式。</li>
<li>最终通过<code>SrsHttpResponseWriter::writev</code>响应客户端。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsLiveStream::do_serve_http</span><span class="params">(ISrsHttpResponseWriter* w, ISrsHttpMessage* r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    string enc_desc;</span><br><span class="line">    ISrsBufferEncoder* enc = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_assert</span>(entry);</span><br><span class="line">    <span class="comment">//匹配后缀</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">srs_string_ends_with</span>(entry-&gt;pattern, <span class="string">&quot;.flv&quot;</span>)) &#123;</span><br><span class="line">        w-&gt;<span class="built_in">header</span>()-&gt;<span class="built_in">set_content_type</span>(<span class="string">&quot;video/x-flv&quot;</span>);</span><br><span class="line">        enc_desc = <span class="string">&quot;FLV&quot;</span>;</span><br><span class="line">        <span class="comment">//FLV Encoder</span></span><br><span class="line">        enc = <span class="keyword">new</span> <span class="built_in">SrsFlvStreamEncoder</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">srs_string_ends_with</span>(entry-&gt;pattern, <span class="string">&quot;.aac&quot;</span>)) &#123;</span><br><span class="line">        w-&gt;<span class="built_in">header</span>()-&gt;<span class="built_in">set_content_type</span>(<span class="string">&quot;audio/x-aac&quot;</span>);</span><br><span class="line">        enc_desc = <span class="string">&quot;AAC&quot;</span>;</span><br><span class="line">        enc = <span class="keyword">new</span> <span class="built_in">SrsAacStreamEncoder</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">srs_string_ends_with</span>(entry-&gt;pattern, <span class="string">&quot;.mp3&quot;</span>)) &#123;</span><br><span class="line">        w-&gt;<span class="built_in">header</span>()-&gt;<span class="built_in">set_content_type</span>(<span class="string">&quot;audio/mpeg&quot;</span>);</span><br><span class="line">        enc_desc = <span class="string">&quot;MP3&quot;</span>;</span><br><span class="line">        enc = <span class="keyword">new</span> <span class="built_in">SrsMp3StreamEncoder</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">srs_string_ends_with</span>(entry-&gt;pattern, <span class="string">&quot;.ts&quot;</span>)) &#123;</span><br><span class="line">        w-&gt;<span class="built_in">header</span>()-&gt;<span class="built_in">set_content_type</span>(<span class="string">&quot;video/MP2T&quot;</span>);</span><br><span class="line">        enc_desc = <span class="string">&quot;TS&quot;</span>;</span><br><span class="line">        enc = <span class="keyword">new</span> <span class="built_in">SrsTsStreamEncoder</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_HTTP_LIVE_STREAM_EXT, <span class="string">&quot;invalid pattern=%s&quot;</span>, entry-&gt;pattern.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(ISrsBufferEncoder, enc);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Enter chunked mode, because we didn&#x27;t set the content-length.</span></span><br><span class="line">    w-&gt;<span class="built_in">write_header</span>(SRS_CONSTS_HTTP_OK);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// create consumer of souce, ignore gop cache, use the audio gop cache.</span></span><br><span class="line">    SrsConsumer* consumer = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">create_consumer</span>(<span class="literal">NULL</span>, consumer, <span class="literal">true</span>, <span class="literal">true</span>, !enc-&gt;<span class="built_in">has_cache</span>())) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;create consumer&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsConsumer, consumer);</span><br><span class="line">    <span class="built_in">srs_verbose</span>(<span class="string">&quot;http: consumer created success.&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    SrsPithyPrint* pprint = SrsPithyPrint::<span class="built_in">create_http_stream</span>();</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsPithyPrint, pprint);</span><br><span class="line">    </span><br><span class="line">    <span class="function">SrsMessageArray <span class="title">msgs</span><span class="params">(SRS_PERF_MW_MSGS)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use receive thread to accept the close event to avoid FD leak.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/636#issuecomment-298208427</span></span><br><span class="line">    SrsHttpMessage* hr = <span class="built_in">dynamic_cast</span>&lt;SrsHttpMessage*&gt;(r);</span><br><span class="line">    SrsResponseOnlyHttpConn* hc = <span class="built_in">dynamic_cast</span>&lt;SrsResponseOnlyHttpConn*&gt;(hr-&gt;<span class="built_in">connection</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// update the statistic when source disconveried.</span></span><br><span class="line">    SrsStatistic* stat = SrsStatistic::<span class="built_in">instance</span>();</span><br><span class="line">    <span class="keyword">if</span> ((err = stat-&gt;<span class="built_in">on_client</span>(_srs_context-&gt;<span class="built_in">get_id</span>(), req, hc, SrsRtmpConnPlay)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;stat on client&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// the memory writer.</span></span><br><span class="line">    <span class="function">SrsBufferWriter <span class="title">writer</span><span class="params">(w)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> ((err = enc-&gt;<span class="built_in">initialize</span>(&amp;writer, cache)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;init encoder&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if gop cache enabled for encoder, dump to consumer.</span></span><br><span class="line">    <span class="keyword">if</span> (enc-&gt;<span class="built_in">has_cache</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = enc-&gt;<span class="built_in">dump_cache</span>(consumer, source-&gt;<span class="built_in">jitter</span>())) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;encoder dump cache&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    SrsFlvStreamEncoder* ffe = <span class="built_in">dynamic_cast</span>&lt;SrsFlvStreamEncoder*&gt;(enc);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Set the socket options for transport.</span></span><br><span class="line">    <span class="type">bool</span> tcp_nodelay = _srs_config-&gt;<span class="built_in">get_tcp_nodelay</span>(req-&gt;vhost);</span><br><span class="line">    <span class="keyword">if</span> (tcp_nodelay) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = hc-&gt;<span class="built_in">set_tcp_nodelay</span>(tcp_nodelay)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;set tcp nodelay&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">srs_utime_t</span> mw_sleep = _srs_config-&gt;<span class="built_in">get_mw_sleep</span>(req-&gt;vhost);</span><br><span class="line">    <span class="keyword">if</span> ((err = hc-&gt;<span class="built_in">set_socket_buffer</span>(mw_sleep)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;set mw_sleep %&quot;</span> PRId64, mw_sleep);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//读取客户端数据，直接丢弃了</span></span><br><span class="line">    SrsHttpRecvThread* trd = <span class="keyword">new</span> <span class="built_in">SrsHttpRecvThread</span>(hc);</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsHttpRecvThread, trd);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">start</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;start recv thread&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;FLV %s, encoder=%s, nodelay=%d, mw_sleep=%dms, cache=%d, msgs=%d&quot;</span>,</span><br><span class="line">        entry-&gt;pattern.<span class="built_in">c_str</span>(), enc_desc.<span class="built_in">c_str</span>(), tcp_nodelay, <span class="built_in">srsu2msi</span>(mw_sleep),</span><br><span class="line">        enc-&gt;<span class="built_in">has_cache</span>(), msgs.max);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> free and erase the disabled entry after all related connections is closed.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> FXIME: Support timeout for player, quit infinite-loop.</span></span><br><span class="line">    <span class="keyword">while</span> (entry-&gt;enabled) &#123;</span><br><span class="line">        <span class="comment">// Whether client closed the FD.</span></span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pprint-&gt;<span class="built_in">elapse</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// get messages from consumer.</span></span><br><span class="line">        <span class="comment">// each msg in msgs.msgs must be free, for the SrsMessageArray never free them.</span></span><br><span class="line">        <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = consumer-&gt;<span class="built_in">dump_packets</span>(&amp;msgs, count)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;consumer dump packets&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Directly use sleep, donot use consumer wait, because we couldn&#x27;t awake consumer.</span></span><br><span class="line">            <span class="built_in">srs_usleep</span>(mw_sleep);</span><br><span class="line">            <span class="comment">// ignore when nothing got.</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (pprint-&gt;<span class="built_in">can_print</span>()) &#123;</span><br><span class="line">            <span class="built_in">srs_trace</span>(<span class="string">&quot;-&gt; &quot;</span> SRS_CONSTS_LOG_HTTP_STREAM <span class="string">&quot; http: got %d msgs, age=%d, min=%d, mw=%d&quot;</span>,</span><br><span class="line">                count, pprint-&gt;<span class="built_in">age</span>(), SRS_PERF_MW_MIN_MSGS, <span class="built_in">srsu2msi</span>(mw_sleep));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// sendout all messages.</span></span><br><span class="line">        <span class="keyword">if</span> (ffe) &#123;</span><br><span class="line">            err = ffe-&gt;<span class="built_in">write_tags</span>(msgs.msgs, count);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            err = <span class="built_in">streaming_send_messages</span>(enc, msgs.msgs, count);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// free the messages.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            SrsSharedPtrMessage* msg = msgs.msgs[i];</span><br><span class="line">            <span class="built_in">srs_freep</span>(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// check send error code.</span></span><br><span class="line">        <span class="keyword">if</span> (err != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send messages&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Here, the entry is disabled by encoder un-publishing or reloading,</span></span><br><span class="line">    <span class="comment">// so we must return a io.EOF error to disconnect the client, or the client will never quit.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_HTTP_STREAM_EOF, <span class="string">&quot;Stream EOF&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHttpRecvThread</code>协程读取客户端数据<code>conn-&gt;pop_message</code>直接丢弃。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpRecvThread::cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> ((err = trd-&gt;<span class="built_in">pull</span>()) == srs_success) &#123;</span><br><span class="line">        ISrsHttpMessage* req = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(ISrsHttpMessage, req);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = conn-&gt;<span class="built_in">pop_message</span>(&amp;req)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;pop message&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsFlvStreamEncoder::write_tags</code>对FLV格式封装。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsFlvStreamEncoder::write_tags</span><span class="params">(SrsSharedPtrMessage** msgs, <span class="type">int</span> count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// For https://github.com/ossrs/srs/issues/939</span></span><br><span class="line">    <span class="keyword">if</span> (!header_written) &#123;</span><br><span class="line">        <span class="type">bool</span> has_video = <span class="literal">false</span>;</span><br><span class="line">        <span class="type">bool</span> has_audio = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count &amp;&amp; (!has_video || !has_audio); i++) &#123;</span><br><span class="line">            SrsSharedPtrMessage* msg = msgs[i];</span><br><span class="line">            <span class="keyword">if</span> (msg-&gt;<span class="built_in">is_video</span>()) &#123;</span><br><span class="line">                has_video = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (msg-&gt;<span class="built_in">is_audio</span>()) &#123;</span><br><span class="line">                has_audio = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Drop data if no A+V.</span></span><br><span class="line">        <span class="keyword">if</span> (!has_video &amp;&amp; !has_audio) &#123;</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">write_header</span>(has_video, has_audio))  != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;write header&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> enc-&gt;<span class="built_in">write_tags</span>(msgs, count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/09/30/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BRTMP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/09/30/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BRTMP/" class="post-title-link" itemprop="url">SRS流媒体服务器之RTMP</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-30 13:02:25" itemprop="dateCreated datePublished" datetime="2023-09-30T13:02:25+08:00">2023-09-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-12-30 22:37:25" itemprop="dateModified" datetime="2023-12-30T22:37:25+08:00">2023-12-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SRS/" itemprop="url" rel="index"><span itemprop="name">SRS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="RTMP推拉流"><a href="#RTMP推拉流" class="headerlink" title="RTMP推拉流"></a>RTMP推拉流</h1><ul>
<li><p>创建监听套接字</p>
<ul>
<li>RTMP创建监听套接字<code>SrsServer::listen_rtmp</code>。</li>
<li>启动协程<code>SrsSTCoroutine::start</code>，每个监听对应一个协程。</li>
<li>协程函数<code>SrsTcpListener::cycle</code>。</li>
</ul>
</li>
<li><p>处理客户端连接</p>
<ul>
<li><p>检测获取客户端连接<code>srs_accept</code>，如果有连接则调用<code>handler-&gt;on_tcp_client</code>。</p>
</li>
<li><p>客户端连接具体实现<code>accept_client</code>，其中<code>fd2conn</code>函数中创建<code>SrsRtmpConn</code>并且绑定连接套接字和连接上下文，之后启动协程<code>conn-&gt;start</code>，每个连接对应一个协程。</p>
</li>
<li><p>协程函数在<code>SrsRtmpConn::do_cycle()</code>中具体实现。</p>
</li>
<li><p>进入 <code>SrsRtmpConn::do_cycle</code>后其中<code>stream_service_cycle</code>里面还分为发布和推流不同分支。</p>
</li>
<li><p>创建或查找<code>SrsSource</code>，一个推流源对应一个<code>SrsSourcce</code>。</p>
</li>
</ul>
</li>
<li><p>推流端</p>
<ul>
<li>每个推流端都会创建一个<code>SrsPublishRecvThread</code>，用来接收数据和推送数据到队列给拉流端使用。</li>
<li>RTMP接收数据<code>rtmp-&gt;recv_message</code>，并且调用<code>pumper-&gt;consume(msg)</code>将处理消息，处理后的消息<code>SrsCommonMessage</code>会推送给<code>SrsComsumer</code>。</li>
</ul>
</li>
<li><p>拉流端</p>
<ul>
<li>每个拉流端都会创建一个<code>SrsQueueRecvThread</code>，用来处理拉流端控制消息，注意和⾳视频消息没有关系。</li>
<li>同时会创建<code>SrsComsumer</code>，<code>SrsSource</code>会将数据通过队列推送过来，之后进行数据处理发送给客户端。</li>
</ul>
</li>
<li><p>核心类</p>
<ul>
<li><code>SrsServer</code>：SRS流媒体服务⼊⼝。</li>
<li><code>SrsBufferListener</code>：监听器，主要是TCP的监听。</li>
<li><code>SrsTcpListener</code>：TCP监听器。</li>
<li><code>SrsRtmpConn</code>：RTMP连接，⾥⾯对应了SrsStSocket和SrsCoroutine。</li>
<li><code>SrsRtmpServer</code>：提供与客户端之间的RTMP-命令-协议-消息的交互服务，使⽤SrsRtmpConn 提供的socket读写数据。</li>
<li><code>SrsSource</code>：描述⼀路播放源，包括推流和拉流的描述。</li>
<li><code>SrsConsumer</code>：拉流消费者，每⼀路拉流客户端对应⼀个SrsConsumer。</li>
<li><code>SrsStSocket</code>：经过封装的socket接⼝。</li>
</ul>
</li>
</ul>
<h2 id="创建监听套接字"><a href="#创建监听套接字" class="headerlink" title="创建监听套接字"></a>创建监听套接字</h2><ul>
<li>RTMP创建监听套接字，并且启动协程。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsServer::listen_rtmp</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// stream service port.</span></span><br><span class="line">    std::vector&lt;std::string&gt; ip_ports = _srs_config-&gt;<span class="built_in">get_listens</span>();</span><br><span class="line">    <span class="built_in">srs_assert</span>((<span class="type">int</span>)ip_ports.<span class="built_in">size</span>() &gt; <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">close_listeners</span>(SrsListenerRtmpStream);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; (<span class="type">int</span>)ip_ports.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        SrsListener* listener = <span class="keyword">new</span> <span class="built_in">SrsBufferListener</span>(<span class="keyword">this</span>, SrsListenerRtmpStream);</span><br><span class="line">        listeners.<span class="built_in">push_back</span>(listener);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> port; string ip;</span><br><span class="line">        <span class="built_in">srs_parse_endpoint</span>(ip_ports[i], ip, port);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//这里调用SrsTcpListener::listen()</span></span><br><span class="line">        <span class="comment">//1.内部创建TCP Socket，bind，listen </span></span><br><span class="line">        <span class="comment">//2.创建SrsSTCoroutine并且执行start() 启动协程</span></span><br><span class="line">        <span class="keyword">if</span> ((err = listener-&gt;<span class="built_in">listen</span>(ip, port)) != srs_success) &#123;</span><br><span class="line">            <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp listen %s:%d&quot;</span>, ip.<span class="built_in">c_str</span>(), port);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>上述启动协程会调用<code>SrsSTCoroutine::start()</code>函数，主要会调用<code>ISrsCoroutineHandler::cycle()</code>函数，该函数子类<code>SrsTcpListener</code>会重写，具体看下面。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsSTCoroutine::start</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//_ST_THREAD_CREATE_PFN _pfn_st_thread_create = (_ST_THREAD_CREATE_PFN)st_thread_create;</span></span><br><span class="line">    <span class="comment">//pfn回调内部调用了cycle()</span></span><br><span class="line">    <span class="keyword">if</span> ((trd = (<span class="type">srs_thread_t</span>)_pfn_st_thread_create(pfn, <span class="keyword">this</span>, <span class="number">1</span>, <span class="number">0</span>)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        err = <span class="built_in">srs_error_new</span>(ERROR_ST_CREATE_CYCLE_THREAD, <span class="string">&quot;create failed&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">srs_freep</span>(trd_err);</span><br><span class="line">        trd_err = <span class="built_in">srs_error_copy</span>(err);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//pfn内部调用了p-&gt;cycle()</span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">SrsSTCoroutine::pfn</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SrsSTCoroutine* p = (SrsSTCoroutine*)arg;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里跟进去调用ISrsCoroutineHandler::cycle()</span></span><br><span class="line">    <span class="comment">//ISrsCoroutineHandler是个接口类</span></span><br><span class="line">    <span class="type">srs_error_t</span> err = p-&gt;<span class="built_in">cycle</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the err for function pull to fetch it.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/pull/1304#issuecomment-480484151</span></span><br><span class="line">    <span class="keyword">if</span> (err != srs_success) &#123;</span><br><span class="line">        <span class="built_in">srs_freep</span>(p-&gt;trd_err);</span><br><span class="line">        <span class="comment">// It&#x27;s ok to directly use it, because it&#x27;s returned by st_thread_join.</span></span><br><span class="line">        p-&gt;trd_err = err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="type">void</span>*)err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>ISrsCoroutineHandler</code>接口。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ISrsCoroutineHandler</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ISrsCoroutineHandler</span>();</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">ISrsCoroutineHandler</span>();</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// Do the work. The ST-coroutine will terminated normally if it returned.</span></span><br><span class="line">    <span class="comment">// @remark If the cycle has its own loop, it must check the thread pull.</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">srs_error_t</span> <span class="title">cycle</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsTcpListener::cycle()</code></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsTcpListener::cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;tcp listener&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//检测获取客户端连接Socket</span></span><br><span class="line">        <span class="type">srs_netfd_t</span> fd = <span class="built_in">srs_accept</span>(lfd, <span class="literal">NULL</span>, <span class="literal">NULL</span>, SRS_UTIME_NO_TIMEOUT);</span><br><span class="line">        <span class="keyword">if</span>(fd == <span class="literal">NULL</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_SOCKET_ACCEPT, <span class="string">&quot;accept at fd=%d&quot;</span>, <span class="built_in">srs_netfd_fileno</span>(lfd));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">	    <span class="keyword">if</span> ((err = <span class="built_in">srs_fd_closeexec</span>(<span class="built_in">srs_netfd_fileno</span>(fd))) != srs_success) &#123;</span><br><span class="line">	        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;set closeexec&quot;</span>);</span><br><span class="line">	    &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//处理新的客户端连接，内部调用SrsServer::accept_client()</span></span><br><span class="line">        <span class="keyword">if</span> ((err = handler-&gt;<span class="built_in">on_tcp_client</span>(fd)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;handle fd=%d&quot;</span>, <span class="built_in">srs_netfd_fileno</span>(fd));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="处理客户端连接"><a href="#处理客户端连接" class="headerlink" title="处理客户端连接"></a>处理客户端连接</h2><ul>
<li><code>fd2conn</code>创建一个<code>SrsRtmpConn</code>并且会绑定连接套接字，其中<code>SrsRtmpConn</code>对应一个<code>SrsRtmpServer</code>，内部也会创建一个协程。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsServer::accept_client</span><span class="params">(SrsListenerType type, <span class="type">srs_netfd_t</span> stfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    SrsConnection* conn = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//绑定Socket和conn，根据不同StreamType创建conn</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    if (type == SrsListenerRtmpStream) &#123;</span></span><br><span class="line"><span class="comment">        *pconn = new SrsRtmpConn(this, stfd, ip);</span></span><br><span class="line"><span class="comment">    &#125; else if (type == SrsListenerHttpApi) &#123;</span></span><br><span class="line"><span class="comment">        *pconn = new SrsHttpApi(this, stfd, http_api_mux, ip);</span></span><br><span class="line"><span class="comment">    &#125; else if (type == SrsListenerHttpStream) &#123;</span></span><br><span class="line"><span class="comment">        *pconn = new SrsResponseOnlyHttpConn(this, stfd, http_server, ip);</span></span><br><span class="line"><span class="comment">    &#125; else &#123;</span></span><br><span class="line"><span class="comment">        srs_warn(&quot;close for no service handler. fd=%d, ip=%s&quot;, fd, ip.c_str());</span></span><br><span class="line"><span class="comment">        srs_close_stfd(stfd);</span></span><br><span class="line"><span class="comment">        return err;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">fd2conn</span>(type, stfd, &amp;conn)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">srs_error_code</span>(err) == ERROR_SOCKET_GET_PEER_IP &amp;&amp; _srs_config-&gt;<span class="built_in">empty_ip_ok</span>()) &#123;</span><br><span class="line">            <span class="built_in">srs_close_stfd</span>(stfd); <span class="built_in">srs_error_reset</span>(err);</span><br><span class="line">            <span class="keyword">return</span> srs_success;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;fd2conn&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">srs_assert</span>(conn);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// directly enqueue, the cycle thread will remove the client.</span></span><br><span class="line">    conns.<span class="built_in">push_back</span>(conn);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cycle will start process thread and when finished remove the client.</span></span><br><span class="line">    <span class="comment">// @remark never use the conn, for it maybe destroyed.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = conn-&gt;<span class="built_in">start</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;start conn coroutine&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>conn-&gt;start()</code>会创建一个协程处理与客户端的连接交互，RTMP在<code>SrsRtmpConn::do_cycle()</code>中具体实现。其中<code>service_cycle</code>继续调用<code>stream_service_cycle</code>里面还分为发布和推流不同分支。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::do_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//握手</span></span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">handshake</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp handshake&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">connect_app</span>(req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp connect tcUrl&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">service_cycle</span>()) != srs_success) &#123;</span><br><span class="line">        err = <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;service cycle&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">srs_error_t</span> r0 = srs_success;</span><br><span class="line">    <span class="keyword">if</span> ((r0 = <span class="built_in">on_disconnect</span>()) != srs_success) &#123;</span><br><span class="line">        err = <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;on disconnect %s&quot;</span>, <span class="built_in">srs_error_desc</span>(r0).<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="built_in">srs_freep</span>(r0);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// If client is redirect to other servers, we already logged the event.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">srs_error_code</span>(err) == ERROR_CONTROL_REDIRECT) &#123;</span><br><span class="line">        <span class="built_in">srs_error_reset</span>(err);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>stream_service_cycle</code>主要创建或查找一个<code>SrsSource</code>，并且处理<code>publishing</code>或<code>playing</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::stream_service_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    </span><br><span class="line">   	<span class="comment">// find a source to serve.</span></span><br><span class="line">    SrsSource* source = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> ((err = _srs_sources-&gt;<span class="built_in">fetch_or_create</span>(req, server, &amp;source)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: fetch source&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (info-&gt;type) &#123;</span><br><span class="line">        <span class="keyword">case</span> SrsRtmpConnPlay: &#123;</span><br><span class="line">            <span class="comment">// response connection start play</span></span><br><span class="line">            <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">start_play</span>(info-&gt;res-&gt;stream_id)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: start play&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((err = <span class="built_in">http_hooks_on_play</span>()) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: callback on play&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            err = <span class="built_in">playing</span>(source);</span><br><span class="line">            <span class="built_in">http_hooks_on_stop</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> SrsRtmpConnFMLEPublish: &#123;</span><br><span class="line">            <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">start_fmle_publish</span>(info-&gt;res-&gt;stream_id)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: start FMLE publish&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">publishing</span>(source);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_SYSTEM_CLIENT_INVALID, <span class="string">&quot;rtmp: unknown client type=%d&quot;</span>, info-&gt;type);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="推流端"><a href="#推流端" class="headerlink" title="推流端"></a>推流端</h2><ul>
<li><code>SrsPublishRecvThread</code>内部封装了协程，具体看下<code>do_publishing</code>中<code>SrsPublishRecvThread::start()</code>，继续进入<code>SrsRecvThread::start()</code>，最后到<code>SrsRecvThread::do_cycle()</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::publishing</span><span class="params">(SrsSource* source)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> Should refine the state of publishing.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">acquire_publish</span>(source)) == srs_success) &#123;</span><br><span class="line">        <span class="comment">// use isolate thread to recv,</span></span><br><span class="line">        <span class="comment">// @see: https://github.com/ossrs/srs/issues/237</span></span><br><span class="line">        <span class="function">SrsPublishRecvThread <span class="title">rtrd</span><span class="params">(rtmp, req, </span></span></span><br><span class="line"><span class="params"><span class="function">                                  srs_netfd_fileno(stfd), </span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="number">0</span>, <span class="keyword">this</span>, source, </span></span></span><br><span class="line"><span class="params"><span class="function">                                  _srs_context-&gt;get_id())</span></span>;</span><br><span class="line">        err = <span class="built_in">do_publishing</span>(source, &amp;rtrd);</span><br><span class="line">        rtrd.<span class="built_in">stop</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsRecvThread::do_cycle</code>中主要看到RTMP接收数据<code>rtmp-&gt;recv_message</code>，并且调用<code>pumper-&gt;consume(msg)</code>将处理消息。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRecvThread::do_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When the pumper is interrupted, wait then retry.</span></span><br><span class="line">        <span class="keyword">if</span> (pumper-&gt;<span class="built_in">interrupted</span>()) &#123;</span><br><span class="line">            <span class="built_in">srs_usleep</span>(timeout);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        SrsCommonMessage* msg = <span class="literal">NULL</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Process the received message.</span></span><br><span class="line">        <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">recv_message</span>(&amp;msg)) == srs_success) &#123;</span><br><span class="line">            err = pumper-&gt;<span class="built_in">consume</span>(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (err != srs_success) &#123;</span><br><span class="line">            <span class="comment">// Interrupt the receive thread for any error.</span></span><br><span class="line">            trd-&gt;<span class="built_in">interrupt</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Notify the pumper to quit for error.</span></span><br><span class="line">            pumper-&gt;<span class="built_in">interrupt</span>(err);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsRtmpServer::recv_message</code>调用<code>protocol-&gt;recv_message(pmsg)</code>处理。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsProtocol::recv_message</span><span class="params">(SrsCommonMessage** pmsg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *pmsg = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsCommonMessage* msg = <span class="literal">NULL</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">recv_interlaced_message</span>(&amp;msg)) != srs_success) &#123;</span><br><span class="line">            <span class="built_in">srs_freep</span>(msg);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv interlaced message&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!msg) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (msg-&gt;size &lt;= <span class="number">0</span> || msg-&gt;header.payload_length &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">srs_trace</span>(<span class="string">&quot;ignore empty message(type=%d, size=%d, time=%&quot;</span> PRId64 <span class="string">&quot;, sid=%d).&quot;</span>,</span><br><span class="line">                      msg-&gt;header.message_type, msg-&gt;header.payload_length,</span><br><span class="line">                      msg-&gt;header.timestamp, msg-&gt;header.stream_id);</span><br><span class="line">            <span class="built_in">srs_freep</span>(msg);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">on_recv_message</span>(msg)) != srs_success) &#123;</span><br><span class="line">            <span class="built_in">srs_freep</span>(msg);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;on recv message&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        *pmsg = msg;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>consume</code>消息处理。</li>
</ul>
<pre class="mermaid">graph TB
    F1[SrsPublishRecvThread::consume]-->F2[SrsRtmpConn::handle_publish_message]
    F2-->F3[SrsRtmpConn::process_publish_message]
    F3-->F3_1[SrsSource::on_audio]
    F3-->F3_2[SrsSource::on_video]
    F3-->F3_3[SrsSource::on_meta_data]
    F3_1-->F3_1_1[SrsSource::on_audio_imp]
    F3_1_1-->F3_1_1_1[SrsMetaCache::update_ash]
    F3_1_1-->F3_1_1_2[SrsConsumer::enqueue]</pre>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsPublishRecvThread::consume</span><span class="params">(SrsCommonMessage* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    err = _conn-&gt;<span class="built_in">handle_publish_message</span>(_source, msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>handle_publish_message</code>调用<code>process_publish_message</code></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::process_publish_message</span><span class="params">(SrsSource* source, SrsCommonMessage* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// process audio packet</span></span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;header.<span class="built_in">is_audio</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">on_audio</span>(msg)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: consume audio&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// process video packet</span></span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;header.<span class="built_in">is_video</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">on_video</span>(msg)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: consume video&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// process aggregate packet</span></span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;header.<span class="built_in">is_aggregate</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">on_aggregate</span>(msg)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: consume aggregate&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// process onMetaData</span></span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;header.<span class="built_in">is_amf0_data</span>() || msg-&gt;header.<span class="built_in">is_amf3_data</span>()) &#123;</span><br><span class="line">        SrsPacket* pkt = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">decode_message</span>(msg, &amp;pkt)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: decode message&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(SrsPacket, pkt);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">dynamic_cast</span>&lt;SrsOnMetaDataPacket*&gt;(pkt)) &#123;</span><br><span class="line">            SrsOnMetaDataPacket* metadata = <span class="built_in">dynamic_cast</span>&lt;SrsOnMetaDataPacket*&gt;(pkt);</span><br><span class="line">            <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">on_meta_data</span>(msg, metadata)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: consume metadata&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>跟踪音频流<code>source-&gt;on_audio</code>处理音频包，最终会调到<code>on_audio_imp</code>，将消息<code>SrsCommonMessage</code>推送到<code>SrsConsumer</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsSource::on_audio_imp</span><span class="params">(SrsSharedPtrMessage* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// copy to all consumer</span></span><br><span class="line">    <span class="keyword">if</span> (!drop_for_reduce) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; (<span class="type">int</span>)consumers.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            SrsConsumer* consumer = consumers.<span class="built_in">at</span>(i);</span><br><span class="line">            <span class="keyword">if</span> ((err = consumer-&gt;<span class="built_in">enqueue</span>(msg, atc, jitter_algorithm)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;consume message&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Copy to hub to all utilities.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = hub-&gt;<span class="built_in">on_audio</span>(msg)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;consume audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cache the sequence header of aac, or first packet of mp3.</span></span><br><span class="line">    <span class="comment">// for example, the mp3 is used for hls to write the &quot;right&quot; audio codec.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> to refine the stream info system.</span></span><br><span class="line">    <span class="comment">//保存sequence header</span></span><br><span class="line">    <span class="keyword">if</span> (is_aac_sequence_header || !meta-&gt;<span class="built_in">ash</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = meta-&gt;<span class="built_in">update_ash</span>(msg)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;meta consume audio&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// when sequence header, donot push to gop cache and adjust the timestamp.</span></span><br><span class="line">    <span class="keyword">if</span> (is_sequence_header) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cache the last gop packets</span></span><br><span class="line">    <span class="comment">//gop 缓存减少延迟</span></span><br><span class="line">    <span class="keyword">if</span> ((err = gop_cache-&gt;<span class="built_in">cache</span>(msg)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;gop cache consume audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="拉流端"><a href="#拉流端" class="headerlink" title="拉流端"></a>拉流端</h2><ul>
<li>控制相关。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpServer::start_play</span><span class="params">(<span class="type">int</span> stream_id)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>看到<code>source-&gt;create_consumer</code>创建消费者，推流端<code>SrsSource::on_audio_imp</code>中有消息将会推送<code>consumer-&gt;enqueue</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::playing</span><span class="params">(SrsSource* source)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// SrsSource的消费者，每个拉流端都会绑定一个SrsConsumer</span></span><br><span class="line">    <span class="comment">// Create a consumer of source.</span></span><br><span class="line">    SrsConsumer* consumer = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">create_consumer</span>(<span class="keyword">this</span>, consumer)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: create consumer&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsConsumer, consumer);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Use receiving thread to receive packets from peer.</span></span><br><span class="line">    <span class="comment">// @see: https://github.com/ossrs/srs/issues/217</span></span><br><span class="line">    <span class="comment">//接收消息的线程是每个SrsRtmpConn是独立的</span></span><br><span class="line">    <span class="function">SrsQueueRecvThread <span class="title">trd</span><span class="params">(consumer, rtmp, SRS_PERF_MW_SLEEP, _srs_context-&gt;get_id())</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = trd.<span class="built_in">start</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: start receive thread&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Deliver packets to peer.</span></span><br><span class="line">    wakable = consumer;</span><br><span class="line">    err = <span class="built_in">do_playing</span>(source, consumer, &amp;trd);</span><br><span class="line">    wakable = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    trd.<span class="built_in">stop</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Drop all packets in receiving thread.</span></span><br><span class="line">    <span class="keyword">if</span> (!trd.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="built_in">srs_warn</span>(<span class="string">&quot;drop the received %d messages&quot;</span>, trd.<span class="built_in">size</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>consumer-&gt;dump_packets</code>获取来自拉流端<code>SrsSource</code>传递给<code>SrsConsumer</code>的数据，并且发送数据给客户端。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::do_playing</span><span class="params">(SrsSource* source, SrsConsumer* consumer, SrsQueueRecvThread* rtrd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">// when source is set to expired, disconnect it.</span></span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: thread quit&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// collect elapse for pithy print.</span></span><br><span class="line">        pprint-&gt;<span class="built_in">elapse</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// to use isolate thread to recv, can improve about 33% performance.</span></span><br><span class="line">        <span class="comment">// @see: https://github.com/ossrs/srs/issues/196</span></span><br><span class="line">        <span class="comment">// @see: https://github.com/ossrs/srs/issues/217</span></span><br><span class="line">        <span class="keyword">while</span> (!rtrd-&gt;<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            SrsCommonMessage* msg = rtrd-&gt;<span class="built_in">pump</span>();</span><br><span class="line">            <span class="comment">//处理拉流客户端的控制消息</span></span><br><span class="line">            <span class="keyword">if</span> ((err = <span class="built_in">process_play_control_msg</span>(consumer, msg)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: play control message&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// quit when recv thread error.</span></span><br><span class="line">        <span class="keyword">if</span> ((err = rtrd-&gt;<span class="built_in">error_code</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: recv thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_PERF_QUEUE_COND_WAIT</span></span><br><span class="line">        <span class="comment">// wait for message to incoming.</span></span><br><span class="line">        <span class="comment">// @see https://github.com/ossrs/srs/issues/251</span></span><br><span class="line">        <span class="comment">// @see https://github.com/ossrs/srs/issues/257</span></span><br><span class="line">        <span class="keyword">if</span> (realtime) &#123;</span><br><span class="line">            <span class="comment">// for realtime, min required msgs is 0, send when got one+ msgs.</span></span><br><span class="line">            consumer-&gt;<span class="built_in">wait</span>(<span class="number">0</span>, mw_sleep);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// for no-realtime, got some msgs then send.</span></span><br><span class="line">            consumer-&gt;<span class="built_in">wait</span>(SRS_PERF_MW_MIN_MSGS, mw_sleep);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// get messages from consumer.</span></span><br><span class="line">        <span class="comment">// each msg in msgs.msgs must be free, for the SrsMessageArray never free them.</span></span><br><span class="line">        <span class="comment">// @remark when enable send_min_interval, only fetch one message a time.</span></span><br><span class="line">        <span class="type">int</span> count = (send_min_interval &gt; <span class="number">0</span>)? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//获取消息</span></span><br><span class="line">        <span class="keyword">if</span> ((err = consumer-&gt;<span class="built_in">dump_packets</span>(&amp;msgs, count)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: consumer dump packets&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// reportable</span></span><br><span class="line">        <span class="keyword">if</span> (pprint-&gt;<span class="built_in">can_print</span>()) &#123;</span><br><span class="line">            kbps-&gt;<span class="built_in">sample</span>();</span><br><span class="line">            <span class="built_in">srs_trace</span>(<span class="string">&quot;-&gt; &quot;</span> SRS_CONSTS_LOG_PLAY <span class="string">&quot; time=%d, msgs=%d, okbps=%d,%d,%d, ikbps=%d,%d,%d, mw=%d&quot;</span>,</span><br><span class="line">                (<span class="type">int</span>)pprint-&gt;<span class="built_in">age</span>(), count, kbps-&gt;<span class="built_in">get_send_kbps</span>(), kbps-&gt;<span class="built_in">get_send_kbps_30s</span>(), kbps-&gt;<span class="built_in">get_send_kbps_5m</span>(),</span><br><span class="line">                kbps-&gt;<span class="built_in">get_recv_kbps</span>(), kbps-&gt;<span class="built_in">get_recv_kbps_30s</span>(), kbps-&gt;<span class="built_in">get_recv_kbps_5m</span>(), <span class="built_in">srsu2msi</span>(mw_sleep));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> SRS_PERF_QUEUE_COND_WAIT</span></span><br><span class="line">            <span class="built_in">srs_usleep</span>(mw_sleep);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            <span class="comment">// ignore when nothing got.</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// only when user specifies the duration,</span></span><br><span class="line">        <span class="comment">// we start to collect the durations for each message.</span></span><br><span class="line">        <span class="keyword">if</span> (user_specified_duration_to_stop) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">                SrsSharedPtrMessage* msg = msgs.msgs[i];</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// foreach msg, collect the duration.</span></span><br><span class="line">                <span class="comment">// @remark: never use msg when sent it, for the protocol sdk will free it.</span></span><br><span class="line">                <span class="keyword">if</span> (starttime &lt; <span class="number">0</span> || starttime &gt; msg-&gt;timestamp) &#123;</span><br><span class="line">                    starttime = msg-&gt;timestamp;</span><br><span class="line">                &#125;</span><br><span class="line">                duration += (msg-&gt;timestamp - starttime) * SRS_UTIME_MILLISECONDS;</span><br><span class="line">                starttime = msg-&gt;timestamp;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// sendout messages, all messages are freed by send_and_free_messages().</span></span><br><span class="line">        <span class="comment">// no need to assert msg, for the rtmp will assert it.</span></span><br><span class="line">        <span class="comment">//发送数据给play客户端</span></span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span> &amp;&amp; (err = rtmp-&gt;<span class="built_in">send_and_free_messages</span>(msgs.msgs, count, info-&gt;res-&gt;stream_id)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: send %d messages&quot;</span>, count);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// if duration specified, and exceed it, stop play live.</span></span><br><span class="line">        <span class="comment">// @see: https://github.com/ossrs/srs/issues/45</span></span><br><span class="line">        <span class="keyword">if</span> (user_specified_duration_to_stop) &#123;</span><br><span class="line">            <span class="keyword">if</span> (duration &gt;= req-&gt;duration) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_RTMP_DURATION_EXCEED, <span class="string">&quot;rtmp: time %d up %d&quot;</span>, <span class="built_in">srsu2msi</span>(duration), <span class="built_in">srsu2msi</span>(req-&gt;duration));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// apply the minimal interval for delivery stream in srs_utime_t.</span></span><br><span class="line">        <span class="keyword">if</span> (send_min_interval &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">srs_usleep</span>(send_min_interval);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="RTMP协议"><a href="#RTMP协议" class="headerlink" title="RTMP协议"></a>RTMP协议</h1><h2 id="推流端-1"><a href="#推流端-1" class="headerlink" title="推流端"></a>推流端</h2><img src="/2023/09/30/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BRTMP/rtmp协议报文.png" alt="rtmp协议报文" style="zoom:50%;">

<ul>
<li>上述RTMP拉流端协程回调中会处理与客户端的握手<code>rtmp-&gt;handshake</code>，<code>rtmp-&gt;connect_app</code>连接命令等。后续处理跟踪<code>service_cycle</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">rs_error_t</span> <span class="title">SrsRtmpConn::do_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;RTMP client ip=%s, fd=%d&quot;</span>, ip.<span class="built_in">c_str</span>(), <span class="built_in">srs_netfd_fileno</span>(stfd));</span><br><span class="line">    </span><br><span class="line">    rtmp-&gt;<span class="built_in">set_recv_timeout</span>(SRS_CONSTS_RTMP_TIMEOUT);</span><br><span class="line">    rtmp-&gt;<span class="built_in">set_send_timeout</span>(SRS_CONSTS_RTMP_TIMEOUT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">handshake</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp handshake&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> rip = rtmp-&gt;<span class="built_in">proxy_real_ip</span>();</span><br><span class="line">    <span class="keyword">if</span> (rip &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">srs_trace</span>(<span class="string">&quot;RTMP proxy real client ip=%d.%d.%d.%d&quot;</span>,</span><br><span class="line">            <span class="built_in">uint8_t</span>(rip&gt;&gt;<span class="number">24</span>), <span class="built_in">uint8_t</span>(rip&gt;&gt;<span class="number">16</span>), <span class="built_in">uint8_t</span>(rip&gt;&gt;<span class="number">8</span>), <span class="built_in">uint8_t</span>(rip));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">connect_app</span>(req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp connect tcUrl&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// set client ip to request.</span></span><br><span class="line">    req-&gt;ip = ip;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;connect app, tcUrl=%s, pageUrl=%s, swfUrl=%s, schema=%s, vhost=%s, port=%d, app=%s, args=%s&quot;</span>,</span><br><span class="line">        req-&gt;tcUrl.<span class="built_in">c_str</span>(), req-&gt;pageUrl.<span class="built_in">c_str</span>(), req-&gt;swfUrl.<span class="built_in">c_str</span>(),</span><br><span class="line">        req-&gt;schema.<span class="built_in">c_str</span>(), req-&gt;vhost.<span class="built_in">c_str</span>(), req-&gt;port,</span><br><span class="line">        req-&gt;app.<span class="built_in">c_str</span>(), (req-&gt;args? <span class="string">&quot;(obj)&quot;</span>:<span class="string">&quot;null&quot;</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// show client identity</span></span><br><span class="line">    <span class="keyword">if</span>(req-&gt;args) &#123;</span><br><span class="line">        std::string srs_version;</span><br><span class="line">        std::string srs_server_ip;</span><br><span class="line">        <span class="type">int</span> srs_pid = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> srs_id = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        SrsAmf0Any* prop = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> ((prop = req-&gt;args-&gt;<span class="built_in">ensure_property_string</span>(<span class="string">&quot;srs_version&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            srs_version = prop-&gt;<span class="built_in">to_str</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((prop = req-&gt;args-&gt;<span class="built_in">ensure_property_string</span>(<span class="string">&quot;srs_server_ip&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            srs_server_ip = prop-&gt;<span class="built_in">to_str</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((prop = req-&gt;args-&gt;<span class="built_in">ensure_property_number</span>(<span class="string">&quot;srs_pid&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            srs_pid = (<span class="type">int</span>)prop-&gt;<span class="built_in">to_number</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((prop = req-&gt;args-&gt;<span class="built_in">ensure_property_number</span>(<span class="string">&quot;srs_id&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            srs_id = (<span class="type">int</span>)prop-&gt;<span class="built_in">to_number</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (srs_pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">srs_trace</span>(<span class="string">&quot;edge-srs ip=%s, version=%s, pid=%d, id=%d&quot;</span>,</span><br><span class="line">                srs_server_ip.<span class="built_in">c_str</span>(), srs_version.<span class="built_in">c_str</span>(), srs_pid, srs_id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">service_cycle</span>()) != srs_success) &#123;</span><br><span class="line">        err = <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;service cycle&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">srs_error_t</span> r0 = srs_success;</span><br><span class="line">    <span class="keyword">if</span> ((r0 = <span class="built_in">on_disconnect</span>()) != srs_success) &#123;</span><br><span class="line">        err = <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;on disconnect %s&quot;</span>, <span class="built_in">srs_error_desc</span>(r0).<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="built_in">srs_freep</span>(r0);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// If client is redirect to other servers, we already logged the event.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">srs_error_code</span>(err) == ERROR_CONTROL_REDIRECT) &#123;</span><br><span class="line">        <span class="built_in">srs_error_reset</span>(err);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>connect消息处理。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpServer::connect_app</span><span class="params">(SrsRequest* req)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    SrsCommonMessage* msg = <span class="literal">NULL</span>;</span><br><span class="line">    SrsConnectAppPacket* pkt = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//期望收到connect命令消息</span></span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">expect_message</span>&lt;SrsConnectAppPacket&gt;(&amp;msg, &amp;pkt)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;expect connect app response&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsCommonMessage, msg);</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsConnectAppPacket, pkt);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//从SrsConnectAppPacket读取对应的字段数据</span></span><br><span class="line">    SrsAmf0Any* prop = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((prop = pkt-&gt;command_object-&gt;<span class="built_in">ensure_property_string</span>(<span class="string">&quot;tcUrl&quot;</span>)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_RTMP_REQ_CONNECT, <span class="string">&quot;invalid request without tcUrl&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    req-&gt;tcUrl = prop-&gt;<span class="built_in">to_str</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((prop = pkt-&gt;command_object-&gt;<span class="built_in">ensure_property_string</span>(<span class="string">&quot;pageUrl&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        req-&gt;pageUrl = prop-&gt;<span class="built_in">to_str</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((prop = pkt-&gt;command_object-&gt;<span class="built_in">ensure_property_string</span>(<span class="string">&quot;swfUrl&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        req-&gt;swfUrl = prop-&gt;<span class="built_in">to_str</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((prop = pkt-&gt;command_object-&gt;<span class="built_in">ensure_property_number</span>(<span class="string">&quot;objectEncoding&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        req-&gt;objectEncoding = prop-&gt;<span class="built_in">to_number</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (pkt-&gt;args) &#123;</span><br><span class="line">        <span class="built_in">srs_freep</span>(req-&gt;args);</span><br><span class="line">        req-&gt;args = pkt-&gt;args-&gt;<span class="built_in">copy</span>()-&gt;<span class="built_in">to_object</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_discovery_tc_url</span>(req-&gt;tcUrl, req-&gt;schema, req-&gt;host, req-&gt;vhost, req-&gt;app, req-&gt;stream, req-&gt;port, req-&gt;param);</span><br><span class="line">    req-&gt;<span class="built_in">strip</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>解析消息，对于<code>recv_message</code>从TCP流式数据中获取chunk封装成<code>SrsCommonMessage</code>，对于<code>decode_message</code>将<code>SrsCommonMessage</code>封装成<code>SrsConnectAppPacket</code>对象数据。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">expect_message</span><span class="params">(SrsCommonMessage** pmsg, T** ppacket)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *pmsg = <span class="literal">NULL</span>;</span><br><span class="line">    *ppacket = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsCommonMessage* msg = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">recv_message</span>(&amp;msg)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv message&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        SrsPacket* packet = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">decode_message</span>(msg, &amp;packet)) != srs_success) &#123;</span><br><span class="line">            <span class="built_in">srs_freep</span>(msg);</span><br><span class="line">            <span class="built_in">srs_freep</span>(packet);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;decode message&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        T* pkt = <span class="built_in">dynamic_cast</span>&lt;T*&gt;(packet);</span><br><span class="line">        <span class="keyword">if</span> (!pkt) &#123;</span><br><span class="line">            <span class="built_in">srs_freep</span>(msg);</span><br><span class="line">            <span class="built_in">srs_freep</span>(packet);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        *pmsg = msg;</span><br><span class="line">        *ppacket = pkt;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>service_cycle</code>具体看下协议处理。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::service_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//设置窗口大小</span></span><br><span class="line">    <span class="type">int</span> out_ack_size = _srs_config-&gt;<span class="built_in">get_out_ack_size</span>(req-&gt;vhost);</span><br><span class="line">    <span class="keyword">if</span> (out_ack_size &amp;&amp; (err = rtmp-&gt;<span class="built_in">set_window_ack_size</span>(out_ack_size)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: set out window ack size&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> in_ack_size = _srs_config-&gt;<span class="built_in">get_in_ack_size</span>(req-&gt;vhost);</span><br><span class="line">    <span class="keyword">if</span> (in_ack_size &amp;&amp; (err = rtmp-&gt;<span class="built_in">set_in_window_ack_size</span>(in_ack_size)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: set in window ack size&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//设置带宽</span></span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">set_peer_bandwidth</span>((<span class="type">int</span>)(<span class="number">2.5</span> * <span class="number">1000</span> * <span class="number">1000</span>), <span class="number">2</span>)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: set peer bandwidth&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// get the ip which client connected.</span></span><br><span class="line">    std::string local_ip = <span class="built_in">srs_get_local_ip</span>(<span class="built_in">srs_netfd_fileno</span>(stfd));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// do bandwidth test if connect to the vhost which is for bandwidth check.</span></span><br><span class="line">    <span class="keyword">if</span> (_srs_config-&gt;<span class="built_in">get_bw_check_enabled</span>(req-&gt;vhost)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = bandwidth-&gt;<span class="built_in">bandwidth_check</span>(rtmp, skt, req, local_ip)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: bandwidth check&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// set chunk size to larger.</span></span><br><span class="line">    <span class="comment">// set the chunk size before any larger response greater than 128,</span></span><br><span class="line">    <span class="comment">// to make OBS happy, @see https://github.com/ossrs/srs/issues/454</span></span><br><span class="line">    <span class="comment">//设置chunk size 一般60k</span></span><br><span class="line">    <span class="type">int</span> chunk_size = _srs_config-&gt;<span class="built_in">get_chunk_size</span>(req-&gt;vhost);</span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">set_chunk_size</span>(chunk_size)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: set chunk size %d&quot;</span>, chunk_size);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// response the client connect ok.</span></span><br><span class="line">    <span class="comment">//响应客户端</span></span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">response_connect_app</span>(req, local_ip.<span class="built_in">c_str</span>())) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: response connect app&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">on_bw_done</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: on bw down&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: thread quit&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        err = <span class="built_in">stream_service_cycle</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// stream service must terminated with error, never success.</span></span><br><span class="line">        <span class="comment">// when terminated with success, it&#x27;s user required to stop.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> Support RTMP client timeout, https://github.com/ossrs/srs/issues/1134</span></span><br><span class="line">        <span class="keyword">if</span> (err == srs_success) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// when not system control error, fatal error, return.</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">srs_is_system_control_error</span>(err)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: stream service&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// for republish, continue service</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">srs_error_code</span>(err) == ERROR_CONTROL_REPUBLISH) &#123;</span><br><span class="line">            <span class="comment">// set timeout to a larger value, wait for encoder to republish.</span></span><br><span class="line">            rtmp-&gt;<span class="built_in">set_send_timeout</span>(SRS_REPUBLISH_RECV_TIMEOUT);</span><br><span class="line">            rtmp-&gt;<span class="built_in">set_recv_timeout</span>(SRS_REPUBLISH_SEND_TIMEOUT);</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">srs_info</span>(<span class="string">&quot;rtmp: retry for republish&quot;</span>);</span><br><span class="line">            <span class="built_in">srs_freep</span>(err);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// for &quot;some&quot; system control error,</span></span><br><span class="line">        <span class="comment">// logical accept and retry stream service.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">srs_error_code</span>(err) == ERROR_CONTROL_RTMP_CLOSE) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> use ping message to anti-death of socket.</span></span><br><span class="line">            <span class="comment">// @see: https://github.com/ossrs/srs/issues/39</span></span><br><span class="line">            <span class="comment">// set timeout to a larger value, for user paused.</span></span><br><span class="line">            rtmp-&gt;<span class="built_in">set_recv_timeout</span>(SRS_PAUSED_RECV_TIMEOUT);</span><br><span class="line">            rtmp-&gt;<span class="built_in">set_send_timeout</span>(SRS_PAUSED_SEND_TIMEOUT);</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">srs_trace</span>(<span class="string">&quot;rtmp: retry for close&quot;</span>);</span><br><span class="line">            <span class="built_in">srs_freep</span>(err);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// for other system control message, fatal error.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: reject&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>继续跟踪到<code>stream_service_cycle</code>中<code>rtmp-&gt;start_fmle_publish</code>，处理FCPublish、createStream、publish等消息。FCPublish命令是一个用于通知服务器要发布新流的RTMP命令，而Publish命令是用于告诉服务器要发布特定流的RTMP命令。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpServer::start_fmle_publish</span><span class="params">(<span class="type">int</span> stream_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// FCPublish</span></span><br><span class="line">    <span class="type">double</span> fc_publish_tid = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsCommonMessage* msg = <span class="literal">NULL</span>;</span><br><span class="line">        SrsFMLEStartPacket* pkt = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">expect_message</span>&lt;SrsFMLEStartPacket&gt;(&amp;msg, &amp;pkt)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv FCPublish&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(SrsCommonMessage, msg);</span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(SrsFMLEStartPacket, pkt);</span><br><span class="line">        </span><br><span class="line">        fc_publish_tid = pkt-&gt;transaction_id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// FCPublish response</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsFMLEStartResPacket* pkt = <span class="keyword">new</span> <span class="built_in">SrsFMLEStartResPacket</span>(fc_publish_tid);</span><br><span class="line">        <span class="keyword">if</span> ((err = protocol-&gt;<span class="built_in">send_and_free_packet</span>(pkt, <span class="number">0</span>)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send FCPublish response&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// createStream</span></span><br><span class="line">    <span class="type">double</span> create_stream_tid = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsCommonMessage* msg = <span class="literal">NULL</span>;</span><br><span class="line">        SrsCreateStreamPacket* pkt = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">expect_message</span>&lt;SrsCreateStreamPacket&gt;(&amp;msg, &amp;pkt)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv createStream&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(SrsCommonMessage, msg);</span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(SrsCreateStreamPacket, pkt);</span><br><span class="line">        </span><br><span class="line">        create_stream_tid = pkt-&gt;transaction_id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// createStream response</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsCreateStreamResPacket* pkt = <span class="keyword">new</span> <span class="built_in">SrsCreateStreamResPacket</span>(create_stream_tid, stream_id);</span><br><span class="line">        <span class="keyword">if</span> ((err = protocol-&gt;<span class="built_in">send_and_free_packet</span>(pkt, <span class="number">0</span>)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send createStream response&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// publish</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsCommonMessage* msg = <span class="literal">NULL</span>;</span><br><span class="line">        SrsPublishPacket* pkt = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">expect_message</span>&lt;SrsPublishPacket&gt;(&amp;msg, &amp;pkt)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv publish&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(SrsCommonMessage, msg);</span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(SrsPublishPacket, pkt);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// publish response onFCPublish(NetStream.Publish.Start)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsOnStatusCallPacket* pkt = <span class="keyword">new</span> <span class="built_in">SrsOnStatusCallPacket</span>();</span><br><span class="line">        </span><br><span class="line">        pkt-&gt;command_name = RTMP_AMF0_COMMAND_ON_FC_PUBLISH;</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusCode, SrsAmf0Any::<span class="built_in">str</span>(StatusCodePublishStart));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusDescription, SrsAmf0Any::<span class="built_in">str</span>(<span class="string">&quot;Started publishing stream.&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = protocol-&gt;<span class="built_in">send_and_free_packet</span>(pkt, stream_id)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send NetStream.Publish.Start&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// publish response onStatus(NetStream.Publish.Start)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsOnStatusCallPacket* pkt = <span class="keyword">new</span> <span class="built_in">SrsOnStatusCallPacket</span>();</span><br><span class="line">        </span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusLevel, SrsAmf0Any::<span class="built_in">str</span>(StatusLevelStatus));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusCode, SrsAmf0Any::<span class="built_in">str</span>(StatusCodePublishStart));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusDescription, SrsAmf0Any::<span class="built_in">str</span>(<span class="string">&quot;Started publishing stream.&quot;</span>));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusClientId, SrsAmf0Any::<span class="built_in">str</span>(RTMP_SIG_CLIENT_ID));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = protocol-&gt;<span class="built_in">send_and_free_packet</span>(pkt, stream_id)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send NetStream.Publish.Start&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="拉流端-1"><a href="#拉流端-1" class="headerlink" title="拉流端"></a>拉流端</h2><ul>
<li>拉流端大部分和推流一样，拉流进入<code>rsRtmpServer::start_play</code>分支。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpServer::start_play</span><span class="params">(<span class="type">int</span> stream_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// StreamBegin</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsUserControlPacket* pkt = <span class="keyword">new</span> <span class="built_in">SrsUserControlPacket</span>();</span><br><span class="line">        pkt-&gt;event_type = SrcPCUCStreamBegin;</span><br><span class="line">        pkt-&gt;event_data = stream_id;</span><br><span class="line">        <span class="keyword">if</span> ((err = protocol-&gt;<span class="built_in">send_and_free_packet</span>(pkt, <span class="number">0</span>)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send StreamBegin&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// onStatus(NetStream.Play.Reset)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsOnStatusCallPacket* pkt = <span class="keyword">new</span> <span class="built_in">SrsOnStatusCallPacket</span>();</span><br><span class="line">        </span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusLevel, SrsAmf0Any::<span class="built_in">str</span>(StatusLevelStatus));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusCode, SrsAmf0Any::<span class="built_in">str</span>(StatusCodeStreamReset));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusDescription, SrsAmf0Any::<span class="built_in">str</span>(<span class="string">&quot;Playing and resetting stream.&quot;</span>));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusDetails, SrsAmf0Any::<span class="built_in">str</span>(<span class="string">&quot;stream&quot;</span>));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusClientId, SrsAmf0Any::<span class="built_in">str</span>(RTMP_SIG_CLIENT_ID));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = protocol-&gt;<span class="built_in">send_and_free_packet</span>(pkt, stream_id)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send NetStream.Play.Reset&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// onStatus(NetStream.Play.Start)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsOnStatusCallPacket* pkt = <span class="keyword">new</span> <span class="built_in">SrsOnStatusCallPacket</span>();</span><br><span class="line">        </span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusLevel, SrsAmf0Any::<span class="built_in">str</span>(StatusLevelStatus));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusCode, SrsAmf0Any::<span class="built_in">str</span>(StatusCodeStreamStart));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusDescription, SrsAmf0Any::<span class="built_in">str</span>(<span class="string">&quot;Started playing stream.&quot;</span>));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusDetails, SrsAmf0Any::<span class="built_in">str</span>(<span class="string">&quot;stream&quot;</span>));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusClientId, SrsAmf0Any::<span class="built_in">str</span>(RTMP_SIG_CLIENT_ID));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = protocol-&gt;<span class="built_in">send_and_free_packet</span>(pkt, stream_id)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send NetStream.Play.Start&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// |RtmpSampleAccess(false, false)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsSampleAccessPacket* pkt = <span class="keyword">new</span> <span class="built_in">SrsSampleAccessPacket</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// allow audio/video sample.</span></span><br><span class="line">        <span class="comment">// @see: https://github.com/ossrs/srs/issues/49</span></span><br><span class="line">        pkt-&gt;audio_sample_access = <span class="literal">true</span>;</span><br><span class="line">        pkt-&gt;video_sample_access = <span class="literal">true</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = protocol-&gt;<span class="built_in">send_and_free_packet</span>(pkt, stream_id)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send |RtmpSampleAccess true&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// onStatus(NetStream.Data.Start)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsOnStatusDataPacket* pkt = <span class="keyword">new</span> <span class="built_in">SrsOnStatusDataPacket</span>();</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusCode, SrsAmf0Any::<span class="built_in">str</span>(StatusCodeDataStart));</span><br><span class="line">        <span class="keyword">if</span> ((err = protocol-&gt;<span class="built_in">send_and_free_packet</span>(pkt, stream_id)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send NetStream.Data.Start&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/09/29/nginx%E6%90%AD%E5%BB%BAHLS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/09/29/nginx%E6%90%AD%E5%BB%BAHLS/" class="post-title-link" itemprop="url">nginx搭建HLS</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-29 20:44:22" itemprop="dateCreated datePublished" datetime="2023-09-29T20:44:22+08:00">2023-09-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-12-31 12:57:27" itemprop="dateModified" datetime="2023-12-31T12:57:27+08:00">2023-12-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nginx-http-flv-module</span></span><br><span class="line">git clone https://github.com/winshining/nginx-http-flv-module.git</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nginx</span></span><br><span class="line">wget http://nginx.org/download/nginx-1.24.0.tar.gz</span><br><span class="line">tar xvzf nginx-1.24.0.tar.gz</span><br><span class="line">cd nginx-1.24.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编译nginx</span></span><br><span class="line">./configure --prefix=/usr/local/rtmp-nginx --add-module=`pwd`/nginx-http-flv-module</span><br><span class="line">make install -j4</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动</span></span><br><span class="line">cd /usr/local/rtmp-nginx/nginx</span><br><span class="line">sudo ./sbin/nginx -c conf/nginx.conf</span><br></pre></td></tr></table></figure>

<h1 id="配置⽂件"><a href="#配置⽂件" class="headerlink" title="配置⽂件"></a>配置⽂件</h1><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">daemon</span> <span class="literal">off</span>;</span><br><span class="line"><span class="comment"># 如果开启off对应的ts⽂件不并删除</span></span><br><span class="line"><span class="comment"># master_process off;</span></span><br><span class="line"><span class="comment"># user root;</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">error_log</span> /tmp/<span class="literal">error</span>.log <span class="literal">debug</span>;</span><br><span class="line">events&#123;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rtmp&#123;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">1935</span>;</span><br><span class="line">        <span class="attribute">chunk_size</span> <span class="number">4000</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#live</span></span><br><span class="line">        <span class="attribute">application</span> live &#123;</span><br><span class="line">            <span class="attribute">live</span> <span class="literal">on</span>;</span><br><span class="line">    </span><br><span class="line">    		<span class="comment"># live和上面application live对应</span></span><br><span class="line">            <span class="attribute">exec</span> /usr/local/bin/ffmpeg -i rtmp://localhost/live/<span class="variable">$name</span></span><br><span class="line">    </span><br><span class="line">    		<span class="comment"># hls和下面application hls对应</span></span><br><span class="line">            <span class="comment"># 这里测试多码率虽然/tmp/hls下有生成对应文件，ffplay播放不知道为什么没效果？</span></span><br><span class="line">            -c:a copy -c:v copy -b:v <span class="number">300K</span> -g <span class="number">30</span> -f flv rtmp://localhost/hls/<span class="variable">$name_hi</span></span><br><span class="line">            -c:a copy -c:v copy -b:v <span class="number">200K</span> -g <span class="number">30</span> -s 462x254 -f flv rtmp://localhost/hls/<span class="variable">$name_mid</span></span><br><span class="line">            -c:a copy -c:v copy -b:v <span class="number">100K</span> -g <span class="number">30</span> -s 230x128 -f flv rtmp://localhost/hls/<span class="variable">$name_low</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="attribute">application</span> hls &#123;</span><br><span class="line">            <span class="attribute">live</span> <span class="literal">on</span>;</span><br><span class="line">            <span class="attribute">hls</span> <span class="literal">on</span>;                  <span class="comment"># 实时回访</span></span><br><span class="line">            <span class="attribute">hls_path</span> /tmp/hls;       <span class="comment"># m3u8,ts文件保存路径</span></span><br><span class="line">            <span class="attribute">hls_nested</span> <span class="literal">on</span>;           <span class="comment"># 每个流都⾃动创建⼀个⽂件夹</span></span><br><span class="line">            <span class="attribute">hls_fragment</span> <span class="number">2s</span>;         <span class="comment"># 每个ts⽂件为时长</span></span><br><span class="line">            <span class="attribute">hls_playlist_length</span> <span class="number">6s</span>;  <span class="comment"># 保存m3u8列表⻓度时间</span></span><br><span class="line">    </span><br><span class="line">            <span class="attribute">hls_variant</span> _hi BANDWIDTH=<span class="number">350000</span>;</span><br><span class="line">            <span class="attribute">hls_variant</span> _mid BANDWIDTH=<span class="number">250000</span>;</span><br><span class="line">            <span class="attribute">hls_variant</span> _low BANDWIDTH=<span class="number">150000</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http&#123;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">8081</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#welcome</span></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">root</span> html;</span><br><span class="line">            <span class="attribute">index</span> index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">#hls</span></span><br><span class="line">        <span class="section">location</span> /hls &#123;</span><br><span class="line">            <span class="section">types</span> &#123;</span><br><span class="line">                application/vnd.apple.<span class="attribute">mpegusr</span> m3u8;</span><br><span class="line">                video/<span class="attribute">mp2t</span> ts;</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">#root /tmp;</span></span><br><span class="line">            <span class="attribute">alias</span> /tmp/hls;</span><br><span class="line">            <span class="attribute">add_header</span> Cache-Control <span class="literal">no</span>-cache;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># /tmp/hls/livestream.m3u8</span><br><span class="line"></span><br><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-VERSION:3</span><br><span class="line">#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=350000</span><br><span class="line">livestream_hi/index.m3u8</span><br><span class="line">#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=250000</span><br><span class="line">livestream_mid/index.m3u8</span><br><span class="line">#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=150000</span><br><span class="line">livestream_low/index.m3u8</span><br><span class="line"></span><br><span class="line"># /tmp/hls/livestream_low/index.m3u8</span><br><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-VERSION:3</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:41</span><br><span class="line">#EXT-X-TARGETDURATION:4</span><br><span class="line">#EXTINF:4.400,</span><br><span class="line">41.ts</span><br><span class="line">#EXTINF:2.160,</span><br><span class="line">42.ts</span><br><span class="line">#EXTINF:2.480,</span><br><span class="line">43.t</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">推流</span></span><br><span class="line">ffmpeg -re -i test.flv -vcodec copy -acodec copy -f flv -y rtmp://127.0.0.1/live/livestream </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉流</span></span><br><span class="line">RTMP流地址为：rtmp://127.0.0.1/live/livestream </span><br><span class="line">HLS流地址为：http://127.0.0.1:8081/hls/livestream.m3u8</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定码率</span></span><br><span class="line">http://127.0.0.1:8081/hls/livestream_hi/index.m3u8</span><br><span class="line">http://127.0.0.1:8081/hls/livestream_mid/index.m3u8</span><br><span class="line">http://127.0.0.1:8081/hls/livestream_low/index.m3u8</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/09/29/HLS%E6%8B%89%E6%B5%81%E6%BA%90%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/09/29/HLS%E6%8B%89%E6%B5%81%E6%BA%90%E7%A0%81/" class="post-title-link" itemprop="url">HLS拉流源码</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-29 12:52:14" itemprop="dateCreated datePublished" datetime="2023-09-29T12:52:14+08:00">2023-09-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-12-30 22:39:30" itemprop="dateModified" datetime="2023-12-30T22:39:30+08:00">2023-12-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/FFmpeg/" itemprop="url" rel="index"><span itemprop="name">FFmpeg</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>版本：ffmpeg4.2.1</p>
<p>文件：hls.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// playlist 描述m3u8的解析结果</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">parse_playlist</span><span class="params">(HLSContext *c, <span class="type">const</span> <span class="type">char</span> *url,</span></span><br><span class="line"><span class="params">                          <span class="keyword">struct</span> playlist *pls, AVIOContext *in)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    </span><br><span class="line">    ff_get_chomp_line(in, line, <span class="keyword">sizeof</span>(line));  <span class="comment">// 读取行</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(line, <span class="string">&quot;#EXTM3U&quot;</span>)) &#123;  <span class="comment">// HLS协议标志起始头#EXTM3U</span></span><br><span class="line">        ret = AVERROR_INVALIDDATA;</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 解析m3u8内容</span></span><br><span class="line">    <span class="keyword">while</span> (!avio_feof(in)) &#123;    <span class="comment">// ptr指向tag :后的位置</span></span><br><span class="line">        ff_get_chomp_line(in, line, <span class="keyword">sizeof</span>(line));  <span class="comment">// 读取一行</span></span><br><span class="line">        <span class="keyword">if</span> (av_strstart(line, <span class="string">&quot;#EXT-X-STREAM-INF:&quot;</span>, &amp;ptr)) &#123; <span class="comment">// master playlist, 是否嵌套m3u8</span></span><br><span class="line">            is_variant = <span class="number">1</span>;</span><br><span class="line">            <span class="built_in">memset</span>(&amp;variant_info, <span class="number">0</span>, <span class="keyword">sizeof</span>(variant_info));</span><br><span class="line">            ff_parse_key_value(ptr, (ff_parse_key_val_cb) handle_variant_args,</span><br><span class="line">                               &amp;variant_info);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (av_strstart(line, <span class="string">&quot;#EXT-X-KEY:&quot;</span>, &amp;ptr)) &#123; <span class="comment">// #EXT-X-KEY：表示怎么对 media segments 进行解码</span></span><br><span class="line">            <span class="keyword">struct</span> key_info info = &#123;&#123;<span class="number">0</span>&#125;&#125;;</span><br><span class="line">            ff_parse_key_value(ptr, (ff_parse_key_val_cb) handle_key_args,</span><br><span class="line">                               &amp;info);</span><br><span class="line">            key_type = KEY_NONE;</span><br><span class="line">            has_iv = <span class="number">0</span>; </span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(info.method, <span class="string">&quot;AES-128&quot;</span>))</span><br><span class="line">                key_type = KEY_AES_128;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(info.method, <span class="string">&quot;SAMPLE-AES&quot;</span>))</span><br><span class="line">                key_type = KEY_SAMPLE_AES;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(info.iv, <span class="string">&quot;0x&quot;</span>, <span class="number">2</span>) || !<span class="built_in">strncmp</span>(info.iv, <span class="string">&quot;0X&quot;</span>, <span class="number">2</span>)) &#123;</span><br><span class="line">                ff_hex_to_data(iv, info.iv + <span class="number">2</span>);</span><br><span class="line">                has_iv = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            av_strlcpy(key, info.uri, <span class="keyword">sizeof</span>(key)); <span class="comment">// 保存key信息</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (av_strstart(line, <span class="string">&quot;#EXT-X-MEDIA:&quot;</span>, &amp;ptr)) &#123;</span><br><span class="line">            <span class="keyword">struct</span> rendition_info info = &#123;&#123;<span class="number">0</span>&#125;&#125;;</span><br><span class="line">            ff_parse_key_value(ptr, (ff_parse_key_val_cb) handle_rendition_args,</span><br><span class="line">                               &amp;info);</span><br><span class="line">            new_rendition(c, &amp;info, url);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (av_strstart(line, <span class="string">&quot;#EXT-X-TARGETDURATION:&quot;</span>, &amp;ptr)) &#123; <span class="comment">// 最大长度</span></span><br><span class="line">            ret = ensure_playlist(c, &amp;pls, url);    <span class="comment">// 确保pls不为空，为空创建一个playlist</span></span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">goto</span> fail;</span><br><span class="line">            pls-&gt;target_duration = strtoll(ptr, <span class="literal">NULL</span>, <span class="number">10</span>) * AV_TIME_BASE;   <span class="comment">// 记录target duration</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (av_strstart(line, <span class="string">&quot;#EXT-X-MEDIA-SEQUENCE:&quot;</span>, &amp;ptr)) &#123; <span class="comment">// 起始序号</span></span><br><span class="line">            ret = ensure_playlist(c, &amp;pls, url);</span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">goto</span> fail;</span><br><span class="line">            pls-&gt;start_seq_no = atoi(ptr);      <span class="comment">// 记录起始序号</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (av_strstart(line, <span class="string">&quot;#EXT-X-PLAYLIST-TYPE:&quot;</span>, &amp;ptr)) &#123;</span><br><span class="line">            ret = ensure_playlist(c, &amp;pls, url);</span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">goto</span> fail;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(ptr, <span class="string">&quot;EVENT&quot;</span>))</span><br><span class="line">                pls-&gt;type = PLS_TYPE_EVENT; <span class="comment">// 实时生成</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(ptr, <span class="string">&quot;VOD&quot;</span>))</span><br><span class="line">                pls-&gt;type = PLS_TYPE_VOD;   <span class="comment">// 点播生成 m3u8 和 ts 文件</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (av_strstart(line, <span class="string">&quot;#EXT-X-MAP:&quot;</span>, &amp;ptr)) &#123;</span><br><span class="line">            <span class="comment">// 定如何获取分析适用的 Media Segments 所需的 Media Initialization Section</span></span><br><span class="line">            <span class="keyword">struct</span> init_section_info info = &#123;&#123;<span class="number">0</span>&#125;&#125;;</span><br><span class="line">            ret = ensure_playlist(c, &amp;pls, url);</span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">goto</span> fail;</span><br><span class="line">            ff_parse_key_value(ptr, (ff_parse_key_val_cb) handle_init_section_args,</span><br><span class="line">                               &amp;info);</span><br><span class="line">            cur_init_section = new_init_section(pls, &amp;info, url);</span><br><span class="line">            cur_init_section-&gt;key_type = key_type;</span><br><span class="line">            <span class="keyword">if</span> (has_iv) &#123;</span><br><span class="line">                <span class="built_in">memcpy</span>(cur_init_section-&gt;iv, iv, <span class="keyword">sizeof</span>(iv));   <span class="comment">//如果有 IV，则将该值当成 16 个字节的 16 进制数</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">int</span> seq = pls-&gt;start_seq_no + pls-&gt;n_segments;</span><br><span class="line">                <span class="built_in">memset</span>(cur_init_section-&gt;iv, <span class="number">0</span>, <span class="keyword">sizeof</span>(cur_init_section-&gt;iv));</span><br><span class="line">                <span class="comment">//如果没有 IV（Initialization Vector），</span></span><br><span class="line">                <span class="comment">//则使用序列号作为 IV 进行编解码，将序列号的高位赋到 16 个字节的 buffer 中，左边补 0</span></span><br><span class="line">                AV_WB32(cur_init_section-&gt;iv + <span class="number">12</span>, seq);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (key_type != KEY_NONE) &#123;</span><br><span class="line">                ff_make_absolute_url(tmp_str, <span class="keyword">sizeof</span>(tmp_str), url, key);</span><br><span class="line">                cur_init_section-&gt;key = av_strdup(tmp_str);</span><br><span class="line">                <span class="keyword">if</span> (!cur_init_section-&gt;key) &#123;</span><br><span class="line">                    av_free(cur_init_section);</span><br><span class="line">                    ret = AVERROR(ENOMEM);</span><br><span class="line">                    <span class="keyword">goto</span> fail;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                cur_init_section-&gt;key = <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (av_strstart(line, <span class="string">&quot;#EXT-X-ENDLIST&quot;</span>, &amp;ptr)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pls)</span><br><span class="line">                pls-&gt;finished = <span class="number">1</span>;  <span class="comment">// 指示点播文件结束  playlist结束标志，表示VOD  </span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (av_strstart(line, <span class="string">&quot;#EXTINF:&quot;</span>, &amp;ptr)) &#123;</span><br><span class="line">            is_segment = <span class="number">1</span>;  <span class="comment">// segment标志</span></span><br><span class="line">            duration   = atof(ptr) * AV_TIME_BASE;  <span class="comment">// 获取时长</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (av_strstart(line, <span class="string">&quot;#EXT-X-BYTERANGE:&quot;</span>, &amp;ptr)) &#123;</span><br><span class="line">            <span class="comment">// #EXT-X-BYTERANGE:&lt;n&gt;[@o]</span></span><br><span class="line">            <span class="comment">// 设置类似http协议中 Range:bytes=5001-10000</span></span><br><span class="line">            seg_size = strtoll(ptr, <span class="literal">NULL</span>, <span class="number">10</span>);  <span class="comment">// 分片大小</span></span><br><span class="line">            ptr = <span class="built_in">strchr</span>(ptr, <span class="string">&#x27;@&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (ptr)</span><br><span class="line">                seg_offset = strtoll(ptr+<span class="number">1</span>, <span class="literal">NULL</span>, <span class="number">10</span>);  <span class="comment">// 起始偏移</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (av_strstart(line, <span class="string">&quot;#&quot;</span>, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">            av_log(c-&gt;ctx, AV_LOG_INFO, <span class="string">&quot;Skip (&#x27;%s&#x27;)\n&quot;</span>, line);</span><br><span class="line">            <span class="comment">// 有些Tags直接跳过，例如：[hls @ 0x100a0eb50] Skip (&#x27;#EXT-X-VERSION:3&#x27;)</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (line[<span class="number">0</span>]) &#123;   <span class="comment">// 不是以#开头的，比如：livestream-422.ts 或者http://example.com/hi.m3u8</span></span><br><span class="line">            <span class="keyword">if</span> (is_variant) &#123;   <span class="comment">// #EXT-X-STREAM-INF标记嵌套，格式如：http://example.com/hi.m3u8</span></span><br><span class="line">                <span class="keyword">if</span> (!new_variant(c, &amp;variant_info, line, url)) &#123;    <span class="comment">// 添加 playlist</span></span><br><span class="line">                    ret = AVERROR(ENOMEM);</span><br><span class="line">                    <span class="keyword">goto</span> fail;</span><br><span class="line">                &#125;</span><br><span class="line">                is_variant = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (is_segment) &#123;   <span class="comment">// #EXTINF标记一个分片，比如livestream-422.ts</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">segment</span> *<span class="title">seg</span>;</span></span><br><span class="line">                <span class="keyword">if</span> (!pls) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!new_variant(c, <span class="number">0</span>, url, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">                        ret = AVERROR(ENOMEM);</span><br><span class="line">                        <span class="keyword">goto</span> fail;</span><br><span class="line">                    &#125;</span><br><span class="line">                    pls = c-&gt;playlists[c-&gt;n_playlists - <span class="number">1</span>];</span><br><span class="line">                &#125;</span><br><span class="line">                seg = av_malloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> segment));    <span class="comment">// 添加分片segment</span></span><br><span class="line">                <span class="keyword">if</span> (!seg) &#123;</span><br><span class="line">                    ret = AVERROR(ENOMEM);</span><br><span class="line">                    <span class="keyword">goto</span> fail;</span><br><span class="line">                &#125;</span><br><span class="line">                seg-&gt;duration = duration;       <span class="comment">// 持续播放的时间</span></span><br><span class="line">                seg-&gt;key_type = key_type;       <span class="comment">// key类型</span></span><br><span class="line">                <span class="keyword">if</span> (has_iv) &#123;</span><br><span class="line">                    <span class="built_in">memcpy</span>(seg-&gt;iv, iv, <span class="keyword">sizeof</span>(iv));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="type">int</span> seq = pls-&gt;start_seq_no + pls-&gt;n_segments;  <span class="comment">//序号</span></span><br><span class="line">                    <span class="built_in">memset</span>(seg-&gt;iv, <span class="number">0</span>, <span class="keyword">sizeof</span>(seg-&gt;iv));</span><br><span class="line">                    AV_WB32(seg-&gt;iv + <span class="number">12</span>, seq);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (key_type != KEY_NONE) &#123;</span><br><span class="line">                    ff_make_absolute_url(tmp_str, <span class="keyword">sizeof</span>(tmp_str), url, key);</span><br><span class="line">                    seg-&gt;key = av_strdup(tmp_str);</span><br><span class="line">                    <span class="keyword">if</span> (!seg-&gt;key) &#123;</span><br><span class="line">                        av_free(seg);</span><br><span class="line">                        ret = AVERROR(ENOMEM);</span><br><span class="line">                        <span class="keyword">goto</span> fail;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    seg-&gt;key = <span class="literal">NULL</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 将相对的livestream-422.ts路径，</span></span><br><span class="line">                <span class="comment">// 拼接成绝对路径 http://111.229.231.225:8081/live/livestream-422.ts</span></span><br><span class="line">                ff_make_absolute_url(tmp_str, <span class="keyword">sizeof</span>(tmp_str), url, line);</span><br><span class="line">                seg-&gt;url = av_strdup(tmp_str);</span><br><span class="line">                <span class="keyword">if</span> (!seg-&gt;url) &#123;</span><br><span class="line">                    av_free(seg-&gt;key);</span><br><span class="line">                    av_free(seg);</span><br><span class="line">                    ret = AVERROR(ENOMEM);</span><br><span class="line">                    <span class="keyword">goto</span> fail;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                dynarray_add(&amp;pls-&gt;segments, &amp;pls-&gt;n_segments, seg);    <span class="comment">// 增加segments</span></span><br><span class="line">                is_segment = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                seg-&gt;size = seg_size;       <span class="comment">// 设置segment http请求的range字段</span></span><br><span class="line">                <span class="keyword">if</span> (seg_size &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    seg-&gt;url_offset = seg_offset;</span><br><span class="line">                    seg_offset += seg_size;</span><br><span class="line">                    seg_size = <span class="number">-1</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    seg-&gt;url_offset = <span class="number">0</span>;</span><br><span class="line">                    seg_offset = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                seg-&gt;init_section = cur_init_section;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (prev_segments) &#123;    <span class="comment">// 如果解析playlist之前还有segment</span></span><br><span class="line">        <span class="keyword">if</span> (pls-&gt;start_seq_no &gt; prev_start_seq_no &amp;&amp; c-&gt;first_timestamp != AV_NOPTS_VALUE) &#123;</span><br><span class="line">            <span class="type">int64_t</span> prev_timestamp = c-&gt;first_timestamp;</span><br><span class="line">            <span class="type">int</span> i, diff = pls-&gt;start_seq_no - prev_start_seq_no;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; prev_n_segments &amp;&amp; i &lt; diff; i++) &#123;</span><br><span class="line">                c-&gt;first_timestamp += prev_segments[i]-&gt;duration;   <span class="comment">// 跳过时间戳？</span></span><br><span class="line">            &#125;</span><br><span class="line">            av_log(c-&gt;ctx, AV_LOG_DEBUG, <span class="string">&quot;Media sequence change (%d -&gt; %d)&quot;</span></span><br><span class="line">                   <span class="string">&quot; reflected in first_timestamp: %&quot;</span>PRId64<span class="string">&quot; -&gt; %&quot;</span>PRId64<span class="string">&quot;\n&quot;</span>,</span><br><span class="line">                   prev_start_seq_no, pls-&gt;start_seq_no,</span><br><span class="line">                   prev_timestamp, c-&gt;first_timestamp);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pls-&gt;start_seq_no &lt; prev_start_seq_no) &#123;</span><br><span class="line">            av_log(c-&gt;ctx, AV_LOG_WARNING, <span class="string">&quot;Media sequence changed unexpectedly: %d -&gt; %d\n&quot;</span>,</span><br><span class="line">                   prev_start_seq_no, pls-&gt;start_seq_no);       <span class="comment">// 新的序号反而变小是不期望的</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        free_segment_dynarray(prev_segments, prev_n_segments);</span><br><span class="line">        <span class="comment">// 释放掉之前segment，再次播放的时候也是使用新解析出来的segment来播放</span></span><br><span class="line">        av_freep(&amp;prev_segments);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pls)</span><br><span class="line">    pls-&gt;last_load_time = av_gettime_relative();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 释放相关资源</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解析m3u8文件，并打开第一个ts文件读取信息 这里涉及到master playlist解析、节目信息获取，同时初始化hls解析相关的结构。</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">hls_read_header</span><span class="params">(AVFormatContext *s)</span></span><br><span class="line">&#123;</span><br><span class="line">    HLSContext *c = s-&gt;priv_data;</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>, i;</span><br><span class="line">    <span class="type">int</span> highest_cur_seq_no = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    c-&gt;ctx                = s;</span><br><span class="line">    c-&gt;interrupt_callback = &amp;s-&gt;interrupt_callback;</span><br><span class="line"></span><br><span class="line">    c-&gt;first_packet = <span class="number">1</span>;</span><br><span class="line">    c-&gt;first_timestamp = AV_NOPTS_VALUE;</span><br><span class="line">    c-&gt;cur_timestamp = AV_NOPTS_VALUE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((ret = save_avio_options(s)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Some HLS servers don&#x27;t like being sent the range header */</span></span><br><span class="line">    av_dict_set(&amp;c-&gt;avio_opts, <span class="string">&quot;seekable&quot;</span>, <span class="string">&quot;0&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 解析palylist，主要是解析m3u8</span></span><br><span class="line">    <span class="keyword">if</span> ((ret = parse_playlist(c, s-&gt;url, <span class="literal">NULL</span>, s-&gt;pb)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;n_variants == <span class="number">0</span>) &#123;</span><br><span class="line">        av_log(s, AV_LOG_WARNING, <span class="string">&quot;Empty playlist\n&quot;</span>);</span><br><span class="line">        ret = AVERROR_EOF;</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* If the playlist only contained playlists (Master Playlist),</span></span><br><span class="line"><span class="comment">     * parse each individual playlist.对于master playlist，逐个解析其中的playlist  */</span></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;n_playlists &gt; <span class="number">1</span> || c-&gt;playlists[<span class="number">0</span>]-&gt;n_segments == <span class="number">0</span>) &#123;   <span class="comment">// n_segments==0说明一定是master playlist</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; c-&gt;n_playlists; i++) &#123;  <span class="comment">// 如果是嵌套则要继续解析</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">playlist</span> *<span class="title">pls</span> =</span> c-&gt;playlists[i];</span><br><span class="line">            <span class="keyword">if</span> ((ret = parse_playlist(c, pls-&gt;url, pls, <span class="literal">NULL</span>)) &lt; <span class="number">0</span>) <span class="comment">// 比如http://example.com/hi.m3u8</span></span><br><span class="line">                <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;variants[<span class="number">0</span>]-&gt;playlists[<span class="number">0</span>]-&gt;n_segments == <span class="number">0</span>) &#123;</span><br><span class="line">        av_log(s, AV_LOG_WARNING, <span class="string">&quot;Empty segment\n&quot;</span>);</span><br><span class="line">        ret = AVERROR_EOF;</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If this isn&#x27;t a live stream, calculate the total duration of the stream. */</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// finished只有解析到#EXT-X-ENDLIST&quot;才会置为1</span></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;variants[<span class="number">0</span>]-&gt;playlists[<span class="number">0</span>]-&gt;finished) &#123;   </span><br><span class="line">        <span class="type">int64_t</span> duration = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; c-&gt;variants[<span class="number">0</span>]-&gt;playlists[<span class="number">0</span>]-&gt;n_segments; i++)</span><br><span class="line">            duration += c-&gt;variants[<span class="number">0</span>]-&gt;playlists[<span class="number">0</span>]-&gt;segments[i]-&gt;duration;    </span><br><span class="line">        s-&gt;duration = duration; <span class="comment">// 计算点播文件的总长度</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Associate renditions with variants  必须有至少一个variant */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; c-&gt;n_variants; i++) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">variant</span> *<span class="title">var</span> =</span> c-&gt;variants[i];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (var-&gt;audio_group[<span class="number">0</span>])</span><br><span class="line">            add_renditions_to_variant(c, var, AVMEDIA_TYPE_AUDIO, var-&gt;audio_group);</span><br><span class="line">        <span class="keyword">if</span> (var-&gt;video_group[<span class="number">0</span>])</span><br><span class="line">            add_renditions_to_variant(c, var, AVMEDIA_TYPE_VIDEO, var-&gt;video_group);</span><br><span class="line">        <span class="keyword">if</span> (var-&gt;subtitles_group[<span class="number">0</span>])</span><br><span class="line">            add_renditions_to_variant(c, var, AVMEDIA_TYPE_SUBTITLE, var-&gt;subtitles_group);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create a program for each variant */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; c-&gt;n_variants; i++) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">variant</span> *<span class="title">v</span> =</span> c-&gt;variants[i];</span><br><span class="line">        AVProgram *program;</span><br><span class="line"></span><br><span class="line">        program = av_new_program(s, i); <span class="comment">// 节目数量</span></span><br><span class="line">        <span class="keyword">if</span> (!program)</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        av_dict_set_int(&amp;program-&gt;metadata, <span class="string">&quot;variant_bitrate&quot;</span>, v-&gt;bandwidth, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Select the starting segments */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; c-&gt;n_playlists; i++) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">playlist</span> *<span class="title">pls</span> =</span> c-&gt;playlists[i]; <span class="comment">// 挑选playlist</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pls-&gt;n_segments == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 选择起始的播放序列，多个ts文件，从那个开始播放 live_start_index</span></span><br><span class="line">        pls-&gt;cur_seq_no = select_cur_seq_no(c, pls);    </span><br><span class="line">        highest_cur_seq_no = FFMAX(highest_cur_seq_no, pls-&gt;cur_seq_no);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Open the demuxer for each playlist*/</span></span><br><span class="line">    <span class="comment">// 对每个playlist打开其demuxer</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; c-&gt;n_playlists; i++) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">playlist</span> *<span class="title">pls</span> =</span> c-&gt;playlists[i];</span><br><span class="line">        ff_const59 AVInputFormat *in_fmt = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(pls-&gt;ctx = avformat_alloc_context())) &#123;   <span class="comment">// 分配解复用器上下文</span></span><br><span class="line">            ret = AVERROR(ENOMEM);</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pls-&gt;n_segments == <span class="number">0</span>)       <span class="comment">// 没有分片则下一个playlist</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        pls-&gt;index  = i;        <span class="comment">// 当前playlist编号</span></span><br><span class="line">        pls-&gt;needed = <span class="number">1</span>;        <span class="comment">// 有segment的才置为1</span></span><br><span class="line">        pls-&gt;parent = s;        <span class="comment">// 从属的父解复用器</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * If this is a live stream and this playlist looks like it is one segment</span></span><br><span class="line"><span class="comment">         * behind, try to sync it up so that every substream starts at the same</span></span><br><span class="line"><span class="comment">         * time position (so e.g. avformat_find_stream_info() will see packets from</span></span><br><span class="line"><span class="comment">         * all active streams within the first few seconds). This is not very generic,</span></span><br><span class="line"><span class="comment">         * though, as the sequence numbers are technically independent. </span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// 调整直播流的起播索引号，以保证所有playlist是同步的</span></span><br><span class="line">        <span class="keyword">if</span> (!pls-&gt;finished &amp;&amp; pls-&gt;cur_seq_no == highest_cur_seq_no - <span class="number">1</span> &amp;&amp;</span><br><span class="line">            highest_cur_seq_no &lt; pls-&gt;start_seq_no + pls-&gt;n_segments) &#123;</span><br><span class="line">            pls-&gt;cur_seq_no = highest_cur_seq_no;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pls-&gt;read_buffer = av_malloc(INITIAL_BUFFER_SIZE);</span><br><span class="line">        <span class="keyword">if</span> (!pls-&gt;read_buffer)&#123;</span><br><span class="line">            ret = AVERROR(ENOMEM);</span><br><span class="line">            avformat_free_context(pls-&gt;ctx);</span><br><span class="line">            pls-&gt;ctx = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line">        ffio_init_context(&amp;pls-&gt;pb, pls-&gt;read_buffer, INITIAL_BUFFER_SIZE, <span class="number">0</span>, pls,</span><br><span class="line">                          read_data, <span class="literal">NULL</span>, <span class="literal">NULL</span>);       <span class="comment">// read_data是真正读取数据的函数</span></span><br><span class="line">        pls-&gt;pb.seekable = <span class="number">0</span>;</span><br><span class="line">        ret = av_probe_input_buffer(&amp;pls-&gt;pb, &amp;in_fmt, pls-&gt;segments[<span class="number">0</span>]-&gt;url,</span><br><span class="line">                                    <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">/* Free the ctx - it isn&#x27;t initialized properly at this point,</span></span><br><span class="line"><span class="comment">             * so avformat_close_input shouldn&#x27;t be called. If</span></span><br><span class="line"><span class="comment">             * avformat_open_input fails below, it frees and zeros the</span></span><br><span class="line"><span class="comment">             * context, so it doesn&#x27;t need any special treatment like this. */</span></span><br><span class="line">            av_log(s, AV_LOG_ERROR, <span class="string">&quot;Error when loading first segment &#x27;%s&#x27;\n&quot;</span>, pls-&gt;segments[<span class="number">0</span>]-&gt;url);</span><br><span class="line">            avformat_free_context(pls-&gt;ctx);</span><br><span class="line">            pls-&gt;ctx = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line">        pls-&gt;ctx-&gt;pb       = &amp;pls-&gt;pb;</span><br><span class="line">        pls-&gt;ctx-&gt;io_open  = nested_io_open;</span><br><span class="line">        pls-&gt;ctx-&gt;flags   |= s-&gt;flags &amp; ~AVFMT_FLAG_CUSTOM_IO;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((ret = ff_copy_whiteblacklists(pls-&gt;ctx, s)) &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        <span class="comment">/* 打开流，获取其中AVStream信息 */</span></span><br><span class="line">        ret = avformat_open_input(&amp;pls-&gt;ctx, pls-&gt;segments[<span class="number">0</span>]-&gt;url, in_fmt, <span class="literal">NULL</span>);  <span class="comment">// 打开流</span></span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pls-&gt;id3_deferred_extra &amp;&amp; pls-&gt;ctx-&gt;nb_streams == <span class="number">1</span>) &#123;</span><br><span class="line">            ff_id3v2_parse_apic(pls-&gt;ctx, &amp;pls-&gt;id3_deferred_extra);</span><br><span class="line">            avformat_queue_attached_pictures(pls-&gt;ctx);</span><br><span class="line">            ff_id3v2_parse_priv(pls-&gt;ctx, &amp;pls-&gt;id3_deferred_extra);</span><br><span class="line">            ff_id3v2_free_extra_meta(&amp;pls-&gt;id3_deferred_extra);</span><br><span class="line">            pls-&gt;id3_deferred_extra = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pls-&gt;is_id3_timestamped == <span class="number">-1</span>)</span><br><span class="line">            av_log(s, AV_LOG_WARNING, <span class="string">&quot;No expected HTTP requests have been made\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * For ID3 timestamped raw audio streams we need to detect the packet</span></span><br><span class="line"><span class="comment">         * durations to calculate timestamps in fill_timing_for_id3_timestamped_stream(),</span></span><br><span class="line"><span class="comment">         * but for other streams we can rely on our user calling avformat_find_stream_info()</span></span><br><span class="line"><span class="comment">         * on us if they want to.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (pls-&gt;is_id3_timestamped || </span><br><span class="line">            (pls-&gt;n_renditions &gt; <span class="number">0</span> &amp;&amp; </span><br><span class="line">             pls-&gt;renditions[<span class="number">0</span>]-&gt;type == AVMEDIA_TYPE_AUDIO)) &#123;</span><br><span class="line">            ret = avformat_find_stream_info(pls-&gt;ctx, <span class="literal">NULL</span>);    <span class="comment">// 分析对应的音视频成分</span></span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pls-&gt;has_noheader_flag = !!(pls-&gt;ctx-&gt;ctx_flags &amp; AVFMTCTX_NOHEADER);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Create new AVStreams for each stream in this playlist */</span></span><br><span class="line">        ret = update_streams_from_subdemuxer(s, pls);   <span class="comment">// 将分析出来的流成分更新给 parent demux</span></span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Copy any metadata from playlist to main streams, but do not set</span></span><br><span class="line"><span class="comment">         * event flags.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (pls-&gt;n_main_streams)</span><br><span class="line">            av_dict_copy(&amp;pls-&gt;main_streams[<span class="number">0</span>]-&gt;metadata, pls-&gt;ctx-&gt;metadata, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        add_metadata_from_renditions(s, pls, AVMEDIA_TYPE_AUDIO);</span><br><span class="line">        add_metadata_from_renditions(s, pls, AVMEDIA_TYPE_VIDEO);</span><br><span class="line">        add_metadata_from_renditions(s, pls, AVMEDIA_TYPE_SUBTITLE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    update_noheader_flag(s);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">fail:</span><br><span class="line">    hls_close(s);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> INITIAL_BUFFER_SIZE 32768</span></span><br><span class="line"><span class="comment">// 读取数据，每次来读取数据都是希望读到32k的数据</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">read_data</span><span class="params">(<span class="type">void</span> *opaque, <span class="type">uint8_t</span> *buf, <span class="type">int</span> buf_size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">playlist</span> *<span class="title">v</span> =</span> opaque;</span><br><span class="line">    HLSContext *c = v-&gt;parent-&gt;priv_data;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="type">int</span> just_opened = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> reload_count = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">segment</span> *<span class="title">seg</span>;</span></span><br><span class="line"></span><br><span class="line">restart:  <span class="comment">/* 标签：重启新的下载 */</span></span><br><span class="line">    <span class="keyword">if</span> (!v-&gt;needed)</span><br><span class="line">        <span class="keyword">return</span> AVERROR_EOF;     <span class="comment">// 播放结束</span></span><br><span class="line">    <span class="comment">// 进入的条件，当前http连接还没有建立，或者使用了http_persistent以及上一个segment数据读完了</span></span><br><span class="line">    <span class="comment">// 读取m3u8文件，更新playlist</span></span><br><span class="line">    <span class="keyword">if</span> (!v-&gt;input || (c-&gt;http_persistent &amp;&amp; v-&gt;input_read_done)) &#123;        </span><br><span class="line">        <span class="type">int64_t</span> reload_interval;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Check that the playlist is still needed before opening a new segment. */</span></span><br><span class="line">        v-&gt;needed = playlist_needed(v);</span><br><span class="line">        <span class="comment">/* 检查playlist是否需要下载，如果不需要了，直接返回EOF */</span></span><br><span class="line">        <span class="keyword">if</span> (!v-&gt;needed) &#123;</span><br><span class="line">            av_log(v-&gt;parent, AV_LOG_INFO, <span class="string">&quot;No longer receiving playlist %d (&#x27;%s&#x27;)\n&quot;</span>,</span><br><span class="line">                   v-&gt;index, v-&gt;url);</span><br><span class="line">            <span class="keyword">return</span> AVERROR_EOF;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* If this is a live stream and the reload interval has elapsed since</span></span><br><span class="line"><span class="comment">         * the last playlist reload, reload the playlists now. */</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* 对于直播流，定期更新playlist */</span></span><br><span class="line">        reload_interval = default_reload_interval(v);</span><br><span class="line"></span><br><span class="line">reload: <span class="comment">/* 标签：重新下载playlist */</span></span><br><span class="line">        reload_count++;</span><br><span class="line">        <span class="comment">// 超过次数</span></span><br><span class="line">        <span class="keyword">if</span> (reload_count &gt; c-&gt;max_reload)</span><br><span class="line">            <span class="keyword">return</span> AVERROR_EOF;</span><br><span class="line">        <span class="keyword">if</span> (!v-&gt;finished &amp;&amp; <span class="comment">// 直播流才进来，点播m3u8是固定的不需要更新</span></span><br><span class="line">            av_gettime_relative() - v-&gt;last_load_time &gt;= reload_interval) &#123; <span class="comment">// 超过一个segment duration</span></span><br><span class="line">            <span class="keyword">if</span> ((ret = parse_playlist(c, v-&gt;url, v, <span class="literal">NULL</span>)) &lt; <span class="number">0</span>) &#123;  <span class="comment">// 下载playlist</span></span><br><span class="line">                <span class="keyword">if</span> (ret != AVERROR_EXIT)</span><br><span class="line">                    av_log(v-&gt;parent, AV_LOG_WARNING, <span class="string">&quot;Failed to reload playlist %d\n&quot;</span>,</span><br><span class="line">                           v-&gt;index);</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/* If we need to reload the playlist again below (if</span></span><br><span class="line"><span class="comment">             * there&#x27;s still no more segments), switch to a reload</span></span><br><span class="line"><span class="comment">             * interval of half the target duration. */</span></span><br><span class="line">            <span class="comment">// 按照HLS协议规定，如果还需要请求playlist，请求间隔可以设置为segment时长的一半</span></span><br><span class="line">            reload_interval = v-&gt;target_duration / <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* 这种情况下客户端因为某些原因下载过慢，直接调整cur_seq_no，跳过一些segment */</span></span><br><span class="line">        <span class="keyword">if</span> (v-&gt;cur_seq_no &lt; v-&gt;start_seq_no) &#123;  </span><br><span class="line">            av_log(v-&gt;parent, AV_LOG_WARNING,</span><br><span class="line">                   <span class="string">&quot;skipping %d segments ahead, expired from playlists\n&quot;</span>,</span><br><span class="line">                   v-&gt;start_seq_no - v-&gt;cur_seq_no);</span><br><span class="line">            v-&gt;cur_seq_no = v-&gt;start_seq_no;    <span class="comment">// 更新新的下载序号</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 服务器还没有更新m3u8文件，比如当前m3u8的start_seq_no是1181,n_segments是3 等于当前要播发的序号1184</span></span><br><span class="line">        <span class="keyword">if</span> (v-&gt;cur_seq_no &gt;= v-&gt;start_seq_no + v-&gt;n_segments) &#123;</span><br><span class="line">            <span class="keyword">if</span> (v-&gt;finished)    <span class="comment">/* 点播的情况下，表示读取完成 */</span></span><br><span class="line">                <span class="keyword">return</span> AVERROR_EOF;</span><br><span class="line">            <span class="keyword">while</span> (av_gettime_relative() - v-&gt;last_load_time &lt; reload_interval) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ff_check_interrupt(c-&gt;interrupt_callback))  <span class="comment">//这里就是设置的回调</span></span><br><span class="line">                    <span class="keyword">return</span> AVERROR_EXIT;</span><br><span class="line">                av_usleep(<span class="number">100</span>*<span class="number">1000</span>);    <span class="comment">// 直播的情况，休眠100ms继续去尝试</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/* Enough time has elapsed since the last reload */</span></span><br><span class="line">            <span class="comment">// 上面的循环用于等待给定的时间，然后重新加载playlist </span></span><br><span class="line">            <span class="keyword">goto</span> reload;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* 所有的前提都满足，可以开始读segment了 */</span></span><br><span class="line">        v-&gt;input_read_done = <span class="number">0</span>;</span><br><span class="line">        seg = current_segment(v);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* load/update Media Initialization Section, if any Media Initialization Section*/</span></span><br><span class="line">        ret = update_init_section(v, seg);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (c-&gt;http_multiple == <span class="number">1</span> &amp;&amp; v-&gt;input_next_requested) &#123;</span><br><span class="line">            <span class="comment">// 如果之前有提前建立http连接则将input_next赋值给input</span></span><br><span class="line">            FFSWAP(AVIOContext *, v-&gt;input, v-&gt;input_next);</span><br><span class="line">            v-&gt;input_next_requested = <span class="number">0</span>;        </span><br><span class="line">            ret = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;    <span class="comment">/* 这里发起了新的HTTP请求 */</span></span><br><span class="line">            ret = open_input(c, v, seg, &amp;v-&gt;input);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;  <span class="comment">/* 请求失败的情况下的处理，默认直接跳过当前segment */</span></span><br><span class="line">            <span class="keyword">if</span> (ff_check_interrupt(c-&gt;interrupt_callback))</span><br><span class="line">                <span class="keyword">return</span> AVERROR_EXIT;</span><br><span class="line">            av_log(v-&gt;parent, AV_LOG_WARNING, <span class="string">&quot;Failed to open segment %d of playlist %d\n&quot;</span>,</span><br><span class="line">                   v-&gt;cur_seq_no,</span><br><span class="line">                   v-&gt;index);</span><br><span class="line">            v-&gt;cur_seq_no += <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">goto</span> reload;</span><br><span class="line">        &#125;</span><br><span class="line">        just_opened = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;http_multiple == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="type">uint8_t</span> *http_version_opt = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="type">int</span> r = av_opt_get(v-&gt;input, <span class="string">&quot;http_version&quot;</span>, AV_OPT_SEARCH_CHILDREN, &amp;http_version_opt);</span><br><span class="line">        <span class="keyword">if</span> (r &gt;= <span class="number">0</span>) &#123;  <span class="comment">//在HTTP1.1中所有连接都是Keep-alive的，也就是默认都是持续连接的（Persistent Connection）</span></span><br><span class="line">            c-&gt;http_multiple = (!<span class="built_in">strncmp</span>((<span class="type">const</span> <span class="type">char</span> *)http_version_opt, <span class="string">&quot;1.1&quot;</span>, <span class="number">3</span>) || !<span class="built_in">strncmp</span>((<span class="type">const</span> <span class="type">char</span> *)http_version_opt, <span class="string">&quot;2.0&quot;</span>, <span class="number">3</span>));</span><br><span class="line">            av_freep(&amp;http_version_opt);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    seg = next_segment(v);     <span class="comment">/* 这是使用单HTTP发起请求的处理 */</span></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;http_multiple == <span class="number">1</span> &amp;&amp; !v-&gt;input_next_requested &amp;&amp;</span><br><span class="line">        seg &amp;&amp; seg-&gt;key_type == KEY_NONE &amp;&amp; av_strstart(seg-&gt;url, <span class="string">&quot;http&quot;</span>, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        ret = open_input(c, v, seg, &amp;v-&gt;input_next);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ff_check_interrupt(c-&gt;interrupt_callback))</span><br><span class="line">                <span class="keyword">return</span> AVERROR_EXIT;</span><br><span class="line">            av_log(v-&gt;parent, AV_LOG_WARNING, <span class="string">&quot;Failed to open segment %d of playlist %d\n&quot;</span>,</span><br><span class="line">                   v-&gt;cur_seq_no + <span class="number">1</span>,</span><br><span class="line">                   v-&gt;index);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            v-&gt;input_next_requested = <span class="number">1</span>;        <span class="comment">// 只是打开链接，建立连接</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 在任何实际数据返回之前，首先返回init section（解码器可能会依赖这些数据做初始化） */</span></span><br><span class="line">    <span class="keyword">if</span> (v-&gt;init_sec_buf_read_offset &lt; v-&gt;init_sec_data_len) &#123;</span><br><span class="line">        <span class="comment">/* Push init section out first before first actual segment */</span></span><br><span class="line">        <span class="type">int</span> copy_size = FFMIN(v-&gt;init_sec_data_len - v-&gt;init_sec_buf_read_offset, buf_size);</span><br><span class="line">        <span class="built_in">memcpy</span>(buf, v-&gt;init_sec_buf, copy_size);</span><br><span class="line">        v-&gt;init_sec_buf_read_offset += copy_size;</span><br><span class="line">        <span class="keyword">return</span> copy_size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    seg = current_segment(v);<span class="comment">/* 这是实际通过HTTP读取buf_size长度的数据，这个数据是交织后的数据，从server上获取的 */</span></span><br><span class="line">    ret = read_from_url(v, seg, buf, buf_size);</span><br><span class="line">    <span class="keyword">if</span> (ret &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (just_opened &amp;&amp; v-&gt;is_id3_timestamped != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">/* Intercept ID3 tags here, elementary audio streams are required</span></span><br><span class="line"><span class="comment">             * to convey timestamps using them in the beginning of each segment. */</span></span><br><span class="line">            intercept_id3(v, buf, buf_size, &amp;ret);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ret; <span class="comment">// 大于0说明已经读取到数据了</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (c-&gt;http_persistent &amp;&amp;       <span class="comment">// keep-alive</span></span><br><span class="line">        seg-&gt;key_type == KEY_NONE &amp;&amp; av_strstart(seg-&gt;url, <span class="string">&quot;http&quot;</span>, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        v-&gt;input_read_done = <span class="number">1</span>;     <span class="comment">// 当前的已经下载完毕</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ff_format_io_close(v-&gt;parent, &amp;v-&gt;input);<span class="comment">/* 读取完成了，可以关闭segment所使用的HTTP资源了 */</span></span><br><span class="line">    &#125;</span><br><span class="line">    v-&gt;cur_seq_no++;    <span class="comment">/* 更新当前读取的seg_no，同时更新全局的，保证流切换之后可以同步 */</span></span><br><span class="line"></span><br><span class="line">    c-&gt;cur_seq_no = v-&gt;cur_seq_no;  <span class="comment">/* 回到上面继续循环了 */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">goto</span> restart;   <span class="comment">// 读取新的ts流</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/09/27/HLS%E5%8D%8F%E8%AE%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/09/27/HLS%E5%8D%8F%E8%AE%AE/" class="post-title-link" itemprop="url">HLS协议</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-27 22:59:19" itemprop="dateCreated datePublished" datetime="2023-09-27T22:59:19+08:00">2023-09-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-08 13:54:24" itemprop="dateModified" datetime="2024-01-08T13:54:24+08:00">2024-01-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Protocol/" itemprop="url" rel="index"><span itemprop="name">Protocol</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="M3U8-格式"><a href="#M3U8-格式" class="headerlink" title="M3U8 格式"></a>M3U8 格式</h1><p>M3U8（也称为 HLS 播放列表）是一种文本文件格式，用于描述 HTTP Live Streaming（HLS）协议中的媒体播放列表。HLS 是一种流媒体传输协议，广泛用于将音频和视频内容分发到互联网上的移动设备和桌面浏览器。</p>
<p>M3U8 文件是一个纯文本文件，其中包含了多个媒体片段的 URL 和其他相关信息，以便客户端能够按顺序下载和播放这些片段。</p>
<h2 id="播放列表"><a href="#播放列表" class="headerlink" title="播放列表"></a>播放列表</h2><ul>
<li>一个 M3U8 的播放列表（playlist） 就是一个由多个独立行组成的文本文件，每行由回车&#x2F;换行区分。</li>
<li>每一行可以是一个 URI、空白行或是一个以 “#” 号开头的字符串，并且空格只能存在于一行中不同元素间的分隔。</li>
<li>一个 URI 表示一个媒体段或是 “variant playlist file”（最多支持一层嵌套，即一个 M3U8 文件中嵌套另一个 M3U8）。以 “EXT” 开头的表示一个 “tag”，否则表示注释，直接忽略。</li>
<li>每一个 M3U8 文件，分别对应若干个 TS 文件，这些 <strong>TS 文件才是真正存放视频的数据</strong>。<strong>M3U8 文件只是存放了一些 TS 文件的配置信息和相关路径</strong>。</li>
</ul>
<h2 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h2><p>标签（Tags）提供了有关媒体流和播放列表本身的信息。</p>
<p><strong>#EXTM3U</strong></p>
<ul>
<li><p>格式：<code>#EXTM3U</code></p>
</li>
<li><p>作用：每个 m3u8 文件第一行必须是这个 tag，请标示作用。</p>
</li>
</ul>
<p><strong>#EXT-X-VERSION</strong></p>
<ul>
<li>格式：<code>#EXT-X-VERSION:&lt;v&gt;</code></li>
<li>作用：m3u8 文件版本号，比如#EXT-X-VERSION:3。</li>
</ul>
<p><strong>#EXT-X-TARGETDURATION</strong></p>
<ul>
<li>格式： <code>#EXT-X-TARGETDURATION:&lt;s&gt;</code></li>
<li>作用：指定当前视频流中的单个切片（即 ts）文件的最大时长（秒）。所以 #EXTINF 中指定的时间长度必须小于或是等于这个最大值。这个 tag 在整个 playlist 文件中只能出现一次（在嵌套的情况下，一般有真正 ts url 的 m3u8 才会出现该 tag）。</li>
</ul>
<p><strong>#EXT-X-MEDIA-SEQUENCE</strong></p>
<ul>
<li>格式：<code>#EXT-X-MEDIA-SEQUENCE:&lt;number&gt;</code></li>
<li>作用：指定 meida segment 的开始序号，每一个 media uri 在 playlist 中只有唯一的序号，相邻之间序号 +1。 一个 media uri 并不是必须要包含的，如果没有，默认为 0。</li>
</ul>
<p><strong>#EXT-X-ALLOW-CACHE</strong></p>
<ul>
<li>格式：<code>#EXT-X-ALLOW-CACHE:&lt;YES|NO&gt;</code></li>
<li>作用：指示客户端是否被允许缓存媒体片段，可以在 m3u8 文件中任意地方出现，并且最多只出现一次，作用效果是所有的媒体段。</li>
</ul>
<p><strong>#EXTINF</strong></p>
<ul>
<li>格式：<code>#EXTINF:&lt;duration&gt;,&lt;title&gt;</code></li>
<li>作用：指定每个媒体段（ts）的持续时间（单位秒），这个仅对其后面的 uri 有效，每两个媒体段 uri 间被这个 tag 分隔开；比如<code>#EXTINF:14.357, no desc</code>。</li>
</ul>
<p><strong>#EXT-X-ENDLIST</strong></p>
<ul>
<li>格式：<code>#EXT-X-ENDLIST</code></li>
<li>作用：表示 m3u8 文件的结束，live m3u8 没有该 tag。它可以在 playlist 中任意位置出现，但是只能出现一个。</li>
</ul>
<p><strong>#EXT-X-STREAM-INF</strong></p>
<ul>
<li>格式：<code>#EXT-X-STREAM-INF:&lt;attribute-list&gt;</code></li>
<li>作用：指定一个包含多媒体信息的 media uri 作为 playlist，一般做 m3u8 的嵌套使用，它只对紧跟后面的 uri 有效。</li>
<li>常用的属性如下：<ul>
<li>BANDWIDTH：带宽，必须有。</li>
<li>CODECS：指定流的编码类型，不是必须的。</li>
<li>RESOLUTION：分辨率。</li>
<li>AUDIO：这个值必须和 AUDIO 类别的 “EXT-X-MEDIA” 标签中 “GROUP-ID” 属性值相匹配。</li>
<li>VIDEO：同上。</li>
</ul>
</li>
</ul>
<p><strong>#EXT-X-KEY</strong></p>
<ul>
<li>格式：<code>#EXT-X-KEY:&lt;attribute-list&gt;</code></li>
<li>作用：表示怎么对 media segments 进行解密。其作用范围是下次该 tag 出现前的所有 media URI。</li>
<li>参考链接：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/jruing/p/15820950.html">https://www.cnblogs.com/jruing/p/15820950.html</a></li>
</ul>
<h2 id="M3U8-示例"><a href="#M3U8-示例" class="headerlink" title="M3U8 示例"></a>M3U8 示例</h2><h3 id="点播媒体播放列表"><a href="#点播媒体播放列表" class="headerlink" title="点播媒体播放列表"></a>点播媒体播放列表</h3><p>主要特征：文件包含 <code>EXT-X-ENDLIST</code> 标签，<code>EXT-X-PLAYLIST-TYPE</code> 标签（可选）值为 VOD，表示播放列表不可变。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-PLAYLIST-TYPE:VOD</span><br><span class="line">#EXT-X-TARGETDURATION:10</span><br><span class="line">#EXT-X-VERSION:3</span><br><span class="line">#EXTINF:9.009,</span><br><span class="line">http://media.example.com/first.ts</span><br><span class="line">#EXTINF:9.009,</span><br><span class="line">http://media.example.com/second.ts</span><br><span class="line">#EXTINF:3.003,</span><br><span class="line">http://media.example.com/third.ts</span><br><span class="line">#EXT-X-ENDLIST</span><br></pre></td></tr></table></figure>

<p>M3U8 文件支持绝对路径，也支持相对路径，所以上面的格式等效于：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-PLAYLIST-TYPE:VOD</span><br><span class="line">#EXT-X-TARGETDURATION:10</span><br><span class="line">#EXT-X-VERSION:3</span><br><span class="line">#EXTINF:9.009,</span><br><span class="line">first.ts</span><br><span class="line">#EXTINF:9.009,</span><br><span class="line">second.ts</span><br><span class="line">#EXTINF:3.003,</span><br><span class="line">third.ts</span><br><span class="line">#EXT-X-ENDLIST</span><br></pre></td></tr></table></figure>

<h3 id="EVENT-播放列表"><a href="#EVENT-播放列表" class="headerlink" title="EVENT 播放列表"></a>EVENT 播放列表</h3><p>主要特征：<code>EXT-X-PLAYLIST-TYPE</code> 标签值为 EVENT，表示播放列表内容可变，不过只能在文件末尾改变。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-PLAYLIST-TYPE:EVENT</span><br><span class="line">#EXT-X-TARGETDURATION:10</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:0</span><br><span class="line">#EXTINF:10,</span><br><span class="line">fileSequence0.ts</span><br><span class="line">#EXTINF:10,</span><br><span class="line">fileSequence1.ts</span><br><span class="line">#EXTINF:10,</span><br><span class="line">fileSequence2.ts</span><br><span class="line">#EXTINF:10,</span><br><span class="line">fileSequence3.ts</span><br></pre></td></tr></table></figure>

<p>结束时，M3U8 文件内容如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-PLAYLIST-TYPE:EVENT</span><br><span class="line">#EXT-X-TARGETDURATION:10</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:0</span><br><span class="line">#EXTINF:10,</span><br><span class="line">fileSequence0.ts</span><br><span class="line">#EXTINF:10,</span><br><span class="line">fileSequence1.ts</span><br><span class="line">#EXTINF:10,</span><br><span class="line">fileSequence2.ts</span><br><span class="line">#EXTINF:10,</span><br><span class="line">fileSequence3.ts</span><br><span class="line">...</span><br><span class="line">#EXTINF:10,</span><br><span class="line">fileSequence120.ts</span><br><span class="line">#EXTINF:10,</span><br><span class="line">fileSequence121.ts</span><br><span class="line">#EXT-X-ENDLIST</span><br></pre></td></tr></table></figure>

<h3 id="直播播放列表"><a href="#直播播放列表" class="headerlink" title="直播播放列表"></a>直播播放列表</h3><p>主要特征：不包含 <code>EXT-X-ENDLIST</code> 标签，不包含 <code>EXT-X-PLAYLIST-TYPE</code> 标签。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-VERSION:3</span><br><span class="line">#EXT-X-TARGETDURATION:8</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:2680</span><br><span class="line"></span><br><span class="line">#EXTINF:7.975,</span><br><span class="line">https://priv.example.com/fileSequence2680.ts</span><br><span class="line">#EXTINF:7.941,</span><br><span class="line">https://priv.example.com/fileSequence2681.ts</span><br><span class="line">#EXTINF:7.975,</span><br><span class="line">https://priv.example.com/fileSequence2682.ts</span><br></pre></td></tr></table></figure>

<p>直播播放列表是一个会动态更新的 M3U8 文件，服务端会对直播流进行实时转码生成直播流切片，并定期更新 M3U8 文件。这个 M3U8 文件一般为会包括 3-5 个切片。</p>
<p>直播播放列表中的任意一个切片的 URI 被移除时，都需要更新 <code>EXT-X-MEDIA-SEQUENCE</code> 标签的值（+1）。移除切片 URI 时必须按顺序，以保证客户端通过更新的 M3U8 文件拿到的是连续的切片数据。</p>
<h3 id="加密的媒体播放列表"><a href="#加密的媒体播放列表" class="headerlink" title="加密的媒体播放列表"></a>加密的媒体播放列表</h3><p>主要特征：包含 <code>EXT-X-KEY</code> 标签。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-VERSION:3</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:7794</span><br><span class="line">#EXT-X-TARGETDURATION:15</span><br><span class="line"></span><br><span class="line">#EXT-X-KEY:METHOD=AES-128,URI=&quot;https://priv.example.com/key.php?r=52&quot;</span><br><span class="line"></span><br><span class="line">#EXTINF:2.833,</span><br><span class="line">http://media.example.com/fileSequence52-A.ts</span><br><span class="line">#EXTINF:15.0,</span><br><span class="line">http://media.example.com/fileSequence52-B.ts</span><br><span class="line">#EXTINF:13.333,</span><br><span class="line">http://media.example.com/fileSequence52-C.ts</span><br><span class="line"></span><br><span class="line">#EXT-X-KEY:METHOD=AES-128,URI=&quot;https://priv.example.com/key.php?r=53&quot;</span><br><span class="line"></span><br><span class="line">#EXTINF:15.0,</span><br><span class="line">http://media.example.com/fileSequence53-A.ts</span><br></pre></td></tr></table></figure>

<h3 id="BYTERANGE-播放列表"><a href="#BYTERANGE-播放列表" class="headerlink" title="BYTERANGE 播放列表"></a>BYTERANGE 播放列表</h3><p>主要特征：<code>EXT-X-VERSION</code> 标签的值为 4 以上，确保 HLS 支持。通过 <code>EXT-X-BYTERANGE</code> 来指定切片偏移量。语法是：<code>#EXT-X-BYTERANGE:length[@offset]</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-PLAYLIST-TYPE:VOD</span><br><span class="line">#EXT-X-TARGETDURATION:10</span><br><span class="line">#EXT-X-VERSION:4</span><br><span class="line">#EXTINF:9.009,</span><br><span class="line">#EXT-X-BYTERANGE:752320</span><br><span class="line">media.ts</span><br><span class="line">#EXTINF:9.009,</span><br><span class="line">#EXT-X-BYTERANGE:82112@752321</span><br><span class="line">media.ts</span><br><span class="line">#EXTINF:3.003,</span><br><span class="line">#EXT-X-BYTERANGE:69864</span><br><span class="line">media.ts</span><br><span class="line">#EXT-X-ENDLIST</span><br></pre></td></tr></table></figure>

<p>使用 BYTERANGE 播放列表可以不用在服务端存储大量的小切片文件，只通过一个文件再加上文件偏移量信息就可以支持分片。</p>
<p>比如，上面示例的 BYTERANGE 播放列表等价于下面简单的播放列表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-PLAYLIST-TYPE:VOD</span><br><span class="line">#EXT-X-TARGETDURATION:10</span><br><span class="line">#EXT-X-VERSION:3</span><br><span class="line">#EXTINF:9.009,</span><br><span class="line">first.ts</span><br><span class="line">#EXTINF:9.009,</span><br><span class="line">second.ts</span><br><span class="line">#EXTINF:3.003,</span><br><span class="line">third.ts</span><br><span class="line">#EXT-X-ENDLIST</span><br></pre></td></tr></table></figure>

<h3 id="插播不同格式内容的播放列表"><a href="#插播不同格式内容的播放列表" class="headerlink" title="插播不同格式内容的播放列表"></a>插播不同格式内容的播放列表</h3><p>主要特征：包含 <code>EXT-X-DISCONTINUITY</code> 标签。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-TARGETDURATION:10</span><br><span class="line">#EXT-X-VERSION:3</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:0</span><br><span class="line">#EXTINF:10.0,</span><br><span class="line">ad0.ts</span><br><span class="line">#EXTINF:8.0,</span><br><span class="line">ad1.ts</span><br><span class="line">#EXT-X-DISCONTINUITY</span><br><span class="line">#EXTINF:10.0,</span><br><span class="line">movieA.ts</span><br><span class="line">#EXTINF:10.0,</span><br><span class="line">movieB.ts</span><br></pre></td></tr></table></figure>

<p>在一些场景下，我们需要在点播或直播中插入其他内容，比如广告，这时候可能这段广告内容的编码格式与原视频的编码格式存在差异，这种差异可能造成客户端播放出问题，这时候就需要告知客户端。这就需要用到 EXT-X-DISCONTINUITY 标签。</p>
<h3 id="主播放列表"><a href="#主播放列表" class="headerlink" title="主播放列表"></a>主播放列表</h3><p>主要特征：包含 <code>EXT-X-STREAM-INF</code> 标签。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-STREAM-INF:BANDWIDTH=1280000,AVERAGE-BANDWIDTH=1000000</span><br><span class="line">http://example.com/low.m3u8</span><br><span class="line">#EXT-X-STREAM-INF:BANDWIDTH=2560000,AVERAGE-BANDWIDTH=2000000</span><br><span class="line">http://example.com/mid.m3u8</span><br><span class="line">#EXT-X-STREAM-INF:BANDWIDTH=7680000,AVERAGE-BANDWIDTH=6000000</span><br><span class="line">http://example.com/hi.m3u8</span><br><span class="line">#EXT-X-STREAM-INF:BANDWIDTH=65000,CODECS=&quot;mp4a.40.5&quot;</span><br><span class="line">http://example.com/audio-only.m3u8</span><br></pre></td></tr></table></figure>

<p>上面示例中，通过 3 个不同码率的视频流和 1 个音频流来描述一个内容。</p>
<h3 id="I-帧播放列表"><a href="#I-帧播放列表" class="headerlink" title="I 帧播放列表"></a>I 帧播放列表</h3><p>主要特征：包含 <code>EXT-X-I-FRAME-STREAM-INF</code> 标签。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-STREAM-INF:BANDWIDTH=1280000</span><br><span class="line">low/audio-video.m3u8</span><br><span class="line">#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=86000,URI=&quot;low/iframe.m3u8&quot;</span><br><span class="line">#EXT-X-STREAM-INF:BANDWIDTH=2560000</span><br><span class="line">mid/audio-video.m3u8</span><br><span class="line">#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=150000,URI=&quot;mid/iframe.m3u8&quot;</span><br><span class="line">#EXT-X-STREAM-INF:BANDWIDTH=7680000</span><br><span class="line">hi/audio-video.m3u8</span><br><span class="line">#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=550000,URI=&quot;hi/iframe.m3u8&quot;</span><br><span class="line">#EXT-X-STREAM-INF:BANDWIDTH=65000,CODECS=&quot;mp4a.40.5&quot;</span><br><span class="line">audio-only.m3u8</span><br></pre></td></tr></table></figure>

<p>HLS 是通过<strong>主播放列表标签 EXT-X-I-FRAME-STREAM-INF 和媒体播放列表标签 EXT-X-I-FRAMES-ONLY 配合来实现 I 帧播放列表</strong>，从而支持视频播放常用的快进和快退功能。</p>
<p>上面的示例是在主播放列表中通过 EXT-X-I-FRAME-STREAM-INF 标签指定 I 帧播放列表，那么对应的 I 帧播放列表内容示例如下：</p>
<p>主要特征：<code>EXT-X-VERSION</code> 标签的值为 4 以上，确保 HLS 支持；包含 <code>EXT-X-I-FRAMES-ONLY</code> 标签。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-VERSION:4</span><br><span class="line">#EXT-X-I-FRAMES-ONLY</span><br><span class="line">...</span><br><span class="line">#EXTINF:4.12,</span><br><span class="line">#EXT-X-BYTERANGE:9400@376</span><br><span class="line">segment1.ts</span><br><span class="line">#EXTINF:3.56,</span><br><span class="line">#EXT-X-BYTERANGE:7144@47000</span><br><span class="line">segment1.ts</span><br><span class="line">#EXTINF:3.82,</span><br><span class="line">#EXT-X-BYTERANGE:10340@1880</span><br><span class="line">segment2.ts</span><br></pre></td></tr></table></figure>

<p>上面的示例是用 EXT-X-BYTERANGE 来指定每个 I 帧对应的数据。这里需要注意的是 EXTINF 表示的时长是<strong>当前 I 帧到下一个 I 帧的时长</strong>。</p>
<h3 id="HTTP-传输-M3U8"><a href="#HTTP-传输-M3U8" class="headerlink" title="HTTP 传输 M3U8"></a>HTTP 传输 M3U8</h3><p>顶级 M3U8 文件主要是做码率适配的，⼆级 M3U8 才是真正的切片文件。客户端会默认选择码率最高的请求，如果发现码率达不到，会请求降低码率的流。客户端拿到二级 M3U8 文件后，会继续请求里面的文件，这时就可以进行播放了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET /live/test.m3u8 HTTP/1.1</span><br><span class="line">User-Agent: Lavf/59.30.100</span><br><span class="line">Accept: */*</span><br><span class="line">Range: bytes=0-</span><br><span class="line">Connection: close</span><br><span class="line">Host: 192.168.2.101:8080</span><br><span class="line">Icy-MetaData: 1</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Connection: Close</span><br><span class="line">Content-Length: 90</span><br><span class="line">Content-Type: application/vnd.apple.mpegurl</span><br><span class="line">Server: SRS/6.0.75(Bee)</span><br><span class="line"></span><br><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-STREAM-INF:BANDWIDTH=1,AVERAGE-BANDWIDTH=1</span><br><span class="line">/live/test.m3u8?hls_ctx=18201z96</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">GET /live/test.m3u8?hls_ctx=18201z96 HTTP/1.1</span><br><span class="line">User-Agent: Lavf/59.30.100</span><br><span class="line">Accept: */*</span><br><span class="line">Range: bytes=0-</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Host: 192.168.2.101:8080</span><br><span class="line">Icy-MetaData: 1</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Connection: Close</span><br><span class="line">Content-Type: application/vnd.apple.mpegurl</span><br><span class="line">Content-Length: 330</span><br><span class="line">Server: SRS/6.0.75(Bee)</span><br><span class="line"></span><br><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-VERSION:3</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:7</span><br><span class="line">#EXT-X-TARGETDURATION:15</span><br><span class="line">#EXTINF:14.994, no desc</span><br><span class="line">test-7.ts?hls_ctx=18201z96</span><br><span class="line">#EXTINF:14.994, no desc</span><br><span class="line">test-8.ts?hls_ctx=18201z96</span><br><span class="line">#EXTINF:14.994, no desc</span><br><span class="line">test-9.ts?hls_ctx=18201z96</span><br><span class="line">#EXTINF:14.994, no desc</span><br><span class="line">test-10.ts?hls_ctx=18201z96</span><br><span class="line">#EXTINF:8.933, no desc</span><br><span class="line">test-11.ts?hls_ctx=18201z96</span><br><span class="line"></span><br><span class="line">#EXT-X-ALLOW-CACHE:YES</span><br></pre></td></tr></table></figure>

<h1 id="TS-格式"><a href="#TS-格式" class="headerlink" title="TS 格式"></a>TS 格式</h1><h2 id="TS-格式介绍"><a href="#TS-格式介绍" class="headerlink" title="TS 格式介绍"></a>TS 格式介绍</h2><p>TS 全称为 <strong>MPEG2-TS</strong>，是一种封装的格式，视频编码主要格式为 H264&#x2F;MPEG4，音频为 AAC&#x2F;MP3。</p>
<ul>
<li>TS 分层格式：</li>
</ul>
<img src="/2023/09/27/HLS%E5%8D%8F%E8%AE%AE/ts⽂件分层.png" alt="ts⽂件分层" style="zoom:50%;">

<ul>
<li><p>TS 包大小<strong>固定为 188 字节</strong>，TS 文件分为三层：</p>
<ul>
<li>TS 层：Transport Stream，<strong>是在 PES 层的基础上加⼊数据流的识别和传输必须的信息</strong>。</li>
<li>PES 层： Packet Elemental Stream，<strong>是在音视频数据上加了时间戳等对数据帧的说明信息</strong>。</li>
<li>ES 层：Elementary Stream，<strong>即音视频数据</strong>。</li>
</ul>
</li>
<li><p>解析 TS 流数据的流程：</p>
<ul>
<li><strong>查找 PID 为 0x0 的包，解析 PAT，PAT 包中的 Program Map PID 表示 PMT 的 PID</strong>；</li>
<li><strong>查找 PMT，PMT 包中的 Elementary PID 表示音视频包的 PID，PMT 包中的 PCR PID 表示 PCR 的 PID</strong>，有的时候 PCR 的 PID 跟音频或者视频的 PID 相同，说明 PCR 会融进音视频的包，有的时候 PCR 又是自己单独的包。</li>
</ul>
</li>
<li><p>报文预览：</p>
</li>
</ul>
<img src="/2023/09/27/HLS%E5%8D%8F%E8%AE%AE/HLS报文.png" alt="HLS报文" style="zoom:50%;">

<h2 id="包头"><a href="#包头" class="headerlink" title="包头"></a>包头</h2><p>Header 报文格式：</p>
<img src="/2023/09/27/HLS%E5%8D%8F%E8%AE%AE/tsheader报文.png" alt="tsheader报文" style="zoom:50%;">

<p>MPEG2-TS 包的包头占据了 4 字节，用于标识包的类型和其他信息。包头的字段包括：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>比特数量</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Sync Byte</td>
<td>8b</td>
<td>同步字节，固定为 0x47</td>
</tr>
<tr>
<td>Transport Error Indicator</td>
<td>1b</td>
<td>传输错误指示符，表明在 ts 头的 adapt 域后有一个无用字节，通常都为 0，这个字节算在 adapt 域⻓度内</td>
</tr>
<tr>
<td>Payload Unit Start Indicator</td>
<td>1b</td>
<td>负载单元起始标示符，一个完整的数据包开始时标记为 1</td>
</tr>
<tr>
<td>Transport Priority</td>
<td>1b</td>
<td>传输优先级，0 为低优先级，1 为⾼优先级，通常取 0</td>
</tr>
<tr>
<td><strong>PID</strong></td>
<td>13b</td>
<td>用于标识包中的数据流类型，例如音频、视频、字幕等</td>
</tr>
<tr>
<td>Transport Scrambling Contor</td>
<td>2b</td>
<td>用于指示包是否经过了加扰处理，00 表示未加密</td>
</tr>
<tr>
<td>Adaptation Field Control</td>
<td>2b</td>
<td>用于指示是否存在自适应字段，<br>‘00’保留；‘01’为⽆⾃适应域，仅含有效负载；<br>‘10’为仅含⾃适应域，⽆有效负载；<br>‘11’为同时带有⾃适应域和有效负载</td>
</tr>
<tr>
<td>Continuity Counter</td>
<td>4b</td>
<td>递增计数器，从 0-f，起始值不一定取 0，但必须是连续的，可用于检测丢失的包</td>
</tr>
</tbody></table>
<p><strong>TS 的内容是通过 PID 值来标识的，主要内容包括：PAT 表、PMT 表、音频流、视频流。</strong>PAT 表的和 PMT 表需要定期插入 TS 流，因为用户随时可能加入 TS 流，这个间隔比较小，通常每隔几个视频帧就要加入 PAT 和 PMT。PAT 和 PMT 表是必须的，还可以加入其它表如 SDT（业务描述表）等，不过 HLS 流只要有 PAT 和 PMT 就可以播放了。 </p>
<h2 id="自适应字段"><a href="#自适应字段" class="headerlink" title="自适应字段"></a>自适应字段</h2><p>Adaptation Field 报文格式：</p>
<img src="/2023/09/27/HLS%E5%8D%8F%E8%AE%AE/AdaptationField报文.png" alt="AdaptationField报文" style="zoom:50%;">

<p>自适应字段（Adaptation Field）是可选的，长度不固定，用于在需要时包含额外的控制信息。它可以包括时钟调整、加扰解除、字节对齐等信息。</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>比特数量</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Adaptation Field Length</td>
<td>8b</td>
<td>自适应域长度，后面的字节数</td>
</tr>
<tr>
<td>Discontinuity Indicator</td>
<td>1b</td>
<td>通常用于指示数据流的不连续性。如果有多个数据流，这个标志可以用于标识它们之间的切换</td>
</tr>
<tr>
<td>Random Access Indicator</td>
<td>1b</td>
<td>指示是否存在关键帧或I帧。这对于视频流中的随机访问非常重要</td>
</tr>
<tr>
<td>Elementary Stream Priority Indicator</td>
<td>1b</td>
<td>指示当前包的元素流的优先级</td>
</tr>
<tr>
<td>PCR Flag</td>
<td>1b</td>
<td>指示是否存在 PCR（Program Clock Reference）字段。PCR 用于同步多个数据流的时钟</td>
</tr>
<tr>
<td>OPCR Flag</td>
<td>1b</td>
<td>指示是否存在 OPCR（Original Program Clock Reference）字段。OPCR用于描述原始数据流的时钟</td>
</tr>
<tr>
<td>Splicing Point Flag</td>
<td>1b</td>
<td>指示当前包是否可以被拷贝，即是否可以在此处进行剪切</td>
</tr>
<tr>
<td>Transport Private Data Flag</td>
<td>1b</td>
<td>指示是否存在拷贝权标志信息</td>
</tr>
<tr>
<td>Adaptation Field Extension Flag</td>
<td>1b</td>
<td>指示是否存在自适应字段扩展</td>
</tr>
<tr>
<td>Program Clock Reference</td>
<td>48b</td>
<td>如果 PCR 标志为 1，则包含 PCR 字段，用于同步音频和视频的时钟</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
</tbody></table>
<p>自适应区的长度要包含传输错误指示符标识的一个字节。</p>
<p>打包 TS 流时 PAT 和 PMT 表是没有 adaptation field 的，<strong>不够的长度直接补 0xff 即可</strong>。视频流和音频流都需要加 adaptation field，通常加在一个帧的第一个  TS 包和最后一个 TS 包里，中间的 TS 包不加。</p>
<p>pcr 是节目时钟参考，pcr、dts、pts 都是对同一个系统时钟的采样值，pcr 是递增的，因此可以将其设置为 dts 值，音频数据不需要 pcr。如果没有字段，ipad 是可以播放的，但 vlc 无法播放。</p>
<h2 id="有效负载"><a href="#有效负载" class="headerlink" title="有效负载"></a>有效负载</h2><p>有效负载（Payload）包含了音频、视频、字幕等媒体数据。有效负载的长度可以根据包头中的信息变化，通常为 0 到 184 字节。有效负载的具体格式取决于所传输的内容和编码方式。<strong>在解析 MPEG-TS 流时，需要根据 PID（Packet Identifier）字段中的标识来确定有效负载的类型，并使用相应的解码器来解析数据。</strong>不同的 PID 值对应不同的数据流类型，例如音频、视频、字幕等。</p>
<h3 id="PAT"><a href="#PAT" class="headerlink" title="PAT"></a>PAT</h3><p>PAT 报文格式：</p>
<img src="/2023/09/27/HLS%E5%8D%8F%E8%AE%AE/PAT报文.png" alt="PAT报文" style="zoom:50%;">

<p><strong>TS 包头中的 PID 值为 0x0，表示当前负载为 PAT（Program Association Table）。</strong>PAT 数据的信息可以理解为整个 TS 流包含的节目信息。</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>比特数量</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Table ID</td>
<td>8b</td>
<td>PAT 表固定为 0x00</td>
</tr>
<tr>
<td>Syntax indicator</td>
<td>1b</td>
<td>固定为 1</td>
</tr>
<tr>
<td>Reserverd</td>
<td>3b</td>
<td>固定为 011</td>
</tr>
<tr>
<td>Length</td>
<td>12b</td>
<td>后面数据的长度</td>
</tr>
<tr>
<td>Transport Stream Id</td>
<td>16b</td>
<td>传输流 ID，固定为 0x0001</td>
</tr>
<tr>
<td>Reserved</td>
<td>2b</td>
<td>固定为 11</td>
</tr>
<tr>
<td>Version Number</td>
<td>5b</td>
<td>版本号，固定为 00000，如果 PAT 有变化则版本号加 1</td>
</tr>
<tr>
<td>Current&#x2F;Next Indicator</td>
<td>1b</td>
<td>固定为 1，表示这个 PAT 表可以用，如果为 0 则要等待下一个 PAT 表</td>
</tr>
<tr>
<td>Section Number</td>
<td>8b</td>
<td>固定为 0x00</td>
</tr>
<tr>
<td>Last Section Number</td>
<td>8b</td>
<td>固定为 0x00</td>
</tr>
<tr>
<td>开始循环</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>Program Number</strong></td>
<td>16b</td>
<td>节目号</td>
</tr>
<tr>
<td>Reserved</td>
<td>3b</td>
<td>固定为 111</td>
</tr>
<tr>
<td><strong>Program Map PID</strong></td>
<td>13b</td>
<td>节目号对应内容的 PID 值</td>
</tr>
<tr>
<td>结束循环</td>
<td></td>
<td></td>
</tr>
<tr>
<td>CRC32</td>
<td>32b</td>
<td>前面数据的 CRC32 校验码</td>
</tr>
</tbody></table>
<h3 id="PMT"><a href="#PMT" class="headerlink" title="PMT"></a>PMT</h3><p>PMT 报文格式：</p>
<img src="/2023/09/27/HLS%E5%8D%8F%E8%AE%AE/PMT报文.png" alt="PMT报文" style="zoom:50%;">

<p>PMT（Program Map Table）是 MPEG2-TS（MPEG Transport Stream）中的一种表格，用于描述一个或多个节目的组成，包括音频、视频、字幕等多个元素的信息。PMT 表格的主要作用是告诉接收设备如何解析和处理特定节目的数据流。以下是 PMT 表格的基本格式：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>比特数量</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Table Id</td>
<td>8b</td>
<td>PMT 表取值随意，0x02</td>
</tr>
<tr>
<td>Syntax Indicator</td>
<td>1b</td>
<td>固定为 1</td>
</tr>
<tr>
<td>Reserved</td>
<td>2b</td>
<td>固定为 011</td>
</tr>
<tr>
<td>Length</td>
<td>12b</td>
<td>后面数据的长度</td>
</tr>
<tr>
<td>Program Number</td>
<td>16b</td>
<td>频道号码，表示当前的 PMT 关联到的频道，取值 0x0001</td>
</tr>
<tr>
<td>Reserved</td>
<td>2b</td>
<td>固定为 11</td>
</tr>
<tr>
<td>Version Number</td>
<td>5b</td>
<td>版本号，固定为 00000，如果 PAT 有变化则版本号加 1</td>
</tr>
<tr>
<td>Current&#x2F;Next Indicator</td>
<td>1b</td>
<td>固定为1</td>
</tr>
<tr>
<td>Section Number</td>
<td>8b</td>
<td>固定为 0x00</td>
</tr>
<tr>
<td>Last Section Number</td>
<td>8b</td>
<td>固定为 0x00</td>
</tr>
<tr>
<td>Reserved</td>
<td>3b</td>
<td>固定为 111</td>
</tr>
<tr>
<td><strong>PCR_PID</strong></td>
<td>13b</td>
<td>PCR（节目参考时钟）所在 TS 分组的 PID，指定为视频 PID</td>
</tr>
<tr>
<td>Reserved</td>
<td>4b</td>
<td>固定为 1111</td>
</tr>
<tr>
<td>Program Info Length</td>
<td>12b</td>
<td>节目描述信息，指定为0x000表示没有</td>
</tr>
<tr>
<td>开始循环</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Stream type</td>
<td>8b</td>
<td>流类型，标志是 Video 还是 Audio 还是其他数据，h.264 编码对应 0x1b，aac 编码对应 0x0f，mp3 编码对应 0x03</td>
</tr>
<tr>
<td>Reserved</td>
<td>3b</td>
<td>固定为 111</td>
</tr>
<tr>
<td><strong>Elementary PID</strong></td>
<td>13b</td>
<td>与 Stream type 对应的 PID</td>
</tr>
<tr>
<td>Reserved</td>
<td>4b</td>
<td>固定为 1111</td>
</tr>
<tr>
<td>ES info length</td>
<td>12b</td>
<td>描述信息，指定为 0x000 表示没有</td>
</tr>
<tr>
<td>结束循环</td>
<td></td>
<td></td>
</tr>
<tr>
<td>CRC32</td>
<td>32b</td>
<td>前面数据的 CRC32 校验码</td>
</tr>
</tbody></table>
<h3 id="PES"><a href="#PES" class="headerlink" title="PES"></a>PES</h3><p><strong>PES（Packetized Elementary Stream）用于传输和存储音频、视频和其他媒体数据。</strong>PES 将媒体数据分成小包，每个包包含了媒体数据及其相关信息，使其易于传输和解析。以下是 PES 包头的基本格式：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>比特数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Prefix</td>
<td>24b</td>
<td>PES 包起始码，通常为 0x000001</td>
</tr>
<tr>
<td>Stream</td>
<td>8b</td>
<td>PES 包所包含数据类型，如视频为 0xe0</td>
</tr>
<tr>
<td>Length</td>
<td>16b</td>
<td>指示 PES 包的长度，包含包头、扩展头和有效负载</td>
</tr>
<tr>
<td>10</td>
<td>2b</td>
<td>固定为二进制 10，标志 PES 包头结束，实际数据开始</td>
</tr>
<tr>
<td>Scrambling Control</td>
<td>2b</td>
<td>表示对 PES 包进行加扰控制</td>
</tr>
<tr>
<td>priority</td>
<td>1b</td>
<td>优先级标识位</td>
</tr>
<tr>
<td>Data Alignment</td>
<td>1b</td>
<td>数据对齐标志位，指示包头的结束位置</td>
</tr>
<tr>
<td>Copyright</td>
<td>1b</td>
<td>版权标志</td>
</tr>
<tr>
<td>Original</td>
<td>1b</td>
<td>表示数据的原始性</td>
</tr>
<tr>
<td>PTS Flag</td>
<td>1b</td>
<td>是否包含 PTS 字段</td>
</tr>
<tr>
<td>DTS Flag</td>
<td>1b</td>
<td>是否包含 DTS 字段</td>
</tr>
<tr>
<td>ESCR Flag</td>
<td>1b</td>
<td>是否包含 ESCR 字段</td>
</tr>
<tr>
<td>ES Rate Flag</td>
<td>1b</td>
<td>是否包含 ES Rate 字段</td>
</tr>
<tr>
<td>DSM Trick Model Flag</td>
<td>1b</td>
<td>是否包含 Additional Copy Info 字段</td>
</tr>
<tr>
<td>Additional Copy Info Flag</td>
<td>1b</td>
<td>是否包含 DSM Trick Mode 字段</td>
</tr>
<tr>
<td>CRC Flag</td>
<td>1b</td>
<td>是否包含 CRC 字段</td>
</tr>
<tr>
<td>Extension Flag</td>
<td>1b</td>
<td>是否包含扩展头字段</td>
</tr>
<tr>
<td>Header Data Length</td>
<td>8b</td>
<td>PES 包头数据的长度，包括可选的扩展头</td>
</tr>
</tbody></table>
<h1 id="HTTP-协议"><a href="#HTTP-协议" class="headerlink" title="HTTP 协议"></a>HTTP 协议</h1><p>参考：<a target="_blank" rel="noopener" href="https://www.kancloud.cn/spirit-ling/http-study/636182">https://www.kancloud.cn/spirit-ling/http-study/636182</a></p>
<p>参考链接：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/rell336/article/details/38109621">https://blog.csdn.net/rell336/article/details/38109621</a> </p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/rongdeguoqian/article/details/18214627">https://blog.csdn.net/rongdeguoqian/article/details/18214627</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/09/27/HLS%E7%AE%80%E4%BB%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/09/27/HLS%E7%AE%80%E4%BB%8B/" class="post-title-link" itemprop="url">HLS简介</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-27 20:26:58" itemprop="dateCreated datePublished" datetime="2023-09-27T20:26:58+08:00">2023-09-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-08 15:10:47" itemprop="dateModified" datetime="2024-01-08T15:10:47+08:00">2024-01-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Protocol/" itemprop="url" rel="index"><span itemprop="name">Protocol</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="SRC-流媒体服务器"><a href="#SRC-流媒体服务器" class="headerlink" title="SRC 流媒体服务器"></a>SRC 流媒体服务器</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p><strong>编译</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/ossrs/srs.git</span><br><span class="line">cd srs/trunk</span><br><span class="line">./configure &amp;&amp; make</span><br></pre></td></tr></table></figure>

<p><strong>配置文件</strong></p>
<p><code>conf/srs.conf</code></p>
<p><strong>启动</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./objs/srs -c conf/srs.conf</span><br></pre></td></tr></table></figure>

<p><strong>日志</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail -n 30 -f ./objs/srs.log</span><br></pre></td></tr></table></figure>

<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p><strong>推流</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -re -i test.mp4 -codec copy -f flv -y rtmp://127.0.0.1:1935/live/test</span><br></pre></td></tr></table></figure>

<p>默认情况下srs的rtmp采用1935端口。</p>
<p><strong>拉流</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">HLS</span></span><br><span class="line">ffplay http://127.0.0.1:8080/live/test.m3u8</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">RTMP</span></span><br><span class="line">ffplay rtmp://127.0.0.1/live/live/test</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">HTTP FLV</span></span><br><span class="line">ffplay http://127.0.0.1:8080/live/test.flv</span><br></pre></td></tr></table></figure>

<p>SRC播放器：<a target="_blank" rel="noopener" href="http://ossrs.net/srs.release/trunk/research/players/srs_player.html">http://ossrs.net/srs.release/trunk/research/players/srs_player.html</a> </p>
<h1 id="HLS-框架"><a href="#HLS-框架" class="headerlink" title="HLS 框架"></a>HLS 框架</h1><img src="/2023/09/27/HLS%E7%AE%80%E4%BB%8B/HLS框架.png" alt="HLS框架" style="zoom:50%;">

<img src="/2023/09/27/HLS%E7%AE%80%E4%BB%8B/HLS流程.png" alt="HLS流程" style="zoom:50%;">

<h2 id="HLS-简介"><a href="#HLS-简介" class="headerlink" title="HLS 简介"></a>HLS 简介</h2><p>HLS 协议由三部分组成：HTTP、M3U8、TS。这三部分中，<strong>HTTP 是传输协议，M3U8 是索引文件，TS 是音视频的媒体信息。</strong></p>
<ul>
<li><strong>索引文件采用扩展的 M3U 播放列表格式，后缀名为 .m3u8。</strong> M3U 播放列表是一个由若干文本行组成的文本文件，其中每一行要么是一个 URI，一个空行，或者是一个以注释符“#”起始的行。每个 URI 行指向一个分段的媒体文件，或者一个衍生的索引（播放列表）文件。除了以“#EXT”起始的行是标签行外，其他以“#”起始的行是注释，应予忽略。</li>
<li><strong>TS 文件中必须仅包含一个 MPEG-2 节目，在每个文件的开头应包含一个节目关联表（PAT）和一个节目映射表（PMT）</strong>，包含视频的文件中还必须含有至少一个关键帧和其他足够信息（如序列头）用以完成解码器的初始化。</li>
</ul>
<h2 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h2><p>服务器部分负责将输入的音视频媒体内容转换成为适合于内容分发组件进行递送的格式。</p>
<ul>
<li>Media Encoder：<ul>
<li><strong>编码器首先将摄像机实时采集的音视频数据压缩编码为符合特定标准的音视频基本流（例如 H264 视频和 AAC 音频），然后再复用和封装成为符合 MPEG-2 系统层标准的传输流（TS）格式进行输出。</strong></li>
<li>之所以采用 MPEG-2 TS 格式来对编码后的媒体流进行统一封装，是因为它能够将音视频媒体流严格按时序进行交织复用，<strong>任意截取和分段后，每一个分段都可能不依赖于之前的分段而独立进行解码和播放。</strong></li>
</ul>
</li>
<li>Stream Segmenter：<ul>
<li><strong>流分割器负责将编码器输出的 MPEG-2 TS 流分割为一系列连续的、长度均等的小 TS 文件（后缀名为.ts），并依次发送至内容分发组件中的 Web 服务器进行存储。</strong></li>
<li>与此同时，为了跟踪播放过程中媒体文件的可用性和当前位置，流分割器还需创建一个含有指向这些小 TS 文件指针的<strong>索引文件</strong>，同样放置于 Web 服务器之中。</li>
<li><strong>对于视频直播</strong>：这个索引文件可以看作是一个连续媒体流中的播放列表滑动窗口，<strong>每当流分割器生成一个新的 TS 文件时，这个索引文件的内容也被更新，新的文件 URI 加入到滑动窗口的末尾，老的文件 URI 则被移去</strong>，这样索引文件中将始终包含最新的固定数量的x个分段。</li>
<li><strong>对于视频点播</strong>：与直播型会话不同的是，<strong>索引文件是一个不随时间而更新的静态文件</strong>，其中包含一个节目从头到尾所有分段文件的URI列表，并以<code>#EXT-X-ENDLIST</code>标签结尾。</li>
<li>流分割器还可以对其生成的每个小 TS 文件进行加密，并生生成相应的密钥文件。</li>
</ul>
</li>
</ul>
<h2 id="内容分发"><a href="#内容分发" class="headerlink" title="内容分发"></a>内容分发</h2><p>内容分发系统用于通过 HTTP 协议将分割后的小媒体文件及其索引文件递送至客户端播放器，它既可以是一个<strong>普通的 Web 服务器</strong>，也可以是一个 Web 缓存系统。几乎不需要对 Web 服务器做任何特殊的配置，以及增加其他定制的模块。推荐的配置仅限于对 .m3u8 文件和 .ts 文件的 MIME 类型关联，如表所示。 </p>
<table>
<thead>
<tr>
<th>文件扩展名</th>
<th>MIME类型</th>
</tr>
</thead>
<tbody><tr>
<td>.m3u8</td>
<td>application&#x2F;x-mpegURL或vnd.apple.mpegURL</td>
</tr>
<tr>
<td>.ts</td>
<td>video&#x2F;MP2T</td>
</tr>
</tbody></table>
<p>由于索引文件需要频繁更新和下载，因此在 Web Cache 的配置中有必要对 .m3u8 文件的 TTL（time-to-live） 值进行微调以保证客户端每次请求该文件时都能够下载到它的最新版本。 </p>
<h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><ul>
<li>通常情况下，客户端软件通过访问 Web 网页中的 URL 链接来获取和下载<strong>一个流媒体会话的索引文件</strong>。这个索引文件进一步指定了服务器上当前可用的 TS 格式媒体文件、解密密钥和其他替换流的位置。</li>
<li>对于选定的媒体流，客户端依次下载索引文件中列出的每一个可用媒体文件。<strong>当这些媒体文件缓冲够一定数量后，客户端将它们按顺序重新拼装成一个连贯的 TS 流，然后发送至播放器进行解码和呈现</strong>。</li>
<li>对于加密的媒体文件，客户端还负责根据索引文件的指引来获取解密密钥，提供用户认证接口，并按需进行解密。对于视频点播，上述过程不断持续下去，直到客户端碰到索引文件中的<code>#EXT-X-ENDLIST</code>标签。</li>
<li>对于视频直播，索引文件中不存在<code>#EXT-X-ENDLIST</code>标签，客户端将周期性地向 Web 服务器重新请求获取该索引文件的更新版本，然后在这个更新版的索引文件中查找新的媒体文件和解密密钥，并将它们的 URI  添加至下载队列的末尾。</li>
<li>HTTP Live Streaming 并不是一个真正实时的流媒体系统，这是因为对应于媒体分段的大小和持续时间有一定潜在的时间延迟。在客户端中，至少在一个分段媒体文件被完全下载之后才能够开始播放，而<strong>通常要求下载完成两个分段媒体文件之后才开始播放以保证不同分段音视频之间的无缝连接</strong>。</li>
<li>此外，在客户端开始下载之前，必须等待服务器端的编码器和流分割器至少生成一个 TS 文件，这也会带来潜在的时延。</li>
</ul>
<h2 id="网络自适应的流间切换和故障保护"><a href="#网络自适应的流间切换和故障保护" class="headerlink" title="网络自适应的流间切换和故障保护"></a>网络自适应的流间切换和故障保护</h2><ul>
<li><p>在基于 HTTP Live Streaming 的流媒体系统中，<strong>服务器可以为同一节目源准备多份以不同码率和质量编码的替换流</strong>，并为每个替换流都生成一个衍生的索引文件。在主索引文件中通过包含一系列指向其他衍生索引文件的URI指针来找到相应的替换流。</p>
</li>
<li><p>此时客户端软件可根据网络和带宽的变化情况随时切换到不同衍生索引文件所指向的替换流进行下载，<strong>从而自适应地为用户提供相应网络条件下接近最优的音视频 QoS 体验</strong>。上述替换流和衍生索引文件机制除了可以用于基于带宽波动的动态流间切换外，还可以用于服务器的故障保护。为此目的，首先在一台服务器上按照正常流程生成一个媒体流或者多个替换流，以及对应的索引文件，然后再在另一台服务器上生成一套并行的备份媒体流和索引文件。<strong>接下来将指向备份流的索引加入到主索引文件之中，使得其中针对每个带宽值都对应有一个主媒体流和一个备份媒体流</strong>。</p>
</li>
<li><p>相对于常见的流媒体直播协议，例如 RTMP 协议、 RTSP 协议、 MMS 协议等， HLS 直播最大的不同在于，直播客户端获取到的，并不是一个完整的数据流。<strong>HLS 协议在服务器端将直播数据流存储为连续的、很短时长的媒体文件</strong>（MPEG-TS格式），而客户端则不断的下载并播放这些小文件，因为服务器端总是会将最新的直播数据生成新的小文件，这样客户端只要不停的按顺序播放从服务器获取到的文件，就实现了直播。由此可见，基本上可以认为，<strong>HLS 是以点播的技术方式来实现直播</strong>。由于数据通过 HTTP 协议传输，所以完全不用考虑防火墙或者代理的问题，而且分段文件的时长很短，客户端可以很快的选择和切换码率，以适应不同带宽条件下的播放。不过 HLS 的这种技术特点，决定了它的延迟一般总是会高于普通的流媒体直播协议。</p>
</li>
</ul>
<h1 id="HLS-协议"><a href="#HLS-协议" class="headerlink" title="HLS 协议"></a>HLS 协议</h1><ul>
<li><p>作为 Apple 提出的一种基于 HTTP 的协议，HLS（HTTP Live Streaming）用于解决实时音视频流的传输。尤其是在移动端，由于 iOS&#x2F;H5 不支持 flash，使得 HLS 成了移动端实时视频流传输的首选。</p>
</li>
<li><p>HLS（HTTP Live Streaming） 把整个流分成一个个小的基于 HTTP 的文件来下载，每次只下载一些。HLS 协议由三部分组成：HTTP、M3U8、TS。这三部分中，<strong>HTTP 是传输协议，M3U8 是索引文件，TS 是音视频的媒体信息</strong>。</p>
</li>
<li><p>HLS 是提供一个 M3U8 地址，<strong>Apple 的 Safari 浏览器直接就能打开 M3U8 地址</strong>；Android 不能直接打开，需要使用 HTML5 的 video 标签，然后在浏览器中打开这个页面即可：</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- livestream.html --&gt;</span><br><span class="line">&lt;video width=&quot;640&quot; height=&quot;360&quot;</span><br><span class="line">		autoplay controls autobuffer</span><br><span class="line">		src=&quot;http://127.0.0.1:8080/live/test.m3u8&quot;</span><br><span class="line">		type=&quot;application/vnd.apple.mpegurl&quot;&gt;</span><br><span class="line">&lt;/video&gt;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/09/23/RTCP%E5%8D%8F%E8%AE%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/09/23/RTCP%E5%8D%8F%E8%AE%AE/" class="post-title-link" itemprop="url">RTCP协议</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-23 08:58:02" itemprop="dateCreated datePublished" datetime="2023-09-23T08:58:02+08:00">2023-09-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-12-30 22:38:22" itemprop="dateModified" datetime="2023-12-30T22:38:22+08:00">2023-12-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Protocol/" itemprop="url" rel="index"><span itemprop="name">Protocol</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="RTCP介绍"><a href="#RTCP介绍" class="headerlink" title="RTCP介绍"></a>RTCP介绍</h1><p>RTCP（Real-time Transport Control Protocol）是用于控制和监视实时多媒体会话的协议。它是RTP（Real-time Transport Protocol）的伴随协议，通常与RTP一起用于音频和视频会话。RTCP的主要目的是提供会话质量反馈、参与者识别、会话信息维护以及带宽管理等功能。</p>
<h1 id="RTCP报⽂格式"><a href="#RTCP报⽂格式" class="headerlink" title="RTCP报⽂格式"></a>RTCP报⽂格式</h1><h2 id="报⽂类型"><a href="#报⽂类型" class="headerlink" title="报⽂类型"></a>报⽂类型</h2><p>有5种RTCP报告⽤来报告当前控制信息：</p>
<table>
<thead>
<tr>
<th>Packet Type值</th>
<th>分组类型</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>200</td>
<td>SR（Sender report）</td>
<td>发送⽅报告</td>
</tr>
<tr>
<td>201</td>
<td>RR（Receiver report）</td>
<td>接收⽅报告</td>
</tr>
<tr>
<td>202</td>
<td>SDES（Source description）</td>
<td>源描述报告</td>
</tr>
<tr>
<td>203</td>
<td>BYE（Goodbye）</td>
<td>离开会话</td>
</tr>
<tr>
<td>204</td>
<td>APP（Application-defined）</td>
<td>应⽤定义</td>
</tr>
</tbody></table>
<p>RTCP的5种报告：RR，SR，SDES，BYE和APP。他们使⽤共同的结构，但是在某些具体的地⽅有⼀些不同。以下是RTCP报⽂共同结构： </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> 0                   1                   2                   3</span><br><span class="line"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|V=2|P|    RC   |       PT      |             Length            |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure>

<ul>
<li><code>V</code>（Version）：2bits，协议版本。通常设置为2。</li>
<li><code>P</code>（Padding）：1bit，指示是否使用填充（Padding）。通常设置为0；如果填充位被设置为1，则⼀个或多个附加的字节会加在包头的最后，附加的最后⼀个字节放置附加的字节数。</li>
<li><code>RC</code>（Report Count）：5bits，表示RTCP报告中的报告块数量。</li>
<li><code>PT</code>（Packet Type）：8bits，指定RTCP消息的类型，在RTP标准中定义了5种类型：RR，SR，SDES，BYE和APP。 </li>
<li><code>Length</code>：16bits，RTCP消息的长度，以32位字（32-bit words）为单位。</li>
</ul>
<h2 id="SR报⽂格式"><a href="#SR报⽂格式" class="headerlink" title="SR报⽂格式"></a>SR报⽂格式</h2><p>SR（Sender Report）数据包是RTCP（Real-time Transport Control Protocol）中的一种消息类型，用于发送方向会话参与者提供有关自身的信息。以下是SR数据包的格式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> 0                   1                   2                   3</span><br><span class="line"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|V=2|P|    RC   |   PT=SR=200   |             Length            |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                     SSRC of Packet Sender                     |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|              NTP Timestamp (High 32 bits)                     |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|              NTP Timestamp (Low 32 bits)                      |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|              RTP Timestamp                                    |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|           Sender&#x27;s Packet Count                               |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|           Sender&#x27;s Octet Count                                |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">| Report Block 1 (optional)                                     |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">| Report Block 2 (optional)                                     |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SSRC of Packet Sender</code>：发送SR数据包的同步信源标识符（SSRC）。</li>
<li><code>NTP Timestamp</code>：以64位形式表示的NTP（Network Time Protocol）时间戳，分为高32位和低32位；该时间戳的⾼32 bites以NTP格式表示，从1900年1⽉1⽇开始计数，以秒为单位。低32 bites表示秒后⾯的⼩数。</li>
<li><code>RTP Timestamp</code>：RTP时间戳（以RTP媒体流的时钟为单位），用于同步RTP数据包的时间。</li>
<li><code>Sender&#39;s Packet Count</code>：发送方发送的RTP数据包数量。</li>
<li><code>Sender&#39;s Octet Count</code>：发送方发送的字节数（octets），如果发送者改变了SSRC会被重置。</li>
</ul>
<p><strong>SR报⽂的实例</strong></p>
<img src="/2023/09/23/RTCP%E5%8D%8F%E8%AE%AE/SR报文.png" alt="SR报文" style="zoom:50%;">

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/09/22/SDP%E5%8D%8F%E8%AE%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/09/22/SDP%E5%8D%8F%E8%AE%AE/" class="post-title-link" itemprop="url">SDP协议</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-22 20:37:35" itemprop="dateCreated datePublished" datetime="2023-09-22T20:37:35+08:00">2023-09-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-10 11:59:22" itemprop="dateModified" datetime="2024-01-10T11:59:22+08:00">2024-01-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Protocol/" itemprop="url" rel="index"><span itemprop="name">Protocol</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="SDP-介绍"><a href="#SDP-介绍" class="headerlink" title="SDP 介绍"></a>SDP 介绍</h1><p>SDP（Session Description Protocol） 完全是<strong>一种会话描述格式</strong>，它<strong>不属于传输协议</strong>，只使用不同的适当的传输协议，包括会话通知协议（SAP）、会话初始协议（SIP）、实时流协议（RTSP）、MIME 扩展协议的电子邮件以及超文本传输协议（HTTP）。SDP 协议是也是基于文本的协议，这样就能保证协议的可扩展性⽐较强，这样就使其具有⼴泛的应用范围。SDP 不支持会话内容或媒体编码的协商，所以在流媒体中只用来描述媒体信息。</p>
<h1 id="SDP-格式"><a href="#SDP-格式" class="headerlink" title="SDP 格式"></a>SDP 格式</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;type&gt;=&lt;value&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>&lt;type&gt;</code>：大小写敏感的一个字符，代表特定的属性，⽐如 v 代表版本。</p>
</li>
<li><p><code>&lt;value&gt;</code>：结构化文本，格式与属性类型有关，UTF8 编码。</p>
</li>
<li><p><code>=</code> 两边不允许存在空格。</p>
</li>
</ul>
<h2 id="必需字段"><a href="#必需字段" class="headerlink" title="必需字段"></a>必需字段</h2><ul>
<li>v&#x3D;（协议版本号），一个会话描述的开始，前一个会话结束标志。</li>
<li>o&#x3D;（会话源或者会话生成者，以及会话标识符）。</li>
<li>s&#x3D;（会话名称）这个字段是个文本字符串，可以显示给会话参与者。</li>
<li>t&#x3D;（会话时间）这个字段指明会话开始时间与结束时间。</li>
<li>m&#x3D;（媒体）该字段用来指明媒体类型、数据应该发送到的传输端口，传输协议（例如 RTP）以及媒体格式（例如 RTP 负载格式）。</li>
</ul>
<h2 id="可选字段"><a href="#可选字段" class="headerlink" title="可选字段"></a>可选字段</h2><p>SDP 可选字段中，一些只能应用于会话级，一些只能应用于媒体级，还有一些可以应用于两种级别。对于应用于两种级别的字段，在某个具体媒体上，<strong>应用于媒体级的字段会覆盖应用于会话级的字段值</strong>。例如，某个字段其会话级的字段值为 X，媒体1的该字段值为 Y，那么值 X 应用于会话中除媒体类型 1 之外的所有媒体，而媒体 1 应用值 Y。</p>
<p>可选字段如下：</p>
<ul>
<li>i&#x3D;（会话信息）对字段的文本描述，提供了⽐会话名称更多的信息。该字段既可以用于会话级也可以用于媒体级。 </li>
<li>u&#x3D;（描述的 URI 地址）URI 信息，通过这个地址可以获取更多会话相关信息。例如，一个会议可能公布在 WEB 页面上，所以需要该 WEB 的 URI。每个会话只能提供一个 URI。</li>
<li>E&#x3D;（E-mail 地址）负责会话个体的 E-mail 地址，可以有多个。只能用于会话级别。</li>
<li>p&#x3D;（电话号码）同 email 一样，多个，会话级别。</li>
<li>c&#x3D;（连接信息）该字段提供连接数据，包括连接类型、网络类型和连接地址。可应用于会话级也可以用于媒体级。</li>
<li>b&#x3D;（带宽信息）指明带宽需求，单位 kbit&#x2F;s, 可用于两个级别。</li>
<li>r&#x3D;（重复次数）如果是有规律的日程安排活动，这个字段用来指明会话重复频次和时间。</li>
<li>z&#x3D;（时区调整）用于按日程安排的有规律活动会话。会话可能会夸时区，避免时区变更造成的混乱。</li>
<li>k&#x3D;（加密密钥）为了对媒体加密、解密，该字段提供了一个加密密钥或者规定了一个获取密钥的机制。可用于两个级别。</li>
<li>a&#x3D;（属性）用于描述会话或者某个媒体的额外属性。</li>
</ul>
<p>可选字段中，连接信息字段是特别与条件相关的。因为该字段定义了数据应发送到的网络地址，所以必须被包含进会话描述中的某个地方。 </p>
<h2 id="子字段"><a href="#子字段" class="headerlink" title="子字段"></a>子字段</h2><p>在 SDP 中许多字段采用多个子字段的形式，此时，这些字段值由多个以空格符间隔的多个值组成。格式如下：</p>
<ul>
<li>字段 名称&#x3D;&lt;子字段1的值&gt; &lt;子字段2的值&gt; &lt;子字段3的值&gt;</li>
</ul>
<p>例如：</p>
<ul>
<li>会话源（o） ：有六个子字段：用户名、会话 ID、版本、网络类型、地址类型、地址。 </li>
<li>连接信息（c）：有三个子字段：网络类型、地址类型和连接地址。同会话源中含义不同，他们表示需要接收媒体数据的网络和地址，而不是生成会话的网络和地址。</li>
<li>媒体信息（m）：有四个子字段：媒体类型、端口、传输协议、格式。</li>
</ul>
<p><strong>媒体信息</strong></p>
<p>格式： m&#x3D;(媒体)（端口）（传送层）（格式列表）。</p>
<p>媒体类型：音频、视频、应用、数据和控制。</p>
<p>端口：媒体传送层端口。</p>
<p>传送层：ip4上大多基于 rtp&#x2F;udp上传送（RTP&#x2F;AVP）IETF RTP 协议，在 udp 上传输。</p>
<p>格式列表： 对应对应的音频负载类型（PT）。</p>
<p>例子：m&#x3D;video 0 RTP&#x2F;AVP 96 </p>
<p><strong>属性</strong></p>
<p>属性有两种形式，第一种是特征属性，第⼆种属于值属性。SDP 描述了多个建议属性。 </p>
<ul>
<li><p>特征属性</p>
<ul>
<li><p>例如 a&#x3D;sendonly，表明会话描述的发送者只希望发送数据而不打算接收数据，端口号无意义，可以置为 0。 </p>
</li>
<li><p>例如 a&#x3D;recvonly，表明这个会话描述的发送者只想接收数据而不打算发送数据。</p>
</li>
</ul>
</li>
<li><p>值属性</p>
<ul>
<li><p>例如 a&#x3D;rtpmp:&lt;负载类型&gt;&lt;编码名称&gt;&#x2F;&lt;时钟速率&gt;[&lt;编码参数&gt;]</p>
</li>
<li><p>rtpmap 属性提供了一个在 VoIP 应用中的重要属性使用方法，该属性可用于媒体流，在媒体格式不是静态的RTP负载类型时特别有用。严格来说，“rtpmap”只在使用动态负载类型情况下才是必须的，例如标准的 G.711 语音是静态 RTP 负载类型，采用如下方法就可以对它完整描述：</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">m=audio 45678 RTP/AVP 0</span><br></pre></td></tr></table></figure>
</li>
<li><p>而对动态负载来说需要指定更多信息才能使远端完全识别到媒体编码，例如 16 位线性编码 16 kHz 取样的立体声音就是一个动态 RTP 负载类型，如果我们采用动态负载类型 98 表示这个媒体流，那么 SDP 格式如下：</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">m=audio 45678 RTP/AVP 98 </span><br><span class="line">a=rtpmap 98 L16/16000/2</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/09/22/RTSP%E5%8D%8F%E8%AE%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/09/22/RTSP%E5%8D%8F%E8%AE%AE/" class="post-title-link" itemprop="url">RTSP协议</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-22 18:30:32" itemprop="dateCreated datePublished" datetime="2023-09-22T18:30:32+08:00">2023-09-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-09 16:21:18" itemprop="dateModified" datetime="2024-01-09T16:21:18+08:00">2024-01-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Protocol/" itemprop="url" rel="index"><span itemprop="name">Protocol</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>RTSP（Real-Time Stream Protocol）是一种基于文本的应用层协议，在语法及一些消息参数等方面，RTSP 协议与 HTTP 协议类似。其他的关于 RTSP 的介绍后面补充吧，直接通过抓包会更加直观了解到 RTSP 协议的一个交互流程。</p>
<h1 id="推流过程"><a href="#推流过程" class="headerlink" title="推流过程"></a>推流过程</h1><h2 id="OPTION"><a href="#OPTION" class="headerlink" title="OPTION"></a>OPTION</h2><p>client-&gt;server：option 查询服务器端可用方法。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OPTIONS rtsp://192.168.2.101:554/live/test RTSP/1.0</span><br><span class="line"><span class="attribute">CSeq</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Lavf59.30.100</span><br></pre></td></tr></table></figure>

<p>server-&gt;client：回应信息的 public 头字段中包括提供的所有可用方法。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RTSP/1.0 200 OK</span><br><span class="line"><span class="attribute">CSeq</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Fri, Sep 22 2023 10:07:06 GMT</span><br><span class="line"><span class="attribute">Public</span><span class="punctuation">: </span>OPTIONS, DESCRIBE, SETUP, TEARDOWN, PLAY, PAUSE, ANNOUNCE, RECORD, SET_PARAMETER, GET_PARAMETER</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>ZLMediaKit(git hash:f69f3b3/2023-09-09T10:59:27+08:00,branch:master,build time:2023-09-19T18:24:32)</span><br></pre></td></tr></table></figure>

<h2 id="ANNOUNCE"><a href="#ANNOUNCE" class="headerlink" title="ANNOUNCE"></a>ANNOUNCE</h2><p>client-&gt;server：客户端发送媒体描述信息给服务器。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">ANNOUNCE rtsp://192.168.2.101:554/live/test RTSP/1.0</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/sdp</span><br><span class="line"><span class="attribute">CSeq</span><span class="punctuation">: </span>2</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Lavf59.30.100</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>492</span><br><span class="line"></span><br><span class="line">v=0</span><br><span class="line">o=- 0 0 IN IP4 127.0.0.1</span><br><span class="line">s=No Name</span><br><span class="line">c=IN IP4 192.168.2.101</span><br><span class="line">t=0 0</span><br><span class="line">a=tool:libavformat 59.30.100</span><br><span class="line">m=video 0 RTP/AVP 96</span><br><span class="line">b=AS:200</span><br><span class="line">a=rtpmap:96 H264/90000</span><br><span class="line">a=fmtp:96 packetization-mode=1; sprop-parameter-sets=J2QAH6xWgNg95+agICAgQA==,KO48sA==; profile-level-id=64001F</span><br><span class="line">a=control:streamid=0</span><br><span class="line">m=audio 0 RTP/AVP 97</span><br><span class="line">b=AS:128</span><br><span class="line">a=rtpmap:97 MPEG4-GENERIC/44100/2</span><br><span class="line">a=fmtp:97 profile-level-id=1;mode=AAC-hbr;sizelength=13;indexlength=3;indexdeltalength=3; config=121056E500</span><br><span class="line">a=control:streamid=1</span><br></pre></td></tr></table></figure>

<p>server-&gt;client：回应媒体描述信息，并返回了 Session ID。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RTSP/1.0 200 OK</span><br><span class="line"><span class="attribute">CSeq</span><span class="punctuation">: </span>2</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Fri, Sep 22 2023 10:07:06 GMT</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>ZLMediaKit(git hash:f69f3b3/2023-09-09T10:59:27+08:00,branch:master,build time:2023-09-19T18:24:32)</span><br><span class="line"><span class="attribute">Session</span><span class="punctuation">: </span>viBkiUQCL9ES</span><br></pre></td></tr></table></figure>

<h2 id="SETUP"><a href="#SETUP" class="headerlink" title="SETUP"></a>SETUP</h2><p>client-&gt;server：通过 Transport 头字段列出可接受的传输选项，请求建立会话。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SETUP rtsp://192.168.2.101:554/live/test/streamid=0 RTSP/1.0</span><br><span class="line"><span class="attribute">Transport</span><span class="punctuation">: </span>RTP/AVP/UDP;unicast;client_port=31196-31197;mode=record</span><br><span class="line"><span class="attribute">CSeq</span><span class="punctuation">: </span>3</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Lavf59.30.100</span><br><span class="line"><span class="attribute">Session</span><span class="punctuation">: </span>viBkiUQCL9ES</span><br></pre></td></tr></table></figure>

<p>server-&gt;client：建立会话，通过 Transport 头字段返回选择的具体转输选项，并返回建立的 Session ID。并且看到对于 RTP 端口通信 31196-&gt;33150；对于 RTCP 端口通信 31197-&gt;33151。 </p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RTSP/1.0 200 OK</span><br><span class="line"><span class="attribute">CSeq</span><span class="punctuation">: </span>3</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Fri, Sep 22 2023 10:07:06 GMT</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>ZLMediaKit(git hash:f69f3b3/2023-09-09T10:59:27+08:00,branch:master,build time:2023-09-19T18:24:32)</span><br><span class="line"><span class="attribute">Session</span><span class="punctuation">: </span>viBkiUQCL9ES</span><br><span class="line"><span class="attribute">Transport</span><span class="punctuation">: </span>RTP/AVP/UDP;unicast;client_port=31196-31197;mode=record;server_port=33150-33151;ssrc=00000000</span><br></pre></td></tr></table></figure>

<p>对于另一个 streamid&#x3D;1 也是一样的：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SETUP rtsp://192.168.2.101:554/live/test/streamid=1 RTSP/1.0</span><br><span class="line"><span class="attribute">Transport</span><span class="punctuation">: </span>RTP/AVP/UDP;unicast;client_port=31198-31199;mode=record</span><br><span class="line"><span class="attribute">CSeq</span><span class="punctuation">: </span>4</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Lavf59.30.100</span><br><span class="line"><span class="attribute">Session</span><span class="punctuation">: </span>viBkiUQCL9ES</span><br></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RTSP/1.0 200 OK</span><br><span class="line"><span class="attribute">CSeq</span><span class="punctuation">: </span>4</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Fri, Sep 22 2023 10:07:06 GMT</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>ZLMediaKit(git hash:f69f3b3/2023-09-09T10:59:27+08:00,branch:master,build time:2023-09-19T18:24:32)</span><br><span class="line"><span class="attribute">Session</span><span class="punctuation">: </span>viBkiUQCL9ES</span><br><span class="line"><span class="attribute">Transport</span><span class="punctuation">: </span>RTP/AVP/UDP;unicast;client_port=31198-31199;mode=record;server_port=31888-31889;ssrc=00000000</span><br></pre></td></tr></table></figure>

<h2 id="RECORD"><a href="#RECORD" class="headerlink" title="RECORD"></a>RECORD</h2><p>client-&gt;server：请求发送数据。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RECORD rtsp://192.168.2.101:554/live/test RTSP/1.0</span><br><span class="line"><span class="attribute">Range</span><span class="punctuation">: </span>npt=0.000-</span><br><span class="line"><span class="attribute">CSeq</span><span class="punctuation">: </span>5</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Lavf59.30.100</span><br><span class="line"><span class="attribute">Session</span><span class="punctuation">: </span>viBkiUQCL9ES</span><br></pre></td></tr></table></figure>

<p>client-&gt;server：回应该允许的信息。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RTSP/1.0 200 OK</span><br><span class="line"><span class="attribute">CSeq</span><span class="punctuation">: </span>5</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Fri, Sep 22 2023 10:07:06 GMT</span><br><span class="line"><span class="attribute">RTP-Info</span><span class="punctuation">: </span>url=rtsp://192.168.2.101:554/live/test/streamid=0,url=rtsp://192.168.2.101:554/live/test/streamid=1</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>ZLMediaKit(git hash:f69f3b3/2023-09-09T10:59:27+08:00,branch:master,build time:2023-09-19T18:24:32)</span><br><span class="line"><span class="attribute">Session</span><span class="punctuation">: </span>viBkiUQCL9ES</span><br></pre></td></tr></table></figure>

<h2 id="RTP-数据推送"><a href="#RTP-数据推送" class="headerlink" title="RTP 数据推送"></a>RTP 数据推送</h2><img src="/2023/09/22/RTSP%E5%8D%8F%E8%AE%AE/RTP报文.png" alt="RTP报文" style="zoom:50%;">

<h2 id="TERDOWN"><a href="#TERDOWN" class="headerlink" title="TERDOWN"></a>TERDOWN</h2><p>client-&gt;server：请求关闭会话。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TEARDOWN rtsp://192.168.2.101:554/live/test RTSP/1.0</span><br><span class="line"><span class="attribute">CSeq</span><span class="punctuation">: </span>6</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Lavf59.30.100</span><br><span class="line"><span class="attribute">Session</span><span class="punctuation">: </span>viBkiUQCL9ES</span><br></pre></td></tr></table></figure>

<p>server-&gt;client：回应该请求，200 正常关闭。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RTSP/1.0 200 OK</span><br><span class="line"><span class="attribute">CSeq</span><span class="punctuation">: </span>6</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Fri, Sep 22 2023 10:07:10 GMT</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>ZLMediaKit(git hash:f69f3b3/2023-09-09T10:59:27+08:00,branch:master,build time:2023-09-19T18:24:32)</span><br><span class="line"><span class="attribute">Session</span><span class="punctuation">: </span>viBkiUQCL9ES</span><br></pre></td></tr></table></figure>

<h1 id="拉流过程"><a href="#拉流过程" class="headerlink" title="拉流过程"></a>拉流过程</h1><h2 id="OPTION-1"><a href="#OPTION-1" class="headerlink" title="OPTION"></a>OPTION</h2><p>client-&gt;server：查询哪些方法可用。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OPTIONS rtsp://192.168.2.101:554/live/test RTSP/1.0</span><br><span class="line"><span class="attribute">CSeq</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Lavf59.30.100</span><br></pre></td></tr></table></figure>

<p>server-&gt;client：回应信息的 public 头字段中包括提供的所有可用方法。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RTSP/1.0 200 OK</span><br><span class="line"><span class="attribute">CSeq</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Fri, Sep 22 2023 11:19:53 GMT</span><br><span class="line"><span class="attribute">Public</span><span class="punctuation">: </span>OPTIONS, DESCRIBE, SETUP, TEARDOWN, PLAY, PAUSE, ANNOUNCE, RECORD, SET_PARAMETER, GET_PARAMETER</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>ZLMediaKit(git hash:f69f3b3/2023-09-09T10:59:27+08:00,branch:master,build time:2023-09-19T18:24:32)</span><br></pre></td></tr></table></figure>

<h2 id="DESCRIBE"><a href="#DESCRIBE" class="headerlink" title="DESCRIBE"></a>DESCRIBE</h2><p>client-&gt;server：要求得到服务提供的媒体描述信息。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DESCRIBE rtsp://192.168.2.101:554/live/test RTSP/1.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>application/sdp</span><br><span class="line"><span class="attribute">CSeq</span><span class="punctuation">: </span>2</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Lavf59.30.100</span><br></pre></td></tr></table></figure>

<p>server-&gt;client：回应媒体描述信息，一般是 sdp 信息。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">RTSP/1.0 200 OK</span><br><span class="line"><span class="attribute">Content-Base</span><span class="punctuation">: </span>rtsp://192.168.2.101:554/live/test/</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>589</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/sdp</span><br><span class="line"><span class="attribute">CSeq</span><span class="punctuation">: </span>2</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Fri, Sep 22 2023 11:19:53 GMT</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>ZLMediaKit(git hash:f69f3b3/2023-09-09T10:59:27+08:00,branch:master,build time:2023-09-19T18:24:32)</span><br><span class="line"><span class="attribute">Session</span><span class="punctuation">: </span>CdplhrJIUmWx</span><br><span class="line"><span class="attribute">x-Accept-Dynamic-Rate</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">x-Accept-Retransmit</span><span class="punctuation">: </span>our-retransmit</span><br><span class="line"></span><br><span class="line">v=0</span><br><span class="line">o=- 0 0 IN IP4 0.0.0.0</span><br><span class="line">s=Streamed by ZLMediaKit(git hash:f69f3b3/2023-09-09T10:59:27+08:00,branch:master,build time:2023-09-19T18:24:32)</span><br><span class="line">c=IN IP4 0.0.0.0</span><br><span class="line">t=0 0</span><br><span class="line">a=range:npt=now-</span><br><span class="line">a=control:*</span><br><span class="line">m=video 0 RTP/AVP 96</span><br><span class="line">b=AS:200</span><br><span class="line">a=fmtp:96 packetization-mode=1; sprop-parameter-sets=J2QAH6xWgNg95+agICAgQA==,KO48sA==; profile-level-id=64001F</span><br><span class="line">a=rtpmap:96 H264/90000</span><br><span class="line">a=control:streamid=0</span><br><span class="line">m=audio 0 RTP/AVP 97</span><br><span class="line">b=AS:128</span><br><span class="line">a=fmtp:97 profile-level-id=1;mode=AAC-hbr;sizelength=13;indexlength=3;indexdeltalength=3; config=121056E500</span><br><span class="line">a=rtpmap:97 MPEG4-GENERIC/44100/2</span><br><span class="line">a=control:streamid=1</span><br></pre></td></tr></table></figure>

<h2 id="SETUP-1"><a href="#SETUP-1" class="headerlink" title="SETUP"></a>SETUP</h2><p>client-&gt;server：通过 Transport 头字段列出可接受的传输选项，请求建立会话。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SETUP rtsp://192.168.2.101:554/live/test/streamid=0 RTSP/1.0</span><br><span class="line"><span class="attribute">Transport</span><span class="punctuation">: </span>RTP/AVP/UDP;unicast;client_port=32316-32317</span><br><span class="line"><span class="attribute">x-Dynamic-Rate</span><span class="punctuation">: </span>0</span><br><span class="line"><span class="attribute">CSeq</span><span class="punctuation">: </span>3</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Lavf59.30.100</span><br><span class="line"><span class="attribute">Session</span><span class="punctuation">: </span>CdplhrJIUmWx</span><br></pre></td></tr></table></figure>

<p>server-&gt;client：建立会话，通过 Transport 头字段返回选择的具体转输选项。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RTSP/1.0 200 OK</span><br><span class="line"><span class="attribute">CSeq</span><span class="punctuation">: </span>3</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Fri, Sep 22 2023 11:19:53 GMT</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>ZLMediaKit(git hash:f69f3b3/2023-09-09T10:59:27+08:00,branch:master,build time:2023-09-19T18:24:32)</span><br><span class="line"><span class="attribute">Session</span><span class="punctuation">: </span>CdplhrJIUmWx</span><br><span class="line"><span class="attribute">Transport</span><span class="punctuation">: </span>RTP/AVP/UDP;unicast;client_port=32316-32317;server_port=30580-30581;ssrc=A336E81F</span><br></pre></td></tr></table></figure>

<p>对于另一个 streamid&#x3D;1 如下，注意 ssrc 源是不同 ID。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SETUP rtsp://192.168.2.101:554/live/test/streamid=1 RTSP/1.0</span><br><span class="line"><span class="attribute">Transport</span><span class="punctuation">: </span>RTP/AVP/UDP;unicast;client_port=32318-32319</span><br><span class="line"><span class="attribute">x-Dynamic-Rate</span><span class="punctuation">: </span>0</span><br><span class="line"><span class="attribute">CSeq</span><span class="punctuation">: </span>4</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Lavf59.30.100</span><br><span class="line"><span class="attribute">Session</span><span class="punctuation">: </span>CdplhrJIUmWx</span><br></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RTSP/1.0 200 OK</span><br><span class="line"><span class="attribute">CSeq</span><span class="punctuation">: </span>4</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Fri, Sep 22 2023 11:19:53 GMT</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>ZLMediaKit(git hash:f69f3b3/2023-09-09T10:59:27+08:00,branch:master,build time:2023-09-19T18:24:32)</span><br><span class="line"><span class="attribute">Session</span><span class="punctuation">: </span>CdplhrJIUmWx</span><br><span class="line"><span class="attribute">Transport</span><span class="punctuation">: </span>RTP/AVP/UDP;unicast;client_port=32318-32319;server_port=34870-34871;ssrc=DDA40D88</span><br></pre></td></tr></table></figure>

<h2 id="PLAY"><a href="#PLAY" class="headerlink" title="PLAY"></a>PLAY</h2><p>client-&gt;server：请求开始发送数据。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PLAY rtsp://192.168.2.101:554/live/test/ RTSP/1.0</span><br><span class="line"><span class="attribute">Range</span><span class="punctuation">: </span>npt=0.000-</span><br><span class="line"><span class="attribute">CSeq</span><span class="punctuation">: </span>5</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Lavf59.30.100</span><br><span class="line"><span class="attribute">Session</span><span class="punctuation">: </span>CdplhrJIUmWx</span><br></pre></td></tr></table></figure>

<p>server-&gt;client：回应该请求的信息。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">RTSP/1.0 200 OK</span><br><span class="line"><span class="attribute">CSeq</span><span class="punctuation">: </span>5</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Fri, Sep 22 2023 11:19:53 GMT</span><br><span class="line"><span class="attribute">Range</span><span class="punctuation">: </span>npt=0.000-</span><br><span class="line"><span class="attribute">RTP-Info</span><span class="punctuation">: </span>url=rtsp://192.168.2.101:554/live/test/streamid=0;seq=6937;rtptime=1382371650,url=rtsp://192.168.2.101:554/live/test/streamid=1;seq=2132;rtptime=-2108239456</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>ZLMediaKit(git hash:f69f3b3/2023-09-09T10:59:27+08:00,branch:master,build time:2023-09-19T18:24:32)</span><br><span class="line"><span class="attribute">Session</span><span class="punctuation">: </span>CdplhrJIUmWx</span><br></pre></td></tr></table></figure>

<h2 id="RTP-数据拉取"><a href="#RTP-数据拉取" class="headerlink" title="RTP 数据拉取"></a>RTP 数据拉取</h2><img src="/2023/09/22/RTSP%E5%8D%8F%E8%AE%AE/RTP拉流报文.png" alt="RTP拉流报文" style="zoom:50%;">

<p>SSRC 推流是客户端自己定义的，拉流的时候是服务器发送过来的。</p>
<h2 id="TERDOWN-1"><a href="#TERDOWN-1" class="headerlink" title="TERDOWN"></a>TERDOWN</h2><p>client-&gt;server：请求关闭会话。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TEARDOWN rtsp://192.168.2.101:554/live/test RTSP/1.0</span><br><span class="line"><span class="attribute">CSeq</span><span class="punctuation">: </span>6</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Lavf59.30.100</span><br><span class="line"><span class="attribute">Session</span><span class="punctuation">: </span>CdplhrJIUmWx</span><br></pre></td></tr></table></figure>

<p>server-&gt;client：回应该请求，200 正常关闭。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RTSP/1.0 200 OK</span><br><span class="line"><span class="attribute">CSeq</span><span class="punctuation">: </span>6</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Fri, Sep 22 2023 11:22:10 GMT</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>ZLMediaKit(git hash:f69f3b3/2023-09-09T10:59:27+08:00,branch:master,build time:2023-09-19T18:24:32)</span><br><span class="line"><span class="attribute">Session</span><span class="punctuation">: </span>CdplhrJIUmWx</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Fang</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"neutral","dark":"neutral"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.3.0/mermaid.min.js","integrity":"sha256-9y71g5Lz/KLsHjB8uXwnkuWDtAMDSzD/HdIbqhJfTAI="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





</body>
</html>
