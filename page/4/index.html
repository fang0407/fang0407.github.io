<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CPT+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"fang0407.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="NOTE">
<meta property="og:url" content="https://fang0407.github.io/page/4/index.html">
<meta property="og:site_name" content="NOTE">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Fang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://fang0407.github.io/page/4/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/4/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>NOTE</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">NOTE</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Fang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">79</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/10/14/WebRTC%E4%B8%80%E5%AF%B9%E4%B8%80%E9%80%9A%E8%AF%9D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/14/WebRTC%E4%B8%80%E5%AF%B9%E4%B8%80%E9%80%9A%E8%AF%9D/" class="post-title-link" itemprop="url">WebRTC一对一通话</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-10-14 20:03:33" itemprop="dateCreated datePublished" datetime="2023-10-14T20:03:33+08:00">2023-10-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-12-30 22:37:01" itemprop="dateModified" datetime="2023-12-30T22:37:01+08:00">2023-12-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/WebRTC/" itemprop="url" rel="index"><span itemprop="name">WebRTC</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="一对一通话"><a href="#一对一通话" class="headerlink" title="一对一通话"></a>一对一通话</h1><img src="/2023/10/14/WebRTC%E4%B8%80%E5%AF%B9%E4%B8%80%E9%80%9A%E8%AF%9D/一对一通话.png" alt="一对一通话" style="zoom:70%;">

<h2 id="信令协议设计"><a href="#信令协议设计" class="headerlink" title="信令协议设计"></a>信令协议设计</h2><ul>
<li><code>join</code> 加入房间。</li>
<li><code>resp­-join</code> 当join房间后发现房间已经存在另一个人时则返回另一个人的uid；如果只有自己则不返回。</li>
<li><code>new­-peer</code> 服务器通知客户端有新人加入，收到new­-peer则发起连接请求。</li>
<li><code>offer</code> 转发offer sdp。</li>
<li><code>answer</code> 转发answer sdp。</li>
<li><code>candidate</code> 转发candidate sdp。 </li>
<li><code>leave</code> 离开房间，服务器收到leave信令则检查同一房间是否有其他人，如果有其他人则通知他有人离开。</li>
<li><code>peer­-leave</code> 服务器通知客户端有人离开。</li>
</ul>
<h2 id="RTCPeerConnection"><a href="#RTCPeerConnection" class="headerlink" title="RTCPeerConnection"></a>RTCPeerConnection</h2><p><code>RTCPeerConnection</code> 接口代表一个由本地计算机到远端的 WebRTC 连接。该接口提供了创建，保持，监控，关闭连接的方法的实现。</p>
<p>参考链接：<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/RTCPeerConnection">https://developer.mozilla.org/zh-CN/docs/Web/API/RTCPeerConnection</a></p>
<p><strong>RTCPeerConnection</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pc = <span class="keyword">new</span> <span class="title class_">RTCPeerConnection</span>([configuration]);</span><br></pre></td></tr></table></figure>

<p>configuration可选</p>
<ul>
<li><p><code>bundlePolicy</code>：一般用<code>max­bundle</code>。</p>
<ul>
<li><code>banlanced</code>：音频与视频轨使用各自的传输通道。</li>
<li><code>max­compat</code>：每个轨使用自己的传输通道。</li>
<li><code>max­bundle</code>：都绑定到同一个传输通道。</li>
</ul>
</li>
<li><p><code>iceTransportPolicy</code>：指定ICE的传输策略，一般用<code>all</code>。</p>
<ul>
<li><code>relay</code>：只使用中继候选者。</li>
<li><code>all</code>：可以使用任何类型的候选者。</li>
</ul>
</li>
<li><p><code>iceServers</code>：其由RTCIceServer组成，每个RTCIceServer都是一个ICE代理的服务器。</p>
<ul>
<li><code>credential </code>：凭据，只有TURN服务使用。</li>
<li><code>credentialType</code>：凭据类型，可以password或oauth。</li>
<li><code>urls </code>：用于连接服中的ur数组。</li>
<li><code>username</code>：用户名，只有TURN服务使用。</li>
</ul>
</li>
<li><p><code>rtcpMuxPolicy</code>：rtcp的复用策略，该选项在收集ICE候选者时使用，一般用<code>require</code>。</p>
<ul>
<li><code>negotiate</code>：收集RTCP与RTP复用的ICE候选者，如果RTCP能复用就与RTP复用，如果不能复用，就将他们单独使用。</li>
<li><code>require</code>：只能收集RTCP与RTP复用的ICE候选者，如果RTCP不能复用，则失败。</li>
</ul>
</li>
</ul>
<p><strong>事件处理回调</strong></p>
<ul>
<li><code>onicecandidate</code>：收到候选者时触发的事件。</li>
<li><code>ontrack</code>：获取远端流。</li>
<li><code>onconnectionstatechange</code>：PeerConnection的连接状态。</li>
<li><code>oniceconnectionstatechange</code>：ICE连接事件。</li>
</ul>
<h2 id="媒体协商"><a href="#媒体协商" class="headerlink" title="媒体协商"></a>媒体协商</h2><img src="/2023/10/14/WebRTC%E4%B8%80%E5%AF%B9%E4%B8%80%E9%80%9A%E8%AF%9D/媒体协商.png" alt="媒体协商" style="zoom:70%;">

<p><strong>createOffer</strong></p>
<p>生成一个 offer，它是一个带有特定的配置信息寻找远端匹配机器（peer）的请求。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">aPromise = myPeerConnection.<span class="title function_">createOffer</span>([options]);</span><br><span class="line"></span><br><span class="line"><span class="comment">//[options] 参数：</span></span><br><span class="line"><span class="keyword">var</span> options = &#123;</span><br><span class="line">    <span class="attr">offerToReceiveAudio</span>: <span class="literal">true</span>, <span class="comment">// 告诉另一端，你是否想接收音频，默认true </span></span><br><span class="line">    <span class="attr">offerToReceiveVideo</span>: <span class="literal">true</span>, <span class="comment">// 告诉另一端，你是否想接收视频，默认true </span></span><br><span class="line">    <span class="attr">iceRestart</span>: <span class="literal">false</span>, <span class="comment">// 是否在活跃状态重启ICE网络协商 </span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>createAnswer</strong></p>
<p>在协调一条连接中的两端 offer&#x2F;answers 时，根据从远端发来的 offer 生成一个 answer。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aPromise = <span class="title class_">RTCPeerConnection</span>.<span class="title function_">createAnswer</span>([options]); <span class="comment">//目前createAnswer的options是 无效的。</span></span><br></pre></td></tr></table></figure>

<p><strong>setLocalDescription</strong></p>
<p>改变与连接相关的本地描述。这个描述定义了连接的属性，例如：连接的编码方式。连接会受到它的改变的影响，而且连接必须能同时支持新的以及旧的描述。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aPromise = <span class="title class_">RTCPeerConnection</span>.<span class="title function_">setLocalDescription</span>(sessionDescription);</span><br></pre></td></tr></table></figure>

<p><strong>setRemoteDescription</strong></p>
<p>改变与连接相关的远端描述。这个描述定义了连接的属性，例如：连接的编码方式。连接会受到它的改变的影响，而且连接必须能同时支持新的以及旧的描述。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aPromise = <span class="title class_">RTCPeerConnection</span>.<span class="title function_">setRemoteDescription</span>(sessionDescription);</span><br></pre></td></tr></table></figure>

<h2 id="添加媒体流"><a href="#添加媒体流" class="headerlink" title="添加媒体流"></a>添加媒体流</h2><p><strong>addTrack</strong></p>
<p>将一个新的媒体音轨添加到一组音轨中，这些音轨将被传输给另一个对等点。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rtpSender = rtcPeerConnection.<span class="title function_">addTrack</span>(track, stream...);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">参数：</span></span><br><span class="line"><span class="comment">track：一个MediaStreamTrack对象，表示要添加到对等连接的媒体轨道。</span></span><br><span class="line"><span class="comment">stream...：可选一个或多个本地的MediaStream对象，该轨迹应添加到其中。</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="网络协商"><a href="#网络协商" class="headerlink" title="网络协商"></a>网络协商</h2><p>添加一个 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Glossary/ICE">ICE</a> 代理。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aPromise = pc.<span class="title function_">addIceCandidate</span>(candidate);</span><br></pre></td></tr></table></figure>

<p>candidate有Web端（和Android不同）相关属性：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>candidate</td>
<td>候选者描述信息</td>
</tr>
<tr>
<td>sdpMid</td>
<td>与候选者相关的媒体流的识别标签</td>
</tr>
<tr>
<td>sdpMLineIndex</td>
<td>在SDP中 m&#x3D;的索引值</td>
</tr>
<tr>
<td>usernameFragment</td>
<td>包括了远端的唯一标识</td>
</tr>
</tbody></table>
<h1 id="Coturn服务"><a href="#Coturn服务" class="headerlink" title="Coturn服务"></a>Coturn服务</h1><p>coturn穿透和转发服务器，集成了stun+turn协议。 </p>
<p><strong>编译安装</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/coturn/coturn</span><br><span class="line">cd coturn</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<p><strong>是否安装成功</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">turnserver ‐L 0.0.0.0 ‐a ‐u test:123456 ‐v ‐f ‐r nort.gov</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看相应的端口号3478是否存在进程</span></span><br><span class="line">sudo lsof ‐i:3478</span><br></pre></td></tr></table></figure>

<p><strong>测试地址</strong></p>
<p>测试网址：<a target="_blank" rel="noopener" href="https://webrtc.github.io/samples/src/content/peerconnection/trickle-ice/">https://webrtc.github.io/samples/src/content/peerconnection/trickle-ice/</a></p>
<h1 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h1><h2 id="局域网测试"><a href="#局域网测试" class="headerlink" title="局域网测试"></a>局域网测试</h2><p><strong>启动conturn</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">turnserver ‐L 0.0.0.0 ‐a ‐u test:123456 ‐v ‐f ‐r nort.gov</span><br></pre></td></tr></table></figure>

<p><strong>配置RTCPeerConnection参数</strong></p>
<p><code>RTCPeerConnection</code>时传入ICE server的参数，以便当在公网环境下可以进行正常通话。</p>
<p>设置configuration，先设置为relay中继模式，只有relay中继模式可用的时候，才能部署到公网去（部署到公网后也先测试relay）。 </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> defaultConfiguration = &#123;</span><br><span class="line"><span class="attr">bundlePolicy</span>: <span class="string">&quot;max-bundle&quot;</span>,</span><br><span class="line"><span class="attr">rtcpMuxPolicy</span>: <span class="string">&quot;require&quot;</span>,</span><br><span class="line"><span class="attr">iceTransportPolicy</span>: <span class="string">&quot;relay&quot;</span>, <span class="comment">//relay 或者 all，测试用relay</span></span><br><span class="line"><span class="comment">// 修改ice数组测试效果，需要进行封装</span></span><br><span class="line"><span class="attr">iceServers</span>: [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">urls</span>: [</span><br><span class="line">      <span class="string">&quot;turn:192.168.2.101:3478?transport=udp&quot;</span>,</span><br><span class="line">      <span class="string">&quot;turn:192.168.2.101:3478?transport=tcp&quot;</span>, <span class="comment">// 可以插入多个进行备选</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">username</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">    <span class="attr">credential</span>: <span class="string">&quot;123456&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">urls</span>: [<span class="string">&quot;stun:192.168.2.101:3478&quot;</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">],</span><br><span class="line">&#125;;</span><br><span class="line">pc = <span class="keyword">new</span> <span class="title class_">RTCPeerConnection</span>(defaultConfiguration</span><br></pre></td></tr></table></figure>

<p><strong>局域网测试</strong></p>
<p>启动通话后，如果使用relay模式断开conturn后会发现Web是无法通信的，但是使用all模式断开conturn后依然可以通信。</p>
<h2 id="公网部署"><a href="#公网部署" class="headerlink" title="公网部署"></a>公网部署</h2><p>注意公网防火墙问题，比如 coturn涉及到的3478端口是否开放。在局域网上搭建，部署公网只需要替换公网IP即可。</p>
<p><strong>nginx安装</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx‐1.15.8.tar.gz</span><br><span class="line">tar xvzf nginx‐1.15.8.tar.gz</span><br><span class="line">cd nginx‐1.15.8/</span><br><span class="line"></span><br><span class="line">./configure ‐‐with‐http_ssl_module</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br><span class="line"></span><br><span class="line">启动：sudo /usr/local/nginx/sbin/nginx </span><br><span class="line">停止：sudo /usr/local/nginx/sbin/nginx -s stop</span><br><span class="line">重新加载配置文件：sudo /usr/local/nginx/sbin/nginx -s reload</span><br></pre></td></tr></table></figure>

<p><strong>产生证书</strong> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir ‐p ~/cert</span><br><span class="line">cd ~/cert</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CA私钥</span></span><br><span class="line">openssl genrsa -out key.pem 2048</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">自签名证书</span></span><br><span class="line">openssl req -new -x509 -key key.pem -out cert.pem -days 1095</span><br></pre></td></tr></table></figure>

<p><strong>配置web服务器</strong></p>
<p>添加<code>/usr/local/nginx/conf/conf.d/webrtc-https.conf</code></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">    <span class="comment"># 配置自己的证书</span></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /root/cert/cert.pem;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /root/cert/key.pem;</span><br><span class="line">    <span class="attribute">charset</span> utf‐<span class="number">8</span>;</span><br><span class="line">    <span class="comment"># ip地址或者域名</span></span><br><span class="line">    <span class="attribute">server_name</span> <span class="number">192.168.2.101</span>;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">add_header</span> <span class="string">&#x27;Access‐Control‐Allow‐Origin&#x27;</span> <span class="string">&#x27;*&#x27;</span>;</span><br><span class="line">        <span class="attribute">add_header</span> <span class="string">&#x27;Access‐Control‐Allow‐Credentials&#x27;</span> <span class="string">&#x27;true&#x27;</span>;</span><br><span class="line">        <span class="attribute">add_header</span> <span class="string">&#x27;Access‐Control‐Allow‐Methods&#x27;</span> <span class="string">&#x27;*&#x27;</span>;</span><br><span class="line">        <span class="attribute">add_header</span> <span class="string">&#x27;Access‐Control‐Allow‐Headers&#x27;</span> <span class="string">&#x27;Origin, X‐Requested‐With, Content‐Type, Accept&#x27;</span>;</span><br><span class="line">        <span class="comment"># web页面所在目录</span></span><br><span class="line">        <span class="attribute">root</span> /root/webrtc/client;</span><br><span class="line">        <span class="attribute">index</span> index.php index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编辑<code>nginx.conf</code>文件，在末尾<code>&#125;</code>之前添加包含文件。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">    <span class="attribute">include</span> /usr/local/nginx/conf/conf.d/<span class="regexp">*.conf</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果遇到权限问题，编辑<code>nginx.conf</code>文件，加入。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">user</span> root owner;</span><br></pre></td></tr></table></figure>

<p>页面打开<a target="_blank" rel="noopener" href="https://192.168.2.101测试./">https://192.168.2.101测试。</a></p>
<p><strong>配置websocket代理</strong></p>
<p>此时Web不能直接访问信令服务器，https不能访问ws，本身是安全的访问，不能降级做不安全的访问。</p>
<p>使用Nginx服务器代理访问信令服务器。</p>
<p>完整配置文件：<code>/usr/local/nginx/conf/conf.d/webrtc-websocket-proxy.conf</code></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">map</span> <span class="variable">$http_upgrade</span> <span class="variable">$connection_upgrade</span> &#123;</span><br><span class="line">    <span class="attribute">default</span> upgrade;</span><br><span class="line">    &#x27;&#x27; close;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">upstream</span> websocket &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.2.101:8099</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8098</span> ssl;</span><br><span class="line">    <span class="comment">#ssl on;</span></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /root/cert/cert.pem;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /root/cert/key.pem;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">server_name</span> <span class="number">192.168.2.101</span>;</span><br><span class="line">    <span class="section">location</span> /ws &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://websocket;</span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="variable">$connection_upgrade</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>websocket超时断开</strong></p>
<p>在通话时，出现60秒后客户端自动断开的问题，是因为经过nginx代理时，如果websocket长时间没有收发消息则该websocket将会被断开。我们这里可以修改收发消息的时间间隔。</p>
<ul>
<li><strong>proxy_connect_timeout：</strong>设置代理服务器与后端服务器建立连接的超时时间。</li>
<li><strong>proxy_read_timeout：</strong>设置代理服务器从后端服务器读取数据的超时时间。</li>
<li><strong>proxy_send_timeout：</strong>设置代理服务器向后端服务器发送数据的超时时间。</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">map</span> <span class="variable">$http_upgrade</span> <span class="variable">$connection_upgrade</span> &#123;</span><br><span class="line">    <span class="attribute">default</span> upgrade;</span><br><span class="line">    &#x27;&#x27; close;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">upstream</span> websocket &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.2.101:8099</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8098</span> ssl;</span><br><span class="line">    <span class="comment">#ssl on;</span></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /root/cert/cert.pem;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /root/cert/key.pem;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">server_name</span> <span class="number">192.168.2.101</span>;</span><br><span class="line">    <span class="section">location</span> /ws &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://websocket;</span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_connect_timeout</span> <span class="number">4s</span>;</span><br><span class="line">        <span class="attribute">proxy_read_timeout</span> <span class="number">6000s</span>;</span><br><span class="line">        <span class="attribute">proxy_send_timeout</span> <span class="number">6000s</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="variable">$connection_upgrade</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><pre class="mermaid">graph LR
    F1[客户端]--https port=443-->F2[Web服务]
    F2--wss port=8098 path=/ws-->F3[nginx代理信令服务]
    F3--http port=8099-->F4[信令服务]
    F1--ICE port=3478-->F5[Coturn服务]</pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/10/11/WebSocket%E5%8D%8F%E8%AE%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/11/WebSocket%E5%8D%8F%E8%AE%AE/" class="post-title-link" itemprop="url">WebSocket协议</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-10-11 22:59:27" itemprop="dateCreated datePublished" datetime="2023-10-11T22:59:27+08:00">2023-10-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-16 18:47:25" itemprop="dateModified" datetime="2024-01-16T18:47:25+08:00">2024-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Protocol/" itemprop="url" rel="index"><span itemprop="name">Protocol</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="WebSocket介绍"><a href="#WebSocket介绍" class="headerlink" title="WebSocket介绍"></a>WebSocket介绍</h1><p>WebSocket 是 HTML5 开始提供的一种在单个 TCP 连接上进行全双工通讯的协议。 WebSocket 使得客户端和服务器之间的数据交换变得更加简单，允许服务端主动向客户端推送数据。在 WebSocket API 中，浏览器和服务器只需要完成一次握手，两者之间就直接可以创建持久性的连接，并进行双向数据传输。</p>
<p>WebSocket 通信流程：</p>
<img src="/2023/10/11/WebSocket%E5%8D%8F%E8%AE%AE/WebSocket通信流程.png" alt="WebSocket通信流程" style="zoom:80%;">

<p>为了建立一个 WebSocket 连接，客户端浏览器首先要向服务器发起一个 HTTP 请求，这个请求和通常的 HTTP 请求不同，包含了一些附加头信息，其中附加头信息”<strong>Upgrade: WebSocket</strong>“表明这是一个申请协议升级的 HTTP 请求，服务器端解析这些附加的头信息然后产生应答信息返回给客户端，客户端和服务器端的 WebSocket 连接就建立起来了，双方就可以通过这个连接通道自由的传递信息，并且这个连接会持续存在直到客户端或者服务器端的某一方主动的关闭连接。</p>
<p>申请协议升级 HTTP 请求响应：</p>
<img src="/2023/10/11/WebSocket%E5%8D%8F%E8%AE%AE/HTTP升级WebSocket报文.png" alt="HTTP升级WebSocket报文" style="zoom:50%;">

<p>WebSocket 报文格式：</p>
<img src="/2023/10/11/WebSocket%E5%8D%8F%E8%AE%AE/websocket报文.png" alt="websocket报文" style="zoom:50%;">

<h1 id="WebSocket例子"><a href="#WebSocket例子" class="headerlink" title="WebSocket例子"></a>WebSocket例子</h1><h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Websocket通信<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;sendMsg&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;submitBtn&quot;</span>&gt;</span>Send<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">showMessage</span>(<span class="params">str, type</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">var</span> div = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;div&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">      div.<span class="property">innerHTML</span> = str;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">if</span> (type == <span class="string">&quot;enter&quot;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        div.<span class="property">style</span>.<span class="property">color</span> = <span class="string">&quot;blue&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="string">&quot;leave&quot;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        div.<span class="property">style</span>.<span class="property">color</span> = <span class="string">&quot;red&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(div);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> websocket = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&quot;ws://127.0.0.1:8010&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//open connection</span></span></span><br><span class="line"><span class="language-javascript">    websocket.<span class="property">onopen</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;connect to server&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">//bind btn click event</span></span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;submitBtn&quot;</span>).<span class="property">onclick</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> txt = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;sendMsg&quot;</span>).<span class="property">value</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (txt) &#123;</span></span><br><span class="line"><span class="language-javascript">          websocket.<span class="title function_">send</span>(txt);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">      &#125;;</span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//close connection</span></span></span><br><span class="line"><span class="language-javascript">    websocket.<span class="property">onclose</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;websocket close&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//error connection</span></span></span><br><span class="line"><span class="language-javascript">    websocket.<span class="property">onerror</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;websocket error&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//receive message</span></span></span><br><span class="line"><span class="language-javascript">    websocket.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">var</span> mes = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(e.<span class="property">data</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">showMessage</span>(mes.<span class="property">data</span>, mes.<span class="property">type</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h2><p>服务器端使用 WebSocket 需要安装 nodejs­-websocket。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm init # 创建package.json文件，系统会提示相关配置，也可以使用命令： </span><br><span class="line">npm init ‐y </span><br><span class="line">npm install nodejs-websocket</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ws = <span class="built_in">require</span>(<span class="string">&quot;nodejs-websocket&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> port = <span class="number">8010</span>;</span><br><span class="line"><span class="keyword">var</span> user = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = ws.<span class="title function_">createServer</span>(<span class="keyword">function</span> (<span class="params">conn</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;create a new connection...&quot;</span>);</span><br><span class="line">    user++;</span><br><span class="line">    conn.<span class="property">nickname</span> = <span class="string">&quot;user&quot;</span> + user;</span><br><span class="line">    conn.<span class="property">fd</span> = <span class="string">&quot;user&quot;</span> + user;</span><br><span class="line">    <span class="keyword">var</span> mes = &#123;&#125;;</span><br><span class="line">    mes.<span class="property">type</span> = <span class="string">&quot;enter&quot;</span>;</span><br><span class="line">    mes.<span class="property">data</span> = conn.<span class="property">nickname</span> + <span class="string">&quot;进来了&quot;</span>;</span><br><span class="line">    <span class="title function_">broadcast</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(mes));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//send message</span></span><br><span class="line">    conn.<span class="title function_">on</span>(<span class="string">&quot;text&quot;</span>, <span class="keyword">function</span>(<span class="params">str</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;回复:&quot;</span> + str);</span><br><span class="line">        mes.<span class="property">type</span> = <span class="string">&quot;message&quot;</span>;</span><br><span class="line">        mes.<span class="property">data</span> = conn.<span class="property">nickname</span> + <span class="string">&quot; 说: &quot;</span> + str;</span><br><span class="line">        <span class="title function_">broadcast</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(mes));</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//close connection</span></span><br><span class="line">    conn.<span class="title function_">on</span>(<span class="string">&quot;close&quot;</span>, <span class="keyword">function</span>(<span class="params">code, reason</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;关闭连接&quot;</span>);</span><br><span class="line">        mes.<span class="property">type</span> = <span class="string">&quot;leave&quot;</span>;</span><br><span class="line">        mes.<span class="property">data</span> = conn.<span class="property">nickname</span> + <span class="string">&quot; 离开了&quot;</span>;</span><br><span class="line">        <span class="title function_">broadcast</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(mes));</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//error</span></span><br><span class="line">    conn.<span class="title function_">on</span>(<span class="string">&quot;error&quot;</span>, <span class="keyword">function</span>(<span class="params">err</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;监听错误:&quot;</span> + err);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;).<span class="title function_">listen</span>(port);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;server listen on port: &quot;</span> + port);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">broadcast</span>(<span class="params">str</span>) &#123;</span><br><span class="line">    server.<span class="property">connections</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">connection</span>)&#123;</span><br><span class="line">        connection.<span class="title function_">sendText</span>(str);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/10/09/WebRTC%E4%BB%8B%E7%BB%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/09/WebRTC%E4%BB%8B%E7%BB%8D/" class="post-title-link" itemprop="url">WebRTC介绍</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-10-09 19:16:26" itemprop="dateCreated datePublished" datetime="2023-10-09T19:16:26+08:00">2023-10-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-18 13:48:18" itemprop="dateModified" datetime="2024-01-18T13:48:18+08:00">2024-01-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/WebRTC/" itemprop="url" rel="index"><span itemprop="name">WebRTC</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="WebRTC介绍"><a href="#WebRTC介绍" class="headerlink" title="WebRTC介绍"></a>WebRTC介绍</h1><p>WebRTC（Web Real­Time Communication）是 Google 于 2010 以 6829 万美元从 Global IP Solutions 公司购买，并于 2011 年将其开源，旨在建立一个互联网浏览器间的实时通信的平台，让 WebRTC 技术成为 H5 标准之一。WebRTC 是一个免费的开放项目，它通过简单的 API 为浏览器和移动应用程序提供实时通信（RTC）功能。</p>
<h1 id="WebRTC框架"><a href="#WebRTC框架" class="headerlink" title="WebRTC框架"></a>WebRTC框架</h1><img src="/2023/10/09/WebRTC%E4%BB%8B%E7%BB%8D/WebRTC框架.png" alt="WebRTC框架" style="zoom:50%;">

<p>上图的框架对于不同的开发人员关注点不同： </p>
<ul>
<li>紫色部分是 Web 应用开发者 API 层</li>
<li>蓝色实线部分是面向浏览器厂商的 API 层</li>
<li>蓝色虚线部分浏览器厂商可以自定义实现</li>
</ul>
<p>特别是图中的 PeerConnection 为 Web 开发人员提供了一个抽象，从复杂的内部结构中抽象出来。注意关注 PeerConnection 这个对象即可以开发音视频通话应用。 </p>
<h2 id="WebRTC架构组件介绍"><a href="#WebRTC架构组件介绍" class="headerlink" title="WebRTC架构组件介绍"></a>WebRTC架构组件介绍</h2><h3 id="Web-APP"><a href="#Web-APP" class="headerlink" title="Web APP"></a>Web APP</h3><p>Web 开发者开发的程序，Web 开发者可以基于集成 WebRTC 的浏览器提供的 Web API 开发基于视频、音频的实时通信应用。</p>
<h3 id="Web-API"><a href="#Web-API" class="headerlink" title="Web API"></a>Web API</h3><p>面向第三方开发者的 WebRTC 标准 API（Javascript），使开发者能够容易地开发出类似于网络视频聊天的 Web 应用。</p>
<h3 id="WebRTC-Native-C-API"><a href="#WebRTC-Native-C-API" class="headerlink" title="WebRTC Native C++ API"></a>WebRTC Native C++ API</h3><p>本地 C++ API 层，使浏览器厂商容易实现 WebRTC 标准的 Web API，抽象地对数字信号过程进行处理。</p>
<h3 id="Transport-Session"><a href="#Transport-Session" class="headerlink" title="Transport &#x2F; Session"></a>Transport &#x2F; Session</h3><p>传输&#x2F;会话层，会话层组件采用了 libjingle 库的部分组件实现，无需使用 xmpp&#x2F;jingle 协议。</p>
<h3 id="VoiceEngine"><a href="#VoiceEngine" class="headerlink" title="VoiceEngine"></a>VoiceEngine</h3><p>WebRTC 音频处理引擎，包含一系列音频多媒体处理的框架，VoiceEngine 是 WebRTC 极具价值的技术之一，是 Google 收购 GIPS 公司后开源的。在 VoIP上，技术业界领先。</p>
<p>Opus：支持从 6 kbit&#x2F;s 到 510 kbit&#x2F;s 的恒定和可变比特率编码，帧大小从 2.5 ms 到 60 ms，各种采样率从 8 kHz（4 kHz 带宽）到 48 kHz（20 kHz 带宽，可复制人类听觉系统的整个听力范围）。由 IETF RFC 6176 定义。</p>
<p>NetEQ 模块是 WebRTC 语音引擎中的核心模块 ，一种动态抖动缓冲和错误隐藏算法，用于隐藏网络抖动和数据包丢失的负面影响。保持尽可能低的延迟，同时保持最高的语音质量。</p>
<h3 id="VideoEngine"><a href="#VideoEngine" class="headerlink" title="VideoEngine"></a>VideoEngine</h3><p>WebRTC 视频处理引擎，VideoEngine 是包含一系列视频处理的整体框架，从摄像头采集视频到视频信息网络传输再到视频显示整个完整过程的解决方案。VP8 视频图像编解码器，是 WebRTC 视频引擎的默认的编解码，VP8 适合实时通信应用场景，因为它主要是针对低延时而设计的编解码器。 </p>
<h1 id="WebRTC发展前景"><a href="#WebRTC发展前景" class="headerlink" title="WebRTC发展前景"></a>WebRTC发展前景</h1><p>WebRTC 虽然冠以“web”之名，但并不受限于传统互联网应用或浏览器的终端运行环境。实际上<strong>无论终端运行环境是浏览器、桌面应用、移动设备（Android 或 iOS）还是 IoT 设备，只要IP连接可到达且符合 WebRTC 规范就可以互通</strong>。这一点释放了大量智能终端（或运行在智能终端上的app）的实时通信能力，打开了许多对于实时交互性要求较高的应用场景的想象空间，譬如在线教育、视频会议、视频社交、远程协助、远程操控等等都是其合适的应用领域。</p>
<h1 id="WebRTC通话原理"><a href="#WebRTC通话原理" class="headerlink" title="WebRTC通话原理"></a>WebRTC通话原理</h1><p>问题：两个不同网络环境的（具备摄像头&#x2F;麦克风多媒体设备的）浏览器，要实现点对点的实时音视频对话，难点在哪里？ </p>
<h2 id="媒体协商"><a href="#媒体协商" class="headerlink" title="媒体协商"></a>媒体协商</h2><p><strong>彼此要了解对方支持的媒体格式。</strong></p>
<p>在 WebRTC 中用来描述网络信息的术语叫 <strong>SDP</strong>。</p>
<p>比如：Peer­A端可支持 VP8、H264 多种编码格式，而 Peer­B 端支持 VP9、H264，要保证二端都正确的编解码，最简单的办法就是取它们的交集 H264。</p>
<p>注：有一个专门的协议 ，称为Session Description Protocol （SDP），可用于描述上述这类信息，在 WebRTC 中，<strong>参与视频通讯的双方必须先交换SDP信息</strong>，这样双方才能知根知底，而交换SDP的过程，也称为”<strong>媒体协商</strong>“。</p>
<h2 id="网络协商"><a href="#网络协商" class="headerlink" title="网络协商"></a>网络协商</h2><p><strong>彼此要了解对方的网络情况，这样才有可能找到一条相互通讯的链路。</strong></p>
<p>在 WebRTC 中用来描述网络信息的术语叫 <strong>Candidate</strong>。</p>
<p>解决方式：</p>
<ul>
<li>获取外网IP地址映射。</li>
<li>通过信令服务器（signal server）交换网络信息。</li>
</ul>
<p>对于理想的网络情况是每个浏览器的电脑都是私有公网 IP，可以直接进行点对点连接。</p>
<img src="/2023/10/09/WebRTC%E4%BB%8B%E7%BB%8D/理想网络情况.png" alt="理想网络情况" style="zoom:50%;">



<p>但是实际情况是我们的电脑和电脑之前或大或小都是在某个局域网中，需要 NAT（Network Address Translation，网络地址转换）。</p>
<img src="/2023/10/09/WebRTC%E4%BB%8B%E7%BB%8D/实际网络情况.png" alt="实际网络情况" style="zoom:50%;">

<p>在解决 WebRTC 使用过程中的上述问题的时候，我们需要用到 STUN 和 TURN。</p>
<h3 id="STUN"><a href="#STUN" class="headerlink" title="STUN"></a>STUN</h3><p>STUN（Session Traversal Utilities for NAT，NAT会话穿越应用程序）是一种网络协议，它允许位于 NAT（或多重 NAT）后的<strong>客户端找出自己的公网地址</strong>，查出自己位于哪种类型的 NAT 之后以及 <strong>NAT 为某一个本地端口所绑定的 Internet 端端口</strong>。这些信息被用来在两个同时处于 NAT 路由器之后的主机之间创建 UDP 通信。该协议由 RFC 5389 定义。</p>
<p>在遇到上述情况的时候，我们可以建立一个 STUN 服务器，这个服务器做什么用的呢？主要是<strong>给无法在公网环境下的视频通话设备分配公网 IP 用的</strong>。这样两台电脑就可以在公网 IP 中进行通话。</p>
<img src="/2023/10/09/WebRTC%E4%BB%8B%E7%BB%8D/STUN服务器.png" alt="STUN服务器" style="zoom:50%;">

<p>使用一句话说明 STUN 做的事情就是：<strong>告诉我你的公网 IP 地址+端口是什么</strong>。搭建 STUN 服务器很简单，媒体流传输是按照 P2P 的方式。</p>
<p>那么问题来了，<strong>STUN 并不是每次都能成功的为需要 NAT 的通话设备分配 IP 地址的</strong>，P2P 在传输媒体流时，使用的本地带宽，在多人视频通话的过程中，通话质量的好坏往往需要根据使用者本地的带宽确定。那么怎么办？TURN 可以很好的解决这个问题。</p>
<h3 id="TURN"><a href="#TURN" class="headerlink" title="TURN"></a>TURN</h3><p>TURN 的全称为 Traversal Using Relays around NAT，是 STUN&#x2F;RFC5389 的一个拓展，主要添加了 <strong>Relay</strong> 功能。如果终端在 NAT 之后， 那么在特定的情景下，有可能使得终端无法和其对等端（peer）进行直接的通信，这时就需要公网的服务器作为一个中继， 对来往的数据进行转发。这个转发的协议就被定义为 TURN。</p>
<img src="/2023/10/09/WebRTC%E4%BB%8B%E7%BB%8D/TURN服务器.png" alt="TURN服务器" style="zoom:50%;">

<p>在 STUN 分配公网 IP 失败后，可以通过 TURN 服务器请求公网 IP 地址作为中继地址。<strong>这种方式的带宽由服务器端承担</strong>，在多人视频聊天的时候，本地带宽压力较小，并且，根据 Google 的说明，TURN 协议可以使用在所有的环境中。（单向数据 200kbps 一对一通话）。</p>
<p>以上是 WebRTC 中经常用到的两个协议，STUN 和 TURN 服务器我们使用 coturn 开源项目来搭建。</p>
<p>补充：ICE 跟 STUN 和 TURN 不一样，ICE 不是一种协议，而是一个框架（Framework），它整合了 STUN 和 TURN。coturn 开源项目集成了 STUN 和 TURN 的功能。</p>
<h2 id="信令服务器"><a href="#信令服务器" class="headerlink" title="信令服务器"></a>信令服务器</h2><p>从上面我们知道了两个客户端协商媒体信息和网络信息，那怎么去交换？是不是需要一个中间商去做交换？所以我们需要一个信令服务器（Signal Server）转发彼此的媒体信息和网络信息。 </p>
<img src="/2023/10/09/WebRTC%E4%BB%8B%E7%BB%8D/信令服务器.png" alt="信令服务器" style="zoom:50%;">

<p>如上图，我们在基于 WebRTC API 开发应用（APP）时，可以将彼此的 APP 连接到信令服务器（Signal Server，一般搭建在公网，或者两端都可以访问到的局域网），<strong>借助信令服务器，就可以实现上面提到的 SDP 媒体信息及 Candidate 网络信息交换</strong>。</p>
<p>注意：信令服务器不只是交互媒体信息 sdp 和网络信息 candidate，比如：</p>
<ul>
<li><p>房间管理</p>
</li>
<li><p>人员进出房间</p>
</li>
</ul>
<h2 id="WebRTC-API"><a href="#WebRTC-API" class="headerlink" title="WebRTC API"></a>WebRTC API</h2><ul>
<li><strong>MediaStream</strong> — MediaStream 用来表示一个媒体数据流（通过 getUserMedia 接口获取），允许你访问输入设备，如麦克风和 Web摄像机，该 API 允许从其中任意一个获取媒体流。</li>
<li><strong>RTCPeerConnection</strong> — RTCPeerConnection 对象允许用户在两个浏览器之间直接通讯 ，你可以通过网络将捕获的音频和视频流实时发送到另一个 WebRTC 端点。使用这些 API，你可以在本地机器和远程对等点之间创建连接。它提供了连接到远程对等点、维护和监视连接以及在不再需要连接时关闭连接的方法。</li>
</ul>
<h2 id="一对一通话"><a href="#一对一通话" class="headerlink" title="一对一通话"></a>一对一通话</h2><img src="/2023/10/09/WebRTC%E4%BB%8B%E7%BB%8D/一对一通话.png" alt="一对一通话" style="zoom:70%;">

<p>在一对一通话场景中，每个 Peer 均创建有一个 PeerConnection 对象，由一方主动发 Offer SDP，另一方则应答 Answer SDP，最后双方交换 ICE Candidate 从而完成通话链路的建立。但是在中国的网络环境中，据一些统计数据显示，至少一半的网络是无法直接穿透打通，这种情况下只能借助 TURN 服务器中转。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/10/09/RTCP%E6%97%B6%E9%97%B4%E6%88%B3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/09/RTCP%E6%97%B6%E9%97%B4%E6%88%B3/" class="post-title-link" itemprop="url">RTCP时间戳</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-10-09 19:02:19" itemprop="dateCreated datePublished" datetime="2023-10-09T19:02:19+08:00">2023-10-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-17 22:46:07" itemprop="dateModified" datetime="2023-10-17T22:46:07+08:00">2023-10-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>今天通过RTSP使用UDP协议拉流播放摄像头，获取流的开始时间<code>start_time_realtime</code>的时候，发现时间戳会差8个小时，具体记录一下排查过程。FFmpeg版本是<code>ffmpeg version N-106450-g5ee198f9aa Copyright (c) 2000-2022 the FFmpeg developers</code>。</p>
<h1 id="排查步骤"><a href="#排查步骤" class="headerlink" title="排查步骤"></a>排查步骤</h1><h2 id="测试程序"><a href="#测试程序" class="headerlink" title="测试程序"></a>测试程序</h2><ul>
<li>编写main.c文件</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libavformat/avformat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span>                                                                    </span></span><br><span class="line"><span class="function"></span>&#123;                                                                      </span><br><span class="line">    AVDictionary *format_opts = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">av_dict_set</span>(&amp;format_opts, <span class="string">&quot;rtsp_transport&quot;</span>, <span class="string">&quot;udp&quot;</span>, <span class="number">0</span>); </span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* rtsp_path = <span class="string">&quot;rtsp://admin:HuaWei123@10.30.30.70/LiveMedia/ch1/Media1&quot;</span>;</span><br><span class="line">    AVFormatContext* ifmt_ctx = <span class="built_in">avformat_alloc_context</span>();</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">avformat_open_input</span>(&amp;ifmt_ctx, rtsp_path, <span class="literal">NULL</span>, &amp;format_opts);</span><br><span class="line">    <span class="built_in">avformat_find_stream_info</span>(ifmt_ctx, <span class="literal">NULL</span>);</span><br><span class="line">    AVPacket* pkt = <span class="built_in">av_packet_alloc</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">av_read_frame</span>(ifmt_ctx, pkt);</span><br><span class="line">        <span class="comment">//printf(&quot;%ld\n&quot;, ifmt_ctx-&gt;start_time_realtime);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><ul>
<li>ffmpeg编译debug版本</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./configure --enable-debug=3 --prefix=/root/ffmpeg/install --enable-shared --enable-pic --extra-cflags=-g --disable-stripping</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make -j4</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make install</span></span><br></pre></td></tr></table></figure>

<ul>
<li>测试demo编译</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -g main.c -I /root/ffmpeg/install/include -L /root/ffmpeg/install/lib -lavformat -lavutil -lavcodec</span><br></pre></td></tr></table></figure>

<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><h3 id="tcpdump"><a href="#tcpdump" class="headerlink" title="tcpdump"></a>tcpdump</h3><p>先启动tcpdump然后启动gdb调试程序。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i any host 127.0.0.1 and udp -w rtp_rtcp.pcap</span><br></pre></td></tr></table></figure>

<img src="/2023/10/09/RTCP%E6%97%B6%E9%97%B4%E6%88%B3/SR报文.png" alt="SR报文" style="zoom:90%;">

<h3 id="gdb"><a href="#gdb" class="headerlink" title="gdb"></a>gdb</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">gdb ./a.out</span><br><span class="line">gdb: /usr/local/lib/libuuid.so.1: no version information available (required by /usr/lib/x86_64-linux-gnu/libbabeltrace-ctf.so.1)</span><br><span class="line">GNU gdb (Ubuntu 7.11.1-0ubuntu1~16.5) 7.11.1</span><br><span class="line">Copyright (C) 2016 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type &quot;show copying&quot;</span><br><span class="line">and &quot;show warranty&quot; for details.</span><br><span class="line">This GDB was configured as &quot;x86_64-linux-gnu&quot;.</span><br><span class="line">Type &quot;show configuration&quot; for configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line">For help, type &quot;help&quot;.</span><br><span class="line">Type &quot;apropos word&quot; to search for commands related to &quot;word&quot;...</span><br><span class="line">Reading symbols from ./a.out...done.</span><br><span class="line">(gdb) b main</span><br><span class="line">Breakpoint 1 at 0x4008ce: file main.c, line 7.</span><br><span class="line">(gdb) r</span><br><span class="line">Starting program: /root/ffmpeg/a.out </span><br><span class="line">[Thread debugging using libthread_db enabled]</span><br><span class="line">Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, main () at main.c:7</span><br><span class="line">7       &#123;</span><br><span class="line">(gdb) b libavformat/rtsp.c:2310</span><br><span class="line">Breakpoint 2 at 0x7ffff7aedade: file libavformat/rtsp.c, line 2310.</span><br><span class="line">(gdb) b libavformat/rtpdec.c:194</span><br><span class="line">Breakpoint 3 at 0x7ffff7ad8340: file libavformat/rtpdec.c, line 194.</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 3, rtcp_parse_packet (len=52, buf=0x662040 &quot;\200&quot;, &lt;incomplete sequence \310&gt;, s=&lt;optimized out&gt;) at libavformat/rtpdec.c:194</span><br><span class="line">194                 if (payload_len &lt; 20) &#123;</span><br><span class="line">(gdb) l</span><br><span class="line">189         while (len &gt;= 4) &#123;</span><br><span class="line">190             payload_len = FFMIN(len, (AV_RB16(buf + 2) + 1) * 4);</span><br><span class="line">191</span><br><span class="line">192             switch (buf[1]) &#123;</span><br><span class="line">193             case RTCP_SR:</span><br><span class="line">194                 if (payload_len &lt; 20) &#123;</span><br><span class="line">195                     av_log(s-&gt;ic, AV_LOG_ERROR, &quot;Invalid RTCP SR packet length\n&quot;);</span><br><span class="line">196                     return AVERROR_INVALIDDATA;</span><br><span class="line">197                 &#125;</span><br><span class="line">198</span><br><span class="line">(gdb) x buf</span><br><span class="line">0x662040:       0x0600c880</span><br><span class="line">(gdb) x/xb buf</span><br><span class="line">0x662040:       0x80</span><br><span class="line">(gdb) x/tb buf</span><br><span class="line">0x662040:       10000000</span><br><span class="line">(gdb) x/xb buf+1</span><br><span class="line">0x662041:       0xc8</span><br><span class="line">(gdb) p buf[1]     #RTCP消息类型 200是SR</span><br><span class="line">$1 = 200 &#x27;\310&#x27;</span><br><span class="line">(gdb) x/ub buf+1</span><br><span class="line">0x662041:       200</span><br><span class="line">(gdb) x/xh buf+2   #RTCP消息长度，6*4 == 24Byte</span><br><span class="line">0x662042:       0x0600</span><br><span class="line">(gdb) x/xw buf+4   #SSRC</span><br><span class="line">0x662044:       0xa50b6170</span><br><span class="line">(gdb) x/xw buf+8   #NTP timestamp (高32位)</span><br><span class="line">0x662048:       0x9390cee8</span><br><span class="line">(gdb) x/xw buf+12  #NTP timestamp (低32位)</span><br><span class="line">0x66204c:       0x2fa1822b</span><br><span class="line">(gdb) p av_rescale(AV_RB64(buf + 8) - (NTP_OFFSET &lt;&lt; 32), 1000000, 1LL &lt;&lt; 32)  #这个具体下面解释</span><br><span class="line">$5 = 1696862739169962</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>可以看到gdb输出的和SR报文内容是一致的，具体：</p>
<ul>
<li>Packet Type：<code>p buf[1]</code></li>
<li>Length：<code>x/xh buf+2</code></li>
<li>Sender SSRC：<code>x/xw buf+4</code></li>
<li>Timestamp，MSW：<code>x/xw buf+8</code></li>
<li>Timestamp，LSW：<code>x/xw buf+12</code></li>
</ul>
<p>但是gdb输出下面代码的结果为<code>1696862739169962</code>转为时间是<code>2023-10-9 22:45:39</code>和上述报文的<code>NTP timestamp</code>差了8个小时。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">av_rescale</span>(<span class="built_in">AV_RB64</span>(buf + <span class="number">8</span>) - (NTP_OFFSET &lt;&lt; <span class="number">32</span>), <span class="number">1000000</span>, <span class="number">1LL</span> &lt;&lt; <span class="number">32</span>);</span><br></pre></td></tr></table></figure>

<p><code>AV_RB64(buf + 8)</code>是MSW时间，单位从<code>1900-01-01 00:00:00</code>开始的。</p>
<p><code>NTP_OFFSET &lt;&lt; 32</code>这个是1900年到1970年的时间长度，为什么要减去它，因为时间戳是从<code>1970-01-01 00:00:00</code>开始的。</p>
<p>所以差8个小时，是由于北京时间时间戳是从<code>1970-01-01 08:00:00</code>开始的，NTP timestamp要减去8个小时才是北京时间，这里存在疑惑？？？</p>
<h1 id="RTCP传输"><a href="#RTCP传输" class="headerlink" title="RTCP传输"></a>RTCP传输</h1><h2 id="拉流端"><a href="#拉流端" class="headerlink" title="拉流端"></a>拉流端</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">rtcp_parse_packet</span><span class="params">(RTPDemuxContext *s, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *buf,</span></span><br><span class="line"><span class="params">                             <span class="type">int</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> payload_len;</span><br><span class="line">    <span class="keyword">while</span> (len &gt;= <span class="number">4</span>) &#123;</span><br><span class="line">        payload_len = FFMIN(len, (AV_RB16(buf + <span class="number">2</span>) + <span class="number">1</span>) * <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (buf[<span class="number">1</span>]) &#123;</span><br><span class="line">        <span class="keyword">case</span> RTCP_SR:</span><br><span class="line">            <span class="keyword">if</span> (payload_len &lt; <span class="number">20</span>) &#123;</span><br><span class="line">                av_log(s-&gt;ic, AV_LOG_ERROR, <span class="string">&quot;Invalid RTCP SR packet length\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> AVERROR_INVALIDDATA;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            s-&gt;last_rtcp_reception_time = av_gettime_relative();</span><br><span class="line">            s-&gt;last_rtcp_ntp_time  = AV_RB64(buf + <span class="number">8</span>);</span><br><span class="line">            s-&gt;last_rtcp_timestamp = AV_RB32(buf + <span class="number">16</span>);</span><br><span class="line">            <span class="keyword">if</span> (s-&gt;first_rtcp_ntp_time == AV_NOPTS_VALUE) &#123;</span><br><span class="line">                s-&gt;first_rtcp_ntp_time = s-&gt;last_rtcp_ntp_time;</span><br><span class="line">                <span class="keyword">if</span> (!s-&gt;base_timestamp)</span><br><span class="line">                    s-&gt;base_timestamp = s-&gt;last_rtcp_timestamp;</span><br><span class="line">                s-&gt;rtcp_ts_offset = (<span class="type">int32_t</span>)(s-&gt;last_rtcp_timestamp - s-&gt;base_timestamp);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> RTCP_BYE:</span><br><span class="line">            <span class="keyword">return</span> -RTCP_BYE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        buf += payload_len;</span><br><span class="line">        len -= payload_len;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要看下<code>s-&gt;last_rtcp_ntp_time  = AV_RB64(buf + 8)</code>推流端如何打包数据。</p>
<h2 id="推流端"><a href="#推流端" class="headerlink" title="推流端"></a>推流端</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* send an rtcp sender report packet */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">rtcp_send_sr</span><span class="params">(AVFormatContext *s1, <span class="type">int64_t</span> ntp_time, <span class="type">int</span> bye)</span></span><br><span class="line">&#123;</span><br><span class="line">    RTPMuxContext *s = s1-&gt;priv_data;</span><br><span class="line">    <span class="type">uint32_t</span> rtp_ts;</span><br><span class="line"></span><br><span class="line">    av_log(s1, AV_LOG_TRACE, <span class="string">&quot;RTCP: %02x %&quot;</span>PRIx64<span class="string">&quot; %&quot;</span>PRIx32<span class="string">&quot;\n&quot;</span>, </span><br><span class="line">           s-&gt;payload_type, ntp_time, s-&gt;timestamp);</span><br><span class="line"></span><br><span class="line">    s-&gt;last_rtcp_ntp_time = ntp_time;</span><br><span class="line">    rtp_ts = av_rescale_q(ntp_time - s-&gt;first_rtcp_ntp_time, (AVRational)&#123;<span class="number">1</span>, <span class="number">1000000</span>&#125;,</span><br><span class="line">                          s1-&gt;streams[<span class="number">0</span>]-&gt;time_base) + s-&gt;base_timestamp;</span><br><span class="line">    avio_w8(s1-&gt;pb, RTP_VERSION &lt;&lt; <span class="number">6</span>);</span><br><span class="line">    avio_w8(s1-&gt;pb, RTCP_SR);</span><br><span class="line">    avio_wb16(s1-&gt;pb, <span class="number">6</span>); <span class="comment">/* length in words - 1 */</span></span><br><span class="line">    avio_wb32(s1-&gt;pb, s-&gt;ssrc);</span><br><span class="line">    avio_wb32(s1-&gt;pb, ntp_time / <span class="number">1000000</span>);</span><br><span class="line">    avio_wb32(s1-&gt;pb, ((ntp_time % <span class="number">1000000</span>) &lt;&lt; <span class="number">32</span>) / <span class="number">1000000</span>);</span><br><span class="line">    avio_wb32(s1-&gt;pb, rtp_ts);</span><br><span class="line">    avio_wb32(s1-&gt;pb, s-&gt;packet_count);</span><br><span class="line">    avio_wb32(s1-&gt;pb, s-&gt;octet_count);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s-&gt;cname) &#123;</span><br><span class="line">        <span class="type">int</span> len = FFMIN(<span class="built_in">strlen</span>(s-&gt;cname), <span class="number">255</span>);</span><br><span class="line">        avio_w8(s1-&gt;pb, (RTP_VERSION &lt;&lt; <span class="number">6</span>) + <span class="number">1</span>);</span><br><span class="line">        avio_w8(s1-&gt;pb, RTCP_SDES);</span><br><span class="line">        avio_wb16(s1-&gt;pb, (<span class="number">7</span> + len + <span class="number">3</span>) / <span class="number">4</span>); <span class="comment">/* length in words - 1 */</span></span><br><span class="line"></span><br><span class="line">        avio_wb32(s1-&gt;pb, s-&gt;ssrc);</span><br><span class="line">        avio_w8(s1-&gt;pb, <span class="number">0x01</span>); <span class="comment">/* CNAME */</span></span><br><span class="line">        avio_w8(s1-&gt;pb, len);</span><br><span class="line">        avio_write(s1-&gt;pb, s-&gt;cname, len);</span><br><span class="line">        avio_w8(s1-&gt;pb, <span class="number">0</span>); <span class="comment">/* END */</span></span><br><span class="line">        <span class="keyword">for</span> (len = (<span class="number">7</span> + len) % <span class="number">4</span>; len % <span class="number">4</span>; len++)</span><br><span class="line">            avio_w8(s1-&gt;pb, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bye) &#123;</span><br><span class="line">        avio_w8(s1-&gt;pb, (RTP_VERSION &lt;&lt; <span class="number">6</span>) | <span class="number">1</span>);</span><br><span class="line">        avio_w8(s1-&gt;pb, RTCP_BYE);</span><br><span class="line">        avio_wb16(s1-&gt;pb, <span class="number">1</span>); <span class="comment">/* length in words - 1 */</span></span><br><span class="line">        avio_wb32(s1-&gt;pb, s-&gt;ssrc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    avio_flush(s1-&gt;pb);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>拉流端的<code>last_rtcp_ntp_time  </code>对应<code>avio_wb32(s1-&gt;pb, ntp_time / 1000000)</code>，其中<code>ntp_time</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint64_t</span> <span class="title function_">ff_ntp_time</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (av_gettime() / <span class="number">1000</span>) * <span class="number">1000</span> + NTP_OFFSET_US;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rtcp_send_sr(s1, ff_ntp_time(), <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>其中<code>av_gettime</code>调用<code>gettimeofday</code>，为什么加上<code>NTP_OFFSET_US</code>这个其实就是1900年到1970年的时间差，转成MSW，所以上面拉流端需要减去<code>NTP_OFFSET_US</code>。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/10/06/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BEdge%E9%9B%86%E7%BE%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/06/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BEdge%E9%9B%86%E7%BE%A4/" class="post-title-link" itemprop="url">SRS流媒体服务器之Edge集群</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-10-06 17:24:19" itemprop="dateCreated datePublished" datetime="2023-10-06T17:24:19+08:00">2023-10-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-12-30 22:37:34" itemprop="dateModified" datetime="2023-12-30T22:37:34+08:00">2023-12-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SRS/" itemprop="url" rel="index"><span itemprop="name">SRS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Edge集群原理和配置"><a href="#Edge集群原理和配置" class="headerlink" title="Edge集群原理和配置"></a>Edge集群原理和配置</h1><h2 id="Edge集群简介"><a href="#Edge集群简介" class="headerlink" title="Edge集群简介"></a>Edge集群简介</h2><p>Edge模式中，中心节点叫Origin（源站），边缘节点叫做Edge（边缘）。</p>
<p>所谓边缘Edge服务器，就是边缘直播缓存服务器，配置时指定为remote模式和origin（指定一个或多个源站IP），这个边缘Edge服务器就是Origin（源站）的缓存了。</p>
<p>当用户推流到边缘服务器时，边缘直接将流转发给源站：</p>
<ul>
<li>譬如源站在北京BGP机房，湖南有个电信ADSL用户要推流发布自己的直播流，要是直接推流到北京BGP可能效果不是很好，可以在湖南电信机房部署一个边缘，用户推流到湖南边缘，边缘转发给北京源站BGP。</li>
<li>当用户播放边缘服务器的流时，边缘服务器看有没有缓存，若缓存了就直接将流发给客户端。 若没有缓存，则发起一路回源链接，从源站取数据源源不断放到自己的缓存队列。也就是说多个客户端连接到边缘时，只有一路回源。</li>
<li>这种结构在CDN是最典型的部署结构。譬如北京源站， 在全国32个省每个省都部署了10台服务器，一共就有320台边缘，假设每个省1台边缘服务器都有 2000用户观看，那么就有64万用户，每秒钟集群发送640Gbps数据；而回源链接只有320个， 实现了大规模分发。</li>
<li>边缘Edge服务器，实际上是解决大并发问题产生的分布式集群结构。SRS的边缘可以指定多个源站， 在源站出现故障时会自动切换到下一个源站，不影响用户观看，具有最佳的容错性，用户完全不会觉察。</li>
</ul>
<img src="/2023/10/06/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BEdge%E9%9B%86%E7%BE%A4/Edge集群.png" alt="Edge集群" style="zoom:50%;">

<h2 id="Edge适用场景"><a href="#Edge适用场景" class="headerlink" title="Edge适用场景"></a>Edge适用场景</h2><ul>
<li>CDN&#x2F;VDN大规模集群，客户众多流众多需要按需回源。</li>
<li>小规模集群，但是流比较多，需要按需回源。</li>
<li>骨干带宽低，边缘服务器强悍，可以使用多层Edge，降低上层BGP带宽。</li>
</ul>
<p>注意：Edge可以从源站拉流，也可以将流转发给源站。也就是说，<strong>播放Edge上的流时，Edge会回源拉流；推流到Edge上时，Edge会直接将流转发给源站</strong>。</p>
<h2 id="Edge集群部署实例"><a href="#Edge集群部署实例" class="headerlink" title="Edge集群部署实例"></a>Edge集群部署实例</h2><h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><p>部署两个源站，两个边缘。</p>
<p>修改<code>conf/origin.conf</code>，启动<code>./objs/srs -c conf/origin.conf</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">listen              1935;</span><br><span class="line">max_connections     1000;</span><br><span class="line">pid                 ./objs/origin.pid;</span><br><span class="line">daemon              off;</span><br><span class="line">srs_log_tank        console;</span><br><span class="line">http_server &#123;</span><br><span class="line">    enabled         on;</span><br><span class="line">    listen          8081;</span><br><span class="line">    dir             ./objs/nginx/html;</span><br><span class="line">&#125;</span><br><span class="line">vhost __defaultVhost__ &#123;</span><br><span class="line">    http_remux &#123;</span><br><span class="line">        enabled     on;</span><br><span class="line">        mount       [vhost]/[app]/[stream].flv;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改<code>conf/origin2.conf</code>，启动<code>./objs/srs -c conf/origin2.conf</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">listen              1936;</span><br><span class="line">max_connections     1000;</span><br><span class="line">pid                 ./objs/origin2.pid;</span><br><span class="line">daemon              off;</span><br><span class="line">srs_log_tank        console;</span><br><span class="line">http_server &#123;</span><br><span class="line">    enabled         on;</span><br><span class="line">    listen          8081;</span><br><span class="line">    dir             ./objs/nginx/html;</span><br><span class="line">&#125;</span><br><span class="line">vhost __defaultVhost__ &#123;</span><br><span class="line">    http_remux &#123;</span><br><span class="line">        enabled     on;</span><br><span class="line">        mount       [vhost]/[app]/[stream].flv;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改<code>conf/edge1.conf</code>，启动<code>./objs/srs -c conf/edge1.conf</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">listen              19350;</span><br><span class="line">max_connections     1000;</span><br><span class="line">pid                 objs/edge1.pid;</span><br><span class="line">daemon              off;</span><br><span class="line">srs_log_tank        console;</span><br><span class="line">vhost __defaultVhost__ &#123;</span><br><span class="line">    cluster &#123;</span><br><span class="line">        mode            remote;</span><br><span class="line">        origin          127.0.0.1:1935 127.0.0.1:1936;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改<code>conf/edge2.conf</code>，启动<code>./objs/srs -c conf/edge2.conf</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">listen              19351;</span><br><span class="line">max_connections     1000;</span><br><span class="line">pid                 objs/edge2.pid;</span><br><span class="line">daemon              off;</span><br><span class="line">srs_log_tank        console;</span><br><span class="line">vhost __defaultVhost__ &#123;</span><br><span class="line">    cluster &#123;</span><br><span class="line">        mode            remote;</span><br><span class="line">        origin          127.0.0.1:1935 127.0.0.1:1936;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p><strong>正常推拉流测试</strong></p>
<p>推流到边缘19351服务。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -re  -i test.flv  -vcodec copy -acodec copy -f flv -y rtmp://127.0.0.1:19351/live/livestream</span><br></pre></td></tr></table></figure>

<p>拉流测试。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Origin</span></span><br><span class="line">ffplay rtmp://127.0.0.1/live/livestream</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Edge1</span></span><br><span class="line">ffplay rtmp://127.0.0.1:19350/live/livestream</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Edge2</span></span><br><span class="line">ffplay rtmp://127.0.0.1:19351/live/livestream</span><br></pre></td></tr></table></figure>

<p><strong>测试同时推流一样的路径</strong></p>
<p>第一次推流到边缘19350，此时源站1935接收到推流数据。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -re  -i test.flv  -vcodec copy -acodec copy -f flv -y rtmp://127.0.0.1:19350/live/livestream</span><br></pre></td></tr></table></figure>

<p>第二次推流到边缘19351，此时源站1935接收到推流数据，由于同样的推流路径，发生报错。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -re  -i test2.flv  -vcodec copy -acodec copy -f flv -y rtmp://127.0.0.1:19350/live/livestream</span><br></pre></td></tr></table></figure>

<p>第二次推流到边缘19351，发生报错内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[2023-10-03 19:26:02.729][ERROR][96226][225iw4qp][35] serve error code=1028(StreamBusy)(Stream already exists or busy) : service cycle : rtmp: stream service : rtmp: stream /live/livestream is busy</span><br><span class="line">thread [96226][225iw4qp]: do_cycle() [./src/app/srs_app_rtmp_conn.cpp:263][errno=35]</span><br><span class="line">thread [96226][225iw4qp]: service_cycle() [./src/app/srs_app_rtmp_conn.cpp:457][errno=35]</span><br><span class="line">thread [96226][225iw4qp]: acquire_publish() [./src/app/srs_app_rtmp_conn.cpp:1079][errno=35](Resource temporarily unavailable)</span><br></pre></td></tr></table></figure>

<p>第三次推流到边缘19351正常（此时由于轮询到源站1936），此时源站1936接收到推流数据。此时无法保证源的唯一性，两个源站有同样的路径，但是播放内容不一样。</p>
<p><strong>测试源站故障情况</strong></p>
<p>推流到边缘19350。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -re  -i test.flv  -vcodec copy -acodec copy -f flv -y rtmp://127.0.0.1:19350/live/livestream</span><br></pre></td></tr></table></figure>

<p>边缘19351拉流。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffplay rtmp://127.0.0.1:19351/live/livestream</span><br></pre></td></tr></table></figure>

<p>断开源站1935（需要边缘推送，边缘只会往一个源站去推送），发现导致推流端断开，推流再推送的时候就会切换源站。</p>
<h1 id="Edge集群源码"><a href="#Edge集群源码" class="headerlink" title="Edge集群源码"></a>Edge集群源码</h1><h2 id="核心类"><a href="#核心类" class="headerlink" title="核心类"></a>核心类</h2><ul>
<li><code>SrsPublishEdge</code>：推流到源站，实际是调用<code>SrsEdgeForwarder</code>来实现。</li>
<li><code>SrsPlayEdge</code>：从源站拉流，实际是调用<code>SrsEdgeIngester</code>来实现。</li>
</ul>
<h2 id="推流端"><a href="#推流端" class="headerlink" title="推流端"></a>推流端</h2><p>边缘结点推流到源站。顺序跟踪源码有时候不好跟，可以通过GDB工具反向查看调用堆栈。</p>
<ul>
<li>通过edge配置文件，断点到<code>SrsConfig::get_vhost_is_edge</code>，查看堆栈内容，主要是判断是否配置了边缘结点。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#0  SrsConfig::get_vhost_is_edge (this=0xa0fcf0, vhost=&quot;defaultVhost&quot;)</span><br><span class="line">    at src/app/srs_app_config.cpp:5063</span><br><span class="line">#1  0x00000000004d4ac8 in SrsRtmpConn::stream_service_cycle (this=0xa2fc50)</span><br><span class="line">    at src/app/srs_app_rtmp_conn.cpp:472</span><br><span class="line">#2  0x00000000004d4141 in SrsRtmpConn::service_cycle (this=0xa2fc50) at src/app/srs_app_rtmp_conn.cpp:388</span><br><span class="line">#3  0x00000000004d2f09 in SrsRtmpConn::do_cycle (this=0xa2fc50) at src/app/srs_app_rtmp_conn.cpp:209</span><br><span class="line">#4  0x00000000004d10fb in SrsConnection::cycle (this=0xa2fcc8) at src/app/srs_app_conn.cpp:171</span><br><span class="line">#5  0x0000000000509c88 in SrsSTCoroutine::cycle (this=0xa2ff00) at src/app/srs_app_st.cpp:198</span><br><span class="line">#6  0x0000000000509cfd in SrsSTCoroutine::pfn (arg=0xa2ff00) at src/app/srs_app_st.cpp:213</span><br><span class="line">#7  0x00000000005bdd9d in st_thread_main () at sched.c:337</span><br><span class="line">#8  0x00000000005be515 in st_thread_create (start=0x5bd719 &lt;st_vp_schedule+170&gt;,</span><br><span class="line">    arg=0x700000001, joinable=1, stk_size=1) at sched.c:616</span><br><span class="line">#0  SrsConfig::get_vhost_is_edge (this=0xa0fcf0, vhost=0xa10b50) at src/app/srs_app_config.cpp:5069</span><br><span class="line">#1  0x0000000000537edc in SrsConfig::get_vhost_is_edge (this=0xa0fcf0, vhost=&quot;defaultVhost&quot;)</span><br><span class="line">    at src/app/srs_app_config.cpp:5065</span><br><span class="line">#2  0x00000000004d4ac8 in SrsRtmpConn::stream_service_cycle (this=0xa2fc50)</span><br><span class="line">    at src/app/srs_app_rtmp_conn.cpp:472</span><br><span class="line">#3  0x00000000004d4141 in SrsRtmpConn::service_cycle (this=0xa2fc50) at src/app/srs_app_rtmp_conn.cpp:388</span><br><span class="line">#4  0x00000000004d2f09 in SrsRtmpConn::do_cycle (this=0xa2fc50) at src/app/srs_app_rtmp_conn.cpp:209</span><br><span class="line">#5  0x00000000004d10fb in SrsConnection::cycle (this=0xa2fcc8) at src/app/srs_app_conn.cpp:171</span><br><span class="line">#6  0x0000000000509c88 in SrsSTCoroutine::cycle (this=0xa2ff00) at src/app/srs_app_st.cpp:198</span><br><span class="line">#7  0x0000000000509cfd in SrsSTCoroutine::pfn (arg=0xa2ff00) at src/app/srs_app_st.cpp:213</span><br><span class="line">#8  0x00000000005bdd9d in st_thread_main () at sched.c:337</span><br><span class="line">#9  0x00000000005be515 in st_thread_create (start=0x5bd719 &lt;st_vp_schedule+170&gt;,</span><br><span class="line">    arg=0x700000001, joinable=1, stk_size=1) at sched.c:616</span><br></pre></td></tr></table></figure>

<ul>
<li>断点<code>SrsConfig::get_vhost_edge_origin</code>。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#0  SrsConfig::get_vhost_edge_origin (this=0xa0fcf0, vhost=&quot;defaultVhost&quot;)</span><br><span class="line">    at src/app/srs_app_config.cpp:5091</span><br><span class="line">#1  0x000000000057ab62 in SrsEdgeForwarder::start (this=0xa3b5d0) at src/app/srs_app_edge.cpp:482</span><br><span class="line">#2  0x000000000057c4b2 in SrsPublishEdge::on_client_publish (this=0xa3aa50) at src/app/srs_app_edge.cpp:777</span><br><span class="line">#3  0x00000000004e74a9 in SrsSource::on_edge_start_publish (this=0xa3af10)</span><br><span class="line">    at src/app/srs_app_source.cpp:2592</span><br><span class="line">#4  0x00000000004d8996 in SrsRtmpConn::acquire_publish (this=0xa2fc50, source=0xa3af10)</span><br><span class="line">    at src/app/srs_app_rtmp_conn.cpp:936</span><br><span class="line">#5  0x00000000004d7a74 in SrsRtmpConn::publishing (this=0xa2fc50, source=0xa3af10)</span><br><span class="line">    at src/app/srs_app_rtmp_conn.cpp:822</span><br><span class="line">#6  0x00000000004d5229 in SrsRtmpConn::stream_service_cycle (this=0xa2fc50)</span><br><span class="line">    at src/app/srs_app_rtmp_conn.cpp:534</span><br><span class="line">#7  0x00000000004d4141 in SrsRtmpConn::service_cycle (this=0xa2fc50) at src/app/srs_app_rtmp_conn.cpp:388</span><br><span class="line">#8  0x00000000004d2f09 in SrsRtmpConn::do_cycle (this=0xa2fc50) at src/app/srs_app_rtmp_conn.cpp:209</span><br><span class="line">#9  0x00000000004d10fb in SrsConnection::cycle (this=0xa2fcc8) at src/app/srs_app_conn.cpp:171</span><br><span class="line">#10 0x0000000000509c88 in SrsSTCoroutine::cycle (this=0xa2ff00) at src/app/srs_app_st.cpp:198</span><br><span class="line">#11 0x0000000000509cfd in SrsSTCoroutine::pfn (arg=0xa2ff00) at src/app/srs_app_st.cpp:213</span><br><span class="line">#12 0x00000000005bdd9d in st_thread_main () at sched.c:337</span><br><span class="line">#13 0x00000000005be515 in st_thread_create (start=0x5bd719 &lt;st_vp_schedule+170&gt;, </span><br><span class="line">    arg=0x700000001, joinable=1, stk_size=1) at sched.c:616</span><br></pre></td></tr></table></figure>

<ul>
<li>通过是否配置<code>info-&gt;edge</code>走不同分支。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::acquire_publish</span><span class="params">(SrsSource* source)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!source-&gt;<span class="built_in">can_publish</span>(info-&gt;edge)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_SYSTEM_STREAM_BUSY, </span><br><span class="line">                             <span class="string">&quot;rtmp: stream %s is busy&quot;</span>, </span><br><span class="line">                             req-&gt;<span class="built_in">get_stream_url</span>().<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// when edge, ignore the publish event, directly proxy it.</span></span><br><span class="line">    <span class="keyword">if</span> (info-&gt;edge) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">on_edge_start_publish</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: edge start publish&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  <span class="comment">//非边缘结点分支</span></span><br><span class="line">        <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">on_publish</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: source publish&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>上述<code>source-&gt;on_edge_start_publish</code>最终调用到<code>SrsPublishEdge::on_client_publish</code>，其中内部实际调用了<code>forwarder-&gt;start</code>启动协程推流到源站。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsPublishEdge::on_client_publish</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// error when not init state.</span></span><br><span class="line">    <span class="keyword">if</span> (state != SrsEdgeStateInit) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_RTMP_EDGE_PUBLISH_STATE, <span class="string">&quot;invalid state&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/180</span></span><br><span class="line">    <span class="comment">// to avoid multiple publish the same stream on the same edge,</span></span><br><span class="line">    <span class="comment">// directly enter the publish stage.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsEdgeState pstate = state;</span><br><span class="line">        state = SrsEdgeStatePublish;</span><br><span class="line">        <span class="built_in">srs_trace</span>(<span class="string">&quot;edge change from %d to state %d (push).&quot;</span>, pstate, state);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// start to forward stream to origin.</span></span><br><span class="line">    err = forwarder-&gt;<span class="built_in">start</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/180</span></span><br><span class="line">    <span class="comment">// when failed, revert to init</span></span><br><span class="line">    <span class="keyword">if</span> (err != srs_success) &#123;</span><br><span class="line">        SrsEdgeState pstate = state;</span><br><span class="line">        state = SrsEdgeStateInit;</span><br><span class="line">        <span class="built_in">srs_trace</span>(<span class="string">&quot;edge revert from %d to state %d (push), error %s&quot;</span>, </span><br><span class="line">                  pstate, state, <span class="built_in">srs_error_desc</span>(err).<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>协程函数读取数据并推送到源端。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsEdgeForwarder::do_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    sdk-&gt;<span class="built_in">set_recv_timeout</span>(SRS_CONSTS_RTMP_PULSE);</span><br><span class="line">    </span><br><span class="line">    SrsPithyPrint* pprint = SrsPithyPrint::<span class="built_in">create_edge</span>();</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsPithyPrint, pprint);</span><br><span class="line">    </span><br><span class="line">    <span class="function">SrsMessageArray <span class="title">msgs</span><span class="params">(SYS_MAX_EDGE_SEND_MSGS)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;edge forward pull&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (send_error_code != ERROR_SUCCESS) &#123;</span><br><span class="line">            <span class="built_in">srs_usleep</span>(SRS_EDGE_FORWARDER_TIMEOUT);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// read from client.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            SrsCommonMessage* msg = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="comment">//sdk 是 edge-&gt;origin的rtmp推流客户端</span></span><br><span class="line">            err = sdk-&gt;<span class="built_in">recv_message</span>(&amp;msg);</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">srs_verbose</span>(<span class="string">&quot;edge loop recv message. ret=%d&quot;</span>, ret);</span><br><span class="line">            <span class="keyword">if</span> (err != srs_success &amp;&amp; <span class="built_in">srs_error_code</span>(err) != ERROR_SOCKET_TIMEOUT) &#123;</span><br><span class="line">                <span class="built_in">srs_error</span>(<span class="string">&quot;edge push get server control message failed. err=%s&quot;</span>,</span><br><span class="line">                          <span class="built_in">srs_error_desc</span>(err).<span class="built_in">c_str</span>());</span><br><span class="line">                send_error_code = <span class="built_in">srs_error_code</span>(err);</span><br><span class="line">                <span class="built_in">srs_error_reset</span>(err);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">srs_error_reset</span>(err);</span><br><span class="line">            <span class="built_in">srs_freep</span>(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// forward all messages.</span></span><br><span class="line">        <span class="comment">// each msg in msgs.msgs must be free, for the SrsMessageArray never free them.</span></span><br><span class="line">        <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//读取音视频数据</span></span><br><span class="line">        <span class="keyword">if</span> ((err = queue-&gt;<span class="built_in">dump_packets</span>(msgs.max, msgs.msgs, count)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;queue dumps packets&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        pprint-&gt;<span class="built_in">elapse</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// pithy print</span></span><br><span class="line">        <span class="keyword">if</span> (pprint-&gt;<span class="built_in">can_print</span>()) &#123;</span><br><span class="line">            sdk-&gt;<span class="built_in">kbps_sample</span>(SRS_CONSTS_LOG_EDGE_PUBLISH, pprint-&gt;<span class="built_in">age</span>(), count);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ignore when no messages.</span></span><br><span class="line">        <span class="keyword">if</span> (count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">srs_verbose</span>(<span class="string">&quot;edge no packets to push.&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// sendout messages, all messages are freed by send_and_free_messages().</span></span><br><span class="line">        <span class="comment">//将客户端推流到edge的数据，从edge推送到origin</span></span><br><span class="line">        <span class="keyword">if</span> ((err = sdk-&gt;<span class="built_in">send_and_free_messages</span>(msgs.msgs, count)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send messages&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>继续跟踪从哪里放数据到队列中，可以找到<code>SrsEdgeForwarder::proxy</code>中调用<code>queue-&gt;enqueue</code>，至于哪里调用<code>SrsEdgeForwarder::proxy</code>可以搜索，或者打个断点，看下堆栈：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#0  SrsEdgeForwarder::proxy (this=0xa3b5b0, msg=0xb10ab0) at src/app/srs_app_edge.cpp:624</span><br><span class="line">#1  0x000000000057c5ee in SrsPublishEdge::on_proxy_publish (this=0xa3aa30, msg=0xb10ab0)</span><br><span class="line">    at src/app/srs_app_edge.cpp:792</span><br><span class="line">#2  0x00000000004e74e2 in SrsSource::on_edge_proxy_publish (this=0xa3aef0, msg=0xb10ab0)</span><br><span class="line">    at src/app/srs_app_source.cpp:2598</span><br><span class="line">#3  0x00000000004d8ea9 in SrsRtmpConn::process_publish_message (this=0xa3ba50, source=0xa3aef0, msg=0xb10ab0) at src/app/srs_app_rtmp_conn.cpp:1006</span><br><span class="line">#4  0x00000000004d8dce in SrsRtmpConn::handle_publish_message (this=0xa3ba50, source=0xa3aef0, msg=0xb10ab0)</span><br><span class="line">    at src/app/srs_app_rtmp_conn.cpp:993</span><br><span class="line">#5  0x00000000005810b6 in SrsPublishRecvThread::consume (this=0x7ffff7f66800, msg=0xb10ab0)</span><br><span class="line">    at src/app/srs_app_recv_thread.cpp:389</span><br><span class="line">#6  0x000000000057fbd4 in SrsRecvThread::do_cycle (this=0x7ffff7f66808)</span><br><span class="line">    at src/app/srs_app_recv_thread.cpp:146</span><br><span class="line">#7  0x000000000057fa25 in SrsRecvThread::cycle (this=0x7ffff7f66808) at src/app/srs_app_recv_thread.cpp:115</span><br><span class="line">#8  0x0000000000509c88 in SrsSTCoroutine::cycle (this=0xa46540) at src/app/srs_app_st.cpp:198</span><br><span class="line">#9  0x0000000000509cfd in SrsSTCoroutine::pfn (arg=0xa46540) at src/app/srs_app_st.cpp:213</span><br><span class="line">#10 0x00000000005bdd9d in _st_thread_main () at sched.c:337</span><br><span class="line">#11 0x00000000005be515 in st_thread_create (start=0xa47720, arg=0x7ffff7f66530, joinable=32767,</span><br><span class="line">    stk_size=-134847200) at sched.c:616</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsRtmpConn::process_publish_message</code>作为边缘结点的话只处理<code>info-&gt;edge</code>分支内的流程。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::process_publish_message</span><span class="params">(SrsSource* source, SrsCommonMessage* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// for edge, directly proxy message to origin.</span></span><br><span class="line">    <span class="keyword">if</span> (info-&gt;edge) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">on_edge_proxy_publish</span>(msg)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: proxy publish&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最终一层层调用调用到<code>SrsEdgeForwarder::proxy</code>，<code>queue-&gt;enqueue</code>放入音视频数据。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsPublishEdge::on_proxy_publish</span><span class="params">(SrsCommonMessage* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> forwarder-&gt;<span class="built_in">proxy</span>(msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsEdgeForwarder::proxy</span><span class="params">(SrsCommonMessage* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (send_error_code != ERROR_SUCCESS) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(send_error_code, <span class="string">&quot;edge forwarder&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// the msg is auto free by source,</span></span><br><span class="line">    <span class="comment">// so we just ignore, or copy then send it.</span></span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;size &lt;= <span class="number">0</span></span><br><span class="line">        || msg-&gt;header.<span class="built_in">is_set_chunk_size</span>()</span><br><span class="line">        || msg-&gt;header.<span class="built_in">is_window_ackledgement_size</span>()</span><br><span class="line">        || msg-&gt;header.<span class="built_in">is_ackledgement</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    SrsSharedPtrMessage copy;</span><br><span class="line">    <span class="keyword">if</span> ((err = copy.<span class="built_in">create</span>(msg)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;create message&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    copy.stream_id = sdk-&gt;<span class="built_in">sid</span>();</span><br><span class="line">    <span class="keyword">if</span> ((err = queue-&gt;<span class="built_in">enqueue</span>(copy.<span class="built_in">copy</span>())) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;enqueue message&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="拉流端"><a href="#拉流端" class="headerlink" title="拉流端"></a>拉流端</h2><p>边缘结点从源站拉流。</p>
<ul>
<li>断点<code>SrsEdgeIngester::do_cycle</code>，拉流端也会有协程函数。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#0  SrsEdgeIngester::do_cycle (this=0xa3b080) at src/app/srs_app_edge.cpp:282</span><br><span class="line">#1  0x000000000057931d in SrsEdgeIngester::cycle (this=0xa3b080) at src/app/srs_app_edge.cpp:243</span><br><span class="line">#2  0x0000000000509c88 in SrsSTCoroutine::cycle (this=0xab72f0) at src/app/srs_app_st.cpp:198</span><br><span class="line">#3  0x0000000000509cfd in SrsSTCoroutine::pfn (arg=0xab72f0) at src/app/srs_app_st.cpp:213</span><br><span class="line">#4  0x00000000005bdd9d in _st_thread_main () at sched.c:337</span><br></pre></td></tr></table></figure>

<ul>
<li>协程函数中调用了<code>SrsEdgeIngester::ingest</code>，读取数据<code>upstream-&gt;recv_message</code>，随后调用<code>process_publish_message</code>，从源站拉流后通过<code>SrsSource</code>分发。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsEdgeIngester::ingest</span><span class="params">(string&amp; redirect)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    SrsPithyPrint* pprint = SrsPithyPrint::<span class="built_in">create_edge</span>();</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsPithyPrint, pprint);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// we only use the redict once.</span></span><br><span class="line">    <span class="comment">// reset the redirect to empty, for maybe the origin changed.</span></span><br><span class="line">    redirect = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;thread quit&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        pprint-&gt;<span class="built_in">elapse</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// pithy print</span></span><br><span class="line">        <span class="keyword">if</span> (pprint-&gt;<span class="built_in">can_print</span>()) &#123;</span><br><span class="line">            upstream-&gt;<span class="built_in">kbps_sample</span>(SRS_CONSTS_LOG_EDGE_PLAY, pprint-&gt;<span class="built_in">age</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// read from client.</span></span><br><span class="line">        SrsCommonMessage* msg = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = upstream-&gt;<span class="built_in">recv_message</span>(&amp;msg)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv message&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">srs_assert</span>(msg);</span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(SrsCommonMessage, msg);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">process_publish_message</span>(msg, redirect)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;process message&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/10/05/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BForward%E9%9B%86%E7%BE%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/05/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BForward%E9%9B%86%E7%BE%A4/" class="post-title-link" itemprop="url">SRS流媒体服务器之Forward集群</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-10-05 09:17:48" itemprop="dateCreated datePublished" datetime="2023-10-05T09:17:48+08:00">2023-10-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-12-30 22:37:32" itemprop="dateModified" datetime="2023-12-30T22:37:32+08:00">2023-12-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SRS/" itemprop="url" rel="index"><span itemprop="name">SRS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Forward集群原理和配置"><a href="#Forward集群原理和配置" class="headerlink" title="Forward集群原理和配置"></a>Forward集群原理和配置</h1><h2 id="Forward集群简介"><a href="#Forward集群简介" class="headerlink" title="Forward集群简介"></a>Forward集群简介</h2><p>在SRS中可以理解为把Master节点获得直播流广播给所有的Slave节点。我觉得广播这个词可能要比Forward更容易理解。也可以理解为转发，即Master把接收到的所有流都转发给Slave节点，即Master节点由多少路直播流，那么在每个Slave节点也会多少路直播流。</p>
<p>注：在SRS中还有另外一种集群方式，Edge方式。注意两种方式的用词不同。</p>
<ul>
<li>Forward模式中，中心节点叫Master，边缘节点叫Slave。</li>
<li>Edge模式中，中心节点叫Origin（源站），边缘节点叫做Edge（边缘）。</li>
</ul>
<h2 id="Forward集群适用场景"><a href="#Forward集群适用场景" class="headerlink" title="Forward集群适用场景"></a>Forward集群适用场景</h2><p>Forward适合搭建小型集群，为什么这么说呢？因为每个slave节点都和master节点有相同数量的直播流，那么请看下图（从右往左，1、2、3是步骤）：</p>
<img src="/2023/10/05/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BForward%E9%9B%86%E7%BE%A4/Forward集群.png" alt="Forward集群" style="zoom:50%;">

<p>推流者推流给Master，那么Master就会Forward到每一个Slave。那么在Slave节点上不论需不需要都会有Master过来的流。试想一下，如果推流者的数量为10，那么Master到Slave之间的带宽就是：带宽&#x3D;10 * Slave的个数 *直播流码率，随着Slave的增多，Master的出口带宽会不断提高。而现实是，在某些Slave节点其实根本没有人看……这样就造成了Master到Slave之间的带宽浪费。</p>
<h2 id="Forward集群部署实例"><a href="#Forward集群部署实例" class="headerlink" title="Forward集群部署实例"></a>Forward集群部署实例</h2><h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><p>修改<code>conf/forward.master.conf</code>，启动<code>./objs/srs -c conf/forward.master.conf</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">listen              1935;</span><br><span class="line">max_connections     1000;</span><br><span class="line">pid                 ./objs/srs.master.pid;</span><br><span class="line">daemon              off;</span><br><span class="line">srs_log_tank        console;</span><br><span class="line">vhost __defaultVhost__ &#123;</span><br><span class="line">    forward &#123;</span><br><span class="line">        enabled on;</span><br><span class="line">        destination 127.0.0.1:19350;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改<code>conf/forward.slave.conf</code>，<code>./objs/srs -c conf/forward.slave.conf</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">listen              19350;</span><br><span class="line">max_connections     1000;</span><br><span class="line">pid                 ./objs/srs.slave.pid;</span><br><span class="line">daemon              off;</span><br><span class="line">srs_log_tank        console;</span><br><span class="line">vhost __defaultVhost__ &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改<code>conf/forward.slave2.conf</code>，<code>./objs/srs -c conf/forward.slave2.conf</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">listen              19351;</span><br><span class="line">max_connections     1000;</span><br><span class="line">pid                 ./objs/srs.slave2.pid;</span><br><span class="line">daemon              off;</span><br><span class="line">srs_log_tank        console;</span><br><span class="line">vhost __defaultVhost__ &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>推流到Master</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -re  -i test.flv  -vcodec copy -acodec copy -f flv -y rtmp://127.0.0.1/live/livestream</span><br></pre></td></tr></table></figure>

<p>拉流测试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Master</span></span><br><span class="line">ffplay rtmp://127.0.0.1/live/livestream</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Slave</span></span><br><span class="line">ffplay rtmp://127.0.0.1:19350/live/livestream</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Slave2</span></span><br><span class="line">ffplay rtmp://127.0.0.1:19351/live/livestream</span><br></pre></td></tr></table></figure>

<h1 id="Forward集群源码"><a href="#Forward集群源码" class="headerlink" title="Forward集群源码"></a>Forward集群源码</h1><p>Forward集群模式只能将流推送到Master结点，所以Slave结点没有推流端，只有拉流端。</p>
<ul>
<li>断点<code>SrsConfig::get_forward_enabled</code>。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#0  SrsConfig::get_forward_enabled (this=0xa0fcf0, vhost=&quot;defaultVhost&quot;) at</span><br><span class="line">src/app/srs_app_config.cpp:4821</span><br><span class="line">#1  0x00000000004e1aa2 in SrsOriginHub::create_forwarders (this=0xa3a5b0) at</span><br><span class="line">src/app/srs_app_source.cpp:1467</span><br><span class="line">#2  0x00000000004e053c in SrsOriginHub::on_publish (this=0xa3a5b0) at</span><br><span class="line">src/app/srs_app_source.cpp:1120</span><br><span class="line">#3  0x00000000004e6a0b in SrsSource::on_publish (this=0xa3a120) at</span><br><span class="line">src/app/srs_app_source.cpp:2460</span><br><span class="line">#4  0x00000000004d89f2 in SrsRtmpConn::acquire_publish (this=0xa2fca0, source=0xa3a120)</span><br><span class="line">bool SrsConfig::get_forward_enabled(string vhost) &#123; static bool DEFAULT = false; SrsConfDirective* conf = get_vhost(vhost); if (!conf) &#123; return DEFAULT; &#125;conf = conf-&gt;get(&quot;forward&quot;); if (!conf) &#123; return DEFAULT; &#125;conf = conf-&gt;get(&quot;enabled&quot;); if (!conf || conf-&gt;arg0().empty()) &#123; return DEFAULT; &#125;return SRS_CONF_PERFER_FALSE(conf-&gt;arg0()); &#125;SrsConfDirective* SrsConfig::get_forwards(string vhost) &#123; SrsConfDirective* conf = get_vhost(vhost); if (!conf) &#123; return NULL; &#125;conf = conf-&gt;get(&quot;forward&quot;); if (!conf) &#123; return NULL; &#125;return conf-&gt;get(&quot;destination&quot;); &#125;</span><br><span class="line">    at src/app/srs_app_rtmp_conn.cpp:940</span><br><span class="line">#5  0x00000000004d7a74 in SrsRtmpConn::publishing (this=0xa2fca0, source=0xa3a120)</span><br><span class="line">    at src/app/srs_app_rtmp_conn.cpp:822</span><br><span class="line">#6  0x00000000004d5229 in SrsRtmpConn::stream_service_cycle (this=0xa2fca0) </span><br><span class="line">    at src/app/srs_app_rtmp_conn.cpp:534</span><br><span class="line">#7  0x00000000004d4141 in SrsRtmpConn::service_cycle (this=0xa2fca0) at src/app/srs_app_rtmp_conn.cpp:388</span><br><span class="line">#8  0x00000000004d2f09 in SrsRtmpConn::do_cycle (this=0xa2fca0) at src/app/srs_app_rtmp_conn.cpp:209</span><br><span class="line">#9  0x00000000004d10fb in SrsConnection::cycle (this=0xa2fd18) at src/app/srs_app_conn.cpp:171</span><br><span class="line">#10 0x0000000000509c88 in SrsSTCoroutine::cycle (this=0xa2ff50) at src/app/srs_app_st.cpp:198</span><br><span class="line">#11 0x0000000000509cfd in SrsSTCoroutine::pfn (arg=0xa2ff50) at src/app/srs_app_st.cpp:213</span><br><span class="line">#12 0x00000000005bdd9d in st_thread_main () at sched.c:337</span><br><span class="line">#13 0x00000000005be515 in st_thread_create (start=0x5bd719 &lt;st_vp_schedule+170&gt;,</span><br><span class="line">    arg=0x700000001, joinable=1, stk_size=1) at sched.c:616</span><br></pre></td></tr></table></figure>

<ul>
<li>根据断点，看下<code>SrsRtmpConn::acquire_publish</code>其中<code>info-&gt;edge</code>分支是用来edge边缘推流的，该流程处理另一个分支内<code>source-&gt;on_publish</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::acquire_publish</span><span class="params">(SrsSource* source)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!source-&gt;<span class="built_in">can_publish</span>(info-&gt;edge)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_SYSTEM_STREAM_BUSY, </span><br><span class="line">                             <span class="string">&quot;rtmp: stream %s is busy&quot;</span>, </span><br><span class="line">                             req-&gt;<span class="built_in">get_stream_url</span>().<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// when edge, ignore the publish event, directly proxy it.</span></span><br><span class="line">    <span class="keyword">if</span> (info-&gt;edge) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">on_edge_start_publish</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: edge start publish&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">on_publish</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: source publish&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用<code>source-&gt;on_publish</code>进入<code>SrsOriginHub::on_publish</code>，创建<code>SrsForwarder</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsOriginHub::on_publish</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// create forwarders</span></span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">create_forwarders</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;create forwarders&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> use initialize to set req.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = encoder-&gt;<span class="built_in">on_publish</span>(req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;encoder publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = hls-&gt;<span class="built_in">on_publish</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = dash-&gt;<span class="built_in">on_publish</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;dash publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = dvr-&gt;<span class="built_in">on_publish</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;dvr publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> use initialize to set req.</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_AUTO_HDS</span></span><br><span class="line">    <span class="keyword">if</span> ((err = hds-&gt;<span class="built_in">on_publish</span>(req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hds publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> use initialize to set req.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = ng_exec-&gt;<span class="built_in">on_publish</span>(req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;exec publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    is_active = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><code>create_forwarders</code>读取配置文件创建<code>SrsForwarder</code>，并通过<code>forwarder-&gt;on_publish</code>启动协程。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsOriginHub::create_forwarders</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//是否开启enable</span></span><br><span class="line">    <span class="keyword">if</span> (!_srs_config-&gt;<span class="built_in">get_forward_enabled</span>(req-&gt;vhost)) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//多个forwards</span></span><br><span class="line">    SrsConfDirective* conf = _srs_config-&gt;<span class="built_in">get_forwards</span>(req-&gt;vhost);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; conf &amp;&amp; i &lt; (<span class="type">int</span>)conf-&gt;args.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        std::string forward_server = conf-&gt;args.<span class="built_in">at</span>(i);</span><br><span class="line">        </span><br><span class="line">        SrsForwarder* forwarder = <span class="keyword">new</span> <span class="built_in">SrsForwarder</span>(<span class="keyword">this</span>);</span><br><span class="line">        forwarders.<span class="built_in">push_back</span>(forwarder);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// initialize the forwarder with request.</span></span><br><span class="line">        <span class="keyword">if</span> ((err = forwarder-&gt;<span class="built_in">initialize</span>(req, forward_server)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;init forwarder&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">srs_utime_t</span> queue_size = _srs_config-&gt;<span class="built_in">get_queue_length</span>(req-&gt;vhost);</span><br><span class="line">        forwarder-&gt;<span class="built_in">set_queue_size</span>(queue_size);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//on_publish启动协程</span></span><br><span class="line">        <span class="keyword">if</span> ((err = forwarder-&gt;<span class="built_in">on_publish</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;start forwarder failed, vhost=%s, app=%s, stream=%s, forward-to=%s&quot;</span>,</span><br><span class="line">                req-&gt;vhost.<span class="built_in">c_str</span>(), req-&gt;app.<span class="built_in">c_str</span>(), req-&gt;stream.<span class="built_in">c_str</span>(), forward_server.<span class="built_in">c_str</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>启动<code>SrsForwarder</code>协程，进入回调<code>SrsForwarder::do_cycle</code>，主要在<code>forward</code>中循环读取队列中的数据，并转发给客户端。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsForwarder::do_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    std::string url;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        std::string server;</span><br><span class="line">        <span class="type">int</span> port = SRS_CONSTS_RTMP_DEFAULT_PORT;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// parse host:port from hostport.</span></span><br><span class="line">        <span class="built_in">srs_parse_hostport</span>(ep_forward, server, port);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// generate url</span></span><br><span class="line">        url = <span class="built_in">srs_generate_rtmp_url</span>(server, port, req-&gt;host, req-&gt;vhost, req-&gt;app, req-&gt;stream, req-&gt;param);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_freep</span>(sdk);</span><br><span class="line">    <span class="type">srs_utime_t</span> cto = SRS_FORWARDER_CIMS;</span><br><span class="line">    <span class="type">srs_utime_t</span> sto = SRS_CONSTS_RTMP_TIMEOUT;</span><br><span class="line">    sdk = <span class="keyword">new</span> <span class="built_in">SrsSimpleRtmpClient</span>(url, cto, sto);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = sdk-&gt;<span class="built_in">connect</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;sdk connect url=%s, cto=%dms, sto=%dms.&quot;</span>, </span><br><span class="line">                              url.<span class="built_in">c_str</span>(), <span class="built_in">srsu2msi</span>(cto), <span class="built_in">srsu2msi</span>(sto));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = sdk-&gt;<span class="built_in">publish</span>(_srs_config-&gt;<span class="built_in">get_chunk_size</span>(req-&gt;vhost))) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;sdk publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = hub-&gt;<span class="built_in">on_forwarder_start</span>(<span class="keyword">this</span>)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;notify hub start&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = forward()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;forward&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>sdk-&gt;recv_message</code>用来处理客户端消息命令，<code>queue-&gt;dump_packets</code>获取音视频数据，<code>sdk-&gt;send_and_free_messages</code>发送给客户端。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsForwarder::forward</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    sdk-&gt;<span class="built_in">set_recv_timeout</span>(SRS_CONSTS_RTMP_PULSE);</span><br><span class="line">    </span><br><span class="line">    SrsPithyPrint* pprint = SrsPithyPrint::<span class="built_in">create_forwarder</span>();</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsPithyPrint, pprint);</span><br><span class="line">    </span><br><span class="line">    <span class="function">SrsMessageArray <span class="title">msgs</span><span class="params">(SYS_MAX_FORWARD_SEND_MSGS)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// update sequence header</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> maybe need to zero the sequence header timestamp.</span></span><br><span class="line">    <span class="keyword">if</span> (sh_video) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = sdk-&gt;<span class="built_in">send_and_free_message</span>(sh_video-&gt;<span class="built_in">copy</span>())) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send video sh&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (sh_audio) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = sdk-&gt;<span class="built_in">send_and_free_message</span>(sh_audio-&gt;<span class="built_in">copy</span>())) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send audio sh&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;thread quit&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        pprint-&gt;<span class="built_in">elapse</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// read from client.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            SrsCommonMessage* msg = <span class="literal">NULL</span>;</span><br><span class="line">            err = sdk-&gt;<span class="built_in">recv_message</span>(&amp;msg);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (err != srs_success &amp;&amp; <span class="built_in">srs_error_code</span>(err) != ERROR_SOCKET_TIMEOUT) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;receive control message&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">srs_error_reset</span>(err);</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">srs_freep</span>(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// forward all messages.</span></span><br><span class="line">        <span class="comment">// each msg in msgs.msgs must be free, for the SrsMessageArray never free them.</span></span><br><span class="line">        <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = queue-&gt;<span class="built_in">dump_packets</span>(msgs.max, msgs.msgs, count)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;dump packets&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// pithy print</span></span><br><span class="line">        <span class="keyword">if</span> (pprint-&gt;<span class="built_in">can_print</span>()) &#123;</span><br><span class="line">            sdk-&gt;<span class="built_in">kbps_sample</span>(SRS_CONSTS_LOG_FOWARDER, pprint-&gt;<span class="built_in">age</span>(), count);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ignore when no messages.</span></span><br><span class="line">        <span class="keyword">if</span> (count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// sendout messages, all messages are freed by send_and_free_messages().</span></span><br><span class="line">        <span class="keyword">if</span> ((err = sdk-&gt;<span class="built_in">send_and_free_messages</span>(msgs.msgs, count)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send messages&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>继续跟踪从哪里放数据到队列中，可以找到<code>SrsForwarder::on_meta_data</code>、<code>SrsForwarder::on_audio</code>和<code>SrsForwarder::on_video</code>中调用<code>queue-&gt;enqueue</code>，以<code>SrsForwarder::on_meta_data</code>为例，打个断点，看下堆栈：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#0  SrsForwarder::on_meta_data (this=0xa3b960, shared_metadata=0xa45f00) at src/app/srs_app_forward.cpp:114</span><br><span class="line">#1  0x00000000004dea69 in SrsOriginHub::on_meta_data (this=0xa3a5b0, </span><br><span class="line">    shared_metadata=0xa45f00, packet=0xa45e60 at src/app/srs_app_source.cpp:924</span><br><span class="line">#2  0x00000000004e516f in SrsSource::on_meta_data (this=0xa3a120, msg=0xa45c80, metadata=0xa45e60)</span><br><span class="line">    at src/app/srs_app_source.cpp:2116</span><br><span class="line">#3  0x00000000004d91bb in SrsRtmpConn::process_publish_message (this=0xa2fca0, source=0xa3a120, msg=0xa45c80)</span><br><span class="line">    at src/app/srs_app_rtmp_conn.cpp:1045</span><br><span class="line">#4  0x00000000004d8dce in SrsRtmpConn::handle_publish_message (this=0xa2fca0, source=0xa3a120, msg=0xa45c80)</span><br><span class="line">    at src/app/srs_app_rtmp_conn.cpp:993</span><br><span class="line">#5  0x00000000005810b6 in SrsPublishRecvThread::consume (this=0x7ffff7f66800, msg=0xa45c80)</span><br><span class="line">    at src/app/srs_app_recv_thread.cpp:389</span><br><span class="line">#6  0x000000000057fbd4 in SrsRecvThread::do_cycle (this=0x7ffff7f66808) </span><br><span class="line">    at src/app/srs_app_recv_thread.cpp:146</span><br><span class="line">#7  0x000000000057fa25 in SrsRecvThread::cycle (this=0x7ffff7f66808) at src/app/srs_app_recv_thread.cpp:115</span><br><span class="line">#8  0x0000000000509c88 in SrsSTCoroutine::cycle (this=0xa3a840) at src/app/srs_app_st.cpp:198</span><br><span class="line">#9  0x0000000000509cfd in SrsSTCoroutine::pfn (arg=0xa3a840) at src/app/srs_app_st.cpp:213</span><br><span class="line">#10 0x00000000005bdd9d in _st_thread_main () at sched.c:337</span><br><span class="line">#11 0x00000000005be515 in st_thread_create (start=0xa3bc30,</span><br><span class="line">    arg=0x7ffff7f66530, joinable=32767, stk_size=-134847200) at sched.c:616</span><br></pre></td></tr></table></figure>

<ul>
<li>对于<code>SrsSource::on_meta_data</code>、<code>SrsSource::on_audio</code>和<code>SrsSource::on_video</code>用来接收数据，例如<code>SrsSource::on_meta_data</code>继续调用<code>hub-&gt;on_meta_data</code>其中<code>SrsOriginHub</code>用来转发数据的类；下面以<code>on_meta_data</code>为例。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsSource::on_meta_data</span><span class="params">(SrsCommonMessage* msg, SrsOnMetaDataPacket* metadata)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if allow atc_auto and bravo-atc detected, open atc for vhost.</span></span><br><span class="line">    SrsAmf0Any* prop = <span class="literal">NULL</span>;</span><br><span class="line">    atc = _srs_config-&gt;<span class="built_in">get_atc</span>(req-&gt;vhost);</span><br><span class="line">    <span class="keyword">if</span> (_srs_config-&gt;<span class="built_in">get_atc_auto</span>(req-&gt;vhost)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((prop = metadata-&gt;metadata-&gt;<span class="built_in">get_property</span>(<span class="string">&quot;bravo_atc&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (prop-&gt;<span class="built_in">is_string</span>() &amp;&amp; prop-&gt;<span class="built_in">to_str</span>() == <span class="string">&quot;true&quot;</span>) &#123;</span><br><span class="line">                atc = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Update the meta cache.</span></span><br><span class="line">    <span class="type">bool</span> updated = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> ((err = meta-&gt;<span class="built_in">update_data</span>(&amp;msg-&gt;header, metadata, updated)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;update metadata&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!updated) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// when already got metadata, drop when reduce sequence header.</span></span><br><span class="line">    <span class="type">bool</span> drop_for_reduce = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (meta-&gt;<span class="built_in">data</span>() &amp;&amp; _srs_config-&gt;<span class="built_in">get_reduce_sequence_header</span>(req-&gt;vhost)) &#123;</span><br><span class="line">        drop_for_reduce = <span class="literal">true</span>;</span><br><span class="line">        <span class="built_in">srs_warn</span>(<span class="string">&quot;drop for reduce sh metadata, size=%d&quot;</span>, msg-&gt;size);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// copy to all consumer</span></span><br><span class="line">    <span class="keyword">if</span> (!drop_for_reduce) &#123;</span><br><span class="line">        std::vector&lt;SrsConsumer*&gt;::iterator it;</span><br><span class="line">        <span class="keyword">for</span> (it = consumers.<span class="built_in">begin</span>(); it != consumers.<span class="built_in">end</span>(); ++it) &#123;</span><br><span class="line">            SrsConsumer* consumer = *it;</span><br><span class="line">            <span class="keyword">if</span> ((err = consumer-&gt;<span class="built_in">enqueue</span>(meta-&gt;<span class="built_in">data</span>(), atc, jitter_algorithm)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;consume metadata&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Copy to hub to all utilities.</span></span><br><span class="line">    <span class="keyword">return</span> hub-&gt;<span class="built_in">on_meta_data</span>(meta-&gt;<span class="built_in">data</span>(), metadata);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsOriginHub::on_meta_data</code>继续调用<code>forwarder-&gt;on_meta_data</code>，转发数据给<code>SrsForwarder</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsOriginHub::on_meta_data</span><span class="params">(SrsSharedPtrMessage* shared_metadata, SrsOnMetaDataPacket* packet)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = format-&gt;<span class="built_in">on_metadata</span>(packet)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;Format parse metadata&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// copy to all forwarders</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        std::vector&lt;SrsForwarder*&gt;::iterator it;</span><br><span class="line">        <span class="keyword">for</span> (it = forwarders.<span class="built_in">begin</span>(); it != forwarders.<span class="built_in">end</span>(); ++it) &#123;</span><br><span class="line">            SrsForwarder* forwarder = *it;</span><br><span class="line">            <span class="keyword">if</span> ((err = forwarder-&gt;<span class="built_in">on_meta_data</span>(shared_metadata)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;Forwarder consume metadata&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = dvr-&gt;<span class="built_in">on_meta_data</span>(shared_metadata)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;DVR consume metadata&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最终看到<code>SrsForwarder::on_meta_data</code>将数据放入队列。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsForwarder::on_meta_data</span><span class="params">(SrsSharedPtrMessage* shared_metadata)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    SrsSharedPtrMessage* metadata = shared_metadata-&gt;<span class="built_in">copy</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> config the jitter of Forwarder.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = jitter-&gt;<span class="built_in">correct</span>(metadata, SrsRtmpJitterAlgorithmOFF)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;jitter&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = queue-&gt;<span class="built_in">enqueue</span>(metadata)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;enqueue metadata&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/10/03/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BHLS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/03/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BHLS/" class="post-title-link" itemprop="url">SRS流媒体服务器之HLS</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-10-03 13:13:50" itemprop="dateCreated datePublished" datetime="2023-10-03T13:13:50+08:00">2023-10-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-12-30 22:37:29" itemprop="dateModified" datetime="2023-12-30T22:37:29+08:00">2023-12-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SRS/" itemprop="url" rel="index"><span itemprop="name">SRS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="HLS介绍"><a href="#HLS介绍" class="headerlink" title="HLS介绍"></a>HLS介绍</h1><h2 id="HLS简介"><a href="#HLS简介" class="headerlink" title="HLS简介"></a>HLS简介</h2><p>RTMP指Adobe的RTMP（Realtime Message Protocol），⼴泛应⽤于低延时直播，也是编码器和服务器对接的实际标准协议，在PC（Flash）上有最佳观看体验和最佳稳定性。HLS指Apple的HLS（Http Live Streaming），本身就是Live（直播）的，不过Vod（点播）也能⽀持。HLS是Apple平台的标准流媒体协议，和RTMP在PC上⼀样⽀持得天⾐⽆缝。HLS和RTMP两种分发⽅式，就可以⽀持所有的终端。 </p>
<h2 id="HLS应用场景"><a href="#HLS应用场景" class="headerlink" title="HLS应用场景"></a>HLS应用场景</h2><ul>
<li>跨平台：PC主要的直播⽅案是RTMP，也有⼀些库能播放HLS，譬如jwplayer，基于osmf的hls插件也⼀⼤堆。所以实际上如果选⼀种协议能跨PC&#x2F;Android&#x2F;IOS，那就是HLS。 </li>
<li>IOS上苛刻的稳定性要求：IOS上最稳定的当然是HLS，稳定性不差于RTMP在PC-flash上的表现。 </li>
<li>友好的CDN分发⽅式：⽬前CDN对于RTMP也是基本协议，但是HLS分发的基础是HTTP，所以CDN的接⼊和分发会⽐RTMP更加完善。能在各种CDN之间切换，RTMP也能，只是可能需要对接测试。 </li>
<li>简单：HLS作为流媒体协议⾮常简单，Apple⽀持得也很完善。Android对HLS的⽀持也会越来越完善。⾄于DASH&#x2F;HDS，好像没有什么特别的理由，就像linux已经⼤⾏其道⽽且开放，其他的系统很难再⼴泛应⽤。</li>
</ul>
<p>总之，SRS⽀持HLS主要是作为输出的分发协议，直播以RTMP+HLS分发，满⾜各种应⽤场景。点播以HLS为主。 </p>
<h2 id="推荐分发⽅式"><a href="#推荐分发⽅式" class="headerlink" title="推荐分发⽅式"></a>推荐分发⽅式</h2><ul>
<li>编码器输出RTMP协议。 </li>
<li>流媒体系统接⼊使⽤RTMP协议。 </li>
<li>流媒体系统内部直播分发使⽤RTMP。 </li>
<li>PC+直播+实时性要求⾼：使⽤flash播放RTMP。 </li>
<li>PC+直播+没有实时性要求：使⽤RTMP或者HLS均可。 </li>
<li>PC+点播：使⽤HTTP或者HLS。 </li>
<li>Apple IOS&#x2F;OSX：都使⽤HLS（实时性要求⾼得⾃⼰解析RTMP，或者使⽤外部库。</li>
<li>Andorid：和IOS⼀样，不过可以确定的是可以⾃⼰开发⽀持RTMP。</li>
</ul>
<h1 id="HLS源码分析"><a href="#HLS源码分析" class="headerlink" title="HLS源码分析"></a>HLS源码分析</h1><h2 id="配置⽂件"><a href="#配置⽂件" class="headerlink" title="配置⽂件"></a>配置⽂件</h2><p>修改<code>conf/hls.conf</code>文件，<code>./objs/srs -c conf/hls.conf</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">listen              1935;</span><br><span class="line">max_connections     1000;</span><br><span class="line">daemon              off;</span><br><span class="line">srs_log_tank        console;</span><br><span class="line">http_server &#123;</span><br><span class="line">    enabled         on;</span><br><span class="line">    listen          8080;</span><br><span class="line">    dir             ./objs/nginx/html;</span><br><span class="line">&#125;</span><br><span class="line">vhost __defaultVhost__ &#123;</span><br><span class="line">    hls &#123;</span><br><span class="line">        enabled         on;</span><br><span class="line">        hls_path        ./objs/nginx/html;  # ts,m3u8保存路径</span><br><span class="line">        hls_fragment    10;   # 分片时长</span><br><span class="line">        hls_window      60;   # 总分片时长，窗⼝时⻓</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="调试分析"><a href="#调试分析" class="headerlink" title="调试分析"></a>调试分析</h2><h3 id="核心类"><a href="#核心类" class="headerlink" title="核心类"></a>核心类</h3><ul>
<li><code>SrsHls</code>：对于HLS业务的封装。</li>
<li><code>SrsHlsController</code>：The hls stream cache。</li>
<li><code>SrsHlsMuxer</code>：负责⽣产m3u8和ts⽂件。</li>
<li><code>SrsHlsSegment</code>：负责分⽚，⽂件创建、删除等。</li>
<li><code>SrsFragment</code>：对⽂件的处理，是SrsHlsSegment 的基类。</li>
<li><code>SrsFragmentWindow</code>：管理segment。</li>
</ul>
<h3 id="推流端"><a href="#推流端" class="headerlink" title="推流端"></a>推流端</h3><p>主要通过RTMP推流，将接收音视频数据写入m3u8和ts文件。</p>
<ul>
<li>看到配置文件<code>hls_fragment</code>字段，找到<code>SrsConfig::get_hls_fragmen</code>，打断点，查看堆栈：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#0 SrsConfig::get_hls_fragment (this=0xa0fcf0, vhost=&quot;__defaultVhost__&quot;) at src/app/srs_app_config.cpp:6102</span><br><span class="line">#1 0x00000000004f3ee9 in SrsHlsController::on_publish (this=0xa3b560, req=0xa3bcb0) </span><br><span class="line">   at src/app/srs_app_hls.cpp:885 </span><br><span class="line">#2 0x00000000004f5be2 in SrsHls::on_publish (this=0xa3b030) at src/app/srs_app_hls.cpp:1181</span><br><span class="line">#3 0x00000000004e0603 in SrsOriginHub::on_publish (this=0xa3b670) at src/app/srs_app_source.cpp:1129</span><br><span class="line">#4 0x00000000004e6a0b in SrsSource::on_publish (this=0xa3b1e0) at src/app/srs_app_source.cpp:2460</span><br><span class="line">#5 0x00000000004d89f2 in SrsRtmpConn::acquire_publish (this=0xa30d60, source=0xa3b1e0) </span><br><span class="line">   at src/app/srs_app_rtmp_conn.cpp:940</span><br><span class="line">#6 0x00000000004d7a74 in SrsRtmpConn::publishing (this=0xa30d60, source=0xa3b1e0)</span><br><span class="line">   at src/app/srs_app_rtmp_conn.cpp:822</span><br><span class="line">#7 0x00000000004d5229 in SrsRtmpConn::stream_service_cycle (this=0xa30d60)</span><br><span class="line">   at src/app/srs_app_rtmp_conn.cpp:534</span><br><span class="line">#8 0x00000000004d4141 in SrsRtmpConn::service_cycle (this=0xa30d60) at src/app/srs_app_rtmp_conn.cpp:388</span><br><span class="line">#9 0x00000000004d2f09 in SrsRtmpConn::do_cycle (this=0xa30d60) at src/app/srs_app_rtmp_conn.cpp:209</span><br><span class="line">#10 0x00000000004d10fb in SrsConnection::cycle (this=0xa30dd8) at src/app/srs_app_conn.cpp:171</span><br><span class="line">#11 0x0000000000509c88 in SrsSTCoroutine::cycle (this=0xa31010) at src/app/srs_app_st.cpp:198</span><br><span class="line">#12 0x0000000000509cfd in SrsSTCoroutine::pfn (arg=0xa31010) at src/app/srs_app_st.cpp:213</span><br><span class="line">#13 0x00000000005bdd9d in _st_thread_main () at sched.c:337</span><br><span class="line">#14 0x00000000005be515 in st_thread_create (start=0x5bd719 &lt;_st_vp_schedule+170&gt;,</span><br><span class="line">    arg=0x700000001, joinable=1, stk_size=1) at sched.c616</span><br></pre></td></tr></table></figure>

<ul>
<li>看到堆栈前面和RTMP推流流程一致。</li>
<li><code>SrsRtmpConn::acquire_publish</code>后<code>info-&gt;edge</code>分支用于edge边缘结点推流，该流程处理在另一个分支<code>source-&gt;on_publish</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::acquire_publish</span><span class="params">(SrsSource* source)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!source-&gt;<span class="built_in">can_publish</span>(info-&gt;edge)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_SYSTEM_STREAM_BUSY,</span><br><span class="line">                             <span class="string">&quot;rtmp: stream %s is busy&quot;</span>,</span><br><span class="line">                             req-&gt;<span class="built_in">get_stream_url</span>().<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// when edge, ignore the publish event, directly proxy it.</span></span><br><span class="line">    <span class="keyword">if</span> (info-&gt;edge) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">on_edge_start_publish</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: edge start publish&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">on_publish</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: source publish&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>进入<code>SrsSource::on_publish</code>后调用<code>hub-&gt;on_publish</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsSource::on_publish</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// update the request object.</span></span><br><span class="line">    <span class="built_in">srs_assert</span>(req);</span><br><span class="line">    </span><br><span class="line">    _can_publish = <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// whatever, the publish thread is the source or edge source,</span></span><br><span class="line">    <span class="comment">// save its id to srouce id.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">on_source_id_changed</span>(_srs_context-&gt;<span class="built_in">get_id</span>())) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;source id change&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// reset the mix queue.</span></span><br><span class="line">    mix_queue-&gt;<span class="built_in">clear</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reset the metadata cache, to make VLC happy when disable/enable stream.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/1630#issuecomment-597979448</span></span><br><span class="line">    meta-&gt;<span class="built_in">clear</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// detect the monotonically again.</span></span><br><span class="line">    is_monotonically_increase = <span class="literal">true</span>;</span><br><span class="line">    last_packet_time = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Notify the hub about the publish event.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = hub-&gt;<span class="built_in">on_publish</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hub publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// notify the handler.</span></span><br><span class="line">    <span class="built_in">srs_assert</span>(handler);</span><br><span class="line">    <span class="keyword">if</span> ((err = handler-&gt;<span class="built_in">on_publish</span>(<span class="keyword">this</span>, req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;handle publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    SrsStatistic* stat = SrsStatistic::<span class="built_in">instance</span>();</span><br><span class="line">    stat-&gt;<span class="built_in">on_stream_publish</span>(req, _source_id);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsOriginHub</code>扩展源推流不同业务，比如转码，录制，转发等，主要关注<code>hls-&gt;on_publish</code>用于HLS。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsOriginHub::on_publish</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// create forwarders</span></span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">create_forwarders</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;create forwarders&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> use initialize to set req.</span></span><br><span class="line">    <span class="comment">//转码</span></span><br><span class="line">    <span class="keyword">if</span> ((err = encoder-&gt;<span class="built_in">on_publish</span>(req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;encoder publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = hls-&gt;<span class="built_in">on_publish</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = dash-&gt;<span class="built_in">on_publish</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;dash publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//录制</span></span><br><span class="line">    <span class="keyword">if</span> ((err = dvr-&gt;<span class="built_in">on_publish</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;dvr publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> use initialize to set req.</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_AUTO_HDS</span></span><br><span class="line">    <span class="keyword">if</span> ((err = hds-&gt;<span class="built_in">on_publish</span>(req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hds publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> use initialize to set req.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = ng_exec-&gt;<span class="built_in">on_publish</span>(req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;exec publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    is_active = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHls::on_publish</code>主要调用<code>controller-&gt;on_publish</code>做处理。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHls::on_publish</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// update the hls time, for hls_dispose.</span></span><br><span class="line">    last_update_time = <span class="built_in">srs_get_system_time</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// support multiple publish.</span></span><br><span class="line">    <span class="keyword">if</span> (enabled) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!_srs_config-&gt;<span class="built_in">get_hls_enabled</span>(req-&gt;vhost)) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = controller-&gt;<span class="built_in">on_publish</span>(req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: on publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If enabled, directly turn FLV timestamp to TS DTS.</span></span><br><span class="line">    <span class="comment">// @remark It&#x27;ll be reloaded automatically, because the origin hub will republish while reloading.</span></span><br><span class="line">    hls_dts_directly = _srs_config-&gt;<span class="built_in">get_vhost_hls_dts_directly</span>(req-&gt;vhost);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if enabled, open the muxer.</span></span><br><span class="line">    enabled = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ok, the hls can be dispose, or need to be dispose.</span></span><br><span class="line">    disposable = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHlsController::on_publish</code>读取配置文件信息，之后<code>SrsHlsMuxer</code>处理HLS相关业务封装。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHlsController::on_publish</span><span class="params">(SrsRequest* req)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    std::string vhost = req-&gt;vhost;</span><br><span class="line">    std::string stream = req-&gt;stream;</span><br><span class="line">    std::string app = req-&gt;app;</span><br><span class="line">    </span><br><span class="line">    <span class="type">srs_utime_t</span> hls_fragment = _srs_config-&gt;<span class="built_in">get_hls_fragment</span>(vhost);</span><br><span class="line">    <span class="type">srs_utime_t</span> hls_window = _srs_config-&gt;<span class="built_in">get_hls_window</span>(vhost);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// get the hls m3u8 ts list entry prefix config</span></span><br><span class="line">    std::string entry_prefix = _srs_config-&gt;<span class="built_in">get_hls_entry_prefix</span>(vhost);</span><br><span class="line">    <span class="comment">// get the hls path config</span></span><br><span class="line">    std::string path = _srs_config-&gt;<span class="built_in">get_hls_path</span>(vhost);</span><br><span class="line">    std::string m3u8_file = _srs_config-&gt;<span class="built_in">get_hls_m3u8_file</span>(vhost);</span><br><span class="line">    std::string ts_file = _srs_config-&gt;<span class="built_in">get_hls_ts_file</span>(vhost);</span><br><span class="line">    <span class="type">bool</span> cleanup = _srs_config-&gt;<span class="built_in">get_hls_cleanup</span>(vhost);</span><br><span class="line">    <span class="type">bool</span> wait_keyframe = _srs_config-&gt;<span class="built_in">get_hls_wait_keyframe</span>(vhost);</span><br><span class="line">    <span class="comment">// the audio overflow, for pure audio to reap segment.</span></span><br><span class="line">    <span class="type">double</span> hls_aof_ratio = _srs_config-&gt;<span class="built_in">get_hls_aof_ratio</span>(vhost);</span><br><span class="line">    <span class="comment">// whether use floor(timestamp/hls_fragment) for variable timestamp</span></span><br><span class="line">    <span class="type">bool</span> ts_floor = _srs_config-&gt;<span class="built_in">get_hls_ts_floor</span>(vhost);</span><br><span class="line">    <span class="comment">// the seconds to dispose the hls.</span></span><br><span class="line">    <span class="type">srs_utime_t</span> hls_dispose = _srs_config-&gt;<span class="built_in">get_hls_dispose</span>(vhost);</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> hls_keys = _srs_config-&gt;<span class="built_in">get_hls_keys</span>(vhost);</span><br><span class="line">    <span class="type">int</span> hls_fragments_per_key = _srs_config-&gt;<span class="built_in">get_hls_fragments_per_key</span>(vhost);</span><br><span class="line">    string hls_key_file =  _srs_config-&gt;<span class="built_in">get_hls_key_file</span>(vhost);</span><br><span class="line">    string hls_key_file_path = _srs_config-&gt;<span class="built_in">get_hls_key_file_path</span>(vhost);</span><br><span class="line">    string hls_key_url = _srs_config-&gt;<span class="built_in">get_hls_key_url</span>(vhost);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> support load exists m3u8, to continue publish stream.</span></span><br><span class="line">    <span class="comment">// for the HLS donot requires the EXT-X-MEDIA-SEQUENCE be monotonically increase.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((err = muxer-&gt;<span class="built_in">on_publish</span>(req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;muxer publish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = muxer-&gt;<span class="built_in">update_config</span>(req, entry_prefix, path, m3u8_file, ts_file, hls_fragment,</span><br><span class="line">        hls_window, ts_floor, hls_aof_ratio, cleanup, wait_keyframe,hls_keys,hls_fragments_per_key,</span><br><span class="line">        hls_key_file, hls_key_file_path, hls_key_url)) != srs_success ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: update config&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = muxer-&gt;<span class="built_in">segment_open</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: segment open&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This config item is used in SrsHls, we just log its value here.</span></span><br><span class="line">    <span class="type">bool</span> hls_dts_directly = _srs_config-&gt;<span class="built_in">get_vhost_hls_dts_directly</span>(req-&gt;vhost);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;hls: win=%dms, frag=%dms, prefix=%s, path=%s, m3u8=%s, ts=%s, aof=%.2f, floor=%d, clean=%d, waitk=%d, dispose=%dms, dts_directly=%d&quot;</span>,</span><br><span class="line">        <span class="built_in">srsu2msi</span>(hls_window), <span class="built_in">srsu2msi</span>(hls_fragment), entry_prefix.<span class="built_in">c_str</span>(), path.<span class="built_in">c_str</span>(), m3u8_file.<span class="built_in">c_str</span>(), ts_file.<span class="built_in">c_str</span>(),</span><br><span class="line">        hls_aof_ratio, ts_floor, cleanup, wait_keyframe, <span class="built_in">srsu2msi</span>(hls_dispose), hls_dts_directly);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>配置<code>SrsHlsMuxer</code>信息，创建<code>SrsFileWriter</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHlsMuxer::update_config</span><span class="params">(SrsRequest* r, string entry_prefix,</span></span></span><br><span class="line"><span class="params"><span class="function">    string path, string m3u8_file, string ts_file, <span class="type">srs_utime_t</span> fragment, <span class="type">srs_utime_t</span> window,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">bool</span> ts_floor, <span class="type">double</span> aof_ratio, <span class="type">bool</span> cleanup, <span class="type">bool</span> wait_keyframe, <span class="type">bool</span> keys,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">int</span> fragments_per_key, string key_file ,string key_file_path, string key_url)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_freep</span>(req);</span><br><span class="line">    req = r-&gt;<span class="built_in">copy</span>();</span><br><span class="line">    </span><br><span class="line">    hls_entry_prefix = entry_prefix;</span><br><span class="line">    hls_path = path;</span><br><span class="line">    hls_ts_file = ts_file;</span><br><span class="line">    hls_fragment = fragment;</span><br><span class="line">    hls_aof_ratio = aof_ratio;</span><br><span class="line">    hls_ts_floor = ts_floor;</span><br><span class="line">    hls_cleanup = cleanup;</span><br><span class="line">    hls_wait_keyframe = wait_keyframe;</span><br><span class="line">    previous_floor_ts = <span class="number">0</span>;</span><br><span class="line">    accept_floor_ts = <span class="number">0</span>;</span><br><span class="line">    hls_window = window;</span><br><span class="line">    deviation_ts = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    hls_keys = keys;</span><br><span class="line">    hls_fragments_per_key = fragments_per_key;</span><br><span class="line">    hls_key_file = key_file;</span><br><span class="line">    hls_key_file_path = key_file_path;</span><br><span class="line">    hls_key_url = key_url;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// generate the m3u8 dir and path.</span></span><br><span class="line">    m3u8_url = <span class="built_in">srs_path_build_stream</span>(m3u8_file, req-&gt;vhost, req-&gt;app, req-&gt;stream);</span><br><span class="line">    m3u8 = path + <span class="string">&quot;/&quot;</span> + m3u8_url;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// when update config, reset the history target duration.</span></span><br><span class="line">    max_td = fragment * _srs_config-&gt;<span class="built_in">get_hls_td_ratio</span>(r-&gt;vhost);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// create m3u8 dir once.</span></span><br><span class="line">    m3u8_dir = <span class="built_in">srs_path_dirname</span>(m3u8);</span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">srs_create_dir_recursively</span>(m3u8_dir)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;create dir&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hls_keys &amp;&amp; (hls_path != hls_key_file_path)) &#123;</span><br><span class="line">        string key_file = <span class="built_in">srs_path_build_stream</span>(hls_key_file, req-&gt;vhost, req-&gt;app, req-&gt;stream);</span><br><span class="line">        string key_url = hls_key_file_path + <span class="string">&quot;/&quot;</span> + key_file;</span><br><span class="line">        string key_dir = <span class="built_in">srs_path_dirname</span>(key_url);</span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">srs_create_dir_recursively</span>(key_dir)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;create dir&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(hls_keys) &#123;</span><br><span class="line">        writer = <span class="keyword">new</span> <span class="built_in">SrsEncFileWriter</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        writer = <span class="keyword">new</span> <span class="built_in">SrsFileWriter</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHlsMuxer::segment_open</code>打开TS分片，并写入。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHlsMuxer::segment_open</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//省略...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// open temp ts file.</span></span><br><span class="line">    std::string tmp_file = current-&gt;<span class="built_in">tmppath</span>();</span><br><span class="line">    <span class="keyword">if</span> ((err = current-&gt;writer-&gt;<span class="built_in">open</span>(tmp_file)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;open hls muxer&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// reset the context for a new ts start.</span></span><br><span class="line">    context-&gt;<span class="built_in">reset</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>断点<code>SrsHlsMuxer::do_segment_close</code>。</li>
<li><code>SrsHlsMuxer::segment_open</code>，对应<code>SrsHlsMuxer::segment_close</code>用于结束⼀个segment的写⼊。</li>
<li><code>_refresh_m3u8</code>用于更新m3u8文件。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#0 SrsHlsMuxer::do_segment_close (this=0xa3b6f0) at src/app/srs_app_hls.cpp:602</span><br><span class="line">#1 0x00000000004f1b19 in SrsHlsMuxer::segment_close (this=0xa3b6f0) at src/app/srs_app_hls.cpp:593</span><br><span class="line">#2 0x00000000004f52c4 in SrsHlsController::reap_segment (this=0xa3b560) at src/app/srs_app_hls.cpp:1046</span><br><span class="line">#3 0x00000000004f51d2 in SrsHlsController::write_video (this=0xa3b560, frame=0xa3fdb0, dts=1328400)</span><br><span class="line">   at src/app/srs_app_hls.cpp:1024</span><br><span class="line">#4 0x00000000004f63c3 in SrsHls::on_video (this=0xa3b030, shared_video=0x7ffff7ee8b00, format=0xa3bad0)</span><br><span class="line">   at src/app/srs_app_hls.cpp:1340</span><br><span class="line">#5 0x00000000004dfbef in SrsOriginHub::on_video (</span><br><span class="line">   this=0xa3b670, shared_video=0x7ffff7ee8b00, is_sequence_header=false) at src/app/srs_app_source.cpp:1062</span><br><span class="line">#6 0x00000000004e5fa5 in SrsSource::on_video_imp (this=0xa3b1e0, msg=0x7ffff7ee8b00) </span><br><span class="line">   at src/app/srs_app_source.cpp:2306</span><br><span class="line">#7 0x00000000004e5bf9 in SrsSource::on_video (this=0xa3b1e0, shared_video=0xa3dfa0)</span><br><span class="line">   at src/app/srs_app_source.cpp:2261</span><br><span class="line">#8 0x00000000004d8fa7 in SrsRtmpConn::process_publish_message (this=0xa30d60,</span><br><span class="line">   source=0xa3b1e0, msg=0xa3dfa0)</span><br><span class="line">   at src/app/srs_app_rtmp_conn.cpp:1021</span><br><span class="line">#9 0x00000000004d8dce in SrsRtmpConn::handle_publish_message (this=0xa30d60,</span><br><span class="line">   source=0xa3b1e0, msg=0xa3dfa0) </span><br><span class="line">   at src/app/srs_app_rtmp_conn.cpp:993</span><br><span class="line">#10 0x00000000005810b6 in SrsPublishRecvThread::consume (this=0x7ffff7f42800, msg=0xa3dfa0)</span><br><span class="line">    at src/app/srs_app_recv_thread.cpp:389</span><br><span class="line">#11 0x00000000004d2f09 in SrsRtmpConn::do_cycle (this=0x7ffff7f42808) at src/app/srs_app_rtmp_conn.cpp:146</span><br><span class="line">#12 0x000000000057fa25 in SrsRecvThread::cycle (this=0x7ffff7f42808) at src/app/srs_app_recv_thread.cpp:115 #13 0x0000000000509c88 in SrsSTCoroutine::cycle (this=0xa3de00) at src/app/srs_app_st.cpp:198</span><br></pre></td></tr></table></figure>

<ul>
<li>写入TS的视频数据。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHlsController::write_video</span><span class="params">(SrsVideoFrame* frame, <span class="type">int64_t</span> dts)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// write video to cache.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = tsmc-&gt;<span class="built_in">cache_video</span>(frame, dts)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: cache video&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// when segment overflow, reap if possible.</span></span><br><span class="line">    <span class="comment">//文件是不是够fragment</span></span><br><span class="line">    <span class="keyword">if</span> (muxer-&gt;<span class="built_in">is_segment_overflow</span>()) &#123;</span><br><span class="line">        <span class="comment">// do reap ts if any of:</span></span><br><span class="line">        <span class="comment">//      a. wait keyframe and got keyframe.</span></span><br><span class="line">        <span class="comment">//      b. always reap when not wait keyframe.</span></span><br><span class="line">        <span class="keyword">if</span> (!muxer-&gt;<span class="built_in">wait_keyframe</span>() || frame-&gt;frame_type == SrsVideoAvcFrameTypeKeyFrame) &#123;</span><br><span class="line">            <span class="comment">// reap the segment, which will also flush the video.</span></span><br><span class="line">            <span class="keyword">if</span> ((err = <span class="built_in">reap_segment</span>()) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: reap segment&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// flush video when got one</span></span><br><span class="line">    <span class="keyword">if</span> ((err = muxer-&gt;<span class="built_in">flush_video</span>(tsmc)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: flush video&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHlsController::reap_segment</code>主要管理对ts、m3u8文件。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHlsController::reap_segment</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> flush audio before or after segment?</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> fresh segment begin with audio or video?</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// close current ts.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = muxer-&gt;<span class="built_in">segment_close</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="comment">// When close segment error, we must reopen it for next packet to write.</span></span><br><span class="line">        <span class="type">srs_error_t</span> r0 = muxer-&gt;<span class="built_in">segment_open</span>();</span><br><span class="line">        <span class="keyword">if</span> (r0 != srs_success) &#123;</span><br><span class="line">            <span class="built_in">srs_warn</span>(<span class="string">&quot;close segment err %s&quot;</span>, <span class="built_in">srs_error_desc</span>(r0).<span class="built_in">c_str</span>());</span><br><span class="line">            <span class="built_in">srs_freep</span>(r0);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: segment close&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// open new ts.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = muxer-&gt;<span class="built_in">segment_open</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: segment open&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// segment open, flush video first.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = muxer-&gt;<span class="built_in">flush_video</span>(tsmc)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: flush video&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// segment open, flush the audio.</span></span><br><span class="line">    <span class="comment">// @see: ngx_rtmp_hls_open_fragment</span></span><br><span class="line">    <span class="comment">/* start fragment with audio to make iPhone happy */</span></span><br><span class="line">    <span class="keyword">if</span> ((err = muxer-&gt;<span class="built_in">flush_audio</span>(tsmc)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: flush audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>上述主要在<code>SrsHls::on_publish</code>处理推流初始化相关。</li>
<li>具体从哪里读音视频数据中，断点<code>SrsTsContextWriter::write_audio</code>如何写入音频数据。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#0 SrsTsContextWriter::write_audio (this=0xa3c770, audio=0xa45bf0) at src/kernel/srs_kernel_ts.cpp:2582</span><br><span class="line">#1 0x00000000004f1858 in SrsHlsMuxer::flush_audio (this=0xa3b6f0, cache=0xa3b580)</span><br><span class="line">   at src/app/srs_app_hls.cpp:552</span><br><span class="line">#2 0x00000000004f5089 in SrsHlsController::write_audio (this=0xa3b560, frame=0xa41640, pts=3060)</span><br><span class="line">   at src/app/srs_app_hls.cpp:1001</span><br><span class="line">#3 0x00000000004f613c in SrsHls::on_audio (this=0xa3b030, shared_audio=0x7ffff7ee8b10, format=0xa3bad0)</span><br><span class="line">   at src/app/srs_app_hls.cpp:1290</span><br><span class="line">#4 0x00000000004deeaf in SrsOriginHub::on_audio (this=0xa3b670, shared_audio=0x7ffff7ee8b10)</span><br><span class="line">   at src/app/srs_app_source.cpp:969</span><br><span class="line">#5 0x00000000004e579a in SrsSource::on_audio_imp (this=0xa3b1e0, msg=0x7ffff7ee8b10)</span><br><span class="line">   at src/app/srs_app_source.cpp:2191</span><br><span class="line">#6 0x00000000004e539d in SrsSource::on_audio (this=0xa3b1e0, shared_audio=0xa3dfa0)</span><br><span class="line">   at src/app/srs_app_source.cpp:2141</span><br><span class="line">#7 0x00000000004d8f28 in SrsRtmpConn::process_publish_message (this=0xa30d60, source=0xa3b1e0, msg=0xa3dfa0)    at src/app/srs_app_rtmp_conn.cpp:1014</span><br><span class="line">#8 0x00000000004d8dce in SrsRtmpConn::handle_publish_message (this=0xa30d60, source=0xa3b1e0, msg=0xa3dfa0)      at src/app/srs_app_rtmp_conn.cpp:993</span><br><span class="line">#9 0x00000000005810b6 in SrsPublishRecvThread::consume (this=0x7ffff7f42800, msg=0xa3dfa0)</span><br><span class="line">   at src/app/srs_app_recv_thread.cpp:389</span><br><span class="line">#10 0x000000000057fbd4 in SrsRecvThread::do_cycle (this=0x7ffff7f42808)</span><br><span class="line">    at src/app/srs_app_recv_thread.cpp:146</span><br><span class="line">#11 0x000000000057fa25 in SrsRecvThread::cycle (this=0x7ffff7f42808) at src/app/srs_app_recv_thread.cpp:115</span><br><span class="line">#12 0x0000000000509c88 in SrsSTCoroutine::cycle (this=0xa3de00) at src/app/srs_app_st.cpp:198</span><br><span class="line">#13 0x0000000000509cfd in SrsSTCoroutine::pfn (arg=0xa3de00) at src/app/srs_app_st.cpp:213</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsSource::on_audio_imp</code>的<code>SrsSharedPtrMessage</code>消息是RTMP格式消息。</li>
<li><code>consumer-&gt;enqueue</code>推送给消费者，<code>hub-&gt;on_audio</code>是具体<code>SrsOriginHub</code>做处理。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsSource::on_audio_imp</span><span class="params">(SrsSharedPtrMessage* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="type">bool</span> is_aac_sequence_header = SrsFlvAudio::<span class="built_in">sh</span>(msg-&gt;payload, msg-&gt;size);</span><br><span class="line">    <span class="type">bool</span> is_sequence_header = is_aac_sequence_header;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// whether consumer should drop for the duplicated sequence header.</span></span><br><span class="line">    <span class="type">bool</span> drop_for_reduce = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (is_sequence_header &amp;&amp; meta-&gt;<span class="built_in">previous_ash</span>() &amp;&amp; _srs_config-&gt;<span class="built_in">get_reduce_sequence_header</span>(req-&gt;vhost)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (meta-&gt;<span class="built_in">previous_ash</span>()-&gt;size == msg-&gt;size) &#123;</span><br><span class="line">            drop_for_reduce = <span class="built_in">srs_bytes_equals</span>(meta-&gt;<span class="built_in">previous_ash</span>()-&gt;payload, msg-&gt;payload, msg-&gt;size);</span><br><span class="line">            <span class="built_in">srs_warn</span>(<span class="string">&quot;drop for reduce sh audio, size=%d&quot;</span>, msg-&gt;size);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// copy to all consumer</span></span><br><span class="line">    <span class="keyword">if</span> (!drop_for_reduce) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; (<span class="type">int</span>)consumers.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            SrsConsumer* consumer = consumers.<span class="built_in">at</span>(i);</span><br><span class="line">            <span class="keyword">if</span> ((err = consumer-&gt;<span class="built_in">enqueue</span>(msg, atc, jitter_algorithm)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;consume message&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Copy to hub to all utilities.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = hub-&gt;<span class="built_in">on_audio</span>(msg)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;consume audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cache the sequence header of aac, or first packet of mp3.</span></span><br><span class="line">    <span class="comment">// for example, the mp3 is used for hls to write the &quot;right&quot; audio codec.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> to refine the stream info system.</span></span><br><span class="line">    <span class="keyword">if</span> (is_aac_sequence_header || !meta-&gt;<span class="built_in">ash</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = meta-&gt;<span class="built_in">update_ash</span>(msg)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;meta consume audio&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// when sequence header, donot push to gop cache and adjust the timestamp.</span></span><br><span class="line">    <span class="keyword">if</span> (is_sequence_header) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cache the last gop packets</span></span><br><span class="line">    <span class="keyword">if</span> ((err = gop_cache-&gt;<span class="built_in">cache</span>(msg)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;gop cache consume audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if atc, update the sequence header to abs time.</span></span><br><span class="line">    <span class="keyword">if</span> (atc) &#123;</span><br><span class="line">        <span class="keyword">if</span> (meta-&gt;<span class="built_in">ash</span>()) &#123;</span><br><span class="line">            meta-&gt;<span class="built_in">ash</span>()-&gt;timestamp = msg-&gt;timestamp;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (meta-&gt;<span class="built_in">data</span>()) &#123;</span><br><span class="line">            meta-&gt;<span class="built_in">data</span>()-&gt;timestamp = msg-&gt;timestamp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsOriginHub::on_audio</code>中处理不同格式的音频数，首先会将<code>SrsSharedPtrMessage</code>RTMP消息格式转<code>SrsFormat</code>消息格式。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsOriginHub::on_audio</span><span class="params">(SrsSharedPtrMessage* shared_audio)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;    </span><br><span class="line">    SrsSharedPtrMessage* msg = shared_audio;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = format-&gt;<span class="built_in">on_audio</span>(msg)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;format consume audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cache the sequence header if aac</span></span><br><span class="line">    <span class="comment">// donot cache the sequence header to gop_cache, return here.</span></span><br><span class="line">    <span class="keyword">if</span> (format-&gt;<span class="built_in">is_aac_sequence_header</span>()) &#123;</span><br><span class="line">        <span class="built_in">srs_assert</span>(format-&gt;acodec);</span><br><span class="line">        SrsAudioCodecConfig* c = format-&gt;acodec;</span><br><span class="line">        </span><br><span class="line">        <span class="type">static</span> <span class="type">int</span> flv_sample_sizes[] = &#123;<span class="number">8</span>, <span class="number">16</span>, <span class="number">0</span>&#125;;</span><br><span class="line">        <span class="type">static</span> <span class="type">int</span> flv_sound_types[] = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>&#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// when got audio stream info.</span></span><br><span class="line">        SrsStatistic* stat = SrsStatistic::<span class="built_in">instance</span>();</span><br><span class="line">        <span class="keyword">if</span> ((err = stat-&gt;<span class="built_in">on_audio_info</span>(req, SrsAudioCodecIdAAC, c-&gt;sound_rate, c-&gt;sound_type, c-&gt;aac_object)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;stat audio&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">srs_trace</span>(<span class="string">&quot;%dB audio sh, codec(%d, profile=%s, %dchannels, %dkbps, %dHZ), flv(%dbits, %dchannels, %dHZ)&quot;</span>,</span><br><span class="line">                  msg-&gt;size, c-&gt;id, <span class="built_in">srs_aac_object2str</span>(c-&gt;aac_object).<span class="built_in">c_str</span>(), c-&gt;aac_channels,</span><br><span class="line">                  c-&gt;audio_data_rate / <span class="number">1000</span>, srs_aac_srates[c-&gt;aac_sample_rate],</span><br><span class="line">                  flv_sample_sizes[c-&gt;sound_size], flv_sound_types[c-&gt;sound_type],</span><br><span class="line">                  srs_flv_srates[c-&gt;sound_rate]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = hls-&gt;<span class="built_in">on_audio</span>(msg, format)) != srs_success) &#123;</span><br><span class="line">        <span class="comment">// apply the error strategy for hls.</span></span><br><span class="line">        <span class="comment">// @see https://github.com/ossrs/srs/issues/264</span></span><br><span class="line">        std::string hls_error_strategy = _srs_config-&gt;<span class="built_in">get_hls_on_error</span>(req-&gt;vhost);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">srs_config_hls_is_on_error_ignore</span>(hls_error_strategy)) &#123;</span><br><span class="line">            <span class="built_in">srs_warn</span>(<span class="string">&quot;hls: ignore audio error %s&quot;</span>, <span class="built_in">srs_error_desc</span>(err).<span class="built_in">c_str</span>());</span><br><span class="line">            hls-&gt;<span class="built_in">on_unpublish</span>();</span><br><span class="line">            <span class="built_in">srs_error_reset</span>(err);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">srs_config_hls_is_on_error_continue</span>(hls_error_strategy)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">srs_hls_can_continue</span>(<span class="built_in">srs_error_code</span>(err), source-&gt;meta-&gt;<span class="built_in">ash</span>(), msg)) &#123;</span><br><span class="line">                <span class="built_in">srs_error_reset</span>(err);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: audio&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: audio&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHls::on_audio</code>调用<code>controller-&gt;write_audio</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHls::on_audio</span><span class="params">(SrsSharedPtrMessage* shared_audio, SrsFormat* format)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!enabled) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Ignore if no format-&gt;acodec, it means the codec is not parsed, or unknown codec.</span></span><br><span class="line">    <span class="comment">// @issue https://github.com/ossrs/srs/issues/1506#issuecomment-562079474</span></span><br><span class="line">    <span class="keyword">if</span> (!format-&gt;acodec) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// update the hls time, for hls_dispose.</span></span><br><span class="line">    last_update_time = <span class="built_in">srs_get_system_time</span>();</span><br><span class="line">    </span><br><span class="line">    SrsSharedPtrMessage* audio = shared_audio-&gt;<span class="built_in">copy</span>();</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsSharedPtrMessage, audio);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ts support audio codec: aac/mp3</span></span><br><span class="line">    SrsAudioCodecId acodec = format-&gt;acodec-&gt;id;</span><br><span class="line">    <span class="keyword">if</span> (acodec != SrsAudioCodecIdAAC &amp;&amp; acodec != SrsAudioCodecIdMP3) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ignore sequence header</span></span><br><span class="line">    <span class="built_in">srs_assert</span>(format-&gt;audio);</span><br><span class="line">    <span class="keyword">if</span> (acodec == SrsAudioCodecIdAAC &amp;&amp;</span><br><span class="line">        format-&gt;audio-&gt;aac_packet_type == SrsAudioAacFrameTraitSequenceHeader) &#123;</span><br><span class="line">        <span class="keyword">return</span> controller-&gt;<span class="built_in">on_sequence_header</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> config the jitter of HLS.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = jitter-&gt;<span class="built_in">correct</span>(audio, SrsRtmpJitterAlgorithmOFF)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: jitter&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Reset the aac samples counter when DTS jitter.</span></span><br><span class="line">    <span class="keyword">if</span> (previous_audio_dts &gt; audio-&gt;timestamp) &#123;</span><br><span class="line">        previous_audio_dts = audio-&gt;timestamp;</span><br><span class="line">        aac_samples = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The diff duration in ms between two FLV audio packets.</span></span><br><span class="line">    <span class="type">int</span> diff = ::<span class="built_in">abs</span>((<span class="type">int</span>)(audio-&gt;timestamp - previous_audio_dts));</span><br><span class="line">    previous_audio_dts = audio-&gt;timestamp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Guess the number of samples for each AAC frame.</span></span><br><span class="line">    <span class="comment">// If samples is 1024, the sample-rate is 8000HZ, the diff should be 1024/8000s=128ms.</span></span><br><span class="line">    <span class="comment">// If samples is 1024, the sample-rate is 44100HZ, the diff should be 1024/44100s=23ms.</span></span><br><span class="line">    <span class="comment">// If samples is 2048, the sample-rate is 44100HZ, the diff should be 2048/44100s=46ms.</span></span><br><span class="line">    <span class="type">int</span> nb_samples_per_frame = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> guessNumberOfSamples = diff * srs_flv_srates[format-&gt;acodec-&gt;sound_rate] / <span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">if</span> (guessNumberOfSamples &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (guessNumberOfSamples &lt; <span class="number">960</span>) &#123;</span><br><span class="line">            nb_samples_per_frame = <span class="number">960</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (guessNumberOfSamples &lt; <span class="number">1536</span>) &#123;</span><br><span class="line">            nb_samples_per_frame = <span class="number">1024</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (guessNumberOfSamples &lt; <span class="number">3072</span>) &#123;</span><br><span class="line">            nb_samples_per_frame = <span class="number">2048</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            nb_samples_per_frame = <span class="number">4096</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Recalc the DTS by the samples of AAC.</span></span><br><span class="line">    aac_samples += nb_samples_per_frame;</span><br><span class="line">    <span class="type">int64_t</span> dts = <span class="number">90000</span> * aac_samples / srs_flv_srates[format-&gt;acodec-&gt;sound_rate];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If directly turn FLV timestamp, overwrite the guessed DTS.</span></span><br><span class="line">    <span class="comment">// @doc https://github.com/ossrs/srs/issues/1506#issuecomment-562063095</span></span><br><span class="line">    <span class="keyword">if</span> (hls_dts_directly) &#123;</span><br><span class="line">        dts = audio-&gt;timestamp * <span class="number">90</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = controller-&gt;<span class="built_in">write_audio</span>(format-&gt;audio, dts)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: write audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHlsController::write_audio</code>缓存音频数据等，<code>muxer-&gt;flush_audio</code>写入音频数据。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHlsController::write_audio</span><span class="params">(SrsAudioFrame* frame, <span class="type">int64_t</span> pts)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// write audio to cache.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = tsmc-&gt;<span class="built_in">cache_audio</span>(frame, pts)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: cache audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// reap when current source is pure audio.</span></span><br><span class="line">    <span class="comment">// it maybe changed when stream info changed,</span></span><br><span class="line">    <span class="comment">// for example, pure audio when start, audio/video when publishing,</span></span><br><span class="line">    <span class="comment">// pure audio again for audio disabled.</span></span><br><span class="line">    <span class="comment">// so we reap event when the audio incoming when segment overflow.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/151</span></span><br><span class="line">    <span class="comment">// we use absolutely overflow of segment to make jwplayer/ffplay happy</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/151#issuecomment-71155184</span></span><br><span class="line">    <span class="keyword">if</span> (tsmc-&gt;audio &amp;&amp; muxer-&gt;<span class="built_in">is_segment_absolutely_overflow</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">reap_segment</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: reap segment&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// for pure audio, aggregate some frame to one.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> Check whether it&#x27;s necessary.</span></span><br><span class="line">    <span class="keyword">if</span> (muxer-&gt;<span class="built_in">pure_audio</span>() &amp;&amp; tsmc-&gt;audio) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pts - tsmc-&gt;audio-&gt;start_pts &lt; SRS_CONSTS_HLS_PURE_AUDIO_AGGREGATE) &#123;</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// directly write the audio frame by frame to ts,</span></span><br><span class="line">    <span class="comment">// it&#x27;s ok for the hls overload, or maybe cause the audio corrupt,</span></span><br><span class="line">    <span class="comment">// which introduced by aggregate the audios to a big one.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/512</span></span><br><span class="line">    <span class="keyword">if</span> ((err = muxer-&gt;<span class="built_in">flush_audio</span>(tsmc)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: flush audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用<code>current-&gt;tscw-&gt;write_audio</code>写入缓存音频数据。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHlsMuxer::flush_audio</span><span class="params">(SrsTsMessageCache* cache)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if current is NULL, segment is not open, ignore the flush event.</span></span><br><span class="line">    <span class="keyword">if</span> (!current) &#123;</span><br><span class="line">        <span class="built_in">srs_warn</span>(<span class="string">&quot;flush audio ignored, for segment is not open.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!cache-&gt;audio || cache-&gt;audio-&gt;payload-&gt;<span class="built_in">length</span>() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// update the duration of segment.</span></span><br><span class="line">    current-&gt;<span class="built_in">append</span>(cache-&gt;audio-&gt;pts / <span class="number">90</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = current-&gt;tscw-&gt;<span class="built_in">write_audio</span>(cache-&gt;audio)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;hls: write audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// write success, clear and free the msg</span></span><br><span class="line">    <span class="built_in">srs_freep</span>(cache-&gt;audio);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用<code>context-&gt;encode</code>做TS格式封装。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsTsContextWriter::write_audio</span><span class="params">(SrsTsMessage* audio)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_info</span>(<span class="string">&quot;hls: write audio pts=%&quot;</span> PRId64 <span class="string">&quot;, dts=%&quot;</span> PRId64 <span class="string">&quot;, size=%d&quot;</span>,</span><br><span class="line">        audio-&gt;pts, audio-&gt;dts, audio-&gt;PES_packet_length);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = context-&gt;<span class="built_in">encode</span>(writer, audio, vcodec, acodec)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;ts: write audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">srs_info</span>(<span class="string">&quot;hls encode audio ok&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="拉流端"><a href="#拉流端" class="headerlink" title="拉流端"></a>拉流端</h3><p>主要是响应拉流客户端HTTP携带的m3u8和ts文件。</p>
<ul>
<li>断点<code>SrsFileReader::SrsFileReader</code>，拉流端会构造<code>SrsFileReader</code>类读取HLS协议相关文件响应客户端。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#0 SrsFileReader::SrsFileReader (this=0xa7ac50, __in_chrg=&lt;optimized out&gt;, __vtt_parm= &lt;optimized out&gt;) </span><br><span class="line">   at src/kernel/srs_kernel_file.cpp:195</span><br><span class="line">#1 0x0000000000459258 in ISrsFileReaderFactory::create_file_reader (this=0xa122f0)</span><br><span class="line">   at src/kernel/srs_kernel_file.cpp:192</span><br><span class="line">#2 0x0000000000499842 in SrsHttpFileServer::serve_file (this=0xa12310, w=0x7ffff7f0cbd0, r=0xa77130,</span><br><span class="line">   fullpath=&quot;./objs/nginx/html/live/livestream.m3u8&quot;) at src/protocol/srs_http_stack.cpp:391</span><br><span class="line">#3 0x000000000049957e in SrsHttpFileServer::serve_http (this=0xa12310, w=0x7ffff7f0cbd0, r=0xa77130)</span><br><span class="line">   at src/protocol/srs_http_stack.cpp:384</span><br><span class="line">#4 0x000000000049c86f in SrsHttpServeMux::serve_http (this=0xa10420, w=0x7ffff7f0cbd0, r=0xa77130)</span><br><span class="line">   at src/protocol/srs_http_stack.cpp:711</span><br><span class="line">#5 0x00000000005620a1 in SrsHttpServer::serve_http (this=0xa11e60, w=0x7ffff7f0cbd0, r=0xa77130)</span><br><span class="line">   at src/app/srs_app_http_conn.cpp:303</span><br><span class="line">#6 0x000000000049d6be in SrsHttpCorsMux::serve_http (this=0xa59bb0, w=0x7ffff7f0cbd0, r=0xa77130)</span><br><span class="line">   at src/protocol/srs_http_stack.cpp:859</span><br><span class="line">#7 0x0000000000561086 in SrsHttpConn::process_request (this=0xa76ea0, w=0x7ffff7f0cbd0, r=0xa77130)</span><br><span class="line">   at src/app/srs_app_http_conn.cpp:161</span><br><span class="line">#8 0x0000000000560ce8 in SrsHttpConn::do_cycle (this=0xa76ea0) at src/app/srs_app_http_conn.cpp:133</span><br><span class="line">#9 0x00000000004d10fb in SrsConnection::cycle (this=0xa76ea0) at src/app/srs_app_conn.cpp:171</span><br><span class="line">#10 0x0000000000509c88 in SrsSTCoroutine::cycle (this=0xa5aa20) at src/app/srs_app_st.cpp:198</span><br><span class="line">#11 0x0000000000509cfd in SrsSTCoroutine::pfn (arg=0xa5aa20) at src/app/srs_app_st.cpp:213 </span><br><span class="line">#12 0x00000000005bdd9d in _st_thread_main () at sched.c:337</span><br><span class="line">#13 0x00000000005be515 in st_thread_create (start=0x5bd719 &lt;_st_vp_schedule+170&gt;, </span><br><span class="line">    arg=0x900000001, joinable=1, stk_size=1) at sched.c:616</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHttpServer::serve_http</code>之前流程类似HTTP-FLV拉流。</li>
<li>对于HTTP-FLV进入<code>http_stream-&gt;mux.serve_http</code>，而HLS进入<code>http_static-&gt;mux.serve_http</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpServer::serve_http</span><span class="params">(ISrsHttpResponseWriter* w, ISrsHttpMessage* r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// try http stream first.</span></span><br><span class="line">    ISrsHttpHandler* h = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> ((err = http_stream-&gt;mux.<span class="built_in">find_handler</span>(r, &amp;h)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;find handler&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!h-&gt;<span class="built_in">is_not_found</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> http_stream-&gt;mux.<span class="built_in">serve_http</span>(w, r);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> http_static-&gt;mux.<span class="built_in">serve_http</span>(w, r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>与HTTP-FLV不同HLS<code>ISrsHttpHandler</code>是<code>SrsHttpFileServer</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpServeMux::serve_http</span><span class="params">(ISrsHttpResponseWriter* w, ISrsHttpMessage* r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    ISrsHttpHandler* h = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">find_handler</span>(r, &amp;h)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;find handler&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_assert</span>(h);</span><br><span class="line">    <span class="keyword">if</span> ((err = h-&gt;<span class="built_in">serve_http</span>(w, r)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;serve http&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>检查文件是否存在，<code>serve_file</code>读取文件。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpFileServer::serve_http</span><span class="params">(ISrsHttpResponseWriter* w, ISrsHttpMessage* r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">srs_assert</span>(entry);</span><br><span class="line"></span><br><span class="line">    string upath = r-&gt;<span class="built_in">path</span>();</span><br><span class="line">    string fullpath = <span class="built_in">srs_http_fs_fullpath</span>(dir, entry-&gt;pattern, upath);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// stat current dir, if exists, return error.</span></span><br><span class="line">    <span class="keyword">if</span> (!_srs_path_exists(fullpath)) &#123;</span><br><span class="line">        <span class="built_in">srs_warn</span>(<span class="string">&quot;http miss file=%s, pattern=%s, upath=%s&quot;</span>,</span><br><span class="line">                 fullpath.<span class="built_in">c_str</span>(), entry-&gt;pattern.<span class="built_in">c_str</span>(), upath.<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">SrsHttpNotFoundHandler</span>().<span class="built_in">serve_http</span>(w, r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;http match file=%s, pattern=%s, upath=%s&quot;</span>,</span><br><span class="line">              fullpath.<span class="built_in">c_str</span>(), entry-&gt;pattern.<span class="built_in">c_str</span>(), upath.<span class="built_in">c_str</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// handle file according to its extension.</span></span><br><span class="line">    <span class="comment">// use vod stream for .flv/.fhv</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">srs_string_ends_with</span>(fullpath, <span class="string">&quot;.flv&quot;</span>) || <span class="built_in">srs_string_ends_with</span>(fullpath, <span class="string">&quot;.fhv&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">serve_flv_file</span>(w, r, fullpath);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">srs_string_ends_with</span>(fullpath, <span class="string">&quot;.mp4&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">serve_mp4_file</span>(w, r, fullpath);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// serve common static file.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">serve_file</span>(w, r, fullpath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>文件读取并封装HTTP响应格式，最后调用<code>SrsHttpResponseWriter::final_request</code>完成对客户端响应。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpFileServer::serve_file</span><span class="params">(ISrsHttpResponseWriter* w, ISrsHttpMessage* r, string fullpath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    SrsFileReader* fs = fs_factory-&gt;<span class="built_in">create_file_reader</span>();</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsFileReader, fs);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((err = fs-&gt;<span class="built_in">open</span>(fullpath)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;open file %s&quot;</span>, fullpath.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The length of bytes we could response to.</span></span><br><span class="line">    <span class="type">int64_t</span> length = fs-&gt;<span class="built_in">filesize</span>() - fs-&gt;<span class="built_in">tellg</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// unset the content length to encode in chunked encoding.</span></span><br><span class="line">    w-&gt;<span class="built_in">header</span>()-&gt;<span class="built_in">set_content_length</span>(length);</span><br><span class="line">    </span><br><span class="line">    <span class="type">static</span> std::map&lt;std::string, std::string&gt; _mime;</span><br><span class="line">    <span class="keyword">if</span> (_mime.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        _mime[<span class="string">&quot;.ts&quot;</span>] = <span class="string">&quot;video/MP2T&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.flv&quot;</span>] = <span class="string">&quot;video/x-flv&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.m4v&quot;</span>] = <span class="string">&quot;video/x-m4v&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.3gpp&quot;</span>] = <span class="string">&quot;video/3gpp&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.3gp&quot;</span>] = <span class="string">&quot;video/3gpp&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.mp4&quot;</span>] = <span class="string">&quot;video/mp4&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.aac&quot;</span>] = <span class="string">&quot;audio/x-aac&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.mp3&quot;</span>] = <span class="string">&quot;audio/mpeg&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.m4a&quot;</span>] = <span class="string">&quot;audio/x-m4a&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.ogg&quot;</span>] = <span class="string">&quot;audio/ogg&quot;</span>;</span><br><span class="line">        <span class="comment">// @see hls-m3u8-draft-pantos-http-live-streaming-12.pdf, page 5.</span></span><br><span class="line">        _mime[<span class="string">&quot;.m3u8&quot;</span>] = <span class="string">&quot;application/vnd.apple.mpegurl&quot;</span>; <span class="comment">// application/x-mpegURL</span></span><br><span class="line">        _mime[<span class="string">&quot;.rss&quot;</span>] = <span class="string">&quot;application/rss+xml&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.json&quot;</span>] = <span class="string">&quot;application/json&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.swf&quot;</span>] = <span class="string">&quot;application/x-shockwave-flash&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.doc&quot;</span>] = <span class="string">&quot;application/msword&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.zip&quot;</span>] = <span class="string">&quot;application/zip&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.rar&quot;</span>] = <span class="string">&quot;application/x-rar-compressed&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.xml&quot;</span>] = <span class="string">&quot;text/xml&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.html&quot;</span>] = <span class="string">&quot;text/html&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.js&quot;</span>] = <span class="string">&quot;text/javascript&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.css&quot;</span>] = <span class="string">&quot;text/css&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.ico&quot;</span>] = <span class="string">&quot;image/x-icon&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.png&quot;</span>] = <span class="string">&quot;image/png&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.jpeg&quot;</span>] = <span class="string">&quot;image/jpeg&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.jpg&quot;</span>] = <span class="string">&quot;image/jpeg&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.gif&quot;</span>] = <span class="string">&quot;image/gif&quot;</span>;</span><br><span class="line">        <span class="comment">// For MPEG-DASH.</span></span><br><span class="line">        <span class="comment">//_mime[&quot;.mpd&quot;] = &quot;application/dash+xml&quot;;</span></span><br><span class="line">        _mime[<span class="string">&quot;.mpd&quot;</span>] = <span class="string">&quot;text/xml&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.m4s&quot;</span>] = <span class="string">&quot;video/iso.segment&quot;</span>;</span><br><span class="line">        _mime[<span class="string">&quot;.mp4v&quot;</span>] = <span class="string">&quot;video/mp4&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        std::string ext = <span class="built_in">srs_path_filext</span>(fullpath);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (_mime.<span class="built_in">find</span>(ext) == _mime.<span class="built_in">end</span>()) &#123;</span><br><span class="line">            w-&gt;<span class="built_in">header</span>()-&gt;<span class="built_in">set_content_type</span>(<span class="string">&quot;application/octet-stream&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            w-&gt;<span class="built_in">header</span>()-&gt;<span class="built_in">set_content_type</span>(_mime[ext]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Enter chunked mode, because we didn&#x27;t set the content-length.</span></span><br><span class="line">    w-&gt;<span class="built_in">write_header</span>(SRS_CONSTS_HTTP_OK);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// write body.</span></span><br><span class="line">    <span class="type">int64_t</span> left = length;</span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">copy</span>(w, fs, r, (<span class="type">int</span>)left)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;copy file=%s size=%d&quot;</span>, fullpath.<span class="built_in">c_str</span>(), left);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = w-&gt;<span class="built_in">final_request</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;final request&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHttpFileServer</code>怎么创建的，断点<code>SrsHttpFileServer::SrsHttpFileServer</code>。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#0 SrsHttpFileServer (this=0xa12530, root_dir=&quot;\360$\241\000\000\000\000\000\021\000\000\000\000\0001000\000\021\000\000\000\00010001000100013241301\376\366\377\177\000\000 \b\241\000\000\000\000\000\000\364\363\034\031\071\000\234`\340\377\377\377\177\000\000\060%\241\000\000\000\000\000`\340\377\377\177\000\ 000R\351W\ 000\000\000\000\000\000\027\241\000\000\000\0001000\000 \241\000\000\000\000\000\260\337\377\000\b&quot;, &#x27;\000&#x27; &lt;r&gt;，</span><br><span class="line">&quot;\341\377\377\377\177\000\000\060\004\241\000\000\000\000\000\060\005\241\000\000\000\000\000\021\000\000\000\000\000\000\000\021\000\000\000\000\00010001000100010271241\000\000\000\000\000\&quot;\241\000\000\000\000\000&quot;...) at src/protocol/srs_http_stack. cpp:336</span><br><span class="line">#1 0x000000000057d326 in SrsVodStream: :SrsVodStream (this=0xa12530, root_dir=&quot;`\&quot;\241\000\000\000\000\000\021\000\000\000\000\000\000\000\021&quot;</span><br><span class="line">, &#x27;\000&#x27; &lt;repeats 24 times&gt;, &quot;\364\363\034\031\071\000\234\064\005n\000\000\000\000\000\000\b\241\000\000\000\000\000 \340\377\377\377\177\000\000\000\364\363\034\031\071\000\234\000\000\000\000\000\000\000\000\000\b\241\000\000\0001\000\000 \b\241\0001000\000\000\000\300\341\377\377\377\177\000\000\320\340\377\377\377\177\000\000\234 V\000\000\000\000\000\220\340\377\377\377\177\000\000\260\033\241\000\000\000\000\000\320\340\377\377\377\177\000\000\000\000\000\000\000\000\000\000@\b\241\00\000\000\000\00\020\000\000\000\000\000\000\000\020\000\000\000\000\000\000\000s\277I\000\000\000\000\000\250!\241\000\000\000\000\000&quot;...) </span><br><span class="line">  at src/app/srs_app_http_static.cpp:54</span><br><span class="line">#2 0x000000000057e952 in SrsHttpStaticServer::initialize (this=0xa12000)</span><br><span class="line">   at src/app/srs_app_http_static. cpp:235</span><br><span class="line">#3 0x000000000056209 in SrsHttpServer::initialize (this=0xallbb0) at src/app/srs_app_http_conn.cpp:283</span><br><span class="line">#4 0x00000000004c8648 in SrsServer::initialize (this=0xa10630, ch=0x0) at src/app/srs_app_server.cpp:757</span><br><span class="line">#5 0x00000000005bccdf in run (svr=0xa10630) at src/main/srs_main_server.cpp:395</span><br><span class="line">#6 0x00000000005bb8f1 in do_main (argc=3, argv=0×7fffffffe4f8) at src/main/srs_main_server.cpp:184</span><br><span class="line">#7 0x00000000005bba35 in main (argc=3, argv=0x7fffffffe4f8) at src/main/srs_main_server.cpp:192</span><br></pre></td></tr></table></figure>

<ul>
<li>初始化<code>SrsHttpStreamServer</code>和<code>SrsHttpStaticServer</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpServer::initialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// for SRS go-sharp to detect the status of HTTP server of SRS HTTP FLV Cluster.</span></span><br><span class="line">    <span class="comment">//需要做精碗匹配</span></span><br><span class="line">    <span class="keyword">if</span> ((err = http_static-&gt;mux.<span class="built_in">handle</span>(<span class="string">&quot;/api/v1/versions&quot;</span>, <span class="keyword">new</span> <span class="built_in">SrsGoApiVersion</span>())) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;handle versin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = http_stream-&gt;<span class="built_in">initialize</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;http stream&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = http_static-&gt;<span class="built_in">initialize</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;http static&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>注册<code>SrsVodStream</code>，基类是<code>SrsHttpFileServer</code>，在<code>find_handler</code>中可以匹配。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpStaticServer::initialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="type">bool</span> default_root_exists = <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// http static file and flv vod stream mount for each vhost.</span></span><br><span class="line">    SrsConfDirective* root = _srs_config-&gt;<span class="built_in">get_root</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; (<span class="type">int</span>)root-&gt;directives.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        SrsConfDirective* conf = root-&gt;<span class="built_in">at</span>(i);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!conf-&gt;<span class="built_in">is_vhost</span>()) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        string pmount;</span><br><span class="line">        string vhost = conf-&gt;<span class="built_in">arg0</span>();</span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">mount_vhost</span>(vhost, pmount)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;mount vhost&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (pmount == <span class="string">&quot;/&quot;</span>) &#123;</span><br><span class="line">            default_root_exists = <span class="literal">true</span>;</span><br><span class="line">            std::string dir = _srs_config-&gt;<span class="built_in">get_vhost_http_dir</span>(vhost);</span><br><span class="line">            <span class="built_in">srs_warn</span>(<span class="string">&quot;http: root mount to %s&quot;</span>, dir.<span class="built_in">c_str</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!default_root_exists) &#123;</span><br><span class="line">        <span class="comment">// add root</span></span><br><span class="line">        std::string dir = _srs_config-&gt;<span class="built_in">get_http_stream_dir</span>();</span><br><span class="line">        <span class="keyword">if</span> ((err = mux.<span class="built_in">handle</span>(<span class="string">&quot;/&quot;</span>, <span class="keyword">new</span> <span class="built_in">SrsVodStream</span>(dir))) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;mount root dir=%s&quot;</span>, dir.<span class="built_in">c_str</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">srs_trace</span>(<span class="string">&quot;http: root mount to %s&quot;</span>, dir.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/10/02/SRC%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BHTTP-FLV/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/02/SRC%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BHTTP-FLV/" class="post-title-link" itemprop="url">SRC流媒体服务器之HTTP-FLV</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-10-02 10:07:31" itemprop="dateCreated datePublished" datetime="2023-10-02T10:07:31+08:00">2023-10-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-12-30 22:37:44" itemprop="dateModified" datetime="2023-12-30T22:37:44+08:00">2023-12-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SRS/" itemprop="url" rel="index"><span itemprop="name">SRS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="HTTP-FLV介绍"><a href="#HTTP-FLV介绍" class="headerlink" title="HTTP-FLV介绍"></a>HTTP-FLV介绍</h1><ul>
<li>HTTP协议中有个约定：Content-Length字段，HTTP服务器回复HTTP请求的时候如果有这个字段，客户端就接收这个⻓度的数据然后就认为数据传输完成了，如果服务器回复HTTP请求中没有这个字段，客户端就⼀直接收数据，直到服务器跟客户端的socket连接断开。</li>
<li>HTTP-FLV直播就是利⽤了这个原理，服务器回复客户端请求的时候不加Content-Length字段，在回复了HTTP内容之后，紧接着发送FLV数据，客户端就⼀直接收数据了。 </li>
<li>HTTP-FLV报文格式：</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/live/livestream.flv</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Lavf/59.30.100</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Range</span><span class="punctuation">: </span>bytes=0-</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.2.9:8080</span><br><span class="line"><span class="attribute">Icy-MetaData</span><span class="punctuation">: </span>1</span><br><span class="line"></span><br><span class="line"><span class="language-http"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span></span><br><span class="line"><span class="language-http"><span class="attribute">Connection</span><span class="punctuation">: </span>Close</span></span><br><span class="line"><span class="language-http"><span class="attribute">Content-Type</span><span class="punctuation">: </span>video/x-flv</span></span><br><span class="line"><span class="language-http"><span class="attribute">Server</span><span class="punctuation">: </span>SRS/6.0.75(Bee)</span></span><br><span class="line"><span class="language-http"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span></span><br><span class="line"><span class="language-http"></span></span><br><span class="line"><span class="language-http"><span class="language-jboss-cli">9</span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http">FLV.<span class="string">....</span>	</span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http">4</span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http"><span class="string">....</span></span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http">df91</span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http"><span class="string">.............</span></span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http">onMetaData.<span class="string">..width.</span>@<span class="string">.........height.</span>@t.<span class="string">......</span></span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http">videodatarate.@i.P.<span class="string">....</span>	framerate.@9.<span class="string">.......videocodecid.</span>@<span class="string">........</span></span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http">audiodatarate.@=T@<span class="string">......audiosamplerate.</span>@<span class="string">.........audiosamplesize.</span>@0.<span class="string">.......stereo....audiocodecid.</span>@$<span class="string">........major_brand...isom.</span></span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http">minor_<span class="keyword">version</span>.<span class="string">..512..compatible_brands...isomiso2avc1mp41..encoder..</span></span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http">Lavf59.30.100.<span class="string">.filesize...........server...SRS/6.0.75</span><span class="params">(Bee)</span><span class="string">..server_version...6.0.75.</span></span></span></span><br><span class="line"><span class="language-jboss-cli"><span class="language-http"><span class="comment">#省略</span></span></span></span><br></pre></td></tr></table></figure>

<h1 id="HTTP-FLV源码分析"><a href="#HTTP-FLV源码分析" class="headerlink" title="HTTP-FLV源码分析"></a>HTTP-FLV源码分析</h1><h2 id="配置⽂件"><a href="#配置⽂件" class="headerlink" title="配置⽂件"></a>配置⽂件</h2><p>修改<code>conf/http.flv.live.conf</code>文件，<code>./objs/srs -c conf/http.flv.live.conf</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">listen              1935;</span><br><span class="line">max_connections     1000;</span><br><span class="line">daemon              off;</span><br><span class="line">srs_log_tank        console;</span><br><span class="line">http_server &#123;</span><br><span class="line">    enabled         on;</span><br><span class="line">    listen          8080;</span><br><span class="line">    dir             ./objs/nginx/html;</span><br><span class="line">&#125;</span><br><span class="line">vhost __defaultVhost__ &#123;</span><br><span class="line">    http_remux &#123;</span><br><span class="line">        enabled     on;</span><br><span class="line">        mount       [vhost]/[app]/[stream].flv;  # ⽀持.flv .ts .aac .mp3的使⽤</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="调试分析"><a href="#调试分析" class="headerlink" title="调试分析"></a>调试分析</h2><h3 id="核心类"><a href="#核心类" class="headerlink" title="核心类"></a>核心类</h3><ul>
<li><p><code>SrsBufferCache</code>：HTTP直播流编码器的缓存。</p>
</li>
<li><p><code>SrsFlvStreamEncoder</code>：将RTMP转成HTTP FLV流。</p>
</li>
<li><p><code>SrsTsStreamEncoder</code>：将RTMP转成HTTP TS流。</p>
</li>
<li><p><code>SrsAacStreamEncoder</code>：将RTMP含有的AAC成分转成HTTP AAC流。</p>
</li>
<li><p><code>SrsMp3StreamEncoder</code>：将RTMP含有的MP3成分转成HTTP MP3流。</p>
</li>
<li><p><code>SrsBufferWriter</code>：将流直接写⼊到HTTP响应。</p>
</li>
<li><p><code>SrsLiveStream</code>：HTTP直播流，将RTMP转成HTTP-FLV或者其他格式，其实际是handler。</p>
</li>
<li><p><code>SrsLiveEntry</code>：直播⼊⼝，⽤来处理HTTP直播流。</p>
</li>
<li><p><code>SrsHttpStreamServer</code>：HTTP直播流服务，服务FLV&#x2F;TS&#x2F;MP3&#x2F;AAC流。</p>
</li>
<li><p><code>SrsHttpResponseWriter</code>：负责将数据发送给客户端，本质是调⽤SrsStSocket进⾏发送。</p>
</li>
<li><p><code>SrsHttpServeMux</code>：HTTP请求多路复⽤器，说⽩了就是路由，⾥⾯记录了path以及对应的handler。</p>
</li>
</ul>
<h3 id="监听"><a href="#监听" class="headerlink" title="监听"></a>监听</h3><ul>
<li>监听进入<code>SrsServer::listen_http_stream</code>，流程与RTMP监听一样。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsServer::listen_http_stream</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">close_listeners</span>(SrsListenerHttpStream);</span><br><span class="line">    <span class="keyword">if</span> (_srs_config-&gt;<span class="built_in">get_http_stream_enabled</span>()) &#123;</span><br><span class="line">        <span class="comment">//SrsListenerHttpStream</span></span><br><span class="line">        SrsListener* listener = <span class="keyword">new</span> <span class="built_in">SrsBufferListener</span>(<span class="keyword">this</span>, SrsListenerHttpStream);</span><br><span class="line">        listeners.<span class="built_in">push_back</span>(listener);</span><br><span class="line">        </span><br><span class="line">        std::string ep = _srs_config-&gt;<span class="built_in">get_http_stream_listen</span>();</span><br><span class="line">        </span><br><span class="line">        std::string ip;</span><br><span class="line">        <span class="type">int</span> port;</span><br><span class="line">        <span class="built_in">srs_parse_endpoint</span>(ep, ip, port);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = listener-&gt;<span class="built_in">listen</span>(ip, port)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;http stream listen %s:%d&quot;</span>, ip.<span class="built_in">c_str</span>(), port);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>监听类型是<code>SrsListenerHttpStream</code>，创建<code>SrsResponseOnlyHttpConn</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsServer::fd2conn</span><span class="params">(SrsListenerType type, <span class="type">srs_netfd_t</span> stfd, SrsConnection** pconn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (type == SrsListenerRtmpStream) &#123;</span><br><span class="line">        *pconn = <span class="keyword">new</span> <span class="built_in">SrsRtmpConn</span>(<span class="keyword">this</span>, stfd, ip);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == SrsListenerHttpApi) &#123;</span><br><span class="line">        *pconn = <span class="keyword">new</span> <span class="built_in">SrsHttpApi</span>(<span class="keyword">this</span>, stfd, http_api_mux, ip);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == SrsListenerHttpStream) &#123;</span><br><span class="line">        *pconn = <span class="keyword">new</span> <span class="built_in">SrsResponseOnlyHttpConn</span>(<span class="keyword">this</span>, stfd, http_server, ip);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">srs_warn</span>(<span class="string">&quot;close for no service handler. fd=%d, ip=%s&quot;</span>, fd, ip.<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="built_in">srs_close_stfd</span>(stfd);</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="推流端"><a href="#推流端" class="headerlink" title="推流端"></a>推流端</h3><p>推流主要根据URL创建对应的<code>ISrsHttpHandler</code>。</p>
<ul>
<li>根据配置文件关键字<code>http_remux</code>查找，断点<code>SrsConfig::get_vhost_http_remux_enabled</code>。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#0 SrsConfig::get_vhost_http_remux_enabled (this=0xa0fcf0, vhost=&quot;__defaultVhost__&quot;)</span><br><span class="line">   at src/app/srs_app_config.cpp:6886</span><br><span class="line">#1 0x00000000005029cf in SrsHttpStreamServer::initialize_flv_entry this=0xallfd0, vhost=&quot;__defaultVhost__&quot;)</span><br><span class="line">   at src/app/srs_app_http_stream.cpp:1166</span><br><span class="line">#2 0x00000000005028d3 in SrsHttpStreamServer::initialize_flv_streaming (this=0xa11fd0)</span><br><span class="line">   at src/app/srs_app_http_stream.cpp:1154</span><br><span class="line">#3 0x0000000000500a2a in SrsHttpStreamServer::initialize (this=0xallfd0)</span><br><span class="line">   at src/app/srs_app_http_stream.cpp:873</span><br><span class="line">#4 0x0000000000561eb7 in SrsHttpServer::initialize (this=0xalle00) at src/app/srs_app_http_conn.cpp:279</span><br><span class="line">#5 0x00000000004c84c0 in SrsServer::initialize (this=0xallea0, ch=0x0) at src/app/srs_app_server.cpp:757</span><br><span class="line">#6 0x00000000005bcb57 in run (svr=0xa11ea0) at src/main/srs_main_server.cpp:395</span><br><span class="line">#7 0x00000000005bb769 in do_main (argc=3, argv=0x7fffffffe4f8) at src/main/srs_main_server.cpp:184</span><br><span class="line">#8 0x00000000005bb8ad in main (argc=3, argv=0x7fffffffe4f8) at src/main/srs_main_server.cpp:192</span><br></pre></td></tr></table></figure>

<ul>
<li><code>initialize_flv_entry</code>，创建<code>SrsLiveEntry</code>用于处理HTTP直播流并保存。</li>
<li><code>tflvs</code>根据配置创建并保存HTTP直播流地址模板，提供给<code>sflvs</code>使用。</li>
<li><code>sflvs</code>在<code>SrsHttpStreamServer::http_mount</code>中赋值，用于HTTP直播流。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpStreamServer::initialize_flv_entry</span><span class="params">(std::string vhost)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!_srs_config-&gt;<span class="built_in">get_vhost_http_remux_enabled</span>(vhost)) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    SrsLiveEntry* entry = <span class="keyword">new</span> <span class="built_in">SrsLiveEntry</span>(_srs_config-&gt;<span class="built_in">get_vhost_http_remux_mount</span>(vhost));</span><br><span class="line">    </span><br><span class="line">    tflvs[vhost] = entry;</span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;http flv live stream, vhost=%s, mount=%s&quot;</span>, vhost.<span class="built_in">c_str</span>(), entry-&gt;mount.<span class="built_in">c_str</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>do_main</code>函数初始化srs服务。</li>
<li>其中<code>SrsHttpServeMux</code>用于公共路由规则。</li>
<li><code>SrsHttpServer</code>包含<code>SrsHttpStreamServer</code>和<code>SrsHttpStaticServer</code>。<ul>
<li><code>SrsHttpStreamServer</code>用于HTTP直播流。</li>
<li><code>SrsHttpStaticServer</code>用于HTTP静态文件访问。</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">SrsServer::<span class="built_in">SrsServer</span>()</span><br><span class="line">&#123;</span><br><span class="line">    signal_reload = <span class="literal">false</span>;</span><br><span class="line">    signal_persistence_config = <span class="literal">false</span>;</span><br><span class="line">    signal_gmc_stop = <span class="literal">false</span>;</span><br><span class="line">    signal_fast_quit = <span class="literal">false</span>;</span><br><span class="line">    signal_gracefully_quit = <span class="literal">false</span>;</span><br><span class="line">    pid_fd = <span class="number">-1</span>;</span><br><span class="line">    </span><br><span class="line">    signal_manager = <span class="keyword">new</span> <span class="built_in">SrsSignalManager</span>(<span class="keyword">this</span>);</span><br><span class="line">    conn_manager = <span class="keyword">new</span> <span class="built_in">SrsCoroutineManager</span>();</span><br><span class="line">    </span><br><span class="line">    handler = <span class="literal">NULL</span>;</span><br><span class="line">    ppid = ::<span class="built_in">getppid</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// donot new object in constructor,</span></span><br><span class="line">    <span class="comment">// for some global instance is not ready now,</span></span><br><span class="line">    <span class="comment">// new these objects in initialize instead.</span></span><br><span class="line">    http_api_mux = <span class="keyword">new</span> <span class="built_in">SrsHttpServeMux</span>();</span><br><span class="line">    http_server = <span class="keyword">new</span> <span class="built_in">SrsHttpServer</span>(<span class="keyword">this</span>);</span><br><span class="line">    http_heartbeat = <span class="keyword">new</span> <span class="built_in">SrsHttpHeartbeat</span>();</span><br><span class="line">    ingester = <span class="keyword">new</span> <span class="built_in">SrsIngester</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>断点<code>SrsHttpStreamServer::http_mount </code>，看下推流具体堆栈。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#0 0x0000000000500ffa in SrsHttpStreamServer::http_mount (this=0xa11dc0, s=0xa3bf80, r=0xa3ae90)</span><br><span class="line">   at src/app/srs_app_http_stream.cpp:907</span><br><span class="line">#1 0x00000000005620f5 in SrsHttpServer::http_mount (this=0xa118f0, s=0xa3bf80, r=0xa3ae90)</span><br><span class="line">   at src/app/srs_app_http_conn.cpp:308</span><br><span class="line">#2 0x00000000004cd3cc in SrsServer::on_publish (this=0xa103a0, s=0xa3bf80, r=0xa3ae90)</span><br><span class="line">   at src/app/srs_app_server.cpp:1608</span><br><span class="line">#3 0x00000000004e6a9b in SrsSource::on_publish (this=0xa3bf80) at src/app/srs_app_source.cpp:2466</span><br><span class="line">#4 0x00000000004d89f2 in SrsRtmpConn::acquire_publish (this=0xa30ce0, source=0xa3bf80)</span><br><span class="line">   at src/app/srs_app_rtmp_conn.cpp:940</span><br><span class="line">#5 0x00000000004d7a74 in SrsRtmpConn::publishing (this=0xa30ce0, source=0xa3bf80)</span><br><span class="line">   at src/app/srs_app_rtmp_conn.cpp:822</span><br><span class="line">#6 0x00000000004d5229 in SrsRtmpConn::stream_service_cycle (this=0xa30ce0)</span><br><span class="line">   at src/app/srs_app_rtmp_conn.cpp:534</span><br><span class="line">#7 0x00000000004d4141 in SrsRtmpConn::service_cycle (this=0xa30ce0) at src/app/srs_app_rtmp_conn.cpp:388</span><br><span class="line">#8 0x00000000004d2f09 in SrsRtmpConn::do_cycle (this=0xa30ce0) at src/app/srs_app_rtmp_conn.cpp:209</span><br><span class="line">#9 0x00000000004d10fb in SrsConnection::cycle (this=0xa30d58) at src/app/srs_app_conn.cpp:171</span><br><span class="line">#10 0x0000000000509c88 in SrsSTCoroutine::cycle (this=0xa30f70) at src/app/srs_app_st.cpp:198</span><br><span class="line">#11 0x0000000000509cfd in SrsSTCoroutine::pfn (arg=0xa30f70) at src/app/srs_app_st.cpp:213</span><br><span class="line">#12 0x00000000005bdd9d in _st_thread_main () at sched.c:337</span><br><span class="line">#13 0x00000000005be515 in st_thread_create (start=0x5bd719 &lt;_st_vp_schedule+170&gt;, </span><br><span class="line">    arg=0x700000001, joinable=1, stk_size=1) at sched.c:616</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsRtmpConn::acquire_publish</code>中<code>info-&gt;edge</code>分支是用来edge边缘推流的，该流程处理在另一个分支<code>source-&gt;on_publish</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::acquire_publish</span><span class="params">(SrsSource* source)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!source-&gt;<span class="built_in">can_publish</span>(info-&gt;edge)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_SYSTEM_STREAM_BUSY, </span><br><span class="line">                             <span class="string">&quot;rtmp: stream %s is busy&quot;</span>, </span><br><span class="line">                             req-&gt;<span class="built_in">get_stream_url</span>().<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// when edge, ignore the publish event, directly proxy it.</span></span><br><span class="line">    <span class="keyword">if</span> (info-&gt;edge) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">on_edge_start_publish</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: edge start publish&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">on_publish</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: source publish&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用<code>source-&gt;on_publish</code>进入<code>SrsServer::on_publish</code>，调用<code>http_server-&gt;http_mount</code>创建路由规则。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsServer::on_publish</span><span class="params">(SrsSource* s, SrsRequest* r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = http_server-&gt;<span class="built_in">http_mount</span>(s, r)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;http mount&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//源站集群</span></span><br><span class="line">    SrsCoWorkers* coworkers = SrsCoWorkers::<span class="built_in">instance</span>();</span><br><span class="line">    <span class="keyword">if</span> ((err = coworkers-&gt;<span class="built_in">on_publish</span>(s, r)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;coworkers&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>对于同一个推流端，<code>SrsLiveEntry</code>和<code>SrsLiveStream</code>是一一对应的。</li>
<li><code>SrsLiveEntry</code>是用来处理URL映射关系的；</li>
<li><code>SrsLiveStream</code>主要是给HTTP拉流客户端访问的。</li>
<li>同一路的多个拉流客户端公用一个<code>SrsLiveStream</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpStreamServer::http_mount</span><span class="params">(SrsSource* s, SrsRequest* r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// the id to identify stream.</span></span><br><span class="line">    <span class="comment">//比如/live/stream</span></span><br><span class="line">    std::string sid = r-&gt;<span class="built_in">get_stream_url</span>();</span><br><span class="line">    SrsLiveEntry* entry = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// create stream from template when not found.</span></span><br><span class="line">    <span class="keyword">if</span> (sflvs.<span class="built_in">find</span>(sid) == sflvs.<span class="built_in">end</span>()) &#123;</span><br><span class="line">        <span class="comment">//查找对应vhost，比如__defaultVhost__</span></span><br><span class="line">        <span class="keyword">if</span> (tflvs.<span class="built_in">find</span>(r-&gt;vhost) == tflvs.<span class="built_in">end</span>()) &#123; <span class="comment">//vhost</span></span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取SrsLiveEntry</span></span><br><span class="line">        SrsLiveEntry* tmpl = tflvs[r-&gt;vhost];</span><br><span class="line">        <span class="comment">//mount 比如[vhost]/[app]/[stream].flv</span></span><br><span class="line">        std::string mount = tmpl-&gt;mount;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// replace the vhost variable</span></span><br><span class="line">        mount = <span class="built_in">srs_string_replace</span>(mount, <span class="string">&quot;[vhost]&quot;</span>, r-&gt;vhost);</span><br><span class="line">        mount = <span class="built_in">srs_string_replace</span>(mount, <span class="string">&quot;[app]&quot;</span>, r-&gt;app);</span><br><span class="line">        mount = <span class="built_in">srs_string_replace</span>(mount, <span class="string">&quot;[stream]&quot;</span>, r-&gt;stream);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// remove the default vhost mount</span></span><br><span class="line">        <span class="comment">//替换mount 类似 /livestream/live.flv格式</span></span><br><span class="line">        mount = <span class="built_in">srs_string_replace</span>(mount, SRS_CONSTS_RTMP_DEFAULT_VHOST<span class="string">&quot;/&quot;</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        entry = <span class="keyword">new</span> <span class="built_in">SrsLiveEntry</span>(mount);</span><br><span class="line"></span><br><span class="line">        entry-&gt;source = s;</span><br><span class="line">        entry-&gt;req = r-&gt;<span class="built_in">copy</span>()-&gt;<span class="built_in">as_http</span>();</span><br><span class="line">        entry-&gt;cache = <span class="keyword">new</span> <span class="built_in">SrsBufferCache</span>(s, r);</span><br><span class="line">        <span class="comment">//创建SrsLiveStream，每个SrsSource绑定一个</span></span><br><span class="line">        entry-&gt;stream = <span class="keyword">new</span> <span class="built_in">SrsLiveStream</span>(s, r, entry-&gt;cache);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> maybe refine the logic of http remux service.</span></span><br><span class="line">        <span class="comment">// if user push streams followed:</span></span><br><span class="line">        <span class="comment">//     rtmp://test.com/live/stream1</span></span><br><span class="line">        <span class="comment">//     rtmp://test.com/live/stream2</span></span><br><span class="line">        <span class="comment">// and they will using the same template, such as: [vhost]/[app]/[stream].flv</span></span><br><span class="line">        <span class="comment">// so, need to free last request object, otherwise, it will cause memory leak.</span></span><br><span class="line">        <span class="built_in">srs_freep</span>(tmpl-&gt;req);</span><br><span class="line">        </span><br><span class="line">        tmpl-&gt;source = s;</span><br><span class="line">        tmpl-&gt;req = r-&gt;<span class="built_in">copy</span>()-&gt;<span class="built_in">as_http</span>();</span><br><span class="line">        </span><br><span class="line">        sflvs[sid] = entry;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// mount the http flv stream.</span></span><br><span class="line">        <span class="comment">// we must register the handler, then start the thread,</span></span><br><span class="line">        <span class="comment">// for the thread will cause thread switch context.</span></span><br><span class="line">        <span class="comment">// @see https://github.com/ossrs/srs/issues/404</span></span><br><span class="line">        <span class="comment">//创建路由规则SrsHttpServeMux，mount：要匹配的路由</span></span><br><span class="line">        <span class="keyword">if</span> ((err = mux.<span class="built_in">handle</span>(mount, entry-&gt;stream)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;http: mount flv stream for vhost=%s failed&quot;</span>, sid.<span class="built_in">c_str</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// start http stream cache thread</span></span><br><span class="line">        <span class="keyword">if</span> ((err = entry-&gt;cache-&gt;<span class="built_in">start</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;http: start stream cache failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">srs_trace</span>(<span class="string">&quot;http: mount flv stream for sid=%s, mount=%s&quot;</span>, sid.<span class="built_in">c_str</span>(), mount.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        entry = sflvs[sid];</span><br><span class="line">        entry-&gt;stream-&gt;<span class="built_in">update</span>(s, r);</span><br><span class="line">        entry-&gt;cache-&gt;<span class="built_in">update</span>(s, r);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (entry-&gt;stream) &#123;</span><br><span class="line">        entry-&gt;stream-&gt;entry-&gt;enabled = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHttpServeMux::handle</code>是真正创建路由规则的函数。</li>
<li>参数<code>pattern</code>作为URL索引，参数<code>handler</code>是<code>SrsLiveStream</code>提供给拉流客户端访问。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpServeMux::handle</span><span class="params">(std::string pattern, ISrsHttpHandler* handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">srs_assert</span>(handler);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (pattern.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_HTTP_PATTERN_EMPTY, <span class="string">&quot;empty pattern&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (entries.<span class="built_in">find</span>(pattern) != entries.<span class="built_in">end</span>()) &#123;</span><br><span class="line">        SrsHttpMuxEntry* exists = entries[pattern];</span><br><span class="line">        <span class="keyword">if</span> (exists-&gt;explicit_match) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_HTTP_PATTERN_DUPLICATED, <span class="string">&quot;pattern=%s exists&quot;</span>, pattern.<span class="built_in">c_str</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    std::string vhost = pattern;</span><br><span class="line">    <span class="keyword">if</span> (pattern.<span class="built_in">at</span>(<span class="number">0</span>) != <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pattern.<span class="built_in">find</span>(<span class="string">&quot;/&quot;</span>) != string::npos) &#123;</span><br><span class="line">            vhost = pattern.<span class="built_in">substr</span>(<span class="number">0</span>, pattern.<span class="built_in">find</span>(<span class="string">&quot;/&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        vhosts[vhost] = handler;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">//创建路由</span></span><br><span class="line">        SrsHttpMuxEntry* entry = <span class="keyword">new</span> <span class="built_in">SrsHttpMuxEntry</span>();</span><br><span class="line">        entry-&gt;explicit_match = <span class="literal">true</span>;</span><br><span class="line">        entry-&gt;handler = handler;</span><br><span class="line">        entry-&gt;pattern = pattern;</span><br><span class="line">        entry-&gt;handler-&gt;entry = entry;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (entries.<span class="built_in">find</span>(pattern) != entries.<span class="built_in">end</span>()) &#123;</span><br><span class="line">            SrsHttpMuxEntry* exists = entries[pattern];</span><br><span class="line">            <span class="built_in">srs_freep</span>(exists);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//设置 patter:URL</span></span><br><span class="line">        entries[pattern] = entry;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Helpful behavior:</span></span><br><span class="line">    <span class="comment">// If pattern is /tree/, insert an implicit permanent redirect for /tree.</span></span><br><span class="line">    <span class="comment">// It can be overridden by an explicit registration.</span></span><br><span class="line">    <span class="keyword">if</span> (pattern != <span class="string">&quot;/&quot;</span> &amp;&amp; !pattern.<span class="built_in">empty</span>() &amp;&amp; pattern.<span class="built_in">at</span>(pattern.<span class="built_in">length</span>() - <span class="number">1</span>) == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">        std::string rpattern = pattern.<span class="built_in">substr</span>(<span class="number">0</span>, pattern.<span class="built_in">length</span>() - <span class="number">1</span>);</span><br><span class="line">        SrsHttpMuxEntry* entry = <span class="literal">NULL</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// free the exists implicit entry</span></span><br><span class="line">        <span class="keyword">if</span> (entries.<span class="built_in">find</span>(rpattern) != entries.<span class="built_in">end</span>()) &#123;</span><br><span class="line">            entry = entries[rpattern];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// create implicit redirect.</span></span><br><span class="line">        <span class="keyword">if</span> (!entry || !entry-&gt;explicit_match) &#123;</span><br><span class="line">            <span class="built_in">srs_freep</span>(entry);</span><br><span class="line">            </span><br><span class="line">            entry = <span class="keyword">new</span> <span class="built_in">SrsHttpMuxEntry</span>();</span><br><span class="line">            entry-&gt;explicit_match = <span class="literal">false</span>;</span><br><span class="line">            entry-&gt;handler = <span class="keyword">new</span> <span class="built_in">SrsHttpRedirectHandler</span>(pattern, SRS_CONSTS_HTTP_Found);</span><br><span class="line">            entry-&gt;pattern = pattern;</span><br><span class="line">            entry-&gt;handler-&gt;entry = entry;</span><br><span class="line">            </span><br><span class="line">            entries[rpattern] = entry;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> srs_success;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="拉流端"><a href="#拉流端" class="headerlink" title="拉流端"></a>拉流端</h3><p>拉流端根据URL查找对应的<code>ISrsHttpHandler</code>。</p>
<ul>
<li>断点<code>SrsHttpResponseWriter::write</code>，<code>SrsHttpResponseWriter</code>负责将数据发送给客户端。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#0 SrsHttpResponseWriter::write (this=0x7ffff7eb5bd0, data=0x7ffff7eb5470 &quot;FLV\001\005&quot;, size=9)</span><br><span class="line">   at src/service/srs_service_http_conn.cpp:727</span><br><span class="line">#1 0x00000000004fde19 in SrsBufferWriter::write (this=0x7ffff7eb5860, buf=0x7ffff7eb5470,</span><br><span class="line">   count=9, pnwrite=0x0) at src/app/srs_app_http_stream.cpp:506</span><br><span class="line">#2 0x000000000040e9e1 in SrsFlvTransmuxer::write_header (this=0xa71b10,</span><br><span class="line">   flv_header=0x7ffff7eb5470 &quot;FLV\001\005&quot;) at src/kernel/srs_kernel_flv.cpp:411</span><br><span class="line">#3 0x000000000040e90d in SrsFlvTransmuxer::write_header (this=0xa71b10, has_video=true, has_audio=true)</span><br><span class="line">   at src/kernel/srs_kernel_flv.cpp:399</span><br><span class="line">#4 0x00000000004fd11a in SrsFlvStreamEncoder::write_header (this=0xa68b10, has_video=true, has_audio=true)</span><br><span class="line">   at src/app/srs_app_http_stream.cpp:355</span><br><span class="line">#5 0x00000000004fd04f in SrsFlvStreamEncoder::write_tags (this=0xa68b10, msgs=0xa6da30, count=10)</span><br><span class="line">   at src/app/srs_app_http_stream.cpp:340</span><br><span class="line">#6 0x00000000004ff0dc in SrsLiveStream::do_serve_http (this=0xa3d9d0, w=0x7ffff7eb5bd0, r=0xa91c00)</span><br><span class="line">   at src/app/srs_app_http_stream.cpp:677</span><br><span class="line">#7 0x00000000004fe108 in SrsLiveStream::serve_http (this=0xa3d9d0, w=0x7ffff7eb5bd0, r=0xa91c00)</span><br><span class="line">   at src/app/srs_app_http_stream.cpp:544</span><br><span class="line">#8 0x000000000049c86f in SrsHttpServeMux::serve_http (this=0xa11fe0, w=0x7ffff7eb5bd0, r=0xa91c00)</span><br><span class="line">   at src/protocol/srs_http_stack.cpp:711</span><br><span class="line">#9 0x0000000000562080 in SrsHttpServer::serve_http (this=0xa11e00, w=0x7ffff7eb5bd0, r=0xa91c00)</span><br><span class="line">   at src/app/srs_app_http_conn.cpp:300 </span><br><span class="line">#10 0x000000000049d6be in SrsHttpCorsMux::serve_http (this=0xa3aa60, w=0x7ffff7eb5bd0, r=0xa91c00)</span><br><span class="line">    at src/protocol/srs_http_stack.cpp:859</span><br><span class="line">#11 0x0000000000561086 in SrsHttpConn::process_request (this=0xa626e0, w=0x7ffff7eb5bd0, r=0xa91c00)</span><br><span class="line">    at src/app/srs_app_http_conn.cpp:161</span><br><span class="line">#12 0x0000000000560ce8 in SrsHttpConn::do_cycle (this=0xa626e0) at src/app/srs_app_http_conn.cpp:133</span><br><span class="line">#13 0x00000000004d10fb in SrsConnection::cycle (this=0xa626e0) at src/app/srs_app_conn.cpp:171</span><br><span class="line">#14 0x0000000000509c88 in SrsSTCoroutine::cycle (this=0xa62a70) at src/app/srs_app_st.cpp:198</span><br><span class="line">#15 0x0000000000509cfd in SrsSTCoroutine::pfn (arg=0xa62a70) at src/app/srs_app_st.cpp:213</span><br><span class="line">#16 0x00000000005bdd9d in _st_thread_main () at sched.c:337</span><br><span class="line">#17 0x00000000005be515 in st_thread_create (start=0x5bd719 &lt;_st_vp_schedule+170&gt;,</span><br><span class="line">    arg=0x900000001, joinable=1, stk_size=1) at sched.c:616</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHttpConn::do_cycle</code>中初始化<code>cors-&gt;initialize</code>。</li>
<li><code>http_mux</code>是<code>SrsHttpServer</code> ，之后处理HTTP请求<code>process_request</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpConn::do_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// initialize parser</span></span><br><span class="line">    <span class="keyword">if</span> ((err = parser-&gt;<span class="built_in">initialize</span>(HTTP_REQUEST, <span class="literal">false</span>)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;init parser for %s&quot;</span>, ip.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// set the recv timeout, for some clients never disconnect the connection.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/398</span></span><br><span class="line">    skt-&gt;<span class="built_in">set_recv_timeout</span>(SRS_HTTP_RECV_TIMEOUT);</span><br><span class="line">    </span><br><span class="line">    SrsRequest* last_req = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsRequest, last_req);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// initialize the cors, which will proxy to mux.</span></span><br><span class="line">    <span class="type">bool</span> crossdomain_enabled = _srs_config-&gt;<span class="built_in">get_http_stream_crossdomain</span>();</span><br><span class="line">    <span class="keyword">if</span> ((err = cors-&gt;<span class="built_in">initialize</span>(http_mux, crossdomain_enabled)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;init cors&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// process http messages.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> req_id = <span class="number">0</span>; (err = trd-&gt;<span class="built_in">pull</span>()) == srs_success; req_id++) &#123;</span><br><span class="line">        <span class="comment">// Try to receive a message from http.</span></span><br><span class="line">        <span class="built_in">srs_trace</span>(<span class="string">&quot;HTTP client ip=%s, request=%d, to=%dms&quot;</span>, </span><br><span class="line">                  ip.<span class="built_in">c_str</span>(), req_id, <span class="built_in">srsu2ms</span>(SRS_HTTP_RECV_TIMEOUT));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// get a http message</span></span><br><span class="line">        ISrsHttpMessage* req = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = parser-&gt;<span class="built_in">parse_message</span>(skt, &amp;req)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// if SUCCESS, always NOT-NULL.</span></span><br><span class="line">        <span class="comment">// always free it in this scope.</span></span><br><span class="line">        <span class="built_in">srs_assert</span>(req);</span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(ISrsHttpMessage, req);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Attach owner connection to message.</span></span><br><span class="line">        SrsHttpMessage* hreq = (SrsHttpMessage*)req;</span><br><span class="line">        hreq-&gt;<span class="built_in">set_connection</span>(<span class="keyword">this</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// copy request to last request object.</span></span><br><span class="line">        <span class="built_in">srs_freep</span>(last_req);</span><br><span class="line">        last_req = hreq-&gt;<span class="built_in">to_request</span>(hreq-&gt;<span class="built_in">host</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// may should discard the body.</span></span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">on_got_http_message</span>(req)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ok, handle http request.</span></span><br><span class="line">        <span class="comment">//给客户端推数据SrsHttpResponseWriter</span></span><br><span class="line">        <span class="function">SrsHttpResponseWriter <span class="title">writer</span><span class="params">(skt)</span></span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">process_request</span>(&amp;writer, req)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// donot keep alive, disconnect it.</span></span><br><span class="line">        <span class="comment">// @see https://github.com/ossrs/srs/issues/399</span></span><br><span class="line">        <span class="keyword">if</span> (!req-&gt;<span class="built_in">is_keep_alive</span>()) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">srs_error_t</span> r0 = srs_success;</span><br><span class="line">    <span class="keyword">if</span> ((r0 = <span class="built_in">on_disconnect</span>(last_req)) != srs_success) &#123;</span><br><span class="line">        err = <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;on disconnect %s&quot;</span>, <span class="built_in">srs_error_desc</span>(r0).<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="built_in">srs_freep</span>(r0);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHttpConn::process_request</code>调用<code>SrsHttpCorsMux::serve_http</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpCorsMux::serve_http</span><span class="params">(ISrsHttpResponseWriter* w, ISrsHttpMessage* r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// If CORS enabled, and there is a &quot;Origin&quot; header, it&#x27;s CORS.</span></span><br><span class="line">    <span class="keyword">if</span> (enabled) &#123;</span><br><span class="line">        SrsHttpHeader* h = r-&gt;<span class="built_in">header</span>();</span><br><span class="line">        required = !h-&gt;<span class="built_in">get</span>(<span class="string">&quot;Origin&quot;</span>).<span class="built_in">empty</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// When CORS required, set the CORS headers.</span></span><br><span class="line">    <span class="keyword">if</span> (required) &#123;</span><br><span class="line">        SrsHttpHeader* h = w-&gt;<span class="built_in">header</span>();</span><br><span class="line">        h-&gt;<span class="built_in">set</span>(<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>, <span class="string">&quot;*&quot;</span>);</span><br><span class="line">        h-&gt;<span class="built_in">set</span>(<span class="string">&quot;Access-Control-Allow-Methods&quot;</span>, <span class="string">&quot;GET, POST, HEAD, PUT, DELETE, OPTIONS&quot;</span>);</span><br><span class="line">        h-&gt;<span class="built_in">set</span>(<span class="string">&quot;Access-Control-Expose-Headers&quot;</span>, <span class="string">&quot;Server,range,Content-Length,Content-Range&quot;</span>);</span><br><span class="line">        h-&gt;<span class="built_in">set</span>(<span class="string">&quot;Access-Control-Allow-Headers&quot;</span>, <span class="string">&quot;origin,range,accept-encoding,referer,Cache-Control,X-Proxy-Authorization,X-Requested-With,Content-Type&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// handle the http options.</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;<span class="built_in">is_http_options</span>()) &#123;</span><br><span class="line">        w-&gt;<span class="built_in">header</span>()-&gt;<span class="built_in">set_content_length</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (enabled) &#123;</span><br><span class="line">            w-&gt;<span class="built_in">write_header</span>(SRS_CONSTS_HTTP_OK);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            w-&gt;<span class="built_in">write_header</span>(SRS_CONSTS_HTTP_MethodNotAllowed);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> w-&gt;<span class="built_in">final_request</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_assert</span>(next);</span><br><span class="line">    <span class="keyword">return</span> next-&gt;<span class="built_in">serve_http</span>(w, r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>推流的时候通过<code>mux.handle</code>创建路由规则。</li>
<li>拉流的时候通过<code>http_stream-&gt;mux.find_handler</code>查找路由。</li>
<li>创建的时候根据<code>http_remux</code>配置，例如&#x2F;live&#x2F;test.flv，拉流查找的时候找到对应的才能播放。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpServer::serve_http</span><span class="params">(ISrsHttpResponseWriter* w, ISrsHttpMessage* r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// try http stream first.</span></span><br><span class="line">    ISrsHttpHandler* h = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//查找路由</span></span><br><span class="line">    <span class="keyword">if</span> ((err = http_stream-&gt;mux.<span class="built_in">find_handler</span>(r, &amp;h)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;find handler&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!h-&gt;<span class="built_in">is_not_found</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> http_stream-&gt;mux.<span class="built_in">serve_http</span>(w, r);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> http_static-&gt;mux.<span class="built_in">serve_http</span>(w, r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>匹配<code>entry-&gt;pattern</code>后缀，获取音视频数据<code>source-&gt;create_consumer</code>。</li>
<li>如果是FLV格式<code>ffe-&gt;write_tags</code>写数据，具体里面包含<code>write_header</code>和<code>write_tags</code>，具体参考FLV格式。</li>
<li>最终通过<code>SrsHttpResponseWriter::writev</code>响应客户端。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsLiveStream::do_serve_http</span><span class="params">(ISrsHttpResponseWriter* w, ISrsHttpMessage* r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    string enc_desc;</span><br><span class="line">    ISrsBufferEncoder* enc = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_assert</span>(entry);</span><br><span class="line">    <span class="comment">//匹配后缀</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">srs_string_ends_with</span>(entry-&gt;pattern, <span class="string">&quot;.flv&quot;</span>)) &#123;</span><br><span class="line">        w-&gt;<span class="built_in">header</span>()-&gt;<span class="built_in">set_content_type</span>(<span class="string">&quot;video/x-flv&quot;</span>);</span><br><span class="line">        enc_desc = <span class="string">&quot;FLV&quot;</span>;</span><br><span class="line">        <span class="comment">//FLV Encoder</span></span><br><span class="line">        enc = <span class="keyword">new</span> <span class="built_in">SrsFlvStreamEncoder</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">srs_string_ends_with</span>(entry-&gt;pattern, <span class="string">&quot;.aac&quot;</span>)) &#123;</span><br><span class="line">        w-&gt;<span class="built_in">header</span>()-&gt;<span class="built_in">set_content_type</span>(<span class="string">&quot;audio/x-aac&quot;</span>);</span><br><span class="line">        enc_desc = <span class="string">&quot;AAC&quot;</span>;</span><br><span class="line">        enc = <span class="keyword">new</span> <span class="built_in">SrsAacStreamEncoder</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">srs_string_ends_with</span>(entry-&gt;pattern, <span class="string">&quot;.mp3&quot;</span>)) &#123;</span><br><span class="line">        w-&gt;<span class="built_in">header</span>()-&gt;<span class="built_in">set_content_type</span>(<span class="string">&quot;audio/mpeg&quot;</span>);</span><br><span class="line">        enc_desc = <span class="string">&quot;MP3&quot;</span>;</span><br><span class="line">        enc = <span class="keyword">new</span> <span class="built_in">SrsMp3StreamEncoder</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">srs_string_ends_with</span>(entry-&gt;pattern, <span class="string">&quot;.ts&quot;</span>)) &#123;</span><br><span class="line">        w-&gt;<span class="built_in">header</span>()-&gt;<span class="built_in">set_content_type</span>(<span class="string">&quot;video/MP2T&quot;</span>);</span><br><span class="line">        enc_desc = <span class="string">&quot;TS&quot;</span>;</span><br><span class="line">        enc = <span class="keyword">new</span> <span class="built_in">SrsTsStreamEncoder</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_HTTP_LIVE_STREAM_EXT, <span class="string">&quot;invalid pattern=%s&quot;</span>, entry-&gt;pattern.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(ISrsBufferEncoder, enc);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Enter chunked mode, because we didn&#x27;t set the content-length.</span></span><br><span class="line">    w-&gt;<span class="built_in">write_header</span>(SRS_CONSTS_HTTP_OK);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// create consumer of souce, ignore gop cache, use the audio gop cache.</span></span><br><span class="line">    SrsConsumer* consumer = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">create_consumer</span>(<span class="literal">NULL</span>, consumer, <span class="literal">true</span>, <span class="literal">true</span>, !enc-&gt;<span class="built_in">has_cache</span>())) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;create consumer&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsConsumer, consumer);</span><br><span class="line">    <span class="built_in">srs_verbose</span>(<span class="string">&quot;http: consumer created success.&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    SrsPithyPrint* pprint = SrsPithyPrint::<span class="built_in">create_http_stream</span>();</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsPithyPrint, pprint);</span><br><span class="line">    </span><br><span class="line">    <span class="function">SrsMessageArray <span class="title">msgs</span><span class="params">(SRS_PERF_MW_MSGS)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use receive thread to accept the close event to avoid FD leak.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/issues/636#issuecomment-298208427</span></span><br><span class="line">    SrsHttpMessage* hr = <span class="built_in">dynamic_cast</span>&lt;SrsHttpMessage*&gt;(r);</span><br><span class="line">    SrsResponseOnlyHttpConn* hc = <span class="built_in">dynamic_cast</span>&lt;SrsResponseOnlyHttpConn*&gt;(hr-&gt;<span class="built_in">connection</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// update the statistic when source disconveried.</span></span><br><span class="line">    SrsStatistic* stat = SrsStatistic::<span class="built_in">instance</span>();</span><br><span class="line">    <span class="keyword">if</span> ((err = stat-&gt;<span class="built_in">on_client</span>(_srs_context-&gt;<span class="built_in">get_id</span>(), req, hc, SrsRtmpConnPlay)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;stat on client&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// the memory writer.</span></span><br><span class="line">    <span class="function">SrsBufferWriter <span class="title">writer</span><span class="params">(w)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> ((err = enc-&gt;<span class="built_in">initialize</span>(&amp;writer, cache)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;init encoder&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if gop cache enabled for encoder, dump to consumer.</span></span><br><span class="line">    <span class="keyword">if</span> (enc-&gt;<span class="built_in">has_cache</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = enc-&gt;<span class="built_in">dump_cache</span>(consumer, source-&gt;<span class="built_in">jitter</span>())) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;encoder dump cache&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    SrsFlvStreamEncoder* ffe = <span class="built_in">dynamic_cast</span>&lt;SrsFlvStreamEncoder*&gt;(enc);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Set the socket options for transport.</span></span><br><span class="line">    <span class="type">bool</span> tcp_nodelay = _srs_config-&gt;<span class="built_in">get_tcp_nodelay</span>(req-&gt;vhost);</span><br><span class="line">    <span class="keyword">if</span> (tcp_nodelay) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = hc-&gt;<span class="built_in">set_tcp_nodelay</span>(tcp_nodelay)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;set tcp nodelay&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">srs_utime_t</span> mw_sleep = _srs_config-&gt;<span class="built_in">get_mw_sleep</span>(req-&gt;vhost);</span><br><span class="line">    <span class="keyword">if</span> ((err = hc-&gt;<span class="built_in">set_socket_buffer</span>(mw_sleep)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;set mw_sleep %&quot;</span> PRId64, mw_sleep);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//读取客户端数据，直接丢弃了</span></span><br><span class="line">    SrsHttpRecvThread* trd = <span class="keyword">new</span> <span class="built_in">SrsHttpRecvThread</span>(hc);</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsHttpRecvThread, trd);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">start</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;start recv thread&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;FLV %s, encoder=%s, nodelay=%d, mw_sleep=%dms, cache=%d, msgs=%d&quot;</span>,</span><br><span class="line">        entry-&gt;pattern.<span class="built_in">c_str</span>(), enc_desc.<span class="built_in">c_str</span>(), tcp_nodelay, <span class="built_in">srsu2msi</span>(mw_sleep),</span><br><span class="line">        enc-&gt;<span class="built_in">has_cache</span>(), msgs.max);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> free and erase the disabled entry after all related connections is closed.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> FXIME: Support timeout for player, quit infinite-loop.</span></span><br><span class="line">    <span class="keyword">while</span> (entry-&gt;enabled) &#123;</span><br><span class="line">        <span class="comment">// Whether client closed the FD.</span></span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pprint-&gt;<span class="built_in">elapse</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// get messages from consumer.</span></span><br><span class="line">        <span class="comment">// each msg in msgs.msgs must be free, for the SrsMessageArray never free them.</span></span><br><span class="line">        <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = consumer-&gt;<span class="built_in">dump_packets</span>(&amp;msgs, count)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;consumer dump packets&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Directly use sleep, donot use consumer wait, because we couldn&#x27;t awake consumer.</span></span><br><span class="line">            <span class="built_in">srs_usleep</span>(mw_sleep);</span><br><span class="line">            <span class="comment">// ignore when nothing got.</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (pprint-&gt;<span class="built_in">can_print</span>()) &#123;</span><br><span class="line">            <span class="built_in">srs_trace</span>(<span class="string">&quot;-&gt; &quot;</span> SRS_CONSTS_LOG_HTTP_STREAM <span class="string">&quot; http: got %d msgs, age=%d, min=%d, mw=%d&quot;</span>,</span><br><span class="line">                count, pprint-&gt;<span class="built_in">age</span>(), SRS_PERF_MW_MIN_MSGS, <span class="built_in">srsu2msi</span>(mw_sleep));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// sendout all messages.</span></span><br><span class="line">        <span class="keyword">if</span> (ffe) &#123;</span><br><span class="line">            err = ffe-&gt;<span class="built_in">write_tags</span>(msgs.msgs, count);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            err = <span class="built_in">streaming_send_messages</span>(enc, msgs.msgs, count);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// free the messages.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            SrsSharedPtrMessage* msg = msgs.msgs[i];</span><br><span class="line">            <span class="built_in">srs_freep</span>(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// check send error code.</span></span><br><span class="line">        <span class="keyword">if</span> (err != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send messages&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Here, the entry is disabled by encoder un-publishing or reloading,</span></span><br><span class="line">    <span class="comment">// so we must return a io.EOF error to disconnect the client, or the client will never quit.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_HTTP_STREAM_EOF, <span class="string">&quot;Stream EOF&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsHttpRecvThread</code>协程读取客户端数据<code>conn-&gt;pop_message</code>直接丢弃。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsHttpRecvThread::cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> ((err = trd-&gt;<span class="built_in">pull</span>()) == srs_success) &#123;</span><br><span class="line">        ISrsHttpMessage* req = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(ISrsHttpMessage, req);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = conn-&gt;<span class="built_in">pop_message</span>(&amp;req)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;pop message&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsFlvStreamEncoder::write_tags</code>对FLV格式封装。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsFlvStreamEncoder::write_tags</span><span class="params">(SrsSharedPtrMessage** msgs, <span class="type">int</span> count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// For https://github.com/ossrs/srs/issues/939</span></span><br><span class="line">    <span class="keyword">if</span> (!header_written) &#123;</span><br><span class="line">        <span class="type">bool</span> has_video = <span class="literal">false</span>;</span><br><span class="line">        <span class="type">bool</span> has_audio = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count &amp;&amp; (!has_video || !has_audio); i++) &#123;</span><br><span class="line">            SrsSharedPtrMessage* msg = msgs[i];</span><br><span class="line">            <span class="keyword">if</span> (msg-&gt;<span class="built_in">is_video</span>()) &#123;</span><br><span class="line">                has_video = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (msg-&gt;<span class="built_in">is_audio</span>()) &#123;</span><br><span class="line">                has_audio = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Drop data if no A+V.</span></span><br><span class="line">        <span class="keyword">if</span> (!has_video &amp;&amp; !has_audio) &#123;</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">write_header</span>(has_video, has_audio))  != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;write header&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> enc-&gt;<span class="built_in">write_tags</span>(msgs, count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/09/30/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BRTMP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/09/30/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BRTMP/" class="post-title-link" itemprop="url">SRS流媒体服务器之RTMP</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-30 13:02:25" itemprop="dateCreated datePublished" datetime="2023-09-30T13:02:25+08:00">2023-09-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-12-30 22:37:25" itemprop="dateModified" datetime="2023-12-30T22:37:25+08:00">2023-12-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SRS/" itemprop="url" rel="index"><span itemprop="name">SRS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="RTMP推拉流"><a href="#RTMP推拉流" class="headerlink" title="RTMP推拉流"></a>RTMP推拉流</h1><ul>
<li><p>创建监听套接字</p>
<ul>
<li>RTMP创建监听套接字<code>SrsServer::listen_rtmp</code>。</li>
<li>启动协程<code>SrsSTCoroutine::start</code>，每个监听对应一个协程。</li>
<li>协程函数<code>SrsTcpListener::cycle</code>。</li>
</ul>
</li>
<li><p>处理客户端连接</p>
<ul>
<li><p>检测获取客户端连接<code>srs_accept</code>，如果有连接则调用<code>handler-&gt;on_tcp_client</code>。</p>
</li>
<li><p>客户端连接具体实现<code>accept_client</code>，其中<code>fd2conn</code>函数中创建<code>SrsRtmpConn</code>并且绑定连接套接字和连接上下文，之后启动协程<code>conn-&gt;start</code>，每个连接对应一个协程。</p>
</li>
<li><p>协程函数在<code>SrsRtmpConn::do_cycle()</code>中具体实现。</p>
</li>
<li><p>进入 <code>SrsRtmpConn::do_cycle</code>后其中<code>stream_service_cycle</code>里面还分为发布和推流不同分支。</p>
</li>
<li><p>创建或查找<code>SrsSource</code>，一个推流源对应一个<code>SrsSourcce</code>。</p>
</li>
</ul>
</li>
<li><p>推流端</p>
<ul>
<li>每个推流端都会创建一个<code>SrsPublishRecvThread</code>，用来接收数据和推送数据到队列给拉流端使用。</li>
<li>RTMP接收数据<code>rtmp-&gt;recv_message</code>，并且调用<code>pumper-&gt;consume(msg)</code>将处理消息，处理后的消息<code>SrsCommonMessage</code>会推送给<code>SrsComsumer</code>。</li>
</ul>
</li>
<li><p>拉流端</p>
<ul>
<li>每个拉流端都会创建一个<code>SrsQueueRecvThread</code>，用来处理拉流端控制消息，注意和⾳视频消息没有关系。</li>
<li>同时会创建<code>SrsComsumer</code>，<code>SrsSource</code>会将数据通过队列推送过来，之后进行数据处理发送给客户端。</li>
</ul>
</li>
<li><p>核心类</p>
<ul>
<li><code>SrsServer</code>：SRS流媒体服务⼊⼝。</li>
<li><code>SrsBufferListener</code>：监听器，主要是TCP的监听。</li>
<li><code>SrsTcpListener</code>：TCP监听器。</li>
<li><code>SrsRtmpConn</code>：RTMP连接，⾥⾯对应了SrsStSocket和SrsCoroutine。</li>
<li><code>SrsRtmpServer</code>：提供与客户端之间的RTMP-命令-协议-消息的交互服务，使⽤SrsRtmpConn 提供的socket读写数据。</li>
<li><code>SrsSource</code>：描述⼀路播放源，包括推流和拉流的描述。</li>
<li><code>SrsConsumer</code>：拉流消费者，每⼀路拉流客户端对应⼀个SrsConsumer。</li>
<li><code>SrsStSocket</code>：经过封装的socket接⼝。</li>
</ul>
</li>
</ul>
<h2 id="创建监听套接字"><a href="#创建监听套接字" class="headerlink" title="创建监听套接字"></a>创建监听套接字</h2><ul>
<li>RTMP创建监听套接字，并且启动协程。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsServer::listen_rtmp</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// stream service port.</span></span><br><span class="line">    std::vector&lt;std::string&gt; ip_ports = _srs_config-&gt;<span class="built_in">get_listens</span>();</span><br><span class="line">    <span class="built_in">srs_assert</span>((<span class="type">int</span>)ip_ports.<span class="built_in">size</span>() &gt; <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">close_listeners</span>(SrsListenerRtmpStream);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; (<span class="type">int</span>)ip_ports.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        SrsListener* listener = <span class="keyword">new</span> <span class="built_in">SrsBufferListener</span>(<span class="keyword">this</span>, SrsListenerRtmpStream);</span><br><span class="line">        listeners.<span class="built_in">push_back</span>(listener);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> port; string ip;</span><br><span class="line">        <span class="built_in">srs_parse_endpoint</span>(ip_ports[i], ip, port);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//这里调用SrsTcpListener::listen()</span></span><br><span class="line">        <span class="comment">//1.内部创建TCP Socket，bind，listen </span></span><br><span class="line">        <span class="comment">//2.创建SrsSTCoroutine并且执行start() 启动协程</span></span><br><span class="line">        <span class="keyword">if</span> ((err = listener-&gt;<span class="built_in">listen</span>(ip, port)) != srs_success) &#123;</span><br><span class="line">            <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp listen %s:%d&quot;</span>, ip.<span class="built_in">c_str</span>(), port);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>上述启动协程会调用<code>SrsSTCoroutine::start()</code>函数，主要会调用<code>ISrsCoroutineHandler::cycle()</code>函数，该函数子类<code>SrsTcpListener</code>会重写，具体看下面。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsSTCoroutine::start</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//_ST_THREAD_CREATE_PFN _pfn_st_thread_create = (_ST_THREAD_CREATE_PFN)st_thread_create;</span></span><br><span class="line">    <span class="comment">//pfn回调内部调用了cycle()</span></span><br><span class="line">    <span class="keyword">if</span> ((trd = (<span class="type">srs_thread_t</span>)_pfn_st_thread_create(pfn, <span class="keyword">this</span>, <span class="number">1</span>, <span class="number">0</span>)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        err = <span class="built_in">srs_error_new</span>(ERROR_ST_CREATE_CYCLE_THREAD, <span class="string">&quot;create failed&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">srs_freep</span>(trd_err);</span><br><span class="line">        trd_err = <span class="built_in">srs_error_copy</span>(err);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//pfn内部调用了p-&gt;cycle()</span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">SrsSTCoroutine::pfn</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SrsSTCoroutine* p = (SrsSTCoroutine*)arg;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里跟进去调用ISrsCoroutineHandler::cycle()</span></span><br><span class="line">    <span class="comment">//ISrsCoroutineHandler是个接口类</span></span><br><span class="line">    <span class="type">srs_error_t</span> err = p-&gt;<span class="built_in">cycle</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the err for function pull to fetch it.</span></span><br><span class="line">    <span class="comment">// @see https://github.com/ossrs/srs/pull/1304#issuecomment-480484151</span></span><br><span class="line">    <span class="keyword">if</span> (err != srs_success) &#123;</span><br><span class="line">        <span class="built_in">srs_freep</span>(p-&gt;trd_err);</span><br><span class="line">        <span class="comment">// It&#x27;s ok to directly use it, because it&#x27;s returned by st_thread_join.</span></span><br><span class="line">        p-&gt;trd_err = err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="type">void</span>*)err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>ISrsCoroutineHandler</code>接口。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ISrsCoroutineHandler</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ISrsCoroutineHandler</span>();</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">ISrsCoroutineHandler</span>();</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// Do the work. The ST-coroutine will terminated normally if it returned.</span></span><br><span class="line">    <span class="comment">// @remark If the cycle has its own loop, it must check the thread pull.</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">srs_error_t</span> <span class="title">cycle</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsTcpListener::cycle()</code></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsTcpListener::cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;tcp listener&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//检测获取客户端连接Socket</span></span><br><span class="line">        <span class="type">srs_netfd_t</span> fd = <span class="built_in">srs_accept</span>(lfd, <span class="literal">NULL</span>, <span class="literal">NULL</span>, SRS_UTIME_NO_TIMEOUT);</span><br><span class="line">        <span class="keyword">if</span>(fd == <span class="literal">NULL</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_SOCKET_ACCEPT, <span class="string">&quot;accept at fd=%d&quot;</span>, <span class="built_in">srs_netfd_fileno</span>(lfd));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">	    <span class="keyword">if</span> ((err = <span class="built_in">srs_fd_closeexec</span>(<span class="built_in">srs_netfd_fileno</span>(fd))) != srs_success) &#123;</span><br><span class="line">	        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;set closeexec&quot;</span>);</span><br><span class="line">	    &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//处理新的客户端连接，内部调用SrsServer::accept_client()</span></span><br><span class="line">        <span class="keyword">if</span> ((err = handler-&gt;<span class="built_in">on_tcp_client</span>(fd)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;handle fd=%d&quot;</span>, <span class="built_in">srs_netfd_fileno</span>(fd));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="处理客户端连接"><a href="#处理客户端连接" class="headerlink" title="处理客户端连接"></a>处理客户端连接</h2><ul>
<li><code>fd2conn</code>创建一个<code>SrsRtmpConn</code>并且会绑定连接套接字，其中<code>SrsRtmpConn</code>对应一个<code>SrsRtmpServer</code>，内部也会创建一个协程。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsServer::accept_client</span><span class="params">(SrsListenerType type, <span class="type">srs_netfd_t</span> stfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    SrsConnection* conn = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//绑定Socket和conn，根据不同StreamType创建conn</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    if (type == SrsListenerRtmpStream) &#123;</span></span><br><span class="line"><span class="comment">        *pconn = new SrsRtmpConn(this, stfd, ip);</span></span><br><span class="line"><span class="comment">    &#125; else if (type == SrsListenerHttpApi) &#123;</span></span><br><span class="line"><span class="comment">        *pconn = new SrsHttpApi(this, stfd, http_api_mux, ip);</span></span><br><span class="line"><span class="comment">    &#125; else if (type == SrsListenerHttpStream) &#123;</span></span><br><span class="line"><span class="comment">        *pconn = new SrsResponseOnlyHttpConn(this, stfd, http_server, ip);</span></span><br><span class="line"><span class="comment">    &#125; else &#123;</span></span><br><span class="line"><span class="comment">        srs_warn(&quot;close for no service handler. fd=%d, ip=%s&quot;, fd, ip.c_str());</span></span><br><span class="line"><span class="comment">        srs_close_stfd(stfd);</span></span><br><span class="line"><span class="comment">        return err;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">fd2conn</span>(type, stfd, &amp;conn)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">srs_error_code</span>(err) == ERROR_SOCKET_GET_PEER_IP &amp;&amp; _srs_config-&gt;<span class="built_in">empty_ip_ok</span>()) &#123;</span><br><span class="line">            <span class="built_in">srs_close_stfd</span>(stfd); <span class="built_in">srs_error_reset</span>(err);</span><br><span class="line">            <span class="keyword">return</span> srs_success;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;fd2conn&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">srs_assert</span>(conn);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// directly enqueue, the cycle thread will remove the client.</span></span><br><span class="line">    conns.<span class="built_in">push_back</span>(conn);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cycle will start process thread and when finished remove the client.</span></span><br><span class="line">    <span class="comment">// @remark never use the conn, for it maybe destroyed.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = conn-&gt;<span class="built_in">start</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;start conn coroutine&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>conn-&gt;start()</code>会创建一个协程处理与客户端的连接交互，RTMP在<code>SrsRtmpConn::do_cycle()</code>中具体实现。其中<code>service_cycle</code>继续调用<code>stream_service_cycle</code>里面还分为发布和推流不同分支。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::do_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//握手</span></span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">handshake</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp handshake&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">connect_app</span>(req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp connect tcUrl&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">service_cycle</span>()) != srs_success) &#123;</span><br><span class="line">        err = <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;service cycle&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">srs_error_t</span> r0 = srs_success;</span><br><span class="line">    <span class="keyword">if</span> ((r0 = <span class="built_in">on_disconnect</span>()) != srs_success) &#123;</span><br><span class="line">        err = <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;on disconnect %s&quot;</span>, <span class="built_in">srs_error_desc</span>(r0).<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="built_in">srs_freep</span>(r0);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// If client is redirect to other servers, we already logged the event.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">srs_error_code</span>(err) == ERROR_CONTROL_REDIRECT) &#123;</span><br><span class="line">        <span class="built_in">srs_error_reset</span>(err);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>stream_service_cycle</code>主要创建或查找一个<code>SrsSource</code>，并且处理<code>publishing</code>或<code>playing</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::stream_service_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    </span><br><span class="line">   	<span class="comment">// find a source to serve.</span></span><br><span class="line">    SrsSource* source = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> ((err = _srs_sources-&gt;<span class="built_in">fetch_or_create</span>(req, server, &amp;source)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: fetch source&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (info-&gt;type) &#123;</span><br><span class="line">        <span class="keyword">case</span> SrsRtmpConnPlay: &#123;</span><br><span class="line">            <span class="comment">// response connection start play</span></span><br><span class="line">            <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">start_play</span>(info-&gt;res-&gt;stream_id)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: start play&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((err = <span class="built_in">http_hooks_on_play</span>()) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: callback on play&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            err = <span class="built_in">playing</span>(source);</span><br><span class="line">            <span class="built_in">http_hooks_on_stop</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> SrsRtmpConnFMLEPublish: &#123;</span><br><span class="line">            <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">start_fmle_publish</span>(info-&gt;res-&gt;stream_id)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: start FMLE publish&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">publishing</span>(source);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_SYSTEM_CLIENT_INVALID, <span class="string">&quot;rtmp: unknown client type=%d&quot;</span>, info-&gt;type);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="推流端"><a href="#推流端" class="headerlink" title="推流端"></a>推流端</h2><ul>
<li><code>SrsPublishRecvThread</code>内部封装了协程，具体看下<code>do_publishing</code>中<code>SrsPublishRecvThread::start()</code>，继续进入<code>SrsRecvThread::start()</code>，最后到<code>SrsRecvThread::do_cycle()</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::publishing</span><span class="params">(SrsSource* source)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> Should refine the state of publishing.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">acquire_publish</span>(source)) == srs_success) &#123;</span><br><span class="line">        <span class="comment">// use isolate thread to recv,</span></span><br><span class="line">        <span class="comment">// @see: https://github.com/ossrs/srs/issues/237</span></span><br><span class="line">        <span class="function">SrsPublishRecvThread <span class="title">rtrd</span><span class="params">(rtmp, req, </span></span></span><br><span class="line"><span class="params"><span class="function">                                  srs_netfd_fileno(stfd), </span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="number">0</span>, <span class="keyword">this</span>, source, </span></span></span><br><span class="line"><span class="params"><span class="function">                                  _srs_context-&gt;get_id())</span></span>;</span><br><span class="line">        err = <span class="built_in">do_publishing</span>(source, &amp;rtrd);</span><br><span class="line">        rtrd.<span class="built_in">stop</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsRecvThread::do_cycle</code>中主要看到RTMP接收数据<code>rtmp-&gt;recv_message</code>，并且调用<code>pumper-&gt;consume(msg)</code>将处理消息。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRecvThread::do_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When the pumper is interrupted, wait then retry.</span></span><br><span class="line">        <span class="keyword">if</span> (pumper-&gt;<span class="built_in">interrupted</span>()) &#123;</span><br><span class="line">            <span class="built_in">srs_usleep</span>(timeout);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        SrsCommonMessage* msg = <span class="literal">NULL</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Process the received message.</span></span><br><span class="line">        <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">recv_message</span>(&amp;msg)) == srs_success) &#123;</span><br><span class="line">            err = pumper-&gt;<span class="built_in">consume</span>(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (err != srs_success) &#123;</span><br><span class="line">            <span class="comment">// Interrupt the receive thread for any error.</span></span><br><span class="line">            trd-&gt;<span class="built_in">interrupt</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Notify the pumper to quit for error.</span></span><br><span class="line">            pumper-&gt;<span class="built_in">interrupt</span>(err);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>SrsRtmpServer::recv_message</code>调用<code>protocol-&gt;recv_message(pmsg)</code>处理。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsProtocol::recv_message</span><span class="params">(SrsCommonMessage** pmsg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *pmsg = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsCommonMessage* msg = <span class="literal">NULL</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">recv_interlaced_message</span>(&amp;msg)) != srs_success) &#123;</span><br><span class="line">            <span class="built_in">srs_freep</span>(msg);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv interlaced message&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!msg) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (msg-&gt;size &lt;= <span class="number">0</span> || msg-&gt;header.payload_length &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">srs_trace</span>(<span class="string">&quot;ignore empty message(type=%d, size=%d, time=%&quot;</span> PRId64 <span class="string">&quot;, sid=%d).&quot;</span>,</span><br><span class="line">                      msg-&gt;header.message_type, msg-&gt;header.payload_length,</span><br><span class="line">                      msg-&gt;header.timestamp, msg-&gt;header.stream_id);</span><br><span class="line">            <span class="built_in">srs_freep</span>(msg);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">on_recv_message</span>(msg)) != srs_success) &#123;</span><br><span class="line">            <span class="built_in">srs_freep</span>(msg);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;on recv message&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        *pmsg = msg;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>consume</code>消息处理。</li>
</ul>
<pre class="mermaid">graph TB
    F1[SrsPublishRecvThread::consume]-->F2[SrsRtmpConn::handle_publish_message]
    F2-->F3[SrsRtmpConn::process_publish_message]
    F3-->F3_1[SrsSource::on_audio]
    F3-->F3_2[SrsSource::on_video]
    F3-->F3_3[SrsSource::on_meta_data]
    F3_1-->F3_1_1[SrsSource::on_audio_imp]
    F3_1_1-->F3_1_1_1[SrsMetaCache::update_ash]
    F3_1_1-->F3_1_1_2[SrsConsumer::enqueue]</pre>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsPublishRecvThread::consume</span><span class="params">(SrsCommonMessage* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    err = _conn-&gt;<span class="built_in">handle_publish_message</span>(_source, msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>handle_publish_message</code>调用<code>process_publish_message</code></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::process_publish_message</span><span class="params">(SrsSource* source, SrsCommonMessage* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// process audio packet</span></span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;header.<span class="built_in">is_audio</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">on_audio</span>(msg)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: consume audio&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// process video packet</span></span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;header.<span class="built_in">is_video</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">on_video</span>(msg)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: consume video&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// process aggregate packet</span></span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;header.<span class="built_in">is_aggregate</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">on_aggregate</span>(msg)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: consume aggregate&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// process onMetaData</span></span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;header.<span class="built_in">is_amf0_data</span>() || msg-&gt;header.<span class="built_in">is_amf3_data</span>()) &#123;</span><br><span class="line">        SrsPacket* pkt = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">decode_message</span>(msg, &amp;pkt)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: decode message&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(SrsPacket, pkt);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">dynamic_cast</span>&lt;SrsOnMetaDataPacket*&gt;(pkt)) &#123;</span><br><span class="line">            SrsOnMetaDataPacket* metadata = <span class="built_in">dynamic_cast</span>&lt;SrsOnMetaDataPacket*&gt;(pkt);</span><br><span class="line">            <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">on_meta_data</span>(msg, metadata)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: consume metadata&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>跟踪音频流<code>source-&gt;on_audio</code>处理音频包，最终会调到<code>on_audio_imp</code>，将消息<code>SrsCommonMessage</code>推送到<code>SrsConsumer</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsSource::on_audio_imp</span><span class="params">(SrsSharedPtrMessage* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// copy to all consumer</span></span><br><span class="line">    <span class="keyword">if</span> (!drop_for_reduce) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; (<span class="type">int</span>)consumers.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            SrsConsumer* consumer = consumers.<span class="built_in">at</span>(i);</span><br><span class="line">            <span class="keyword">if</span> ((err = consumer-&gt;<span class="built_in">enqueue</span>(msg, atc, jitter_algorithm)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;consume message&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Copy to hub to all utilities.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = hub-&gt;<span class="built_in">on_audio</span>(msg)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;consume audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cache the sequence header of aac, or first packet of mp3.</span></span><br><span class="line">    <span class="comment">// for example, the mp3 is used for hls to write the &quot;right&quot; audio codec.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> to refine the stream info system.</span></span><br><span class="line">    <span class="comment">//保存sequence header</span></span><br><span class="line">    <span class="keyword">if</span> (is_aac_sequence_header || !meta-&gt;<span class="built_in">ash</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = meta-&gt;<span class="built_in">update_ash</span>(msg)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;meta consume audio&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// when sequence header, donot push to gop cache and adjust the timestamp.</span></span><br><span class="line">    <span class="keyword">if</span> (is_sequence_header) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cache the last gop packets</span></span><br><span class="line">    <span class="comment">//gop 缓存减少延迟</span></span><br><span class="line">    <span class="keyword">if</span> ((err = gop_cache-&gt;<span class="built_in">cache</span>(msg)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;gop cache consume audio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="拉流端"><a href="#拉流端" class="headerlink" title="拉流端"></a>拉流端</h2><ul>
<li>控制相关。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpServer::start_play</span><span class="params">(<span class="type">int</span> stream_id)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>看到<code>source-&gt;create_consumer</code>创建消费者，推流端<code>SrsSource::on_audio_imp</code>中有消息将会推送<code>consumer-&gt;enqueue</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::playing</span><span class="params">(SrsSource* source)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// SrsSource的消费者，每个拉流端都会绑定一个SrsConsumer</span></span><br><span class="line">    <span class="comment">// Create a consumer of source.</span></span><br><span class="line">    SrsConsumer* consumer = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> ((err = source-&gt;<span class="built_in">create_consumer</span>(<span class="keyword">this</span>, consumer)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: create consumer&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsConsumer, consumer);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Use receiving thread to receive packets from peer.</span></span><br><span class="line">    <span class="comment">// @see: https://github.com/ossrs/srs/issues/217</span></span><br><span class="line">    <span class="comment">//接收消息的线程是每个SrsRtmpConn是独立的</span></span><br><span class="line">    <span class="function">SrsQueueRecvThread <span class="title">trd</span><span class="params">(consumer, rtmp, SRS_PERF_MW_SLEEP, _srs_context-&gt;get_id())</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = trd.<span class="built_in">start</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: start receive thread&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Deliver packets to peer.</span></span><br><span class="line">    wakable = consumer;</span><br><span class="line">    err = <span class="built_in">do_playing</span>(source, consumer, &amp;trd);</span><br><span class="line">    wakable = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    trd.<span class="built_in">stop</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Drop all packets in receiving thread.</span></span><br><span class="line">    <span class="keyword">if</span> (!trd.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="built_in">srs_warn</span>(<span class="string">&quot;drop the received %d messages&quot;</span>, trd.<span class="built_in">size</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>consumer-&gt;dump_packets</code>获取来自拉流端<code>SrsSource</code>传递给<code>SrsConsumer</code>的数据，并且发送数据给客户端。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::do_playing</span><span class="params">(SrsSource* source, SrsConsumer* consumer, SrsQueueRecvThread* rtrd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">// when source is set to expired, disconnect it.</span></span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: thread quit&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// collect elapse for pithy print.</span></span><br><span class="line">        pprint-&gt;<span class="built_in">elapse</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// to use isolate thread to recv, can improve about 33% performance.</span></span><br><span class="line">        <span class="comment">// @see: https://github.com/ossrs/srs/issues/196</span></span><br><span class="line">        <span class="comment">// @see: https://github.com/ossrs/srs/issues/217</span></span><br><span class="line">        <span class="keyword">while</span> (!rtrd-&gt;<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            SrsCommonMessage* msg = rtrd-&gt;<span class="built_in">pump</span>();</span><br><span class="line">            <span class="comment">//处理拉流客户端的控制消息</span></span><br><span class="line">            <span class="keyword">if</span> ((err = <span class="built_in">process_play_control_msg</span>(consumer, msg)) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: play control message&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// quit when recv thread error.</span></span><br><span class="line">        <span class="keyword">if</span> ((err = rtrd-&gt;<span class="built_in">error_code</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: recv thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRS_PERF_QUEUE_COND_WAIT</span></span><br><span class="line">        <span class="comment">// wait for message to incoming.</span></span><br><span class="line">        <span class="comment">// @see https://github.com/ossrs/srs/issues/251</span></span><br><span class="line">        <span class="comment">// @see https://github.com/ossrs/srs/issues/257</span></span><br><span class="line">        <span class="keyword">if</span> (realtime) &#123;</span><br><span class="line">            <span class="comment">// for realtime, min required msgs is 0, send when got one+ msgs.</span></span><br><span class="line">            consumer-&gt;<span class="built_in">wait</span>(<span class="number">0</span>, mw_sleep);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// for no-realtime, got some msgs then send.</span></span><br><span class="line">            consumer-&gt;<span class="built_in">wait</span>(SRS_PERF_MW_MIN_MSGS, mw_sleep);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// get messages from consumer.</span></span><br><span class="line">        <span class="comment">// each msg in msgs.msgs must be free, for the SrsMessageArray never free them.</span></span><br><span class="line">        <span class="comment">// @remark when enable send_min_interval, only fetch one message a time.</span></span><br><span class="line">        <span class="type">int</span> count = (send_min_interval &gt; <span class="number">0</span>)? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//获取消息</span></span><br><span class="line">        <span class="keyword">if</span> ((err = consumer-&gt;<span class="built_in">dump_packets</span>(&amp;msgs, count)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: consumer dump packets&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// reportable</span></span><br><span class="line">        <span class="keyword">if</span> (pprint-&gt;<span class="built_in">can_print</span>()) &#123;</span><br><span class="line">            kbps-&gt;<span class="built_in">sample</span>();</span><br><span class="line">            <span class="built_in">srs_trace</span>(<span class="string">&quot;-&gt; &quot;</span> SRS_CONSTS_LOG_PLAY <span class="string">&quot; time=%d, msgs=%d, okbps=%d,%d,%d, ikbps=%d,%d,%d, mw=%d&quot;</span>,</span><br><span class="line">                (<span class="type">int</span>)pprint-&gt;<span class="built_in">age</span>(), count, kbps-&gt;<span class="built_in">get_send_kbps</span>(), kbps-&gt;<span class="built_in">get_send_kbps_30s</span>(), kbps-&gt;<span class="built_in">get_send_kbps_5m</span>(),</span><br><span class="line">                kbps-&gt;<span class="built_in">get_recv_kbps</span>(), kbps-&gt;<span class="built_in">get_recv_kbps_30s</span>(), kbps-&gt;<span class="built_in">get_recv_kbps_5m</span>(), <span class="built_in">srsu2msi</span>(mw_sleep));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> SRS_PERF_QUEUE_COND_WAIT</span></span><br><span class="line">            <span class="built_in">srs_usleep</span>(mw_sleep);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            <span class="comment">// ignore when nothing got.</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// only when user specifies the duration,</span></span><br><span class="line">        <span class="comment">// we start to collect the durations for each message.</span></span><br><span class="line">        <span class="keyword">if</span> (user_specified_duration_to_stop) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">                SrsSharedPtrMessage* msg = msgs.msgs[i];</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// foreach msg, collect the duration.</span></span><br><span class="line">                <span class="comment">// @remark: never use msg when sent it, for the protocol sdk will free it.</span></span><br><span class="line">                <span class="keyword">if</span> (starttime &lt; <span class="number">0</span> || starttime &gt; msg-&gt;timestamp) &#123;</span><br><span class="line">                    starttime = msg-&gt;timestamp;</span><br><span class="line">                &#125;</span><br><span class="line">                duration += (msg-&gt;timestamp - starttime) * SRS_UTIME_MILLISECONDS;</span><br><span class="line">                starttime = msg-&gt;timestamp;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// sendout messages, all messages are freed by send_and_free_messages().</span></span><br><span class="line">        <span class="comment">// no need to assert msg, for the rtmp will assert it.</span></span><br><span class="line">        <span class="comment">//发送数据给play客户端</span></span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span> &amp;&amp; (err = rtmp-&gt;<span class="built_in">send_and_free_messages</span>(msgs.msgs, count, info-&gt;res-&gt;stream_id)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: send %d messages&quot;</span>, count);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// if duration specified, and exceed it, stop play live.</span></span><br><span class="line">        <span class="comment">// @see: https://github.com/ossrs/srs/issues/45</span></span><br><span class="line">        <span class="keyword">if</span> (user_specified_duration_to_stop) &#123;</span><br><span class="line">            <span class="keyword">if</span> (duration &gt;= req-&gt;duration) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_RTMP_DURATION_EXCEED, <span class="string">&quot;rtmp: time %d up %d&quot;</span>, <span class="built_in">srsu2msi</span>(duration), <span class="built_in">srsu2msi</span>(req-&gt;duration));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// apply the minimal interval for delivery stream in srs_utime_t.</span></span><br><span class="line">        <span class="keyword">if</span> (send_min_interval &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">srs_usleep</span>(send_min_interval);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="RTMP协议"><a href="#RTMP协议" class="headerlink" title="RTMP协议"></a>RTMP协议</h1><h2 id="推流端-1"><a href="#推流端-1" class="headerlink" title="推流端"></a>推流端</h2><img src="/2023/09/30/SRS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8BRTMP/rtmp协议报文.png" alt="rtmp协议报文" style="zoom:50%;">

<ul>
<li>上述RTMP拉流端协程回调中会处理与客户端的握手<code>rtmp-&gt;handshake</code>，<code>rtmp-&gt;connect_app</code>连接命令等。后续处理跟踪<code>service_cycle</code>。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">rs_error_t</span> <span class="title">SrsRtmpConn::do_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;RTMP client ip=%s, fd=%d&quot;</span>, ip.<span class="built_in">c_str</span>(), <span class="built_in">srs_netfd_fileno</span>(stfd));</span><br><span class="line">    </span><br><span class="line">    rtmp-&gt;<span class="built_in">set_recv_timeout</span>(SRS_CONSTS_RTMP_TIMEOUT);</span><br><span class="line">    rtmp-&gt;<span class="built_in">set_send_timeout</span>(SRS_CONSTS_RTMP_TIMEOUT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">handshake</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp handshake&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> rip = rtmp-&gt;<span class="built_in">proxy_real_ip</span>();</span><br><span class="line">    <span class="keyword">if</span> (rip &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">srs_trace</span>(<span class="string">&quot;RTMP proxy real client ip=%d.%d.%d.%d&quot;</span>,</span><br><span class="line">            <span class="built_in">uint8_t</span>(rip&gt;&gt;<span class="number">24</span>), <span class="built_in">uint8_t</span>(rip&gt;&gt;<span class="number">16</span>), <span class="built_in">uint8_t</span>(rip&gt;&gt;<span class="number">8</span>), <span class="built_in">uint8_t</span>(rip));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">connect_app</span>(req)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp connect tcUrl&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// set client ip to request.</span></span><br><span class="line">    req-&gt;ip = ip;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_trace</span>(<span class="string">&quot;connect app, tcUrl=%s, pageUrl=%s, swfUrl=%s, schema=%s, vhost=%s, port=%d, app=%s, args=%s&quot;</span>,</span><br><span class="line">        req-&gt;tcUrl.<span class="built_in">c_str</span>(), req-&gt;pageUrl.<span class="built_in">c_str</span>(), req-&gt;swfUrl.<span class="built_in">c_str</span>(),</span><br><span class="line">        req-&gt;schema.<span class="built_in">c_str</span>(), req-&gt;vhost.<span class="built_in">c_str</span>(), req-&gt;port,</span><br><span class="line">        req-&gt;app.<span class="built_in">c_str</span>(), (req-&gt;args? <span class="string">&quot;(obj)&quot;</span>:<span class="string">&quot;null&quot;</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// show client identity</span></span><br><span class="line">    <span class="keyword">if</span>(req-&gt;args) &#123;</span><br><span class="line">        std::string srs_version;</span><br><span class="line">        std::string srs_server_ip;</span><br><span class="line">        <span class="type">int</span> srs_pid = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> srs_id = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        SrsAmf0Any* prop = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> ((prop = req-&gt;args-&gt;<span class="built_in">ensure_property_string</span>(<span class="string">&quot;srs_version&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            srs_version = prop-&gt;<span class="built_in">to_str</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((prop = req-&gt;args-&gt;<span class="built_in">ensure_property_string</span>(<span class="string">&quot;srs_server_ip&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            srs_server_ip = prop-&gt;<span class="built_in">to_str</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((prop = req-&gt;args-&gt;<span class="built_in">ensure_property_number</span>(<span class="string">&quot;srs_pid&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            srs_pid = (<span class="type">int</span>)prop-&gt;<span class="built_in">to_number</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((prop = req-&gt;args-&gt;<span class="built_in">ensure_property_number</span>(<span class="string">&quot;srs_id&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            srs_id = (<span class="type">int</span>)prop-&gt;<span class="built_in">to_number</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (srs_pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">srs_trace</span>(<span class="string">&quot;edge-srs ip=%s, version=%s, pid=%d, id=%d&quot;</span>,</span><br><span class="line">                srs_server_ip.<span class="built_in">c_str</span>(), srs_version.<span class="built_in">c_str</span>(), srs_pid, srs_id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">service_cycle</span>()) != srs_success) &#123;</span><br><span class="line">        err = <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;service cycle&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">srs_error_t</span> r0 = srs_success;</span><br><span class="line">    <span class="keyword">if</span> ((r0 = <span class="built_in">on_disconnect</span>()) != srs_success) &#123;</span><br><span class="line">        err = <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;on disconnect %s&quot;</span>, <span class="built_in">srs_error_desc</span>(r0).<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="built_in">srs_freep</span>(r0);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// If client is redirect to other servers, we already logged the event.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">srs_error_code</span>(err) == ERROR_CONTROL_REDIRECT) &#123;</span><br><span class="line">        <span class="built_in">srs_error_reset</span>(err);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>connect消息处理。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpServer::connect_app</span><span class="params">(SrsRequest* req)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    SrsCommonMessage* msg = <span class="literal">NULL</span>;</span><br><span class="line">    SrsConnectAppPacket* pkt = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//期望收到connect命令消息</span></span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="built_in">expect_message</span>&lt;SrsConnectAppPacket&gt;(&amp;msg, &amp;pkt)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;expect connect app response&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsCommonMessage, msg);</span><br><span class="line">    <span class="built_in">SrsAutoFree</span>(SrsConnectAppPacket, pkt);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//从SrsConnectAppPacket读取对应的字段数据</span></span><br><span class="line">    SrsAmf0Any* prop = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((prop = pkt-&gt;command_object-&gt;<span class="built_in">ensure_property_string</span>(<span class="string">&quot;tcUrl&quot;</span>)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_RTMP_REQ_CONNECT, <span class="string">&quot;invalid request without tcUrl&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    req-&gt;tcUrl = prop-&gt;<span class="built_in">to_str</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((prop = pkt-&gt;command_object-&gt;<span class="built_in">ensure_property_string</span>(<span class="string">&quot;pageUrl&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        req-&gt;pageUrl = prop-&gt;<span class="built_in">to_str</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((prop = pkt-&gt;command_object-&gt;<span class="built_in">ensure_property_string</span>(<span class="string">&quot;swfUrl&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        req-&gt;swfUrl = prop-&gt;<span class="built_in">to_str</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((prop = pkt-&gt;command_object-&gt;<span class="built_in">ensure_property_number</span>(<span class="string">&quot;objectEncoding&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        req-&gt;objectEncoding = prop-&gt;<span class="built_in">to_number</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (pkt-&gt;args) &#123;</span><br><span class="line">        <span class="built_in">srs_freep</span>(req-&gt;args);</span><br><span class="line">        req-&gt;args = pkt-&gt;args-&gt;<span class="built_in">copy</span>()-&gt;<span class="built_in">to_object</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srs_discovery_tc_url</span>(req-&gt;tcUrl, req-&gt;schema, req-&gt;host, req-&gt;vhost, req-&gt;app, req-&gt;stream, req-&gt;port, req-&gt;param);</span><br><span class="line">    req-&gt;<span class="built_in">strip</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>解析消息，对于<code>recv_message</code>从TCP流式数据中获取chunk封装成<code>SrsCommonMessage</code>，对于<code>decode_message</code>将<code>SrsCommonMessage</code>封装成<code>SrsConnectAppPacket</code>对象数据。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">expect_message</span><span class="params">(SrsCommonMessage** pmsg, T** ppacket)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *pmsg = <span class="literal">NULL</span>;</span><br><span class="line">    *ppacket = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsCommonMessage* msg = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">recv_message</span>(&amp;msg)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv message&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        SrsPacket* packet = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">decode_message</span>(msg, &amp;packet)) != srs_success) &#123;</span><br><span class="line">            <span class="built_in">srs_freep</span>(msg);</span><br><span class="line">            <span class="built_in">srs_freep</span>(packet);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;decode message&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        T* pkt = <span class="built_in">dynamic_cast</span>&lt;T*&gt;(packet);</span><br><span class="line">        <span class="keyword">if</span> (!pkt) &#123;</span><br><span class="line">            <span class="built_in">srs_freep</span>(msg);</span><br><span class="line">            <span class="built_in">srs_freep</span>(packet);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        *pmsg = msg;</span><br><span class="line">        *ppacket = pkt;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>service_cycle</code>具体看下协议处理。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpConn::service_cycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//设置窗口大小</span></span><br><span class="line">    <span class="type">int</span> out_ack_size = _srs_config-&gt;<span class="built_in">get_out_ack_size</span>(req-&gt;vhost);</span><br><span class="line">    <span class="keyword">if</span> (out_ack_size &amp;&amp; (err = rtmp-&gt;<span class="built_in">set_window_ack_size</span>(out_ack_size)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: set out window ack size&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> in_ack_size = _srs_config-&gt;<span class="built_in">get_in_ack_size</span>(req-&gt;vhost);</span><br><span class="line">    <span class="keyword">if</span> (in_ack_size &amp;&amp; (err = rtmp-&gt;<span class="built_in">set_in_window_ack_size</span>(in_ack_size)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: set in window ack size&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//设置带宽</span></span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">set_peer_bandwidth</span>((<span class="type">int</span>)(<span class="number">2.5</span> * <span class="number">1000</span> * <span class="number">1000</span>), <span class="number">2</span>)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: set peer bandwidth&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// get the ip which client connected.</span></span><br><span class="line">    std::string local_ip = <span class="built_in">srs_get_local_ip</span>(<span class="built_in">srs_netfd_fileno</span>(stfd));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// do bandwidth test if connect to the vhost which is for bandwidth check.</span></span><br><span class="line">    <span class="keyword">if</span> (_srs_config-&gt;<span class="built_in">get_bw_check_enabled</span>(req-&gt;vhost)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = bandwidth-&gt;<span class="built_in">bandwidth_check</span>(rtmp, skt, req, local_ip)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: bandwidth check&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// set chunk size to larger.</span></span><br><span class="line">    <span class="comment">// set the chunk size before any larger response greater than 128,</span></span><br><span class="line">    <span class="comment">// to make OBS happy, @see https://github.com/ossrs/srs/issues/454</span></span><br><span class="line">    <span class="comment">//设置chunk size 一般60k</span></span><br><span class="line">    <span class="type">int</span> chunk_size = _srs_config-&gt;<span class="built_in">get_chunk_size</span>(req-&gt;vhost);</span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">set_chunk_size</span>(chunk_size)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: set chunk size %d&quot;</span>, chunk_size);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// response the client connect ok.</span></span><br><span class="line">    <span class="comment">//响应客户端</span></span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">response_connect_app</span>(req, local_ip.<span class="built_in">c_str</span>())) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: response connect app&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((err = rtmp-&gt;<span class="built_in">on_bw_done</span>()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: on bw down&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = trd-&gt;<span class="built_in">pull</span>()) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: thread quit&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        err = <span class="built_in">stream_service_cycle</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// stream service must terminated with error, never success.</span></span><br><span class="line">        <span class="comment">// when terminated with success, it&#x27;s user required to stop.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> Support RTMP client timeout, https://github.com/ossrs/srs/issues/1134</span></span><br><span class="line">        <span class="keyword">if</span> (err == srs_success) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// when not system control error, fatal error, return.</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">srs_is_system_control_error</span>(err)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: stream service&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// for republish, continue service</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">srs_error_code</span>(err) == ERROR_CONTROL_REPUBLISH) &#123;</span><br><span class="line">            <span class="comment">// set timeout to a larger value, wait for encoder to republish.</span></span><br><span class="line">            rtmp-&gt;<span class="built_in">set_send_timeout</span>(SRS_REPUBLISH_RECV_TIMEOUT);</span><br><span class="line">            rtmp-&gt;<span class="built_in">set_recv_timeout</span>(SRS_REPUBLISH_SEND_TIMEOUT);</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">srs_info</span>(<span class="string">&quot;rtmp: retry for republish&quot;</span>);</span><br><span class="line">            <span class="built_in">srs_freep</span>(err);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// for &quot;some&quot; system control error,</span></span><br><span class="line">        <span class="comment">// logical accept and retry stream service.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">srs_error_code</span>(err) == ERROR_CONTROL_RTMP_CLOSE) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> use ping message to anti-death of socket.</span></span><br><span class="line">            <span class="comment">// @see: https://github.com/ossrs/srs/issues/39</span></span><br><span class="line">            <span class="comment">// set timeout to a larger value, for user paused.</span></span><br><span class="line">            rtmp-&gt;<span class="built_in">set_recv_timeout</span>(SRS_PAUSED_RECV_TIMEOUT);</span><br><span class="line">            rtmp-&gt;<span class="built_in">set_send_timeout</span>(SRS_PAUSED_SEND_TIMEOUT);</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">srs_trace</span>(<span class="string">&quot;rtmp: retry for close&quot;</span>);</span><br><span class="line">            <span class="built_in">srs_freep</span>(err);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// for other system control message, fatal error.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;rtmp: reject&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>继续跟踪到<code>stream_service_cycle</code>中<code>rtmp-&gt;start_fmle_publish</code>，处理FCPublish、createStream、publish等消息。FCPublish命令是一个用于通知服务器要发布新流的RTMP命令，而Publish命令是用于告诉服务器要发布特定流的RTMP命令。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpServer::start_fmle_publish</span><span class="params">(<span class="type">int</span> stream_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// FCPublish</span></span><br><span class="line">    <span class="type">double</span> fc_publish_tid = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsCommonMessage* msg = <span class="literal">NULL</span>;</span><br><span class="line">        SrsFMLEStartPacket* pkt = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">expect_message</span>&lt;SrsFMLEStartPacket&gt;(&amp;msg, &amp;pkt)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv FCPublish&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(SrsCommonMessage, msg);</span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(SrsFMLEStartPacket, pkt);</span><br><span class="line">        </span><br><span class="line">        fc_publish_tid = pkt-&gt;transaction_id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// FCPublish response</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsFMLEStartResPacket* pkt = <span class="keyword">new</span> <span class="built_in">SrsFMLEStartResPacket</span>(fc_publish_tid);</span><br><span class="line">        <span class="keyword">if</span> ((err = protocol-&gt;<span class="built_in">send_and_free_packet</span>(pkt, <span class="number">0</span>)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send FCPublish response&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// createStream</span></span><br><span class="line">    <span class="type">double</span> create_stream_tid = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsCommonMessage* msg = <span class="literal">NULL</span>;</span><br><span class="line">        SrsCreateStreamPacket* pkt = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">expect_message</span>&lt;SrsCreateStreamPacket&gt;(&amp;msg, &amp;pkt)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv createStream&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(SrsCommonMessage, msg);</span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(SrsCreateStreamPacket, pkt);</span><br><span class="line">        </span><br><span class="line">        create_stream_tid = pkt-&gt;transaction_id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// createStream response</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsCreateStreamResPacket* pkt = <span class="keyword">new</span> <span class="built_in">SrsCreateStreamResPacket</span>(create_stream_tid, stream_id);</span><br><span class="line">        <span class="keyword">if</span> ((err = protocol-&gt;<span class="built_in">send_and_free_packet</span>(pkt, <span class="number">0</span>)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send createStream response&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// publish</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsCommonMessage* msg = <span class="literal">NULL</span>;</span><br><span class="line">        SrsPublishPacket* pkt = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = <span class="built_in">expect_message</span>&lt;SrsPublishPacket&gt;(&amp;msg, &amp;pkt)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;recv publish&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(SrsCommonMessage, msg);</span><br><span class="line">        <span class="built_in">SrsAutoFree</span>(SrsPublishPacket, pkt);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// publish response onFCPublish(NetStream.Publish.Start)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsOnStatusCallPacket* pkt = <span class="keyword">new</span> <span class="built_in">SrsOnStatusCallPacket</span>();</span><br><span class="line">        </span><br><span class="line">        pkt-&gt;command_name = RTMP_AMF0_COMMAND_ON_FC_PUBLISH;</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusCode, SrsAmf0Any::<span class="built_in">str</span>(StatusCodePublishStart));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusDescription, SrsAmf0Any::<span class="built_in">str</span>(<span class="string">&quot;Started publishing stream.&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = protocol-&gt;<span class="built_in">send_and_free_packet</span>(pkt, stream_id)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send NetStream.Publish.Start&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// publish response onStatus(NetStream.Publish.Start)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsOnStatusCallPacket* pkt = <span class="keyword">new</span> <span class="built_in">SrsOnStatusCallPacket</span>();</span><br><span class="line">        </span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusLevel, SrsAmf0Any::<span class="built_in">str</span>(StatusLevelStatus));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusCode, SrsAmf0Any::<span class="built_in">str</span>(StatusCodePublishStart));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusDescription, SrsAmf0Any::<span class="built_in">str</span>(<span class="string">&quot;Started publishing stream.&quot;</span>));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusClientId, SrsAmf0Any::<span class="built_in">str</span>(RTMP_SIG_CLIENT_ID));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = protocol-&gt;<span class="built_in">send_and_free_packet</span>(pkt, stream_id)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send NetStream.Publish.Start&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="拉流端-1"><a href="#拉流端-1" class="headerlink" title="拉流端"></a>拉流端</h2><ul>
<li>拉流端大部分和推流一样，拉流进入<code>rsRtmpServer::start_play</code>分支。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">srs_error_t</span> <span class="title">SrsRtmpServer::start_play</span><span class="params">(<span class="type">int</span> stream_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">srs_error_t</span> err = srs_success;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// StreamBegin</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsUserControlPacket* pkt = <span class="keyword">new</span> <span class="built_in">SrsUserControlPacket</span>();</span><br><span class="line">        pkt-&gt;event_type = SrcPCUCStreamBegin;</span><br><span class="line">        pkt-&gt;event_data = stream_id;</span><br><span class="line">        <span class="keyword">if</span> ((err = protocol-&gt;<span class="built_in">send_and_free_packet</span>(pkt, <span class="number">0</span>)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send StreamBegin&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// onStatus(NetStream.Play.Reset)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsOnStatusCallPacket* pkt = <span class="keyword">new</span> <span class="built_in">SrsOnStatusCallPacket</span>();</span><br><span class="line">        </span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusLevel, SrsAmf0Any::<span class="built_in">str</span>(StatusLevelStatus));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusCode, SrsAmf0Any::<span class="built_in">str</span>(StatusCodeStreamReset));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusDescription, SrsAmf0Any::<span class="built_in">str</span>(<span class="string">&quot;Playing and resetting stream.&quot;</span>));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusDetails, SrsAmf0Any::<span class="built_in">str</span>(<span class="string">&quot;stream&quot;</span>));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusClientId, SrsAmf0Any::<span class="built_in">str</span>(RTMP_SIG_CLIENT_ID));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = protocol-&gt;<span class="built_in">send_and_free_packet</span>(pkt, stream_id)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send NetStream.Play.Reset&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// onStatus(NetStream.Play.Start)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsOnStatusCallPacket* pkt = <span class="keyword">new</span> <span class="built_in">SrsOnStatusCallPacket</span>();</span><br><span class="line">        </span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusLevel, SrsAmf0Any::<span class="built_in">str</span>(StatusLevelStatus));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusCode, SrsAmf0Any::<span class="built_in">str</span>(StatusCodeStreamStart));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusDescription, SrsAmf0Any::<span class="built_in">str</span>(<span class="string">&quot;Started playing stream.&quot;</span>));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusDetails, SrsAmf0Any::<span class="built_in">str</span>(<span class="string">&quot;stream&quot;</span>));</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusClientId, SrsAmf0Any::<span class="built_in">str</span>(RTMP_SIG_CLIENT_ID));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = protocol-&gt;<span class="built_in">send_and_free_packet</span>(pkt, stream_id)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send NetStream.Play.Start&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// |RtmpSampleAccess(false, false)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsSampleAccessPacket* pkt = <span class="keyword">new</span> <span class="built_in">SrsSampleAccessPacket</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// allow audio/video sample.</span></span><br><span class="line">        <span class="comment">// @see: https://github.com/ossrs/srs/issues/49</span></span><br><span class="line">        pkt-&gt;audio_sample_access = <span class="literal">true</span>;</span><br><span class="line">        pkt-&gt;video_sample_access = <span class="literal">true</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((err = protocol-&gt;<span class="built_in">send_and_free_packet</span>(pkt, stream_id)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send |RtmpSampleAccess true&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// onStatus(NetStream.Data.Start)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        SrsOnStatusDataPacket* pkt = <span class="keyword">new</span> <span class="built_in">SrsOnStatusDataPacket</span>();</span><br><span class="line">        pkt-&gt;data-&gt;<span class="built_in">set</span>(StatusCode, SrsAmf0Any::<span class="built_in">str</span>(StatusCodeDataStart));</span><br><span class="line">        <span class="keyword">if</span> ((err = protocol-&gt;<span class="built_in">send_and_free_packet</span>(pkt, stream_id)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">srs_error_wrap</span>(err, <span class="string">&quot;send NetStream.Data.Start&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2023/09/29/nginx%E6%90%AD%E5%BB%BAHLS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/09/29/nginx%E6%90%AD%E5%BB%BAHLS/" class="post-title-link" itemprop="url">nginx搭建HLS</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-29 20:44:22" itemprop="dateCreated datePublished" datetime="2023-09-29T20:44:22+08:00">2023-09-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-12-31 12:57:27" itemprop="dateModified" datetime="2023-12-31T12:57:27+08:00">2023-12-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nginx-http-flv-module</span></span><br><span class="line">git clone https://github.com/winshining/nginx-http-flv-module.git</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nginx</span></span><br><span class="line">wget http://nginx.org/download/nginx-1.24.0.tar.gz</span><br><span class="line">tar xvzf nginx-1.24.0.tar.gz</span><br><span class="line">cd nginx-1.24.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编译nginx</span></span><br><span class="line">./configure --prefix=/usr/local/rtmp-nginx --add-module=`pwd`/nginx-http-flv-module</span><br><span class="line">make install -j4</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动</span></span><br><span class="line">cd /usr/local/rtmp-nginx/nginx</span><br><span class="line">sudo ./sbin/nginx -c conf/nginx.conf</span><br></pre></td></tr></table></figure>

<h1 id="配置⽂件"><a href="#配置⽂件" class="headerlink" title="配置⽂件"></a>配置⽂件</h1><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">daemon</span> <span class="literal">off</span>;</span><br><span class="line"><span class="comment"># 如果开启off对应的ts⽂件不并删除</span></span><br><span class="line"><span class="comment"># master_process off;</span></span><br><span class="line"><span class="comment"># user root;</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">error_log</span> /tmp/<span class="literal">error</span>.log <span class="literal">debug</span>;</span><br><span class="line">events&#123;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rtmp&#123;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">1935</span>;</span><br><span class="line">        <span class="attribute">chunk_size</span> <span class="number">4000</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#live</span></span><br><span class="line">        <span class="attribute">application</span> live &#123;</span><br><span class="line">            <span class="attribute">live</span> <span class="literal">on</span>;</span><br><span class="line">    </span><br><span class="line">    		<span class="comment"># live和上面application live对应</span></span><br><span class="line">            <span class="attribute">exec</span> /usr/local/bin/ffmpeg -i rtmp://localhost/live/<span class="variable">$name</span></span><br><span class="line">    </span><br><span class="line">    		<span class="comment"># hls和下面application hls对应</span></span><br><span class="line">            <span class="comment"># 这里测试多码率虽然/tmp/hls下有生成对应文件，ffplay播放不知道为什么没效果？</span></span><br><span class="line">            -c:a copy -c:v copy -b:v <span class="number">300K</span> -g <span class="number">30</span> -f flv rtmp://localhost/hls/<span class="variable">$name_hi</span></span><br><span class="line">            -c:a copy -c:v copy -b:v <span class="number">200K</span> -g <span class="number">30</span> -s 462x254 -f flv rtmp://localhost/hls/<span class="variable">$name_mid</span></span><br><span class="line">            -c:a copy -c:v copy -b:v <span class="number">100K</span> -g <span class="number">30</span> -s 230x128 -f flv rtmp://localhost/hls/<span class="variable">$name_low</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="attribute">application</span> hls &#123;</span><br><span class="line">            <span class="attribute">live</span> <span class="literal">on</span>;</span><br><span class="line">            <span class="attribute">hls</span> <span class="literal">on</span>;                  <span class="comment"># 实时回访</span></span><br><span class="line">            <span class="attribute">hls_path</span> /tmp/hls;       <span class="comment"># m3u8,ts文件保存路径</span></span><br><span class="line">            <span class="attribute">hls_nested</span> <span class="literal">on</span>;           <span class="comment"># 每个流都⾃动创建⼀个⽂件夹</span></span><br><span class="line">            <span class="attribute">hls_fragment</span> <span class="number">2s</span>;         <span class="comment"># 每个ts⽂件为时长</span></span><br><span class="line">            <span class="attribute">hls_playlist_length</span> <span class="number">6s</span>;  <span class="comment"># 保存m3u8列表⻓度时间</span></span><br><span class="line">    </span><br><span class="line">            <span class="attribute">hls_variant</span> _hi BANDWIDTH=<span class="number">350000</span>;</span><br><span class="line">            <span class="attribute">hls_variant</span> _mid BANDWIDTH=<span class="number">250000</span>;</span><br><span class="line">            <span class="attribute">hls_variant</span> _low BANDWIDTH=<span class="number">150000</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http&#123;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">8081</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#welcome</span></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">root</span> html;</span><br><span class="line">            <span class="attribute">index</span> index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">#hls</span></span><br><span class="line">        <span class="section">location</span> /hls &#123;</span><br><span class="line">            <span class="section">types</span> &#123;</span><br><span class="line">                application/vnd.apple.<span class="attribute">mpegusr</span> m3u8;</span><br><span class="line">                video/<span class="attribute">mp2t</span> ts;</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">#root /tmp;</span></span><br><span class="line">            <span class="attribute">alias</span> /tmp/hls;</span><br><span class="line">            <span class="attribute">add_header</span> Cache-Control <span class="literal">no</span>-cache;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># /tmp/hls/livestream.m3u8</span><br><span class="line"></span><br><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-VERSION:3</span><br><span class="line">#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=350000</span><br><span class="line">livestream_hi/index.m3u8</span><br><span class="line">#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=250000</span><br><span class="line">livestream_mid/index.m3u8</span><br><span class="line">#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=150000</span><br><span class="line">livestream_low/index.m3u8</span><br><span class="line"></span><br><span class="line"># /tmp/hls/livestream_low/index.m3u8</span><br><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-VERSION:3</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:41</span><br><span class="line">#EXT-X-TARGETDURATION:4</span><br><span class="line">#EXTINF:4.400,</span><br><span class="line">41.ts</span><br><span class="line">#EXTINF:2.160,</span><br><span class="line">42.ts</span><br><span class="line">#EXTINF:2.480,</span><br><span class="line">43.t</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">推流</span></span><br><span class="line">ffmpeg -re -i test.flv -vcodec copy -acodec copy -f flv -y rtmp://127.0.0.1/live/livestream </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉流</span></span><br><span class="line">RTMP流地址为：rtmp://127.0.0.1/live/livestream </span><br><span class="line">HLS流地址为：http://127.0.0.1:8081/hls/livestream.m3u8</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定码率</span></span><br><span class="line">http://127.0.0.1:8081/hls/livestream_hi/index.m3u8</span><br><span class="line">http://127.0.0.1:8081/hls/livestream_mid/index.m3u8</span><br><span class="line">http://127.0.0.1:8081/hls/livestream_low/index.m3u8</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Fang</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"neutral","dark":"neutral"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.3.0/mermaid.min.js","integrity":"sha256-9y71g5Lz/KLsHjB8uXwnkuWDtAMDSzD/HdIbqhJfTAI="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





</body>
</html>
