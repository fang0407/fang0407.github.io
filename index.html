<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CPT+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"fang0407.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="NOTE">
<meta property="og:url" content="https://fang0407.github.io/index.html">
<meta property="og:site_name" content="NOTE">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Fang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://fang0407.github.io/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>NOTE</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">NOTE</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Fang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">92</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2025/08/17/GDB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/17/GDB/" class="post-title-link" itemprop="url">GDB</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-08-17 09:20:17 / Modified: 18:35:52" itemprop="dateCreated datePublished" datetime="2025-08-17T09:20:17+08:00">2025-08-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/GDB/" itemprop="url" rel="index"><span itemprop="name">GDB</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">gdb -q a.out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">list/l 列出源代码的一部分</span><br><span class="line">list + 向上列出源代码的一部分</span><br><span class="line">list - 向下列出源代码的一部分</span><br><span class="line">set listsize 30  设置列出源代码的行数</span><br><span class="line">show listsize  查看列出源代码的行数</span><br><span class="line"></span><br><span class="line">run/r 运行程序</span><br><span class="line"></span><br><span class="line">break/b 添加断点</span><br><span class="line">break main 添加断点到main函数</span><br><span class="line">break 10 添加断点到第10行</span><br><span class="line">info breakpoints/i b 查看断点</span><br><span class="line">watch 监视一个变量的值何时被写</span><br><span class="line">info watchpoints 查看监视的变量</span><br><span class="line"></span><br><span class="line">continue/c 继续执行，直到断点或者程序结束</span><br><span class="line">next/n 单步执行（在停止之后）；跳过函数调用</span><br><span class="line">step/s 单步执行（在停止之后）；进入函数调用</span><br><span class="line"></span><br><span class="line">finish 继续执行，知道当前函数返回</span><br><span class="line">return 强制从当前函数返回</span><br><span class="line">quit 退出gdb</span><br><span class="line"></span><br><span class="line">shell/! 使用linux命令</span><br></pre></td></tr></table></figure>

<h1 id="断点"><a href="#断点" class="headerlink" title="断点"></a>断点</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">break &lt;行号&gt;</span><br><span class="line">break &lt;文件名&gt;:&lt;行号&gt;</span><br><span class="line"></span><br><span class="line">break &lt;函数名&gt;</span><br><span class="line">break &lt;类名&gt;::&lt;函数名&gt;</span><br><span class="line">break &lt;文件名&gt;:&lt;函数名&gt;</span><br><span class="line">break &lt;文件名&gt;:&lt;类名&gt;::&lt;函数名&gt;</span><br><span class="line"></span><br><span class="line">break &lt;位置&gt; if &lt;条件表达式&gt;</span><br><span class="line"></span><br><span class="line">break *&lt;内存地址&gt;</span><br><span class="line"></span><br><span class="line">rb &lt;模糊函数名&gt; 模糊断点</span><br><span class="line"></span><br><span class="line">tbreak/tb &lt;位置&gt; 临时断点，语法和break相同</span><br><span class="line"></span><br><span class="line">delete &lt;断点编号&gt; 删除指定断点</span><br><span class="line"></span><br><span class="line">enable &lt;断点编号&gt; 启用断点</span><br><span class="line">enable once &lt;断点编号&gt; 启动一次后自动禁用</span><br><span class="line">disable &lt;断点编号&gt; 禁用断点</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="入参设置"><a href="#入参设置" class="headerlink" title="入参设置"></a>入参设置</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gdb --args ./可执行程序 arg1 arg2 &quot;arg with space&quot; 参数包含空格使用&quot;&quot;</span><br><span class="line">run arg1 arg2 &quot;arg with space&quot;</span><br><span class="line">set args arg1 arg2 &quot;arg with space&quot;</span><br><span class="line"></span><br><span class="line">show args</span><br></pre></td></tr></table></figure>

<h1 id="汇编单步执行"><a href="#汇编单步执行" class="headerlink" title="汇编单步执行"></a>汇编单步执行</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nexti/ni 执行下一条汇编指令；跳过函数</span><br><span class="line">stepi 执行下一条汇编指令；进入函数</span><br></pre></td></tr></table></figure>

<h1 id="观察点"><a href="#观察点" class="headerlink" title="观察点"></a>观察点</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">watch 监视一个变量的值何时被写</span><br><span class="line">rwatch 监视一个变量的值何时被读</span><br><span class="line">awatch 监视一个变量的值何时被读或者写</span><br></pre></td></tr></table></figure>

<h1 id="堆栈信息"><a href="#堆栈信息" class="headerlink" title="堆栈信息"></a>堆栈信息</h1><p>栈帧是函数调用时在内存栈区分配的一块连续内存，用于存储函数执行期间的上下文信息（如局部变量、参数、返回地址等）。</p>
<p>每个函数调用对应一个独立的栈帧。</p>
<p>x86 的函数参数，使用寄存器 rdi、rsi、rdx、rcx、r8、r9 存储前六个参数，超过的存储在栈中，入栈顺序从右到左入栈。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">backtrace/bt 查看程序堆栈信息</span><br><span class="line">bt full 显示函数参数和局部变量值</span><br><span class="line">bt 3 只显示最近三层调用</span><br><span class="line"></span><br><span class="line">info frame 查看当前栈帧信息</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">(gdb) i frame</span><br><span class="line">Stack level 0, frame at 0x7fffffffe350:</span><br><span class="line"> rip = 0x40050a in Test2 (test.c:4); saved rip = 0x40052a</span><br><span class="line"> called by frame at 0x7fffffffe360</span><br><span class="line"> source language c.</span><br><span class="line"> Arglist at 0x7fffffffe340, args:</span><br><span class="line"> Locals at 0x7fffffffe340, Previous frame&#x27;s sp is 0x7fffffffe350</span><br><span class="line"> Saved registers:</span><br><span class="line">  rbp at 0x7fffffffe340, rip at 0x7fffffffe348</span><br><span class="line">  </span><br><span class="line">rip 指令指针寄存器，代表当前代码的执行位置</span><br><span class="line">saved rip 当前栈帧调用位置的下一行代码的位置</span><br><span class="line"></span><br><span class="line">验证是否正确</span><br><span class="line">(gdb) info line 4</span><br><span class="line">Line 4 of &quot;test.c&quot; starts at address 0x40050a &lt;Test2+4&gt; and ends at 0x400519 &lt;Test2+19&gt;.</span><br><span class="line">看到地址起始地址 0x40050a</span><br><span class="line">(gdb) info line 12</span><br><span class="line">Line 12 of &quot;test.c&quot; starts at address 0x40052a &lt;Test1+14&gt; and ends at 0x40052b &lt;Test1+15&gt;.</span><br><span class="line">看到调用函数的下一行起始地址 0x40052a</span><br></pre></td></tr></table></figure>

<h1 id="打印"><a href="#打印" class="headerlink" title="打印"></a>打印</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">print x 以十进制打印变量x的值</span><br><span class="line">print /x ptr 以十六进制打印指针ptr的值</span><br><span class="line">print /s str 以字符串形式打印字符数组str的值</span><br><span class="line"></span><br><span class="line">print namespace:var 打印命名空间中的变量</span><br><span class="line"></span><br><span class="line">print 2 * x  计算表达式</span><br><span class="line">print func(a,b) 调用函数</span><br><span class="line">print MyClass::staticMethod() 调用静态方法</span><br><span class="line"></span><br><span class="line">print *(int*)0x12345678 打印指定地址的int值</span><br><span class="line">print (char*)0x400000 将地址视为字符串打印</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2024/11/10/CV-CUDA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/11/10/CV-CUDA/" class="post-title-link" itemprop="url">CV-CUDA</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-11-10 07:43:04" itemprop="dateCreated datePublished" datetime="2024-11-10T07:43:04+08:00">2024-11-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-11-30 06:16:32" itemprop="dateModified" datetime="2024-11-30T06:16:32+08:00">2024-11-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CUDA/" itemprop="url" rel="index"><span itemprop="name">CUDA</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="CV-CUDA编译"><a href="#CV-CUDA编译" class="headerlink" title="CV-CUDA编译"></a>CV-CUDA编译</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 编译运行环境：docker ubuntu:20.04、gcc 11、nvidia 3090</span><br><span class="line"># 安装docker以及nvidia-docker，</span><br><span class="line"></span><br><span class="line">nvidia-docker run -it -e NVIDIA_VISIBLE_DEVICES=all -e NVIDIA_DRIVER_CAPABILITIES=compute,utility 镜像ID bash</span><br><span class="line"></span><br><span class="line">git clone https://github.com/CVCUDA/CV-CUDA.git</span><br><span class="line"></span><br><span class="line">cd CV-CUDA/samples/common/build</span><br><span class="line">cmake ../</span><br><span class="line">make -j</span><br><span class="line"></span><br><span class="line">cd CV-CUDA/samples/classification/build</span><br><span class="line">cmake ../</span><br><span class="line">make -j</span><br><span class="line">./cvcuda_sample_classification -e model/image.engine -i model/plate.jpg -l model/lable.txt -b 1</span><br><span class="line"></span><br><span class="line"># 序列化TRT模型</span><br><span class="line">cd TensorRT-8.6.1.6/bin</span><br><span class="line">export LD_LIBRARY_PATH=/usr/local/cuda-12.2/lib64:/cudnn-linux-x86_64-8.9.6.50_cuda12-archive/lib:TensorRt-8.6.1.6/lib:$LD_LIBRARY_PATH</span><br><span class="line"></span><br><span class="line">./trtexec --onnx=image.onnx --minShapes=input:1x3x224x224 --optShapes=input:1x3x224x224 --maxShapes=input:1x3x224x224 --saveEngine=./image.engine</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2024/10/01/%E7%BC%96%E8%AF%91%E7%BA%AA%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/01/%E7%BC%96%E8%AF%91%E7%BA%AA%E5%BD%95/" class="post-title-link" itemprop="url">编译纪录</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-10-01 12:05:58" itemprop="dateCreated datePublished" datetime="2024-10-01T12:05:58+08:00">2024-10-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-11-30 06:27:50" itemprop="dateModified" datetime="2024-11-30T06:27:50+08:00">2024-11-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%85%B6%E4%BB%96/" itemprop="url" rel="index"><span itemprop="name">其他</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="x264"><a href="#x264" class="headerlink" title="x264"></a>x264</h1><p><strong>通用流程，也可以编译其它的库</strong></p>
<ul>
<li>msys2 是一种在 windows 平台模拟 Linux 运行环境的技术，你可以在该环境运行 Linux 命令来编译 windows 平台的库</li>
<li>下载 msys2，下载地址: <a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/msys2/distrib/x86_64/%EF%BC%8C%E4%BE%8B%E5%A6%82">https://mirrors.tuna.tsinghua.edu.cn/msys2/distrib/x86_64/，例如</a> msys2-x86_64-20240113.exe</li>
<li>下载完毕之后，正常安装即可，打开 mingw64.exe</li>
<li>同步软件包数据，<code>pacman -Sy</code><ul>
<li>如果同步软件包数据比较慢，可使用清华的镜像，具体配置方法可参考:</li>
<li><a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/help/msys2/">https://mirrors.tuna.tsinghua.edu.cn/help/msys2/</a></li>
</ul>
</li>
<li>安装 MinGW-x64 和 MinGW-x86 工具链<ul>
<li><code>pacman -S mingw-w64-i686-toolchain</code></li>
<li><code>pacman -S mingw-w64-x86_64-toolchain</code></li>
<li>也可以单独安装 MinGW，然后拷贝到 msys2 下的 mingw64 和 mingw32 目录</li>
</ul>
</li>
<li>安装必备的工具<ul>
<li><code>pacman -S nasm</code> # 汇编工具</li>
<li><code>pacman -S yasm</code> # 汇编工具</li>
<li><code>pacman -S make</code></li>
<li><code>pacman -S cmake</code></li>
<li><code>pacman -S diffutils</code> # 比较工具，ffmpeg configure 生成 makefile 时用到</li>
<li><code>pacman -S pkg-config</code> # 库配置工具，方便引用依赖库</li>
</ul>
</li>
<li>打开 <code>C:\msys64\msys2_shell.cmd</code>，按照下图进行编辑 （可以保证继承父窗口的环境变量）<ul>
<li>启动 x64 Native Tools Command Prompt for VS2019</li>
<li>进入 msys2 安装目录，执行 <code>msys2_shell.cmd -mingw64</code></li>
<li>测试输入 <code>cl</code> 命令，是否继承了 MSVC 的编译环境</li>
</ul>
</li>
</ul>
<img src="/2024/10/01/%E7%BC%96%E8%AF%91%E7%BA%AA%E5%BD%95/msys2继承.png" alt="msys2继承" style="zoom:50%;">

<p><strong>编译x264库</strong></p>
<ul>
<li>获取源代码，通过命令获取：<code>git clone https://code.videolan.org/videolan/x264.git</code></li>
<li>编译 Debug 版本：<code>CC=cl ./configure --prefix=/d/third_party/x264_lib --enable-shared --enable-static --enable-debug &amp;&amp; make &amp;&amp; make install</code></li>
<li>编译 Release 版本：<code>CC=cl ./configure --prefix=/d/third_party/x264_lib --enable-shared --enable-static &amp;&amp; make &amp;&amp; make install</code></li>
</ul>
<h1 id="protobuf"><a href="#protobuf" class="headerlink" title="protobuf"></a>protobuf</h1><ul>
<li><p>编译运行环境：Win10</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/protocolbuffers/protobuf/releases/download/v3.8.0/protobuf-cpp-3.8.0.zip">protobuf 3.8.0</a> 版本下载并解压</p>
</li>
<li><p>安装 vs2019，打开 x64 Native Tools Command Prompt for VS 2019</p>
<ul>
<li><p><code>cd protobuf/cmake &amp;&amp; mkdir build</code></p>
</li>
<li><p><code>cmake ../</code> （默认使用 Visual Studio 16 2019 生成工程文件）</p>
</li>
<li><p>在 build目录下生成 protobuf.sln，使用 vs2019 打开，生成解决方案</p>
</li>
<li><p>如果是 Debug 版本在 build 目录下的 Debug 目录生成相应库文件</p>
</li>
<li><p>在工程项目右击属性—&gt;配置属性—&gt;C&#x2F;C++—&gt;代码生成—&gt;运行库中选择 MT&#x2F;MTd&#x2F;MD&#x2F;MDd</p>
</li>
</ul>
</li>
</ul>
<h1 id="jsoncpp"><a href="#jsoncpp" class="headerlink" title="jsoncpp"></a>jsoncpp</h1><ul>
<li><p>编译运行环境：Win10</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/open-source-parsers/jsoncpp/archive/refs/tags/1.9.5.zip">jsoncpp 1.9.5</a> 版本下载并解压</p>
</li>
<li><p>安装 vs2019，打开 x64 Native Tools Command Prompt for VS 2019</p>
<ul>
<li><p><code>cd jsoncpp-1.9.5 &amp;&amp; mkdir build</code></p>
</li>
<li><p><code>cmake ../</code> （默认使用 Visual Studio 16 2019 生成工程文件）</p>
</li>
<li><p>在 build目录下生成 jsoncpp.sln，使用 vs2019 打开，生成解决方案</p>
</li>
<li><p>在 build 目录下的 lib 目录生成相应库文件</p>
</li>
</ul>
</li>
</ul>
<h1 id="CV-CUDA"><a href="#CV-CUDA" class="headerlink" title="CV-CUDA"></a>CV-CUDA</h1><ul>
<li>编译运行环境：ubuntu:20.04、gcc 11、nvidia 3090</li>
<li>安装 docker 以及 nvidia-docker</li>
<li>CUDA 下载：<a target="_blank" rel="noopener" href="https://developer.nvidia.com/cuda-downloads%EF%BC%8C%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5%EF%BC%9Ahttps://blog.csdn.net/jhsignal/article/details/111401628">https://developer.nvidia.com/cuda-downloads，参考链接：https://blog.csdn.net/jhsignal/article/details/111401628</a></li>
<li>cuDNN 下载：<a target="_blank" rel="noopener" href="https://developer.nvidia.com/rdp/cudnn-download">https://developer.nvidia.com/rdp/cudnn-download</a></li>
<li>TensorRT 下载：<a target="_blank" rel="noopener" href="https://developer.nvidia.com/tensorrt">https://developer.nvidia.com/tensorrt</a></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 进入容器</span><br><span class="line">nvidia-docker run -it -e NVIDIA_VISIBLE_DEVICES=all -e NVIDIA_DRIVER_CAPABILITIES=compute,utility 镜像ID bash</span><br><span class="line"></span><br><span class="line"># 获取及编译CV-CUDA</span><br><span class="line">git clone https://github.com/CVCUDA/CV-CUDA.git</span><br><span class="line"></span><br><span class="line">cd CV-CUDA/samples/common/build</span><br><span class="line">cmake ../</span><br><span class="line">make -j</span><br><span class="line"></span><br><span class="line">cd CV-CUDA/samples/classification/build</span><br><span class="line">cmake ../</span><br><span class="line">make -j</span><br><span class="line">./cvcuda_sample_classification -e model/image.engine -i model/plate.jpg -l model/lable.txt -b 1</span><br><span class="line"></span><br><span class="line"># 序列化TRT模型</span><br><span class="line">cd TensorRT-8.6.1.6/bin</span><br><span class="line">export LD_LIBRARY_PATH=/usr/local/cuda-12.2/lib64:/cudnn-linux-x86_64-8.9.6.50_cuda12-archive/lib:TensorRt-8.6.1.6/lib:$LD_LIBRARY_PATH</span><br><span class="line">./trtexec --onnx=image.onnx --minShapes=input:1x3x224x224 --optShapes=input:1x3x224x224 --maxShapes=input:1x3x224x224 --saveEngine=./image.engine</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2024/09/21/Gstreamer%E6%8F%92%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/21/Gstreamer%E6%8F%92%E4%BB%B6/" class="post-title-link" itemprop="url">Gstreamer插件</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-09-21 09:10:16 / Modified: 09:12:09" itemprop="dateCreated datePublished" datetime="2024-09-21T09:10:16+08:00">2024-09-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Gstreamer/" itemprop="url" rel="index"><span itemprop="name">Gstreamer</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Gstreamer编译"><a href="#Gstreamer编译" class="headerlink" title="Gstreamer编译"></a>Gstreamer编译</h1><p>环境：ubuntu16.04，gcc version 5.4.0 20160609</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"># 编译Python3.8</span><br><span class="line">wget --no-check-certificate https://www.python.org/ftp/python/3.8.17/Python-3.8.17.tgz</span><br><span class="line">tar xzvf Python-3.8.17.tgz</span><br><span class="line">cd Python-3.8.17</span><br><span class="line">./configure --enable-optimizations</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line">wget --no-check-certificate  https://www.openssl.org/source/old/1.1.1/openssl-1.1.1w.tar.gz</span><br><span class="line">tar xzvf openssl-1.1.1w.tar.gz</span><br><span class="line">cd openssl-1.1.1w</span><br><span class="line">./config </span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line">wget --no-check-certificate https://ftp.openbsd.org/pub/OpenBSD/LibreSSL/libressl-2.7.4.tar.gz</span><br><span class="line">tar xzvf  libressl-2.7.4.tar.gz</span><br><span class="line">cd libressl-2.7.4</span><br><span class="line">./config --prefix=/usr/local</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line">回到 Python3.8 目录，编辑安装文件 Modules/Setup</span><br><span class="line">删除有关 ssl 编译代码的注释，共 4 行</span><br><span class="line">SSL=/usr/local/ssl</span><br><span class="line">_ssl _ssl.c \</span><br><span class="line">        -DUSE_SSL -I$(SSL)/include -I$(SSL)/include/openssl \</span><br><span class="line">        -L$(SSL)/lib -lssl -lcrypto</span><br><span class="line"></span><br><span class="line"># meson</span><br><span class="line">pip3 install --user meson</span><br><span class="line">ln -s ~/.local/bin/meson  /usr/bin/meson</span><br><span class="line"></span><br><span class="line"># ninja</span><br><span class="line">wget --no-check-certificate  https://github.com/ninja-build/ninja/releases/download/v1.12.1/ninja-linux.zip</span><br><span class="line">mv ninja /usr/bin</span><br><span class="line"></span><br><span class="line"># gstreamer</span><br><span class="line">wget --no-check-certificate  https://github.com/GStreamer/gstreamer/archive/refs/tags/1.24.0.tar.gz</span><br><span class="line">cd gstreamer-1.24.0</span><br><span class="line">mkdir build</span><br><span class="line">meson setup</span><br><span class="line">meson configure</span><br><span class="line">meson --reconfigure --prefix=`pwd`/gst_install -Dgst_plugins-base:opus=disabled -Dbad=disabled</span><br><span class="line">meson compile</span><br><span class="line">meson install</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">参考链接</span><br><span class="line">https://github.com/GStreamer/gstreamer?tab=readme-ov-file</span><br><span class="line">https://blog.csdn.net/Aidam_Bo/article/details/112919330</span><br><span class="line">https://tsaiyuyan.github.io/2020/05/11/gstreamer-bian-yi-bi-ji/</span><br></pre></td></tr></table></figure>

<h1 id="插件模板"><a href="#插件模板" class="headerlink" title="插件模板"></a>插件模板</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://gitlab.freedesktop.org/gstreamer/gst-template.git</span><br><span class="line">cd gst-template/gst-plugin/src</span><br><span class="line">../tools/make_element plugin</span><br></pre></td></tr></table></figure>

<ul>
<li>编译生成的插件库添加到 <code>GST_PLUGIN_PATH</code> 环境变量</li>
</ul>
<h1 id="插件接口"><a href="#插件接口" class="headerlink" title="插件接口"></a>插件接口</h1><h2 id="plugin-init"><a href="#plugin-init" class="headerlink" title="plugin_init"></a>plugin_init</h2><ul>
<li><code>plugin_init</code>：初始化插件并注册插件中的元素</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> gboolean <span class="title">plugin_init</span> <span class="params">(GstPlugin *plugin)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">GST_ELEMENT_REGISTER</span> (plugin_template, plugin);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>GST_ELEMENT_REGISTER (plugin_template, plugin)</code></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> GST_ELEMENT_REGISTER (plugin_template, plugin) gst_element_register_plugin_template (plugin)</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>GST_ELEMENT_REGISTER_DEFINE (plugin_template, &quot;plugin_template&quot;, GST_RANK_NONE, GST_TYPE_PLUGIN_TEMPLATE)</code></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">gboolen <span class="title">gst_element_register_plugin_template</span> <span class="params">(GSTPlugin* plugin)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">gst_element_register</span>(plugin, <span class="string">&quot;plugin_template&quot;</span>, GST_RANK_NONE, GST_TYPE_PLUGIN_TEMPLATE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>函数原型：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">gboolean <span class="title">gst_element_register</span> <span class="params">(GstPlugin *plugin, <span class="type">const</span> gchar *name, GstRank rank, GType type)</span></span>;</span><br></pre></td></tr></table></figure>

<p>参数说明：</p>
<p><code>GstPlugin *plugin</code>：指向 <code>GstPlugin</code> 结构的指针，表示当前插件的元数据。</p>
<p><code>const gchar *name</code>：要注册的元素名称，这个名称在 <code>GStreamer</code> 的 pipeline 中用于标识元素。</p>
<p><code>GstRank rank</code>：元素的排名，决定了在自动连接时元素的优先级。排名越低，优先级越高。</p>
<p><code>GType type</code>：元素类型的 <code>GType</code> 值，通常通过 <code>G_DEFINE_TYPE</code> 宏定义。</p>
<hr>
<ul>
<li><code>GST_TYPE_PLUGIN_TEMPLATE</code></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> GST_TYPE_PLUGIN_TEMPLATE (gst_plugin_template_get_type())</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>G_DEFINE_TYPE (GstPluginTemplate, gst_plugin_template, GST_TYPE_ELEMENT)</code></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span>     <span class="title">gst_plugin_template_init</span>       <span class="params">(GstPluginTemplate      *self)</span></span>;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span>     <span class="title">gst_plugin_template_class_init</span> <span class="params">(GstPluginTemplateClass *klass)</span></span>;</span><br><span class="line"><span class="type">static</span> gpointer gst_plugin_template_parent_class = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">static</span> gint     GstPluginTemplate_private_offset;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span>     <span class="title">gst_plugin_template_class_intern_init</span> <span class="params">(gpointer klass)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    gst_plugin_template_parent_class = <span class="built_in">g_type_class_peek_parent</span> (klass);</span><br><span class="line">    <span class="keyword">if</span> (GstPluginTemplate_private_offset != <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">g_type_class_adjust_private_offset</span> (klass, &amp;GstPluginTemplate_private_offset);</span><br><span class="line">    <span class="built_in">gst_plugin_template_class_init</span> ((GstPluginTemplateClass*) klass);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> gpointer <span class="title">gst_plugin_template_get_instance_private</span> <span class="params">(GstPluginTemplate *self)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">G_STRUCT_MEMBER_P</span> (self, GstPluginTemplate_private_offset));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">GType <span class="title">gst_plugin_template_get_type</span> <span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> gsize static_g_define_type_id = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">g_once_init_enter</span> (&amp;static_g_define_type_id))</span><br><span class="line">    &#123;</span><br><span class="line">        GType g_define_type_id =</span><br><span class="line">            <span class="built_in">g_type_register_static_simple</span> (GST_TYPE_ELEMENT,</span><br><span class="line">                                           <span class="built_in">g_intern_static_string</span> (<span class="string">&quot;GstPluginTemplate&quot;</span>),</span><br><span class="line">                                           <span class="built_in">sizeof</span> (GstPluginTemplateClass),</span><br><span class="line">                                           (GClassInitFunc) gst_plugin_template_class_intern_init,</span><br><span class="line">                                           <span class="built_in">sizeof</span> (GstPluginTemplate),</span><br><span class="line">                                           (GInstanceInitFunc) gst_plugin_template_init,</span><br><span class="line">                                           <span class="number">0</span>);</span><br><span class="line">        &#123;</span><br><span class="line">            GstPluginTemplate_private_offset =</span><br><span class="line">                <span class="built_in">g_type_add_instance_private</span> (g_define_type_id, <span class="built_in">sizeof</span> (GstPluginTemplatePrivate));</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">const</span> GInterfaceInfo g_implement_interface_info = &#123;</span><br><span class="line">                (GInterfaceInitFunc) gst_plugin_template_gizmo_init</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="built_in">g_type_add_interface_static</span> (g_define_type_id, TYPE_GIZMO, &amp;g_implement_interface_info);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">g_once_init_leave</span> (&amp;static_g_define_type_id, g_define_type_id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> static_g_define_type_id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>G_DECLARE_FINAL_TYPE (GstPluginTemplate, gst_plugin_template, GST, PLUGIN_TEMPLATE, GstElement)</code></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GType <span class="title">gst_plugin_template_get_type</span> <span class="params">(<span class="type">void</span>)</span></span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_GstPluginTemplate</span> GstPluginTemplate;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123; GstElementClass parent_class; &#125; GstPluginTemplateClass;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>GstElement</code> 和 <code>GstElementClass</code> 区别<ul>
<li><code>GstElement</code><ul>
<li>是自定义元素的实例结构体。每个 <code>GstElement</code> 实例代表 GStreamer 管道中的一个元素实体。</li>
<li>它通常包含实际处理数据所需的成员变量，实例结构体定义了元素的状态信息，这些信息对于元素的运行时行为是特定的。</li>
</ul>
</li>
<li><code>GstElementClass</code><ul>
<li>是自定义元素的类结构体，它定义了元素的行为和功能。</li>
<li>类似于面向对象编程中的类，它包含了方法（虚函数）的实现。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="class-init"><a href="#class-init" class="headerlink" title="_class_init"></a>_class_init</h2><p>用于初始化类一次（指定类具有哪些信号、参数和虚函数，并设置全局状态）。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">gst_plugin_template_class_init</span> <span class="params">(GstPluginTemplateClass *klass)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GObjectClass *gobject_class;</span><br><span class="line">    GstElementClass *gstelement_class;</span><br><span class="line">    </span><br><span class="line">    gobject_class = (GObjectClass *) klass;</span><br><span class="line">    gstelement_class = (GstElementClass *) klass;</span><br><span class="line">    </span><br><span class="line">    gobject_class-&gt;set_property = gst_plugin_template_set_property;</span><br><span class="line">    gobject_class-&gt;get_property = gst_plugin_template_get_property;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">g_object_class_install_property</span> (gobject_class, PROP_SILENT,</span><br><span class="line">                                     <span class="built_in">g_param_spec_boolean</span> (<span class="string">&quot;silent&quot;</span>, <span class="string">&quot;Silent&quot;</span>, <span class="string">&quot;Produce verbose output ?&quot;</span>,</span><br><span class="line">                                                           FALSE, G_PARAM_READWRITE));</span><br><span class="line">    <span class="built_in">gst_element_class_set_details_simple</span> (gstelement_class,</span><br><span class="line">                                          <span class="string">&quot;Plugin&quot;</span>,</span><br><span class="line">                                          <span class="string">&quot;FIXME:Generic&quot;</span>,</span><br><span class="line">                                          <span class="string">&quot;FIXME:Generic Template Element&quot;</span>,</span><br><span class="line">                                          <span class="string">&quot;AUTHOR_NAME AUTHOR_EMAIL&quot;</span>);</span><br><span class="line">    <span class="built_in">gst_element_class_add_pad_template</span> (gstelement_class,</span><br><span class="line">                                        <span class="built_in">gst_static_pad_template_get</span> (&amp;src_factory));</span><br><span class="line">    <span class="built_in">gst_element_class_add_pad_template</span> (gstelement_class,</span><br><span class="line">                                        <span class="built_in">gst_static_pad_template_get</span> (&amp;sink_factory));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="gst-element-class-set-details-simple"><a href="#gst-element-class-set-details-simple" class="headerlink" title="gst_element_class_set_details_simple"></a>gst_element_class_set_details_simple</h3><p>用于设置 <code>GstElement</code> 类的元数据。允许开发者快速定义元素的名称、描述、作者和 <code>Klass</code> 结构，通常在元素类的初始化函数中调用。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">gst_element_class_set_details_simple</span> (gstelement_class,  <span class="comment">// 指向 GstElement 类的类的指针</span></span><br><span class="line">                                      <span class="string">&quot;Plugin&quot;</span>,          <span class="comment">// 元素的长名称，通常是元素的全名</span></span><br><span class="line">                                      <span class="string">&quot;FIXME:Generic&quot;</span>,   <span class="comment">// 元素的分类，用于描述元素的类型，例如 &quot;Source/Audio&quot;</span></span><br><span class="line">                                      <span class="string">&quot;FIXME:Generic Template Element&quot;</span>,  <span class="comment">// 元素的简短描述，说明元素的功能</span></span><br><span class="line">                                      <span class="string">&quot;AUTHOR_NAME AUTHOR_EMAIL&quot;</span>  <span class="comment">// 元素作者的名称和联系信息</span></span><br><span class="line">                                     );</span><br></pre></td></tr></table></figure>

<h3 id="gst-element-class-add-pad-template"><a href="#gst-element-class-add-pad-template" class="headerlink" title="gst_element_class_add_pad_template"></a>gst_element_class_add_pad_template</h3><p>用于向 <code>GstElement</code> 类添加一个新的 pad 模板。Pad 是 GStreamer 元素的输入或输出点，用于连接元素形成处理管道。通过添加 pad 模板，可以定义元素的静态连接端口，指明它们可以接受或提供什么样的媒体数据。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> GstStaticPadTemplate src_factory = <span class="built_in">GST_STATIC_PAD_TEMPLATE</span> (</span><br><span class="line">    <span class="string">&quot;src&quot;</span>,</span><br><span class="line">    GST_PAD_SINK,</span><br><span class="line">    GST_PAD_ALWAYS,</span><br><span class="line">    <span class="built_in">GST_STATIC_CAPS</span> (<span class="string">&quot;ANY&quot;</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> GstStaticPadTemplate sink_factory = <span class="built_in">GST_STATIC_PAD_TEMPLATE</span> (</span><br><span class="line">    <span class="string">&quot;sink&quot;</span>,</span><br><span class="line">    GST_PAD_SINK,</span><br><span class="line">    GST_PAD_ALWAYS,</span><br><span class="line">    <span class="built_in">GST_STATIC_CAPS</span> (<span class="string">&quot;audio/x-raw, format=(string)S16LE, rate=(int)44100, channels=(int)2&quot;</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">gst_my_plugin_class_init</span> <span class="params">(GstMyPluginClass *klass)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GstElementClass *element_class = <span class="built_in">GST_ELEMENT_CLASS</span> (klass);</span><br><span class="line">    <span class="comment">// 添加 pad 模板到插件</span></span><br><span class="line">    <span class="built_in">gst_plugin_add_pad_template</span> (element_class, <span class="built_in">gst_static_pad_template_get</span> (&amp;src_factory));</span><br><span class="line">    <span class="built_in">gst_plugin_add_pad_template</span> (element_class, <span class="built_in">gst_static_pad_template_get</span> (&amp;sink_factory));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="property"><a href="#property" class="headerlink" title="_property"></a>_property</h3><p><code>GObjectClass</code> 的方法，用于设置和获取成员。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* properties */</span></span><br><span class="line"><span class="keyword">enum</span> &#123;</span><br><span class="line">  PROP_0,</span><br><span class="line">  PROP_SILENT</span><br><span class="line">  <span class="comment">/* FILL ME */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">gst_plugin_template_set_property</span> <span class="params">(GObject *object, guint prop_id,</span></span></span><br><span class="line"><span class="params"><span class="function">                                              <span class="type">const</span> GValue *value, GParamSpec *pspec)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GstPluginTemplate *filter = <span class="built_in">GST_PLUGIN_TEMPLATE</span> (object);</span><br><span class="line">    <span class="keyword">switch</span> (prop_id) &#123;</span><br><span class="line">        <span class="keyword">case</span> PROP_SILENT:</span><br><span class="line">            filter-&gt;silent = <span class="built_in">g_value_get_boolean</span> (value);</span><br><span class="line">            <span class="built_in">g_print</span> (<span class="string">&quot;Silent argument was changed to %s\n&quot;</span>,</span><br><span class="line">                     filter-&gt;silent ? <span class="string">&quot;true&quot;</span> : <span class="string">&quot;false&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">G_OBJECT_WARN_INVALID_PROPERTY_ID</span> (object, prop_id, pspec);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">gst_plugin_template_get_property</span> <span class="params">(GObject *object, guint prop_id,</span></span></span><br><span class="line"><span class="params"><span class="function">                                              GValue *value, GParamSpec *pspec)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GstPluginTemplate *filter = <span class="built_in">GST_PLUGIN_TEMPLATE</span> (object);</span><br><span class="line">    <span class="keyword">switch</span> (prop_id) &#123;</span><br><span class="line">        <span class="keyword">case</span> PROP_SILENT:</span><br><span class="line">            <span class="built_in">g_value_set_boolean</span> (value, filter-&gt;silent);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">G_OBJECT_WARN_INVALID_PROPERTY_ID</span> (object, prop_id, pspec);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">gst_plugin_template_class_init</span> <span class="params">(GstPluginTemplateClass *klass)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GObjectClass *object_class = <span class="built_in">G_OBJECT_CLASS</span> (klass);</span><br><span class="line">    <span class="comment">/* define virtual function pointers */</span></span><br><span class="line">    object_class-&gt;set_property = gst_plugin_template_set_property;</span><br><span class="line">    object_class-&gt;get_property = gst_plugin_template_get_property;</span><br><span class="line">    <span class="comment">/* define properties */</span></span><br><span class="line">    <span class="built_in">g_object_class_install_property</span> (object_class, PROP_SILENT,</span><br><span class="line">                                     <span class="built_in">g_param_spec_boolean</span> (<span class="string">&quot;silent&quot;</span>, <span class="string">&quot;Silent&quot;</span>,</span><br><span class="line">                                                           <span class="string">&quot;Whether to be very verbose or not&quot;</span>,</span><br><span class="line">                                                           FALSE, G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="start-stop-create"><a href="#start-stop-create" class="headerlink" title="start&#x2F;stop&#x2F;create"></a>start&#x2F;stop&#x2F;create</h3><p><code>GstBaseSrcClass</code> 的方法，<code>start</code> 进行资源的初始化和准备工作；<code>stop</code> 进行资源的清理工作；<code>create</code> 生产数据。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> gboolean <span class="title">gst_plugin_template_start</span> <span class="params">(GstBaseSrc *base_src)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 资源初始化代码</span></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> gboolean <span class="title">gst_plugin_template_stop</span> <span class="params">(GstBaseSrc *base_src)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 资源清理代码</span></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> GstFlowReturn <span class="title">gst_plugin_template_create</span> <span class="params">(GstBaseSrc *src, guint64 offset, guint size, GstBuffer **buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 生产数据</span></span><br><span class="line">    <span class="keyword">return</span> GST_FLOW_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">gst_plugin_template_class_init</span> <span class="params">(GstPluginTemplateClass *klass)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GstBaseSrcClass *base_src_class = <span class="built_in">GST_BASE_SRC_CLASS</span> (klass);</span><br><span class="line">    base_src_class-&gt;start = <span class="built_in">GST_DEBUG_FUNCPTR</span> (gst_plugin_template_start);</span><br><span class="line">    base_src_class-&gt;stop = <span class="built_in">GST_DEBUG_FUNCPTR</span> (gst_plugin_template_stop);</span><br><span class="line">    base_src_class-&gt;create = <span class="built_in">GST_DEBUG_FUNCPTR</span> (gst_plugin_template_create);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="init"><a href="#init" class="headerlink" title="_init"></a>_init</h2><p>用于初始化这种类型的特定实例。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">gst_plugin_template_init</span> <span class="params">(GstPluginTemplate* plugin)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* pad through which data comes in to the element */</span></span><br><span class="line">    plugin-&gt;sinkpad = <span class="built_in">gst_pad_new_from_static_template</span> (&amp;sink_factory, <span class="string">&quot;sink&quot;</span>);</span><br><span class="line">    <span class="built_in">gst_pad_set_event_function</span> (plugin-&gt;sinkpad,</span><br><span class="line">                                <span class="built_in">GST_DEBUG_FUNCPTR</span> (gst_plugin_template_sink_event));</span><br><span class="line">    <span class="comment">/* configure chain function on the pad before adding the pad to the element */</span></span><br><span class="line">    <span class="built_in">gst_pad_set_chain_function</span> (plugin-&gt;sinkpad,</span><br><span class="line">                                <span class="built_in">GST_DEBUG_FUNCPTR</span> (gst_plugin_template_chain));</span><br><span class="line">    <span class="built_in">GST_PAD_SET_PROXY_CAPS</span> (plugin-&gt;sinkpad);</span><br><span class="line">    <span class="built_in">gst_element_add_pad</span> (<span class="built_in">GST_ELEMENT</span> (plugin), plugin-&gt;sinkpad);</span><br><span class="line">    <span class="comment">/* pad through which data goes out of the element */</span></span><br><span class="line">    plugin-&gt;srcpad = <span class="built_in">gst_pad_new_from_static_template</span> (&amp;src_factory, <span class="string">&quot;src&quot;</span>);</span><br><span class="line">    <span class="built_in">GST_PAD_SET_PROXY_CAPS</span> (plugin-&gt;srcpad);</span><br><span class="line">    <span class="built_in">gst_element_add_pad</span> (<span class="built_in">GST_ELEMENT</span> (plugin), plugin-&gt;srcpad);</span><br><span class="line">    <span class="comment">/* properties initial value */</span></span><br><span class="line">    plugin-&gt;silent = FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="gst-pad-new-from-static-template"><a href="#gst-pad-new-from-static-template" class="headerlink" title="gst_pad_new_from_static_template"></a>gst_pad_new_from_static_template</h3><p>用于根据静态 pad 模板创建一个新的 pad 实例。它通常在元素的实例初始化函数中被调用，用于根据预先定义的 pad 模板创建 pad。</p>
<h3 id="gst-element-add-pad"><a href="#gst-element-add-pad" class="headerlink" title="gst_element_add_pad"></a>gst_element_add_pad</h3><p>用于将一个已经创建的 <code>GstPad</code> 添加到 <code>GstElement</code> 中。</p>
<h3 id="chain"><a href="#chain" class="headerlink" title="_chain"></a>_chain</h3><p>用于处理通过 <code>GStreamer</code> 管道流动的数据包（通常称为缓冲区或 buffers）的函数。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> GstFlowReturn <span class="title">gst_plugin_template_chain</span> <span class="params">(GstPad *pad, GstObject *parent, GstBuffer *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  GstPluginTemplate *plugin = <span class="built_in">GST_PLUGIN_TEMPLATE</span> (parent);</span><br><span class="line">  GstBuffer *outbuf;</span><br><span class="line"></span><br><span class="line">  outbuf = <span class="built_in">gst_plugin_template_process_data</span> (plugin, buf);</span><br><span class="line">  <span class="built_in">gst_buffer_unref</span> (buf);</span><br><span class="line">  <span class="keyword">if</span> (!outbuf) &#123;</span><br><span class="line">    <span class="comment">/* something went wrong - signal an error */</span></span><br><span class="line">    <span class="built_in">GST_ELEMENT_ERROR</span> (<span class="built_in">GST_ELEMENT</span> (plugin), STREAM, FAILED, (<span class="literal">NULL</span>), (<span class="literal">NULL</span>));</span><br><span class="line">    <span class="keyword">return</span> GST_FLOW_ERROR;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">gst_pad_push</span> (plugin-&gt;srcpad, outbuf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="event"><a href="#event" class="headerlink" title="_event"></a>_event</h3><p>通知数据流中发生的特殊事件（如上限、流结束、新闻片段、标签等）。事件可以向上游和下游传播，可以在 <code>GstPad</code> 上接收它们。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> gboolean <span class="title">gst_plugin_template_sink_event</span> <span class="params">(GstPad *pad, GstObject *parent, GstEvent *event)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    gboolean ret;</span><br><span class="line">    GstPluginTemplate *plugin = <span class="built_in">GST_PLUGIN_TEMPLATE</span> (parent);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (<span class="built_in">GST_EVENT_TYPE</span> (event)) &#123;</span><br><span class="line">        <span class="keyword">case</span> GST_EVENT_CAPS:</span><br><span class="line">            <span class="comment">/* we should handle the format here */</span></span><br><span class="line">            <span class="comment">/* push the event downstream */</span></span><br><span class="line">            ret = <span class="built_in">gst_pad_push_event</span> (plugin-&gt;srcpad, event);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> GST_EVENT_EOS:</span><br><span class="line">            <span class="comment">/* end-of-stream, we should close down all stream leftovers here */</span></span><br><span class="line">            <span class="built_in">gst_plugin_template_stop_processing</span> (plugin);</span><br><span class="line">            ret = <span class="built_in">gst_pad_event_default</span> (pad, parent, event);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">/* just call the default handler */</span></span><br><span class="line">            ret = <span class="built_in">gst_pad_event_default</span> (pad, parent, event);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="query"><a href="#query" class="headerlink" title="_query"></a>_query</h3><p>通过查询功能，元素将收到它必须回复的查询。这些查询包括位置、持续时间，以及您的元素支持的格式和调度模式。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> gboolean <span class="title">gst_plugin_template_src_query</span> <span class="params">(GstPad *pad, GstObject *parent, GstQuery *query)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    gboolean ret;</span><br><span class="line">    GstPluginTemplate *plugin = <span class="built_in">GST_PLUGIN_TEMPLATE</span> (parent);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (<span class="built_in">GST_QUERY_TYPE</span> (query)) &#123;</span><br><span class="line">        <span class="keyword">case</span> GST_QUERY_POSITION:</span><br><span class="line">            <span class="comment">/* we should report the current position */</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> GST_QUERY_DURATION:</span><br><span class="line">            <span class="comment">/* we should report the duration here */</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> GST_QUERY_CAPS:</span><br><span class="line">            <span class="comment">/* we should report the supported caps here */</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">/* just call the default handler */</span></span><br><span class="line">            ret = <span class="built_in">gst_pad_query_default</span> (pad, parent, query);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="state"><a href="#state" class="headerlink" title="_state"></a>_state</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> GstStateChangeReturn <span class="title">gst_my_filter_change_state</span> <span class="params">(GstElement *element, GstStateChange transition)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">gst_my_filter_class_init</span> <span class="params">(GstMyFilterClass *klass)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GstElementClass *element_class = <span class="built_in">GST_ELEMENT_CLASS</span> (klass);</span><br><span class="line">    element_class-&gt;change_state = gst_my_filter_change_state;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> GstStateChangeReturn <span class="title">gst_my_filter_change_state</span> <span class="params">(GstElement *element, GstStateChange transition)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GstStateChangeReturn ret = GST_STATE_CHANGE_SUCCESS;</span><br><span class="line">    GstMyFilter *filter = <span class="built_in">GST_MY_FILTER</span> (element);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (transition) &#123;</span><br><span class="line">        <span class="keyword">case</span> GST_STATE_CHANGE_NULL_TO_READY:</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">gst_my_filter_allocate_memory</span> (filter))</span><br><span class="line">                <span class="keyword">return</span> GST_STATE_CHANGE_FAILURE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ret = <span class="built_in">GST_ELEMENT_CLASS</span> (parent_class)-&gt;<span class="built_in">change_state</span> (element, transition);</span><br><span class="line">    <span class="keyword">if</span> (ret == GST_STATE_CHANGE_FAILURE)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (transition) &#123;</span><br><span class="line">        <span class="keyword">case</span> GST_STATE_CHANGE_READY_TO_NULL:</span><br><span class="line">            <span class="built_in">gst_my_filter_free_memory</span> (filter);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2024/09/15/Direct3D%E6%B8%B2%E6%9F%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/15/Direct3D%E6%B8%B2%E6%9F%93/" class="post-title-link" itemprop="url">Direct3D渲染</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-09-15 15:07:12" itemprop="dateCreated datePublished" datetime="2024-09-15T15:07:12+08:00">2024-09-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-09-16 09:10:50" itemprop="dateModified" datetime="2024-09-16T09:10:50+08:00">2024-09-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%85%B6%E4%BB%96/" itemprop="url" rel="index"><span itemprop="name">其他</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Direct3D图形管道"><a href="#Direct3D图形管道" class="headerlink" title="Direct3D图形管道"></a>Direct3D图形管道</h1><pre class="mermaid">graph LR
    顶点数据-->转换处理
    原始数据-->转换处理
    转换处理-->顶点处理
    顶点处理-->几何处理
    几何处理-->像素处理
    纹理资源-->像素处理
    像素处理-->像素渲染</pre>

<h1 id="Direct3D相关概念"><a href="#Direct3D相关概念" class="headerlink" title="Direct3D相关概念"></a>Direct3D相关概念</h1><h2 id="Direct3D设备"><a href="#Direct3D设备" class="headerlink" title="Direct3D设备"></a>Direct3D设备</h2><p>Direct3D 设备时渲染组件，封装并存储渲染状态，此外，还执行转换和照明操作，并将图像光栅化到表面。体系架构上，Direct3D 设备包含转换模块、光线模块和光栅模块。</p>
<p>Direct3D 目前支持两种设备类型：</p>
<ul>
<li>HAL 设备，支持硬件加速，但可能不支持所有功能</li>
<li>参考设备，不使用硬件加速，因此速度很慢，但保证正确的支持一整套 Direct3D 的功能</li>
</ul>
<h2 id="Direct3D资源"><a href="#Direct3D资源" class="headerlink" title="Direct3D资源"></a>Direct3D资源</h2><p>资源是用于渲染场景的纹理和缓冲区。应用程序需要创建、加载、复制和使用资源。</p>
<h2 id="Surface"><a href="#Surface" class="headerlink" title="Surface"></a>Surface</h2><p>Surface（表面），表示显存当中的一个线性区域，通常位于显卡的显存当中，也可以存在于系统的内存当中。</p>
<ul>
<li>前台缓冲表面，由显卡转换并在显示器上显示的内存矩形。应用程序不会直接写入前台缓冲表面。</li>
<li>后台缓冲表面，应用程序可以直接写入的矩形内存，后台缓冲表面永远不会直接显示在显示器上。</li>
<li>翻转表面，将后台缓冲表面移动到前台缓冲表面的过程。</li>
<li>交换链，可以串行呈现给前台缓冲表面的一个或者多个后台缓冲表面的集合。</li>
</ul>
<h2 id="撕裂问题"><a href="#撕裂问题" class="headerlink" title="撕裂问题"></a>撕裂问题</h2><p>显卡中有一个指向 surface 的指针，该 surface 表示显示器正在显示的图像，称为前台缓冲表面。随着显示器不断的刷新，显卡会将前台缓冲表面的内容发送到显示器进行显示。但是，这会导致呈现实时图形时出现问题。该问题的核心是，显示器的刷新率（60hz~120hz）与计算机其它部分相比非常缓慢。<strong>如果应用程序在显示器刷新的过程中更新前台缓冲表面，显示的图像将被截成两部分， 一部分是旧图像，一部分是新图像，此问题称为撕裂。</strong></p>
<p>为了解决撕裂问题，Direct3D 提供了两种选项:</p>
<ul>
<li><p>一种选项是只允许显示器在垂直同步操作时才允许更新前台缓冲表面。显示器刷新图像的方式通常是水平扫描，从显示器左上角开始，Z 字形移动到右下角。光标到达底部时，显示器将重新校准，将其移回左上角，重新开始刷新过程。此重新校准的过程称为垂直同步。<strong>在垂直同步期间，显示器不会绘制任何内容，因此在显示器再次开始绘制之前，不会看到对前台缓冲区的任何更新</strong>。垂直同步相对较慢，但是，还不足以在此期间渲染复杂场景。若要避免撕裂，同时能够渲染复杂场景，则需要进行后台缓冲表面。</p>
</li>
<li><p>后台缓冲表面。除前台缓冲表面外，其余的表面缓冲表面都称为后台缓冲表面。<strong>通过使用后台缓冲表面，应用程序可以在系统空闲时自由渲染场景，而无需考虑显示器的刷新频率</strong>。<strong>后台缓冲带来一个新的问题：如何以及何时将后台缓冲表面的内容移至前台缓冲表面?</strong></p>
</li>
<li><p>表面翻转&amp;交换链。<strong>由于显卡只使用指针来引用前台缓冲区表面，所以只需要更改指针就可以将后台缓冲表面移至前台缓冲表面，这个过程称为表面翻转。</strong>表面翻转的结果是前台缓冲区表面变成了后台缓冲区表面，后台缓冲区表面变成了前台缓冲区表面。如果后台缓冲区不止一个，指针会以圆形的方式切换，这样就形成了一个交换链。</p>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2024/08/17/WebRTC-API/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/08/17/WebRTC-API/" class="post-title-link" itemprop="url">WebRTC-API</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-08-17 10:50:35" itemprop="dateCreated datePublished" datetime="2024-08-17T10:50:35+08:00">2024-08-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-09-16 20:37:27" itemprop="dateModified" datetime="2024-09-16T20:37:27+08:00">2024-09-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/WebRTC/" itemprop="url" rel="index"><span itemprop="name">WebRTC</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="音视频采集"><a href="#音视频采集" class="headerlink" title="音视频采集"></a>音视频采集</h1><h2 id="录音设备"><a href="#录音设备" class="headerlink" title="录音设备"></a>录音设备</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;api/task_queue/default_task_queue_factory.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;modules/audio_device/include/audio_device.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::unique_ptr&lt;webrtc::TaskQueueFactory&gt; task_queue_factory =</span><br><span class="line">        webrtc::<span class="built_in">CreateDefaultTaskQueueFactory</span>();</span><br><span class="line">    rtc::scoped_refptr&lt;webrtc::AudioDeviceModule&gt; audio_device = </span><br><span class="line">        webrtc::AudioDeviceModule::<span class="built_in">Create</span>(</span><br><span class="line">        webrtc::AudioDeviceModule::kPlatformDefaultAudio, task_queue_factory);</span><br><span class="line">    </span><br><span class="line">    <span class="type">int16_t</span> total = audio_device-&gt;<span class="built_in">RecordingDevices</span>();</span><br><span class="line">    <span class="type">char</span> id[<span class="number">128</span>];</span><br><span class="line">    <span class="type">char</span> name[<span class="number">128</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int16_t</span> index = <span class="number">0</span>; index &lt; total; ++index) &#123;</span><br><span class="line">        <span class="type">int32_t</span> res = audio_device-&gt;<span class="built_in">RecordingDeviceName</span>(index, name, id);</span><br><span class="line">        <span class="keyword">if</span> (res != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;id:&quot;</span> &lt;&lt; std::<span class="built_in">string</span>(id) &lt;&lt; <span class="string">&quot; name:&quot;</span> &lt;&lt; std::<span class="built_in">string</span>(name) &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="摄像头设备"><a href="#摄像头设备" class="headerlink" title="摄像头设备"></a>摄像头设备</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;modules/video_capture/video_capture_factory.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::unique_ptr&lt;webrtc::VideoCaptureModule::DeviceInfo&gt; video_device =</span><br><span class="line">        webrtc::VideoCaptureFactory::<span class="built_in">CreateDeviceInfo</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="type">uint32_t</span> total = video_device-&gt;<span class="built_in">NumberOfDevices</span>();</span><br><span class="line">    <span class="keyword">if</span> (total == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> id[<span class="number">128</span>];</span><br><span class="line">    <span class="type">char</span> name[<span class="number">128</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> index = <span class="number">0</span>; index &lt; total; ++index) &#123;</span><br><span class="line">        <span class="type">int32_t</span> res = video_device-&gt;<span class="built_in">GetDeviceName</span>(index, name, <span class="built_in">sizeof</span>(name), id, <span class="built_in">sizeof</span>(id));</span><br><span class="line">        <span class="keyword">if</span> (res != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;device id: &quot;</span> &lt;&lt; std::<span class="built_in">string</span>(id) &lt;&lt; <span class="string">&quot; device name: &quot;</span> &lt;&lt; std::<span class="built_in">string</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="窗口信息"><a href="#窗口信息" class="headerlink" title="窗口信息"></a>窗口信息</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;modules/desktop_capture/desktop_capturer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;modules/desktop_capture/desktop_capture_options.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::unique_ptr&lt;webrtc::DesktopCapturer&gt; desktop_capture =</span><br><span class="line">        webrtc::DesktopCapturer::<span class="built_in">CreateWindowCapturer</span>(webrtc::DesktopCaptureOptions::<span class="built_in">CreateDefault</span>());</span><br><span class="line"></span><br><span class="line">    webrtc::DesktopCapturer::SourceList sources;</span><br><span class="line">    desktop_capture-&gt;<span class="built_in">GetSourceList</span>(&amp;sources);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> it = sources.<span class="built_in">begin</span>(); it != sources.<span class="built_in">end</span>(); ++it) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;source id:&quot;</span> &lt;&lt; it-&gt;id &lt;&lt; <span class="string">&quot; title:&quot;</span> &lt;&lt; it-&gt;title &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="摄像头采集"><a href="#摄像头采集" class="headerlink" title="摄像头采集"></a>摄像头采集</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;rtc_base/logging.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;modules/video_capture/video_capture.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;modules/video_capture/video_capture_factory.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VcmCapturer</span> : <span class="keyword">public</span> rtc::VideoSinkInterface&lt;webrtc::VideoFrame&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">VcmCapturer</span>(<span class="type">size_t</span> width, <span class="type">size_t</span> height, <span class="type">size_t</span> fps, <span class="type">const</span> std::string&amp; device_id)</span><br><span class="line">    ~<span class="built_in">VcmCapturer</span>() <span class="keyword">override</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">Start</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Stop</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Destroy</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">OnFrame</span><span class="params">(<span class="type">const</span> webrtc::VideoFrame&amp; frame)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">size_t</span> width_;</span><br><span class="line">    <span class="type">size_t</span> height_;</span><br><span class="line">    <span class="type">size_t</span> fps_;</span><br><span class="line">    std::string device_id_;</span><br><span class="line">    rtc::scoped_refptr&lt;webrtc::VideoCaptureModule&gt; vcm_;</span><br><span class="line">    webrtc::VideoCaptureCapability capability_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">VcmCapturer::<span class="built_in">VcmCapturer</span>(<span class="type">size_t</span> width, <span class="type">size_t</span> height, <span class="type">size_t</span> fps, <span class="type">const</span> std::string &amp;device_id) </span><br><span class="line">    : <span class="built_in">width_</span>(width)</span><br><span class="line">    , <span class="built_in">height_</span>(height)</span><br><span class="line">    , <span class="built_in">fps_</span>(fps)</span><br><span class="line">    , <span class="built_in">device_id_</span>(device_id)</span><br><span class="line">&#123;</span><br><span class="line">    vcm_ = webrtc::VideoCaptureFactory::<span class="built_in">Create</span>(device_id.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">if</span> (!vcm_) &#123;</span><br><span class="line">        <span class="built_in">RTC_LOG</span>(LS_WARNING) &lt;&lt; <span class="string">&quot;failed to create vcm capture, device id: &quot;</span> &lt;&lt; device_id;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册回调采集数据</span></span><br><span class="line">    vcm_-&gt;<span class="built_in">RegisterCaptureDataCallback</span>(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function">std::unique_ptr&lt;webrtc::VideoCaptureModule::DeviceInfo&gt; <span class="title">device_info</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        webrtc::VideoCaptureFactory::CreateDeviceInfo())</span></span>;</span><br><span class="line">    device_info-&gt;<span class="built_in">GetCapability</span>(vcm_-&gt;<span class="built_in">CurrentDeviceName</span>(), <span class="number">0</span>, capability_);</span><br><span class="line"></span><br><span class="line">    capability_.width = width;</span><br><span class="line">    capability_.height = height;</span><br><span class="line">    capability_.maxFPS = fps;</span><br><span class="line">    capability_.videoType = webrtc::VideoType::kI420;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">VcmCapturer::Start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!vcm_) &#123;</span><br><span class="line">        <span class="built_in">RTC_LOG</span>(LS_WARNING) &lt;&lt; <span class="string">&quot;vcm not init&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (vcm_-&gt;<span class="built_in">StartCapture</span>(capability_) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">RTC_LOG</span>(LS_WARNING) &lt;&lt; <span class="string">&quot;start capture failed, device_id: &quot;</span> &lt;&lt; vcm_-&gt;<span class="built_in">CurrentDeviceName</span>();</span><br><span class="line">        <span class="built_in">Destroy</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">RTC_LOG</span>(LS_INFO) &lt;&lt; <span class="string">&quot;video capture started: &quot;</span> &lt;&lt; vcm_-&gt;<span class="built_in">CurrentDeviceName</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">VcmCapturer::Stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (vcm_) &#123;</span><br><span class="line">        vcm_-&gt;<span class="built_in">StopCapture</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">VcmCapturer::Destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!vcm_) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vcm_-&gt;<span class="built_in">StopCapture</span>();</span><br><span class="line">    vcm_-&gt;<span class="built_in">DeRegisterCaptureDataCallback</span>();</span><br><span class="line">    vcm_ = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="窗口采集"><a href="#窗口采集" class="headerlink" title="窗口采集"></a>窗口采集</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;rtc_base/thread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;rtc_base/logging.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;system_wrappers/include/sleep.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;modules/desktop_capture/desktop_capturer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;modules/desktop_capture/desktop_frame.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;modules/desktop_capture/desktop_capture_options.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libyuv/convert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libyuv/video_common.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;api/video/i420_buffer.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DesktopCapture</span> : <span class="keyword">public</span> webrtc::DesktopCapturer::Callback &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">DesktopCapture</span>();</span><br><span class="line">    ~<span class="built_in">DesktopCapture</span>() <span class="keyword">override</span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">Start</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Stop</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">DesktopCapture::OnCaptureResult</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        webrtc::DesktopCapturer::Result result,</span></span></span><br><span class="line"><span class="params"><span class="function">        std::unique_ptr&lt;webrtc::DesktopFrame&gt; frame)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">size_t</span> width_;</span><br><span class="line">    <span class="type">size_t</span> height_;</span><br><span class="line">    <span class="type">size_t</span> fps_;</span><br><span class="line">    <span class="type">intptr_t</span> window_id_;</span><br><span class="line">    std::atomic&lt;<span class="type">bool</span>&gt; is_running_&#123;<span class="literal">false</span>&#125;;</span><br><span class="line">    FILE* fd_ = <span class="literal">nullptr</span>;</span><br><span class="line">    std::unique_ptr&lt;webrtc::DesktopCapturer&gt; desktop_capturer_;</span><br><span class="line">    std::unique_ptr&lt;rtc::Thread&gt; capturer_thread_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">DesktopCapture::<span class="built_in">DesktopCapture</span>() </span><br><span class="line">    : <span class="built_in">capturer_thread_</span>(rtc::Thread::<span class="built_in">Create</span>())</span><br><span class="line">&#123;</span><br><span class="line">    FILE* fd_ = <span class="built_in">fopen</span>(<span class="string">&quot;test.yuv420&quot;</span>, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DesktopCapture::~<span class="built_in">DesktopCapture</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">Stop</span>();</span><br><span class="line">    <span class="built_in">fclose</span>(fd_);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DesktopCapture::Start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    capturer_thread_-&gt;<span class="built_in">Start</span>();</span><br><span class="line">    is_running_ = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    capturer_thread_-&gt;<span class="built_in">PostTask</span>([<span class="keyword">this</span>]() &#123;</span><br><span class="line">        std::unique_ptr&lt;webrtc::DesktopCapturer&gt; desktop_capturer =</span><br><span class="line">            webrtc::DesktopCapturer::<span class="built_in">CreateWindowCapturer</span>(</span><br><span class="line">                                webrtc::DesktopCaptureOptions::<span class="built_in">CreateDefault</span>());</span><br><span class="line">        desktop_capturer_-&gt;<span class="built_in">Start</span>(<span class="keyword">this</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!desktop_capturer_-&gt;<span class="built_in">SelectSource</span>(window_id_)) &#123;</span><br><span class="line">            <span class="built_in">Stop</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!desktop_capturer_) &#123;</span><br><span class="line">            <span class="built_in">Stop</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">RTC_LOG</span>(LS_INFO) &lt;&lt; <span class="string">&quot;Desktop capture started.&quot;</span>;</span><br><span class="line">        <span class="keyword">while</span> (is_running_) &#123;</span><br><span class="line">            webrtc::<span class="built_in">SleepMs</span>(<span class="number">1000</span> / fps_);</span><br><span class="line">            desktop_capturer_-&gt;<span class="built_in">CaptureFrame</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">RTC_LOG</span>(LS_INFO) &lt;&lt; <span class="string">&quot;Desktop capture stoped.&quot;</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DesktopCapture::Stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_running_) &#123;</span><br><span class="line">        is_running_ = <span class="literal">false</span>;</span><br><span class="line">        capturer_thread_-&gt;<span class="built_in">Stop</span>();</span><br><span class="line">        capturer_thread_.<span class="built_in">reset</span>();</span><br><span class="line">        desktop_capturer_.<span class="built_in">reset</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取DesktopFrame(ARGB)转成VideoFrame(I420)</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DesktopCapture::OnCaptureResult</span><span class="params">(webrtc::DesktopCapturer::Result result,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     std::unique_ptr&lt;webrtc::DesktopFrame&gt; frame)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (result == webrtc::DesktopCapturer::Result::SUCCESS) &#123;</span><br><span class="line">        <span class="type">int</span> height = frame.<span class="built_in">size</span>().<span class="built_in">height</span>();</span><br><span class="line">        <span class="type">int</span> width = frame.<span class="built_in">size</span>().<span class="built_in">width</span>();</span><br><span class="line">        <span class="comment">// cv::Mat</span></span><br><span class="line">        <span class="function">cv::Mat <span class="title">image</span><span class="params">(height, width, CV_8UC4, frame.data(), width * <span class="number">4</span>)</span></span>;</span><br><span class="line">        <span class="type">static</span> <span class="type">int</span> img_id = <span class="number">0</span>;</span><br><span class="line">        cv::<span class="built_in">imwrite</span>(<span class="string">&quot;./image&quot;</span> + std::<span class="built_in">to_string</span>(img_id) + <span class="string">&quot;.jpg&quot;</span>, image);</span><br><span class="line">        img_id++;</span><br><span class="line"></span><br><span class="line">        rtc::scoped_refptr&lt;webrtc::I420Buffer&gt; buffer = </span><br><span class="line">            webrtc::I420Buffer::<span class="built_in">Create</span>(width, height, width, width / <span class="number">2</span>, width / <span class="number">2</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">const</span> <span class="type">int</span> res = libyuv::<span class="built_in">ConvertToI420</span>(</span><br><span class="line">            frame.<span class="built_in">data</span>(), <span class="number">0</span>, buffer-&gt;<span class="built_in">MutableDataY</span>(), buffer-&gt;<span class="built_in">StrideY</span>(),</span><br><span class="line">            buffer-&gt;<span class="built_in">MutableDataU</span>(), buffer-&gt;<span class="built_in">StrideU</span>(),</span><br><span class="line">            buffer-&gt;<span class="built_in">MutableDataV</span>(), buffer-&gt;<span class="built_in">StrideV</span>(), <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">            buffer-&gt;<span class="built_in">width</span>(), buffer-&gt;<span class="built_in">height</span>(), buffer-&gt;<span class="built_in">width</span>(),</span><br><span class="line">            buffer-&gt;<span class="built_in">height</span>(), libyuv::kRotate0, ::libyuv::FOURCC_ARGB);</span><br><span class="line">        </span><br><span class="line">        <span class="function">webrtc::VideoFrame <span class="title">video_frame</span><span class="params">(buffer, <span class="number">0</span>, <span class="number">0</span>,  webrtc::kVideoRotation_0)</span></span>;</span><br><span class="line">        rtc::scoped_refptr&lt;webrtc::VideoFrameBuffer&gt; vfb = video_frame.<span class="built_in">video_frame_buffer</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// YUV420写文件        </span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; height; ++i)</span><br><span class="line">            <span class="built_in">fwrite</span>(vfb.<span class="built_in">get</span>()-&gt;<span class="built_in">GetI420</span>()-&gt;<span class="built_in">DataY</span>() + i * vfb.<span class="built_in">get</span>()-&gt;<span class="built_in">GetI420</span>()-&gt;<span class="built_in">StrideY</span>(), <span class="number">1</span>, width, fd_);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; height / <span class="number">2</span>; ++i)</span><br><span class="line">            <span class="built_in">fwrite</span>(vfb.<span class="built_in">get</span>()-&gt;<span class="built_in">GetI420</span>()-&gt;<span class="built_in">DataU</span>() + i * vfb.<span class="built_in">get</span>()-&gt;<span class="built_in">GetI420</span>()-&gt;<span class="built_in">StrideU</span>(), <span class="number">1</span>, width / <span class="number">2</span>, fd_);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; height / <span class="number">2</span>; ++i)</span><br><span class="line">            <span class="built_in">fwrite</span>(vfb.<span class="built_in">get</span>()-&gt;<span class="built_in">GetI420</span>()-&gt;<span class="built_in">DataV</span>() + i * vfb.<span class="built_in">get</span>()-&gt;<span class="built_in">GetI420</span>()-&gt;<span class="built_in">StrideV</span>(), <span class="number">1</span>, width / <span class="number">2</span>, fd_);</span><br><span class="line">        <span class="built_in">fflush</span>(fd_);     </span><br><span class="line">        <span class="comment">// 播放yuv420</span></span><br><span class="line">        <span class="comment">// 注意宽高，否则可能产生花屏</span></span><br><span class="line">        <span class="comment">// ffplay -pixel_format yuv420p -video_size widthxheight -framerate 5 test.yuv420</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Source-Sink"><a href="#Source-Sink" class="headerlink" title="Source&amp;Sink"></a>Source&amp;Sink</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Source</span> : <span class="keyword">public</span> rtc::VideoSinkInterface&lt;webrtc::VideoFrame&gt;,</span><br><span class="line">               <span class="keyword">public</span> rtc::VideoSourceInterface&lt;webrtc::VideoFrame&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// rtc::VideoSourceInterface</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">AddOrUpdateSink</span><span class="params">(rtc::VideoSinkInterface&lt;webrtc::VideoFrame&gt;* sink,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 <span class="type">const</span> rtc::VideoSinkWants&amp; wants)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        broadcaster_.<span class="built_in">AddOrUpdateSink</span>(sink, wants);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">RemoveSink</span><span class="params">(rtc::VideoSinkInterface&lt;webrtc::VideoFrame&gt;* sink)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        broadcaster_.<span class="built_in">RemoveSink</span>(sink);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// rtc::VideoSinkInterface</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">OnFrame</span><span class="params">(<span class="type">const</span> webrtc::VideoFrame&amp; frame)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 添加的所有Sink中OnFrame回调数据</span></span><br><span class="line">        broadcaster_.<span class="built_in">OnFrame</span>(frame);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// sinks 线程安全</span></span><br><span class="line">    rtc::VideoBroadcaster broadcaster_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Sink</span> : <span class="keyword">public</span> rtc::VideoSinkInterface&lt;webrtc::VideoFrame&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// rtc::VideoSinkInterface</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">OnFrame</span><span class="params">(<span class="type">const</span> webrtc::VideoFrame &amp;frame)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Sink作为视频源的输出接收者</span></span><br><span class="line">        <span class="comment">// OnFrame()中获取数据</span></span><br><span class="line">        source_-&gt;<span class="built_in">AddOrUpdateSink</span>(<span class="keyword">this</span>, rtc::<span class="built_in">VideoSinkWants</span>());</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// 视频源</span></span><br><span class="line">    rtc::VideoSourceInterface&lt;webrtc::VideoFrame&gt;* source_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="PeerConnection"><a href="#PeerConnection" class="headerlink" title="PeerConnection"></a>PeerConnection</h1><h2 id="创建PeerConnection"><a href="#创建PeerConnection" class="headerlink" title="创建PeerConnection"></a>创建PeerConnection</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;rtc_base/logging&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;api/peer_connection_interface.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;api/create_peerconnection_factory.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;api/audio_codecs/builtin_audio_encoder_factory.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;api/audio_codecs/builtin_audio_decoder_factory.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;api/video_codecs/builtin_video_encoder_factory.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;api/video_codecs/builtin_video_decoder_factory.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DummyPeerConnectionObserver</span> : <span class="keyword">public</span> webrtc::PeerConnectionObserver &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// Triggered when the SignalingState changed.</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">OnSignalingChange</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        webrtc::PeerConnectionInterface::SignalingState new_state)</span> <span class="keyword">override</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Triggered when a remote peer opens a data channel.</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">OnDataChannel</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        rtc::scoped_refptr&lt;webrtc::DataChannelInterface&gt; data_channel)</span> <span class="keyword">override</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Called any time the IceGatheringState changes.</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">OnIceGatheringChange</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        webrtc::PeerConnectionInterface::IceGatheringState new_state)</span> <span class="keyword">override</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// A new ICE candidate has been gathered.</span></span><br><span class="line">    <span class="comment">// PeerConnection::SetLocalDescription 调用后触发收集本地的candidate</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">OnIceCandidate</span><span class="params">(<span class="type">const</span> webrtc::IceCandidateInterface* candidate)</span> <span class="keyword">override</span> </span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Called any time the PeerConnectionState changes.</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">OnConnectionChange</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        webrtc::PeerConnectionInterface::PeerConnectionState new_state)</span> <span class="keyword">override</span> </span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// This is called when a receiver and its track are created.</span></span><br><span class="line">    <span class="comment">// TODO(zhihuang): Make this pure virtual when all subclasses implement it.</span></span><br><span class="line">    <span class="comment">// Note: This is called with both Plan B and Unified Plan semantics. Unified</span></span><br><span class="line">    <span class="comment">// Plan users should prefer OnTrack, OnAddTrack is only called as backwards</span></span><br><span class="line">    <span class="comment">// compatibility (and is called in the exact same situations as OnTrack).</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">OnAddTrack</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        rtc::scoped_refptr&lt;webrtc::RtpReceiverInterface&gt; receiver,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> std::vector&lt;rtc::scoped_refptr&lt;webrtc::MediaStreamInterface&gt;&gt;&amp; streams)</span> <span class="keyword">override</span> </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 创建PeerconnectionFactory</span></span><br><span class="line">    <span class="function">std::unique_ptr&lt;rtc::Thread&gt; <span class="title">worker_thread</span><span class="params">(rtc::Thread::Create())</span></span>;</span><br><span class="line">    worker_thread-&gt;<span class="built_in">SetName</span>(<span class="string">&quot;worker_thread&quot;</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    worker_thread-&gt;<span class="built_in">Start</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="function">std::unique_ptr&lt;rtc::Thread&gt; <span class="title">network_thread</span><span class="params">(rtc::Thread::Create())</span></span>;</span><br><span class="line">    network_thread-&gt;<span class="built_in">SetName</span>(<span class="string">&quot;network_thread&quot;</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    network_thread-&gt;<span class="built_in">Start</span>();</span><br><span class="line">    </span><br><span class="line">    rtc::scoped_refptr&lt;webrtc::PeerConnectionFactoryInterface&gt; pc_factory =</span><br><span class="line">        webrtc::<span class="built_in">CreatePeerConnectionFactory</span>(network_thread.<span class="built_in">get</span>(),  <span class="comment">// 网络线程</span></span><br><span class="line">                                            worker_thread.<span class="built_in">get</span>(),  <span class="comment">// 工作线程</span></span><br><span class="line">                                            <span class="literal">nullptr</span>, <span class="comment">// 信令线程</span></span><br><span class="line">                                            <span class="literal">nullptr</span>, <span class="comment">// 默认音频设备</span></span><br><span class="line">                                            webrtc::<span class="built_in">CreateBuiltinAudioEncoderFactory</span>(), <span class="comment">// 音频编码器工厂</span></span><br><span class="line">                                            webrtc::<span class="built_in">CreateBuiltinAudioDecoderFactory</span>(), <span class="comment">// 音频解码器工厂</span></span><br><span class="line">                                            webrtc::<span class="built_in">CreateBuiltinVideoEncoderFactory</span>(), <span class="comment">// 视频编码器工厂</span></span><br><span class="line">                                            <span class="comment">// CreateExternalVideoEncoderFactory(), // 可以自定义插件</span></span><br><span class="line">                                            webrtc::<span class="built_in">CreateBuiltinVideoDecoderFactory</span>(), <span class="comment">// 视频解码器工厂</span></span><br><span class="line">                                            <span class="literal">nullptr</span>, <span class="comment">// 音频混音器</span></span><br><span class="line">                                            <span class="literal">nullptr</span>  <span class="comment">// 音频处理器</span></span><br><span class="line">                                           );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!pc_factory) &#123;</span><br><span class="line">        <span class="built_in">RTC_LOG</span>(LS_WARNING) &lt;&lt; <span class="string">&quot;create peerconnection factory failed&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 创建peerconnection</span></span><br><span class="line">    webrtc::PeerConnectionInterface::RTCConfiguration config;</span><br><span class="line">    config.sdp_semantics = webrtc::SdpSemantics::kUnifiedPlan;</span><br><span class="line"></span><br><span class="line">    DummyPeerConnectionObserver observer;</span><br><span class="line">    <span class="function">webrtc::PeerConnectionDependencies <span class="title">dep</span><span class="params">(&amp;observer)</span></span>;</span><br><span class="line">    <span class="keyword">auto</span> pc_or_error = pc_factory-&gt;<span class="built_in">CreatePeerConnectionOrError</span>(config, std::<span class="built_in">move</span>(dep));</span><br><span class="line">    <span class="keyword">if</span> (!pc_or_error.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">        <span class="built_in">RTC_LOG</span>(LS_WARNING) &lt;&lt; <span class="string">&quot;create peerconnection failed: &quot;</span> &lt;&lt; pc_or_error.<span class="built_in">error</span>().<span class="built_in">message</span>() ;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pc = pc_or_error.<span class="built_in">value</span>();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="添加音视频轨道"><a href="#添加音视频轨道" class="headerlink" title="添加音视频轨道"></a>添加音视频轨道</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;rtc_base/logging&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pc/video_track_source.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VideoSource</span> : <span class="keyword">public</span> webrtc::VideoTrackSource &#123;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> rtc::VideoSourceInterface&lt;webrtc::VideoFrame&gt;* <span class="title">source</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 音频轨道</span></span><br><span class="line">    cricket::AudioOptions audio_options;</span><br><span class="line">    <span class="function">rtc::scoped_refptr&lt;webrtc::AudioTrackInterface&gt; <span class="title">audio_track</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        pc_factory-&gt;CreateAudioTrack(<span class="string">&quot;audio_label&quot;</span>, </span></span></span><br><span class="line"><span class="params"><span class="function">                                     pc_factory-&gt;CreateAudioSource(audio_options).get()))</span></span>; <span class="comment">// 默认音频源</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> result_or_error = pc-&gt;<span class="built_in">AddTrack</span>(audio_track, &#123;<span class="string">&quot;stream_id&quot;</span>&#125;);</span><br><span class="line">    <span class="keyword">if</span> (!result_or_error.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">        <span class="built_in">RTC_LOG</span>(LS_WARNING) &lt;&lt; <span class="string">&quot;failed to add audio track to peerconnection: &quot;</span></span><br><span class="line">                            &lt;&lt; result_or_error.<span class="built_in">error</span>().<span class="built_in">message</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 视频轨道</span></span><br><span class="line">    <span class="comment">// 需要创建视频源 webrtc::VideoTrackSource</span></span><br><span class="line">    rtc::scoped_refptr&lt;webrtc::VideoTrackSourceInterface&gt; video_source;</span><br><span class="line">    <span class="function">rtc::scoped_refptr&lt;webrtc::VideoTrackInterface&gt; <span class="title">video_track</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        pc_factory-&gt;CreateVideoTrack(video_source, <span class="string">&quot;video_label&quot;</span>))</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> result_or_error = pc-&gt;<span class="built_in">AddTrack</span>(video_track, &#123;<span class="string">&quot;stream_id&quot;</span>&#125;);</span><br><span class="line">    <span class="keyword">if</span> (!result_or_error.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">        <span class="built_in">RTC_LOG</span>(LS_WARNING) &lt;&lt; <span class="string">&quot;failed to add video track to peerconnection: &quot;</span></span><br><span class="line">                            &lt;&lt; result_or_error.<span class="built_in">error</span>().<span class="built_in">message</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Offer-Answer"><a href="#Offer-Answer" class="headerlink" title="Offer&amp;Answer"></a>Offer&amp;Answer</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;rtc_base/logging&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;api/peer_connection_interface.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置远程Offer观察者</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DummySetRemoteDescriptionObserver</span> : <span class="keyword">public</span> webrtc::SetRemoteDescriptionObserverInterface &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">OnSetRemoteDescriptionComplete</span><span class="params">(webrtc::RTCError error)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (error.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">            <span class="built_in">RTC_LOG</span>(LS_INFO) &lt;&lt; <span class="string">&quot;set remote sdp success&quot;</span>;</span><br><span class="line">            <span class="built_in">CreateAnswer</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">RTC_LOG</span>(LS_WARNING) &lt;&lt; <span class="string">&quot;set remote sdp failed: &quot;</span> &lt;&lt; error.<span class="built_in">message</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 设置远程Offer</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SetRemoteOffer</span><span class="params">(<span class="type">const</span> std::string &amp;offer)</span> </span>&#123;</span><br><span class="line">    absl::optional&lt;webrtc::SdpType&gt; sdp_type = webrtc::<span class="built_in">SdpTypeFromString</span>(<span class="string">&quot;offer&quot;</span>);</span><br><span class="line">    webrtc::SdpParseError err;</span><br><span class="line">    std::unique_ptr&lt;webrtc::SessionDescriptionInterface&gt; session_description =</span><br><span class="line">        webrtc::<span class="built_in">CreateSessionDescription</span>(*sdp_type, offer, &amp;err);</span><br><span class="line">    <span class="keyword">if</span> (!session_description) &#123;</span><br><span class="line">        <span class="built_in">RTC_LOG</span>(LS_WARNING) &lt;&lt; <span class="string">&quot;create session description failed: &quot;</span> &lt;&lt; err.description;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sdp设置到pc中</span></span><br><span class="line">    <span class="function">rtc::scoped_refptr&lt;DummySetRemoteDescriptionObserver&gt; <span class="title">observer</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">new</span> rtc::RefCountedObject&lt;DummySetRemoteDescriptionObserver&gt;())</span></span>;</span><br><span class="line">    pc-&gt;<span class="built_in">SetRemoteDescription</span>(std::<span class="built_in">move</span>(session_description), observer);    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建Answer观察者</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DummyCreateSessionDescriptionObserver</span> : <span class="keyword">public</span> webrtc::CreateSessionDescriptionObserver &#123;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">OnSuccess</span><span class="params">(webrtc::SessionDescriptionInterface* desc)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="built_in">SetLocalAnswer</span>(desc);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">OnFailure</span><span class="params">(webrtc::RTCError error)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="built_in">RTC_LOG</span>(LS_WARNING) &lt;&lt; <span class="string">&quot;create answer failed: &quot;</span> &lt;&lt; error.<span class="built_in">message</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 本地创建Answer</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CreateAnswer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">rtc::scoped_refptr&lt;DummyCreateSessionDescriptionObserver&gt; <span class="title">observer</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">new</span> rtc::RefCountedObject&lt;DummyCreateSessionDescriptionObserver&gt;())</span></span>;</span><br><span class="line">    pc-&gt;<span class="built_in">CreateAnswer</span>(observer.<span class="built_in">get</span>(), webrtc::PeerConnectionInterface::<span class="built_in">RTCOfferAnswerOptions</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置本地Answer观察者</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DummySetLocalDescriptionObserver</span> : <span class="keyword">public</span> webrtc::SetLocalDescriptionObserverInterface &#123;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">OnSetLocalDescriptionComplete</span><span class="params">(webrtc::RTCError error)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (error.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">            <span class="built_in">RTC_LOG</span>(LS_INFO) &lt;&lt; <span class="string">&quot;set local answer success&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">RTC_LOG</span>(LS_WARNING) &lt;&lt; <span class="string">&quot;set local answer failed: &quot;</span> &lt;&lt; error.<span class="built_in">message</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 设置本地Answer</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SetLocalAnswer</span><span class="params">(webrtc::SessionDescriptionInterface *desc)</span> </span>&#123;</span><br><span class="line">    std::string answer;</span><br><span class="line">    desc-&gt;<span class="built_in">ToString</span>(&amp;answer);</span><br><span class="line">    <span class="built_in">RTC_LOG</span>(LS_INFO) &lt;&lt; <span class="string">&quot;create answer success, answer: \n&quot;</span> &lt;&lt; answer;</span><br><span class="line"></span><br><span class="line">    <span class="function">rtc::scoped_refptr&lt;DummySetLocalDescriptionObserver&gt; <span class="title">observer</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">new</span> rtc::RefCountedObject&lt;DummySetLocalDescriptionObserver&gt;())</span></span>;</span><br><span class="line">    <span class="function">std::unique_ptr&lt;webrtc::SessionDescriptionInterface&gt; <span class="title">answer_sdp</span><span class="params">(desc)</span></span>;</span><br><span class="line">    pc-&gt;<span class="built_in">SetLocalDescription</span>(std::<span class="built_in">move</span>(answer_sdp), observer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="自定义编解码器插件"><a href="#自定义编解码器插件" class="headerlink" title="自定义编解码器插件"></a>自定义编解码器插件</h1><h2 id="编码插件"><a href="#编码插件" class="headerlink" title="编码插件"></a>编码插件</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;api/video_codecs/video_encoder_factory.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExternalVideoEncoderFactory</span> : <span class="keyword">public</span> webrtc::VideoEncoderFactory &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ExternalVideoEncoderFactory</span>();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> std::vector&lt;webrtc::SdpVideoFormat&gt; <span class="title">GetSupportedFormats</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> std::unique_ptr&lt;webrtc::VideoEncoder&gt; <span class="title">Create</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> webrtc::Environment&amp; env, <span class="type">const</span> webrtc::SdpVideoFormat&amp; format)</span> <span class="keyword">override</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">std::unique_ptr&lt;ExternalVideoEncoderFactory&gt; <span class="title">CreateExternalVideoEncoderFactory</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">H264EncoderImpl</span> : <span class="keyword">public</span> webrtc::VideoEncoder &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">H264EncoderImpl</span>();</span><br><span class="line">    ~<span class="built_in">H264EncoderImpl</span>() <span class="keyword">override</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">InitEncode</span><span class="params">(<span class="type">const</span> webrtc::VideoCodec* codec_settings,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="type">const</span> VideoEncoder::Settings&amp; settings)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register an encode complete callback object.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Input:</span></span><br><span class="line">    <span class="comment">//          - callback         : Callback object which handles encoded images.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Return value                : WEBRTC_VIDEO_CODEC_OK if OK, &lt; 0 otherwise.</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int32_t</span> <span class="title">RegisterEncodeCompleteCallback</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        webrtc::EncodedImageCallback* callback)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Free encoder memory.</span></span><br><span class="line">    <span class="comment">// Return value                : WEBRTC_VIDEO_CODEC_OK if OK, &lt; 0 otherwise.</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int32_t</span> <span class="title">Release</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Encode an image (as a part of a video stream). The encoded image</span></span><br><span class="line">    <span class="comment">// will be returned to the user through the encode complete callback.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Input:</span></span><br><span class="line">    <span class="comment">//          - frame             : Image to be encoded</span></span><br><span class="line">    <span class="comment">//          - frame_types       : Frame type to be generated by the encoder.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Return value                 : WEBRTC_VIDEO_CODEC_OK if OK</span></span><br><span class="line">    <span class="comment">//                                &lt;0 - Errors:</span></span><br><span class="line">    <span class="comment">//                                  WEBRTC_VIDEO_CODEC_ERR_PARAMETER</span></span><br><span class="line">    <span class="comment">//                                  WEBRTC_VIDEO_CODEC_MEMORY</span></span><br><span class="line">    <span class="comment">//                                  WEBRTC_VIDEO_CODEC_ERROR</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int32_t</span> <span class="title">Encode</span><span class="params">(<span class="type">const</span> webrtc::VideoFrame&amp; frame,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="type">const</span> std::vector&lt;webrtc::VideoFrameType&gt;* frame_types)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sets rate control parameters: bitrate, framerate, etc. These settings are</span></span><br><span class="line">    <span class="comment">// instantaneous (i.e. not moving averages) and should apply from now until</span></span><br><span class="line">    <span class="comment">// the next call to SetRates().</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">SetRates</span><span class="params">(<span class="type">const</span> RateControlParameters&amp; parameters)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Returns meta-data about the encoder, such as implementation name.</span></span><br><span class="line">    <span class="comment">// The output of this method may change during runtime. For instance if a</span></span><br><span class="line">    <span class="comment">// hardware encoder fails, it may fall back to doing software encoding using</span></span><br><span class="line">    <span class="comment">// an implementation with different characteristics.</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> EncoderInfo <span class="title">GetEncoderInfo</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="解码插件"><a href="#解码插件" class="headerlink" title="解码插件"></a>解码插件</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;api/video_codecs/video_decoder_factory.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExternalVideoDecoderFactory</span> : <span class="keyword">public</span> webrtc::VideoDecoderFactory &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ExternalVideoDecoderFactory</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Returns a list of supported video formats in order of preference, to use</span></span><br><span class="line">    <span class="comment">// for signaling etc.</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> std::vector&lt;webrtc::SdpVideoFormat&gt; <span class="title">GetSupportedFormats</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Creates a VideoDecoder for the specified `format`.</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> std::unique_ptr&lt;webrtc::VideoDecoder&gt; <span class="title">Create</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> webrtc::Environment&amp; env,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> webrtc::SdpVideoFormat&amp; format)</span> <span class="keyword">override</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">std::unique_ptr&lt;ExternalVideoDecoderFactory&gt; <span class="title">CreateExternalrideoDecoderFactory</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">H264DecoderImpl</span> : <span class="keyword">public</span> webrtc::VideoDecoder &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">H264DecoderImpl</span>(<span class="type">const</span> webrtc::Environment &amp;env);</span><br><span class="line">    ~<span class="built_in">H264DecoderImpl</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prepares decoder to handle incoming encoded frames. Can be called multiple</span></span><br><span class="line">    <span class="comment">// times, in such case only latest `settings` are in effect.</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">Configure</span><span class="params">(<span class="type">const</span> Settings&amp; settings)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO(bugs.webrtc.org/15444): Migrate all subclasses to Decode() without</span></span><br><span class="line">    <span class="comment">// missing_frame and delete this.</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int32_t</span> <span class="title">Decode</span><span class="params">(<span class="type">const</span> webrtc::EncodedImage&amp; input_image,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="type">bool</span> missing_frames,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="type">int64_t</span> render_time_ms)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int32_t</span> <span class="title">RegisterDecodeCompleteCallback</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        webrtc::DecodedImageCallback* callback)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int32_t</span> <span class="title">Release</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2024/08/10/WebRTC%E7%BC%96%E8%AF%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/08/10/WebRTC%E7%BC%96%E8%AF%91/" class="post-title-link" itemprop="url">WebRTC编译</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-08-10 09:39:07" itemprop="dateCreated datePublished" datetime="2024-08-10T09:39:07+08:00">2024-08-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-09-29 14:17:51" itemprop="dateModified" datetime="2024-09-29T14:17:51+08:00">2024-09-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/WebRTC/" itemprop="url" rel="index"><span itemprop="name">WebRTC</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="编译环境"><a href="#编译环境" class="headerlink" title="编译环境"></a>编译环境</h1><h2 id="mac"><a href="#mac" class="headerlink" title="mac"></a>mac</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mkdir WebRTC</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">git代理，配置成对应的代理</span></span><br><span class="line">git config --global http.proxy http://127.0.0.1:7890</span><br><span class="line">git config --global https.proxy http://127.0.0.1:7890</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取depot_tools</span></span><br><span class="line">git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git depot_tools</span><br><span class="line">vim ~/.zshrc</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加如下</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">depot_tools目录添加到系统PATH目录</span></span><br><span class="line">export PATH=$PATH:/Users/mac/WorkSpace/WebRTC/depot_tools</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使生效</span></span><br><span class="line">source ~/.zshrc</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">代理，配置成对应的代理</span></span><br><span class="line">export http_proxy=http://127.0.0.1:7890 </span><br><span class="line">export https_proxy=http://127.0.0.1:7890</span><br><span class="line">export all_proxy=socks5://127.0.0.1:7890</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">需要下载和更新一些工具，需要一定的时间</span></span><br><span class="line">gclient</span><br></pre></td></tr></table></figure>

<h2 id="win"><a href="#win" class="headerlink" title="win"></a>win</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">需要安装 vs2022 以及 win10sdk</span><br><span class="line">win10sdk下载地址：https://developer.microsoft.com/zh-cn/windows/downloads/sdk-archive/</span><br><span class="line">打开 x64 Native Tools Command Prompt for VS 2022 工具</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">git代理，配置成对应的代理</span></span><br><span class="line">git config --global http.proxy http://127.0.0.1:7890</span><br><span class="line">git config --global https.proxy http://127.0.0.1:7890</span><br><span class="line"></span><br><span class="line">mkdir WebRTC</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取depot_tools</span></span><br><span class="line">git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git depot_tools</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加环境变量</span></span><br><span class="line">depot_tools目录添加到系统PATH目录</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">首次执行 gclient <span class="built_in">sync</span> 将更新 depot_tools</span></span><br><span class="line">添加环境变量DEPOT_TOOLS_UPDATE=1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这个用于告诉 depot_tools 使用本地的 vs 版本，否则 depot_tools 使用 webrtc 内部的版本)</span></span><br><span class="line">添加系统变量DEPOT_TOOLS_WIN_TOOLCHAIN=0</span><br><span class="line"></span><br><span class="line">添加环境变量后，重新打开命令行工具</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">代理，配置成对应的代理</span></span><br><span class="line">set http_proxy=http://127.0.0.1:7890</span><br><span class="line">set https_proxy=http://127.0.0.1:7890</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">需要下载和更新一些工具，需要一定的时间</span></span><br><span class="line">gclient</span><br></pre></td></tr></table></figure>

<h1 id="获取源码"><a href="#获取源码" class="headerlink" title="获取源码"></a>获取源码</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取WebRTC源码</span></span><br><span class="line">cd WebRTC</span><br><span class="line">mkdir webrtc</span><br><span class="line">cd webrtc</span><br><span class="line">fetch --nohooks webrtc</span><br><span class="line">gclient sync # 此步骤，可能会因为网络等各种原因多次失败，重复执行即可</span><br></pre></td></tr></table></figure>

<h1 id="切换分支"><a href="#切换分支" class="headerlink" title="切换分支"></a>切换分支</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看所有的WebRTC分支:https://webrtc.googlesource.com/src/+/refs/heads/main/docs/release-notes.md</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">列出所有的分支</span></span><br><span class="line">git branch -r</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">切换到指定的分支(以M128为例子)</span></span><br><span class="line">git checkout -b M128 refs/remotes/branch-heads/6613 </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">更新依赖库</span></span><br><span class="line">gclient sync</span><br></pre></td></tr></table></figure>

<h1 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"># 构建</span><br><span class="line">cd webrtc/src</span><br><span class="line">gn gen out/Default</span><br><span class="line"></span><br><span class="line">vim out/Default/args.gn</span><br><span class="line"># Set build arguments here. See `gn help buildargs`.</span><br><span class="line"></span><br><span class="line"># 编译平台</span><br><span class="line">target_os=&quot;mac&quot;</span><br><span class="line"># target_os=&quot;win&quot;</span><br><span class="line"># 编译成arm64位版本</span><br><span class="line">target_cpu = &quot;arm64&quot;</span><br><span class="line"># target_cpu = &quot;amd64&quot;</span><br><span class="line"># 编译成debug版本</span><br><span class="line">is_debug = true</span><br><span class="line"># 编译时启用运行时类型信息功能，如果时false，使用libwebrtc.a产生连接错误如:typeinfo for webrtc::VideoTrackSource</span><br><span class="line">use_rtti=true</span><br><span class="line"># 导出符号</span><br><span class="line">rtc_enable_symbol_export=true</span><br><span class="line"></span><br><span class="line"># 不编译单元测试</span><br><span class="line">rtc_include_tests = false</span><br><span class="line"># 不将warning当成errros</span><br><span class="line">treat_warnings_as_errors = false</span><br><span class="line"># C++库默认使用了webrtc内部的C++库，与外部C++库abi不兼容</span><br><span class="line"># 由于符号不同可能会链接失败，侥幸编译通过，也会在运行时由于内存布局不一致，引发崩溃</span><br><span class="line">use_custom_libcxx=false</span><br><span class="line"></span><br><span class="line"># 不使用clang编译器，如果使用clang编译，集成到一些UI框架，可能无法使用</span><br><span class="line"># is_clang = false</span><br><span class="line"></span><br><span class="line"># 使用内置的h264，默认false</span><br><span class="line"># 关闭掉clang之后，如果启用内置的h264编解码，则无法编译通过</span><br><span class="line"># rtc_use_h264 = true</span><br><span class="line"></span><br><span class="line"># 编译</span><br><span class="line">ninja -C out/Default</span><br><span class="line"></span><br><span class="line"># 清理</span><br><span class="line">gn clean out/Default</span><br></pre></td></tr></table></figure>

<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><ul>
<li>补充，M128 版本使用如下报错</li>
</ul>
<p>使用 <code>webrtc::CreateBuiltinVideoEncoderFactory()</code> 和 <code>webrtc::CreateBuiltinVideoDecoderFactory()</code> 报错 <code>Undefined symbols for architecture arm64:webrtc::CreateBuiltinVideoDecoderFactory</code> 未找到该符号，需要手动添加编译。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cd webrtc/src</span><br><span class="line">修改 webrtc.gni</span><br><span class="line">在 rtc_include_builtin_audio_codecs = true 下面添加 </span><br><span class="line">   rtc_include_builtin_video_codecs = true</span><br><span class="line">修改 BUILD.gn</span><br><span class="line">添加</span><br><span class="line">if (rtc_include_builtin_video_codecs) &#123;</span><br><span class="line">  deps += [</span><br><span class="line">    &quot;api/video_codecs:builtin_video_decoder_factory&quot;,</span><br><span class="line">    &quot;api/video_codecs:builtin_video_encoder_factory&quot;,</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">然后重新编译</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2024/07/29/ByteTrack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/07/29/ByteTrack/" class="post-title-link" itemprop="url">ByteTrack</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-07-29 16:52:43" itemprop="dateCreated datePublished" datetime="2024-07-29T16:52:43+08:00">2024-07-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-07-31 20:26:27" itemprop="dateModified" datetime="2024-07-31T20:26:27+08:00">2024-07-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/DeepLearning/" itemprop="url" rel="index"><span itemprop="name">DeepLearning</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><strong>ByteTrack 伪代码</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">输入: A video sequence V; object detector Det; detection score threshold τ</span><br><span class="line">输出: Tracks T of the video</span><br><span class="line"></span><br><span class="line">初始化: T ← 0</span><br><span class="line">for frame fk in V do</span><br><span class="line">    /* Figure 2(a) */</span><br><span class="line">    /* predict detection boxes &amp; scores */</span><br><span class="line">    Dk ← Det(fk)</span><br><span class="line">    Dhigh ← 0</span><br><span class="line">    Dlow ← 0</span><br><span class="line">    for d in Dk do</span><br><span class="line">        if d.score &gt; τ then</span><br><span class="line">            Dhigh ← Dhigh ∪ &#123;d&#125;</span><br><span class="line">        end</span><br><span class="line">        else</span><br><span class="line">            Dlow ← Dlow ∪ &#123;d&#125;</span><br><span class="line">        end</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    /* predict new locations of tracks */</span><br><span class="line">    for t in T do</span><br><span class="line">        t ← KalmanFilter(t)</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    /* Figure 2(b) */</span><br><span class="line">    /* first association */</span><br><span class="line">    Associate T and Dhigh using Similarity#1</span><br><span class="line">    Dremain ← remaining object boxes from Dhigh</span><br><span class="line">    Tremain ← remaining tracks from T</span><br><span class="line">    </span><br><span class="line">    /* Figure 2(c) */</span><br><span class="line">    /* second association */</span><br><span class="line">    Associate Tremain and Dlow using similarity#2</span><br><span class="line">    Tre−remain ← remaining tracks from Tremain</span><br><span class="line">    </span><br><span class="line">    /* delete unmatched tracks */</span><br><span class="line">    T ← T \ Tre−remain</span><br><span class="line">    </span><br><span class="line">    /* initialize new tracks */</span><br><span class="line">    for d in Dremain do</span><br><span class="line">        T ← T ∪ &#123;d&#125;</span><br><span class="line">    end</span><br><span class="line">end</span><br><span class="line">Return: T</span><br></pre></td></tr></table></figure>

<p><strong>卡尔曼滤波</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> byte_kalman</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">double</span> KalmanFilter::chi2inv95[<span class="number">10</span>] = &#123; </span><br><span class="line">    <span class="number">0</span>,  </span><br><span class="line">    <span class="number">3.8415</span>,</span><br><span class="line">    <span class="number">5.9915</span>,</span><br><span class="line">    <span class="number">7.8147</span>,</span><br><span class="line">    <span class="number">9.4877</span>,</span><br><span class="line">    <span class="number">11.070</span>,</span><br><span class="line">    <span class="number">12.592</span>,</span><br><span class="line">    <span class="number">14.067</span>,</span><br><span class="line">    <span class="number">15.507</span>,</span><br><span class="line">    <span class="number">16.919</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    KalmanFilter::<span class="built_in">KalmanFilter</span>()</span><br><span class="line">    &#123;   </span><br><span class="line">        <span class="type">int</span> ndim = <span class="number">4</span>;</span><br><span class="line">        <span class="type">double</span> dt = <span class="number">1.</span>; </span><br><span class="line"></span><br><span class="line">        _motion_mat = Eigen::MatrixXf::<span class="built_in">Identity</span>(<span class="number">8</span>, <span class="number">8</span>); </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; ndim; i++) &#123;</span><br><span class="line">            _motion_mat(i, ndim + i) = dt; </span><br><span class="line">        &#125;   </span><br><span class="line">        _update_mat = Eigen::MatrixXf::<span class="built_in">Identity</span>(<span class="number">4</span>, <span class="number">8</span>); </span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>-&gt;_std_weight_position = <span class="number">1.</span> / <span class="number">20</span>; </span><br><span class="line">        <span class="keyword">this</span>-&gt;_std_weight_velocity = <span class="number">1.</span> / <span class="number">160</span>;</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    <span class="function">KAL_DATA <span class="title">KalmanFilter::initiate</span><span class="params">(<span class="type">const</span> DETECTBOX &amp;measurement)</span></span></span><br><span class="line"><span class="function">    </span>&#123;   </span><br><span class="line">        DETECTBOX mean_pos = measurement;</span><br><span class="line">        DETECTBOX mean_vel;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) <span class="built_in">mean_vel</span>(i) = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 初始化均值向量 [x中心坐标, y中心坐标, 宽度, 高度, x速度, y速度, 宽度变化, 高度变化]</span></span><br><span class="line">        KAL_MEAN mean;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i &lt; <span class="number">4</span>) <span class="built_in">mean</span>(i) = <span class="built_in">mean_pos</span>(i);</span><br><span class="line">            <span class="keyword">else</span> <span class="built_in">mean</span>(i) = <span class="built_in">mean_vel</span>(i - <span class="number">4</span>); </span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 初始化标准差向量</span></span><br><span class="line">        KAL_MEAN std;</span><br><span class="line">        <span class="built_in">std</span>(<span class="number">0</span>) = <span class="number">2</span> * _std_weight_position * measurement[<span class="number">3</span>];</span><br><span class="line">        <span class="built_in">std</span>(<span class="number">1</span>) = <span class="number">2</span> * _std_weight_position * measurement[<span class="number">3</span>];</span><br><span class="line">        <span class="built_in">std</span>(<span class="number">2</span>) = <span class="number">1e-2</span>;</span><br><span class="line">        <span class="built_in">std</span>(<span class="number">3</span>) = <span class="number">2</span> * _std_weight_position * measurement[<span class="number">3</span>];</span><br><span class="line">        <span class="built_in">std</span>(<span class="number">4</span>) = <span class="number">10</span> * _std_weight_velocity * measurement[<span class="number">3</span>];</span><br><span class="line">        <span class="built_in">std</span>(<span class="number">5</span>) = <span class="number">10</span> * _std_weight_velocity * measurement[<span class="number">3</span>];</span><br><span class="line">        <span class="built_in">std</span>(<span class="number">6</span>) = <span class="number">1e-5</span>;</span><br><span class="line">        <span class="built_in">std</span>(<span class="number">7</span>) = <span class="number">10</span> * _std_weight_velocity * measurement[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将平方的标准差转换为协方差矩阵的对角线元素</span></span><br><span class="line">        KAL_MEAN tmp = std.<span class="built_in">array</span>().<span class="built_in">square</span>();</span><br><span class="line">        KAL_COVA var = tmp.<span class="built_in">asDiagonal</span>();</span><br><span class="line">        <span class="comment">// 返回均值和协方差矩阵</span></span><br><span class="line">        <span class="keyword">return</span> std::<span class="built_in">make_pair</span>(mean, var);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">KalmanFilter::predict</span><span class="params">(KAL_MEAN &amp;mean, KAL_COVA &amp;covariance)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//revise the data;</span></span><br><span class="line">        DETECTBOX std_pos;</span><br><span class="line">        std_pos &lt;&lt; <span class="function">_std_weight_position * <span class="title">mean</span><span class="params">(<span class="number">3</span>)</span>,</span></span><br><span class="line"><span class="function">            _std_weight_position * <span class="title">mean</span><span class="params">(<span class="number">3</span>)</span>,</span></span><br><span class="line"><span class="function">            1e-2,</span></span><br><span class="line"><span class="function">            _std_weight_position * <span class="title">mean</span><span class="params">(<span class="number">3</span>)</span></span>;</span><br><span class="line">        DETECTBOX std_vel;</span><br><span class="line">        std_vel &lt;&lt; <span class="function">_std_weight_velocity * <span class="title">mean</span><span class="params">(<span class="number">3</span>)</span>,</span></span><br><span class="line"><span class="function">            _std_weight_velocity * <span class="title">mean</span><span class="params">(<span class="number">3</span>)</span>,</span></span><br><span class="line"><span class="function">            1e-5,</span></span><br><span class="line"><span class="function">            _std_weight_velocity * <span class="title">mean</span><span class="params">(<span class="number">3</span>)</span></span>;</span><br><span class="line">        KAL_MEAN tmp;</span><br><span class="line">        tmp.<span class="built_in">block</span>&lt;<span class="number">1</span>, <span class="number">4</span>&gt;(<span class="number">0</span>, <span class="number">0</span>) = std_pos;</span><br><span class="line">        tmp.<span class="built_in">block</span>&lt;<span class="number">1</span>, <span class="number">4</span>&gt;(<span class="number">0</span>, <span class="number">4</span>) = std_vel;</span><br><span class="line">        tmp = tmp.<span class="built_in">array</span>().<span class="built_in">square</span>();</span><br><span class="line">        KAL_COVA motion_cov = tmp.<span class="built_in">asDiagonal</span>();</span><br><span class="line">        <span class="comment">// 预测值 = 状态矩阵 x 当前均值向量</span></span><br><span class="line">        KAL_MEAN mean1 = <span class="keyword">this</span>-&gt;_motion_mat * mean.<span class="built_in">transpose</span>();</span><br><span class="line">        <span class="comment">// 协方差矩阵</span></span><br><span class="line">        KAL_COVA covariance1 = <span class="keyword">this</span>-&gt;_motion_mat * covariance *(_motion_mat.<span class="built_in">transpose</span>());</span><br><span class="line">        <span class="comment">// 协方差矩阵 + 噪声</span></span><br><span class="line">        covariance1 += motion_cov;</span><br><span class="line"></span><br><span class="line">        mean = mean1;</span><br><span class="line">        covariance = covariance1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">KAL_HDATA <span class="title">KalmanFilter::project</span><span class="params">(<span class="type">const</span> KAL_MEAN &amp;mean, <span class="type">const</span> KAL_COVA &amp;covariance)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        DETECTBOX std;</span><br><span class="line">        std &lt;&lt; <span class="function">_std_weight_position * <span class="title">mean</span><span class="params">(<span class="number">3</span>)</span>, _std_weight_position * <span class="title">mean</span><span class="params">(<span class="number">3</span>)</span>,</span></span><br><span class="line"><span class="function">            1e-1, _std_weight_position * <span class="title">mean</span><span class="params">(<span class="number">3</span>)</span></span>;</span><br><span class="line">        KAL_HMEAN mean1 = _update_mat * mean.<span class="built_in">transpose</span>();</span><br><span class="line">        KAL_HCOVA covariance1 = _update_mat * covariance * (_update_mat.<span class="built_in">transpose</span>());</span><br><span class="line">        Eigen::Matrix&lt;<span class="type">float</span>, <span class="number">4</span>, <span class="number">4</span>&gt; diag = std.<span class="built_in">asDiagonal</span>();</span><br><span class="line">        diag = diag.<span class="built_in">array</span>().<span class="built_in">square</span>().<span class="built_in">matrix</span>();</span><br><span class="line">        covariance1 += diag;</span><br><span class="line">        <span class="comment">//    covariance1.diagonal() &lt;&lt; diag;</span></span><br><span class="line">        <span class="keyword">return</span> std::<span class="built_in">make_pair</span>(mean1, covariance1);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获得新的观测数据后更新滤波器的状态估计</span></span><br><span class="line">    <span class="function">KAL_DATA <span class="title">KalmanFilter::update</span><span class="params">(<span class="type">const</span> KAL_MEAN &amp;mean, </span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="type">const</span> KAL_COVA &amp;covariance, </span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="type">const</span> DETECTBOX &amp;measurement)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        KAL_HDATA pa = <span class="built_in">project</span>(mean, covariance);</span><br><span class="line">        KAL_HMEAN projected_mean = pa.first;</span><br><span class="line">        KAL_HCOVA projected_cov = pa.second;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//chol_factor, lower =</span></span><br><span class="line">        <span class="comment">//scipy.linalg.cho_factor(projected_cov, lower=True, check_finite=False)</span></span><br><span class="line">        <span class="comment">//kalmain_gain =</span></span><br><span class="line">        <span class="comment">//scipy.linalg.cho_solve((cho_factor, lower),</span></span><br><span class="line">        <span class="comment">//np.dot(covariance, self._upadte_mat.T).T,</span></span><br><span class="line">        <span class="comment">//check_finite=False).T</span></span><br><span class="line">        Eigen::Matrix&lt;<span class="type">float</span>, <span class="number">4</span>, <span class="number">8</span>&gt; B = (covariance * (_update_mat.<span class="built_in">transpose</span>())).<span class="built_in">transpose</span>();</span><br><span class="line">        <span class="comment">// 卡尔曼增益</span></span><br><span class="line">        Eigen::Matrix&lt;<span class="type">float</span>, <span class="number">8</span>, <span class="number">4</span>&gt; kalman_gain = (projected_cov.<span class="built_in">llt</span>().<span class="built_in">solve</span>(B)).<span class="built_in">transpose</span>(); <span class="comment">// eg.8x4</span></span><br><span class="line">        Eigen::Matrix&lt;<span class="type">float</span>, <span class="number">1</span>, <span class="number">4</span>&gt; innovation = measurement - projected_mean; <span class="comment">//eg.1x4</span></span><br><span class="line">        <span class="keyword">auto</span> tmp = innovation * (kalman_gain.<span class="built_in">transpose</span>());</span><br><span class="line">        KAL_MEAN new_mean = (mean.<span class="built_in">array</span>() + tmp.<span class="built_in">array</span>()).<span class="built_in">matrix</span>();</span><br><span class="line">        KAL_COVA new_covariance = covariance - kalman_gain * projected_cov*(kalman_gain.<span class="built_in">transpose</span>());</span><br><span class="line">        <span class="comment">// 返回更新后的均值和协方差</span></span><br><span class="line">        <span class="keyword">return</span> std::<span class="built_in">make_pair</span>(new_mean, new_covariance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">Eigen::Matrix&lt;<span class="type">float</span>, 1, -1&gt;</span></span><br><span class="line"><span class="function">        <span class="title">KalmanFilter::gating_distance</span><span class="params">(<span class="type">const</span> KAL_MEAN &amp;mean,</span></span></span><br><span class="line"><span class="params"><span class="function">                                      <span class="type">const</span> KAL_COVA &amp;covariance,</span></span></span><br><span class="line"><span class="params"><span class="function">                                      <span class="type">const</span> std::vector&lt;DETECTBOX&gt; &amp;measurements,</span></span></span><br><span class="line"><span class="params"><span class="function">                                      <span class="type">bool</span> only_position)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        KAL_HDATA pa = <span class="keyword">this</span>-&gt;<span class="built_in">project</span>(mean, covariance);</span><br><span class="line">        <span class="keyword">if</span> (only_position) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;not implement!&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        KAL_HMEAN mean1 = pa.first;</span><br><span class="line">        KAL_HCOVA covariance1 = pa.second;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//    Eigen::Matrix&lt;float, -1, 4, Eigen::RowMajor&gt; d(size, 4);</span></span><br><span class="line">        <span class="function">DETECTBOXSS <span class="title">d</span><span class="params">(measurements.size(), <span class="number">4</span>)</span></span>;</span><br><span class="line">        <span class="type">int</span> pos = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (DETECTBOX box : measurements) &#123;</span><br><span class="line">            d.<span class="built_in">row</span>(pos++) = box - mean1;</span><br><span class="line">        &#125;</span><br><span class="line">        Eigen::Matrix&lt;<span class="type">float</span>, <span class="number">-1</span>, <span class="number">-1</span>, Eigen::RowMajor&gt; factor = covariance1.<span class="built_in">llt</span>().<span class="built_in">matrixL</span>();</span><br><span class="line">        Eigen::Matrix&lt;<span class="type">float</span>, <span class="number">-1</span>, <span class="number">-1</span>&gt; z = </span><br><span class="line">            factor.<span class="built_in">triangularView</span>&lt;Eigen::Lower&gt;().<span class="built_in">solve</span>&lt;Eigen::OnTheRight&gt;(d).<span class="built_in">transpose</span>();</span><br><span class="line">        <span class="keyword">auto</span> zz = ((z.<span class="built_in">array</span>())*(z.<span class="built_in">array</span>())).<span class="built_in">matrix</span>();</span><br><span class="line">        <span class="keyword">auto</span> square_maha = zz.<span class="built_in">colwise</span>().<span class="built_in">sum</span>();</span><br><span class="line">        <span class="keyword">return</span> square_maha;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>计算 IOU 代价矩阵</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">vector&lt;vector&lt;<span class="type">float</span>&gt; &gt; BYTETracker::<span class="built_in">iou_distance</span>(vector&lt;STrack*&gt; &amp;atracks,</span><br><span class="line">                                                 vector&lt;STrack&gt; &amp;btracks,</span><br><span class="line">                                                 <span class="type">int</span> &amp;dist_size,</span><br><span class="line">                                                 <span class="type">int</span> &amp;dist_size_size)</span><br><span class="line">&#123;</span><br><span class="line">    vector&lt;vector&lt;<span class="type">float</span>&gt; &gt; cost_matrix;</span><br><span class="line">    <span class="keyword">if</span> (atracks.<span class="built_in">size</span>() * btracks.<span class="built_in">size</span>() == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        dist_size = atracks.<span class="built_in">size</span>();</span><br><span class="line">        dist_size_size = btracks.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">return</span> cost_matrix;</span><br><span class="line">    &#125;</span><br><span class="line">    vector&lt;vector&lt;<span class="type">float</span>&gt; &gt; atlbrs, btlbrs;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; atracks.<span class="built_in">size</span>(); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        atlbrs.<span class="built_in">push_back</span>(atracks[i]-&gt;tlbr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; btracks.<span class="built_in">size</span>(); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        btlbrs.<span class="built_in">push_back</span>(btracks[i].tlbr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dist_size = atracks.<span class="built_in">size</span>();</span><br><span class="line">    dist_size_size = btracks.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">    vector&lt;vector&lt;<span class="type">float</span>&gt; &gt; _ious = <span class="built_in">ious</span>(atlbrs, btlbrs);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; _ious.<span class="built_in">size</span>();i++)</span><br><span class="line">    &#123;</span><br><span class="line">        vector&lt;<span class="type">float</span>&gt; _iou;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; _ious[i].<span class="built_in">size</span>(); j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// box重合部分越大，代价越小</span></span><br><span class="line">            _iou.<span class="built_in">push_back</span>(<span class="number">1</span> - _ious[i][j]);</span><br><span class="line">        &#125;</span><br><span class="line">        cost_matrix.<span class="built_in">push_back</span>(_iou);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cost_matrix;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>计算 IOU</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">vector&lt;vector&lt;<span class="type">float</span>&gt; &gt; BYTETracker::<span class="built_in">ious</span>(vector&lt;vector&lt;<span class="type">float</span>&gt; &gt; &amp;atlbrs, vector&lt;vector&lt;<span class="type">float</span>&gt; &gt; &amp;btlbrs)</span><br><span class="line">&#123;</span><br><span class="line">    vector&lt;vector&lt;<span class="type">float</span>&gt; &gt; ious;</span><br><span class="line">    <span class="keyword">if</span> (atlbrs.<span class="built_in">size</span>()*btlbrs.<span class="built_in">size</span>() == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> ious;</span><br><span class="line"></span><br><span class="line">    ious.<span class="built_in">resize</span>(atlbrs.<span class="built_in">size</span>());</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; ious.<span class="built_in">size</span>(); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        ious[i].<span class="built_in">resize</span>(btlbrs.<span class="built_in">size</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//bbox_ious</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> k = <span class="number">0</span>; k &lt; btlbrs.<span class="built_in">size</span>(); k++)</span><br><span class="line">    &#123;</span><br><span class="line">        vector&lt;<span class="type">float</span>&gt; ious_tmp;</span><br><span class="line">        <span class="type">float</span> box_area = (btlbrs[k][<span class="number">2</span>] - btlbrs[k][<span class="number">0</span>] + <span class="number">1</span>)*(btlbrs[k][<span class="number">3</span>] - btlbrs[k][<span class="number">1</span>] + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> n = <span class="number">0</span>; n &lt; atlbrs.<span class="built_in">size</span>(); n++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">float</span> iw = <span class="built_in">min</span>(atlbrs[n][<span class="number">2</span>], btlbrs[k][<span class="number">2</span>]) - <span class="built_in">max</span>(atlbrs[n][<span class="number">0</span>], btlbrs[k][<span class="number">0</span>]) + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (iw &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">float</span> ih = <span class="built_in">min</span>(atlbrs[n][<span class="number">3</span>], btlbrs[k][<span class="number">3</span>]) - <span class="built_in">max</span>(atlbrs[n][<span class="number">1</span>], btlbrs[k][<span class="number">1</span>]) + <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span>(ih &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="type">float</span> ua = (atlbrs[n][<span class="number">2</span>] - atlbrs[n][<span class="number">0</span>] + <span class="number">1</span>)*(atlbrs[n][<span class="number">3</span>] - atlbrs[n][<span class="number">1</span>] + <span class="number">1</span>) +</span><br><span class="line">                        box_area - iw * ih;</span><br><span class="line">                    ious[n][k] = iw * ih / ua;  <span class="comment">// 计算两个box的交集占全部面积的比值</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    ious[n][k] = <span class="number">0.0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                ious[n][k] = <span class="number">0.0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ious;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>匈牙利算法</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">BYTETracker::linear_assignment</span><span class="params">(vector&lt;vector&lt;<span class="type">float</span>&gt; &gt; &amp;cost_matrix,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    <span class="type">int</span> cost_matrix_size,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    <span class="type">int</span> cost_matrix_size_size,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    <span class="type">float</span> thresh,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    vector&lt;vector&lt;<span class="type">int</span>&gt; &gt; &amp;matches,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    vector&lt;<span class="type">int</span>&gt; &amp;unmatched_a,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    vector&lt;<span class="type">int</span>&gt; &amp;unmatched_b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (cost_matrix.<span class="built_in">size</span>() == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; cost_matrix_size; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            unmatched_a.<span class="built_in">push_back</span>(i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; cost_matrix_size_size; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            unmatched_b.<span class="built_in">push_back</span>(i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vector&lt;<span class="type">int</span>&gt; rowsol; vector&lt;<span class="type">int</span>&gt; colsol;</span><br><span class="line">    <span class="type">float</span> c = <span class="built_in">lapjv</span>(cost_matrix, rowsol, colsol, <span class="literal">true</span>, thresh);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; rowsol.<span class="built_in">size</span>(); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (rowsol[i] &gt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            vector&lt;<span class="type">int</span>&gt; match;</span><br><span class="line">            match.<span class="built_in">push_back</span>(i);</span><br><span class="line">            match.<span class="built_in">push_back</span>(rowsol[i]);</span><br><span class="line">            matches.<span class="built_in">push_back</span>(match);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            unmatched_a.<span class="built_in">push_back</span>(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; colsol.<span class="built_in">size</span>(); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (colsol[i] &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            unmatched_b.<span class="built_in">push_back</span>(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ByteTrack 示例</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">conda create -n bytetrack python=3.8</span><br><span class="line">conda activate bytetrack</span><br><span class="line"></span><br><span class="line"># 参考 https://github.com/ifzhang/ByteTrack Dockerfile</span><br><span class="line">git clone https://github.com/ifzhang/ByteTrack</span><br><span class="line">cd ByteTrack</span><br><span class="line">git checkout 8df560f2c85518f2512399cae0d493933d32f548</span><br><span class="line">mkdir -p YOLOX_outputs/yolox_x_mix_det/track_vis</span><br><span class="line">sed -i &#x27;s/numpy/numpy==1.23.5/g&#x27; requirements.txt</span><br><span class="line">sed -i &#x27;s/torch&gt;=1.7/torch==1.9.1+cu111/g&#x27; requirements.txt</span><br><span class="line">sed -i &#x27;s/torchvision==0.10.0/torchvision==0.10.1+cu111/g&#x27; requirements.txt</span><br><span class="line">sed -i &quot;s/&#x27;cuda:6&#x27;/0/g&quot; tools/demo_track.py</span><br><span class="line">pip3 install -r requirements.txt -f https://download.pytorch.org/whl/torch_stable.html</span><br><span class="line">python3 setup.py develop</span><br><span class="line">pip3 install cython</span><br><span class="line">pip3 install &#x27;git+https://github.com/cocodataset/cocoapi.git#subdirectory=PythonAPI&#x27;</span><br><span class="line">pip3 install cython_bbox gdown</span><br><span class="line">ldconfig</span><br><span class="line">pip cache purge</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># bytetrack_x_mot17.pth.tar 下载参考https://github.com/ifzhang/ByteTrack</span><br><span class="line">python3 tools/demo_track.py video -f exps/example/mot/yolox_x_mix_det.py -c pretrained/bytetrack_x_mot17.pth.tar --fp16 --fuse --save_result</span><br></pre></td></tr></table></figure>

<p>参考链接：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/CV_Autobot/article/details/129096035">匈牙利匹配算法</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zxy_ZXY123/article/details/136472356">卡尔曼滤波</a></p>
<p><a target="_blank" rel="noopener" href="https://arxiv.org/pdf/2110.06864">ByteTrack</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2024/07/22/YOLOv5%E8%AE%AD%E7%BB%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/07/22/YOLOv5%E8%AE%AD%E7%BB%83/" class="post-title-link" itemprop="url">YOLOv5训练</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-07-22 19:04:20 / Modified: 20:48:56" itemprop="dateCreated datePublished" datetime="2024-07-22T19:04:20+08:00">2024-07-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/DeepLearning/" itemprop="url" rel="index"><span itemprop="name">DeepLearning</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h1><p>系统环境：</p>
<ul>
<li>操作系统：ubuntu16.04</li>
<li>显卡：Tesla T4</li>
<li>显卡驱动：460.39</li>
</ul>
<p>YOLOv5 下载：</p>
<ul>
<li>YOLO v5&#x2F;v6.0 <a target="_blank" rel="noopener" href="https://github.com/ultralytics/yolov5/archive/refs/tags/v6.0.tar.gz">源代码</a> </li>
<li>预训练模型 <a target="_blank" rel="noopener" href="https://github.com/ultralytics/yolov5/releases/download/v6.0/yolov5s.pt">yolov5s.pt</a></li>
</ul>
<p>依赖环境：</p>
<ul>
<li><p>下载 Anaconda，创建 <code>conda create -n yolo_v5 python=3.8</code>，并进入 <code>conda activate yolo_v5</code></p>
</li>
<li><p>安装 torch gpu 版本 <code>pip install torch==1.8.1+cu111 torchvision==0.9.1+cu111 torchaudio==0.8.1 -f https://download.pytorch.org/whl/torch_stable.html</code> 参考 <a target="_blank" rel="noopener" href="https://pytorch.org/get-started/previous-versions/">https://pytorch.org/get-started/previous-versions/</a></p>
</li>
<li><p>修改 YOLOv5 的源代码中的 requirements.txt 文件后安装 <code>pip install -r requirements.txt</code></p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"># pip install -r requirements.txt</span><br><span class="line">  </span><br><span class="line"># Base ----------------------------------------</span><br><span class="line">matplotlib==3.2.2</span><br><span class="line">numpy==1.18.5</span><br><span class="line">opencv-python==4.1.2.30</span><br><span class="line">Pillow==7.1.2</span><br><span class="line">PyYAML==5.3.1</span><br><span class="line">requests==2.23.0</span><br><span class="line">scipy==1.4.1</span><br><span class="line"># torch&gt;=1.7.0</span><br><span class="line"># torchvision&gt;=0.8.1</span><br><span class="line">tqdm==4.41.0</span><br><span class="line"></span><br><span class="line"># Logging -------------------------------------</span><br><span class="line">tensorboard==2.4.1</span><br><span class="line"># wandb</span><br><span class="line"></span><br><span class="line"># Plotting ------------------------------------</span><br><span class="line">pandas==1.1.4</span><br><span class="line">seaborn==0.11.0</span><br><span class="line"></span><br><span class="line"># Export --------------------------------------</span><br><span class="line"># coremltools&gt;=4.1  # CoreML export</span><br><span class="line"># onnx&gt;=1.9.0  # ONNX export</span><br><span class="line"># onnx-simplifier&gt;=0.3.6  # ONNX simplifier</span><br><span class="line"># scikit-learn==0.19.2  # CoreML quantization</span><br><span class="line"># tensorflow&gt;=2.4.1  # TFLite export</span><br><span class="line"># tensorflowjs&gt;=3.9.0  # TF.js export</span><br><span class="line"></span><br><span class="line"># Extras --------------------------------------</span><br><span class="line"># albumentations&gt;=1.0.3</span><br><span class="line"># Cython  # for pycocotools https://github.com/cocodataset/cocoapi/issues/172</span><br><span class="line"># pycocotools&gt;=2.0  # COCO mAP</span><br><span class="line"># roboflow</span><br><span class="line">thop  # FLOPs computation</span><br></pre></td></tr></table></figure>

<h1 id="生成数据集"><a href="#生成数据集" class="headerlink" title="生成数据集"></a>生成数据集</h1><ul>
<li><p>分别创建 <code>test</code>、<code>train</code> 和 <code>val</code> 目录，各个目录分别创建 <code>images</code> 和 <code>labels</code> 目录</p>
<ul>
<li><p><code>images</code> 用于存储图片</p>
</li>
<li><p><code>labels</code> 用于存储标签</p>
<ul>
<li>每个文件对应 <code>images</code> 中的图片名称后缀变成 .txt</li>
<li>每个目标对应一行</li>
<li>其中每一行格式为 <code>class x_center y_center width height</code></li>
<li>归一化 xywh，将 <code>x_center</code> 和 <code>width</code> 除以图片宽度，<code>y_center</code> 和 <code>height</code> 除以图片高度</li>
<li>类别数字从零开始索引</li>
</ul>
</li>
</ul>
</li>
<li><p>创建 <code>data/mydataset.yml</code> 文件</p>
<ul>
<li>修改数据集的路径</li>
<li>修改类别数量以及名字</li>
</ul>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Train/val/test sets as 1) dir: path/to/imgs, 2) file: path/to/imgs.txt, or 3) list: [path/to/imgs1, path/to/imgs2, ..]</span></span><br><span class="line"><span class="attr">path:</span> <span class="string">/path/data/dataset</span>  <span class="comment"># dataset root dir</span></span><br><span class="line"><span class="attr">train:</span> <span class="string">train/images</span>  <span class="comment"># train images (relative to &#x27;path&#x27;) 128 images</span></span><br><span class="line"><span class="attr">val:</span> <span class="string">val/images</span>  <span class="comment"># val images (relative to &#x27;path&#x27;) 128 images</span></span><br><span class="line"><span class="attr">test:</span> <span class="string">test/images</span>  <span class="comment"># test images (optional)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Classes</span></span><br><span class="line"><span class="attr">nc:</span> <span class="number">11</span>  <span class="comment"># number of classes</span></span><br><span class="line"><span class="attr">names:</span> [<span class="string">&quot;animals&quot;</span>, <span class="string">&quot;cat&quot;</span>, <span class="string">&quot;chicken&quot;</span>, <span class="string">&quot;cow&quot;</span>, <span class="string">&quot;dog&quot;</span>, <span class="string">&quot;fox&quot;</span>, <span class="string">&quot;goat&quot;</span>, <span class="string">&quot;horse&quot;</span>, <span class="string">&quot;person&quot;</span>, <span class="string">&quot;racoon&quot;</span>, <span class="string">&quot;skunk&quot;</span>]  <span class="comment"># class names</span></span><br></pre></td></tr></table></figure>

<h1 id="训练"><a href="#训练" class="headerlink" title="训练"></a>训练</h1><p><code>python train.py --weights ./yolov5s.pt --cfg ./models/yolov5s.yaml --data ./data/mydataset.yaml --device 0,1</code></p>
<p>训练完成后在当前目录 <code>runs/train/exp/weights</code> 生成 best.pt 和 last.pt</p>
<h1 id="预测"><a href="#预测" class="headerlink" title="预测"></a>预测</h1><p><code>python detect.py --weights ./runs/train/exp/weights/best.pt --source ./data/dataset/test/images --device 0</code></p>
<p>预测完成后的图片当前目录 <code>runs/detect/exp/</code></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fang0407.github.io/2024/07/19/LeNet/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NOTE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | NOTE">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/07/19/LeNet/" class="post-title-link" itemprop="url">LeNet</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-07-19 09:10:58 / Modified: 09:12:45" itemprop="dateCreated datePublished" datetime="2024-07-19T09:10:58+08:00">2024-07-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/DeepLearning/" itemprop="url" rel="index"><span itemprop="name">DeepLearning</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Fashion-MNIST 是一个服装分类数据集，由 10 个类别的图像组成。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torchvision</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_data_fashion_mnist</span>(<span class="params">batch_size, resize=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;下载Fashion-MNIST数据集，然后将其加载到内存中&quot;&quot;&quot;</span></span><br><span class="line">    trans = [torchvision.transforms.ToTensor()]</span><br><span class="line">    <span class="keyword">if</span> resize:</span><br><span class="line">        trans.insert(<span class="number">0</span>, transforms.Resize(resize))</span><br><span class="line">    trans = torchvision.transforms.Compose(trans)</span><br><span class="line">    mnist_train = torchvision.datasets.FashionMNIST(</span><br><span class="line">        root=<span class="string">&quot;../data&quot;</span>, train=<span class="literal">True</span>, transform=trans, download=<span class="literal">True</span>)</span><br><span class="line">    mnist_test = torchvision.datasets.FashionMNIST(</span><br><span class="line">        root=<span class="string">&quot;../data&quot;</span>, train=<span class="literal">False</span>, transform=trans, download=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">return</span> (torch.utils.data.DataLoader(mnist_train, batch_size, shuffle=<span class="literal">True</span>, num_workers=<span class="number">4</span>),</span><br><span class="line">            torch.utils.data.DataLoader(mnist_test, batch_size, shuffle=<span class="literal">False</span>, num_workers=<span class="number">4</span>)</span><br></pre></td></tr></table></figure>

<p>LeNet-5 由两部分组成：由两个卷积层和三个全连接层组成。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">X = torch.rand(size=(<span class="number">1</span>, <span class="number">1</span>, <span class="number">28</span>, <span class="number">28</span>), dtype=torch.float32)</span><br><span class="line"><span class="keyword">for</span> layer <span class="keyword">in</span> Lenet():</span><br><span class="line">    X = layer(X)</span><br><span class="line">    <span class="built_in">print</span>(layer.__class__.__name__,<span class="string">&#x27;output shape: \t&#x27;</span>,X.shape)</span><br><span class="line">    </span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Conv2d output shape:         torch.Size([1, 6, 28, 28])</span></span><br><span class="line"><span class="string">Sigmoid output shape:        torch.Size([1, 6, 28, 28])</span></span><br><span class="line"><span class="string">AvgPool2d output shape:      torch.Size([1, 6, 14, 14])</span></span><br><span class="line"><span class="string">Conv2d output shape:         torch.Size([1, 16, 10, 10])</span></span><br><span class="line"><span class="string">Sigmoid output shape:        torch.Size([1, 16, 10, 10])</span></span><br><span class="line"><span class="string">AvgPool2d output shape:      torch.Size([1, 16, 5, 5])</span></span><br><span class="line"><span class="string">Flatten output shape:        torch.Size([1, 400])</span></span><br><span class="line"><span class="string">Linear output shape:         torch.Size([1, 120])</span></span><br><span class="line"><span class="string">Sigmoid output shape:        torch.Size([1, 120])</span></span><br><span class="line"><span class="string">Linear output shape:         torch.Size([1, 84])</span></span><br><span class="line"><span class="string">Sigmoid output shape:        torch.Size([1, 84])</span></span><br><span class="line"><span class="string">Linear output shape:         torch.Size([1, 10])</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>LeNet-5 模型训练。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torchvision</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Lenet</span>(torch.nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Lenet-5网络实现&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(Lenet, self).__init__()</span><br><span class="line">        self.net = torch.nn.Sequential(</span><br><span class="line">                torch.nn.Conv2d(<span class="number">1</span>, <span class="number">6</span>, kernel_size=<span class="number">5</span>, padding=<span class="number">2</span>),</span><br><span class="line">                torch.nn.Sigmoid(),</span><br><span class="line">                torch.nn.AvgPool2d(kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>),</span><br><span class="line">                torch.nn.Conv2d(<span class="number">6</span>, <span class="number">16</span>, kernel_size=<span class="number">5</span>),</span><br><span class="line">                torch.nn.Sigmoid(),</span><br><span class="line">                torch.nn.AvgPool2d(kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>),</span><br><span class="line">                torch.nn.Flatten(),</span><br><span class="line">                torch.nn.Linear(<span class="number">16</span> * <span class="number">5</span> * <span class="number">5</span>, <span class="number">120</span>),</span><br><span class="line">                torch.nn.Sigmoid(),</span><br><span class="line">                torch.nn.Linear(<span class="number">120</span>, <span class="number">84</span>),</span><br><span class="line">                torch.nn.Sigmoid(),</span><br><span class="line">                torch.nn.Linear(<span class="number">84</span>, <span class="number">10</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="keyword">return</span> self.net(x)</span><br><span class="line">      </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">try_mps</span>():</span><br><span class="line">    <span class="keyword">return</span> torch.device(<span class="string">&#x27;mps&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">accuracy</span>(<span class="params">y_hat, y</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;计算预测正确的数量&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(y_hat.shape) &gt; <span class="number">1</span> <span class="keyword">and</span> y_hat.shape[<span class="number">1</span>] &gt; <span class="number">1</span>:</span><br><span class="line">        y_hat = y_hat.argmax(axis=<span class="number">1</span>)</span><br><span class="line">    cmp = y_hat == y</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">float</span>(cmp.<span class="built_in">sum</span>() / <span class="built_in">len</span>(cmp))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">evaluate_accuracy_gpu</span>(<span class="params">net, data_iter, device=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(net, torch.nn.Module):</span><br><span class="line">        net.<span class="built_in">eval</span>()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> device:</span><br><span class="line">            device = <span class="built_in">next</span>(<span class="built_in">iter</span>(net.parameters())).device</span><br><span class="line">    test_acc = []</span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        <span class="keyword">for</span> X, y <span class="keyword">in</span> data_iter:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(X, <span class="built_in">list</span>):</span><br><span class="line">                X = [x.to(device) <span class="keyword">for</span> x <span class="keyword">in</span> X]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                X = X.to(device)</span><br><span class="line">            y = y.to(device)</span><br><span class="line">            test_acc.append(accuracy(net(X), y))</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sum</span>(test_acc) / <span class="built_in">len</span>(test_acc)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train</span>(<span class="params">net, train_iter, test_iter, device</span>):</span><br><span class="line">    lr, num_epochs = <span class="number">0.9</span>, <span class="number">10</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">init_weights</span>(<span class="params">m</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(m) == torch.nn.Linear <span class="keyword">or</span> <span class="built_in">type</span>(m) == torch.nn.Conv2d:</span><br><span class="line">            torch.nn.init.xavier_uniform_(m.weight)</span><br><span class="line">    net.apply(init_weights)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;training on&#x27;</span>, device)</span><br><span class="line">    net.to(device)</span><br><span class="line">    optimizer = torch.optim.SGD(net.parameters(), lr=lr)</span><br><span class="line">    loss = torch.nn.CrossEntropyLoss()</span><br><span class="line">    num_batches = <span class="built_in">len</span>(train_iter)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(num_epochs):</span><br><span class="line">        net.train()</span><br><span class="line">        <span class="keyword">for</span> i, (X, Y) <span class="keyword">in</span> <span class="built_in">enumerate</span>(train_iter):</span><br><span class="line">            optimizer.zero_grad()</span><br><span class="line"></span><br><span class="line">            X, Y = X.to(device), Y.to(device)</span><br><span class="line">            y_hat = net(X)</span><br><span class="line">            l = loss(y_hat, Y)</span><br><span class="line">            l.backward()</span><br><span class="line">            optimizer.step()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i + <span class="number">1</span>) % (num_batches // <span class="number">5</span>) == <span class="number">0</span> <span class="keyword">or</span> i == num_batches - <span class="number">1</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;loss:&#x27;</span>, l, <span class="string">&#x27;train_acc:&#x27;</span>, accuracy(y_hat, Y))</span><br><span class="line"></span><br><span class="line">        test_acc = evaluate_accuracy_gpu(net, test_iter)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;test_acc:&#x27;</span>, test_acc)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    net = Lenet()</span><br><span class="line">    batch_size = <span class="number">256</span></span><br><span class="line">    train_iter, test_iter = load_data_fashion_mnist(batch_size=batch_size)</span><br><span class="line">    train(net, train_iter, test_iter, try_mps())</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Fang</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"neutral","dark":"neutral"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.3.0/mermaid.min.js","integrity":"sha256-9y71g5Lz/KLsHjB8uXwnkuWDtAMDSzD/HdIbqhJfTAI="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
